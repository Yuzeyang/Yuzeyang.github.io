<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å®«åŸ</title>
  <subtitle>Talk is cheap,show me the code.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yuzeyang.github.io/"/>
  <updated>2017-09-24T10:21:37.000Z</updated>
  <id>http://yuzeyang.github.io/</id>
  
  <author>
    <name>å®«åŸ</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HTTPS ç¬”è®°</title>
    <link href="http://yuzeyang.github.io/2017/09/24/https/"/>
    <id>http://yuzeyang.github.io/2017/09/24/https/</id>
    <published>2017-09-24T06:51:26.000Z</published>
    <updated>2017-09-24T10:21:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>HTTPS æ˜¯è¢«å¹¿æ³›åº”ç”¨åœ¨ç½‘ç»œä¸­çš„ä¸€ç§åŠ å¯†é€šä¿¡åè®®ï¼Œä¹Ÿè¢«å«åšåœ¨ TLS ä¹‹ä¸Šçš„ HTTPã€‚TLS ä»¥åŠå‰èº« SSL æ˜¯ä¼ è¾“å±‚å®‰å…¨åè®®ï¼Œç»™ç½‘ç»œé€šä¿¡æä¾›å®‰å…¨å’Œæ•°æ®å®Œæ•´æ€§çš„ä¿éšœï¼Œæ‰€ä»¥å®ƒèƒ½å¾ˆå¥½çš„è§£å†³ HTTP çš„æ•°æ®æ˜æ–‡å’ŒåŠ«æŒç¯¡æ”¹çš„é—®é¢˜ã€‚å¹¶ä¸”å…¶åˆ†ä¸ºè®°å½•å±‚å’Œä¼ è¾“å±‚ï¼Œè®°å½•å±‚ç”¨æ¥ç¡®å®šä¼ è¾“å±‚æ•°æ®çš„å°è£…æ ¼å¼ï¼Œä¼ è¾“å±‚åˆ™ç”¨äºæ•°æ®ä¼ è¾“ï¼Œè€Œåœ¨ä¼ è¾“ä¹‹å‰ï¼Œé€šä¿¡åŒæ–¹å¦‚ä½•å½¼æ­¤ä¿¡ä»»å’Œå»ºç«‹ä¸€ä¸ªå®‰å…¨é€šä¿¡æ–¹å¼ï¼Œæ˜¯éœ€è¦æˆ‘ä»¬æ·±å…¥äº†è§£çš„ã€‚</p>
<p>ç›®å‰æ¨èçš„ TLS ç‰ˆæœ¬æ˜¯ 1.2ï¼Œåè®®å…·ä½“å†…å®¹å¯ä»¥åœ¨ <a href="https://tools.ietf.org/html/rfc5246#section-7.4.2" target="_blank" rel="external">The Transport Layer Security (TLS) Protocol Version 1.2</a> ä¸­å»ä»”ç»†äº†è§£ï¼Œå®ƒæ˜¯08å¹´8æœˆå‘è¡¨çš„ã€‚ TLS 1.3 åˆ°16å¹´1æœˆéƒ½è¿˜åªæ˜¯è‰æ¡ˆã€‚</p>
<a id="more"></a>
<h2 id="u51C6_u5907"><a href="#u51C6_u5907" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>è¿™é‡Œæˆ‘ä½¿ç”¨ <a href="https://www.wireshark.org/download.html" target="_blank" rel="external">Wireshark</a> æ¥æŠ“åŒ…çœ‹ HTTPS çš„æ¡æ‰‹è¿‡ç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å¼€å¯ç½‘å¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod 777 /dev/bpf*</div></pre></td></tr></table></figure>
<p>å¦åˆ™ä¼šæç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">no interface can be used for capturing in this system with the current configuration</div></pre></td></tr></table></figure>
<p>å¼€å¯ä¹‹åï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨å†…è®¿é—®ä¸€ä¸ª <a href="https://xxx" target="_blank" rel="external">https://xxx</a> çš„ç½‘ç«™ï¼Œå†è¿‡æ»¤å‡º sslï¼Œä¸éš¾æ‰¾åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚</p>
<h2 id="u6B63_u6587"><a href="#u6B63_u6587" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>æˆ‘æˆªå–äº†å…¶ä¸­ä¸€æ®µ</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_handshake" alt=""></p>
<p>æ¡æ‰‹æ€»ç»“èµ·æ¥å°±æ˜¯åŒæ–¹èº«ä»½éªŒè¯ï¼Œåå•†åŠ å¯†ç®—æ³•ï¼Œäº¤æ¢åŠ å¯†å¯†é’¥ã€‚</p>
<p>è€Œè¿™äº›æ­¥éª¤æœ‰äº›æœåŠ¡å™¨æ˜¯åˆå¹¶åœ¨ä¸€èµ·å‘é€ï¼Œä¾‹å¦‚ï¼š</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_another_example" alt=""></p>
<h3 id="Client_Hello"><a href="#Client_Hello" class="headerlink" title="Client Hello"></a>Client Hello</h3><p>é¦–å…ˆå®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä¸ª Hello æ¶ˆæ¯ç»™æœåŠ¡ç«¯ï¼š</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_client_hello" alt=""></p>
<p> <code>Version: TLS 1.2</code> æ˜¯å…¶ç‰ˆæœ¬ä¿¡æ¯ï¼Œ<code>Random</code> æ˜¯ç”±å®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºæ•°ï¼Œé•¿åº¦ä¸º28ä¸ªå­—èŠ‚ï¼ˆç”¨äºåå•†å¯†é’¥ï¼‰ï¼Œ<code>Cipher Suites</code> æ˜¯å®¢æˆ·ç«¯æ”¯æŒçš„åŠ å¯†ç®—æ³•ï¼Œè®©æœåŠ¡ç«¯ä»ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œ<code>Compression Methods</code> æ˜¯å‹ç¼©æ–¹æ³•ï¼Œä»¥åŠä¸€äº›é¢å¤–çš„ä¿¡æ¯ã€‚</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_client_extension" alt=""></p>
<h3 id="Server_Hello"><a href="#Server_Hello" class="headerlink" title="Server Hello"></a>Server Hello</h3><p>æœåŠ¡ç«¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘èµ·çš„ Hello ä¹‹åï¼ŒåŒæ ·å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ª Helloï¼š</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_server_hello" alt=""></p>
<p>é‡Œé¢åŒ…å«äº†åå•†åçš„ç‰ˆæœ¬ä¿¡æ¯ TLS 1.2ï¼Œä½¿ç”¨çš„åŠ å¯†ç®—æ³• <code>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code> å’Œå‹ç¼©æ–¹æ³•ï¼Œä»¥åŠæœåŠ¡ç«¯ç”Ÿæˆçš„éšæœºæ•°ï¼ˆç”¨äºåå•†å¯†é’¥ï¼‰ã€‚</p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>åŒæ—¶æœåŠ¡ç«¯ä¹Ÿä¼šé…ç½®å¹¶è¿”å›å¯¹åº”çš„è¯ä¹¦ï¼Œç”¨æ¥èº«ä»½éªŒè¯å’Œå¯†é’¥äº¤æ¢ã€‚</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_server_cer" alt=""></p>
<h4 id="u8BC1_u4E66_u751F_u6210"><a href="#u8BC1_u4E66_u751F_u6210" class="headerlink" title="è¯ä¹¦ç”Ÿæˆ"></a>è¯ä¹¦ç”Ÿæˆ</h4><p>ç”³è¯·è€…éœ€è¦å‘é¢å‘è¯ä¹¦çš„å¯ä¿¡ç¬¬ä¸‰æ–¹CAæœºæ„æäº¤åŸŸåã€å…¬é’¥å’Œè¯·æ±‚æ–‡ä»¶(.ceræ–‡ä»¶)ï¼ŒCAæœºæ„éªŒè¯ä¿¡æ¯çš„åˆæ³•çœŸå®æ€§åé¢å‘è¯ä¹¦ï¼Œé‡Œé¢åˆ†ä¸ºæ˜æ–‡ä¿¡æ¯å’Œç­¾åä¿¡æ¯ï¼Œæ˜æ–‡ä¿¡æ¯åŒ…æ‹¬åŸŸåï¼Œç”³è¯·è€…ä¿¡æ¯å’Œé¢å‘æœºæ„ï¼Œæœ‰æ•ˆæœŸï¼Œå…¬é’¥ç­‰ä¿¡æ¯ï¼Œç­¾åä¿¡æ¯æ˜¯é€šè¿‡CAç§é’¥å¯¹æ˜æ–‡ä¿¡æ¯è¿›è¡ŒåŠ å¯†åçš„å†…å®¹ï¼Œç”³è¯·è€…åœ¨å®‰è£…è¯ä¹¦åï¼Œå¯ä»¥é€šè¿‡è¯ä¹¦å…¬é’¥æ¥å¯¹ç­¾åä¿¡æ¯å’Œæ˜æ–‡ä¿¡æ¯è¿›è¡ŒéªŒè¯ã€‚</p>
<h4 id="u8BC1_u4E66_u9A8C_u8BC1"><a href="#u8BC1_u4E66_u9A8C_u8BC1" class="headerlink" title="è¯ä¹¦éªŒè¯"></a>è¯ä¹¦éªŒè¯</h4><p>éªŒè¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼ŒéªŒè¯è¯ä¹¦æœ¬èº«çš„åˆæ³•æ€§å’ŒéªŒè¯é¢å‘è€…çš„åˆæ³•æ€§ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è¯ä¹¦æ˜¯åˆ†å±‚çº§çš„ï¼Œä¸‹ä¸€çº§çš„è¯ä¹¦éœ€è¦ç”¨ä¸Šä¸€çº§è¯ä¹¦çš„<code>ç§é’¥</code>ç­¾åï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä½¿ç”¨ä¸Šä¸€çº§è¯ä¹¦çš„å…¬é’¥æ¥è§£å¯†å¾—åˆ°ä¸‹ä¸€çº§çš„ç­¾åæ‘˜è¦ï¼ŒåŒæ—¶å®¢æˆ·ç«¯ä¹Ÿå¦‚æ­¤æ“ä½œï¼Œæœ€åå¯¹æ‘˜è¦è¿›è¡Œå¯¹æ¯”éªŒè¯ã€‚</p>
<p>é¢å‘è€…åˆæ³•æ€§åˆ™æ˜¯æ£€æŸ¥æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿä¸­çš„å¯ä¿¡è¯ä¹¦åˆ—è¡¨ã€‚æ‰€ä»¥æœ‰æ—¶å€™ä¸è¦ä¹±å®‰è£…ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„è¯ä¹¦ã€‚</p>
<h3 id="Server_Key_Exchange_2C_Server_Hello_Done"><a href="#Server_Key_Exchange_2C_Server_Hello_Done" class="headerlink" title="Server Key Exchange, Server Hello Done"></a>Server Key Exchange, Server Hello Done</h3><p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_server_exchange_key" alt=""></p>
<p><code>Server Key Exchange</code> ç”¨æ¥åŠ å¯†ä¸‹ä¸€æ­¥ä¸­çš„ Client Key Exchange ï¼Œåªæœ‰å½“è¯ä¹¦ä¸­ä¸åŒ…å«å…¬é’¥çš„æ—¶å€™æ‰éœ€è¦ï¼Œæ¯”å¦‚ç”¨ <code>Diffie Hellman</code> å¯†é’¥äº¤æ¢ç®—æ³•ã€‚</p>
<p><code>Server Hello Done</code> è¡¨ç¤ºæœåŠ¡ç«¯ Hello çš„ç»“æŸã€‚</p>
<h3 id="Client_Key_Exchange"><a href="#Client_Key_Exchange" class="headerlink" title="Client Key Exchange"></a>Client Key Exchange</h3><p>æ­¤æ—¶å®¢æˆ·ç«¯åœ¨éªŒè¯è¯ä¹¦é€šè¿‡ä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦å†ä¼ é€’ä¸€ä¸ªéšæœºæ•°ç»™å®¢æˆ·ç«¯ï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ <a href="https://tools.ietf.org/html/rfc5246#section-7.4.7.1" target="_blank" rel="external">RSA åŠ å¯†</a>ï¼Œå®¢æˆ·ç«¯å…ˆç”Ÿæˆ48å­—èŠ‚çš„éšæœºæ•°ï¼Œå†ç”¨è¯ä¹¦çš„å…¬é’¥åŠ å¯†ï¼Œç„¶åå‘ç»™æœåŠ¡ç«¯ï¼Œå¦ä¸€ç§æ˜¯è¿™é‡Œå®¢æˆ·ç«¯ç”¨çš„æ˜¯ <a href="https://tools.ietf.org/html/rfc5246#section-7.4.7.2" target="_blank" rel="external">Diffie-Hellman</a> å¯†é’¥äº¤æ¢ç®—æ³•ï¼Œæ‰€ä»¥è¿™æ¡æ¶ˆæ¯ä¼šåŒ…å«å®¢æˆ·ç«¯çš„ Diffie-Hellman å…¬é’¥ã€‚</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_client_exchange_key" alt=""></p>
<h3 id="Encrypted_Handshake_Message_2C_Application_Data"><a href="#Encrypted_Handshake_Message_2C_Application_Data" class="headerlink" title="Encrypted Handshake Message, Application Data"></a>Encrypted Handshake Message, Application Data</h3><p>æ­¤æ—¶åŒæ–¹æ ¹æ®å®¢æˆ·ç«¯ç”Ÿæˆçš„2ä¸ªéšæœºæ•°å’ŒæœåŠ¡ç«¯ç”Ÿæˆçš„1ä¸ªéšæœºæ•°ï¼Œä½¿ç”¨ç›¸åŒçš„ç®—æ³•å¾—åˆ°ä¸€ä¸ªåå•†å¯†é’¥ï¼Œå¯¹æ•°æ®è¿›è¡Œå¯¹ç§°åŠ å¯†å¾—åˆ° <code>Encrypted Application Data</code>ï¼Œç„¶åå†è¿›è¡Œé€šä¿¡ï¼Œå¯¹æ–¹å†è¿›è¡Œè§£å¯†ï¼Œä»è€Œä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§ã€‚</p>
<p><img src="http://7xt7s8.com2.z0.glb.clouddn.com/https_application_data" alt=""></p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>HTTPS è¯·æ±‚è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºæ¡æ‰‹å’Œæ•°æ®ä¼ è¾“ä¸¤æ­¥ï¼Œæ¡æ‰‹æ˜¯åœ¨åŒæ–¹éªŒè¯èº«ä»½ä¹‹åï¼Œåå•†å‡ºä¸€ä¸ªå¯†é’¥ï¼Œæ•°æ®ä¼ è¾“åˆ™æ˜¯ä½¿ç”¨ä¹‹å‰åå•†çš„å¯†é’¥ï¼Œå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚</p>
<p>æœ¬æ–‡æ˜¯å¯¹ HTTPS è¯·æ±‚çš„ä¸€ä¸ªç®€å•çš„ç†è§£ç¬”è®°ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·å­¦ä¹ äº¤æµ~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;HTTPS æ˜¯è¢«å¹¿æ³›åº”ç”¨åœ¨ç½‘ç»œä¸­çš„ä¸€ç§åŠ å¯†é€šä¿¡åè®®ï¼Œä¹Ÿè¢«å«åšåœ¨ TLS ä¹‹ä¸Šçš„ HTTPã€‚TLS ä»¥åŠå‰èº« SSL æ˜¯ä¼ è¾“å±‚å®‰å…¨åè®®ï¼Œç»™ç½‘ç»œé€šä¿¡æä¾›å®‰å…¨å’Œæ•°æ®å®Œæ•´æ€§çš„ä¿éšœï¼Œæ‰€ä»¥å®ƒèƒ½å¾ˆå¥½çš„è§£å†³ HTTP çš„æ•°æ®æ˜æ–‡å’ŒåŠ«æŒç¯¡æ”¹çš„é—®é¢˜ã€‚å¹¶ä¸”å…¶åˆ†ä¸ºè®°å½•å±‚å’Œä¼ è¾“å±‚ï¼Œè®°å½•å±‚ç”¨æ¥ç¡®å®šä¼ è¾“å±‚æ•°æ®çš„å°è£…æ ¼å¼ï¼Œä¼ è¾“å±‚åˆ™ç”¨äºæ•°æ®ä¼ è¾“ï¼Œè€Œåœ¨ä¼ è¾“ä¹‹å‰ï¼Œé€šä¿¡åŒæ–¹å¦‚ä½•å½¼æ­¤ä¿¡ä»»å’Œå»ºç«‹ä¸€ä¸ªå®‰å…¨é€šä¿¡æ–¹å¼ï¼Œæ˜¯éœ€è¦æˆ‘ä»¬æ·±å…¥äº†è§£çš„ã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰æ¨èçš„ TLS ç‰ˆæœ¬æ˜¯ 1.2ï¼Œåè®®å…·ä½“å†…å®¹å¯ä»¥åœ¨ &lt;a href=&quot;https://tools.ietf.org/html/rfc5246#section-7.4.2&quot;&gt;The Transport Layer Security (TLS) Protocol Version 1.2&lt;/a&gt; ä¸­å»ä»”ç»†äº†è§£ï¼Œå®ƒæ˜¯08å¹´8æœˆå‘è¡¨çš„ã€‚ TLS 1.3 åˆ°16å¹´1æœˆéƒ½è¿˜åªæ˜¯è‰æ¡ˆã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="HTTPS" scheme="http://yuzeyang.github.io/tags/HTTPS/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨ Fastlane å‡çº§ç§æœ‰ Pod åº“</title>
    <link href="http://yuzeyang.github.io/2017/09/09/fastlane-pod-spec-upgrade/"/>
    <id>http://yuzeyang.github.io/2017/09/09/fastlane-pod-spec-upgrade/</id>
    <published>2017-09-09T06:26:37.000Z</published>
    <updated>2017-09-09T09:19:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æˆ‘ä»¬å®Œæˆäº†ç”¨ <code>Fastlane</code> è‡ªåŠ¨åŒ–æ‰“åŒ…ä¸Šä¼  iTunes Counnet ï¼Œä¸ºäº†å°† Fastlane çš„åŠŸèƒ½è¿›ä¸€æ­¥çš„ä½¿ç”¨ï¼Œåé¢å¸Œæœ›èƒ½å°† Pod é›†æˆå’Œå‡çº§ä¹Ÿè‡ªåŠ¨åŒ–ï¼Œæˆ‘ä¹ŸæŠ½ç©ºç ”ç©¶äº†ä¸€ä¸‹ç§æœ‰ Pod åº“çš„å‡çº§ã€ Fastlane Actionçš„åˆ¶ä½œå’Œ Fastlane Plugin çš„åˆ¶ä½œã€‚</p>
<a id="more"></a>
<p>okï¼Œå¼€å§‹æˆ‘ä»¬çš„æ­£æ–‡ã€‚</p>
<p>é¦–å…ˆï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ <a href="https://github.com/fastlane/fastlane" target="_blank" rel="external">Fastlane </a>ï¼Œå®ƒæ˜¯ç”¨ <code>Ruby</code> æ¥å®ç°è‡ªåŠ¨åŒ–æ„å»ºå’Œæ‰“åŒ…çš„å·¥å…·ï¼Œå¹¶ä¸”èƒ½å’Œ <code>Jenkins</code> ç­‰ CI å¹³å°ç»“åˆä½¿ç”¨ã€‚ Fastlane å¯¹äº iOS å¼€å‘æ¥è¯´ï¼Œå®åœ¨æ˜¯å¤ªå‹å¥½ï¼Œä»å®ƒæä¾›çš„ <a href="https://docs.fastlane.tools/actions/" target="_blank" rel="external">actions</a> å’Œ <a href="https://docs.fastlane.tools/plugins/available-plugins/" target="_blank" rel="external">plugins</a> æ¥çœ‹ï¼Œè¶³ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œå¦‚æœä¸å¤Ÿçš„è¯ï¼Œå¯ä»¥è‡ªå®šä¹‰ Actionï¼Œå¹¶ä¸”å¯ä»¥åˆ¶ä½œæˆ Plugin æäº¤åˆ° <code>RubyGems</code> ä¸Šä¾›å…¶ä»–å¼€å‘è€…ä½¿ç”¨ã€‚</p>
<h3 id="u5347_u7EA7_u79C1_u6709_Pod__u5E93"><a href="#u5347_u7EA7_u79C1_u6709_Pod__u5E93" class="headerlink" title="å‡çº§ç§æœ‰ Pod åº“"></a>å‡çº§ç§æœ‰ Pod åº“</h3><p>å¯¹ Fastlane çš„é…ç½®è¿™é‡Œå°±ä¸è¯´äº†ï¼Œé…ç½®å¥½åæœ€ç®€å•çš„æ–‡ä»¶ç»“æ„å°±æ˜¯åªæœ‰ä¸€ä¸ª <code>Appfile</code> å’Œ <code>Fastfile</code> ï¼ŒAppfile åŒ…å«åˆšæ‰åˆå§‹åŒ–æ—¶é…ç½®ï¼Œè€Œ Fastfile è´Ÿè´£æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æˆ‘ä»¬å¹³æ—¶åœ¨å‡çº§ç§æœ‰ Pod åº“æ—¶çš„æ­¥éª¤ï¼ˆçœ‹æ³¨é‡Šéƒ¨åˆ†ï¼‰</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git_pull <span class="comment"># æ‹‰å–æœ€æ–°ä»£ç </span></div><div class="line">ensure_git_branch <span class="comment"># ç¡®ä¿å½“å‰æ˜¯ master åˆ†æ”¯</span></div><div class="line">pod_spec_lint(<span class="symbol">allow_warnings:</span> <span class="literal">true</span>) <span class="comment"># æ£€æŸ¥ Podspec æœ‰æ•ˆæ€§</span></div><div class="line">version_bump_podspec(<span class="symbol">path:</span> path, <span class="symbol">version_number:</span> version) <span class="comment"># ä¿®æ”¹ podspec ä¸­ç‰ˆæœ¬</span></div><div class="line">git_commit(<span class="symbol">path:</span> <span class="string">"."</span>, <span class="symbol">message:</span> <span class="string">"update version to <span class="subst">#&#123;version&#125;</span>"</span>) <span class="comment"># commit</span></div><div class="line">push_to_git_remote <span class="comment"># æäº¤æœ¬åœ°æ”¹åŠ¨åˆ°è¿œç¨‹åˆ†æ”¯</span></div><div class="line">add_git_tag(<span class="symbol">tag:</span> version) <span class="comment"># æ·»åŠ  tag</span></div><div class="line">push_git_tags <span class="comment"># push æœ¬åœ° tags</span></div><div class="line">pod_push(<span class="symbol">path:</span> path, <span class="symbol">allow_warnings:</span> <span class="literal">true</span>) <span class="comment"># push podspec åˆ°ä»“åº“</span></div></pre></td></tr></table></figure>
<p>å†å›åˆ°æ³¨é‡Šå¯¹åº”çš„ fastlane å‘½ä»¤ï¼Œå®é™…ä¸Š fastlane çš„ actions é‡Œéƒ½èƒ½æ‰¾åˆ° Pod å¯¹åº”çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯¹ç…§æ–‡æ¡£å¡«å……å¥½å‚æ•°ä¹‹åï¼Œæ•´ä¸ªå‡çº§çš„æ ¸å¿ƒåŠŸèƒ½å·²ç»å®ç°äº†ã€‚æœ€åæˆ‘ä»¬è€ƒè™‘å‘½ä»¤éœ€è¦çš„å“ªäº›å…¥å‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ Project çš„åå­—å’Œå‡çº§åˆ°å“ªä¸€ä¸ªç‰ˆæœ¬</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">version = options[<span class="symbol">:version</span>]</div><div class="line">project = options[<span class="symbol">:project</span>]</div></pre></td></tr></table></figure>
<p>å®Œæˆä¹‹åæˆ‘ä»¬åé¢å‡çº§åªéœ€è¦ä¸€è¡Œå‘½ä»¤</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastlane pod_repo_push <span class="symbol">project:</span>[projectname] <span class="symbol">version:</span>[version]</div></pre></td></tr></table></figure>
<p>è¯¦è§ï¼š<a href="https://github.com/Yuzeyang/Fastfile/blob/master/fastlane/Fastfile" target="_blank" rel="external">Fastfile</a></p>
<h3 id="u81EA_u5B9A_u4E49_Action"><a href="#u81EA_u5B9A_u4E49_Action" class="headerlink" title="è‡ªå®šä¹‰ Action"></a>è‡ªå®šä¹‰ Action</h3><p>ä¸Šé¢å‡çº§åº“ä¸­ç”¨åˆ°äº†ä¸€ä¸ªå‘½ä»¤ <code>pod_spec_lint</code> ï¼Œè¿™ä¸ªå¹¶æ²¡æœ‰åœ¨å®˜æ–¹æä¾›çš„ Actions é‡Œï¼Œæ˜¯æˆ‘è‡ªå®šä¹‰çš„ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ pod_spec_lint ä¸ç”¨ <code>pod_lib_lint</code> å‘¢ï¼Ÿå½“æ—¶æˆ‘åœ¨åœ¨æµ‹è¯•å‡çº§çš„æ—¶å€™ï¼ŒæŠŠç§æœ‰åº“æ›´æ–°ä¼ åˆ° Github ä¸Šæ—¶ï¼Œpod_lib_lint éªŒè¯é€šè¿‡ï¼Œä½†æ˜¯ push åˆ° remote çš„æ—¶å€™å°±æŠ¥é”™æºæ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œè¿™å°±è®©æˆ‘å¾ˆçº³é—·äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">[22:46:42]: --------------------------</div><div class="line">[22:46:42]: --- Step: pod_lib_lint ---</div><div class="line">[22:46:42]: --------------------------</div><div class="line">[22:46:42]: $ pod lib lint --allow-warnings</div><div class="line">[22:46:52]: â–¸ -&gt; FastlanePodspecDemo (0.1.1)</div><div class="line">[22:46:52]: â–¸ - WARN | summary: The summary is not meaningful.</div><div class="line">[22:46:52]: â–¸ - WARN | description: The description is equal to the summary.</div><div class="line">[22:46:52]: â–¸ - WARN | [iOS] license: Unable to find a license file</div><div class="line">[22:46:52]: â–¸ FastlanePodspecDemo passed validation.</div><div class="line">[22:46:52]: Pod lib lint Successfully â¬†ï¸</div><div class="line">[22:46:52]: ----------------------------------</div><div class="line">...</div><div class="line">[22:47:34]: --- Step: pod_push ---</div><div class="line">[22:47:34]: ----------------------</div><div class="line">[22:47:34]: $ pod trunk push &apos;FastlanePodspecDemo.podspec&apos; --allow-warnings</div><div class="line">[22:47:34]: â–¸ Updating spec repo master</div><div class="line">[22:49:36]: â–¸ CocoaPods 1.3.1 is available.</div><div class="line">[22:49:36]: â–¸ To update use: sudo gem install cocoapods</div><div class="line">[22:49:36]: â–¸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</div><div class="line">[22:49:36]: â–¸ Validating podspec</div><div class="line">[22:49:51]: â–¸ -&gt; FastlanePodspecDemo (0.1.2)</div><div class="line">[22:49:51]: â–¸ - WARN | summary: The summary is not meaningful.</div><div class="line">[22:49:51]: â–¸ - WARN | description: The description is equal to the summary.</div><div class="line">[22:49:51]: â–¸ - ERROR | [iOS] file patterns: The source_files pattern did not match any file.</div><div class="line">[22:49:51]: â–¸ - ERROR | [iOS] file patterns: The resources pattern did not match any file.</div><div class="line">[22:49:51]: â–¸ - WARN | [iOS] license: Unable to find a license file</div><div class="line">[22:49:51]: â–¸ [!] The spec did not pass validation, due to 2 errors.</div><div class="line">[22:49:51]: â–¸ [!] The validator for Swift projects uses Swift 3.0 by default, if you are using a different version of swift you can use a .swift-version file to set the version for your Pod. For example to use Swift 2.3, run:</div><div class="line">[22:49:51]: â–¸ echo &quot;2.3 &quot; &gt; .swift-version.</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘çœ‹åˆ°äº†è¿™ç¯‡è§£é‡Š <a href="https://stackoverflow.com/questions/32304421/whats-the-difference-between-pod-spec-lint-and-pod-lib-lint" target="_blank" rel="external"><a href="https://stackoverflow.com/questions/32304421/whats-the-difference-between-pod-spec-lint-and-pod-lib-lint" target="_blank" rel="external">Whatâ€™s the difference between â€˜pod spec lintâ€™ and â€˜pod lib lintâ€™?</a></a> ï¼Œpod lib lint åªä¼š lint ä½ æœ¬åœ°çš„ pod ï¼Œä»¥åŠç¡®ä¿ä½ æä¾›çš„ä¸œè¥¿æ˜¯å¦æ­£ç¡®ï¼Œä½†æ˜¯ä»£ç æ¨åˆ°è¿œç¨‹åå¦‚æœ lint ä¸è¿‡ä¹Ÿè¿˜æ˜¯æ²¡ç”¨ï¼Œè€Œ pod spec lint é™¤äº† pod lib lint çš„éªŒè¯æ­¥éª¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¼š lint è¿œç¨‹çš„pod ï¼ŒçœŸæ­£ç¡®ä¿ podspec çš„æœ‰æ•ˆæ€§ã€‚</p>
<p>æ‰€ä»¥æˆ‘åŸºäºåŸæ¥çš„ pod_lib_lint å‘½ä»¤åšäº†ç®€å•çš„ä¿®æ”¹ï¼Œé€šè¿‡è¿è¡Œ <code>fatslant new_action</code> ç”Ÿæˆ<code>action/pod_sepc_lint.rb</code> æ–‡ä»¶ï¼Œè¯¦è§ï¼š<a href="https://github.com/Yuzeyang/Fastfile/blob/master/fastlane/actions/pod_spec_lint.rb" target="_blank" rel="external">pod_spec_lint.rb</a> ï¼Œå†™å¥½ä¹‹åå¯ä»¥è¿è¡Œ <code>bundle exec rspec</code> è·‘ä¸€ä¸‹æµ‹è¯•æ˜¯å¦èƒ½é€šè¿‡ï¼Œä¹Ÿå¯ä»¥è¿è¡Œ <code>bundle exec rubocop -a</code> æ£€æŸ¥ä¸€ä¸‹ä»£ç æ˜¯å¦ç¬¦åˆ fastlane actionçš„è§„èŒƒã€‚æœ€åæˆ‘è¯•ç€æäº¤ä¸€ä¸ª PR çœ‹çœ‹èƒ½å¦ç»™å®˜æ–¹åŠ ä¸Šï¼Œåæ¥å®˜æ–¹å›åº”å·²ç»ä¸èƒ½åœ¨åŠ  actions äº†ï¼Œåªèƒ½æ·»åŠ åˆ° plugin é‡Œã€‚</p>
<p>åæ¥ä½¿ç”¨è‡ªå®šä¹‰çš„ pod_spec_lint å‘½ä»¤ä¹‹åå°±è§£å†³äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">[22:58:00]: Get started using a Gemfile for fastlane https://docs.fastlane.tools/getting-started/ios/setup/#use-a-gemfile</div><div class="line">...</div><div class="line">[22:58:06]: --- Step: pod_spec_lint ---</div><div class="line">[22:58:06]: ---------------------------</div><div class="line">[22:58:06]: $ pod spec lint --allow-warnings</div><div class="line">[22:58:19]: â–¸ -&gt; FastlanePodspecDemo (0.1.2)</div><div class="line">[22:58:19]: â–¸ - WARN | summary: The summary is not meaningful.</div><div class="line">[22:58:19]: â–¸ - WARN | description: The description is equal to the summary.</div><div class="line">[22:58:19]: â–¸ - WARN | [iOS] license: Unable to find a license file</div><div class="line">[22:58:19]: â–¸ Analyzed 1 podspec.</div><div class="line">[22:58:19]: â–¸ FastlanePodspecDemo.podspec passed validation.</div><div class="line">[22:58:19]: Pod spec lint Successfully â¬†ï¸</div><div class="line">[22:58:19]: ----------------------------------</div><div class="line">...</div><div class="line">[22:58:40]: --- Step: pod_push ---</div><div class="line">[22:58:40]: ----------------------</div><div class="line">[22:58:40]: $ pod trunk push &apos;FastlanePodspecDemo.podspec&apos; --allow-warnings</div><div class="line">[22:58:41]: â–¸ Updating spec repo master</div><div class="line">[23:04:01]: â–¸ CocoaPods 1.3.1 is available.</div><div class="line">[23:04:01]: â–¸ To update use: sudo gem install cocoapods</div><div class="line">[23:04:01]: â–¸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</div><div class="line">[23:04:01]: â–¸ Validating podspec</div><div class="line">[23:04:29]: â–¸ -&gt; FastlanePodspecDemo (0.1.3)</div><div class="line">[23:04:29]: â–¸ - WARN | summary: The summary is not meaningful.</div><div class="line">[23:04:29]: â–¸ - WARN | description: The description is equal to the summary.</div><div class="line">[23:04:29]: â–¸ - WARN | [iOS] license: Unable to find a license file</div><div class="line">[23:04:29]: â–¸ Updating spec repo master</div><div class="line">[23:05:45]: â–¸ CocoaPods 1.3.1 is available.</div><div class="line">[23:05:45]: â–¸ To update use: sudo gem install cocoapods</div><div class="line">[23:05:45]: â–¸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</div><div class="line">[23:05:46]: â–¸ --------------------------------------------------------------------------------</div><div class="line">[23:05:46]: â–¸ ğŸ‰ Congrats</div><div class="line">[23:05:46]: â–¸ ğŸš€ FastlanePodspecDemo (0.1.3) successfully published</div><div class="line">[23:05:46]: â–¸ ğŸ“… September 3rd, 09:04</div><div class="line">[23:05:46]: â–¸ ğŸŒ https://cocoapods.org/pods/FastlanePodspecDemo</div><div class="line">[23:05:46]: â–¸ ğŸ‘ Tell your friends!</div><div class="line">[23:05:46]: â–¸ --------------------------------------------------------------------------------</div><div class="line">[23:05:46]: Successfully pushed Podspec â¬†ï¸</div><div class="line">[23:05:46]: push success, current version is 0.1.3</div><div class="line"></div><div class="line">+------+-------------------------------------+-------------+</div><div class="line">| fastlane summary |</div><div class="line">+------+-------------------------------------+-------------+</div><div class="line">| Step | Action | Time (in s) |</div><div class="line">+------+-------------------------------------+-------------+</div><div class="line">| 1 | Verifying required fastlane version | 0 |</div><div class="line">| 2 | default_platform | 0 |</div><div class="line">| 3 | git_pull | 3 |</div><div class="line">| 4 | ensure_git_branch | 0 |</div><div class="line">| 5 | pod_spec_lint | 13 |</div><div class="line">| 6 | version_bump_podspec | 0 |</div><div class="line">| 7 | git_add | 0 |</div><div class="line">| 8 | git_commit | 5 |</div><div class="line">| 9 | push_to_git_remote | 7 |</div><div class="line">| 10 | add_git_tag | 0 |</div><div class="line">| 11 | push_git_tags | 7 |</div><div class="line">| 12 | pod_push | 425 |</div><div class="line">+------+-------------------------------------+-------------+</div><div class="line"></div><div class="line">[23:05:46]: fastlane.tools just saved you 8 minutes! ğŸ‰</div></pre></td></tr></table></figure>
<h3 id="u5236_u4F5C_Plugin"><a href="#u5236_u4F5C_Plugin" class="headerlink" title="åˆ¶ä½œ Plugin"></a>åˆ¶ä½œ Plugin</h3><p>è¿™ä¸€éƒ¨åˆ†æˆ‘å¹¶æ²¡æœ‰å®ç°é€šï¼Œæˆ‘åœ¨æ³¨å†Œ <code>RubyGems</code> çš„è´¦å·æ—¶é‚®ç®±éªŒè¯è¿‡ä¹‹åè¿˜æ˜¯ä¸èƒ½ç™»å½•ï¼Œæç¤ºæœªéªŒè¯â€¦.ä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œæœ‰é‡åˆ°è§£å†³äº†çš„ï¼Œéº»çƒ¦ç•™è¨€å‘Šè¯‰æˆ‘ä¸€ä¸‹ã€‚ä¸‹é¢æ˜¯å¯¹å®˜æ–¹çš„ Plugin åˆ¶ä½œçš„è§£é‡Šï¼š</p>
<p>åˆ›å»ºå¥½ç›®å½•ä¹‹åï¼Œè¿è¡Œ</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fastlane new_plugin [plugin_name]</div></pre></td></tr></table></figure>
<p>fastlane ä¼šåˆ›å»ºä¸€ä¸ªæœ‰æ•ˆçš„ Ruby gem çš„æ–‡ä»¶ç»“æ„ï¼Œç„¶åä½ ç¼–è¾‘ <code>lib/fastlane/plugin/[plugin_name]/actions/[plugin_name].rb</code> å»å®ç°ä½ çš„ action ï¼ŒæŠŠä¸Šé¢è‡ªå®šä¹‰çš„ action çš„å†…å®¹æ‹·è´åˆ°é‡Œé¢ï¼Œç„¶åæŠŠåˆ›å»ºå‡ºæ¥çš„æ–‡ä»¶æ¨åˆ°ä½ çš„ Github ä»“åº“ï¼Œæ›´æ–° <code>fastlane-plugin-[plugin_name].gemspec</code> æ–‡ä»¶æ¥æŒ‡å‘ä½ çš„ä»“åº“ï¼Œæœ€åè¿è¡Œ</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bundle install</div><div class="line">rake install</div><div class="line">rake release</div></pre></td></tr></table></figure>
<p>ok~å¤§åŠŸå‘Šæˆï¼Œç°åœ¨ä½ å¯ä»¥è¿è¡Œ <code>fastlane add_plugin [plugin_name]</code> å®‰è£…ä½¿ç”¨ä½ çš„ Plugin äº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æˆ‘ä»¬å®Œæˆäº†ç”¨ &lt;code&gt;Fastlane&lt;/code&gt; è‡ªåŠ¨åŒ–æ‰“åŒ…ä¸Šä¼  iTunes Counnet ï¼Œä¸ºäº†å°† Fastlane çš„åŠŸèƒ½è¿›ä¸€æ­¥çš„ä½¿ç”¨ï¼Œåé¢å¸Œæœ›èƒ½å°† Pod é›†æˆå’Œå‡çº§ä¹Ÿè‡ªåŠ¨åŒ–ï¼Œæˆ‘ä¹ŸæŠ½ç©ºç ”ç©¶äº†ä¸€ä¸‹ç§æœ‰ Pod åº“çš„å‡çº§ã€ Fastlane Actionçš„åˆ¶ä½œå’Œ Fastlane Plugin çš„åˆ¶ä½œã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Fastlane" scheme="http://yuzeyang.github.io/tags/Fastlane/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº NSURLProtocol å®ç° Debug ç¯å¢ƒåˆ‡æ¢å·¥å…·</title>
    <link href="http://yuzeyang.github.io/2017/09/09/debug-tool-base-on-NSURLProtocol/"/>
    <id>http://yuzeyang.github.io/2017/09/09/debug-tool-base-on-NSURLProtocol/</id>
    <published>2017-09-09T03:21:28.000Z</published>
    <updated>2017-09-24T14:28:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å…¬å¸å†…ä¸€èˆ¬å¯¹è°ƒè¯•ç¯å¢ƒä¼šåˆ†ä¸º<code>çº¿ä¸Š</code>ã€<code>é¢„å‘å¸ƒ</code>å’Œ<code>QAæµ‹è¯•</code>ä¸‰ç§ï¼Œè€Œåœ¨åˆ‡æ¢ç¯å¢ƒçš„æ—¶å€™å¤§å¤šè¿˜æ˜¯é€šè¿‡ç½‘é¡µæˆ–æ¡Œé¢åº”ç”¨ï¼Œå½“åœ¨è°ƒè¯•å®¢æˆ·ç«¯åº”ç”¨æ—¶è¿™æ ·çš„æ–¹å¼å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»„<code>ç¤¾ä¼šå…‰å“¥</code>å°†æ•´å¥—ç¯å¢ƒåˆ‡æ¢å’Œè¯·æ±‚è½¬å‘çš„åŸç†ç†æ¸…æ™°ä¹‹åå®ç°äº† Android ç‰ˆçš„ Debug ç¯å¢ƒåˆ‡æ¢å·¥å…·ï¼Œè€Œæˆ‘åˆ™æ ¹æ®å…¶åŸç†å®ç°äº† iOS ç‰ˆã€‚å®¢æˆ·ç«¯æ¥å…¥è¯¥å·¥å…·ä¹‹åï¼Œåªéœ€åœ¨åº”ç”¨å†…å³å¯åˆ‡æ¢ç¯å¢ƒå’ŒæŒ‡å®šè°ƒè¯•ç›®å½•ï¼ˆæ¯ä¸ªç›®å½•ç‹¬ç«‹éƒ¨ç½²ä»£ç ï¼‰ã€‚</p>
<a id="more"></a>
<h2 id="u539F_u7406"><a href="#u539F_u7406" class="headerlink" title="åŸç†"></a>åŸç†</h2><h3 id="u73AF_u5883_u5207_u6362"><a href="#u73AF_u5883_u5207_u6362" class="headerlink" title="ç¯å¢ƒåˆ‡æ¢"></a>ç¯å¢ƒåˆ‡æ¢</h3><p>å…ˆç®€å•ä»‹ç»ä¸‹ç¯å¢ƒåˆ‡æ¢åŸç†ï¼ˆFrom å…‰å“¥ï¼‰</p>
<p>ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒçš„å†…ç½‘ IP æœºå™¨ï¼Œå®ƒæ˜¯ä¸€å°åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå°†ç½‘ç»œè¯·æ±‚ä»£ç†åˆ°å¯¹åº”ç¯å¢ƒçš„äº‘ç«¯æœºå™¨ä¸Šå¤„ç†ï¼Œå¤„ç†å®Œæˆä¹‹åé€šè¿‡åå‘ä»£ç†æœåŠ¡å™¨å†è¿”å›ç»™è¯·æ±‚æ–¹ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/proxy.png" alt=""></p>
<p>ç¯å¢ƒè®¾ç½®å®é™…æ˜¯å‘å¯¹åº”çš„åœ°å€å‘é€ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæºå¸¦ä¸Šè‡ªå·±çš„ WiFi IPï¼ˆå¦‚æœå¼€å¯ Charles ç­‰ä»£ç†å·¥å…·åï¼Œåˆ™æ˜¯ç”µè„‘çš„ WiFi IPï¼‰ï¼Œä»¥åŠäº‘ç«¯æœºå™¨çš„ IP å’Œ Portè¿›è¡Œç»‘å®šï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSString *URLString = [@&quot;http://&quot; stringByAppendingFormat:@&quot;%@:12345/index&quot;, [self IPByEnv:self.env]];</div><div class="line">NSURL *URL = [NSURL URLWithString:URLString];</div><div class="line">NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:URL];</div><div class="line">request.HTTPMethod = @&quot;POST&quot;;</div><div class="line">[request setValue:self.proxyIP forHTTPHeaderField:@&quot;X-Forward-For&quot;];</div><div class="line"></div><div class="line">GCCarmenModel *carmenModel = [self carmenConfig];</div><div class="line">[request setHTTPBody:[[carmenModel toPostBodyString] dataUsingEncoding:NSUTF8StringEncoding]];</div></pre></td></tr></table></figure>
<h3 id="u8BF7_u6C42_u8F6C_u53D1"><a href="#u8BF7_u6C42_u8F6C_u53D1" class="headerlink" title="è¯·æ±‚è½¬å‘"></a>è¯·æ±‚è½¬å‘</h3><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>NSURLProtocol</code> æ‹¦æˆªå®¢æˆ·ç«¯å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚ï¼Œæˆ‘ä»¬ç»§æ‰¿ <code>NSURLProtocol</code> åéœ€è¦åœ¨ AppDelegate ä¸­æ³¨å†Œå…¶å­ç±»ï¼Œè€Œ  <code>NSURLProtocol</code>  çš„æ‰§è¡Œé¡ºåºå’Œæ³¨å†Œé¡ºåºæ˜¯ç›¸åçš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨æœ€åæ³¨å†Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#ifdef DEBUG</div><div class="line">    [NSURLProtocol registerClass:NSClassFromString(@&quot;ZanDNSProtocol&quot;)];</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>ç›®å‰å¤§å¤šæ•°ç½‘ç»œåº“æˆ‘ä»¬ç”¨çš„éƒ½æ˜¯ <code>AFNetworking</code> ï¼Œæ˜¯åŸºäº <code>NSURLSession</code> çš„ç½‘ç»œè¯·æ±‚ï¼Œæ‰€ä»¥åœ¨æ„é€  <code>NSURLSessionConfiguration</code> ä¹‹åï¼Œéœ€è¦æŒ‡å®šå®ƒçš„ <code>protocolClasses</code> ï¼Œä½†ä¸ºäº†ä¸ç ´å AF æºç ï¼Œæˆ‘ä»¬å¯ä»¥ <code>Swizzling</code> ç³»ç»Ÿ <code>NSURLSession</code> çš„ API <code>sessionWithConfiguration:delegate:delegateQueue:</code> ï¼Œåšåˆ°å¯¹ç½‘ç»œåº“æ— ä¾µå…¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@implementation NSURLSession (DNSSwizzling)</div><div class="line"></div><div class="line">+ (void)load &#123;</div><div class="line">  #ifdef DEBUG</div><div class="line">      dns_classMethodSwizzle(self, @selector(sessionWithConfiguration:delegate:delegateQueue:), @selector(zan_sessionWithConfiguration:delegate:delegateQueue:));</div><div class="line">  #endif</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSURLSession *)zan_sessionWithConfiguration:(NSURLSessionConfiguration *)configuration delegate:(nullable id &lt;NSURLSessionDelegate&gt;)delegate delegateQueue:(nullable NSOperationQueue *)queue &#123;</div><div class="line">    configuration.protocolClasses = @[NSClassFromString(@&quot;ZanDNSProtocol&quot;)];</div><div class="line">    return [self zan_sessionWithConfiguration:configuration delegate:delegate delegateQueue:queue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>æ¥ç€åœ¨ <code>ZanDNSProtocol</code> ï¼ˆ NSURLProtocol å­ç±»ï¼‰ä¸­å®ç°çˆ¶ç±»æ–¹æ³•ï¼Œä¸€å…±å››æ­¥ï¼š</p>
<p>ç¬¬ä¸€æ­¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼Œæœ¬åœ°æˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä»½ DNS åˆ—è¡¨ï¼Œæˆ‘ä»¬åªæ‹¦æˆªåœ¨åˆ—è¡¨ä¸­çš„åŸŸåè¯·æ±‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+ (BOOL)canInitWithRequest:(NSURLRequest *)request &#123;</div><div class="line">    // ...</div><div class="line">    </div><div class="line">    NSString *host = request.URL.host;</div><div class="line">    NSDictionary *DNSConfig = [ZanDNSManager sharedInstance].DNSConfig;</div><div class="line">    if ([[DNSConfig allKeys] containsObject:host]) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒæ­¥æˆ‘ä»¬ä¿®æ”¹æ‹¦æˆªåˆ°çš„è¯·æ±‚ï¼Œæˆ‘ä»¬è§£æå‡ºå½“å‰ç¯å¢ƒä¸‹ Host å¯¹åº”åˆ—è¡¨ä¸­çš„ IP åœ°å€ï¼Œç„¶ååœ¨ <code>URL</code> ä¸­ç”¨ IP æ›¿æ¢æ‰ Hostï¼Œå¹¶åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸Š <code>Host</code>ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å¼€å¯ä»£ç†ä¹‹åï¼Œä»£ç†å·¥å…·åš DNS è§£æï¼Œè§£æåˆ°çº¿ä¸Šçš„ IP åœ°å€ï¼Œè¿™æ ·è½¬å‘çš„è¯·æ±‚è¿˜æ˜¯å¾€çº¿ä¸Šå‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">+ (NSURLRequest *)canonicalRequestForRequest:(NSURLRequest *)request &#123;</div><div class="line">    // ...</div><div class="line">    </div><div class="line">    NSMutableURLRequest *forwardRequest = [request mutableCopy];</div><div class="line">    </div><div class="line">    NSString *URLString = forwardRequest.URL.absoluteString;</div><div class="line">    NSString *originalHost = forwardRequest.URL.host;</div><div class="line">    NSDictionary *DNSConfig = [ZanDNSManager sharedInstance].DNSConfig;</div><div class="line">    NSString *IP = DNSConfig[originalHost];</div><div class="line">    URLString = [URLString stringByReplacingOccurrencesOfString:originalHost withString:IP];</div><div class="line">    forwardRequest.URL = [NSURL URLWithString:URLString];</div><div class="line">    [forwardRequest setValue:originalHost forHTTPHeaderField:@&quot;Host&quot;];</div><div class="line">    [forwardRequest setValue:[ZanDNSManager sharedInstance].proxyIP forHTTPHeaderField:@&quot;X-Forward-For&quot;];</div><div class="line">    </div><div class="line">    return forwardRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰æ­¥å°±æ˜¯å‘é€è¯·æ±‚ï¼Œå¦‚æœæˆ‘ä»¬å¼€å¯äº†ä»£ç†ï¼Œå¯ä»¥é…ç½® <code>NSURLSessionConfiguration</code> çš„ <code>connectionProxyDictionary</code> ï¼Œå¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ç”¨å†ä¸‹è½½ Charles è¯ä¹¦åˆ°æ‰‹æœºï¼Œå¯ä»¥ç›´æ¥ä»£ç†åˆ° Charles æ¥æŠ“åŒ…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)startLoading &#123;</div><div class="line">    [NSURLProtocol setProperty:@(YES) forKey:propertyKey inRequest:[self.request mutableCopy]];</div><div class="line">    NSURLSessionConfiguration *configuration;</div><div class="line">    if ([ZanDNSManager sharedInstance].openProxy) &#123;</div><div class="line">        NSDictionary *proxyDic = @&#123;@&quot;HTTPEnable&quot;: @(YES),</div><div class="line">                                   (NSString *)kCFStreamPropertyHTTPProxyHost: [ZanDNSManager sharedInstance].proxyIP,</div><div class="line">                                   (NSString *)kCFStreamPropertyHTTPProxyPort: @([ZanDNSManager sharedInstance].proxyPort),</div><div class="line">                                   @&quot;HTTPSEnable&quot;: @(YES),</div><div class="line">                                   (NSString *)kCFStreamPropertyHTTPSProxyHost: [ZanDNSManager sharedInstance].proxyIP,</div><div class="line">                                   (NSString *)kCFStreamPropertyHTTPSProxyPort: @([ZanDNSManager sharedInstance].proxyPort)&#125;;</div><div class="line">        configuration = [NSURLSessionConfiguration ephemeralSessionConfiguration];</div><div class="line">        configuration.connectionProxyDictionary = proxyDic;</div><div class="line">    &#125; else &#123;</div><div class="line">        configuration = [NSURLSessionConfiguration defaultSessionConfiguration];</div><div class="line">    &#125;</div><div class="line">    self.session = [NSURLSession zan_sessionWithConfiguration:configuration delegate:self delegateQueue:nil];</div><div class="line">    NSURLSessionDataTask *task = [self.session dataTaskWithRequest:self.request];</div><div class="line">    [task resume];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬å››æ­¥æ˜¯æˆ‘ä»¬å¯¹è¯·æ±‚è¿‡ç¨‹ä¸­ä¿¡ä»»æ‰€æœ‰è¯ä¹¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</div><div class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition, NSURLCredential *_Nullable))completionHandler &#123;</div><div class="line">    if (!challenge) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    NSURLSessionAuthChallengeDisposition disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">    NSString *host = self.request.allHTTPHeaderFields[@&quot;host&quot;];</div><div class="line">    if (![challenge.protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust]) &#123;</div><div class="line">        completionHandler(disposition, nil);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSURLCredential *credential = nil;</div><div class="line">    if ([self evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:host]) &#123;</div><div class="line">        disposition = NSURLSessionAuthChallengeUseCredential;</div><div class="line">        credential = [NSURLCredential credentialForTrust:challenge.protectionSpace.serverTrust];</div><div class="line">    &#125;</div><div class="line">    completionHandler(disposition, credential);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤æˆ‘ä»¬å®Œæˆäº†ä¸€æ•´å¥—ç¯å¢ƒåˆ‡æ¢å’Œè¯·æ±‚æ‹¦æˆªè½¬å‘çš„æ–¹æ¡ˆï¼Œä½†æ˜¯è¯¥å·¥å…·è¿˜æœªèƒ½åšåˆ°æ‹¦æˆªè½¬å‘ <code>WKWebView</code> çš„è¯·æ±‚ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·æ¥äº¤æµäº¤æµ~</p>
<h3 id="2018_u5E749_u670824_u65E5_u66F4_u65B0_uFF1A"><a href="#2018_u5E749_u670824_u65E5_u66F4_u65B0_uFF1A" class="headerlink" title="2018å¹´9æœˆ24æ—¥æ›´æ–°ï¼š"></a>2018å¹´9æœˆ24æ—¥æ›´æ–°ï¼š</h3><p>çœ‹åˆ°<a href="https://mp.weixin.qq.com/s/rhYKLIbXOsUJC_n6dt9UfA" target="_blank" rel="external">è…¾è®¯åœ¨ä½¿ç”¨ WK æ—¶é‡åˆ°çš„å‘</a>é‡Œé¢æåˆ°å¯¹ WK çš„ç½‘ç»œæ‹¦æˆªï¼Œç®€å•çš„è¯´å¯ä»¥é€šè¿‡æ³¨å†Œ http(s) scheme æ¥æ‹¦æˆªåˆ° WK çš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯ç”±äº WK æ˜¯åœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­è¿›è¡Œç½‘ç»œé€šä¿¡çš„ï¼Œä½¿ç”¨ NSURLProtocol å°†ç½‘ç»œè¯·æ±‚æ‹¦æˆªåˆ° App è¿›ç¨‹æ—¶ï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼ŒIPC ä¼šå°† HTTPBody å’Œ HTTPStream ä¸¢å¼ƒï¼Œæ‰€ä»¥ POST è¯·æ±‚çš„ Body å†…å®¹ä¼šä¸¢å¤±ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;u80CC_u666F&quot;&gt;&lt;a href=&quot;#u80CC_u666F&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å…¬å¸å†…ä¸€èˆ¬å¯¹è°ƒè¯•ç¯å¢ƒä¼šåˆ†ä¸º&lt;code&gt;çº¿ä¸Š&lt;/code&gt;ã€&lt;code&gt;é¢„å‘å¸ƒ&lt;/code&gt;å’Œ&lt;code&gt;QAæµ‹è¯•&lt;/code&gt;ä¸‰ç§ï¼Œè€Œåœ¨åˆ‡æ¢ç¯å¢ƒçš„æ—¶å€™å¤§å¤šè¿˜æ˜¯é€šè¿‡ç½‘é¡µæˆ–æ¡Œé¢åº”ç”¨ï¼Œå½“åœ¨è°ƒè¯•å®¢æˆ·ç«¯åº”ç”¨æ—¶è¿™æ ·çš„æ–¹å¼å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»„&lt;code&gt;ç¤¾ä¼šå…‰å“¥&lt;/code&gt;å°†æ•´å¥—ç¯å¢ƒåˆ‡æ¢å’Œè¯·æ±‚è½¬å‘çš„åŸç†ç†æ¸…æ™°ä¹‹åå®ç°äº† Android ç‰ˆçš„ Debug ç¯å¢ƒåˆ‡æ¢å·¥å…·ï¼Œè€Œæˆ‘åˆ™æ ¹æ®å…¶åŸç†å®ç°äº† iOS ç‰ˆã€‚å®¢æˆ·ç«¯æ¥å…¥è¯¥å·¥å…·ä¹‹åï¼Œåªéœ€åœ¨åº”ç”¨å†…å³å¯åˆ‡æ¢ç¯å¢ƒå’ŒæŒ‡å®šè°ƒè¯•ç›®å½•ï¼ˆæ¯ä¸ªç›®å½•ç‹¬ç«‹éƒ¨ç½²ä»£ç ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="NSURLProtocol" scheme="http://yuzeyang.github.io/tags/NSURLProtocol/"/>
    
  </entry>
  
  <entry>
    <title>WebSocket å®ç°åŸç†</title>
    <link href="http://yuzeyang.github.io/2017/07/02/websocket/"/>
    <id>http://yuzeyang.github.io/2017/07/02/websocket/</id>
    <published>2017-07-02T02:28:06.000Z</published>
    <updated>2017-07-20T14:26:41.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¹‹å‰æˆ‘ä»¬å°† <a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="external">CocoaAsyncSocket</a> ä½œä¸ºåº•å±‚å®ç°ï¼Œåœ¨å…¶ä¸Šé¢å°è£…äº†ä¸€å¥— Socket é€šä¿¡æœºåˆ¶ä»¥åŠä¸šåŠ¡æ¥å£ï¼Œæœ€è¿‘æˆ‘ä»¬å¼€å§‹ç ”ç©¶ WebSocket ï¼Œå¹¶ç”¨æ¥æ›¿æ¢æ‰åŸå…ˆçš„ CocoaAsyncSocket ï¼Œç®€å•æ¥è¯´ä¸€ä¸‹ä¸¤è€…çš„å…³ç³»ï¼ŒWebSocket å’Œ Socket è™½ç„¶åç§°ä¸Šå¾ˆåƒï¼Œä½†ä¸¤è€…æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼Œ WebSocket æ˜¯å»ºç«‹åœ¨ TCP/IP åè®®ä¹‹ä¸Šï¼Œå±äºåº”ç”¨å±‚çš„åè®®ï¼Œè€Œ Socket æ˜¯åœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒæ˜¯å°† TCP/IP å±‚çš„å¤æ‚æ“ä½œæŠ½è±¡æˆå‡ ä¸ªç®€å•çš„æ¥å£æ¥æä¾›ç»™åº”ç”¨å±‚è°ƒç”¨ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™æ¬¡æ›¿æ¢å‘¢ï¼ŸåŸå› æ˜¯æˆ‘ä»¬æœåŠ¡ç«¯åœ¨åšæ”¹é€ ï¼ŒåŒæ—¶ç½‘é¡µç‰ˆ IM å·²ç»ä½¿ç”¨äº† WebSocket ï¼Œå®¢æˆ·ç«¯ä¹Ÿé‡‡ç”¨çš„è¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´ç»´æŠ¤ä¸€å¥—ä»£ç ä¼šæ›´å¥½æ›´æ–¹ä¾¿ï¼Œè€Œä¸” WebSocket åœ¨ä½“ç§¯ã€å®æ—¶æ€§å’Œæ‰©å±•ä¸Šéƒ½å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚</p>
<p>WebSocket æœ€æ–°çš„åè®®æ˜¯ <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="external">13 RFC 6455</a> ï¼Œè¦ç†è§£ WebSocket çš„å®ç°ï¼Œä¸€å®šè¦å»ç†è§£å®ƒçš„åè®®ï¼~</p>
<a id="more"></a>
<h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>WebSocket çš„å®ç°åˆ†ä¸ºæ¡æ‰‹ï¼Œæ•°æ®å‘é€/è¯»å–ï¼Œå…³é—­è¿æ¥ã€‚</p>
<p>è¿™é‡Œé¦–å…ˆæ”¾ä¸Šä¸€å¼ æˆ‘ä»¬ç»„ <a href="https://geminiwen.com/" target="_blank" rel="external">@çœé•¿</a> ï¼ˆæ¨èå¤§å®¶å»è¯»ä¸€è¯»çœé•¿çš„åšå®¢ï¼Œå¹²è´§å¾ˆå¤šğŸ‘ï¼‰æ•´ç†å‡ºæ¥çš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿å¤§å®¶å»ç†è§£ï¼Œå…¶ä¸­mbedTLSåšçš„æ˜¯æ•°æ®çš„åŠ è§£å¯†ï¼Œå¯ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/libchat%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h2 id="u63E1_u624B"><a href="#u63E1_u624B" class="headerlink" title="æ¡æ‰‹"></a>æ¡æ‰‹</h2><p>æ¡æ‰‹è¦ä»è¯·æ±‚å¤´å»ç†è§£ã€‚</p>
<p>WebSocket é¦–å…ˆå‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œåœ¨è¯·æ±‚å¤´åŠ ä¸Š  <code>Upgrade</code> å­—æ®µï¼Œè¯¥å­—æ®µç”¨äºæ”¹å˜ HTTP åè®®ç‰ˆæœ¬æˆ–è€…æ˜¯æ¢ç”¨å…¶ä»–åè®®ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠ <code>Upgrade</code> çš„å€¼è®¾ä¸º <code>websocket</code> ï¼Œå°†å®ƒå‡çº§ä¸º WebSocket åè®®ã€‚</p>
<p>åŒæ—¶è¦æ³¨æ„ <code>Sec-WebSocket-Key</code> å­—æ®µï¼Œå®ƒç”±å®¢æˆ·ç«¯ç”Ÿæˆå¹¶å‘ç»™æœåŠ¡ç«¯ï¼Œç”¨äºè¯æ˜æœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå¯å—ä¿¡çš„è¿æ¥æ¡æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æœåŠ¡ç«¯æ’é™¤è‡ªèº«æ¥æ”¶åˆ°çš„ç”±é WebSocket å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸²éšæœºç»è¿‡ <code>base64</code> ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /chat HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</div><div class="line">Origin: http://example.com</div><div class="line">Sec-WebSocket-Protocol: chat, superchat</div><div class="line">Sec-WebSocket-Version: 13</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ç®€åŒ–è¯·æ±‚å¤´ï¼Œå°†è¯·æ±‚ä»¥å­—ç¬¦ä¸²æ–¹å¼å‘é€å‡ºå»ï¼Œå½“ç„¶åˆ«å¿˜äº†æœ€åçš„ä¸¤ä¸ªç©ºè¡Œä½œä¸ºåŒ…ç»“æŸï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * fmt = <span class="string">"GET %s HTTP/1.1\r\n"</span></div><div class="line">                   <span class="string">"Upgrade: websocket\r\n"</span></div><div class="line">                   <span class="string">"Connection: Upgrade\r\n"</span></div><div class="line">                   <span class="string">"Host: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Key: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Version: 13\r\n"</span></div><div class="line">                   <span class="string">"\r\n"</span>;</div><div class="line">size = <span class="built_in">strlen</span>(fmt) + <span class="built_in">strlen</span>(path) + <span class="built_in">strlen</span>(host) + <span class="built_in">strlen</span>(ws-&gt;key);</div><div class="line">buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</div><div class="line"><span class="built_in">sprintf</span>(buf, fmt, path, host, ws-&gt;key);</div><div class="line">size = <span class="built_in">strlen</span>(buf);</div><div class="line">nbytes = ws-&gt;io_send(ws, ws-&gt;context, buf, size);</div></pre></td></tr></table></figure>
<p>æ”¶åˆ°è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šåšä¸€æ¬¡å“åº”ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</div></pre></td></tr></table></figure>
<p>é‡Œé¢é‡è¦çš„æ˜¯ <code>Sec-WebSocket-Accept</code> ï¼ŒæœåŠ¡ç«¯é€šè¿‡ä»å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­è¯»å– <code>Sec-WebSocket-Key</code> ä¸ä¸€ä¸²å…¨å±€å”¯ä¸€çš„æ ‡è¯†å­—ç¬¦ä¸²ï¼ˆä¿—ç§°é­”ä¸²ï¼‰â€œ258EAFA5-E914-47DA-   95CA-C5AB0DC85B11â€åšæ‹¼æ¥ï¼Œç”Ÿæˆé•¿åº¦ä¸º160ä½çš„ <code>SHA-1</code> å­—ç¬¦ä¸²ï¼Œç„¶åè¿›è¡Œ <code>base64</code> ç¼–ç ï¼Œä½œä¸º <code>Sec-WebSocket-Accept</code> çš„å€¼å›ä¼ ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å†å»è§£æè¿™ä¸ªå€¼ï¼Œä¸è‡ªå·±åŠ å¯†ç¼–ç åçš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>å¤„ç†æ¡æ‰‹ HTTP å“åº”è§£æçš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ nodejs çš„ <a href="https://github.com/nodejs/http-parser" target="_blank" rel="external">http-paser</a> ï¼Œè§£ææ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯¹å¤´ä¿¡æ¯çš„é€å­—è¯»å–å†å¤„ç†ï¼Œå…·ä½“å¤„ç†ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„çŠ¶æ€æœºå®ç°ã€‚è§£æå®Œæˆåä½ éœ€è¦å¯¹å…¶å†…å®¹è¿›è¡Œè§£æï¼Œçœ‹è¿”å›æ˜¯å¦æ­£ç¡®ï¼ŒåŒæ—¶å»ç®¡ç†ä½ çš„æ¡æ‰‹çŠ¶æ€ã€‚</p>
<h2 id="u6570_u636E_u53D1_u9001/_u8BFB_u53D6"><a href="#u6570_u636E_u53D1_u9001/_u8BFB_u53D6" class="headerlink" title="æ•°æ®å‘é€/è¯»å–"></a>æ•°æ®å‘é€/è¯»å–</h2><p>æ•°æ®çš„å¤„ç†å°±è¦æ‹¿è¿™ä¸ªå¸§åè®®å›¾æ¥è¯´æ˜äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0                   1                   2                   3</div><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</div><div class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</div><div class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</div><div class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</div><div class="line">| |1|2|3|       |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |          Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æ•°å­—çš„å«ä¹‰ï¼Œæ•°å­—è¡¨ç¤ºä½ï¼Œ0-7è¡¨ç¤ºæœ‰8ä½ï¼Œç­‰äº1ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥å¦‚æœè¦ç»„è£…ä¸€ä¸ªå¸§æ•°æ®å¯ä»¥è¿™æ ·å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *rev = (rev *)<span class="built_in">malloc</span>(<span class="number">4</span>);</div><div class="line">rev[<span class="number">0</span>] = (<span class="keyword">char</span>)(<span class="number">0x81</span> &amp; <span class="number">0xff</span>);</div><div class="line">rev[<span class="number">1</span>] = <span class="number">126</span> &amp; <span class="number">0x7f</span>;</div><div class="line">rev[<span class="number">2</span>] = <span class="number">1</span>;</div><div class="line">rev[<span class="number">3</span>] = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>okï¼Œäº†è§£äº†å¸§æ•°æ®çš„æ ·å­ï¼Œæˆ‘ä»¬åè¿‡æ¥å»ç†è§£å€¼å¯¹åº”çš„å¸§å­—æ®µã€‚</p>
<p>é¦–å…ˆ<code>0x81</code>æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªæ˜¯åå…­è¿›åˆ¶æ•°æ®ï¼Œè½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯<code>1000 0001</code>ï¼Œ æ˜¯ä¸€ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ®µé‡Œé¢æ¯ä¸€ä½çš„å€¼ï¼š</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 </div><div class="line">+-+-+-+-+-------+</div><div class="line">|F|R|R|R| opcode|</div><div class="line">|I|S|S|S|  (4)  |</div><div class="line">|N|V|V|V|       |</div><div class="line">| |1|2|3|       |</div><div class="line">+-+-+-+-+-------+</div></pre></td></tr></table></figure>
<ul>
<li><p><code>FIN</code> è¡¨ç¤ºè¯¥å¸§æ˜¯ä¸æ˜¯æ¶ˆæ¯çš„æœ€åä¸€å¸§ï¼Œ1è¡¨ç¤ºç»“æŸï¼Œ0è¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€å¸§ã€‚</p>
</li>
<li><p><code>RSV1, RSV2, RSV3</code> å¿…é¡»ä¸º0ï¼Œé™¤éæ‰©å±•åå•†å®šä¹‰äº†ä¸€ä¸ªé0çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰é0å€¼ï¼Œä¸”æ”¶åˆ°äº†é0çš„  <code>RSV</code> ï¼Œé‚£ä¹ˆ WebSocket çš„è¿æ¥ä¼šå¤±æ•ˆï¼Œå»ºè®®æ˜¯æ–­å¼€è¿æ¥ã€‚</p>
</li>
<li><p><code>opcode</code> ç”¨æ¥æè¿° <code>Payload data</code> çš„å®šä¹‰ï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„ <code>opcode</code> ï¼ŒåŒæ ·ä¼šä½¿ WebSocket è¿æ¥å¤±æ•ˆï¼Œåè®®å®šä¹‰äº†ä»¥ä¸‹å€¼ï¼š</p>
<ul>
<li>%x0 è¡¨ç¤ºè¿ç»­çš„å¸§</li>
<li>%x1 è¡¨ç¤º text å¸§</li>
<li>%x2 è¡¨ç¤ºäºŒè¿›åˆ¶å¸§</li>
<li>%x3-7 é¢„ç•™ç»™éæ§åˆ¶å¸§</li>
<li>%x8 è¡¨ç¤ºå…³é—­è¿æ¥å¸§</li>
<li>%x9 è¡¨ç¤º ping</li>
<li>%xA è¡¨ç¤º pong</li>
<li>%xB-F é¢„ç•™ç»™æ§åˆ¶å¸§</li>
</ul>
<p>è¿ç»­å¸§æ˜¯å’Œ FIN å€¼ç›¸å…³è”çš„ï¼Œå®ƒè¡¨æ˜å¯èƒ½ç”±äºæ¶ˆæ¯åˆ†ç‰‡çš„åŸå› ï¼Œå°†åŸæœ¬ä¸€ä¸ªå¸§çš„æ•°æ®åˆ†ä¸ºå¤šä¸ªå¸§ï¼Œè¿™æ—¶å€™å‰ä¸€å¸§çš„ opcode å°±æ˜¯0ï¼ŒFIN ä¹Ÿæ˜¯0ï¼Œæœ€åä¸€å¸§çš„ opcode å°±ä¸å†æ˜¯0ï¼ŒFIN å°±æ˜¯1äº†ã€‚</p>
<p>å†å¯ä»¥çœ‹åˆ° opcode é¢„ç•™äº†éæ§åˆ¶å¸§å’Œæ§åˆ¶å¸§ï¼Œè¿™ä¸¤ä¸ªåˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æ§åˆ¶å¸§è¡¨ç¤º WebSocket çš„çŠ¶æ€ä¿¡æ¯ï¼Œåƒæ˜¯å®šä¹‰çš„åˆ†ç‰‡ï¼Œå…³é—­è¿æ¥ï¼Œpingå’Œpongã€‚</p>
<p>éæ§åˆ¶å¸§å°±æ˜¯æ•°æ®å¸§ï¼Œåƒæ˜¯ text å¸§ï¼ŒäºŒè¿›åˆ¶å¸§ã€‚</p>
</li>
</ul>
<p><code>0xff</code> ä½œç”¨å°±æ˜¯å–å‡ºéœ€è¦çš„äºŒè¿›åˆ¶å€¼ã€‚</p>
<p>ä¸‹é¢å†æ¥çœ‹<code>126</code>ï¼Œ126åˆ™è¡¨ç¤ºçš„æ˜¯ <code>Payload len</code> ï¼Œä¹Ÿå°±æ˜¯ Payload çš„é•¿åº¦ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">                8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">                +-+-------------+-------------------------------+</div><div class="line">                |M| Payload len |    Extended payload length    |</div><div class="line">                |A|     (7)     |             (16/64)           |</div><div class="line">                |S|             |   (if payload len==126/127)   |</div><div class="line">                |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |           Payload Data        |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<ul>
<li><code>MASK</code>  è¡¨ç¤º<code>Playload data</code> æ˜¯å¦è¦åŠ æ©ç ï¼Œå¦‚æœè®¾æˆ1ï¼Œåˆ™éœ€è¦èµ‹å€¼ <code>Masking-key</code> ã€‚æ‰€æœ‰ä»å®¢æˆ·ç«¯å‘åˆ°æœåŠ¡ç«¯çš„å¸§éƒ½è¦åŠ æ©ç </li>
<li><code>Playload len</code> è¡¨ç¤º Payload çš„é•¿åº¦ï¼Œè¿™é‡Œåˆ†ä¸ºä¸‰ç§æƒ…å†µ<ul>
<li>é•¿åº¦å°äº126ï¼Œåˆ™åªéœ€è¦7ä½</li>
<li>é•¿åº¦æ˜¯126ï¼Œåˆ™éœ€è¦é¢å¤–2ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> </li>
<li>é•¿åº¦æ˜¯127ï¼Œåˆ™éœ€è¦é¢å¤–8ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> + <code>Extended payload length continued</code> ï¼Œ<code>Extended payload length</code> æ˜¯2ä¸ªå­—èŠ‚ï¼Œ<code>Extended payload length continued</code> æ˜¯6ä¸ªå­—èŠ‚</li>
</ul>
</li>
<li><code>Playload len</code> åˆ™è¡¨ç¤º <code>Extension data</code> ä¸ <code>Application data</code> çš„å’Œ</li>
<li><code>Masking-key</code> æ˜¯åœ¨ <code>MASK</code> è®¾ç½®æˆ1ä¹‹åï¼Œéšæœºç”Ÿæˆçš„4å­—èŠ‚é•¿åº¦çš„æ•°æ®ï¼Œç„¶åå’Œ <code>Payload Data</code> åšå¼‚æˆ–è¿ç®—</li>
<li><code>Payload Data</code> å°±æ˜¯æˆ‘ä»¬å‘é€çš„æ•°æ®</li>
</ul>
<p>è€Œæ•°æ®çš„å‘é€å’Œè¯»å–å°±æ˜¯å¯¹å¸§çš„å°è£…å’Œè§£æã€‚</p>
<p>æ•°æ®å‘é€:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__wrap_packet</span><span class="params">(_WS_IN <span class="keyword">websocket_t</span> *ws,</span></span></div><div class="line">                     _WS_IN <span class="keyword">const</span> <span class="keyword">char</span> *payload,</div><div class="line">                     _WS_IN <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size,</div><div class="line">                     _WS_IN <span class="keyword">int</span> flags,</div><div class="line">                     _WS_OUT <span class="keyword">char</span>** out,</div><div class="line">                     _WS_OUT <span class="keyword">uint64_t</span> *out_size) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> timeval tv;</div><div class="line">    <span class="keyword">char</span> mask[<span class="number">4</span>];</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask_int;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload_len_bits;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload_bit_offset = <span class="number">6</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extend_payload_len_bits, i;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> frame_size;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MASK_BIT_LEN = <span class="number">4</span>;</div><div class="line"></div><div class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">    srand(tv.tv_usec * tv.tv_sec);</div><div class="line">    mask_int = rand();</div><div class="line">    <span class="built_in">memcpy</span>(mask, &amp;mask_int, <span class="number">4</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * payload_len bits</div><div class="line">     * ref to https://tools.ietf.org/html/rfc6455#section-5.2</div><div class="line">     * If 0-125, that is the payload length</div><div class="line">     *</div><div class="line">     * If payload length is equals 126, the following 2 bytes interpreted as a</div><div class="line">     * 16-bit unsigned integer are the payload length</div><div class="line">     * </div><div class="line">     * If 127, the following 8 bytes interpreted as a 64-bit unsigned integer (the</div><div class="line">     * most significant bit MUST be 0) are the payload length.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (payload_size &lt;= <span class="number">125</span>) &#123;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + mask bit len + payload len)</span></div><div class="line">        extend_payload_len_bits = <span class="number">0</span>;</div><div class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + MASK_BIT_LEN + payload_size;</div><div class="line"></div><div class="line">        payload_len_bits = payload_size;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">125</span> &amp;&amp; payload_size &lt;= <span class="number">0xffff</span>) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">2</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">        payload_len_bits = <span class="number">126</span>;</div><div class="line"></div><div class="line">        payload_bit_offset += extend_payload_len_bits;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">0xffff</span> &amp;&amp; payload_size &lt;= <span class="number">0xffffffffffffffff</span>LL) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">8</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">        payload_len_bits = <span class="number">127</span>;</div><div class="line">        payload_bit_offset += extend_payload_len_bits;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</div><div class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_DATA_TOO_LARGE_ERR);</div><div class="line">            ws-&gt;error_cb(ws, err);</div><div class="line">            <span class="built_in">free</span>(err);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> WS_SEND_SEND_ERR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    *out_size = frame_size;</div><div class="line">    <span class="keyword">char</span> *data = (*out) = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(frame_size);</div><div class="line">    <span class="keyword">if</span> (data == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</div><div class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_SEND_ERR);</div><div class="line">            ws-&gt;error_cb(ws, err);</div><div class="line">            <span class="built_in">free</span>(err);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> -ENOMEM;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">char</span> *buf_offset = data;</div><div class="line"></div><div class="line">    bzero(data, frame_size);</div><div class="line">    *data = flags &amp; <span class="number">0xff</span>;</div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// set mask bit = 1</span></div><div class="line">    *(buf_offset) = payload_len_bits | <span class="number">0x80</span>; <span class="comment">//payload length with mask bit on</span></div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">2</span>;</div><div class="line">    <span class="keyword">if</span> (payload_len_bits == <span class="number">126</span>) &#123;</div><div class="line">        payload_size &amp;= <span class="number">0xffff</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_len_bits == <span class="number">127</span>) &#123;</div><div class="line">        payload_size &amp;= <span class="number">0xffffffffffffffff</span>LL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; extend_payload_len_bits; i++) &#123;</div><div class="line">        *(buf_offset + i) = *((<span class="keyword">char</span> *)&amp;payload_size + (extend_payload_len_bits - i - <span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * according to https://tools.ietf.org/html/rfc6455#section-5.3</div><div class="line">     * </div><div class="line">     * buf_offset is set to mask bit</div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset - <span class="number">4</span>;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">         *(buf_offset + i) = mask[i] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * mask the payload data </div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset;</div><div class="line">    <span class="built_in">memcpy</span>(buf_offset, payload, payload_size);</div><div class="line">    mask_payload(mask, buf_offset, payload_size);</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mask_payload</span><span class="params">(<span class="keyword">char</span> mask[<span class="number">4</span>], <span class="keyword">char</span> *payload, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; payload_size; i++) &#123;</div><div class="line">        *(payload + i) ^= mask[i % <span class="number">4</span>] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•°æ®è§£æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws_recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">        ret = ws__recv(ws);</div><div class="line">        <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = OK, i;</div><div class="line">    <span class="keyword">int</span> state = ws-&gt;rd_state;</div><div class="line">    <span class="keyword">char</span> *rd_buf;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span>(state) &#123;</div><div class="line">        <span class="keyword">case</span> WS_READ_IDLE: &#123;</div><div class="line">            ret = ws__make_up(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">ws_frame_t</span> * frame;</div><div class="line">            <span class="keyword">if</span> (ws-&gt;c_frame == <span class="literal">NULL</span>) &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line">            frame = ws-&gt;c_frame;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;fin = (*(rd_buf) &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">            frame-&gt;op_code = *(rd_buf) &amp; <span class="number">0x0f</span>u;</div><div class="line">            frame-&gt;payload_len = *(rd_buf + <span class="number">1</span>) &amp; <span class="number">0x7f</span>u;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;payload_len &lt; <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">2</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame -&gt; payload_len == <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">4</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_2_WORDS;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">8</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_8_WORDS;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_2_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 2</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line"></div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_8_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 8</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_PAYLOAD: &#123;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">uint64_t</span> payload_len = frame-&gt;payload_len;</div><div class="line">            ret = ws__make_up(ws, payload_len);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;payload = <span class="built_in">malloc</span>(payload_len);</div><div class="line">            <span class="built_in">memcpy</span>(frame-&gt;payload, rd_buf, payload_len);</div><div class="line"></div><div class="line">            ws__reset_buf(ws, payload_len);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;fin == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// is control frame</span></div><div class="line">                ws__dispatch_msg(ws, frame);</div><div class="line">                ws__clean_frame(ws);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws-&gt;rd_state = WS_READ_IDLE;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u5173_u95ED_u8FDE_u63A5"><a href="#u5173_u95ED_u8FDE_u63A5" class="headerlink" title="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥</h2><p>å…³é—­è¿æ¥åˆ†ä¸ºä¸¤ç§ï¼šæœåŠ¡ç«¯å‘èµ·å…³é—­å’Œå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ã€‚</p>
<p>æœåŠ¡ç«¯è·Ÿå®¢æˆ·ç«¯çš„å¤„ç†åŸºæœ¬ä¸€è‡´ï¼Œä»¥æœåŠ¡ç«¯ä¸ºä¾‹ï¼š</p>
<p>æœåŠ¡ç«¯å‘èµ·å…³é—­çš„æ—¶å€™ï¼Œä¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå…³é—­å¸§ï¼Œå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°å¸§çš„æ—¶å€™é€šè¿‡è§£æå‡ºå¸§çš„opcodeæ¥åˆ¤æ–­æ˜¯å¦æ˜¯å…³é—­å¸§ï¼Œç„¶ååŒæ ·å‘æœåŠ¡ç«¯å†å‘é€ä¸€ä¸ªå…³é—­å¸§ä½œä¸ºå›åº”ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (op_code == OP_CLOSE) &#123;</div><div class="line">    <span class="keyword">int</span> status_code;</div><div class="line">    <span class="keyword">char</span> *reason;</div><div class="line">    <span class="keyword">char</span> *status_code_buf = (<span class="keyword">char</span> *)&amp;status_code;</div><div class="line">    status_code_buf[<span class="number">0</span>] = payload[<span class="number">1</span>];</div><div class="line">    status_code_buf[<span class="number">1</span>] = payload[<span class="number">0</span>];</div><div class="line">    reason = payload + <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ws-&gt;state != WS_STATE_CLOSED) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * should send response to remote server</div><div class="line">         */</div><div class="line"></div><div class="line">        ws_send(ws, <span class="literal">NULL</span>, <span class="number">0</span>, OP_CLOSE | FLAG_FIN);</div><div class="line">        ws-&gt;state = WS_STATE_CLOSED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// close connection</span></div><div class="line">    <span class="keyword">if</span> (ws-&gt;close_cb) &#123;</div><div class="line">        ws-&gt;close_cb(ws, status_code, reason);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹WebSocketçš„å­¦ä¹ ä¸»è¦æ˜¯å¯¹åè®®çš„ç†è§£ï¼Œç†è§£äº†åè®®ï¼Œä¸Šé¢å¤æ‚çš„ä»£ç è‡ªç„¶è€Œç„¶å°±ä¼šæ˜ç™½~</p>
<h2 id="u540E_u8BB0"><a href="#u540E_u8BB0" class="headerlink" title="åè®°"></a>åè®°</h2><p>å¯¹äºI/Oæ“ä½œçš„åŸç†ï¼Œæ¨èå¤§å®¶å¯ä»¥çœ‹çœ‹è¿™ä¸ªï¼š<a href="https://www.zhihu.com/question/20122137/answer/14049112#" target="_blank" rel="external">epoll æˆ–è€… kqueue çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;u80CC_u666F&quot;&gt;&lt;a href=&quot;#u80CC_u666F&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ä¹‹å‰æˆ‘ä»¬å°† &lt;a href=&quot;https://github.com/robbiehanson/CocoaAsyncSocket&quot;&gt;CocoaAsyncSocket&lt;/a&gt; ä½œä¸ºåº•å±‚å®ç°ï¼Œåœ¨å…¶ä¸Šé¢å°è£…äº†ä¸€å¥— Socket é€šä¿¡æœºåˆ¶ä»¥åŠä¸šåŠ¡æ¥å£ï¼Œæœ€è¿‘æˆ‘ä»¬å¼€å§‹ç ”ç©¶ WebSocket ï¼Œå¹¶ç”¨æ¥æ›¿æ¢æ‰åŸå…ˆçš„ CocoaAsyncSocket ï¼Œç®€å•æ¥è¯´ä¸€ä¸‹ä¸¤è€…çš„å…³ç³»ï¼ŒWebSocket å’Œ Socket è™½ç„¶åç§°ä¸Šå¾ˆåƒï¼Œä½†ä¸¤è€…æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼Œ WebSocket æ˜¯å»ºç«‹åœ¨ TCP/IP åè®®ä¹‹ä¸Šï¼Œå±äºåº”ç”¨å±‚çš„åè®®ï¼Œè€Œ Socket æ˜¯åœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒæ˜¯å°† TCP/IP å±‚çš„å¤æ‚æ“ä½œæŠ½è±¡æˆå‡ ä¸ªç®€å•çš„æ¥å£æ¥æä¾›ç»™åº”ç”¨å±‚è°ƒç”¨ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™æ¬¡æ›¿æ¢å‘¢ï¼ŸåŸå› æ˜¯æˆ‘ä»¬æœåŠ¡ç«¯åœ¨åšæ”¹é€ ï¼ŒåŒæ—¶ç½‘é¡µç‰ˆ IM å·²ç»ä½¿ç”¨äº† WebSocket ï¼Œå®¢æˆ·ç«¯ä¹Ÿé‡‡ç”¨çš„è¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´ç»´æŠ¤ä¸€å¥—ä»£ç ä¼šæ›´å¥½æ›´æ–¹ä¾¿ï¼Œè€Œä¸” WebSocket åœ¨ä½“ç§¯ã€å®æ—¶æ€§å’Œæ‰©å±•ä¸Šéƒ½å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚&lt;/p&gt;
&lt;p&gt;WebSocket æœ€æ–°çš„åè®®æ˜¯ &lt;a href=&quot;https://tools.ietf.org/html/rfc6455&quot;&gt;13 RFC 6455&lt;/a&gt; ï¼Œè¦ç†è§£ WebSocket çš„å®ç°ï¼Œä¸€å®šè¦å»ç†è§£å®ƒçš„åè®®ï¼~&lt;/p&gt;
    
    </summary>
    
    
      <category term="WebSocket" scheme="http://yuzeyang.github.io/tags/WebSocket/"/>
    
  </entry>
  
  <entry>
    <title>Mantle è§£æ</title>
    <link href="http://yuzeyang.github.io/2017/06/18/Mantle/"/>
    <id>http://yuzeyang.github.io/2017/06/18/Mantle/</id>
    <published>2017-06-18T06:56:57.000Z</published>
    <updated>2017-07-02T02:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹ JSON è§£æåº“ç›®å‰æµè¡Œçš„ä¹Ÿæ˜¯éå¸¸çš„å¤šï¼Œ<a href="https://github.com/jsonmodel/jsonmodel" target="_blank" rel="external">jsonmodel</a> ã€<a href="https://github.com/Mantle/Mantle" target="_blank" rel="external">Mantle</a> ã€<a href="https://github.com/ibireme/YYModel" target="_blank" rel="external">YYModel</a> ç­‰éƒ½æ˜¯å¤§å®¶å¸¸ç”¨çš„ï¼Œä½¿ç”¨è¿™äº›åº“çš„å¥½å¤„å°±æ˜¯ä½ æ— éœ€å…³å¿ƒæ•°æ®è§£æè½¬æ¢å’Œå¤æ‚çš„ç±»å‹åˆ¤æ–­å¤„ç†ï¼Œä½ åªéœ€è¦ç¡®å®šå¥½å®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„èƒ½å¤Ÿä¸åç«¯æ•°æ®ç»“æ„ç›¸å¯¹åº”å³å¯ï¼Œè€Œè¿™äº›åº“é‡Œé¢å¯¹äºè§£æçš„å¤„ç†ä¹Ÿéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œæ— éæ˜¯åœ¨ä½¿ç”¨ã€æ€§èƒ½å’Œå¼‚å¸¸å¤„ç†ä¸Šæœ‰äº›å·®åˆ«ï¼Œè¿™é‡Œæ¨èä¸€ä¸‹éƒ­æ›œæºå¤§ç¥ï¼ˆ YYModel çš„ä½œè€…ï¼‰çš„æ–‡ç« ï¼Œå†…å®¹æ˜¯å¯¹<a href="http://blog.ibireme.com/2015/10/23/ios_model_framework_benchmark/" target="_blank" rel="external">å„å¤§è§£æåº“è¿›è¡Œäº†æ¯”è¾ƒ</a>ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œäº†è§£å…¶è§£æè¿‡ç¨‹æ˜¯æœ€ä¸ºåŸºç¡€çš„ï¼Œè¿™æ¬¡çœ‹å®Œ Mantle çš„è§£æå¤„ç†ï¼Œæˆ‘ä¹Ÿåšä¸ªç®€å•çš„æ€»ç»“ï¼Œå¤§å®¶å¯ä»¥äº’ç›¸å­¦ä¹ äº¤æµã€‚</p>
<a id="more"></a>
<p>é¦–å…ˆ Mantle å¯¹äº JSON è§£æçš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<p>ç¬¬ä¸€æ­¥æ˜¯å¯¹ Model å­—æ®µçš„è½¬æ¢å¤„ç†</p>
<p>ç¬¬äºŒæ­¥æ˜¯å¯¹ JSON Dictionary å€¼çš„è½¬æ¢å¤„ç†</p>
<p>ç¬¬ä¸‰æ­¥æ˜¯å¯¹ Model çš„èµ‹å€¼</p>
<h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>å¯¹äºè§£æ JSON æ•°æ®ï¼Œæˆ‘ä»¬æ¯”è¾ƒå¸¸ç”¨æ˜¯ä»¥ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œ<code>modelClass</code> æŒ‡çš„æ˜¯ç»§æ‰¿äº <code>MTLModel</code> çš„å­ç±»ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦è§£ææˆçš„ç›®æ ‡ Model ç±»ï¼Œ <code>JSONDictionary</code> åˆ™æ˜¯éœ€è¦è§£æçš„ JSON æ•°æ®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+ (id)modelOfClass:(Class)modelClass fromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error &#123;</div><div class="line">	MTLJSONAdapter *adapter = [[self alloc] initWithModelClass:modelClass];</div><div class="line"></div><div class="line">	return [adapter modelFromJSONDictionary:JSONDictionary error:error];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ç°ä¸Šçœ‹å°±ä¸¤æ­¥ï¼Œå…ˆæ ¹æ® modelClass åˆå§‹åŒ–ä¸€ä¸ªé€‚é…å™¨ï¼Œå†æ ¹æ® JSON æ•°æ®è¿”å› model å¯¹è±¡ã€‚</p>
<p>åˆå§‹åŒ–é€‚é…å™¨çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬åˆ†æ®µæ¥è¯´å‡ ä¸ªå…³é”®çš„åœ°æ–¹ã€‚</p>
<p>é¦–å…ˆæ£€æŸ¥çš„å°±æ˜¯ Model æ˜¯å¦å®ç°äº† <code>MTLJSONSerializing</code> åè®®ï¼Œæœªå®ç°çš„è¯ä¼šè§¦å‘æ–­è¨€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (id)initWithModelClass:(Class)modelClass &#123;</div><div class="line">	NSParameterAssert(modelClass != nil);</div><div class="line">	NSParameterAssert([modelClass conformsToProtocol:@protocol(MTLJSONSerializing)]);</div><div class="line">  </div><div class="line">  	self = [super init];</div><div class="line">	if (self == nil) return nil;</div><div class="line"></div><div class="line">	_modelClass = modelClass;</div><div class="line"></div><div class="line">	_JSONKeyPathsByPropertyKey = [modelClass JSONKeyPathsByPropertyKey];</div><div class="line">  	</div><div class="line">  	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå…ˆæ¥çœ‹ä¸‹  <code>MTLJSONSerializing</code> åè®®ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@protocol MTLJSONSerializing &lt;MTLModel&gt;</div><div class="line">@required</div><div class="line">+ (NSDictionary *)JSONKeyPathsByPropertyKey;</div><div class="line"></div><div class="line">@optional</div><div class="line">+ (NSValueTransformer *)JSONTransformerForKey:(NSString *)key;</div><div class="line">+ (Class)classForParsingJSONDictionary:(NSDictionary *)JSONDictionary;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p> <code>JSONKeyPathsByPropertyKey</code> æ–¹æ³•æ˜¯é‡Œé¢å”¯ä¸€ä¸€ä¸ªå¿…é¡»è¦å®ç°çš„ï¼Œå®ƒæ˜¯ç”¨äºå°†å±æ€§å’Œ JSON çš„è§£æè·¯å¾„åšå…³è”ï¼Œå®ƒä¸ä»…ä»…å¯ä»¥ç”¨äºç»™å±æ€§èµ·â€œåˆ«åâ€ï¼Œè¿˜å¯ä»¥ç”¨äºå¤šçº§è§£æå’Œå¤šå±‚åµŒå¥—ï¼Œç”¨å®˜æ–¹ä¾‹å­æ¥ä¸¾ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">+ (NSDictionary *)JSONKeyPathsByPropertyKey &#123;</div><div class="line">   return @&#123;</div><div class="line">       @&quot;name&quot;: @&quot;POI.name&quot;,</div><div class="line">       @&quot;point&quot;: @[ @&quot;latitude&quot;, @&quot;longitude&quot; ],</div><div class="line">       @&quot;starred&quot;: @&quot;starred&quot;</div><div class="line">   &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">åœ¨æ˜ å°„è¿‡ç¨‹ä¸­ starred ä¸ JSONDictionary[@&quot;starred&quot;] åšæ˜ å°„ï¼Œ</div><div class="line">name ä¸ JSONDictionary[@&quot;POI&quot;][@&quot;name&quot;] åšæ˜ å°„ï¼Œ</div><div class="line">point åˆ™ç­‰åŒäºä»¥ä¸‹è¿™ä¸ª dictionary</div><div class="line">@&#123;</div><div class="line">   @&quot;latitude&quot;: JSONDictionary[@&quot;latitude&quot;],</div><div class="line">   @&quot;longitude&quot;: JSONDictionary[@&quot;longitude&quot;]</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è®¾è®¡å¾ˆæ˜¯æ–¹ä¾¿ï¼Œå¯ä»¥è‡ªç”±å®šä¹‰æ˜ å°„è§£æä¹‹é—´çš„å…³ç³»ï¼Œä½†æ˜¯åœ¨å®ç°çš„æ—¶å€™ä¼šå‘ç°ï¼Œæˆ‘ä»¬åœ¨å¤„ç†å¯¹äºåƒ starred è¿™æ ·æ™®é€šçš„è§£æå…³ç³»æ—¶ï¼Œä»æ—§éœ€è¦ä¸€ä¸ªä¸€ä¸ªé‡æ–°åœ¨å®šä¹‰ä¸€éï¼Œå¦‚æœæˆ‘ä»¬çš„æ•°æ®ç»“æ„å†…å®¹éå¸¸çš„å¤šï¼Œé‚£å°±æ˜¯ä¸ªä½“åŠ›æ´»äº†ï¼Œè€Œä¸”ä¸å®šä¹‰å°±æ— æ³•è§£æã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (id)initWithModelClass:(Class)modelClass &#123;</div><div class="line">	...</div><div class="line">  	</div><div class="line">    NSSet *propertyKeys = [self.modelClass propertyKeys];</div><div class="line">      </div><div class="line">  	...</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSSet *)propertyKeys &#123;</div><div class="line">	NSSet *cachedKeys = objc_getAssociatedObject(self, MTLModelCachedPropertyKeysKey);</div><div class="line">	if (cachedKeys != nil) return cachedKeys;</div><div class="line"></div><div class="line">	NSMutableSet *keys = [NSMutableSet set];</div><div class="line"></div><div class="line">	[self enumeratePropertiesUsingBlock:^(objc_property_t property, BOOL *stop) &#123;</div><div class="line">		NSString *key = @(property_getName(property));</div><div class="line"></div><div class="line">		if ([self storageBehaviorForPropertyWithKey:key] != MTLPropertyStorageNone) &#123;</div><div class="line">			 [keys addObject:key];</div><div class="line">		&#125;</div><div class="line">	&#125;];</div><div class="line"></div><div class="line">	objc_setAssociatedObject(self, MTLModelCachedPropertyKeysKey, keys, OBJC_ASSOCIATION_COPY);</div><div class="line"></div><div class="line">	return keys;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>propertyKeys</code> æ˜¯éå† MTLModel å­ç±»çš„å±æ€§ï¼Œåˆ¤æ–­å…¶æ‹·è´è¡Œä¸ºï¼Œè¿‡æ»¤æ‰ä¸åšå­˜å‚¨çš„å±æ€§ï¼Œæ³¨æ„å®ƒåŒæ—¶ä¼šå¯¹ hash ã€ superclass ã€ description ã€ debugDescription è¿™å››ä¸ªå±æ€§è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨ NSObject å†…è¿™å››ä¸ªéƒ½æ˜¯ readonly çš„ï¼Œå¦‚æœä½ ä¸å»å°†å®ƒè®¾ä¸º readwrite çš„è¯ï¼Œå®ƒä»¬æ˜¯ä¸åšå­˜å‚¨çš„ã€‚</p>
<p>è¯´åˆ°å­˜å‚¨è¡Œä¸ºï¼ŒMTLModelç”¨äº†ä¸€ä¸ªæšä¸¾ <code>MTLPropertyStorage</code> æ¥æ ‡è®°ä¸€ä¸ªå±æ€§çš„æ‹·è´è¡Œä¸ºï¼Œåˆ†ä¸ºä¸‰ç±»ï¼Œ</p>
<p>ç¬¬ä¸€ç±» <code>MTLPropertyStorageNone</code> ï¼šå±æ€§ä¸åšä»»ä½•å­˜å‚¨ï¼Œåœ¨ MTLModelé‡Œåˆ¤æ–­ä¸å­˜å‚¨çš„æ¡ä»¶æ˜¯1.æ²¡æœ‰è¯¥å±æ€§ï¼Œè‡ªç„¶ä¸ç”¨å­˜å‚¨ 2.è¯¥å±æ€§æ²¡æœ‰ä½¿ç”¨ @dynamic æŒ‡ä»¤ï¼Œä½†æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹åº”çš„setterå’Œgetteræ–¹æ³• 3. MTLModel ç±»ä¸­å±æ€§æ˜¯åªè¯»ï¼Œä¸”æ²¡æœ‰æˆå‘˜å˜é‡ã€‚</p>
<p>ç¬¬äºŒç±» <code>MTLPropertyStorageTransitory</code> ï¼šå±æ€§åªåšæš‚æ—¶æ€§çš„å­˜å‚¨ï¼Œåœ¨å®˜æ–¹è§£é‡Šé‡Œçœ‹åˆ°ä¸€å¥è¯ <code>It may disappear at any time</code> ï¼Œæ„Ÿè§‰æŒ‡çš„æ˜¯å¼±å¼•ç”¨çš„å±æ€§ï¼Œä½†æ˜¯åœ¨ MTLModel é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°è¿”å›  MTLPropertyStorageTransitory çš„å¤„ç†ï¼Œä½†åœ¨ MTLTestModel ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œ MTLTestModel å¯¹ <code>storageBehaviorForPropertyWithKey:</code> è¿›è¡Œäº†é‡å†™ï¼Œå…¶ä¸­å®ƒå¯¹å±æ€§åè¿›è¡Œäº†åˆ¤æ–­ï¼Œåœ¨å¯¹åº”çš„å¤´æ–‡ä»¶é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°è¿™ä¸ªå±æ€§çš„è¯´æ˜ï¼š<code>Should not be stored in JSON, has MTLPropertyStorageTransitory.</code> ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">+ (MTLPropertyStorage)storageBehaviorForPropertyWithKey:(NSString *)propertyKey &#123;</div><div class="line">  if ([propertyKey isEqual:@&quot;weakModel&quot;]) &#123;</div><div class="line">  	return MTLPropertyStorageTransitory;</div><div class="line">  &#125; else &#123;</div><div class="line">  	return [super storageBehaviorForPropertyWithKey:propertyKey];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰ç±» <code>MTLPropertyStoragePermanen</code> ï¼Œå±æ€§åšæ°¸ä¹…å­˜å‚¨ï¼Œ MTLModel é‡Œåˆ¤æ–­åªè¦ä¸æ˜¯ MTLPropertyStorageNone å°±æ˜¯ MTLPropertyStoragePermanenï¼Œéœ€è¦åšæš‚æ—¶å­˜å‚¨çš„ï¼Œå°±éœ€è¦åœ¨å­ç±»é‡Œé‡å†™äº†ã€‚</p>
<h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (id)initWithModelClass:(Class)modelClass &#123;</div><div class="line">	...</div><div class="line">  	</div><div class="line">    _valueTransformersByPropertyKey = [self.class valueTransformersForModelClass:modelClass];</div><div class="line">	_JSONAdaptersByModelClass = [NSMapTable strongToStrongObjectsMapTable];</div><div class="line"></div><div class="line">	return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨éå†å®Œä¹‹åå¼€å§‹å¯¹å±æ€§çš„å€¼è¿›è¡Œè½¬æ¢æ“ä½œï¼Œå¯¹äºè½¬æ¢æ“ä½œä¹Ÿæä¾›äº†ä¸‰ç§æ–¹å¼ï¼Œ</p>
<p>ç¬¬ä¸€ç§æ˜¯è‡ªå®šä¹‰æ–¹å¼ï¼Œåœ¨å­ç±»é‡Œå®šä¹‰å®ç°æ–¹æ³•åä¸º <code>keyï¼ˆå±æ€§åï¼‰</code> + <code>JSONTransformer</code>  çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (NSValueTransformer *)URLJSONTransformer &#123;</div><div class="line">    return [NSValueTransformer valueTransformerForName:MTLURLValueTransformerName];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§æ˜¯é‡å†™ MTLJSONSerializing çš„ optional åè®®ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (NSValueTransformer *)JSONTransformerForKey:(NSString *)key;</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">+ (NSValueTransformer *)JSONTransformerForKey:(NSString *)key &#123;</div><div class="line">	return @&#123;</div><div class="line">		// Not provided transformer for self.URL</div><div class="line">		@&quot;otherURL&quot;: [NSValueTransformer valueTransformerForName:MTLURLValueTransformerName],</div><div class="line">	&#125;[key];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰ç§åˆ™æ˜¯æ ¹æ®å±æ€§çš„ç±»å‹åšç›¸åº”çš„è½¬æ¢ã€‚</p>
<p>åœ¨ä»¥ä¸Šä¸¤éƒ¨è½¬æ¢å®Œæˆä¹‹åå‰©ä¸‹çš„å°±æ˜¯èµ‹å€¼äº†ï¼Œå› ä¸ºå®ç°äº† JSONKeyPathsByPropertyKey æ–¹æ³•ï¼Œæ‰€ä»¥ä» JSONDictionary å–å€¼æ—¶å¦‚æœç¢°åˆ°ä»¥æ•°ç»„å½¢å¼å®šä¹‰çš„ key æ—¶ï¼Œä¼šä»¥<code>.</code>è¿›è¡Œæ‹†åˆ†ï¼Œä¾‹å¦‚ <code>@&quot;name&quot;: @&quot;POI.name&quot;</code> ï¼Œåˆ™å¯¹åº”çš„å–å€¼å¤„ç†æ˜¯ <code>JSONDictionary[@&quot;POI&quot;][@&quot;nameâ€]</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (id)modelFromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error &#123;</div><div class="line">	...</div><div class="line">      </div><div class="line">      for (NSString *propertyKey in [self.modelClass propertyKeys]) &#123;</div><div class="line">		id JSONKeyPaths = self.JSONKeyPathsByPropertyKey[propertyKey];</div><div class="line"></div><div class="line">		if (JSONKeyPaths == nil) continue;</div><div class="line"></div><div class="line">		id value;</div><div class="line"></div><div class="line">		if ([JSONKeyPaths isKindOfClass:NSArray.class]) &#123;</div><div class="line">			NSMutableDictionary *dictionary = [NSMutableDictionary dictionary];</div><div class="line"></div><div class="line">			for (NSString *keyPath in JSONKeyPaths) &#123;</div><div class="line">				BOOL success = NO;</div><div class="line">				id value = [JSONDictionary mtl_valueForJSONKeyPath:keyPath success:&amp;success error:error];</div><div class="line"></div><div class="line">				if (!success) return nil;</div><div class="line"></div><div class="line">				if (value != nil) dictionary[keyPath] = value;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			value = dictionary;</div><div class="line">		&#125; else &#123;</div><div class="line">			BOOL success = NO;</div><div class="line">			value = [JSONDictionary mtl_valueForJSONKeyPath:JSONKeyPaths success:&amp;success error:error];</div><div class="line"></div><div class="line">			if (!success) return nil;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		...</div><div class="line">	&#125;</div><div class="line">  </div><div class="line">  	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨å­ç±»é‡Œå®šä¹‰çš„ keyTransform æ–¹æ³•ä¹ˆï¼Œåœ¨å–å€¼ä¹‹åè¿™äº›å€¼éƒ½ä¼šåšç›¸åº”çš„è½¬æ¢ï¼Œæ³¨æ„ä¸€ç‚¹å°±æ˜¯NSNullå¯¹è±¡ä¼šå…ˆè½¬æ¢æˆnilï¼Œç„¶åå°†nilè½¬æ¢æˆNSNullå¯¹è±¡æ’å…¥åˆ°æ–°çš„ dictionaryValue ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (id)modelFromJSONDictionary:(NSDictionary *)JSONDictionary error:(NSError **)error &#123;</div><div class="line">	...</div><div class="line">      </div><div class="line">      for (NSString *propertyKey in [self.modelClass propertyKeys]) &#123;</div><div class="line">		...</div><div class="line">          </div><div class="line">         @try &#123;</div><div class="line">            NSValueTransformer *transformer = self.valueTransformersByPropertyKey[propertyKey];</div><div class="line">            if (transformer != nil) &#123;</div><div class="line">                // Map NSNull -&gt; nil for the transformer, and then back for the</div><div class="line">                // dictionary we&apos;re going to insert into.</div><div class="line">                if ([value isEqual:NSNull.null]) value = nil;</div><div class="line"></div><div class="line">                if ([transformer respondsToSelector:@selector(transformedValue:success:error:)]) &#123;</div><div class="line">                    id&lt;MTLTransformerErrorHandling&gt; errorHandlingTransformer = (id)transformer;</div><div class="line"></div><div class="line">                    BOOL success = YES;</div><div class="line">                    value = [errorHandlingTransformer transformedValue:value success:&amp;success error:error];</div><div class="line"></div><div class="line">                    if (!success) return nil;</div><div class="line">                &#125; else &#123;</div><div class="line">                    value = [transformer transformedValue:value];</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (value == nil) value = NSNull.null;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dictionaryValue[propertyKey] = value;</div><div class="line">        &#125; @catch (NSException *ex) &#123;</div><div class="line">            NSLog(@&quot;*** Caught exception %@ parsing JSON key path \&quot;%@\&quot; from: %@&quot;, ex, JSONKeyPaths, JSONDictionary);</div><div class="line"></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line">  </div><div class="line">  	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>åœ¨ç”Ÿæˆ dictionaryValue ä¹‹åï¼Œå¼€å§‹è°ƒç”¨ <code>- (instancetype)initWithDictionary:(NSDictionary *)dictionary error:(NSError **)error</code> æ¥å¯¹å­ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶è°ƒç”¨ <code>MTLValidateAndSetValue</code> æ¥èµ‹å€¼ï¼Œè‡³æ­¤ä» JSONDictionary åˆ° model çš„è§£æç®—æ˜¯å®Œæˆäº†~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithDictionary:(NSDictionary *)dictionary error:(NSError **)error &#123;</div><div class="line">	self = [self init];</div><div class="line">	if (self == nil) return nil;</div><div class="line"></div><div class="line">	for (NSString *key in dictionary) &#123;</div><div class="line">		// Mark this as being autoreleased, because validateValue may return</div><div class="line">		// a new object to be stored in this variable (and we don&apos;t want ARC to</div><div class="line">		// double-free or leak the old or new values).</div><div class="line">		__autoreleasing id value = [dictionary objectForKey:key];</div><div class="line"></div><div class="line">		if ([value isEqual:NSNull.null]) value = nil;</div><div class="line"></div><div class="line">		BOOL success = MTLValidateAndSetValue(self, key, value, YES, error);</div><div class="line">		if (!success) return nil;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹ JSON è§£æåº“ç›®å‰æµè¡Œçš„ä¹Ÿæ˜¯éå¸¸çš„å¤šï¼Œ&lt;a href=&quot;https://github.com/jsonmodel/jsonmodel&quot;&gt;jsonmodel&lt;/a&gt; ã€&lt;a href=&quot;https://github.com/Mantle/Mantle&quot;&gt;Mantle&lt;/a&gt; ã€&lt;a href=&quot;https://github.com/ibireme/YYModel&quot;&gt;YYModel&lt;/a&gt; ç­‰éƒ½æ˜¯å¤§å®¶å¸¸ç”¨çš„ï¼Œä½¿ç”¨è¿™äº›åº“çš„å¥½å¤„å°±æ˜¯ä½ æ— éœ€å…³å¿ƒæ•°æ®è§£æè½¬æ¢å’Œå¤æ‚çš„ç±»å‹åˆ¤æ–­å¤„ç†ï¼Œä½ åªéœ€è¦ç¡®å®šå¥½å®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„èƒ½å¤Ÿä¸åç«¯æ•°æ®ç»“æ„ç›¸å¯¹åº”å³å¯ï¼Œè€Œè¿™äº›åº“é‡Œé¢å¯¹äºè§£æçš„å¤„ç†ä¹Ÿéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œæ— éæ˜¯åœ¨ä½¿ç”¨ã€æ€§èƒ½å’Œå¼‚å¸¸å¤„ç†ä¸Šæœ‰äº›å·®åˆ«ï¼Œè¿™é‡Œæ¨èä¸€ä¸‹éƒ­æ›œæºå¤§ç¥ï¼ˆ YYModel çš„ä½œè€…ï¼‰çš„æ–‡ç« ï¼Œå†…å®¹æ˜¯å¯¹&lt;a href=&quot;http://blog.ibireme.com/2015/10/23/ios_model_framework_benchmark/&quot;&gt;å„å¤§è§£æåº“è¿›è¡Œäº†æ¯”è¾ƒ&lt;/a&gt;ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œäº†è§£å…¶è§£æè¿‡ç¨‹æ˜¯æœ€ä¸ºåŸºç¡€çš„ï¼Œè¿™æ¬¡çœ‹å®Œ Mantle çš„è§£æå¤„ç†ï¼Œæˆ‘ä¹Ÿåšä¸ªç®€å•çš„æ€»ç»“ï¼Œå¤§å®¶å¯ä»¥äº’ç›¸å­¦ä¹ äº¤æµã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Mantle" scheme="http://yuzeyang.github.io/tags/Mantle/"/>
    
  </entry>
  
  <entry>
    <title>æœ‰èµ App åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒå®è·µ</title>
    <link href="http://yuzeyang.github.io/2017/04/06/Youzan-App-Config-Center/"/>
    <id>http://yuzeyang.github.io/2017/04/06/Youzan-App-Config-Center/</id>
    <published>2017-04-06T12:16:19.000Z</published>
    <updated>2017-04-11T12:06:55.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å®¢æˆ·ç«¯å¤§é‡çš„ç¡¬ç¼–ç å¯¼è‡´å…¶çµæ´»æ€§å¤§å¤§é™ä½ï¼Œä¸€äº›ç»†å°çš„æ”¹åŠ¨åªèƒ½é€šè¿‡å‘å¸ƒç‰ˆæœ¬è§£å†³ï¼Œç”¨æˆ·å‡çº§æ›´æ–°è¿­ä»£é€Ÿåº¦æ…¢ï¼Œæ—¶æ•ˆæ€§å·®ç­‰åŸå› ï¼Œå‚¬ç”Ÿå‡ºäº†æœ‰èµ App çš„åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒï¼Œå®ƒå¯ä»¥å°†é…ç½®ï¼ŒåŠŸèƒ½ï¼Œç•Œé¢ï¼Œæ•°æ®ç­‰å„ç§é…ç½®æ•°æ®ç»Ÿä¸€è¿›è¡Œç®¡ç†ä¸‹å‘ï¼Œå®æ—¶ç”Ÿæ•ˆï¼Œæå¤§åœ°æå‡äº†å®¢æˆ·ç«¯çš„çµæ´»æ€§ã€‚</p>
<p>åŒæ—¶é…ç½®ä¸­å¿ƒä¸ä»…ä»…æ˜¯ç®€å•çš„å¯¹é…ç½®æ•°æ®è¿›è¡Œä¿®æ”¹ã€è¯»å–è€Œå·²ï¼Œæ›´éœ€è¦åœ¨å®¹é”™æ€§ã€æµé‡ä¼˜åŒ–ã€å¸¦å®½èŠ‚çœç­‰å„æ–¹é¢çš„ä¼˜åŒ–ä¸Šä¸‹åŠŸå¤«ã€‚æœ¬æ–‡ä¸»è¦æä¾›äº†æœ‰èµ App çš„åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ€»ç»“äº†ç‰ˆæœ¬è¿­ä»£ä¸­æ‰€åšçš„ä¼˜åŒ–ã€‚</p>
<a id="more"></a>
<h2 id="u914D_u7F6E_u4E2D_u5FC3_u8BBE_u8BA1"><a href="#u914D_u7F6E_u4E2D_u5FC3_u8BBE_u8BA1" class="headerlink" title="é…ç½®ä¸­å¿ƒè®¾è®¡"></a>é…ç½®ä¸­å¿ƒè®¾è®¡</h2><p>èµ·åˆæœ‰èµå„ App å†…éƒ½æ•£è½ç€ä¸€äº›å†™æ­»çš„é“¾æ¥ï¼Œä½†éšç€ WWDC 16 ä¸­ï¼ŒApple è¡¨ç¤ºå°†ç»§ç»­åœ¨ iOS 10 å’Œ macOS 10.12 é‡Œæ”¶ç´§å¯¹æ™®é€š HTTP çš„è®¿é—®é™åˆ¶ï¼Œå¹¶ä¸”æ— æ³•ä½¿ç”¨ <code>NSAllowsArbitraryLoads</code> æ¥ç»•è¿‡ ATS é™åˆ¶ã€‚æˆ‘ä»¬åªèƒ½å¾ˆè´¹æ—¶è´¹åŠ›çš„æŠŠå„ App å†…æ‰€æœ‰è®¿é—® HTTP çš„é“¾æ¥éƒ½ä¿®æ”¹æˆ HTTPSï¼Œè¿™ä¸€ä¸ªå°å°çš„æ”¹åŠ¨å°±å¦‚æ­¤éº»çƒ¦ï¼Œé‚£åç»­å¤§çš„æ”¹åŠ¨æ›´éš¾ä»¥æƒ³è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å§‹æ€è€ƒèƒ½å¦å°†è¿™äº›é‡å¤ä¸”åŠ¨æ€çš„å·¥ä½œæŠ½è±¡æˆä¸€ä¸ªé…ç½®ä¸­å¿ƒï¼Œç”¨å®ƒæ¥æ”¯æ’‘å„ä¸ªä¸šåŠ¡ã€‚</p>
<h4 id="u7B2C_u4E00_u7248"><a href="#u7B2C_u4E00_u7248" class="headerlink" title="ç¬¬ä¸€ç‰ˆ"></a>ç¬¬ä¸€ç‰ˆ</h4><p>ç¬¬ä¸€ç‰ˆè®¾è®¡çš„ç›¸å¯¹ç®€å•ï¼Œæˆ‘ä»¬åªæ˜¯ä¸“é—¨è®¾è®¡äº†ä¸€ä¸ª APIï¼Œé€šè¿‡ API è¯·æ±‚é…ç½®æ•°æ®ï¼Œå¹¶ä¸”æ¯ä¸ªä¸šåŠ¡å•ç‹¬ç»´æŠ¤ä¸€ä»½é…ç½®æ–‡ä»¶ã€‚</p>
<p>å…·ä½“æµç¨‹ï¼šå®¢æˆ·ç«¯è¿›å…¥åˆ°å‰å°ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºè¢«æ¿€æ´»çš„æ—¶å€™ï¼Œé€šè¿‡é…ç½®ä¸­å¿ƒçš„æ¥å£å‘æœåŠ¡ç«¯è¯·æ±‚æœ€æ–°çš„é…ç½®æ•°æ®ï¼Œå¦‚æœé…ç½®æ–‡ä»¶æœ‰æ›´æ–°ï¼Œåˆ™ä¸‹å‘æœ€æ–°çš„é…ç½®ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯æœ¬åœ°å­˜å‚¨è¿™ä»½æœ€æ–°çš„é…ç½®ï¼Œç”¨äºåº”ç”¨è¿è¡Œæ—¶ä½¿ç”¨ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/AppConfigCenter1.png" alt=""></p>
<p>ä½†éšç€æ¨¡å—åŒ–çš„æ¨è¿›å’Œåº”ç”¨æ•°é‡çš„å¢åŠ ï¼Œé…ç½®æ–‡ä»¶çš„ä½“ç§¯å’Œæ•°é‡ä¼šé€æ¸å¢å¤§ï¼Œæ¯ä¸€æ¬¡ä¿®æ”¹éƒ½ä¼šå…¨é‡ä¸‹å‘åˆ°å®¢æˆ·ç«¯ï¼Œè¿™éƒ¨åˆ†çš„æµé‡ç´¯ç§¯èµ·æ¥æ˜¯ä¸€ä¸ªéå¸¸åºå¤§çš„æ•°å­—ã€‚å¹¶ä¸”ä½¿ç”¨é…ç½®æ–‡ä»¶å»ç®¡ç†é…ç½®ï¼Œåªèƒ½ç»´æŠ¤åˆ°æœ€æ–°çš„é…ç½®ï¼Œæ— æ³•åšåˆ°ä¸‹å‘æŒ‡å®šç‰ˆæœ¬çš„é…ç½®ã€‚</p>
<p>æ‰€ä»¥é’ˆå¯¹è¿™äº›å¼Šç«¯é—®é¢˜ï¼Œæˆ‘ä»¬è¡ç”Ÿå‡ºäº†ç¬¬äºŒç‰ˆé…ç½®ä¸­å¿ƒã€‚</p>
<h4 id="u7B2C_u4E8C_u7248"><a href="#u7B2C_u4E8C_u7248" class="headerlink" title="ç¬¬äºŒç‰ˆ"></a>ç¬¬äºŒç‰ˆ</h4><p>ä¸ºäº†è§£å†³ç¬¬ä¸€ç‰ˆäº§ç”Ÿçš„æµé‡æµªè´¹å’Œé…ç½®ç®¡ç†å¼±çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼˜åŒ–äº†é…ç½®ä¸‹å‘å’Œç®¡ç†æµç¨‹ï¼Œæˆ‘ä»¬é‡‡å–çš„ç­–ç•¥æ˜¯ <code>å¢é‡æ›´æ–°</code> å’Œ <code>æ•°æ®åº“å­˜å‚¨é…ç½®</code> ã€‚</p>
<p>å…·ä½“æµç¨‹æ”¹åŠ¨ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/AppConfigCenter2.png" alt=""></p>
<h4 id="u589E_u91CF_u66F4_u65B0"><a href="#u589E_u91CF_u66F4_u65B0" class="headerlink" title="å¢é‡æ›´æ–°"></a>å¢é‡æ›´æ–°</h4><p>å¢é‡æ›´æ–°çš„ä¼˜åŠ¿ä¸»è¦ä½“ç°åœ¨ä¸šåŠ¡å¢é•¿çš„è¿‡ç¨‹ä¸­ã€‚æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶å¯èƒ½ä¼šä»å‡ å KB å¢é•¿åˆ°å‡ ç™¾ KB ç”šè‡³æ›´å¤§ï¼Œå¦‚æœè¿˜ç»§ç»­ä½¿ç”¨å…¨é‡æ›´æ–°ï¼Œè¿™éƒ¨åˆ†æµé‡å¯¹ç”¨æˆ·æ¥è¯´æ˜¯éå¸¸æµªè´¹çš„ã€‚è€Œä½¿ç”¨å¢é‡æ›´æ–°ä¹‹åï¼ŒæœåŠ¡ç«¯åªéœ€è¦ä¸‹å‘ä¸åŒé…ç½®ä¹‹é—´çš„å·®å¼‚è¡¥ä¸åŒ…ï¼Œè¡¥ä¸åŒ…çš„å¤§å°ç›¸æ¯”äºåŸå§‹é…ç½®çš„å¤§å°æ˜¯éå¸¸å°çš„ï¼Œå¯ä»¥èŠ‚çœä¸‹90%å·¦å³çš„æµé‡ï¼Œè¿™æ˜¯éå¸¸å¯è§‚çš„ã€‚</p>
<p>å¢é‡æ›´æ–°æˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„æ˜¯ Google å‡ºçš„ <a href="https://code.google.com/p/google-diff-match-patch/" target="_blank" rel="external">google-diff-match-patch</a> ï¼Œæ”¯æŒ Java,  JavaScript, Dart, C++, C#,  Objective-C, Lua å’Œ Pythonï¼Œä½†æ˜¯å®˜ç½‘å·²ç»ä¸‹æ‰äº†è¯¥ SDKï¼ˆä¸æ˜ç™½ä¸ºä»€ä¹ˆï¼‰ï¼Œéœ€è¦åˆ° GitHub ä¸Šæœç´¢ç±»ä¼¼äº <code>diff patch language:java</code> è¿™æ ·çš„å…³é”®è¯ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”å¹³å°ä¸‹çš„ SDK äº†ï¼Œæœ‰äººå·²ç» fork å‡ºæ¥äº†ï¼Œå› ä¸ºåªæ˜¯å­—ç¬¦ä¸²çš„æ¯”è¾ƒå¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚</p>
<p>è¯¥å¢é‡æ›´æ–°çš„åŸç†æ˜¯å…ˆé€šè¿‡æ¯”è¾ƒé¦–éƒ¨å’Œå°¾éƒ¨çš„ç›¸åŒéƒ¨åˆ†ï¼Œç›®çš„æ˜¯æå‡ä¸€å®šçš„æ•ˆç‡ï¼Œå†æ¯”è¾ƒä¸­é—´å·®å¼‚çš„éƒ¨åˆ†ï¼Œå·®å¼‚çš„éƒ¨åˆ†é€šè¿‡ä¸€äº›å­—ç¬¦å»è¡¨ç¤ºè¯¥æ”¹åŠ¨æ˜¯  <code>DEL</code>  è¿˜æ˜¯  <code>ADD</code>  è¿˜æ˜¯  <code>EQUAL</code>  ï¼Œè¿™æ ·æœ€ç»ˆå½¢æˆçš„è¡¥ä¸åŒ…æ¯”æ”¹åŠ¨éƒ¨åˆ†è¦å¤§ä¸€ç‚¹ï¼Œä½†æ˜¯ç›¸æ¯”äºå…¨é‡æ›´æ–°å·²ç»å‡å°‘å¾ˆå¤šäº†ã€‚</p>
<p>å¹¶ä¸”ç”Ÿæˆè¡¥ä¸åŒ…åŸºæœ¬æ˜¯æ¯«ç§’çº§çš„ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒæ¥å£è¯·æ±‚çš„è€—æ—¶é—®é¢˜ã€‚</p>
<p>æœåŠ¡ç«¯æŠŠå‰åé…ç½®çš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒå³å¯å¾—åˆ°ä¸€ç»„è¡¥ä¸æ•°æ®ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$dmp = <span class="keyword">new</span> DiffMatchPatch();</div><div class="line">$patches = $dmp-&gt;patch_make($oldConfigString, $latestConfigString);</div><div class="line">$patchStrings = [];</div><div class="line"><span class="keyword">foreach</span> ($patches <span class="keyword">as</span> $patchObject) &#123;</div><div class="line">    array_push($patchStrings, $patchObject-&gt;__toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„è¡¥ä¸ä»¥å®˜æ–¹ä¸ºä¾‹ï¼Œè¡¥ä¸å†…åŒ…å«ä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹é—´å˜åŠ¨éƒ¨åˆ†çš„ location å’Œ lengthï¼Œå¹¶æœ€ç»ˆä¸‹å‘ç»™å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">@@ -16,21 +16,29 @@</div><div class="line"> see </div><div class="line">-yonder</div><div class="line">+the</div><div class="line">  cloud </div><div class="line">+over there </div><div class="line"> that</div><div class="line">@@ -47,18 +47,19 @@</div><div class="line">  almost </div><div class="line">-in</div><div class="line">+the</div><div class="line">  shape o</div><div class="line">@@ -86,24 +86,18 @@</div><div class="line">  By </div><div class="line">-the mass, and &apos;t</div><div class="line">+golly, it </div><div class="line"> is l</div><div class="line">@@ -129,21 +129,23 @@</div><div class="line"> et: </div><div class="line">-Me</div><div class="line">+I </div><div class="line"> think</div><div class="line">-s</div><div class="line">  it </div><div class="line">-i</div><div class="line">+look</div><div class="line"> s li</div><div class="line">@@ -177,12 +177,12 @@</div><div class="line">  is </div><div class="line">-back</div><div class="line">+shap</div><div class="line"> ed l</div><div class="line">@@ -234,11 +234,19 @@</div><div class="line"> us: </div><div class="line">-Ver</div><div class="line">+It&apos;s totall</div><div class="line"> y li</div></pre></td></tr></table></figure>
<p>ä»¥ iOS ä¸ºä¾‹ï¼Œå®¢æˆ·ç«¯è·å–è¡¥ä¸åŒ…åï¼Œæ ¹æ®è¡¥ä¸åŒ…å†…å˜åŠ¨ç¬¦å·ä»¥åŠå˜åŠ¨å†…å®¹å¯¹æœ¬åœ°é…ç½®æ–‡ä»¶å†…å®¹è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥æˆ–åˆ é™¤æ“ä½œï¼Œå½¢æˆæœ€ç»ˆçš„é…ç½®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">DiffMatchPatch *dmp = [[DiffMatchPatch alloc] init];</div><div class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *patchStrings = configDic[<span class="string">@"patches"</span>];</div><div class="line"><span class="built_in">NSMutableArray</span>&lt;Patch *&gt; *patches = [<span class="built_in">NSMutableArray</span> array];</div><div class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *patchString <span class="keyword">in</span> patchStrings) &#123;</div><div class="line">    <span class="built_in">NSArray</span>&lt;Patch *&gt; *patch = [dmp patch_fromText:patchString error:&amp;error];</div><div class="line">    <span class="keyword">if</span> (!error) &#123;</div><div class="line">        [patches addObjectsFromArray:patch];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">NSString</span> *newCacheConfig = [[dmp patch_apply:patches toString:cacheConfig] objectAtIndex:<span class="number">0</span>];</div></pre></td></tr></table></figure>
<p>ä¸ºäº†ç¡®ä¿å®¢æˆ·ç«¯æœ€ç»ˆç”Ÿæˆçš„é…ç½®ä¸æœåŠ¡ç«¯ä¿æŒä¸€è‡´ï¼Œå®¢æˆ·ç«¯åœ¨æ‰“å¥½è¡¥ä¸ä¹‹åï¼Œç”¨è¯¥é…ç½®ç”Ÿæˆ MD5 å€¼ï¼Œä¸æˆ‘ä»¬åœ¨æœåŠ¡ç«¯ä¸‹å‘è¡¥ä¸åŒ…æ—¶æºå¸¦çš„æœ€æ–°é…ç½®çš„ MD5 å€¼è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ä¸€è‡´çš„æƒ…å†µä¸‹æ‰å»ç¼“å­˜é…ç½®ï¼Œé¿å…å› ä¸ºè¡¥ä¸é€ æˆ App æ— æ³•ä½¿ç”¨çš„é—®é¢˜ã€‚</p>
<h4 id="u6570_u636E_u5E93_u7BA1_u7406_u914D_u7F6E"><a href="#u6570_u636E_u5E93_u7BA1_u7406_u914D_u7F6E" class="headerlink" title="æ•°æ®åº“ç®¡ç†é…ç½®"></a>æ•°æ®åº“ç®¡ç†é…ç½®</h4><p>å®ç°å¢é‡æ›´æ–°çš„å‰ææ˜¯æˆ‘ä»¬éœ€è¦æœ‰ä¸åŒç‰ˆæœ¬çš„é…ç½®è®°å½•ï¼Œè€Œç”¨æ–‡ä»¶å»ç®¡ç†æ˜¯éå¸¸ä¸å¯æ§çš„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ•°æ®åº“æ¥ç®¡ç†ï¼ŒåŒæ—¶åˆ©äºåæœŸçš„æ¨ªå‘æ‰©å±•ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒå¹³å°ï¼Œä¸åŒæ¸ é“ï¼Œä¸åŒç‰ˆæœ¬ç­‰è§„åˆ™ä¸‹å‘ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/dbConfig.png" alt=""></p>
<p>ç›®å‰æˆ‘ä»¬æ˜¯æ ¹æ®ç‰ˆæœ¬å’Œåº”ç”¨æ¥å…³è”åˆ°é…ç½®ï¼Œæ‰€ä»¥è¡¨ç»“æ„è®¾è®¡çš„å¾ˆç®€å•ï¼ŒæŠŠåº”ç”¨ã€ç‰ˆæœ¬å’Œé…ç½®æ”¾åœ¨ä¸€å¼ è¡¨é‡Œé¢ï¼Œåé¢é’ˆå¯¹å¤šæ¸ é“å’Œå¤šå¹³å°ç­‰è§„åˆ™ä¹‹åï¼Œè¡¨ç»“æ„ä¸Šä¼šåšä¸€å®šè°ƒæ•´ã€‚</p>
<p>ç”±äºéœ€è¦ App èƒ½åŠæ—¶è·å–åˆ°æœ€æ–°é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨ App æ¿€æ´»çš„æ—¶æœºå»è·å–é…ç½®ï¼Œé€šè¿‡æ•°æ®ç»Ÿè®¡ä¸­å¿ƒæˆ‘ä»¬å¯ä»¥çœ‹åˆ° App å½“æ—¥å¯åŠ¨æ¬¡æ•°çš„æ—¶æ®µåˆ†æï¼Œå†ç»“åˆé…ç½®æ–‡ä»¶å¤§å°ï¼Œæˆ‘ä»¬å¯ä»¥é¢„ä¼°æ‰€å å¸¦å®½çš„å¤§å°ï¼Œè¿ç»´æ˜¯éå¸¸æ‹…å¿ƒä½ æŠŠä»–çš„å¸¦å®½è·‘æ»¡ï¼Œå½±å“åˆ°å…¶ä»–ä¸šåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¸¤ä¸ªä¼˜åŒ–ï¼Œä¸€ä¸ªæ˜¯å‹ç¼©é…ç½®ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°ç¼“å­˜ã€‚</p>
<h5 id="u538B_u7F29_u914D_u7F6E"><a href="#u538B_u7F29_u914D_u7F6E" class="headerlink" title="å‹ç¼©é…ç½®"></a>å‹ç¼©é…ç½®</h5><p>ä¸ºäº†ä¸å ç”¨è¿‡å¤šçš„å¸¦å®½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å†™å…¥ä¹‹å‰æŠŠé…ç½®å‹ç¼©ï¼Œè¯»å–ä¹‹åè§£å‹é…ç½®ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ <code>gzip</code> æ¥å‹ç¼©é…ç½®ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$data[<span class="string">'config'</span>] = base64_encode(gzcompress(json_encode($config)));</div></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>gzip</code> å¯ä»¥è®¾ç½®å‹ç¼©ç­‰çº§ï¼ŒèŒƒå›´æ˜¯0 - 9ï¼Œé»˜è®¤æ˜¯6ï¼Œä½†æ˜¯æå‡å‹ç¼©ç­‰çº§ä¼šå ç”¨è¾ƒå¤š CPU æ—¶é—´å’Œå†…å­˜ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤ç­‰çº§å‹ç¼©ä¹‹åï¼Œé…ç½®æ–‡ä»¶ä½“ç§¯å‡å°‘äº†75%ï¼Œçœ‹æ¥æ˜¯é…ç½®å†…ç›¸åŒçš„éƒ¨åˆ†æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥å‹ç¼©æ•ˆæœè¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚</p>
<p>è¿™é‡Œæœ‰äººä¼šé—®ï¼Œä¸ºä»€ä¹ˆ <code>gzip</code> ä¹‹åè¿˜è¦ <code>base64</code> ç¼–ç ä¸€ä¸‹ï¼Œå› ä¸ºäºŒè¿›åˆ¶æ•°æ®ä¸èƒ½ç›´æ¥å†™åˆ°textå­—æ®µé‡Œé¢ï¼Œå†™è¿›å»ä¹‹åè¯»å‡ºæ¥ä¹Ÿæ˜¯è§£å‹ä¸äº†çš„ã€‚è¿›è¡Œ <code>base64</code>  ç¼–ç ä¹‹åï¼Œæˆ‘ä»¬çš„å‹ç¼©é…ç½®å†…å®¹ä¼šæ¯”åŸæ¥å¤š1/3çš„é•¿åº¦ã€‚</p>
<h5 id="u672C_u5730_u7F13_u5B58"><a href="#u672C_u5730_u7F13_u5B58" class="headerlink" title="æœ¬åœ°ç¼“å­˜"></a>æœ¬åœ°ç¼“å­˜</h5><p>å¯¹äºç›¸åŒçš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨é¢‘ç¹åœ°å»è¯·æ±‚æ•°æ®åº“ï¼Œè€Œå°†å…¶ç¼“å­˜åˆ°æœ¬åœ°ï¼Œè¿™æ ·åç»­çš„è¯·æ±‚å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–é…ç½®ï¼Œå½“ç„¶è¯·è®°å¾—è®¾ç½®ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬ç›®å‰ç”¨çš„æ˜¯ <code>Redis</code> ç¼“å­˜ï¼Œå®ƒå¯¹äºå¤æ‚çš„æ•°æ®ç»“æ„å’Œæ“ä½œæ”¯æŒçš„ç›¸å½“ä¸é”™ï¼Œè€Œä¸”æ“ä½œç®€å•ï¼Œå¯¹äºå‰æœŸåªæ˜¯key-valueå­˜å‚¨çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>Redis</code> ã€‚</p>
<h4 id="u53EF_u64CD_u4F5C_u754C_u9762"><a href="#u53EF_u64CD_u4F5C_u754C_u9762" class="headerlink" title="å¯æ“ä½œç•Œé¢"></a>å¯æ“ä½œç•Œé¢</h4><p>ä¸ºäº†æ–¹ä¾¿ä¸šåŠ¡æ–¹ä¿®æ”¹é…ç½®ï¼Œæˆ‘ä»¬åœ¨å†…éƒ¨å¹³å°ä¸Šæä¾›äº†ä¸€ä¸ªç®€å•çš„å¯æ“ä½œç•Œé¢ï¼Œé€šè¿‡é¡¶éƒ¨çš„Tabæ åˆ‡æ¢æŸ¥çœ‹ä¸åŒåº”ç”¨ä¸‹çš„é…ç½®è®°å½•ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/cpAppConfigCenter.png" alt=""></p>
<p>ç‚¹å‡» <code>æŸ¥çœ‹è¯¦æƒ…</code> å¯ä»¥çœ‹åˆ°å½“å‰ç‰ˆæœ¬çš„é…ç½®å†…å®¹ï¼Œç›®å‰å±•ç¤ºçš„æ•ˆæœå¹¶ä¸å‹å¥½ï¼Œåé¢ä¼šè¿›è¡Œä¼˜åŒ–ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/cpAppConfigCenterDetail.png" alt=""></p>
<p>åœ¨éœ€è¦ä¿®æ”¹é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>æ–°å¢é…ç½®</code> ç»™æŒ‡å®šåº”ç”¨ä¿®æ”¹é…ç½®ï¼Œæ–°å¢æ—¶ä¼šè‡ªåŠ¨åœ¨ç‰ˆæœ¬ä¸Š +1ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/cpAppConfigCenterAdd.png" alt=""></p>
<h2 id="u540E_u7EED_u4F18_u5316"><a href="#u540E_u7EED_u4F18_u5316" class="headerlink" title="åç»­ä¼˜åŒ–"></a>åç»­ä¼˜åŒ–</h2><p>ç›®å‰æœ‰èµ App å·²ç»å®ç°äº†åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒæ•´ä¸€å¥—æµç¨‹ï¼Œä½†æ˜¯åœ¨ä¸€äº›ç»†èŠ‚æ–¹é¢è¿˜éœ€è¦ä¸æ–­çš„æ”¹è¿›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ›´åŠ ä¸°å¯Œçš„é…ç½®ä¸‹å‘è§„åˆ™</li>
<li>å¯æ“ä½œç•Œé¢é…ç½®çš„æœ‰æ•ˆæ€§çš„æ ¡éªŒ</li>
<li>å¯æ“ä½œç•Œé¢çš„è§†è§‰ä¼˜åŒ–</li>
<li>ç­‰ç­‰</li>
</ul>
<p>ä¹Ÿæ¬¢è¿å¤§å®¶æå‡ºè‡ªå·±çš„æ„è§å’Œå»ºè®®ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢è®¨å­¦ä¹ ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;u80CC_u666F&quot;&gt;&lt;a href=&quot;#u80CC_u666F&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å®¢æˆ·ç«¯å¤§é‡çš„ç¡¬ç¼–ç å¯¼è‡´å…¶çµæ´»æ€§å¤§å¤§é™ä½ï¼Œä¸€äº›ç»†å°çš„æ”¹åŠ¨åªèƒ½é€šè¿‡å‘å¸ƒç‰ˆæœ¬è§£å†³ï¼Œç”¨æˆ·å‡çº§æ›´æ–°è¿­ä»£é€Ÿåº¦æ…¢ï¼Œæ—¶æ•ˆæ€§å·®ç­‰åŸå› ï¼Œå‚¬ç”Ÿå‡ºäº†æœ‰èµ App çš„åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒï¼Œå®ƒå¯ä»¥å°†é…ç½®ï¼ŒåŠŸèƒ½ï¼Œç•Œé¢ï¼Œæ•°æ®ç­‰å„ç§é…ç½®æ•°æ®ç»Ÿä¸€è¿›è¡Œç®¡ç†ä¸‹å‘ï¼Œå®æ—¶ç”Ÿæ•ˆï¼Œæå¤§åœ°æå‡äº†å®¢æˆ·ç«¯çš„çµæ´»æ€§ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ—¶é…ç½®ä¸­å¿ƒä¸ä»…ä»…æ˜¯ç®€å•çš„å¯¹é…ç½®æ•°æ®è¿›è¡Œä¿®æ”¹ã€è¯»å–è€Œå·²ï¼Œæ›´éœ€è¦åœ¨å®¹é”™æ€§ã€æµé‡ä¼˜åŒ–ã€å¸¦å®½èŠ‚çœç­‰å„æ–¹é¢çš„ä¼˜åŒ–ä¸Šä¸‹åŠŸå¤«ã€‚æœ¬æ–‡ä¸»è¦æä¾›äº†æœ‰èµ App çš„åŠ¨æ€åŒ–é…ç½®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ€»ç»“äº†ç‰ˆæœ¬è¿­ä»£ä¸­æ‰€åšçš„ä¼˜åŒ–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="App é…ç½®ä¸­å¿ƒ" scheme="http://yuzeyang.github.io/tags/App-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    
  </entry>
  
  <entry>
    <title>æŸ¥çœ‹MySQLè¿æ¥çš„rootå¯†ç </title>
    <link href="http://yuzeyang.github.io/2017/01/04/Check-MySQL-Password/"/>
    <id>http://yuzeyang.github.io/2017/01/04/Check-MySQL-Password/</id>
    <published>2017-01-03T16:03:02.000Z</published>
    <updated>2017-01-03T16:26:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ™šä¸Šåœ¨ç”¨<code>Navicat</code>å»è¿æœ¬åœ°çš„MySQLçš„æ—¶å€™å‘ç°æˆ‘å·²ç»å¿˜äº†å¯†ç äº†ï¼Œè¯•äº†ç½‘ä¸Šå¾ˆå¤šæ–¹å¼éƒ½ä¸è¡Œâ€¦åæ¥å‘ç°å…¶å®å¯ä»¥è‡ªå·±ç›´æ¥å»çœ‹å½“åˆè®¾ç½®çš„å¯†ç ..</p>
<p>æ¥çœ‹æ­£æ–‡ï¼š</p>
<a id="more"></a>
<h5 id="1-_u9996_u5148_u6211_u4EEC_u8FDB_u5230MySQL_u7684bin_u76EE_u5F55_u4E0B"><a href="#1-_u9996_u5148_u6211_u4EEC_u8FDB_u5230MySQL_u7684bin_u76EE_u5F55_u4E0B" class="headerlink" title="1.é¦–å…ˆæˆ‘ä»¬è¿›åˆ°MySQLçš„binç›®å½•ä¸‹"></a>1.é¦–å…ˆæˆ‘ä»¬è¿›åˆ°MySQLçš„binç›®å½•ä¸‹</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">âœ  cd /usr/local/mysql/bin</div></pre></td></tr></table></figure>
<h5 id="2-_u5207_u6362_u6210root_u8EAB_u4EFD"><a href="#2-_u5207_u6362_u6210root_u8EAB_u4EFD" class="headerlink" title="2.åˆ‡æ¢æˆrootèº«ä»½"></a>2.åˆ‡æ¢æˆrootèº«ä»½</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">âœ  bin sudo su</div></pre></td></tr></table></figure>
<h5 id="3-_u8DE8_u8FC7_u6743_u9650_u7684_u9A8C_u8BC1"><a href="#3-_u8DE8_u8FC7_u6743_u9650_u7684_u9A8C_u8BC1" class="headerlink" title="3.è·¨è¿‡æƒé™çš„éªŒè¯"></a>3.è·¨è¿‡æƒé™çš„éªŒè¯</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sh-3.2# ./mysqld_safe --skip-grant-tables &amp;</div><div class="line">[1] 9451</div><div class="line">sh-3.2# 2017-01-03T15:40:10.6NZ mysqld_safe Logging to &apos;/usr/local/mysql/data/yzydeMacBook-Pro.local.err&apos;.</div><div class="line">2017-01-03T15:40:10.6NZ mysqld_safe Starting mysqld daemon with databases from /usr/local/mysql/data</div></pre></td></tr></table></figure>
<h5 id="4-_u4EE5root_u8EAB_u4EFD_u767B_u5F55MySQL"><a href="#4-_u4EE5root_u8EAB_u4EFD_u767B_u5F55MySQL" class="headerlink" title="4.ä»¥rootèº«ä»½ç™»å½•MySQL"></a>4.ä»¥rootèº«ä»½ç™»å½•MySQL</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">./mysql -uroot</div><div class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</div><div class="line">Your MySQL connection id is 2</div><div class="line">Server version: 5.7.12 MySQL Community Server (GPL)</div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</div><div class="line"></div><div class="line">Oracle is a registered trademark of Oracle Corporation and/or its</div><div class="line">affiliates. Other names may be trademarks of their respective</div><div class="line">owners.</div><div class="line"></div><div class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</div></pre></td></tr></table></figure>
<h5 id="5-_u9009_u62E9mysql_u6570_u636E_u5E93"><a href="#5-_u9009_u62E9mysql_u6570_u636E_u5E93" class="headerlink" title="5.é€‰æ‹©mysqlæ•°æ®åº“"></a>5.é€‰æ‹©mysqlæ•°æ®åº“</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use mysql</div><div class="line">Reading table information for completion of table and column names</div><div class="line">You can turn off this feature to get a quicker startup with -A</div><div class="line"></div><div class="line">Database changed</div></pre></td></tr></table></figure>
<h5 id="6-_u663E_u793Amysql_u6570_u636E_u5E93_u4E0B_u7684_u8868"><a href="#6-_u663E_u793Amysql_u6570_u636E_u5E93_u4E0B_u7684_u8868" class="headerlink" title="6.æ˜¾ç¤ºmysqlæ•°æ®åº“ä¸‹çš„è¡¨"></a>6.æ˜¾ç¤ºmysqlæ•°æ®åº“ä¸‹çš„è¡¨</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show tables;</div><div class="line">+---------------------------+</div><div class="line">| Tables_in_mysql           |</div><div class="line">+---------------------------+</div><div class="line">| columns_priv              |</div><div class="line">| db                        |</div><div class="line">| engine_cost               |</div><div class="line">| event                     |</div><div class="line">| func                      |</div><div class="line">| general_log               |</div><div class="line">| gtid_executed             |</div><div class="line">| help_category             |</div><div class="line">| help_keyword              |</div><div class="line">| help_relation             |</div><div class="line">| help_topic                |</div><div class="line">| innodb_index_stats        |</div><div class="line">| innodb_table_stats        |</div><div class="line">| ndb_binlog_index          |</div><div class="line">| plugin                    |</div><div class="line">| proc                      |</div><div class="line">| procs_priv                |</div><div class="line">| proxies_priv              |</div><div class="line">| server_cost               |</div><div class="line">| servers                   |</div><div class="line">| slave_master_info         |</div><div class="line">| slave_relay_log_info      |</div><div class="line">| slave_worker_info         |</div><div class="line">| slow_log                  |</div><div class="line">| tables_priv               |</div><div class="line">| time_zone                 |</div><div class="line">| time_zone_leap_second     |</div><div class="line">| time_zone_name            |</div><div class="line">| time_zone_transition      |</div><div class="line">| time_zone_transition_type |</div><div class="line">| user                      |</div><div class="line">+---------------------------+</div><div class="line">31 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<h5 id="7-_u5F88_u660E_u663E_u6211_u4EEC_u9700_u8981_u7684_u5BC6_u7801_u662F_u5B58_u5728user_u8FD9_u4E2A_u8868_u4E0B_u7684_uFF0C_u6240_u4EE5_u6211_u4EEC_u76F4_u63A5_u770Buser_u7684_u8868_u7ED3_u6784_u662F_u600E_u4E48_u6837_u7684"><a href="#7-_u5F88_u660E_u663E_u6211_u4EEC_u9700_u8981_u7684_u5BC6_u7801_u662F_u5B58_u5728user_u8FD9_u4E2A_u8868_u4E0B_u7684_uFF0C_u6240_u4EE5_u6211_u4EEC_u76F4_u63A5_u770Buser_u7684_u8868_u7ED3_u6784_u662F_u600E_u4E48_u6837_u7684" class="headerlink" title="7.å¾ˆæ˜æ˜¾æˆ‘ä»¬éœ€è¦çš„å¯†ç æ˜¯å­˜åœ¨userè¿™ä¸ªè¡¨ä¸‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹userçš„è¡¨ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„"></a>7.å¾ˆæ˜æ˜¾æˆ‘ä»¬éœ€è¦çš„å¯†ç æ˜¯å­˜åœ¨userè¿™ä¸ªè¡¨ä¸‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹userçš„è¡¨ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show columns from user;</div><div class="line">+------------------------+-----------------------------------+------+-----+-----------------------+-------+</div><div class="line">| Field                  | Type                              | Null | Key | Default               | Extra |</div><div class="line">+------------------------+-----------------------------------+------+-----+-----------------------+-------+</div><div class="line">| Host                   | char(60)                          | NO   | PRI |                       |       |</div><div class="line">| User                   | char(32)                          | NO   | PRI |                       |       |</div><div class="line">| Select_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Insert_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Update_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Delete_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Drop_priv              | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Reload_priv            | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Shutdown_priv          | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Process_priv           | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| File_priv              | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Grant_priv             | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| References_priv        | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Index_priv             | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Alter_priv             | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Show_db_priv           | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Super_priv             | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_tmp_table_priv  | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Lock_tables_priv       | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Execute_priv           | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Repl_slave_priv        | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Repl_client_priv       | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_view_priv       | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Show_view_priv         | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_routine_priv    | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Alter_routine_priv     | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_user_priv       | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Event_priv             | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Trigger_priv           | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| Create_tablespace_priv | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| ssl_type               | enum(&apos;&apos;,&apos;ANY&apos;,&apos;X509&apos;,&apos;SPECIFIED&apos;) | NO   |     |                       |       |</div><div class="line">| ssl_cipher             | blob                              | NO   |     | NULL                  |       |</div><div class="line">| x509_issuer            | blob                              | NO   |     | NULL                  |       |</div><div class="line">| x509_subject           | blob                              | NO   |     | NULL                  |       |</div><div class="line">| max_questions          | int(11) unsigned                  | NO   |     | 0                     |       |</div><div class="line">| max_updates            | int(11) unsigned                  | NO   |     | 0                     |       |</div><div class="line">| max_connections        | int(11) unsigned                  | NO   |     | 0                     |       |</div><div class="line">| max_user_connections   | int(11) unsigned                  | NO   |     | 0                     |       |</div><div class="line">| plugin                 | char(64)                          | NO   |     | mysql_native_password |       |</div><div class="line">| authentication_string  | text                              | YES  |     | NULL                  |       |</div><div class="line">| password_expired       | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">| password_last_changed  | timestamp                         | YES  |     | NULL                  |       |</div><div class="line">| password_lifetime      | smallint(5) unsigned              | YES  |     | NULL                  |       |</div><div class="line">| account_locked         | enum(&apos;N&apos;,&apos;Y&apos;)                     | NO   |     | N                     |       |</div><div class="line">+------------------------+-----------------------------------+------+-----+-----------------------+-------+</div><div class="line">45 rows in set (0.02 sec)</div></pre></td></tr></table></figure>
<h5 id="8-_u8868_u7684_u5185_u5BB9_u6BD4_u8F83_u591A_uFF0C_u4F46_u662F_u6211_u4EEC_u5F88_u5BB9_u6613_u5C31_u53D1_u73B0_uFF0C_u5BC6_u7801_u5176_u5B9E_u662F_u5B58_u5728authentication_string_u5B57_u6BB5_u4E0B_u7684_uFF0C_u90A3_u6211_u4EEC_u5C31_u53EF_u4EE5_u76F4_u63A5_u8BFBUser_u5185_u5BB9_u4E3Aroot_u7684_u5BC6_u7801_u4E86"><a href="#8-_u8868_u7684_u5185_u5BB9_u6BD4_u8F83_u591A_uFF0C_u4F46_u662F_u6211_u4EEC_u5F88_u5BB9_u6613_u5C31_u53D1_u73B0_uFF0C_u5BC6_u7801_u5176_u5B9E_u662F_u5B58_u5728authentication_string_u5B57_u6BB5_u4E0B_u7684_uFF0C_u90A3_u6211_u4EEC_u5C31_u53EF_u4EE5_u76F4_u63A5_u8BFBUser_u5185_u5BB9_u4E3Aroot_u7684_u5BC6_u7801_u4E86" class="headerlink" title="8.è¡¨çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“å°±å‘ç°ï¼Œå¯†ç å…¶å®æ˜¯å­˜åœ¨authentication_stringå­—æ®µä¸‹çš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¯»Userå†…å®¹ä¸ºrootçš„å¯†ç äº†"></a>8.è¡¨çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“å°±å‘ç°ï¼Œå¯†ç å…¶å®æ˜¯å­˜åœ¨authentication_stringå­—æ®µä¸‹çš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¯»Userå†…å®¹ä¸ºrootçš„å¯†ç äº†</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select authentication_string from user where User=&apos;root&apos;;</div><div class="line">+-------------------------------------------+</div><div class="line">| authentication_string                     |</div><div class="line">+-------------------------------------------+</div><div class="line">| *781D25322166DB7FF99BA4A1FA5ED30439A60DDE |</div><div class="line">+-------------------------------------------+</div><div class="line">1 row in set (0.01 sec)</div></pre></td></tr></table></figure>
<p>OKï¼Œé‚£æˆ‘ä»¬æ‹¿ç€è¿™ä¸ªå¯†ç åˆ°<code>Navicat</code>è¯•è¯•çœ‹</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/EditConnection.png!400x400" alt=""></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/connectionSuccessful.png!400x400" alt=""></p>
<p>Wonderful~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ™šä¸Šåœ¨ç”¨&lt;code&gt;Navicat&lt;/code&gt;å»è¿æœ¬åœ°çš„MySQLçš„æ—¶å€™å‘ç°æˆ‘å·²ç»å¿˜äº†å¯†ç äº†ï¼Œè¯•äº†ç½‘ä¸Šå¾ˆå¤šæ–¹å¼éƒ½ä¸è¡Œâ€¦åæ¥å‘ç°å…¶å®å¯ä»¥è‡ªå·±ç›´æ¥å»çœ‹å½“åˆè®¾ç½®çš„å¯†ç ..&lt;/p&gt;
&lt;p&gt;æ¥çœ‹æ­£æ–‡ï¼š&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://yuzeyang.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>é¡¹ç›®æ¥å…¥ä½¿ç”¨React Native</title>
    <link href="http://yuzeyang.github.io/2016/10/09/react-native/"/>
    <id>http://yuzeyang.github.io/2016/10/09/react-native/</id>
    <published>2016-10-09T13:53:32.000Z</published>
    <updated>2017-07-11T03:07:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œå› ä¸ºæœ€è¿‘é¡¹ç›®å¼€å§‹å°è¯•ä½¿ç”¨React Nativeï¼ˆä»¥ä¸‹ç®€ç§°RNï¼‰æ¥å¼€å‘ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨ç ”ç©¶ï¼Œç›®å‰ä¸ºæ­¢å¼€å‘çš„å†…å®¹ä¸å¤šï¼Œæ‰€ä»¥ä½¿ç”¨è¿‡çš„ä¸œè¥¿ä¹Ÿä¸ç®—å¤šï¼Œè¿™é‡Œä¹Ÿåªæ˜¯åšä¸ªç®€å•çš„è®°å½•</p>
<p>è¿™é‡Œæˆ‘æ‰“ç®—ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è®²ï¼š</p>
<p>1.èƒŒæ™¯ä»‹ç»</p>
<p>2.ç¯å¢ƒçš„é…ç½®</p>
<p>3.RNæ‰€éœ€è¦çŸ¥é“çš„çŸ¥è¯†</p>
<p>4.RNä¸åŸç”Ÿçš„äº¤äº’</p>
<p>5.æœ¬åœ°è°ƒè¯•ä¸æœ¬åœ°æ‰“åŒ…è°ƒè¯•</p>
<p>6.è¿œç¨‹çƒ­æ›´æ–°</p>
<p>7.iOSå’ŒAndroidä¸åŒæ ·å¼å¤„ç†</p>
<p>8.è¸©å‘è®°å½•</p>
<p>9.ç›¸å…³èµ„æ–™</p>
<a id="more"></a>
<h2 id="0x00__u80CC_u666F_u4ECB_u7ECD"><a href="#0x00__u80CC_u666F_u4ECB_u7ECD" class="headerlink" title="0x00 èƒŒæ™¯ä»‹ç»"></a>0x00 èƒŒæ™¯ä»‹ç»</h2><p>RNæ˜¯Facebookåœ¨React.js 2015å¤§ä¼šä¸Šå…¬å¸ƒå¼€æºçš„ï¼Œå®ƒæ˜¯åŸºäºå¼€æºæ¡†æ¶React.jsæ¥å®ç°çš„ï¼Œå®ƒæ”¯æŒäº†iOSå’ŒAndroidä¸¤å¤§å¹³å°ï¼Œè§£å†³å¼€å‘è€…ä»¬ç¼–å†™é‡å¤ä»£ç çš„ç—›ç‚¹ï¼Œå®ç°äº†æ‰€è°“çš„è·¨å¹³å°å¼€å‘ï¼ŒLearn Once , Write Anywhereï¼Œè¿™æ˜¯ç›®å‰å¾ˆå¤šå¼€å‘è€…æ‰€è¿½æ±‚çš„ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›ç‹¬ç«‹å¼€å‘è€…æˆ–è€…é¡¹ç›®å¿«é€Ÿè¿­ä»£çš„å›¢é˜Ÿï¼Œå¯ä»¥å°è¯•ä½¿ç”¨RNæ¥å¼€å‘ï¼Œå¦å¤–åŒ…æ‹¬æ–¹ä¾¿çš„npmç®¡ç†ï¼Œå¿«é€Ÿçš„è°ƒè¯•ç­‰ç­‰</p>
<p>é‚£ä¹ˆæ—¢ç„¶ä¼˜ç‚¹è¿™ä¹ˆæ˜æ˜¾ï¼Œä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†çš„å›¢é˜Ÿè¿˜æ˜¯é‡‡ç”¨ä¼ ç»Ÿçš„iOSã€Androidå¼€å‘å‘¢ï¼Œè¸©è¿‡å‘çš„åŒå­¦éƒ½çŸ¥é“ï¼Œé¦–å…ˆåœ¨æ”¯æŒä¸Šè¿˜åšå¾—ä¸å¤Ÿå®Œå–„ï¼Œåœ¨ä½¿ç”¨ç»„ä»¶æ—¶ï¼ŒRNåŸæœ‰æä¾›çš„ç»„ä»¶å¾€å¾€ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒï¼Œä¸åŸç”Ÿç»„ä»¶å¤šå°‘å­˜åœ¨ç€å·®å¼‚ï¼Œè€Œä¸”åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶æ—¶ï¼Œåˆä¼šå› ä¸ºé•¿æœŸä¸æ›´æ–°çš„åŸå› ï¼Œå­˜åœ¨å¾ˆå¤šå‘ï¼Œå¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œæ ¹æœ¬ä¸çŸ¥é“å‘åœ¨å“ªï¼Œå®Œå…¨æ— ä»ä¸‹æ‰‹ã€‚å¦å¤–RNçš„æ€§èƒ½ä¹Ÿä¸èƒ½å’ŒåŸç”Ÿçš„ç›¸æå¹¶è®ºï¼Œç‰¹åˆ«æ˜¯åˆ—è¡¨ç»„ä»¶åœ¨æ¸²æŸ“å¤§é‡æ•°æ®æ—¶ï¼Œæµç•…æ€§æ–¹é¢è¿˜æ˜¯åŸç”Ÿæ›´åŠ ä¼˜è¶Šï¼Œè€Œä¸”å¹¶éæ‰€ä»¥ä»£ç iOSå’ŒAndroidéƒ½èƒ½å…¬ç”¨ï¼Œå¦‚æœæŸä¸ªç»„ä»¶åªæ”¯æŒæŸä¸€ä¸ªå¹³å°ï¼Œé‚£ä½ å¿…é¡»åˆ†å¼€ç¼–å†™ä»£ç ï¼Œå®é™…ä¸Šè¿˜æ˜¯å­˜åœ¨é‡å¤ä»£ç ï¼Œé™¤æ­¤ä¹‹å¤–å­¦ä¹ çš„æˆæœ¬ä»¥åŠå›¢é˜ŸRNæ¨å¹¿ç­‰ç­‰åŸå› éƒ½éœ€è¦è€ƒé‡ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ï¼Œè·¨å¹³å°å¼€å‘å§‹ç»ˆæ˜¯ä¸€ä¸ªè¶‹åŠ¿ï¼ŒRNæ•´ä¸ªç¤¾åŒºä¹Ÿåœ¨ä¸æ–­çš„å‘å±•ï¼Œç›¸ä¿¡æœªæ¥æˆ‘ä»¬ä¼šå®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„è·¨å¹³å°å¼€å‘~</p>
<h2 id="0x01__u73AF_u5883_u914D_u7F6E"><a href="#0x01__u73AF_u5883_u914D_u7F6E" class="headerlink" title="0x01 ç¯å¢ƒé…ç½®"></a>0x01 ç¯å¢ƒé…ç½®</h2><p>ç›¸å¯¹äºAndroidçš„ç¯å¢ƒé…ç½®è¿‡ç¨‹æ¥è¯´ï¼ŒiOSå¯ä»¥è¯´æ˜¯ç®€å•è½»æ¾â€¦å‡ºç°çš„é—®é¢˜è¦å°‘å¾ˆå¤š</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…<strong>Homebrew</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</div></pre></td></tr></table></figure>
<p>ç„¶åå®‰è£…<strong>node</strong>å’Œ<strong>watchman</strong>(ç”¨äºç›‘æµ‹æ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install node</div><div class="line">brew install watchman</div></pre></td></tr></table></figure>
<p>RNçš„å‘½ä»¤è¡Œå·¥å…·<strong>react-native-cli</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g react-native-cli</div></pre></td></tr></table></figure>
<p>å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼Œåªè¦å‰é¢åŠ ä¸ª<strong>sudo</strong>å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo npm install -g react-native-cli</div></pre></td></tr></table></figure>
<p>yeah~thatâ€™s all~æˆ‘åœ¨é…ç½®çš„è¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬æ²¡æœ‰æŠ¥é”™ï¼Œå¦‚æœæœ‰å‡ºç°é…ç½®é—®é¢˜çš„è¯ï¼Œè¯·è‡ªè¡ŒGoogleä¸€ä¸‹ï¼Œçœ‹çœ‹å¤§å®¶çš„è§£å†³æ–¹æ³•</p>
<p>å¦‚æœåœ¨åŸæœ‰iOSé¡¹ç›®ä¸­é›†æˆçš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨package.jsonæ–‡ä»¶é…ç½®ä¸€ä¸‹</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"your project name"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.1"</span>,</div><div class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"start"</span>: <span class="string">"node node_modules/react-native/local-cli/cli.js start"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"react"</span>: <span class="string">"15.3.1"</span>,</div><div class="line">    <span class="attr">"react-native"</span>: <span class="string">"0.33.0"</span>,</div><div class="line">    <span class="attr">"react-native-swipeout"</span>: <span class="string">"^2.0.12"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”Podfileé‡Œï¼Œå¯¼å…¥éœ€è¦çš„RNæ¨¡å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">pod &apos;React&apos;, :path =&gt; &apos;../node_modules/react-native&apos;, :subspecs =&gt; [</div><div class="line">    &apos;Core&apos;,</div><div class="line">    &apos;RCTText&apos;,</div><div class="line">    &apos;RCTImage&apos;,</div><div class="line">    &apos;RCTNetwork&apos;,</div><div class="line">    &apos;RCTWebSocket&apos;, # needed for debugging</div><div class="line">    # Add any other subspecs you want to use in your project</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="0x02_RN_u6240_u9700_u8981_u77E5_u9053_u7684_u77E5_u8BC6"><a href="#0x02_RN_u6240_u9700_u8981_u77E5_u9053_u7684_u77E5_u8BC6" class="headerlink" title="0x02 RNæ‰€éœ€è¦çŸ¥é“çš„çŸ¥è¯†"></a>0x02 RNæ‰€éœ€è¦çŸ¥é“çš„çŸ¥è¯†</h2><h3 id="RN_u7684_u8FD0_u884C_u673A_u5236"><a href="#RN_u7684_u8FD0_u884C_u673A_u5236" class="headerlink" title="RNçš„è¿è¡Œæœºåˆ¶"></a>RNçš„è¿è¡Œæœºåˆ¶</h3><p>åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£RNçš„è¿è¡Œæœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„ï¼Œè¿™æ ·å†™èµ·æ¥æ€è·¯ä¼šæ›´åŠ æ¸…æ™°</p>
<p>é¦–å…ˆï¼Œç¨‹åºéœ€è¦æœ‰ä¸ªå…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¾ˆå¤šçš„ç»„ä»¶ï¼Œä½†æ˜¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªç»„ä»¶ç”¨æ¥åšä¸ºç¨‹åºçš„å…¥å£ï¼ŒRNçš„å…¥å£åˆ™ç±»ä¼¼äºiOSçš„main.mï¼Œåœ¨iOSé‡Œæˆ‘ä»¬ä¼šåœ¨mainå‡½æ•°é‡Œè®¾ç½®åº”ç”¨ç¨‹åºç±»çš„ä»£ç†ç±»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return UIApplicationMain(argc, argv, nil, NSStringFromClass([KDAppDelegate class]));</div></pre></td></tr></table></figure>
<p>åŒæ ·ï¼ŒRNé‡Œæˆ‘ä»¬éœ€è¦æ³¨å†Œå…¥å£çš„åç§°ï¼Œå¹¶ä¸”è¿™ä¸ªåç§°è¦å’ŒåŸç”Ÿçš„åˆå§‹åŒ–RNç•Œé¢æ—¶çš„å…¥å£åç§°ä¿æŒä¸€è‡´</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å¼•ç”¨navigationä½¿ç”¨çš„ç»„ä»¶</span></div><div class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">  AppRegistry,</div><div class="line">  ...</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"></div><div class="line"><span class="comment">// åˆ›å»ºnavigationç±»</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">navigation</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="comment">// set compnent</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ³¨å†Œnavigationä¸ºç¨‹åºçš„å…¥å£</span></div><div class="line">AppRegistry.registerComponent(<span class="string">'navigation'</span>, () =&gt; navigation);</div></pre></td></tr></table></figure>
<p>åœ¨iOSåŸç”Ÿè¿™è¾¹éœ€è¦ç”¨åˆ°RNçš„åœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å®ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSURL *jsCodeLocation =</div><div class="line">[[NSBundle mainBundle] URLForResource:@&quot;bundle/index.ios&quot; withExtension:@&quot;jsbundle&quot;];</div><div class="line">//        [NSURL URLWithString:@&quot;http://172.17.9.188:8081/index.ios.bundle?platform=ios&quot;];</div><div class="line">RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation</div><div class="line">                                                    moduleName:@&quot;navigation&quot;</div><div class="line">                                            initialProperties:nil</div><div class="line">                                                 launchOptions:nil];</div><div class="line">self.view = rootView;</div></pre></td></tr></table></figure>
<p>Tipï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jsCodeLocation æ˜¯RNèµ„æºåŠ è½½çš„è·¯å¾„ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼å»åŠ è½½ï¼Œä¸€ç§æ˜¯åŠ è½½æœ¬åœ°çš„jsæ–‡ä»¶åŠå…¶ä»–èµ„æºæ–‡ä»¶ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬å°†å…¶æ‰“åŒ…æˆbundleæ–‡ä»¶ï¼Œå‰è€…çš„ä¼˜åŠ¿åœ¨äºæ–¹ä¾¿è°ƒè¯•ï¼Œåè€…æ˜¯ç”¨æ¥æ‰“åŒ…å‘å¸ƒä¸Šçº¿ç”¨</div></pre></td></tr></table></figure>
<p><code>moduleName</code>æ˜¯å¯¹åº”äºRNçš„å…¥å£åå­—ï¼Œä¸”è¿™ä¸ªæ˜¯å”¯ä¸€çš„ï¼Œé‚£æˆ‘ä»¬å¦‚æœåŸç”Ÿæœ‰å¤šä¸ªå…¥å£éœ€è¦åˆå§‹åŒ–ä¸åŒçš„RNç•Œé¢ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±ç”¨åˆ°äº†<code>initialProperties</code>ï¼Œå®ƒæ˜¯å­—å…¸ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¥å£ä½œä¸ºè·¯ç”±ï¼Œåœ¨<code>initialProperties</code>é‡Œä¼ å…¥æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–çš„ç•Œé¢åç§°ï¼Œå…¥å£è·å–åˆ°åç§°ä¹‹åï¼Œæ¸²æŸ“å¯¹åº”çš„ç•Œé¢å³å¯</p>
<h3 id="RN_u7EC4_u4EF6_u7684_u751F_u547D_u5468_u671F"><a href="#RN_u7EC4_u4EF6_u7684_u751F_u547D_u5468_u671F" class="headerlink" title="RNç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ"></a>RNç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ</h3><p>åœ¨RNé‡Œé¢ï¼Œæ‰€è°“çš„ç•Œé¢åº”è¯¥ç§°ä½œç±»æˆ–è€…ç»„ä»¶æ›´ä¸ºåˆé€‚</p>
<p>å¹¶ä¸”ç»„ä»¶ä¹Ÿæœ‰å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œå’ŒiOSé‡Œçš„<code>viewWillAppear</code>ã€<code>viewDidDisappear</code>ç­‰ç­‰å¾ˆåƒï¼Œä¸‹é¢ç”Ÿå‘½å‘¨æœŸå†…å®¹å–è‡ªäº<a href="http://www.race604.com/react-native-component-lifecycle/" target="_blank" rel="external">http://www.race604.com/react-native-component-lifecycle/</a></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/RNCycleLife.jpg!700x700" alt=""></p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠç»„ä»¶ç”Ÿå‘½å‘¨æœŸå¤§è‡´åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼šæ˜¯ç»„ä»¶ç¬¬ä¸€æ¬¡ç»˜åˆ¶é˜¶æ®µï¼Œå¦‚å›¾ä¸­çš„ä¸Šé¢è™šçº¿æ¡†å†…ï¼Œåœ¨è¿™é‡Œå®Œæˆäº†ç»„ä»¶çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼›</li>
<li>ç¬¬äºŒé˜¶æ®µï¼šæ˜¯ç»„ä»¶åœ¨è¿è¡Œå’Œäº¤äº’é˜¶æ®µï¼Œå¦‚å›¾ä¸­å·¦ä¸‹è§’è™šçº¿æ¡†ï¼Œè¿™ä¸ªé˜¶æ®µç»„ä»¶å¯ä»¥å¤„ç†ç”¨æˆ·äº¤äº’ï¼Œæˆ–è€…æ¥æ”¶äº‹ä»¶æ›´æ–°ç•Œé¢ï¼›</li>
<li>ç¬¬ä¸‰é˜¶æ®µï¼šæ˜¯ç»„ä»¶å¸è½½æ¶ˆäº¡çš„é˜¶æ®µï¼Œå¦‚å›¾ä¸­å³ä¸‹è§’çš„è™šçº¿æ¡†ä¸­ï¼Œè¿™é‡Œåšä¸€äº›ç»„ä»¶çš„æ¸…ç†å·¥ä½œã€‚</li>
</ul>
<p>ä¸‹é¢æ¥è¯¦ç»†ä»‹ç»ç”Ÿå‘½å‘¨æœŸä¸­çš„å„å›è°ƒå‡½æ•°ã€‚</p>
<h4 id="getDefaultProps"><a href="#getDefaultProps" class="headerlink" title="getDefaultProps"></a>getDefaultProps</h4><p>åœ¨ç»„ä»¶åˆ›å»ºä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨ <code>getDefaultProps()</code>ï¼Œè¿™æ˜¯å…¨å±€è°ƒç”¨ä¸€æ¬¡ï¼Œä¸¥æ ¼åœ°æ¥è¯´ï¼Œè¿™ä¸æ˜¯ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸçš„ä¸€éƒ¨åˆ†ã€‚åœ¨ç»„ä»¶è¢«åˆ›å»ºå¹¶åŠ è½½å€™ï¼Œé¦–å…ˆè°ƒç”¨ <code>getInitialState()</code>ï¼Œæ¥åˆå§‹åŒ–ç»„ä»¶çš„çŠ¶æ€ã€‚</p>
<h4 id="componentWillMount"><a href="#componentWillMount" class="headerlink" title="componentWillMount"></a>componentWillMount</h4><p>ç„¶åï¼Œå‡†å¤‡åŠ è½½ç»„ä»¶ï¼Œä¼šè°ƒç”¨ <code>componentWillMount()</code>ï¼Œå…¶åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentWillMount()</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°è°ƒç”¨æ—¶æœºæ˜¯åœ¨ç»„ä»¶åˆ›å»ºï¼Œå¹¶åˆå§‹åŒ–äº†çŠ¶æ€ä¹‹åï¼Œåœ¨ç¬¬ä¸€æ¬¡ç»˜åˆ¶ <code>render()</code> ä¹‹å‰ã€‚å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›ä¸šåŠ¡åˆå§‹åŒ–æ“ä½œï¼Œä¹Ÿå¯ä»¥è®¾ç½®ç»„ä»¶çŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<h4 id="componentDidMount"><a href="#componentDidMount" class="headerlink" title="componentDidMount"></a>componentDidMount</h4><p>åœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡ç»˜åˆ¶ä¹‹åï¼Œä¼šè°ƒç”¨ <code>componentDidMount()</code>ï¼Œé€šçŸ¥ç»„ä»¶å·²ç»åŠ è½½å®Œæˆã€‚å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentDidMount()</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå…¶è™šæ‹Ÿ DOM å·²ç»æ„å»ºå®Œæˆï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°å¼€å§‹è·å–å…¶ä¸­çš„å…ƒç´ æˆ–è€…å­ç»„ä»¶äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRN æ¡†æ¶æ˜¯å…ˆè°ƒç”¨å­ç»„ä»¶çš„ <code>componentDidMount()</code>ï¼Œç„¶åè°ƒç”¨çˆ¶ç»„ä»¶çš„å‡½æ•°ã€‚ä»è¿™ä¸ªå‡½æ•°å¼€å§‹ï¼Œå°±å¯ä»¥å’Œ JS å…¶ä»–æ¡†æ¶äº¤äº’äº†ï¼Œä¾‹å¦‚è®¾ç½®è®¡æ—¶ <code>setTimeout</code> æˆ–è€… <code>setInterval</code>ï¼Œæˆ–è€…å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚è¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚è¿™ä¸ªå‡½æ•°ä¹‹åï¼Œå°±è¿›å…¥äº†ç¨³å®šè¿è¡ŒçŠ¶æ€ï¼Œç­‰å¾…äº‹ä»¶è§¦å‘ã€‚</p>
<h4 id="componentWillReceiveProps"><a href="#componentWillReceiveProps" class="headerlink" title="componentWillReceiveProps"></a>componentWillReceiveProps</h4><p>å¦‚æœç»„ä»¶æ”¶åˆ°æ–°çš„å±æ€§ï¼ˆpropsï¼‰ï¼Œå°±ä¼šè°ƒç”¨ <code>componentWillReceiveProps()</code>ï¼Œå…¶åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentWillReceiveProps(  </div><div class="line">  object nextProps</div><div class="line">)</div></pre></td></tr></table></figure>
<p>è¾“å…¥å‚æ•° <code>nextProps</code> æ˜¯å³å°†è¢«è®¾ç½®çš„å±æ€§ï¼Œæ—§çš„å±æ€§è¿˜æ˜¯å¯ä»¥é€šè¿‡ <code>this.props</code> æ¥è·å–ã€‚åœ¨è¿™ä¸ªå›è°ƒå‡½æ•°é‡Œé¢ï¼Œä½ å¯ä»¥æ ¹æ®å±æ€§çš„å˜åŒ–ï¼Œé€šè¿‡è°ƒç”¨ <code>this.setState()</code> æ¥æ›´æ–°ä½ çš„ç»„ä»¶çŠ¶æ€ï¼Œè¿™é‡Œè°ƒç”¨æ›´æ–°çŠ¶æ€æ˜¯å®‰å…¨çš„ï¼Œå¹¶ä¸ä¼šè§¦å‘é¢å¤–çš„ <code>render()</code> è°ƒç”¨ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">componentWillReceiveProps: function(nextProps) &#123;  </div><div class="line">  this.setState(&#123;</div><div class="line">    likesIncreasing: nextProps.likeCount &gt; this.props.likeCount</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate"></a>shouldComponentUpdate</h4><p>å½“ç»„ä»¶æ¥æ”¶åˆ°æ–°çš„å±æ€§å’ŒçŠ¶æ€æ”¹å˜çš„è¯ï¼Œéƒ½ä¼šè§¦å‘è°ƒç”¨ <code>shouldComponentUpdate(...)</code>ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">boolean shouldComponentUpdate(  </div><div class="line">  object nextProps, object nextState</div><div class="line">)</div></pre></td></tr></table></figure>
<p>è¾“å…¥å‚æ•° <code>nextProps</code> å’Œä¸Šé¢çš„ <code>componentWillReceiveProps</code> å‡½æ•°ä¸€æ ·ï¼Œ<code>nextState</code> è¡¨ç¤ºç»„ä»¶å³å°†æ›´æ–°çš„çŠ¶æ€å€¼ã€‚è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼å†³å®šæ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶ï¼Œå¦‚æœ <code>true</code> è¡¨ç¤ºéœ€è¦æ›´æ–°ï¼Œç»§ç»­èµ°åé¢çš„æ›´æ–°æµç¨‹ã€‚å¦è€…ï¼Œåˆ™ä¸æ›´æ–°ï¼Œç›´æ¥è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‡½æ•°æ°¸è¿œè¿”å› <code>true</code> ç”¨æ¥ä¿è¯æ•°æ®å˜åŒ–çš„æ—¶å€™ UI èƒ½å¤ŸåŒæ­¥æ›´æ–°ã€‚åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œä½ å¯ä»¥è‡ªå·±é‡è½½è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡æ£€æŸ¥å˜åŒ–å‰åå±æ€§å’ŒçŠ¶æ€ï¼Œæ¥å†³å®š UI æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œèƒ½æœ‰æ•ˆæé«˜åº”ç”¨æ€§èƒ½ã€‚</p>
<h4 id="componentWillUpdate"><a href="#componentWillUpdate" class="headerlink" title="componentWillUpdate"></a>componentWillUpdate</h4><p>å¦‚æœç»„ä»¶çŠ¶æ€æˆ–è€…å±æ€§æ”¹å˜ï¼Œå¹¶ä¸”ä¸Šé¢çš„ <code>shouldComponentUpdate(...)</code> è¿”å›ä¸º <code>true</code>ï¼Œå°±ä¼šå¼€å§‹å‡†æ›´æ–°ç»„ä»¶ï¼Œå¹¶è°ƒç”¨ <code>componentWillUpdate()</code>ï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentWillUpdate(  </div><div class="line">  object nextProps, object nextState</div><div class="line">)</div></pre></td></tr></table></figure>
<p>è¾“å…¥å‚æ•°ä¸ <code>shouldComponentUpdate</code> ä¸€æ ·ï¼Œåœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œå¯ä»¥åšä¸€äº›åœ¨æ›´æ–°ç•Œé¢ä¹‹å‰è¦åšçš„äº‹æƒ…ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œä½ å°±ä¸èƒ½ä½¿ç”¨ <code>this.setState</code> æ¥ä¿®æ”¹çŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°è°ƒç”¨ä¹‹åï¼Œå°±ä¼šæŠŠ <code>nextProps</code> å’Œ <code>nextState</code> åˆ†åˆ«è®¾ç½®åˆ° <code>this.props</code>å’Œ <code>this.state</code> ä¸­ã€‚ç´§æ¥ç€è¿™ä¸ªå‡½æ•°ï¼Œå°±ä¼šè°ƒç”¨ <code>render()</code> æ¥æ›´æ–°ç•Œé¢äº†ã€‚</p>
<h4 id="componentDidUpdate"><a href="#componentDidUpdate" class="headerlink" title="componentDidUpdate"></a>componentDidUpdate</h4><p>è°ƒç”¨äº† <code>render()</code> æ›´æ–°å®Œæˆç•Œé¢ä¹‹åï¼Œä¼šè°ƒç”¨ <code>componentDidUpdate()</code> æ¥å¾—åˆ°é€šçŸ¥ï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">void componentDidUpdate(  </div><div class="line">  object prevProps, object prevState</div><div class="line">)</div></pre></td></tr></table></figure>
<p>å› ä¸ºåˆ°è¿™é‡Œå·²ç»å®Œæˆäº†å±æ€§å’ŒçŠ¶æ€çš„æ›´æ–°äº†ï¼Œæ­¤å‡½æ•°çš„è¾“å…¥å‚æ•°å˜æˆäº† <code>prevProps</code> å’Œ <code>prevState</code>ã€‚</p>
<h4 id="componentWillUnmount"><a href="#componentWillUnmount" class="headerlink" title="componentWillUnmount"></a>componentWillUnmount</h4><p>å½“ç»„ä»¶è¦è¢«ä»ç•Œé¢ä¸Šç§»é™¤çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ <code>componentWillUnmount()</code>ï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void componentWillUnmount()</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå¯ä»¥åšä¸€äº›ç»„ä»¶ç›¸å…³çš„æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚å–æ¶ˆè®¡æ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚</p>
<p>ä¸‹è¡¨æ˜¯ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ï¼Œä»¥åŠèƒ½å¦ä½¿ç”¨ setSate()ï¼š</p>
<table>
<thead>
<tr>
<th>ç”Ÿå‘½å‘¨æœŸ</th>
<th>è°ƒç”¨æ¬¡æ•°</th>
<th>èƒ½å¦ä½¿ç”¨ setSate()</th>
</tr>
</thead>
<tbody>
<tr>
<td>getDefaultProps</td>
<td>1(å…¨å±€è°ƒç”¨ä¸€æ¬¡)</td>
<td>å¦</td>
</tr>
<tr>
<td>getInitialState</td>
<td>1</td>
<td>å¦</td>
</tr>
<tr>
<td>componentWillMount</td>
<td>1</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>render</td>
<td>&gt;=1</td>
<td>å¦</td>
</tr>
<tr>
<td>componentDidMount</td>
<td>1</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>componentWillReceiveProps</td>
<td>&gt;=0</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>shouldComponentUpdate</td>
<td>&gt;=0</td>
<td>å¦</td>
</tr>
<tr>
<td>componentWillUpdate</td>
<td>&gt;=0</td>
<td>å¦</td>
</tr>
<tr>
<td>componentDidUpdate</td>
<td>&gt;=0</td>
<td>å¦</td>
</tr>
<tr>
<td>componentWillUnmount</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
<h3 id="RN_u7684_u8BBE_u8BA1_u6A21_u5F0F"><a href="#RN_u7684_u8BBE_u8BA1_u6A21_u5F0F" class="headerlink" title="RNçš„è®¾è®¡æ¨¡å¼"></a>RNçš„è®¾è®¡æ¨¡å¼</h3><p>ç›®å‰è®¾è®¡æ¨¡å¼ä¹Ÿéå¸¸å¤šï¼Œå¦‚Fluxï¼ŒRefluxï¼ŒReduxï¼ŒRelayï¼ŒMartyï¼Œä¸è¿‡ä»¥ä¸Šéƒ½ä¸æ˜¯å¾ˆäº†è§£ï¼Œå¯ä»¥å‚è€ƒ<a href="https://segmentfault.com/a/1190000004161358" target="_blank" rel="external">ReactNativeçš„ç»„ä»¶æ¶æ„è®¾è®¡</a>å­¦ä¹ äº†è§£ä¸€ä¸‹ï¼Œç”±äºåšå®¢æˆ·ç«¯çš„åŒå­¦æ¥è§¦çš„æœ€å¤šçš„æ˜¯MVCï¼ŒMVVMã€MVCSç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—é€‰ç”¨ç±»ä¼¼MVCSçš„æ¨¡å¼å¯èƒ½æ›´åŠ é€‚åˆæ–°æ‰‹çš„å­¦ä¹ ï¼Œæ¯”å¦‚å†™ç»„ä»¶æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªç»„ä»¶ï¼Œé‡Œé¢ä¼šåŒ…å«æ•°æ®çš„å¤„ç†ï¼Œé¡µé¢çš„æ¸²æŸ“ï¼Œæ ·å¼çš„è®¾ç½®ï¼Œç½‘ç»œè¯·æ±‚ï¼Œå½“è¿™äº›å†…å®¹è¿‡å¤šæ—¶ï¼Œç»„ä»¶å°±ä¼šæ˜¾å¾—ç‰¹åˆ«è‡ƒè‚¿ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å…¶æ‹†åˆ†å¼€ä¸ºæ•°æ®æ¨¡å‹ï¼ˆModelï¼‰ï¼Œé¡µé¢æ¸²æŸ“ï¼Œæ ·å¼è®¾ç½®ï¼Œç½‘è·¯è¯·æ±‚ï¼ˆServiceï¼‰ï¼Œè¿™é‡Œçš„é¡µé¢æ¸²æŸ“å’Œæ ·å¼è®¾ç½®ï¼Œä¸èƒ½ç®—æ˜¯ç§°ä½œä¸ºiOSé‡Œçš„Controllerå’ŒViewï¼Œåº”è¯¥è·Ÿå‰ç«¯ä¸€æ ·ï¼Œåœ¨htmlæ–‡ä»¶é‡Œé¢å†™å¸ƒå±€ï¼Œcssæ–‡ä»¶é‡Œé¢å†™æ ·å¼ï¼Œæ„Ÿè§‰åƒæ˜¯MVCSå’Œå‰ç«¯çš„èåˆ</p>
<h2 id="0x03_RN_u4E0E_u539F_u751F_u7684_u4EA4_u4E92"><a href="#0x03_RN_u4E0E_u539F_u751F_u7684_u4EA4_u4E92" class="headerlink" title="0x03 RNä¸åŸç”Ÿçš„äº¤äº’"></a>0x03 RNä¸åŸç”Ÿçš„äº¤äº’</h2><p>åœ¨å†™RNæ—¶ä¸å…ä¼šé‡åˆ°ä¸åŸç”Ÿäº¤äº’ï¼Œä¸‹é¢æˆ‘åˆ†JSè°ƒç”¨åŸç”Ÿã€åŸç”Ÿè°ƒç”¨JSæ¥è®²</p>
<h3 id="JS_u8C03_u7528_u539F_u751F"><a href="#JS_u8C03_u7528_u539F_u751F" class="headerlink" title="JSè°ƒç”¨åŸç”Ÿ"></a>JSè°ƒç”¨åŸç”Ÿ</h3><p>åœ¨è°ƒç”¨åŸç”Ÿæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>RCTBridgeModule</code>å’Œ<code>RCT_EXPORT_MODULE();</code></p>
<p><code>RCT_EXPORT_MODULE();</code>åˆ™æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œè¿”å›moduleNameï¼Œå¹¶ä¸”è°ƒç”¨<code>+ load</code>æ–¹æ³•æ³¨å†Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define RCT_EXPORT_MODULE(js_name) \</div><div class="line">RCT_EXTERN void RCTRegisterModule(Class); \</div><div class="line">+ (NSString *)moduleName &#123; return @#js_name; &#125; \</div><div class="line">+ (void)load &#123; RCTRegisterModule(self); &#125;</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚æˆ‘ä»¬å¢åŠ ä¸€ä¸ªbridgeæ–¹æ³•ï¼Œè·å–ç‰ˆæœ¬å·ï¼Œ<code>getVersion</code>ä¸ºæ–¹æ³•åï¼Œ<code>callback</code>æ˜¯åŸç”Ÿå›è°ƒç»™JSçš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RCT_EXPORT_METHOD(getVersion : (RCTResponseSenderBlock)callback) &#123;</div><div class="line">    NSString *version =</div><div class="line">    [[NSBundle mainBundle] objectForInfoDictionaryKey:@&quot;CFBundleShortVersionString&quot;];</div><div class="line">    callback(@[[NSNull null], @[version]]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åè¿”å›æ–¹æ³•çš„é˜Ÿåˆ—ä¸ºä¸»é˜Ÿåˆ—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (dispatch_queue_t)methodQueue &#123;</div><div class="line">    return dispatch_get_main_queue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨JSæ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ZanIntentModule = NativeModules.ZanIntentModule;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™è°ƒç”¨æˆ‘ä»¬åœ¨åŸç”Ÿæ—¶å®šä¹‰æ–¹æ³•</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ZanIntentModule.getVersion(</div><div class="line"><span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// do some thing</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="u539F_u751F_u8C03_u7528JS"><a href="#u539F_u751F_u8C03_u7528JS" class="headerlink" title="åŸç”Ÿè°ƒç”¨JS"></a>åŸç”Ÿè°ƒç”¨JS</h3><p>è€ç‰ˆæœ¬çš„è°ƒç”¨æ–¹å¼ä¸ºï¼Œä½†æ˜¯æ¥å£è¢«æ ‡è®°ä¸ºdeprecatedï¼š<code>__deprecated_msg(&quot;Subclass RCTEventEmitter instead&quot;);</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.bridge.eventDispatcher sendAppEventWithName:kGiftReloadData body:nil];</div></pre></td></tr></table></figure>
<p>æ–°ç‰ˆæœ¬çš„è°ƒç”¨æ–¹å¼ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ZanEventEmitter *emitter = [[ZanEventEmitter alloc] init];</div><div class="line">emitter.bridge = self.bridge;</div><div class="line">[emitter sendEventWithName:kGiftReloadData body:nil];</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯æ–°ç‰ˆæœ¬å‘çš„æ˜¯ï¼Œç›´æ¥è¿™æ ·è°ƒç”¨æ—¶bridgeå±…ç„¶æ˜¯nilï¼Œç½‘ä¸Šè¯´ç”¨å•ä¾‹ï¼Œä½†æ˜¯ä¹Ÿä¸è¡Œâ€¦æ‰€ä»¥æˆ‘è¿˜æ˜¯ç”¨è€ç‰ˆæœ¬çš„è°ƒç”¨æ–¹æ³•ï¼Œæœ‰å“ªä¸ªå¤§ç¥çŸ¥é“æ€ä¹ˆç”¨æ–°ç‰ˆæœ¬æ¥å£è°ƒç”¨çš„æ­£ç¡®å§¿åŠ¿ï¼Œè¯·ç•™è¨€äº¤æµå“ˆ</p>
<p>ç„¶ååœ¨å®ç°<code>RCTBridgeDelegate</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (NSURL *)sourceURLForBridge:(RCTBridge *)bridge &#123;</div><div class="line">    return [[NSBundle mainBundle] URLForResource:@&quot;bundle/index.ios&quot; withExtension:@&quot;jsbundle&quot;];</div><div class="line">//    return [NSURL URLWithString:@&quot;http://172.17.9.94:8081/index.ios.bundle?platform=ios&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å¯¹åº”çš„ç»„ä»¶é‡Œï¼Œéœ€è¦åœ¨<code>componentWillMount</code>å¢åŠ ç›‘å¬</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">componentWillMount() &#123;</div><div class="line">  <span class="keyword">this</span>.eventEmitter = NativeAppEventEmitter.addListener(</div><div class="line">    <span class="string">'GiftReloadData'</span>,</div><div class="line">    () =&gt; <span class="keyword">this</span>._reloadData()</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ä¹Ÿéœ€è¦ç§»é™¤æ‰ç›‘å¬</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">componentWillUnmount() &#123;</div><div class="line">  subscription.remove();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååŸç”Ÿå‘é€actionä¹‹åï¼Œä¼šè§¦å‘æˆ‘ä»¬è®¾å®šå¥½çš„<code>reloadData()</code>æ–¹æ³•</p>
<h2 id="0x04__u672C_u5730_u8C03_u8BD5_u4E0E_u6253_u5305_u8C03_u8BD5"><a href="#0x04__u672C_u5730_u8C03_u8BD5_u4E0E_u6253_u5305_u8C03_u8BD5" class="headerlink" title="0x04 æœ¬åœ°è°ƒè¯•ä¸æ‰“åŒ…è°ƒè¯•"></a>0x04 æœ¬åœ°è°ƒè¯•ä¸æ‰“åŒ…è°ƒè¯•</h2><p>åœ¨ç¼–å†™çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿéœ€è¦è¿›è¡Œè°ƒè¯•ï¼Œè°ƒè¯•æœ‰ä¸¤ç§æ–¹æ³•ï¼šä¸€ç§æ˜¯æœ¬åœ°è°ƒè¯•ï¼Œä¸€ç§æ˜¯æ‰“åŒ…è°ƒè¯•</p>
<h3 id="u672C_u5730_u8C03_u8BD5"><a href="#u672C_u5730_u8C03_u8BD5" class="headerlink" title="æœ¬åœ°è°ƒè¯•"></a>æœ¬åœ°è°ƒè¯•</h3><p>æˆ‘ä»¬åœ¨åŠ è½½bundleæ—¶ï¼Œéœ€è¦æ›¿æ¢æˆä½ çš„ipåœ°å€ï¼Œç«¯å£å·ä¸è¦å˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[NSURL URLWithString:@&quot;http://172.17.9.94:8081/index.ios.bundle?platform=ios&quot;]</div></pre></td></tr></table></figure>
<p>å¦‚æœä½ æ˜¯åœ¨çœŸæœºä¸Šè°ƒè¯•ï¼Œä½ éœ€è¦å¼€å¯HTTPä»£ç†ï¼Œå¡«å†™ä½ çš„ipåœ°å€å’Œç«¯å£å·</p>
<p>åœ¨ç»ˆç«¯ä¸Šï¼Œå…ˆè¿›å…¥åˆ°ä½ çš„é¡¹ç›®ç›®å½•ï¼ˆä¸node_modulesç›®å½•åŒçº§ï¼‰ï¼Œç„¶åå¼€å¯æœåŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yzydeMacBook-Pro:shangjiaban-ios yzy$ npm start</div></pre></td></tr></table></figure>
<p>ä½ ä¿®æ”¹äº†æŸå¤„ä¹‹åï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šç‚¹å‡»<code>Shake Gesture</code>æˆ–è€…å¿«æ·é”®ï¼Œåœ¨çœŸæœºä¸Šåªè¦æ‘‡ä¸€æ‘‡å°±å¯ä»¥</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/Shake.png!400x400" alt=""></p>
<p>åœ¨æ¨¡æ‹Ÿå™¨å¼¹å‡ºæ¡†é‡Œé€‰æ‹©<code>Roload</code>ï¼Œè¿™æ ·å°±ä¼šé‡æ–°åŠ è½½ä½ æœ¬åœ°çš„JSæ–‡ä»¶</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/simulation.png!400x400" alt=""></p>
<p>å¦‚æœä½ æƒ³æŸ¥çœ‹JSé‡Œé¢çš„logæ—¥å¿—ï¼Œä½ å¯ä»¥é€‰æ‹©<code>Start Remote JS Debugging</code>ï¼Œåœ¨chromeæµè§ˆå™¨é‡Œå°±èƒ½çœ‹åˆ°è¾“å‡ºçš„æ—¥å¿—äº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/chromeDebug.png" alt=""></p>
<h3 id="u6253_u5305_u8C03_u8BD5"><a href="#u6253_u5305_u8C03_u8BD5" class="headerlink" title="æ‰“åŒ…è°ƒè¯•"></a>æ‰“åŒ…è°ƒè¯•</h3><p>å¦å¤–ä¸€ç§å°±æ˜¯æ‰“åŒ…è°ƒè¯•ï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œé¦–å…ˆæˆ‘ä»¬è¦è®²bundleåŠ è½½æ–¹å¼æ”¹ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[[NSBundle mainBundle] URLForResource:@&quot;bundle/index.ios&quot; withExtension:@&quot;jsbundle&quot;];</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ç»ˆç«¯é‡Œé¢ï¼Œè¾“å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yzydeMacBook-Pro:shangjiaban-ios yzy$ react-native bundle --entry-file index.ios.js --platform ios --dev false --bundle-output ./xxx/bundle/index.ios.jsbundle --assets-dest ./xxx/bundle</div></pre></td></tr></table></figure>
<p><code>--bundle-output ./xxx/bundle/index.ios.jsbundle</code>æŒ‡çš„æ˜¯è¾“å‡ºçš„bundleæ–‡ä»¶è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[20:54:43] &lt;START&gt; Building Dependency Graph</div><div class="line">[20:54:43] &lt;START&gt; Crawling File System</div><div class="line">[20:54:43] &lt;START&gt; find dependencies</div><div class="line">[20:54:48] &lt;END&gt;   Crawling File System (4712ms)</div><div class="line">[20:54:48] &lt;START&gt; Building in-memory fs for JavaScript</div><div class="line">[20:54:48] &lt;END&gt;   Building in-memory fs for JavaScript (230ms)</div><div class="line">[20:54:48] &lt;START&gt; Building in-memory fs for Assets</div><div class="line">[20:54:48] &lt;END&gt;   Building in-memory fs for Assets (154ms)</div><div class="line">[20:54:48] &lt;START&gt; Building Haste Map</div><div class="line">[20:54:48] &lt;START&gt; Building (deprecated) Asset Map</div><div class="line">[20:54:48] &lt;END&gt;   Building (deprecated) Asset Map (66ms)</div><div class="line">[20:54:48] &lt;END&gt;   Building Haste Map (154ms)</div><div class="line">[20:54:48] &lt;END&gt;   Building Dependency Graph (5261ms)</div><div class="line">transformed 372/372 (100%)</div><div class="line">[20:54:49] &lt;END&gt;   find dependencies (6402ms)</div><div class="line">bundle: start</div><div class="line">bundle: finish</div><div class="line">bundle: Writing bundle output to: ./Koudaitong/bundle/index.ios.jsbundle</div><div class="line">bundle: Copying 5 asset files</div><div class="line">bundle: Done writing bundle output</div><div class="line">bundle: Done copying assets</div></pre></td></tr></table></figure>
<p>å½“çœ‹åˆ°è¿™æ ·çš„ä¿¡æ¯çš„æ—¶å€™ï¼Œè¯´æ˜å·²ç»æ‰“åŒ…æˆåŠŸäº†ï¼Œå†å°†ç”Ÿæˆçš„bundleæ–‡ä»¶å¤¹ä»¥<code>Create folder references</code>å½¢å¼åŠ åˆ°å·¥ç¨‹é‡Œï¼Œç„¶åå°±å¯ä»¥runäº†</p>
<p>Tip:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">åœ¨çœŸæœºè°ƒè¯•æ—¶ï¼Œéœ€è¦åœ¨Edit Schemeé‡Œåœ¨Runæ¨¡å¼é‡Œï¼Œå°†Build Configurationæ”¹ä¸ºReleaseæ¨¡å¼</div></pre></td></tr></table></figure>
<h2 id="0x05__u8FDC_u7A0B_u70ED_u66F4_u65B0"><a href="#0x05__u8FDC_u7A0B_u70ED_u66F4_u65B0" class="headerlink" title="0x05 è¿œç¨‹çƒ­æ›´æ–°"></a>0x05 è¿œç¨‹çƒ­æ›´æ–°</h2><p>è¿™å—ç½‘ä¸Šçš„æ–¹æ¡ˆå¤§åŒå°å¼‚ï¼Œå› ä¸ºç›®å‰æˆ‘ä»¬è¿˜æ˜¯é‡‡å–æœ¬åœ°æ‰“åŒ…åŠ è½½çš„æ–¹å¼ï¼Œè¿˜æœªä¸Šçƒ­æ›´æ–°ï¼Œæ‰€ä»¥åœ¨è¿™ä¸å¥½å¤šåšè¯´æ˜ï¼Œç­‰ä¸Šäº†çƒ­æ›´æ–°ä¹‹åï¼Œæˆ‘å†æ¥è¡¥å……~</p>
<p>2016å¹´11æœˆ23æ—¥æ›´æ–°ï¼š</p>
<p>Tipsï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">è¯¥çƒ­æ›´æ–°æ–¹æ³•å–è‡ªäºæœ‰èµæŠ€æœ¯å›¢é˜Ÿå®˜æ–¹åšå®¢é‡Œã€ŠReact Nativeæœ‰èµåˆæ¢ã€‹ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ä»¬æŠ€æœ¯å›¢é˜Ÿçš„åšå®¢~</div></pre></td></tr></table></figure>
<h3 id="u9009_u578B"><a href="#u9009_u578B" class="headerlink" title="é€‰å‹"></a>é€‰å‹</h3><p>ç»è¿‡è°ƒç ”å’Œé€‰å‹ï¼Œæœ€ç»ˆé€‰æ‹©äº†å¾®è½¯å‡ºå“çš„ <code>CodePush</code> ä½œä¸º <code>React Native</code> çƒ­éƒ¨ç½²æ–¹æ¡ˆã€‚</p>
<p><code>CodePush</code> æ˜¯æä¾›ç»™ <code>React Native</code> å¼€å‘è€…ç›´æ¥éƒ¨ç½²ç§»åŠ¨åº”ç”¨æ›´æ–°ç»™ç”¨æˆ·è®¾å¤‡çš„äº‘æœåŠ¡ã€‚<code>CodePush</code> ä½œä¸ºä¸€ä¸ªä¸­å¤®ä»“åº“ï¼Œå¼€å‘è€…å¯ä»¥æ¨é€æ›´æ–° (JS, HTML, CSS and images)ï¼Œåº”ç”¨å¯ä»¥ä»å®¢æˆ·ç«¯ <code>SDK</code> é‡Œé¢æŸ¥è¯¢æ›´æ–°ã€‚<code>CodePush</code> å¯ä»¥è®©åº”ç”¨æœ‰æ›´å¤šçš„å¯ç¡®å®šæ€§ï¼Œä¹Ÿå¯ä»¥è®©ä½ ç›´æ¥æ¥è§¦ç”¨æˆ·ç¾¤ã€‚åœ¨ä¿®å¤ä¸€äº›å°é—®é¢˜å’Œæ·»åŠ æ–°ç‰¹æ€§çš„æ—¶å€™ï¼Œä¸éœ€è¦ç»è¿‡äºŒè¿›åˆ¶æ‰“åŒ…ï¼Œå¯ä»¥ç›´æ¥æ¨é€ä»£ç è¿›è¡Œå®æ—¶æ›´æ–°ã€‚</p>
<p><code>CodePush</code> å¯ä»¥è¿›è¡Œå®æ—¶çš„æ¨é€ä»£ç æ›´æ–°ï¼š</p>
<ul>
<li>ç›´æ¥å¯¹ç”¨æˆ·éƒ¨ç½²ä»£ç æ›´æ–°</li>
<li>ç®¡ç† <code>Alpha</code> ï¼Œ <code>Beta</code> å’Œç”Ÿäº§ç¯å¢ƒåº”ç”¨</li>
<li>æ”¯æŒ <code>JavaScript</code> æ–‡ä»¶ä¸å›¾ç‰‡èµ„æºçš„æ›´æ–°</li>
<li>æš‚ä¸æ”¯æŒå¢é‡æ›´æ–°</li>
</ul>
<p><code>CodePush</code> å¼€æºäº† <code>react-native</code> ç‰ˆæœ¬ï¼Œ<a href="https://github.com/Microsoft/react-native-code-push" target="_blank" rel="external">react-native-code-push</a>æ‰˜ç®¡åœ¨GitHubä¸Šã€‚</p>
<p>å…·ä½“çš„æ•™ç¨‹å’Œç”¨æ³•å¾®è½¯éƒ½åœ¨ <code>Githubä¸Š</code> åšäº†è¯¦ç»†è¯´æ˜ï¼Œæ¥ä¸‹æ¥ç®€å•åœ°æ¢³ç†ä¸€ä¸‹ä»é…ç½®ã€ç¼–ç ã€éƒ¨ç½²ç­‰å…·ä½“æµç¨‹ã€‚</p>
<p>(1) å®‰è£… <code>CodePush CLI</code></p>
<p>ç®¡ç† <code>CodePush</code> è´¦å·éœ€è¦é€šè¿‡ <code>NodeJS-based CLI</code>ã€‚ åªéœ€è¦åœ¨ç»ˆç«¯è¾“å…¥ <code>npm install -g code-push-cli</code> ï¼Œå°±å¯ä»¥å®‰è£…äº†ã€‚ å®‰è£…å®Œæ¯•åï¼Œè¾“å…¥ <code>code-push -v</code> æŸ¥çœ‹ç‰ˆæœ¬ï¼Œå¦‚çœ‹åˆ°ç‰ˆæœ¬ä»£è¡¨æˆåŠŸã€‚</p>
<p>(2) åˆ›å»ºä¸€ä¸ª <code>CodePush</code> è´¦å· åœ¨ç»ˆç«¯è¾“å…¥ <code>code-push register</code> ï¼Œä¼šæ‰“å¼€å¦‚ä¸‹æ³¨å†Œé¡µé¢è®©ä½ é€‰æ‹©æˆæƒè´¦å·ã€‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/codepush.png" alt=""></p>
<p>æˆæƒé€šè¿‡ä¹‹åï¼Œ<code>CodePush</code> ä¼šå‘Šè¯‰ä½ â€œaccess keyâ€ï¼Œå¤åˆ¶æ­¤keyåˆ°ç»ˆç«¯å³å¯å®Œæˆæ³¨å†Œã€‚</p>
<p>ç„¶åç»ˆç«¯è¾“å…¥ <code>code-push login</code> è¿›è¡Œç™»é™†ï¼Œç™»é™†æˆåŠŸåï¼Œä½ çš„sessionæ–‡ä»¶å°†ä¼šå†™åœ¨ /Users/ä½ çš„ç”¨æˆ·å <code>/.code-push.config</code>ã€‚</p>
<p>(3) åœ¨CodePushæœåŠ¡å™¨æ³¨å†Œapp ä¸ºäº†è®© <code>CodePush</code> æœåŠ¡å™¨çŸ¥é“ä½ çš„appï¼Œæˆ‘ä»¬éœ€è¦å‘å®ƒæ³¨å†Œappï¼š åœ¨ç»ˆç«¯è¾“å…¥ <code>code-push app add</code> å³å¯å®Œæˆæ³¨å†Œã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push app add shangjiaban-android</div></pre></td></tr></table></figure>
<blockquote>
<p>å¦‚æœæ˜¯iOSå¹³å°ï¼Œå‘½ä»¤ä¸º <code>code-push app add shangjiaban-ios</code> ï¼Œ <code>Android</code> å’Œ <code>iOS</code> å¿…é¡»è¦åŒºåˆ†</p>
</blockquote>
<p>è¿˜æœ‰å¾ˆå¤š <code>code-push app</code> ç›¸å…³çš„å‘½ä»¤ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$: code-push app help</div><div class="line">Usage: code-push app &lt;command&gt;</div><div class="line"></div><div class="line">å‘½ä»¤ï¼š</div><div class="line">  add       Add a new app to your account</div><div class="line">  remove    Remove an app from your account</div><div class="line">  rm        Remove an app from your account</div><div class="line">  rename    Rename an existing app</div><div class="line">  list      Lists the apps associated with your account</div><div class="line">  ls        Lists the apps associated with your account</div><div class="line">  transfer  Transfer the ownership of an app to another account</div></pre></td></tr></table></figure>
<h3 id="iOS_u914D_u7F6E"><a href="#iOS_u914D_u7F6E" class="headerlink" title="iOSé…ç½®"></a>iOSé…ç½®</h3><p>iOSå¹³å°ä¸Šå…³äº <code>CodePush</code> çš„é…ç½®å’Œ <code>Android</code> å¹³å°æ˜¯ç±»ä¼¼çš„ï¼Œå¯ä»¥å‚è€ƒä¸Šæ–‡çš„(1)(2)(3)ï¼ŒiOSå¹³å°é›†æˆ <code>CodePush</code> æ¯”è¾ƒç®€å•ï¼Œå®˜ç½‘æä¾›äº†3ç§é›†æˆæ–¹å¼ï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»å¦‚ä½•é€šè¿‡ <code>cocoapods</code> æ¥é›†æˆã€‚</p>
<p>(1) å¼•å…¥ <code>CodePush</code></p>
<p>é¦–å…ˆåœ¨Podfileæ–‡ä»¶ä¸­æ·»åŠ  <code>CodePush</code>ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod &apos;CodePush&apos;, :path =&gt; &apos;./node_modules/react-native-code-push&apos;</div></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œ <code>pod install</code> å°±å¯ä»¥äº†ã€‚</p>
<p>(2) å£°æ˜ <code>bundle</code> æ–‡ä»¶æ¥æº</p>
<p>å¼•å…¥ <code>CodePush</code> åè¿˜éœ€è¦åœ¨ä»£ç ä¸­å£°æ˜ <code>bundle</code> çš„åŠ è½½æ¥æºï¼Œä¹‹å‰æ˜¯åŠ è½½æœ¬åœ°çš„<code>bundle</code>æ–‡ä»¶ï¼Œç°åœ¨éœ€è¦è°ƒç”¨ <code>CodePush</code> æä¾›çš„æ–¹æ³•æŒ‡å®šåŠ è½½ <code>Bundle</code> æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#import &quot;CodePush.h&quot;</div><div class="line">...</div><div class="line">// åŸæ¥çš„bundleåŠ è½½æ–¹æ³•</div><div class="line">jsCodeLocation = [[NSBundle mainBundle] URLForResource:@&quot;main&quot; withExtension:@&quot;jsbundle&quot;];</div><div class="line"></div><div class="line">// CodePushçš„bundleåŠ è½½æ–¹æ³•ï¼Œè¿™é‡Œçš„bundleURLé»˜è®¤åŠ è½½çš„æ˜¯main.jsbundleï¼Œ</div><div class="line">// å¦‚æœä½ çš„åç§°ä¸ä¸€æ ·ï¼Œéœ€è¦è°ƒç”¨CodePushæä¾›çš„å…¶ä»–æ–¹æ³•æ¥è‡ªå®šä¹‰ã€‚</div><div class="line">jsCodeLocation = [CodePush bundleURL];</div></pre></td></tr></table></figure>
<p>æœ€åè¿˜éœ€è¦åœ¨ <code>Info.plist</code> ä¸­æ·»åŠ ä¸€ä¸ª <code>key</code> ä¸º <code>CodePushDeploymentKey</code> ,å…¶<code>value</code> å°±æ˜¯ <code>CodePush</code> æä¾›çš„å”¯ä¸€ <code>token</code> å€¼ã€‚å…·ä½“è·å–æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å¾—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push deployment ls &lt;appName&gt; -k</div></pre></td></tr></table></figure>
<h3 id="RN_u914D_u7F6E"><a href="#RN_u914D_u7F6E" class="headerlink" title="RNé…ç½®"></a>RNé…ç½®</h3><p>ä¸ºäº†è¾¾åˆ°æ›´å¥½çš„ä½“éªŒæ•ˆæœï¼Œæˆ‘ä»¬å†³å®šé‡‡ç”¨é™é»˜å‡çº§çš„ç­–ç•¥ï¼Œè®©ç”¨æˆ·æ— æ„ŸçŸ¥åœ°ä½“éªŒçƒ­æ›´æ–°ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“çš„å‡çº§æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/updateStrategy.png!500x500" alt=""></p>
<p>å¦‚æœè¦è¾¾æˆä¸Šè¿°çƒ­éƒ¨ç½²æ•ˆæœï¼Œé‚£ä¹ˆè¿˜éœ€è¦åœ¨ <code>JavaScript</code> æ–‡ä»¶ä¸­å®Œæˆæ›´æ–°æ—¶æœºå’Œæ›´æ–°ç­–ç•¥çš„è®¾ç½®ã€‚</p>
<p>(1)åœ¨jsä¸­å¯¼å…¥ <code>CodePush</code> æ¨¡å—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import codePush from &apos;react-native-code-push&apos;</div></pre></td></tr></table></figure>
<p>(2)åœ¨ <code>componentDidMount</code> ä¸­è°ƒç”¨ <code>sync</code> æ–¹æ³•ï¼Œåå°è¯·æ±‚æ›´æ–°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">codePush.sync()</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯éå¼ºåˆ¶å¹¶å…è®¸æ›´æ–°ï¼Œ <code>CodePush</code> ä¼šåœ¨åå°é™é»˜åœ°å°†æ›´æ–°ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç­‰å¾…APPå†ä¸€æ¬¡å¯åŠ¨æˆ–è€…åŠ è½½ <code>React Native</code> é¡µé¢çš„æ—¶å€™æ›´æ–°åº”ç”¨ã€‚</p>
<p>å¦‚æœæ›´æ–°æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œæ›´æ–°æ–‡ä»¶ä¸‹è½½å¥½ä¹‹åä¼šç«‹å³è¿›è¡Œæ›´æ–°ã€‚å…³äºå¦‚ä½•é…ç½®æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼Œä¼šåœ¨ä¸‹æ–‡å‘å¸ƒæ›´æ–°å¤„é‡ç‚¹è¯´æ˜ã€‚</p>
<p>å¦‚æœä½ æœŸæœ›æ›´åŠæ—¶çš„è·å¾—æ›´æ–°ï¼Œå¯ä»¥åœ¨æ¯æ¬¡APPä»åå°è¿›å…¥å‰å°çš„æ—¶å€™å»ä¸»åŠ¨çš„æ£€æŸ¥æ›´æ–°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AppState.addEventListener(&quot;change&quot;, (newState) =&gt; &#123;  </div><div class="line">        newState === &quot;active&quot; &amp;&amp; codePush.sync(&#123;</div><div class="line">            installMode:codePush.InstallMode.ON_NEXT_RESUME,</div><div class="line">            deploymentKey: DEPLOYMENT_KEY,</div><div class="line">          &#125;);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°æµç¨‹å›¾æåŠçš„ä¸‰ç§æ›´æ–°æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡ <code>installMode</code> å‚æ•°æ§åˆ¶çš„ï¼Œå–å€¼æ–¹å¼åˆ†åˆ«ä¸ºï¼š</p>
<ol>
<li><code>codePush.InstallMode.ON_NEXT_RESTART</code>å³ä¸‹ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™å®‰è£…æ›´æ–°</li>
<li><code>codePush.InstallMode.ON_NEXT_RESUME</code>å³ä¸‹ä¸€æ¬¡åˆ‡åå°åˆ‡æ¢çš„æ—¶å€™å®‰è£…æ›´æ–°</li>
<li><code>codePush.InstallMode. IMMEDIATE</code>ç«‹å³ä¸‹è½½å®‰è£…æ›´æ–°</li>
</ol>
<blockquote>
<p>å¦‚æœå‘å¸ƒæ›´æ–°æ—¶ <code>mandatory</code> å‚æ•°ä¸ºtrueï¼Œå³å¼ºåˆ¶æ›´æ–°ï¼Œåˆ™ä¸Šè¿°è®¾ç½®éƒ½ä¼šæ— æ•ˆï¼Œåªæœ‰<code>mandatory</code> å‚æ•°ä¸ºfasleæ—¶ï¼Œè®¾ç½®æ‰ä¼šæœ‰æ•ˆã€‚</p>
</blockquote>
<h3 id="u6253_u5305_u5E76_u53D1_u5E03"><a href="#u6253_u5305_u5E76_u53D1_u5E03" class="headerlink" title="æ‰“åŒ…å¹¶å‘å¸ƒ"></a>æ‰“åŒ…å¹¶å‘å¸ƒ</h3><p>(1) æ‰“åŒ…js å‘å¸ƒæ›´æ–°ä¹‹å‰ï¼Œéœ€è¦å…ˆæŠŠjsæ‰“åŒ…æˆ <code>bundle</code> ï¼Œä»¥ä¸‹æ˜¯Androidçš„åšæ³•ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼š åœ¨ <code>Android</code> å·¥ç¨‹ç›®å½•é‡Œé¢æ–°å¢ <code>release</code> æ–‡ä»¶ï¼š <code>mkdir release</code> ï¼Œå¯¹äºiOSæ¥è¯´ï¼Œç›®å‰ <code>bundle</code> æ–‡ä»¶ç›´æ¥æ”¾åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æ— éœ€è¿™ä¸€æ­¥ã€‚ ç¬¬äºŒæ­¥ï¼š è¿è¡Œå‘½ä»¤æ‰“åŒ…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native bundle --platform å¹³å° --entry-file å¯åŠ¨æ–‡ä»¶ --bundle-output æ‰“åŒ…jsè¾“å‡ºæ–‡ä»¶ --assets-dest èµ„æºè¾“å‡ºç›®å½• --dev æ˜¯å¦è°ƒè¯•ã€‚</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚:</p>
<p>Android</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native bundle --platform android --entry-file index.android.js --bundle-output ./release/index.android.bundle --assets-dest ./release --dev false</div></pre></td></tr></table></figure>
<p>iOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native bundle --platform ios --entry-file index.ios.js --bundle-output ./Koudaitong/main.jsbundle --assets-dest ./Koudaitong --dev false</div></pre></td></tr></table></figure>
<p>(2) å‘å¸ƒæ›´æ–°</p>
<p>æ‰“åŒ… <code>bundle</code> ç»“æŸåï¼Œå°±å¯ä»¥é€šè¿‡ <code>CodePush</code> å‘å¸ƒæ›´æ–°äº†ã€‚åœ¨ç»ˆç«¯è¾“å…¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">code-push release &lt;åº”ç”¨åç§°&gt; &lt;Bundlesæ‰€åœ¨ç›®å½•&gt; &lt;å¯¹åº”çš„åº”ç”¨ç‰ˆæœ¬&gt; --deploymentNameï¼š æ›´æ–°ç¯å¢ƒ  </div><div class="line">--descriptionï¼š æ›´æ–°æè¿° --mandatoryï¼š æ˜¯å¦å¼ºåˆ¶æ›´æ–°</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<p>Android</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push release shangjiaban-android ./release 3.12.1 --description &quot;update React Native&quot; --mandatory true</div></pre></td></tr></table></figure>
<p>iOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">code-push release shangjiaban-ios ./Koudaitong/main.jsbundle 3.12.0 --description &quot;update React Native&quot; --mandatory false</div></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼š</p>
</blockquote>
<ol>
<li><code>CodePush</code> é»˜è®¤æ˜¯æ›´æ–° <code>Staging</code> ç¯å¢ƒçš„ï¼Œå¦‚æœæ˜¯ <code>Staging</code> ï¼Œåˆ™ä¸éœ€è¦å¡«å†™<code>deploymentName</code>ã€‚</li>
<li>å¦‚æœæœ‰ <code>mandatory</code> åˆ™ <code>Code Push</code> ä¼šæ ¹æ® <code>mandatory</code> æ˜¯ <code>true</code> æˆ–<code>false</code> æ¥æ§åˆ¶åº”ç”¨æ˜¯å¦å¼ºåˆ¶æ›´æ–°ã€‚é»˜è®¤æƒ…å†µä¸‹ <code>mandatory</code> ä¸º <code>false</code> å³ä¸å¼ºåˆ¶æ›´æ–°ã€‚</li>
<li>å¯¹åº”çš„åº”ç”¨ç‰ˆæœ¬ <code>targetBinaryVersion</code> æ˜¯æŒ‡å½“å‰appçš„ç‰ˆæœ¬(å¯¹åº” <code>build.gradle</code> ä¸­è®¾ç½®çš„versionName â€œ3.12.1â€)ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ¬¡æ›´æ–°çš„ <code>js/images</code> å¯¹åº”çš„æ˜¯appçš„é‚£ä¸ªç‰ˆæœ¬ã€‚ä¸è¦å°†å…¶ç†è§£ä¸ºè¿™æ¬¡jsæ›´æ–°çš„ç‰ˆæœ¬ã€‚ å¦‚å®¢æˆ·ç«¯ç‰ˆæœ¬æ˜¯3.12.1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹3.12.1çš„å®¢æˆ·ç«¯æ›´æ–° <code>js/images</code> ï¼Œ <code>targetBinaryVersion</code> å¡«çš„å°±æ˜¯3.12.1ã€‚</li>
<li>å¯¹äºå¯¹æŸä¸ªåº”ç”¨ç‰ˆæœ¬è¿›è¡Œå¤šæ¬¡æ›´æ–°çš„æƒ…å†µï¼Œ <code>CodePush</code> ä¼šæ£€æŸ¥æ¯æ¬¡ä¸Šä¼ çš„ <code>bundle</code> ï¼Œå¦‚æœåœ¨è¯¥ç‰ˆæœ¬ä¸‹å¦‚3.12.1å·²ç»å­˜åœ¨ä¸è¿™æ¬¡ä¸Šä¼ å®Œå…¨ä¸€æ ·çš„ <code>bundle</code> (å¯¹åº”ä¸€ä¸ªç‰ˆæœ¬æœ‰ä¸¤ä¸ª <code>bundle</code> çš„ <code>md5</code> å®Œå…¨ä¸€æ ·)ï¼Œé‚£ä¹ˆ <code>CodePush</code> ä¼šæ‹’ç»æ­¤æ¬¡æ›´æ–°ã€‚</li>
</ol>
<h2 id="0x06_iOS_u548CAndroid_u4E0D_u540C_u6837_u5F0F_u5904_u7406"><a href="#0x06_iOS_u548CAndroid_u4E0D_u540C_u6837_u5F0F_u5904_u7406" class="headerlink" title="0x06 iOSå’ŒAndroidä¸åŒæ ·å¼å¤„ç†"></a>0x06 iOSå’ŒAndroidä¸åŒæ ·å¼å¤„ç†</h2><p>æœ€è¿‘çœ‹åˆ°FBçš„F8ä»£ç é‡Œé¢å¯¹äºiOSå’ŒAndroidä¸åŒå¹³å°ä¸Šæ ·å¼çš„å¤„ç†è§‰å¾—æŒºä¸é”™çš„ï¼Œç”±äºç³»ç»ŸåŸç”Ÿæ§ä»¶æ ·å¼è®¾è®¡é£æ ¼çš„ä¸ä¸€æ ·ï¼Œå¯¼è‡´åœ¨å†™stylesçš„æ—¶å€™ä¼šæ ¹æ®ä¸åŒçš„platformæ¥å†™ï¼Œä¹‹å‰åšæ³•æ˜¯å®šä¹‰ä¸åŒçš„stylesï¼Œç„¶ååˆ¤æ–­platformå»ç”¨ï¼Œè¿™æ ·stylesé‡Œé¢çš„ä»£ç ä¼šå­˜åœ¨å†—ä½™ï¼Œè€Œä¸”å¯¹stylesçš„å®šä¹‰ä¹Ÿä¸å¥½</p>
<p>FBçš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ªstylesçš„åŸºç±»ï¼Œç„¶ååŸºç±»é‡Œè§£æå¹³å°ä¿¡æ¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">styles: Object</span>): </span>&#123;[name: string]: number&#125; &#123;</div><div class="line">  <span class="keyword">const</span> platformStyles = &#123;&#125;;</div><div class="line">  <span class="built_in">Object</span>.keys(styles).forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> &#123;ios, android, ...style&#125; = &#123;...styles[name]&#125;;</div><div class="line">    <span class="keyword">if</span> (ios &amp;&amp; Platform.OS === <span class="string">'ios'</span>) &#123;</div><div class="line">      style = &#123;...style, ...ios&#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (android &amp;&amp; Platform.OS === <span class="string">'android'</span>) &#123;</div><div class="line">      style = &#123;...style, ...android&#125;;</div><div class="line">    &#125;</div><div class="line">    platformStyles[name] = style;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> StyleSheet.create(platformStyles);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è§£æå®Œä¹‹åï¼Œåœ¨stylesé‡Œé¢ï¼Œä¼šæ ¹æ®ä¸åŒçš„platformå–ä¸åŒçš„æ ·å¼</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">button: &#123;</div><div class="line">    <span class="attr">borderColor</span>: <span class="string">'transparent'</span>,</div><div class="line">    <span class="attr">alignItems</span>: <span class="string">'center'</span>,</div><div class="line">    <span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">    <span class="attr">backgroundColor</span>: <span class="string">'transparent'</span>,</div><div class="line">    <span class="attr">ios</span>: &#123;</div><div class="line">      <span class="attr">height</span>: HEIGHT,</div><div class="line">      <span class="attr">paddingHorizontal</span>: <span class="number">20</span>,</div><div class="line">      <span class="attr">borderRadius</span>: HEIGHT / <span class="number">2</span>,</div><div class="line">      <span class="attr">borderWidth</span>: <span class="number">1</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">android</span>: &#123;</div><div class="line">      <span class="attr">paddingBottom</span>: <span class="number">6</span>,</div><div class="line">      <span class="attr">paddingHorizontal</span>: <span class="number">10</span>,</div><div class="line">      <span class="attr">borderBottomWidth</span>: <span class="number">3</span>,</div><div class="line">      <span class="attr">marginRight</span>: <span class="number">10</span>,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<h2 id="0x07__u8E29_u5751_u8BB0_u5F55"><a href="#0x07__u8E29_u5751_u8BB0_u5F55" class="headerlink" title="0x07 è¸©å‘è®°å½•"></a>0x07 è¸©å‘è®°å½•</h2><p>è¸©å‘æœ€å¤šæ˜¯åº”è¯¥æ˜¯ä½¿ç”¨ä¸Šçš„</p>
<p>1.RNç³»ç»Ÿçš„ç»„ä»¶å¹¶ä¸æ˜¯æ‰€æœ‰éƒ½æ˜¯å…±ç”¨çš„ï¼Œæ¯”å¦‚segmentæ”¯æŒiOSï¼Œä¸æ”¯æŒAndroidï¼ŒAlertåˆ†ä¸ºiOSå’ŒAndroidç­‰ç­‰ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦å†™é‡å¤çš„ä»£ç </p>
<p>2.ListViewä¸æ”¯æŒiOSåŸç”Ÿçš„æ»‘åŠ¨æ“ä½œï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œä½†æ˜¯ç¬¬ä¸‰æ–¹åº“ä¸èƒ½æ§åˆ¶åªç¼–è¾‘ä¸€ä¸ªCell</p>
<p>3.ç”±äºåŸå…ˆiOSå’ŒAndroidçš„ä»£ç ä»“åº“æ˜¯åˆ†å¼€çš„ï¼Œæ‰€ä»¥æ¥å…¥RNæ—¶ï¼ŒJSæ–‡ä»¶ä¹Ÿæ˜¯è·Ÿç€ä»“åº“èµ°çš„ï¼Œè¿™æ ·iOSå’ŒAndroidä¼šå­˜åœ¨é‡å¤ä»£ç ï¼Œå¹¶ä¸”ç›®å‰ä¸¤ä¸ªäººåˆ†åˆ«æ¥iOSå’ŒAndroidï¼Œå†™JSæ—¶ï¼Œæœ‰æ—¶å¹¶ä¸å…±äº«ï¼Œå®¹æ˜“ä»£ç å†™ç€å†™ç€å°±æœ‰å·®å¼‚äº†ï¼Œåç¦»äº†Write Once , Run Anywhereçš„åˆè¡·</p>
<h2 id="0x08__u76F8_u5173_u8D44_u6599"><a href="#0x08__u76F8_u5173_u8D44_u6599" class="headerlink" title="0x08 ç›¸å…³èµ„æ–™"></a>0x08 ç›¸å…³èµ„æ–™</h2><p><a href="https://facebook.github.io/react-native/" target="_blank" rel="external">React Native</a></p>
<p><a href="http://reactnative.cn/" target="_blank" rel="external">React Native ä¸­æ–‡ç½‘</a></p>
<p><a href="https://github.com/reactnativecn/react-native-guide" target="_blank" rel="external">æ±‡é›†äº†å„ç±»react-nativeå­¦ä¹ èµ„æºã€å¼€æºAppå’Œç»„ä»¶</a></p>
<p><a href="http://blog.talisk.cn/blog/2016/08/13/RN-Learning-path-for-iOS-developer/" target="_blank" rel="external">å†™ç»™ iOS å¼€å‘è€…çš„ React Native å­¦ä¹ è·¯çº¿</a></p>
<p><a href="http://www.lcode.org/" target="_blank" rel="external">æ±Ÿæ¸…æ¸…çš„æŠ€æœ¯ä¸“æ </a></p>
<p><a href="http://bbs.reactnative.cn/topic/15/react-react-native-%E7%9A%84es5-es6%E5%86%99%E6%B3%95%E5%AF%B9%E7%85%A7%E8%A1%A8" target="_blank" rel="external">React/React Native çš„ES5 ES6å†™æ³•å¯¹ç…§è¡¨</a></p>
<p><a href="http://tech.youzan.com/react-native-zan/" target="_blank" rel="external">React Nativeæœ‰èµåˆæ¢</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å†™ä¸œè¥¿äº†ï¼Œå› ä¸ºæœ€è¿‘é¡¹ç›®å¼€å§‹å°è¯•ä½¿ç”¨React Nativeï¼ˆä»¥ä¸‹ç®€ç§°RNï¼‰æ¥å¼€å‘ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨ç ”ç©¶ï¼Œç›®å‰ä¸ºæ­¢å¼€å‘çš„å†…å®¹ä¸å¤šï¼Œæ‰€ä»¥ä½¿ç”¨è¿‡çš„ä¸œè¥¿ä¹Ÿä¸ç®—å¤šï¼Œè¿™é‡Œä¹Ÿåªæ˜¯åšä¸ªç®€å•çš„è®°å½•&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæˆ‘æ‰“ç®—ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è®²ï¼š&lt;/p&gt;
&lt;p&gt;1.èƒŒæ™¯ä»‹ç»&lt;/p&gt;
&lt;p&gt;2.ç¯å¢ƒçš„é…ç½®&lt;/p&gt;
&lt;p&gt;3.RNæ‰€éœ€è¦çŸ¥é“çš„çŸ¥è¯†&lt;/p&gt;
&lt;p&gt;4.RNä¸åŸç”Ÿçš„äº¤äº’&lt;/p&gt;
&lt;p&gt;5.æœ¬åœ°è°ƒè¯•ä¸æœ¬åœ°æ‰“åŒ…è°ƒè¯•&lt;/p&gt;
&lt;p&gt;6.è¿œç¨‹çƒ­æ›´æ–°&lt;/p&gt;
&lt;p&gt;7.iOSå’ŒAndroidä¸åŒæ ·å¼å¤„ç†&lt;/p&gt;
&lt;p&gt;8.è¸©å‘è®°å½•&lt;/p&gt;
&lt;p&gt;9.ç›¸å…³èµ„æ–™&lt;/p&gt;
    
    </summary>
    
    
      <category term="React Native" scheme="http://yuzeyang.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>iOS æŠ½å±‰å¼æ•ˆæœåˆ—è¡¨</title>
    <link href="http://yuzeyang.github.io/2016/09/08/iOS-Drawer-Table-View/"/>
    <id>http://yuzeyang.github.io/2016/09/08/iOS-Drawer-Table-View/</id>
    <published>2016-09-08T14:16:43.000Z</published>
    <updated>2016-09-12T11:40:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰å¾ˆå–œæ¬¢æ”¶è—<a href="https://dribbble.com/shots" target="_blank" rel="external">dribbble</a>é‡Œé¢çš„ä¸€äº›åŠ¨æ•ˆgifï¼Œé‡Œé¢ä¸ä»…æ˜¯åŠ¨æ•ˆè¿˜æ˜¯é…è‰²ç­‰ç­‰éƒ½éå¸¸çš„ç¾ï¼Œä½œä¸ºä¸€ä¸ªè§†è§‰åŠ¨ç‰©ï¼ŒçœŸçš„æƒ³æŠŠä»–ä»¬ä¸€ä¸ªä¸€ä¸ªéƒ½å®ç°å‡ºæ¥ï¼Œä½œä¸ºè‡ªå·±çš„ä¸€ä¸ªä½œå“ï¼Œé‚£çœŸçš„æ˜¯ä¸€ä»¶èµå¿ƒæ‚¦ç›®çš„äº‹æƒ…ï¼Œçœ‹ç€G20ä¹Ÿå¿«ç»“æŸäº†ï¼Œèµ¶ç´§è¶è¿˜é—²ç€ï¼Œå…ˆå®ç°ä¸€ä¸ªï¼Œæˆ‘å…ˆæŒ‘é€‰äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åŠ¨æ•ˆâ€”â€“<strong>æŠ½å±‰å¼æ•ˆæœåˆ—è¡¨</strong></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ•ˆæœ:</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/GCDrawerTableView.gif!500x500" alt=""></p>
<a id="more"></a>
<p>åŸæ¥çš„åŠ¨æ•ˆåœ°å€æ‰¾ä¸åˆ°äº†â€¦æœ‰çŸ¥é“çš„è¯·ç•™è¨€ç»™æˆ‘â€¦</p>
<p>ä»£ç åœ°å€ï¼š<a href="https://github.com/Yuzeyang/GCDrawerTableView" target="_blank" rel="external">https://github.com/Yuzeyang/GCDrawerTableView</a></p>
<p>è€æ ·å­ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹æ­¥éª¤</p>
<h2 id="0x00_cell_u7684_u5904_u7406"><a href="#0x00_cell_u7684_u5904_u7406" class="headerlink" title="0x00 cellçš„å¤„ç†"></a>0x00 cellçš„å¤„ç†</h2><p>æˆ‘ä»¬å°†<code>cell</code>å’Œ<code>è¯¦æƒ…ç•Œé¢</code>åˆ†å¼€æ¥å¤„ç†</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬é€‰ä¸­å…¶ä¸­ä¸€ä¸ª<code>cell</code>çš„æ—¶å€™ï¼Œè¯¥<code>cell</code>ä¼šç§»åŠ¨åˆ°åˆ—è¡¨ä¸Šæ–¹çš„æŸä¸€ä¸ªä½ç½®ï¼Œå…¶ä»–<code>cell</code>åˆ™ä¸æ˜¾ç¤ºï¼Œç‚¹å‡»<code>x</code>çš„æ—¶å€™ï¼Œ<code>cell</code>è¿”å›ä¸ºåŸä½ï¼Œå…¶ä»–<code>cell</code>åˆé‡æ–°æ˜¾ç¤º</p>
<p>é€‰ä¸­å¤„ç†ï¼šé¦–å…ˆæ˜¯å…ˆå°†å…¶ä»–<code>cell</code>éšè—ï¼Œæˆ‘ä»¬å–å‡º<code>tableview</code>çš„å¯è§<code>cell</code>ï¼Œç„¶åå°†é™¤äº†é€‰ä¸­çš„<code>cell</code>ä¹‹å¤–çš„é€æ˜åº¦éƒ½è®¾ç½®ä¸º0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GCTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];</div><div class="line">[self.tableView bringSubviewToFront:cell];</div><div class="line">for (UIView *subcell in tableView.visibleCells) &#123;</div><div class="line">    if (subcell != cell) &#123;</div><div class="line">        subcell.alpha = 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæ”¹å˜é€‰ä¸­<code>cell</code>çš„åŸç‚¹å€¼ï¼Œå¹¶ä¸”ç»™<code>cell</code>å¢åŠ é˜´å½±ï¼Œè¿™é‡Œæˆ‘å·æ‡’æ²¡æœ‰åšæŒ‰é’®çš„åŠ¨ç”»ï¼Œåªæ˜¯ç”¨æ–‡å­—è¡¨ç¤ºäº†æŒ‰é’®çš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">    CGRect rect = self.frame;</div><div class="line">    self.originCellFrame = rect;</div><div class="line">    CGPoint origin = CGPointMake(0, contentOffsetY + 30);</div><div class="line">    rect.origin = origin;</div><div class="line">    self.frame = rect;</div><div class="line"></div><div class="line">    // è¯¦æƒ…é¡µå¤„ç†</div><div class="line"></div><div class="line">    [self addShadowWithView:self];</div><div class="line">    [self addShadowWithView:self.detailView];</div><div class="line">    [self.detailButton setTitle:@&quot;Ã—&quot; forState:UIControlStateNormal];</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>ç”±äºcellçš„åŠ¨ç”»å¤„ç†æ˜¯æ”¾åœ¨è‡ªå®šä¹‰cellé‡Œé¢åšçš„ï¼Œæ‰€ä»¥åœ¨ç‚¹å‡»å…³é—­çš„æ—¶å€™ï¼Œéœ€è¦åœ¨åŠ¨ç”»ç»“æŸä¹‹åå›è°ƒç»™è§†å›¾æ§åˆ¶å™¨ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç”¨äº†blockæ¥å›è°ƒå…³é—­çš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (void)deselectCell &#123;</div><div class="line">    [UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">        self.frame = self.originCellFrame;</div><div class="line">        </div><div class="line">        self.layer.shadowColor = [UIColor clearColor].CGColor;</div><div class="line">        self.layer.shadowRadius = 0;</div><div class="line">        self.layer.shadowOpacity = 0.0;</div><div class="line">        </div><div class="line">        // è¯¦æƒ…é¡µå¤„ç†</div><div class="line">        [self.detailButton setTitle:@&quot;...&quot; forState:UIControlStateNormal];</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        [self.helperHideView removeFromSuperview];</div><div class="line">        [self.detailView removeFromSuperview];</div><div class="line">        if (_deselectBlock) &#123;</div><div class="line">            _deselectBlock();</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨è¯•å›¾æ§åˆ¶å™¨é‡Œé¢ï¼Œå°†å…¶ä»–çš„cellé€æ˜åº¦æ”¹æˆ1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[cell addDeselectBlock:^() &#123;</div><div class="line">    for (UIView *subcell in tableView.visibleCells) &#123;</div><div class="line">        if (subcell != cell) &#123;</div><div class="line">            subcell.alpha = 1;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    tableView.allowsSelection = YES;</div><div class="line">    tableView.scrollEnabled = YES;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h2 id="0x01__u8BE6_u60C5_u9875"><a href="#0x01__u8BE6_u60C5_u9875" class="headerlink" title="0x01 è¯¦æƒ…é¡µ"></a>0x01 è¯¦æƒ…é¡µ</h2><p>å¯ä»¥çœ‹åˆ°<code>è¯¦æƒ…é¡µ</code>æ˜¯ç±»ä¼¼äºä»ä¸Šæ‰è½çš„æ„Ÿè§‰ï¼Œå¯èƒ½ä¼šè”æƒ³åˆ°ç”µå•†çš„é‚£äº›ç­›é€‰æ ï¼Œä½†æ˜¯ç­›é€‰æ ç‚¹å‡»çš„æ—¶å€™ï¼Œæ˜¯ä¸Šéƒ¨åˆ†å¼€å§‹å‡ºç°ä¸€ç›´åˆ°ä¸‹é¢ï¼Œå±•ç¤ºçš„é¡ºåºæ˜¯åè¿‡æ¥çš„ï¼Œåé¢æƒ³äº†å¾ˆä¹…ï¼Œåªèƒ½æƒ³åˆ°åˆ©ç”¨è§†è§‰é”™è¯¯çš„æ•ˆæœï¼Œå°†è¯¦æƒ…é¡µæ·»åŠ åˆ°cellçš„ä¸‹ä¸€å±‚ï¼Œç„¶å<code>cell</code>åŠ¨ç”»æ—¶å€™ï¼Œè¯¦æƒ…é¡µä¹Ÿåšç›¸åº”çš„åŠ¨ç”»ï¼Œä½†æ˜¯ç”±äºè¯¦æƒ…é¡µçš„<code>size</code>æ¯”<code>cell</code>è‚¯å®šæ˜¯è¦å¤§çš„ï¼Œæ‰€ä»¥å¦‚æœåŠ åˆ°<code>cell</code>ä¸‹ä¸€å±‚æ—¶ï¼Œæ˜¯é®æŒ¡ä¸ä½çš„ï¼Œæ‰€ä»¥å°±éœ€è¦ä¸€ä¸ªé®æŒ¡çš„viewæ¥é®ä½è¯¦æƒ…é¡µ</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†<code>cell</code>ç§»åˆ°æœ€å‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.tableView bringSubviewToFront:cell];</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨cellçš„ä¸‹ä¸€å±‚åŠ ä¸Š<code>é®æŒ¡è§†å›¾</code>å’Œ<code>è¯¦æƒ…é¡µ</code>ï¼Œå¹¶æ ¹æ®cellçš„originåšframeçš„å˜åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">UIView *superview = self.superview;</div><div class="line">    </div><div class="line">CGFloat height = CGRectGetMinY(self.frame) - contentOffsetY + 30;</div><div class="line">[self.helperHideView setFrame:CGRectMake(0, contentOffsetY, CGRectGetWidth(self.frame), height)];</div><div class="line">[superview insertSubview:self.helperHideView belowSubview:self];</div><div class="line"></div><div class="line">[self.detailView setFrame:CGRectMake(0, CGRectGetMaxY(self.frame) - (GCDeviceHeight - 100 - 30*2),</div><div class="line">                                     CGRectGetWidth(self.frame), GCDeviceHeight - 100 - 30*2)];</div><div class="line">[superview insertSubview:self.detailView belowSubview:self.helperHideView];</div><div class="line"></div><div class="line">[UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">  	// cellå¤„ç†  </div><div class="line">  </div><div class="line">  	CGRect rect2 = self.helperHideView.frame;</div><div class="line">    self.originHelperViewFrame = rect2;</div><div class="line">    CGPoint origin2 = CGPointMake(0, contentOffsetY + 30 - height);</div><div class="line">    rect2.origin = origin2;</div><div class="line">    self.helperHideView.frame = rect2;</div><div class="line"></div><div class="line">    CGRect rect1 = self.detailView.frame;</div><div class="line">    self.originDetailViewFrame = rect1;</div><div class="line">    CGPoint origin1 = CGPointMake(0, 100 + 30 + contentOffsetY);</div><div class="line">    rect1.origin = origin1;</div><div class="line">    self.detailView.frame = rect1;</div><div class="line"></div><div class="line">    [self addShadowWithView:self];</div><div class="line">    [self addShadowWithView:self.detailView];</div><div class="line">    [self.detailButton setTitle:@&quot;Ã—&quot; forState:UIControlStateNormal];</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å…³é—­çš„æ—¶å€™ï¼Œç§»é™¤æ‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (void)deselectCell &#123;</div><div class="line">    [UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">        // cellå¤„ç†</div><div class="line">        </div><div class="line">        self.detailView.layer.shadowColor = [UIColor clearColor].CGColor;</div><div class="line">        self.detailView.layer.shadowRadius = 0;</div><div class="line">        self.detailView.layer.shadowOpacity = 0.0;</div><div class="line">        </div><div class="line">        self.detailView.frame = self.originDetailViewFrame;</div><div class="line">        self.helperHideView.frame = self.originHelperViewFrame;</div><div class="line">        </div><div class="line">        [self.detailButton setTitle:@&quot;...&quot; forState:UIControlStateNormal];</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        [self.helperHideView removeFromSuperview];</div><div class="line">        [self.detailView removeFromSuperview];</div><div class="line">        if (_deselectBlock) &#123;</div><div class="line">            _deselectBlock();</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å®ç°äº†æŠ½å±‰å¼çš„æ•ˆæœï¼Œä½†æ˜¯æ€»æ„Ÿè§‰è¿˜æœ‰æ›´å¥½çš„åŠæ³•å®ç°ï¼Œå¦‚æœæœ‰æ€è·¯çš„ï¼Œæ¬¢è¿äº¤æµ~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰å¾ˆå–œæ¬¢æ”¶è—&lt;a href=&quot;https://dribbble.com/shots&quot;&gt;dribbble&lt;/a&gt;é‡Œé¢çš„ä¸€äº›åŠ¨æ•ˆgifï¼Œé‡Œé¢ä¸ä»…æ˜¯åŠ¨æ•ˆè¿˜æ˜¯é…è‰²ç­‰ç­‰éƒ½éå¸¸çš„ç¾ï¼Œä½œä¸ºä¸€ä¸ªè§†è§‰åŠ¨ç‰©ï¼ŒçœŸçš„æƒ³æŠŠä»–ä»¬ä¸€ä¸ªä¸€ä¸ªéƒ½å®ç°å‡ºæ¥ï¼Œä½œä¸ºè‡ªå·±çš„ä¸€ä¸ªä½œå“ï¼Œé‚£çœŸçš„æ˜¯ä¸€ä»¶èµå¿ƒæ‚¦ç›®çš„äº‹æƒ…ï¼Œçœ‹ç€G20ä¹Ÿå¿«ç»“æŸäº†ï¼Œèµ¶ç´§è¶è¿˜é—²ç€ï¼Œå…ˆå®ç°ä¸€ä¸ªï¼Œæˆ‘å…ˆæŒ‘é€‰äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åŠ¨æ•ˆâ€”â€“&lt;strong&gt;æŠ½å±‰å¼æ•ˆæœåˆ—è¡¨&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ•ˆæœ:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/GCDrawerTableView.gif!500x500&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ½å±‰å¼ åˆ—è¡¨" scheme="http://yuzeyang.github.io/tags/%E6%8A%BD%E5%B1%89%E5%BC%8F-%E5%88%97%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>æœå†»æ•ˆæœä¸‹æ‹‰åˆ·æ–°æ§ä»¶</title>
    <link href="http://yuzeyang.github.io/2016/09/02/loadingAniamtion-0902/"/>
    <id>http://yuzeyang.github.io/2016/09/02/loadingAniamtion-0902/</id>
    <published>2016-09-02T05:23:04.000Z</published>
    <updated>2016-09-02T09:48:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªä¸‹æ‹‰æ§ä»¶æ˜¯åœ¨<a href="http://iostuts.io/2015/10/17/elastic-bounce-using-uibezierpath-and-pan-gesture/?sukey=3997c0719f151520e178bb5175f11bfb983f5560c51261103fafb276bac79e1371d16e07ede0cca9f23d826405507a3c" target="_blank" rel="external">Elastic view animation using UIBezierPath</a>è¿™ç¯‡åšå®¢ä¸Šçœ‹åˆ°çš„ï¼Œè§‰å¾—æ•ˆæœè¿˜ä¸é”™ï¼Œè‡ªå·±ä¹Ÿå°±OCç®€å•å®ç°äº†ä¸€ä¸‹ï¼ˆåŸä½œè€…æ˜¯ç”¨Swiftå†™çš„ï¼‰ï¼Œæ§ä»¶æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/GCLoadingAnimationTwo.gif!700x700" alt=""></p>
<p>è¿™æ˜¯ä»£ç åœ°å€ï¼š<a href="https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationTwo" target="_blank" rel="external">https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationTwo</a></p>
<p>è¿™ä¸ªæ§ä»¶çš„åŠ¨ç”»æ•ˆæœåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<p>1.ä¸‹æ‹‰çš„æœå†»æ•ˆæœ</p>
<p>2.ä¸‹æ‹‰è¿›åº¦åœ†åœˆçš„æ˜¾ç¤ºåŠæ—‹è½¬</p>
<a id="more"></a>
<h2 id="0x00__u4E0B_u62C9_u679C_u51BB_u72B6_u6001_u5B9E_u73B0_u601D_u8DEF"><a href="#0x00__u4E0B_u62C9_u679C_u51BB_u72B6_u6001_u5B9E_u73B0_u601D_u8DEF" class="headerlink" title="0x00 ä¸‹æ‹‰æœå†»çŠ¶æ€å®ç°æ€è·¯"></a>0x00 ä¸‹æ‹‰æœå†»çŠ¶æ€å®ç°æ€è·¯</h2><p>å¯¹äºä¸‹æ‹‰çš„çŠ¶æ€ï¼Œæˆ‘å°†å…¶åˆ†ä¸ºä¸‰ç§ï¼Œç„¶ååœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸ºæ­£å¸¸çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSInteger, GCLoadingState) &#123;</div><div class="line">    GCLoadingStateNormal,	// æ­£å¸¸çŠ¶æ€</div><div class="line">    GCLoadingStateLoading,	// åŠ è½½ä¸­çŠ¶æ€</div><div class="line">    GCLoadingStateCancelled	// å–æ¶ˆåŠ è½½çŠ¶æ€</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç»˜åˆ¶æ›²çº¿çš„åˆå§‹æ ·å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)drawOriginPath &#123;</div><div class="line">    UIBezierPath *path = [UIBezierPath bezierPath];</div><div class="line">    [path moveToPoint:CGPointMake(0, 0)];</div><div class="line">    [path addLineToPoint:CGPointMake(0, kGCLoadingViewMinHeight)];</div><div class="line">    [path addLineToPoint:CGPointMake(CGRectGetWidth(self.associatedScrollView.frame), kGCLoadingViewMinHeight)];</div><div class="line">    [path addLineToPoint:CGPointMake(CGRectGetWidth(self.associatedScrollView.frame), 0)];</div><div class="line">    </div><div class="line">    self.loadLayer.path = path.CGPath;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‚£åœ¨æ‰‹æŒ‡æ‹–åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¯¥å¦‚æœå®ç°æœå†»æ‹‰ä¼¸çš„æ•ˆæœå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¾…åŠ©è§†å›¾<code>centerHelperView</code>ï¼Œè¿™ä¸ªè¾…åŠ©è§†å›¾æ˜¯åŠ åœ¨ä¸‹é¢è¿™æ¡çº¿çš„ä¸­é—´çš„ï¼Œå¦‚å›¾çš„å°é»‘ç‚¹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/centerHelperView.png!500x500" alt=""></p>
<p>åœ¨ä¸‹æ‹‰æ—¶æˆ‘ä»¬å°±æ ¹æ®è¿™ä¸ª<code>centerHelperView</code>çš„å˜åŒ–æ¥ä¸æ–­çš„ç»˜åˆ¶æˆ‘ä»¬çš„æ›²çº¿ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åˆ°äº†<code>CADisplayLink</code>ï¼Œè¿™ä¸ªåº”è¯¥åœ¨å†™åŠ¨ç”»çš„æ—¶å€™ç”¨çš„ä¹Ÿæ˜¯æ¯”è¾ƒå¤šäº†ï¼Œæ˜¯æ ¹æ®å±å¹•çš„åˆ·æ–°é¢‘ç‡å°†å†…å®¹ç»˜åˆ¶åˆ°å±å¹•çš„å®šæ—¶å™¨ï¼Œå½“æˆ‘ä»¬å°†å®šæ—¶å™¨åŠ åˆ°<code>runLoop</code>é‡Œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„åœ¨è®¾ç½®<code>mode</code>æ—¶ï¼Œå¦‚æœå°†<code>mode</code>è®¾ç½®ä¸º<code>NSDefaultRunLoopMode</code>ï¼Œé‚£ä¹ˆåœ¨æ»‘åŠ¨çš„æ—¶å€™ï¼Œå®šæ—¶å™¨ä¼šæš‚åœï¼Œç›´åˆ°åœæ­¢æ»‘åŠ¨æ‰ä¼šç»§ç»­å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†<code>mode</code>è®¾ç½®ä¸º<code>NSRunLoopCommonModes</code>ï¼Œè¿™æ ·èƒ½ä¿è¯å®šæ—¶å™¨åœ¨æ»‘åŠ¨çš„è¿‡ç¨‹ä¸­ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (CADisplayLink *)displayLink &#123;</div><div class="line">    if (!_displayLink) &#123;</div><div class="line">        _displayLink = [CADisplayLink displayLinkWithTarget:self selector:@selector(displayLinkAction:)];</div><div class="line">        [_displayLink addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSRunLoopCommonModes];</div><div class="line">        _displayLink.paused = YES;</div><div class="line">    &#125;</div><div class="line">    return _displayLink;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å–å‡º<code>centerHelperView</code>çš„åŸç‚¹ï¼Œæ¥ä¸æ–­ç»˜åˆ¶æœå†»çš„æ›²çº¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)displayLinkAction:(CADisplayLink *)displayLink &#123;</div><div class="line">    CALayer *centerHelperViewLayer = (CALayer *)[self.centerHelperView.layer presentationLayer];</div><div class="line">    CGRect centerHelperViewRect = [[centerHelperViewLayer valueForKey:@&quot;frame&quot;] CGRectValue];</div><div class="line">    [self drawLoadLayerWithCenter:centerHelperViewRect.origin];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ—¢ç„¶æˆ‘ä»¬èƒ½å¤Ÿè·å–åˆ°<code>centerHelperView</code>åœ¨ä¸åŒæ—¶é—´é‡Œçš„ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å®ƒæ¥ç»˜åˆ¶æˆ‘ä»¬çš„æ›²çº¿</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/loadingPoint.png!300x300" alt=""></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·¦å³ä¸¤è¾¹éƒ½æ˜¯ç›´çº¿ï¼Œè°ƒç”¨<code>- addLineToPoint</code>æ–¹æ³•å³å¯ï¼Œé‡è¦çš„æ˜¯åº•ä¸‹è¿™æ¡çº¿ï¼Œæˆ‘ä»¬è·å–åˆ°<code>centerHelperView</code>çš„ä½ç½®åï¼Œæš‚ä¸”ç”¨<code>c</code>æ¥è¡¨ç¤ºï¼Œæˆ‘ä»¬åœ¨ç»˜åˆ¶æ›²çº¿æ—¶ï¼Œéœ€è¦ç”¨åˆ°<code>controlPoint1</code>å’Œ<code>controlPoint2</code>ï¼Œé‚£æˆ‘ä»¬å°±æŠŠåº•ä¸‹çš„çº¿åˆ†ä¸ºä¸‰æ®µï¼Œå¹¶ä¸”ä»¥<code>c</code>ä¸ºä¸­å¿ƒåº—ï¼Œå·¦è¾¹å–å‡º<code>l3</code>ã€<code>l2</code>ã€<code>l1</code>ï¼Œå³è¾¹å–å‡º<code>r3</code>ã€<code>r2</code>ã€<code>r1</code>ï¼Œæ›²çº¿åˆ†ä¸ºä¸‰æ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">UIBezierPath *path = [UIBezierPath bezierPath];</div><div class="line">[path moveToPoint:CGPointMake(0, 0)];</div><div class="line">[path addLineToPoint:l3];</div><div class="line">[path addCurveToPoint:l1 controlPoint1:l3 controlPoint2:l2];</div><div class="line">[path addCurveToPoint:r1 controlPoint1:l1 controlPoint2:c];</div><div class="line">[path addCurveToPoint:r3 controlPoint1:r1 controlPoint2:r2];</div><div class="line">[path addLineToPoint:CGPointMake(CGRectGetWidth(self.associatedScrollView.frame), 0)];</div></pre></td></tr></table></figure>
<p>æœå†»çš„æ›²çº¿æˆ‘ä»¬å°±å®Œæˆäº†ï¼Œç„¶åæˆ‘ä»¬å°±è¦å¼€å§‹å¯¹æ‰‹åŠ¿çš„çŠ¶æ€æ¥è¿›è¡Œå¤„ç†</p>
<p>åœ¨å†™æ§ä»¶è°ƒè¯•çš„æ—¶å€™ï¼Œä½ å¯ä»¥é€šè¿‡ç»™ç›®æ ‡è§†å›¾æ·»åŠ <code>UIPanGestureRecognizer</code>ï¼Œè°ƒç”¨<code>- translationInView:</code>æ¥è·å–åˆ°æ‰‹æŒ‡åœ¨å±å¹•ä¸Šæ‹–åŠ¨æ—¶ä½ç½®çš„å˜åŒ–ï¼Œä½†æ˜¯ä¸‹æ‹‰åˆ·æ–°æ§ä»¶ä¸€èˆ¬éƒ½æ˜¯åŠ åœ¨ScrollViewä¸Šçš„ï¼ŒScrollViewè‡ªå·±æ˜¯æœ‰ä¸€ä¸ªåªè¯»çš„<code>UIPanGestureRecognizer</code>å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¿…è‡ªå·±å†æ·»åŠ ä¸€ä¸ªï¼Œæˆ‘ä»¬åªéœ€è¦è§‚å¯Ÿ<code>UIPanGestureRecognizer</code>çš„<code>state</code>å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.associatedScrollView addObserver:self forKeyPath:@&quot;panGestureRecognizer.state&quot; options:NSKeyValueObservingOptionNew context:nil];</div></pre></td></tr></table></figure>
<p>åœ¨å–æ¶ˆæ‹–åŠ¨æ—¶ï¼Œæˆ‘ä»¬æ ¹æ®<code>ScrollView</code>çš„<code>contentOffset</code>æ¥åˆ¤æ–­ï¼Œæ˜¯å¦æ˜¯å–æ¶ˆåŠ è½½è¿˜æ˜¯åŠ è½½</p>
<h2 id="0x01__u4E0B_u62C9_u8FDB_u5EA6_u5706_u5708_u7684_u663E_u793A_u53CA_u65CB_u8F6C"><a href="#0x01__u4E0B_u62C9_u8FDB_u5EA6_u5706_u5708_u7684_u663E_u793A_u53CA_u65CB_u8F6C" class="headerlink" title="0x01 ä¸‹æ‹‰è¿›åº¦åœ†åœˆçš„æ˜¾ç¤ºåŠæ—‹è½¬"></a>0x01 ä¸‹æ‹‰è¿›åº¦åœ†åœˆçš„æ˜¾ç¤ºåŠæ—‹è½¬</h2><p>è¿›åº¦åœ†åœˆçš„æ˜¾ç¤ºä¸»è¦æ˜¯ä¾èµ–äºä¸‹æ‹‰çš„è¿›åº¦ï¼Œç„¶åæ”¹å˜<code>progress</code>ï¼Œåœ†åœˆéšä¹‹ç»˜åˆ¶å°±å¥½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (contentOffset.y &lt; 0) &#123;</div><div class="line">    self.progress = MAX(0.0, MIN(fabs(contentOffset.y/kGCPullMaxDistance), 1.0));</div><div class="line">&#125; else &#123;</div><div class="line">    self.progress = 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)drawRect:(CGRect)rect &#123;</div><div class="line">    UIBezierPath *circlePath = [UIBezierPath bezierPath];</div><div class="line">    [circlePath moveToPoint:CGPointMake(0, - kGCLoadingCircleRadius)];</div><div class="line">    [circlePath addArcWithCenter:CGPointMake(0, 0) radius:kGCLoadingCircleRadius startAngle:-M_PI/2 endAngle:((M_PI*17/9)*self.progess - M_PI/2) clockwise:YES];</div><div class="line">    </div><div class="line">    self.circleLayer.path = circlePath.CGPath;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“<code>progress</code>è¾¾åˆ°1ä¹‹åï¼Œå°±å¼€å§‹æ—‹è½¬åŠ¨ç”»äº†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä½¿ç”¨<code>CABasicAnimation</code>å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *rotationAnimation = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.z&quot;];</div><div class="line">rotationAnimation.toValue = @(M_PI*2);</div><div class="line">rotationAnimation.beginTime = CACurrentMediaTime();</div><div class="line">rotationAnimation.duration = 1.0;</div><div class="line">rotationAnimation.fillMode = kCAFillModeForwards;</div><div class="line">rotationAnimation.repeatCount = HUGE_VALF;</div><div class="line">[self.circleLayer addAnimation:rotationAnimation forKey:nil];</div></pre></td></tr></table></figure>
<p>okï¼Œå¤§åŠŸå‘Šæˆ~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ä¸ªä¸‹æ‹‰æ§ä»¶æ˜¯åœ¨&lt;a href=&quot;http://iostuts.io/2015/10/17/elastic-bounce-using-uibezierpath-and-pan-gesture/?sukey=3997c0719f151520e178bb5175f11bfb983f5560c51261103fafb276bac79e1371d16e07ede0cca9f23d826405507a3c&quot;&gt;Elastic view animation using UIBezierPath&lt;/a&gt;è¿™ç¯‡åšå®¢ä¸Šçœ‹åˆ°çš„ï¼Œè§‰å¾—æ•ˆæœè¿˜ä¸é”™ï¼Œè‡ªå·±ä¹Ÿå°±OCç®€å•å®ç°äº†ä¸€ä¸‹ï¼ˆåŸä½œè€…æ˜¯ç”¨Swiftå†™çš„ï¼‰ï¼Œæ§ä»¶æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/GCLoadingAnimationTwo.gif!700x700&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯ä»£ç åœ°å€ï¼š&lt;a href=&quot;https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationTwo&quot;&gt;https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationTwo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ§ä»¶çš„åŠ¨ç”»æ•ˆæœåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;p&gt;1.ä¸‹æ‹‰çš„æœå†»æ•ˆæœ&lt;/p&gt;
&lt;p&gt;2.ä¸‹æ‹‰è¿›åº¦åœ†åœˆçš„æ˜¾ç¤ºåŠæ—‹è½¬&lt;/p&gt;
    
    </summary>
    
    
      <category term="ä¸‹æ‹‰åˆ·æ–°" scheme="http://yuzeyang.github.io/tags/%E4%B8%8B%E6%8B%89%E5%88%B7%E6%96%B0/"/>
    
  </entry>
  
  <entry>
    <title>æ ¹æ®åè®®åè·å–æ‰€æœ‰ä»£ç†æ–¹æ³•</title>
    <link href="http://yuzeyang.github.io/2016/08/07/get-protocol-methods/"/>
    <id>http://yuzeyang.github.io/2016/08/07/get-protocol-methods/</id>
    <published>2016-08-07T00:34:59.000Z</published>
    <updated>2016-08-10T09:44:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºä¸€ç›´åœ¨ç”¨<a href="https://github.com/markohlebar/Peckham" target="_blank" rel="external">Peckham</a>è¿™ä¸ªæ’ä»¶ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¾‘å™¨çš„ä»»æ„ä½ç½®ä½¿ç”¨å¿«æ·é”®å¿«é€Ÿå¼•ç”¨å¤´æ–‡ä»¶ï¼Œæ‰€ä»¥åæ¥åœ¨æƒ³èƒ½ä¸èƒ½ä¹Ÿå†™ä¸€ä¸ªç±»ä¼¼çš„æ’ä»¶å¿«é€Ÿå¼•å…¥ä»€ä¹ˆä¸œè¥¿ï¼Œç»†ç»†ä¸€æƒ³å¹³æ—¶è‡ªå·±åœ¨å¼•ç”¨ä»£ç†åè®®çš„æ—¶å€™ï¼ŒåŸºæœ¬éƒ½æ˜¯è¦è·‘åˆ°æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¥½ä¹‹åï¼Œå†å›åˆ°åŸæ¥çš„ä½ç½®ç»§ç»­å†™ï¼Œå¦‚æœæœ‰å¿…é¡»å®ç°çš„ä»£ç†æ–¹æ³•æ²¡æ³¨æ„å®ç°çš„è¯ï¼Œå¯èƒ½åˆè¦å›åˆ°implementationçœ‹warningsæˆ–è€…è·³è½¬åˆ°åè®®é‡Œé¢çœ‹å“ªäº›æ˜¯å¿…é¡»å®ç°ï¼Œæ‹·è´è¿‡æ¥ï¼Œç²˜è´´åˆ°è‡ªå·±çš„å®ç°é‡Œé¢ï¼Œè¿™æ ·çš„æ“ä½œå®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å¯ä»¥å†™ä¸ªæ’ä»¶ï¼Œä½¿ç”¨å¿«æ·é”®å°†å¿…é¡»å®ç°çš„ä»£ç†æ–¹æ³•åˆ°implementationåº•éƒ¨ï¼Œè¿™æ ·å¯¹äºå¼€å‘è€…æ¥è¯´èƒ½é¿å…å¾ˆå¤šä¸å¿…è¦æ“ä½œï¼Œä¹Ÿèƒ½å¿«é€Ÿæ˜ç™½å“ªäº›ä»£ç†æ–¹æ³•å¿…é¡»å®ç°ï¼Œå¥½ï¼Œæ¥ä¸‹æ¥æˆ‘æ¥æ„æ€ä¸‹æ€ä¹ˆå®ç°è¿™ä¸ªæ’ä»¶ï¼ˆä½†æ˜¯åé¢è¿™ä¸ªå®ç°å‡ºæ¥çš„æ•ˆæœå¹¶ä¸æ˜¯å¾ˆå®Œç¾ï¼Œæ‰€ä»¥è¿˜æ˜¯æ”¾å¼ƒäº†â€¦åŸå› çœ‹æ›´å¤šï¼‰</p>
<a id="more"></a>
<p>1.åœ¨å†™å®Œåè®®åä¹‹åï¼ŒåŒå‡»æˆ–è€…å•å‡»æ‹–åŠ¨é€‰ä¸­åè®®å<br>2.ä½¿ç”¨å¿«æ·é”®ï¼Œæ ¹æ®é€‰ä¸­çš„åè®®åï¼ŒæŸ¥æ‰¾åè®®é‡Œé¢çš„æ‰€æœ‰ä»£ç†æ–¹æ³•<br>3.å†ç­›é€‰å‡ºé‡Œé¢requireæ ‡è®°çš„ä»£ç†æ–¹æ³•<br>4.å°†è¿™äº›ä»£ç†æ–¹æ³•ï¼Œæ·»åŠ åˆ°å½“å‰ç±»çš„å®ç°æ–‡ä»¶é‡Œé¢</p>
<p>æˆ‘æ¥ä¸‹å»è®²çš„éƒ½æ˜¯é»˜è®¤ä½ å·²ç»äº†è§£äº†æ’ä»¶çš„é…ç½®ä»¥åŠè°ƒè¯•</p>
<h2 id="u9009_u4E2D_u534F_u8BAE_u540D"><a href="#u9009_u4E2D_u534F_u8BAE_u540D" class="headerlink" title="é€‰ä¸­åè®®å"></a>é€‰ä¸­åè®®å</h2><p>é¦–å…ˆæˆ‘ä»¬åœ¨åˆå§‹åŒ–bundleçš„æ—¶å€™ï¼Œæ³¨å†Œ<code>NSTextViewDidChangeSelectionNotification</code>é€šçŸ¥ï¼Œ<code>- selectString :</code>ç”¨æ¥æ¥æ”¶é€‰ä¸­æ–‡æœ¬æ”¹å˜æ—¶é€šçŸ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(selectString:)</div><div class="line">name:NSTextViewDidChangeSelectionNotification object:nil];</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨æ¥æ”¶æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬è·å–åˆ°å½“å‰æ“ä½œçš„ç¼–è¾‘é¡µé¢<code>NSTextView</code>å¯¹è±¡ï¼Œç„¶åè·å–åˆ°é€‰ä¸­çš„<code>range</code>ï¼Œå–å‡ºé€‰ä¸­çš„æ–‡æœ¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (void)selectString:(NSNotification *)notification &#123;</div><div class="line">    if ([notification.object isKindOfClass:[NSTextView class]]) &#123;</div><div class="line">        NSTextView* textView = (NSTextView *)notification.object;</div><div class="line">        NSArray* selectedRanges = [textView selectedRanges];</div><div class="line">        if (selectedRanges.count == 0) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        NSRange selectedRange = [[selectedRanges objectAtIndex:0] rangeValue];</div><div class="line">        NSString* text = textView.textStorage.string;</div><div class="line">        self.selectedString = [text substringWithRange:selectedRange];</div><div class="line">        NSLog(@&quot;%s %@&quot;,__func__,self.selectedString);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u4F7F_u7528_u5FEB_u6377_u952E_uFF0C_u67E5_u627E_u534F_u8BAE_u91CC_u9762_u7684_u6240_u6709_u4EE3_u7406_u65B9_u6CD5"><a href="#u4F7F_u7528_u5FEB_u6377_u952E_uFF0C_u67E5_u627E_u534F_u8BAE_u91CC_u9762_u7684_u6240_u6709_u4EE3_u7406_u65B9_u6CD5" class="headerlink" title="ä½¿ç”¨å¿«æ·é”®ï¼ŒæŸ¥æ‰¾åè®®é‡Œé¢çš„æ‰€æœ‰ä»£ç†æ–¹æ³•"></a>ä½¿ç”¨å¿«æ·é”®ï¼ŒæŸ¥æ‰¾åè®®é‡Œé¢çš„æ‰€æœ‰ä»£ç†æ–¹æ³•</h2><p>å¿«æ·é”®çš„è®¾ç½®åœ¨å¢åŠ <code>NSMenuItem</code>å¯¹è±¡æ—¶å°±å·²ç»è®¾ç½®äº†ï¼Œå¹¶ä¸”è®¾ç½®å…¶å¿«æ·é”®ä¸º<code>^â‡G</code>ï¼Œä»¥åŠå¯¹åº”çš„<code>- searchProtocol:</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[[menuItem submenu] addItem:[NSMenuItem separatorItem]];</div><div class="line">        </div><div class="line">NSMenuItem *protolMenuItem = [[NSMenuItem alloc] initWithTitle:@&quot;Protol Helper&quot; action:@selector(searchProtocol:) keyEquivalent:@&quot;g&quot;];</div><div class="line">[protolMenuItem setKeyEquivalentModifierMask:NSAlternateKeyMask|NSControlKeyMask];</div><div class="line">protolMenuItem.target = self;</div><div class="line">[[menuItem submenu] addItem:protolMenuItem];</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬æ€ä¹ˆæŸ¥æ‰¾åˆ°é€‰ä¸­æ–‡æœ¬å¯¹åº”çš„åè®®å’Œé‡Œé¢çš„ä»£ç†æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆæ‰¾æ€ä¹ˆè·å–åˆ°ä»£ç†æ–¹æ³•ï¼Œç„¶åå€’æ¨å›æ¥ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ç”¨åˆ°<code>runtime</code>ï¼Œæˆ‘ä»¬è¿›åˆ°<code>runtime.h</code>é‡Œï¼Œé€šè¿‡æœç´¢<code>protocol</code>å…³é”®å­—ï¼Œæˆ‘ä»¬æ‰¾äº†<code>protocol_copyMethodDescriptionList</code>è¿™ä¸ªæ–¹æ³•ï¼Œ<code>p</code>æ˜¯ä¸€ä¸ª<code>Protocol</code>å¯¹è±¡ï¼Œ<code>isRequiredMethod</code>ç­›é€‰æ˜¯å¦æ˜¯å¿…é¡»çš„æ–¹æ³•ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è·å–å¿…é¡»å®ç°çš„ä»£ç†æ–¹æ³•ï¼Œ<code>isInstanceMethod</code>ç­›é€‰æ˜¯å¦æ˜¯å®ä¾‹æ–¹æ³•ï¼Œ<code>outCount</code>è¿™ä¸ªè¡¨ç¤ºè¿”å›æ–¹æ³•çš„æ•°é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">OBJC_EXPORT struct objc_method_description *protocol_copyMethodDescriptionList(Protocol *p, BOOL isRequiredMethod, BOOL isInstanceMethod, unsigned int *outCount)</div><div class="line">     __OSX_AVAILABLE_STARTING(__MAC_10_5, __IPHONE_2_0);</div></pre></td></tr></table></figure>
<p><code>Protocol</code>å¯¹è±¡æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>objc_getProtocol</code>æ–¹æ³•ï¼Œé€šè¿‡ä¼ å…¥åè®®åæ¥åˆ›å»º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">const char *protocolName = self.selectedString.UTF8String;</div><div class="line">Protocol *protocol = objc_getProtocol(protocolName);</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å¼€å§‹è°ƒç”¨<code>protocol_copyMethodDescriptionList</code>æ–¹æ³•ï¼Œæ‰“å°å‡ºæ–¹æ³•ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘å°±å…ˆä¸ç®¡ä»£ç ç®€æ´æ€§äº†ï¼Œæˆ‘æ‹¿<code>NSTextViewDelegate</code>æ¥æµ‹è¯•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">unsigned int count = 999;</div><div class="line">struct objc_method_description *methods1;</div><div class="line">struct objc_method_description *methods2;</div><div class="line">struct objc_method_description *methods3;</div><div class="line">struct objc_method_description *methods4;</div><div class="line">methods1 = protocol_copyMethodDescriptionList(protocol, NO, YES, &amp;count);</div><div class="line">methods2 = protocol_copyMethodDescriptionList(protocol, NO, NO, &amp;count);</div><div class="line">methods3 = protocol_copyMethodDescriptionList(protocol, YES, YES, &amp;count);</div><div class="line">methods4 = protocol_copyMethodDescriptionList(protocol, YES, NO, &amp;count);</div><div class="line"></div><div class="line">if (methods1 != NULL) &#123;</div><div class="line">    NSLog(@&quot;---------------------methods1&quot;);</div><div class="line">    [self logMethods:methods1];</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (methods2 != NULL) &#123;</div><div class="line">    NSLog(@&quot;---------------------methods2&quot;);</div><div class="line">    [self logMethods:methods2];</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (methods3 != NULL) &#123;</div><div class="line">    NSLog(@&quot;---------------------methods3&quot;);</div><div class="line">    [self logMethods:methods3];</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (methods4 != NULL) &#123;</div><div class="line">    NSLog(@&quot;---------------------methods4&quot;);</div><div class="line">    [self logMethods:methods4];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹ä¸‹æ‰“å°çš„æ–¹æ³•ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] ---------------------methods1</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:shouldChangeTextInRange:replacementString: c48@0:8@16&#123;_NSRange=QQ&#125;24@40</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:willChangeSelectionFromCharacterRange:toCharacterRange: &#123;_NSRange=QQ&#125;56@0:8@16&#123;_NSRange=QQ&#125;24&#123;_NSRange=QQ&#125;40</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textViewDidChangeSelection: v24@0:8@16</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:completions:forPartialWordRange:indexOfSelectedItem: @56@0:8@16@24&#123;_NSRange=QQ&#125;32^q48</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:doCommandBySelector: c32@0:8@16:24</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:clickedOnLink:atIndex: c40@0:8@16@24Q32</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:clickedOnCell:inRect:atIndex: v72@0:8@16@24&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;32Q64</div><div class="line">2016-08-07 15:13:39.242 Xcode[1218:86590] methods name textView:doubleClickedOnCell:inRect:atIndex: v72@0:8@16@24&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;32Q64</div><div class="line">...</div></pre></td></tr></table></figure>
<p>whatï¼Ÿæ–¹æ³•åå±…ç„¶ä¸æ˜¯å®Œæ•´çš„ï¼Œä¸æ˜¯æˆ‘ä»¬çœ‹åˆ°<code>- (BOOL)textView:(NSTextView *)textView clickedOnLink:(id)link atIndex:(NSUInteger)charIndex;</code>è¿™æ ·çš„ï¼Œä½†æ˜¯æƒ³æƒ³ä¹Ÿå¯¹ï¼Œæ–¹æ³•ååº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œä¸åŒ…å«å‚æ•°åå’Œå‚æ•°ç±»å‹ï¼Œè™½ç„¶å‚æ•°ç±»å‹å¯ä»¥é€šè¿‡<code>objc_method_description</code>ç»“æ„ä½“é‡Œé¢<code>types</code>æ‹¿åˆ°ï¼Œä½†æ˜¯å‚æ•°åæ€ä¹ˆåŠâ€¦æˆ‘æ€»ä¸èƒ½ç”¨abcæ¥ä»£æ›¿å§ï¼Œè™½ç„¶åšæ˜¯å¯ä»¥åšï¼Œä½†æ˜¯ç”¨èµ·æ¥è¿˜æ˜¯è¦æ”¹å‚æ•°åï¼Œè¿™ä¸æ˜¯å¾ˆéº»çƒ¦â€¦æ„Ÿè§‰åœ¨è¿™é‡Œé‡åˆ°ç“¶é¢ˆäº†</p>
<p>ç„¶åæˆ‘æƒ³çœ‹åˆ°<code>objc_class</code>ç»“æ„ä½“é‡Œé¢ä¹Ÿæœ‰å­˜æ”¾åè®®ä¿¡æ¯ï¼Œé‚£ä»–é‡Œé¢æ˜¯æ€ä¹ˆæ ·çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct objc_class &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line"></div><div class="line">#if !__OBJC2__</div><div class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</div><div class="line">    const char *name                                         OBJC2_UNAVAILABLE;</div><div class="line">    long version                                             OBJC2_UNAVAILABLE;</div><div class="line">    long info                                                OBJC2_UNAVAILABLE;</div><div class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct objc_protocol_list &#123;</div><div class="line">    struct objc_protocol_list *next;</div><div class="line">    long count;</div><div class="line">    Protocol *list[1];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@interface Protocol : Object</div><div class="line">&#123;</div><div class="line">@private</div><div class="line">    char *protocol_name OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_protocol_list *protocol_list OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_description_list *instance_methods OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_description_list *class_methods OBJC2_UNAVAILABLE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struct objc_method_description_list &#123;</div><div class="line">        int count;</div><div class="line">        struct objc_method_description list[1];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struct objc_method_description &#123;</div><div class="line">	SEL name;               /**&lt; The name of the method */</div><div class="line">	char *types;            /**&lt; The types of the method arguments */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸€ç³»åˆ—çš„æŸ¥æ‰¾ï¼Œæˆ‘ä»¬åˆå›åˆ°äº†<code>objc_method_description</code>ï¼Œwhatï¼Ÿè¿™<code>objc_class</code>æœ€ç»ˆæ‹¿åˆ°çš„æ•°æ®è¿˜æ˜¯ä»<code>objc_method_description</code>æ¥çš„ï¼Œé‚£å°±æ˜¯è¯´æ˜æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç›´æ¥è·å¾—<code>- (BOOL)textView:(NSTextView *)textView clickedOnLink:(id)link atIndex:(NSUInteger)charIndex;</code>â€¦.è¿™æ ·å°±ä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æ‰€é¢„æœŸçš„é‚£æ ·äº†</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>protocol_copyMethodDescriptionList</code>æ–¹æ³•è·å–åˆ°åè®®é‡Œé¢æ‰€æœ‰çš„ä»£ç†æ–¹æ³•ï¼Œåˆ†ä¸ºæ–¹æ³•åå’Œç±»å‹ï¼Œä½†æ˜¯ä¸èƒ½è·å–åˆ°<code>- (BOOL)textView:(NSTextView *)textView clickedOnLink:(id)link atIndex:(NSUInteger)charIndex;</code>è¿™æ ·çš„ï¼Œå¦‚æœç”¨aï¼Œbï¼Œcè¿™æ ·çš„æ¥å¡«å……å‚æ•°åï¼Œè¿™æ ·åœ¨ä½¿ç”¨èµ·æ¥ï¼Œä½¿ç”¨æ–¹è¿˜è¦è‡ªå·±å†æ›¿æ¢å‚æ•°åï¼Œè¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œè§£å†³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œggâ€¦..</p>
<p>2016å¹´8æœˆ10æ—¥è¡¥å……ï¼š</p>
<p>åæ¥è¥¿å…°èŠ±æå‡ºè¯´æ ¹æ®åè®®åç§°å»çˆ¬å¼€å‘æ–‡æ¡£ä¸Šç›¸å…³çš„ä»£ç†æ–¹æ³•æˆ–è€…æ‰¾æœ¬åœ°å¼€å‘åŒ…é‡Œé¢çš„ç›¸å…³å¤´æ–‡ä»¶ï¼Œä¸è€ƒè™‘æ˜¯å¦å¯è¡Œï¼Œä½†æ˜¯æœ‰ä¸ªå…±åŒçš„é—®é¢˜æ˜¯åªèƒ½è·å–åˆ°å®˜æ–¹çš„ï¼Œè‡ªå·±åˆ›å»ºçš„ä¸è¡Œï¼Œè€Œä¸”å‰è€…æ²¡æœ‰requireæ ‡è®°</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å› ä¸ºä¸€ç›´åœ¨ç”¨&lt;a href=&quot;https://github.com/markohlebar/Peckham&quot;&gt;Peckham&lt;/a&gt;è¿™ä¸ªæ’ä»¶ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¾‘å™¨çš„ä»»æ„ä½ç½®ä½¿ç”¨å¿«æ·é”®å¿«é€Ÿå¼•ç”¨å¤´æ–‡ä»¶ï¼Œæ‰€ä»¥åæ¥åœ¨æƒ³èƒ½ä¸èƒ½ä¹Ÿå†™ä¸€ä¸ªç±»ä¼¼çš„æ’ä»¶å¿«é€Ÿå¼•å…¥ä»€ä¹ˆä¸œè¥¿ï¼Œç»†ç»†ä¸€æƒ³å¹³æ—¶è‡ªå·±åœ¨å¼•ç”¨ä»£ç†åè®®çš„æ—¶å€™ï¼ŒåŸºæœ¬éƒ½æ˜¯è¦è·‘åˆ°æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¥½ä¹‹åï¼Œå†å›åˆ°åŸæ¥çš„ä½ç½®ç»§ç»­å†™ï¼Œå¦‚æœæœ‰å¿…é¡»å®ç°çš„ä»£ç†æ–¹æ³•æ²¡æ³¨æ„å®ç°çš„è¯ï¼Œå¯èƒ½åˆè¦å›åˆ°implementationçœ‹warningsæˆ–è€…è·³è½¬åˆ°åè®®é‡Œé¢çœ‹å“ªäº›æ˜¯å¿…é¡»å®ç°ï¼Œæ‹·è´è¿‡æ¥ï¼Œç²˜è´´åˆ°è‡ªå·±çš„å®ç°é‡Œé¢ï¼Œè¿™æ ·çš„æ“ä½œå®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘æƒ³å¯ä»¥å†™ä¸ªæ’ä»¶ï¼Œä½¿ç”¨å¿«æ·é”®å°†å¿…é¡»å®ç°çš„ä»£ç†æ–¹æ³•åˆ°implementationåº•éƒ¨ï¼Œè¿™æ ·å¯¹äºå¼€å‘è€…æ¥è¯´èƒ½é¿å…å¾ˆå¤šä¸å¿…è¦æ“ä½œï¼Œä¹Ÿèƒ½å¿«é€Ÿæ˜ç™½å“ªäº›ä»£ç†æ–¹æ³•å¿…é¡»å®ç°ï¼Œå¥½ï¼Œæ¥ä¸‹æ¥æˆ‘æ¥æ„æ€ä¸‹æ€ä¹ˆå®ç°è¿™ä¸ªæ’ä»¶ï¼ˆä½†æ˜¯åé¢è¿™ä¸ªå®ç°å‡ºæ¥çš„æ•ˆæœå¹¶ä¸æ˜¯å¾ˆå®Œç¾ï¼Œæ‰€ä»¥è¿˜æ˜¯æ”¾å¼ƒäº†â€¦åŸå› çœ‹æ›´å¤šï¼‰&lt;/p&gt;
    
    </summary>
    
    
      <category term="åè®®æ–¹æ³•" scheme="http://yuzeyang.github.io/tags/%E5%8D%8F%E8%AE%AE%E6%96%B9%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>åŠ è½½åŠ¨ç”»åˆ†æ</title>
    <link href="http://yuzeyang.github.io/2016/07/27/loadingAnimation-0727/"/>
    <id>http://yuzeyang.github.io/2016/07/27/loadingAnimation-0727/</id>
    <published>2016-07-27T14:49:19.000Z</published>
    <updated>2016-08-15T15:03:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¥½ä¹…æ²¡å†™åŠ¨ç”»äº†â€¦æœ€è¿‘æ‰’äº†ä¸‹ä»¥å‰æ²¡æœ‰å†™çš„åŠ¨ç”»æ•ˆæœï¼Œæƒ³æƒ³ä»æœ€è€çš„å¼€å§‹å†™å§ï¼Œä¹‹å‰çœ‹åˆ°çš„ç‰ˆæœ¬æ˜¯ç”¨Swiftå†™çš„ï¼Œæ²¡ä»”ç»†æ‰¾æœ‰æ²¡æœ‰OCç‰ˆçš„ï¼Œæ‰€ä»¥å¹²è„†è‡ªå·±ç»ƒä¹ ä¸€ä¸‹å§ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<p>(è¿™é‡Œä¸‰è§’å½¢æ˜¯æ—‹è½¬åŠ¨ç”»ï¼Œä½†æ˜¯Gifå½•å‡ºæ¥çœ‹ä¸Šå»æ˜¯æŠ–äº†ä¸¤ä¸‹â€¦)</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/GCLoadingAnimationOne.gif!500x500" alt=""></p>
<p>å¯ä»¥ç›´æ¥runä¸‹ä»£ç ï¼Œçœ‹ä¸‹æ•ˆæœï¼š<a href="https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationOne" target="_blank" rel="external">https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationOne</a></p>
<p>ä¸‹é¢æˆ‘æ¥åˆ†æä¸‹è¿‡ç¨‹</p>
<a id="more"></a>
<p>è¿™ä¸ªåŠ¨ç”»çš„å®ç°åªç”¨åˆ°äº†<code>UIBezierPath</code>ã€<code>CABasicAnimation</code>å’Œ<code>CALayer</code></p>
<p>ä»Gifé‡Œé¢å¯ä»¥çœ‹åˆ°è¿™ä¸ªåŠ¨ç”»åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<p>1.ä»æ— åˆ°åœ†</p>
<p>2.åœ†xè½´æ–¹å‘æ‹‰ä¼¸å’Œyè½´æ–¹å‘æ‹‰ä¼¸</p>
<p>3.â€œé•¿å‡ºâ€ä¸‰è§’å½¢çš„ä¸‰ä¸ªè§’</p>
<p>4.ä¸‰è§’å½¢æ—‹è½¬</p>
<p>5.ç”»ä¸¤æ¡è¾¹æ¡†</p>
<p>6.æ°´é¢ä¸Šæ¶¨åŠ¨ç”»</p>
<p>7.ä¸­é—´çŸ©å½¢æ”¾å¤§è‡³å…¨å±</p>
<p>8.ä¸­é—´logoè·Ÿç€å‡ºç°</p>
<h2 id="0x00__u4ECE_u65E0_u5230_u5706"><a href="#0x00__u4ECE_u65E0_u5230_u5706" class="headerlink" title="0x00 ä»æ— åˆ°åœ†"></a>0x00 ä»æ— åˆ°åœ†</h2><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œåªè¦è®¾å®šèµ·å§‹çš„sizeä¸º0å’Œè®¾å®šé»˜è®¤åœ†åŠå¾„å¤§å°ï¼Œç”¨<code>+ bezierPathWithOvalInRect:</code>æ–¹æ³•ç”»åœ†<code>+ (instancetype)bezierPathWithRoundedRect:(CGRect)rect cornerRadius:(CGFloat)cornerRadius</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UIBezierPath *startPath = [self circleStartPath];</div><div class="line">UIBezierPath *endPath = [UIBezierPath bezierPathWithOvalInRect:CGRectMake(GCLoadingLayerCenterX - GCCircleRadius, GCLoadingLayerCenterY - GCCircleRadius, GCCircleRadius*2, GCCircleRadius*2)];</div></pre></td></tr></table></figure>
<p>å°†æœ€ååœ†çš„<code>path</code>è®¾ä¸º<code>circleLayer</code>çš„<code>path</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">self.circleLayer = [CAShapeLayer layer];</div><div class="line">self.circleLayer.path = endPath.CGPath;</div><div class="line">self.circleLayer.fillColor = [UIColor orangeColor].CGColor;</div><div class="line">[self addSublayer:self.circleLayer];</div></pre></td></tr></table></figure>
<p>ç„¶ååŠ ä¸ŠåŠ¨ç”»ï¼Œå› ä¸ºæˆ‘ä»¬ä¿®æ”¹çš„æ˜¯<code>path</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬<code>animation</code>çš„<code>keyPath</code>æ˜¯<code>path</code>ï¼ˆåé¢ä¹Ÿæ˜¯ï¼‰ï¼Œè®¾å®šèµ·å§‹å€¼ä¸º<code>startPath.CGPath</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *circleAnimation = [CABasicAnimation animationWithKeyPath:@&quot;path&quot;];</div><div class="line">circleAnimation.fromValue = (__bridge id _Nullable)(startPath.CGPath);</div><div class="line">circleAnimation.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseOut];</div><div class="line">circleAnimation.duration = 0.2f;</div><div class="line">circleAnimation.fillMode = kCAFillModeForwards;</div><div class="line">circleAnimation.delegate = self;</div><div class="line">circleAnimation.removedOnCompletion = NO;</div><div class="line">[circleAnimation setValue:@&quot;circleAnimation&quot; forKey:@&quot;animationName&quot;];</div><div class="line">[self.circleLayer addAnimation:circleAnimation forKey:nil];</div></pre></td></tr></table></figure>
<h2 id="0x01__u5706x_u8F74_u65B9_u5411_u62C9_u4F38_u548Cy_u8F74_u65B9_u5411_u62C9_u4F38"><a href="#0x01__u5706x_u8F74_u65B9_u5411_u62C9_u4F38_u548Cy_u8F74_u65B9_u5411_u62C9_u4F38" class="headerlink" title="0x01 åœ†xè½´æ–¹å‘æ‹‰ä¼¸å’Œyè½´æ–¹å‘æ‹‰ä¼¸"></a>0x01 åœ†xè½´æ–¹å‘æ‹‰ä¼¸å’Œyè½´æ–¹å‘æ‹‰ä¼¸</h2><p>è¿™é‡Œæˆ‘ä»¬çš„<code>keyPath</code>ä¸ç”¨<code>transform.scale.x/y</code>ï¼Œå› ä¸ºç¼©æ”¾ä¹‹åï¼Œåœ†å¿ƒä¼šæ”¹å˜ï¼Œçœ‹ä¸Šå»æœ‰åç§»ï¼Œè¿™æ ·åŠ¨ç”»å†™èµ·æ¥æ›´å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹²è„†ç›´æ¥ç”¨æ‹‰ä¼¸åçš„<code>path</code>æ¥åšåŠ¨ç”»</p>
<p>åˆ›å»ºxè½´ã€yè½´æ‹‰ä¼¸åçš„<code>path</code>ï¼Œç„¶ååŠ åˆ°<code>animation</code>é‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">UIBezierPath *scaleXPath = [UIBezierPath bezierPathWithOvalInRect:CGRectMake(GCLoadingLayerCenterX - GCCircleRadius*1.1, GCLoadingLayerCenterY - GCCircleRadius, GCCircleRadius*2.2, GCCircleRadius*2)];</div><div class="line">UIBezierPath *scaleYPath = [UIBezierPath bezierPathWithOvalInRect:CGRectMake(GCLoadingLayerCenterX - GCCircleRadius, GCLoadingLayerCenterY - GCCircleRadius*1.1, GCCircleRadius*2, GCCircleRadius*2.2)];</div><div class="line"></div><div class="line">CABasicAnimation *circleScaleXOneAnimation = [CABasicAnimation animationWithKeyPath:@&quot;path&quot;];</div><div class="line">circleScaleXOneAnimation.fromValue = (__bridge id _Nullable)(self.circleLayer.path);</div><div class="line">circleScaleXOneAnimation.toValue = (__bridge id _Nullable)(scaleXPath.CGPath);</div><div class="line">circleScaleXOneAnimation.duration = 0.2f;</div><div class="line">circleScaleXOneAnimation.beginTime = 0.0;</div></pre></td></tr></table></figure>
<p>ä¸€å…±å››ä¸ª<code>CABasicAnimation</code>å¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬å°†è¿™äº›åŠ¨ç”»åŠ åˆ°<code>CAAnimationGroup</code>é‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CAAnimationGroup *animationGroup = [CAAnimationGroup animation];</div><div class="line">animationGroup.animations = @[circleScaleXOneAnimation,circleScaleXTwoAnimation,circleScaleYOneAnimation,circleScaleYTwoAnimation];</div><div class="line">animationGroup.duration = circleScaleYTwoAnimation.beginTime + circleScaleYTwoAnimation.duration;</div><div class="line">animationGroup.delegate = self;</div><div class="line">[animationGroup setValue:@&quot;circleScaleAnimation&quot; forKey:@&quot;animationName&quot;];</div><div class="line">[self.circleLayer addAnimation:animationGroup forKey:nil];</div></pre></td></tr></table></figure>
<h2 id="0x02__u201C_u957F_u51FA_u201D_u4E09_u89D2_u5F62_u7684_u4E09_u4E2A_u89D2"><a href="#0x02__u201C_u957F_u51FA_u201D_u4E09_u89D2_u5F62_u7684_u4E09_u4E2A_u89D2" class="headerlink" title="0x02 â€œé•¿å‡ºâ€ä¸‰è§’å½¢çš„ä¸‰ä¸ªè§’"></a>0x02 â€œé•¿å‡ºâ€ä¸‰è§’å½¢çš„ä¸‰ä¸ªè§’</h2><p>å®é™…ä¸Šä¸‰è§’å½¢åœ¨ç­‰åˆ°åœ†å½¢å‡ºç°æˆ–è€…åœ†å½¢æ‹‰ä¼¸å®Œä¹‹åå°±å·²ç»åœ¨é‚£äº†ï¼Œâ€œé•¿å‡ºè§’â€çš„æ„Ÿè§‰å®é™…ä¸Šåªæ˜¯æ”¹å˜äº†ç»˜åˆ¶çš„ä¸‰ä¸ªç‚¹çš„ä½ç½®ï¼Œé¦–å…ˆæˆ‘ä»¬æ ¹æ®åœ†çš„åŠå¾„ç”»å‡ºä¸‰è§’å½¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">UIBezierPath *originTrianglePath = [UIBezierPath bezierPath];</div><div class="line">[originTrianglePath moveToPoint:[self triangleLeftPointWithScale:1.0]];</div><div class="line">[originTrianglePath addLineToPoint:[self triangleRightPointWithScale:1.0]];</div><div class="line">[originTrianglePath addLineToPoint:[self triangleTopPointWithScale:1.0]];</div><div class="line">[originTrianglePath closePath];</div><div class="line"></div><div class="line">self.triangleLayer = [CAShapeLayer layer];</div><div class="line">self.triangleLayer.path = originTrianglePath.CGPath;</div><div class="line">self.triangleLayer.fillColor = [UIColor orangeColor].CGColor;</div><div class="line">[self addSublayer:self.triangleLayer];</div></pre></td></tr></table></figure>
<p>ç„¶åæ”¹å˜å·¦è¾¹ç‚¹çš„ä½ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">UIBezierPath *blowUpLeftTrianglePath = [UIBezierPath bezierPath];</div><div class="line">[blowUpLeftTrianglePath moveToPoint:[self triangleLeftPointWithScale:1.2]];</div><div class="line">[blowUpLeftTrianglePath addLineToPoint:[self triangleRightPointWithScale:1.0]];</div><div class="line">[blowUpLeftTrianglePath addLineToPoint:[self triangleTopPointWithScale:1.0]];</div><div class="line">[blowUpLeftTrianglePath closePath];</div></pre></td></tr></table></figure>
<p>ä¹ŸåŠ ä¸Š<code>path</code>çš„åŠ¨ç”»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *blowUpLeftAnimation = [CABasicAnimation animationWithKeyPath:@&quot;path&quot;];</div><div class="line">blowUpLeftAnimation.fromValue = (__bridge id _Nullable)(self.triangleLayer.path);</div><div class="line">blowUpLeftAnimation.toValue = (__bridge id _Nullable)(blowUpLeftTrianglePath.CGPath);</div><div class="line">blowUpLeftAnimation.duration = 0.2f;</div><div class="line">blowUpLeftAnimation.beginTime = 0.0;</div></pre></td></tr></table></figure>
<p>å³è¾¹å’Œä¸Šè¾¹çš„ç‚¹åŒç†ï¼Œç„¶åä¹Ÿä¸€èµ·åŠ åˆ°<code>CAAnimationGroup</code>é‡Œ</p>
<h2 id="0x03__u4E09_u89D2_u5F62_u65CB_u8F6C"><a href="#0x03__u4E09_u89D2_u5F62_u65CB_u8F6C" class="headerlink" title="0x03 ä¸‰è§’å½¢æ—‹è½¬"></a>0x03 ä¸‰è§’å½¢æ—‹è½¬</h2><p>æ—‹è½¬å°±æ¯”è¾ƒç®€å•äº†ï¼Œåªè¦æ ¹æ®zè½´æ—‹è½¬è®¾å®šçš„è§’åº¦å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *rotationAniamtion = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.z&quot;];</div><div class="line">rotationAniamtion.toValue = @(M_PI*2);</div><div class="line">rotationAniamtion.duration = 0.4;</div><div class="line">rotationAniamtion.fillMode = kCAFillModeForwards;</div><div class="line">rotationAniamtion.delegate = self;</div><div class="line">rotationAniamtion.beginTime = CACurrentMediaTime();</div><div class="line">[rotationAniamtion setValue:@&quot;rotationAniamtion&quot; forKey:@&quot;animationName&quot;];</div><div class="line">[self.triangleLayer addAnimation:rotationAniamtion forKey:nil];</div></pre></td></tr></table></figure>
<h2 id="0x04__u753B_u4E24_u6761_u8FB9_u6846"><a href="#0x04__u753B_u4E24_u6761_u8FB9_u6846" class="headerlink" title="0x04 ç”»ä¸¤æ¡è¾¹æ¡†"></a>0x04 ç”»ä¸¤æ¡è¾¹æ¡†</h2><p>è¿™ä¸¤ä¸ªè¾¹æ¡†ç»˜åˆ¶æ–¹æ³•æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œåªæ˜¯ä¸­é—´æœ‰ä¸ªæ—¶é—´é—´éš”è€Œå·²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (CABasicAnimation *)drawRectWithLineColor:(CGColorRef)color animationValue:(NSString *)animationValue &#123;</div><div class="line">    CGPoint startPoint = [self triangleLeftPointWithScale:1.2];</div><div class="line">    UIBezierPath *rectPath = [UIBezierPath bezierPath];</div><div class="line">    [rectPath moveToPoint:startPoint];</div><div class="line">    [rectPath addLineToPoint:CGPointMake(startPoint.x, startPoint.y - GCCircleRadius*2.4)];</div><div class="line">    [rectPath addLineToPoint:CGPointMake(startPoint.x + powf(3, 0.5)*GCCircleRadius*1.2, startPoint.y - GCCircleRadius*2.4)];</div><div class="line">    [rectPath addLineToPoint:CGPointMake(startPoint.x + powf(3, 0.5)*GCCircleRadius*1.2, startPoint.y - 2)];</div><div class="line">    [rectPath addLineToPoint:CGPointMake(startPoint.x - 2.5, startPoint.y - 2)];</div><div class="line">    </div><div class="line">    CAShapeLayer *layer = [CAShapeLayer layer];</div><div class="line">    layer.path = rectPath.CGPath;</div><div class="line">    layer.lineWidth = 5;</div><div class="line">    layer.strokeColor = color;</div><div class="line">    layer.fillColor = [UIColor clearColor].CGColor;</div><div class="line">    [self addSublayer:layer];</div><div class="line">    </div><div class="line">    CABasicAnimation *rectAniamtion = [CABasicAnimation animationWithKeyPath:@&quot;strokeEnd&quot;];</div><div class="line">    rectAniamtion.fromValue = @(0.0);</div><div class="line">    rectAniamtion.toValue = @(1.0);</div><div class="line">    rectAniamtion.duration = 0.8;</div><div class="line">    rectAniamtion.delegate = self;</div><div class="line">    if (animationValue.length) &#123;</div><div class="line">        [rectAniamtion setValue:@&quot;rectAniamtion&quot; forKey:@&quot;animationName&quot;];</div><div class="line">    &#125;</div><div class="line">    [layer addAnimation:rectAniamtion forKey:nil];</div><div class="line">    </div><div class="line">    return rectAniamtion;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é—´éš”çš„è¯ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨<code>- performSelector: withObject: afterDelay:</code>æ¥å»¶è¿Ÿæ‰§è¡Œç¬¬äºŒæ¡è¾¹æ¡†çš„ç»˜åˆ¶å°±å¥½</p>
<h2 id="0x05__u6C34_u9762_u4E0A_u6DA8_u52A8_u753B"><a href="#0x05__u6C34_u9762_u4E0A_u6DA8_u52A8_u753B" class="headerlink" title="0x05 æ°´é¢ä¸Šæ¶¨åŠ¨ç”»"></a>0x05 æ°´é¢ä¸Šæ¶¨åŠ¨ç”»</h2><p>è¿™ä¸ªåŠ¨ç”»çš„å…³é”®å°±æ˜¯ç”¨<code>- addCurveToPoint: controlPoint1: controlPoint2:</code>æ–¹æ³•æ¥ç”»å‡ºæ°´æ³¢çš„çº¿ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯åˆ©ç”¨<code>controlPoint1</code>å’Œ<code>controlPoint2</code>è¿™ä¸¤ä¸ªç‚¹æ¥æ§åˆ¶å¼§åº¦æ–¹å‘ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/addCurveToPoint.png" alt=""></p>
<p>ç„¶åæˆ‘ä»¬åªéœ€è¦äº¤å‰æ”¹å˜<code>controlPoint1</code>å’Œ<code>controlPoint2</code>è¿™ä¸¤ä¸ªç‚¹åœ¨ä¸Šä¸‹çš„ä½ç½®å’Œ<code>startPoint</code>å’Œ<code>endPoint</code>çš„ä½ç½®ï¼Œå°±èƒ½æ„Ÿè§‰æ°´é¢ä¸Šæ¶¨çš„æ„Ÿè§‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSMutableArray &lt;UIBezierPath *&gt; *waterPathArray = [NSMutableArray array];</div><div class="line">for (NSInteger i = 0; i &lt; 11; i++) &#123;</div><div class="line">    UIBezierPath *water = [self water:i % 2 == 0 ? YES : NO withProgress:0.1*i];</div><div class="line">    [waterPathArray addObject:water];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ›å»ºå®Œæ¯•<code>path</code>ä¹‹åï¼Œå°†<code>anmations</code>æ”¾åˆ°<code>CAAnimationGroup</code>é‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (void)addWaterAnimation:(NSMutableArray &lt;UIBezierPath *&gt; *)waterArray &#123;</div><div class="line">    NSMutableArray &lt;CABasicAnimation *&gt; *animationArray = [NSMutableArray array];</div><div class="line">    for (NSInteger i = 0; i &lt; waterArray.count - 1; i++) &#123;</div><div class="line">        CABasicAnimation *waterAniamtion = [CABasicAnimation animationWithKeyPath:@&quot;path&quot;];</div><div class="line">        waterAniamtion.fromValue = (__bridge id _Nullable)(waterArray[i].CGPath);</div><div class="line">        waterAniamtion.toValue = (__bridge id _Nullable)(waterArray[i + 1].CGPath);</div><div class="line">        waterAniamtion.duration = 0.2;</div><div class="line">        waterAniamtion.beginTime = i == 0 ? 0.0 : animationArray[i - 1].beginTime + animationArray[i - 1].duration;</div><div class="line">        [animationArray addObject:waterAniamtion];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CAAnimationGroup *group = [CAAnimationGroup animation];</div><div class="line">    group.animations = animationArray;</div><div class="line">    group.duration = [animationArray lastObject].beginTime + [animationArray lastObject].duration;</div><div class="line">    group.fillMode = kCAFillModeForwards;</div><div class="line">    group.removedOnCompletion = NO;</div><div class="line">    group.delegate = self;</div><div class="line">    [group setValue:@&quot;waterAnimation&quot; forKey:@&quot;animationName&quot;];</div><div class="line">    [self.waterLayer addAnimation:group forKey:nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x06__u4E2D_u95F4_u77E9_u5F62_u653E_u5927_u81F3_u5168_u5C4F"><a href="#0x06__u4E2D_u95F4_u77E9_u5F62_u653E_u5927_u81F3_u5168_u5C4F" class="headerlink" title="0x06 ä¸­é—´çŸ©å½¢æ”¾å¤§è‡³å…¨å±"></a>0x06 ä¸­é—´çŸ©å½¢æ”¾å¤§è‡³å…¨å±</h2><p>å’Œå‰é¢ä¸€æ ·ï¼Œåˆ›å»ºå¥½å…¨å±å¤§å°çš„<code>path</code>ä¹‹åï¼Œç„¶ååŠ ä¸ŠåŠ¨ç”»å³å¯</p>
<h2 id="0x07__u4E2D_u95F4logo_u8DDF_u7740_u51FA_u73B0"><a href="#0x07__u4E2D_u95F4logo_u8DDF_u7740_u51FA_u73B0" class="headerlink" title="0x07 ä¸­é—´logoè·Ÿç€å‡ºç°"></a>0x07 ä¸­é—´logoè·Ÿç€å‡ºç°</h2><p>è¿™ä¸ªæ”¹å˜<code>bounds</code>å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CALayer *logoLayer = [CALayer layer];</div><div class="line">logoLayer.contents = (__bridge id _Nullable)([UIImage imageNamed:@&quot;logo.jpg&quot;].CGImage);</div><div class="line"></div><div class="line">logoLayer.frame = CGRectMake(GCLoadingLayerCenterX, GCLoadingLayerCenterY, 0, 0);</div><div class="line">[self addSublayer:logoLayer];</div><div class="line"></div><div class="line">CABasicAnimation *logoAnimation = [CABasicAnimation animationWithKeyPath:@&quot;bounds&quot;];</div><div class="line">logoAnimation.toValue = [NSValue valueWithCGRect:CGRectMake(GCLoadingLayerCenterX, GCLoadingLayerCenterY, 100, 120)];</div><div class="line">logoAnimation.duration = 0.2;</div><div class="line">logoAnimation.beginTime = 0.0;</div><div class="line">logoAnimation.removedOnCompletion = NO;</div><div class="line">logoAnimation.fillMode = kCAFillModeForwards;</div><div class="line">[logoLayer addAnimation:logoAnimation forKey:nil];</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªåŠ è½½åŠ¨ç”»çš„ç¼ºç‚¹å°±æ˜¯åœ¨åŠ è½½æ—¶æ²¡æœ‰å¯å®šåˆ¶åŒ–çš„å½¢çŠ¶ï¼Œåªèƒ½ä¿®æ”¹åœ†å½¢ç­‰çš„é¢œè‰²ï¼Œå¦‚æœè¦æ”¹å˜å½¢çŠ¶ï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°åŠ¨æ•ˆçš„æ”¹åŠ¨ï¼Œæ‰€ä»¥è¿™ä¸ªåŠ¨ç”»åªèƒ½ä½œä¸ºå­¦ä¹ åˆ†æå‚è€ƒ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¥½ä¹…æ²¡å†™åŠ¨ç”»äº†â€¦æœ€è¿‘æ‰’äº†ä¸‹ä»¥å‰æ²¡æœ‰å†™çš„åŠ¨ç”»æ•ˆæœï¼Œæƒ³æƒ³ä»æœ€è€çš„å¼€å§‹å†™å§ï¼Œä¹‹å‰çœ‹åˆ°çš„ç‰ˆæœ¬æ˜¯ç”¨Swiftå†™çš„ï¼Œæ²¡ä»”ç»†æ‰¾æœ‰æ²¡æœ‰OCç‰ˆçš„ï¼Œæ‰€ä»¥å¹²è„†è‡ªå·±ç»ƒä¹ ä¸€ä¸‹å§ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ•ˆæœï¼š&lt;/p&gt;
&lt;p&gt;(è¿™é‡Œä¸‰è§’å½¢æ˜¯æ—‹è½¬åŠ¨ç”»ï¼Œä½†æ˜¯Gifå½•å‡ºæ¥çœ‹ä¸Šå»æ˜¯æŠ–äº†ä¸¤ä¸‹â€¦)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/GCLoadingAnimationOne.gif!500x500&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥ç›´æ¥runä¸‹ä»£ç ï¼Œçœ‹ä¸‹æ•ˆæœï¼š&lt;a href=&quot;https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationOne&quot;&gt;https://github.com/Yuzeyang/GCLoadingAnimation/tree/master/GCLoadingAnimationOne&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘æ¥åˆ†æä¸‹è¿‡ç¨‹&lt;/p&gt;
    
    </summary>
    
    
      <category term="åŠ è½½åŠ¨ç”»" scheme="http://yuzeyang.github.io/tags/%E5%8A%A0%E8%BD%BD%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>FMDBåˆæ¢ï¼ˆäºŒï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/07/23/FMDB-two/"/>
    <id>http://yuzeyang.github.io/2016/07/23/FMDB-two/</id>
    <published>2016-07-23T08:38:23.000Z</published>
    <updated>2016-07-23T10:31:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>FMResultSet</code>ç”¨æ¥æ‰§è¡ŒSQLè¯­å¥ç»“æœçš„æŸ¥è¯¢</p>
<p><code>FMDatabaseQueue</code>ç”¨ä¸åŒçš„çº¿ç¨‹æ¥æ‰§è¡Œè‹¥å¹²ä¸ªæŸ¥è¯¢å’Œæ›´æ–°æ“ä½œ</p>
<p><code>FMDatabasePool</code>å’Œ<code>FMDatabaseQueue</code>ç±»ä¼¼ï¼Œä½†æ˜¯åªæ˜¯ç”¨åœ¨æ•°æ®åº“åªè¯»æ“ä½œä¸Š</p>
<a id="more"></a>
<h2 id="FMResultSet"><a href="#FMResultSet" class="headerlink" title="FMResultSet"></a>FMResultSet</h2><p>ä¸»è¦æ˜¯æ ¹æ®<code>columnName</code>åˆ—å/<code>columnIdx</code>åˆ—ç´¢å¼•è·å–åˆ°ç›¸åº”æ•°æ®æ ¼å¼çš„æ•°æ®ï¼Œä»¥åŠä½¿ç”¨<code>- next</code>æ–¹æ³•ï¼Œå°†æŸ¥è¯¢ç»“æœé€è¡Œè¾“å…¥</p>
<h4 id="u521D_u59CB_u5316"><a href="#u521D_u59CB_u5316" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)resultSetWithStatement:(FMStatement *)statement usingParentDatabase:(FMDatabase*)aDB &#123;</div><div class="line">    // åˆå§‹åŒ–FMResultSetå¯¹è±¡</div><div class="line">    FMResultSet *rs = [[FMResultSet alloc] init];</div><div class="line">    // è®¾ç½®preparedè¯­å¥å’Œdb</div><div class="line">    [rs setStatement:statement];</div><div class="line">    [rs setParentDB:aDB];</div><div class="line">    // è®¾ç½®preparedè¯­å¥æ­£åœ¨ä½¿ç”¨</div><div class="line">    NSParameterAssert(![statement inUse]);</div><div class="line">    [statement setInUse:YES]; // weak reference</div><div class="line">    </div><div class="line">    return FMDBReturnAutoreleased(rs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u83B7_u53D6_u7ED3_u679C"><a href="#u83B7_u53D6_u7ED3_u679C" class="headerlink" title="è·å–ç»“æœ"></a>è·å–ç»“æœ</h4><p>è¿”å›ç»“æœçš„æ•°æ®ç±»å‹æœ‰å¾ˆå¤šç§ï¼šé™¤äº†åŸºæœ¬æ•°æ®ç±»å‹ä¹‹å¤–ï¼Œè¿˜æœ‰<code>NSString</code>ã€<code>NSDate</code>ã€<code>NSData</code></p>
<p>æ¯”å¦‚ä»¥ä¸‹ä¸¤ä¸ªæ¥å£<code>- intForColumn:</code>å®é™…ä¸Šè°ƒç”¨çš„è¿˜æ˜¯<code>- intForColumnIndex:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (int)intForColumn:(NSString*)columnName &#123;</div><div class="line">    return [self intForColumnIndex:[self columnIndexForName:columnName]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (int)intForColumnIndex:(int)columnIdx &#123;</div><div class="line">    return sqlite3_column_int([_statement statement], columnIdx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡è°ƒç”¨<code>- columnIndexForName:</code>æ–¹æ³•ï¼Œç”¨åˆ—åæ¥è·å¾—åˆ—ç´¢å¼•ï¼Œè¿™å±‚æ˜ å°„å…³ç³»éƒ½æ˜¯å­˜åœ¨<code>_columnNameToIndexMap</code>å­—å…¸é‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (int)columnIndexForName:(NSString*)columnName &#123;</div><div class="line">    columnName = [columnName lowercaseString];</div><div class="line">    </div><div class="line">    NSNumber *n = [[self columnNameToIndexMap] objectForKey:columnName];</div><div class="line">    </div><div class="line">    if (n) &#123;</div><div class="line">        return [n intValue];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSLog(@&quot;Warning: I could not find the column named &apos;%@&apos;.&quot;, columnName);</div><div class="line">    </div><div class="line">    return -1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMutableDictionary *)columnNameToIndexMap &#123;</div><div class="line">    if (!_columnNameToIndexMap) &#123;</div><div class="line">        int columnCount = sqlite3_column_count([_statement statement]);</div><div class="line">        _columnNameToIndexMap = [[NSMutableDictionary alloc] initWithCapacity:(NSUInteger)columnCount];</div><div class="line">        int columnIdx = 0;</div><div class="line">        for (columnIdx = 0; columnIdx &lt; columnCount; columnIdx++) &#123;</div><div class="line">            // åˆ—åä½œä¸ºkeyï¼Œå¯¹åº”çš„åˆ—å·ä½œä¸ºvalue</div><div class="line">            [_columnNameToIndexMap setObject:[NSNumber numberWithInt:columnIdx]</div><div class="line">                                      forKey:[[NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)] lowercaseString]];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return _columnNameToIndexMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u9010_u884C_u8FD4_u56DE_u7ED3_u679C"><a href="#u9010_u884C_u8FD4_u56DE_u7ED3_u679C" class="headerlink" title="é€è¡Œè¿”å›ç»“æœ"></a>é€è¡Œè¿”å›ç»“æœ</h4><p><code>- next</code>æ–¹æ³•æœ¬è´¨æ˜¯è°ƒç”¨<code>- nextWithError</code>ï¼Œ<code>FMDB</code>é‡Œé¢æœ‰çš„æ³¨é‡Šå†™çš„è¿˜æ˜¯æŒºé€—çš„ï¼Œè¿<code>wtf</code>éƒ½æœ‰â€¦å“ˆå“ˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">- (BOOL)nextWithError:(NSError **)outErr &#123;</div><div class="line">    /* Call sqlite3_step() to run the virtual machine. Since the SQL being</div><div class="line">     ** executed is not a SELECT statement, we assume no data will be returned.</div><div class="line">     */</div><div class="line">    // sqlite3_prepareå‡½æ•°å°†SQLå‘½ä»¤å­—ç¬¦ä¸²è§£æå¹¶è½¬æ¢ä¸ºä¸€ç³»åˆ—çš„å‘½ä»¤å­—èŠ‚ç ï¼Œè¿™äº›å­—èŠ‚ç æœ€ç»ˆè¢«ä¼ é€åˆ°SQlite3çš„è™šæ‹Ÿæ•°æ®åº“å¼•æ“ï¼ˆVDBE: Virtual Database Engineï¼‰ä¸­æ‰§è¡Œï¼Œå®Œæˆè¿™é¡¹å·¥ä½œçš„æ˜¯sqlite3_stepå‡½æ•°ã€‚æ¯”å¦‚ä¸€ä¸ªSELECTæŸ¥è¯¢æ“ä½œï¼Œsqlite3_stepå‡½æ•°çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ç»“æœé›†ä¸­çš„å…¶ä¸­ä¸€è¡Œï¼Œç›´åˆ°å†æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¡Œäº†ã€‚æ¯æ¬¡è°ƒç”¨sqlite3_stepå‡½æ•°å¦‚æœè¿”å›SQLITE_ROWï¼Œä»£è¡¨è·å¾—äº†æœ‰æ•ˆæ•°æ®è¡Œï¼Œå¯ä»¥é€šè¿‡sqlite3_columnå‡½æ•°æå–æŸåˆ—çš„å€¼ã€‚å¦‚æœè°ƒç”¨sqlite3_stepå‡½æ•°è¿”å›SQLITE_DONEï¼Œåˆ™ä»£è¡¨preparedè¯­å¥å·²ç»æ‰§è¡Œåˆ°ç»ˆç‚¹äº†ï¼Œæ²¡æœ‰æœ‰æ•ˆæ•°æ®äº†ã€‚å¾ˆå¤šå‘½ä»¤ç¬¬ä¸€æ¬¡è°ƒç”¨sqlite3_stepå‡½æ•°å°±ä¼šè¿”å›SQLITE_DONEï¼Œå› ä¸ºè¿™äº›SQLå‘½ä»¤ä¸ä¼šè¿”å›æ•°æ®ã€‚å¯¹äºINSERTï¼ŒUPDATEï¼ŒDELETEå‘½ä»¤ï¼Œä¼šè¿”å›å®ƒä»¬æ‰€ä¿®æ”¹çš„è¡Œå·â€”â€”ä¸€ä¸ªå•è¡Œå•åˆ—çš„å€¼ã€‚</div><div class="line">    /**</div><div class="line">     SQLITE_BUSY æ•°æ®åº“æ–‡ä»¶æœ‰é”</div><div class="line">     SQLITE_LOCKED æ•°æ®åº“ä¸­çš„æŸå¼ è¡¨æœ‰é”</div><div class="line">     SQLITE_DONE sqlite3_step()æ‰§è¡Œå®Œæ¯•</div><div class="line">     SQLITE_ROW sqlite3_step()è·å–åˆ°ä¸‹ä¸€è¡Œæ•°æ®</div><div class="line">     SQLITE_ERROR ä¸€èˆ¬ç”¨äºæ²¡æœ‰ç‰¹åˆ«æŒ‡å®šé”™è¯¯ç çš„é”™è¯¯ï¼Œå°±æ˜¯è¯´å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†æ— æ³•çŸ¥é“é”™è¯¯å‘ç”Ÿçš„åŸå› ã€‚</div><div class="line">     SQLITE_MISUSE æ²¡æœ‰æ­£ç¡®ä½¿ç”¨SQLiteæ¥å£ï¼Œæ¯”å¦‚ä¸€æ¡è¯­å¥åœ¨sqlite3_stepå‡½æ•°æ‰§è¡Œä¹‹åï¼Œæ²¡æœ‰è¢«é‡ç½®ä¹‹å‰ï¼Œå†æ¬¡ç»™å…¶ç»‘å®šå‚æ•°ï¼Œè¿™æ—¶bindå‡½æ•°å°±ä¼šè¿”å›SQLITE_MISUSEã€‚</div><div class="line">     **/</div><div class="line">    int rc = sqlite3_step([_statement statement]);</div><div class="line">    </div><div class="line">    if (SQLITE_BUSY == rc || SQLITE_LOCKED == rc) &#123;</div><div class="line">        NSLog(@&quot;%s:%d Database busy (%@)&quot;, __FUNCTION__, __LINE__, [_parentDB databasePath]);</div><div class="line">        NSLog(@&quot;Database busy&quot;);</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [_parentDB lastError];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else if (SQLITE_DONE == rc || SQLITE_ROW == rc) &#123;</div><div class="line">        // all is well, let&apos;s return.</div><div class="line">    &#125;</div><div class="line">    else if (SQLITE_ERROR == rc) &#123;</div><div class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [_parentDB lastError];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else if (SQLITE_MISUSE == rc) &#123;</div><div class="line">        // uh oh.</div><div class="line">        NSLog(@&quot;Error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</div><div class="line">        if (outErr) &#123;</div><div class="line">            if (_parentDB) &#123;</div><div class="line">                *outErr = [_parentDB lastError];</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                // If &apos;next&apos; or &apos;nextWithError&apos; is called after the result set is closed,</div><div class="line">                // we need to return the appropriate error.</div><div class="line">                NSDictionary* errorMessage = [NSDictionary dictionaryWithObject:@&quot;parentDB does not exist&quot; forKey:NSLocalizedDescriptionKey];</div><div class="line">                *outErr = [NSError errorWithDomain:@&quot;FMDatabase&quot; code:SQLITE_MISUSE userInfo:errorMessage];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        // wtf?</div><div class="line">        NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) rs&quot;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [_parentDB lastError];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    if (rc != SQLITE_ROW) &#123;</div><div class="line">        [self close];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return (rc == SQLITE_ROW);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">while ([rs next]) &#123;</div><div class="line">    NSString *file = [rs stringForColumn:@&quot;file&quot;];</div><div class="line">    NSLog(@&quot;database_list: %@&quot;, file);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="FMDatabaseQueue"><a href="#FMDatabaseQueue" class="headerlink" title="FMDatabaseQueue"></a>FMDatabaseQueue</h2><p>æ˜¯ç”¨æ¥å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡ŒSQLè¯­å¥</p>
<h4 id="u521D_u59CB_u5316-1"><a href="#u521D_u59CB_u5316-1" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>å¤´æ–‡ä»¶é‡Œæä¾›äº†å¾ˆå¤šç§åˆå§‹åŒ–æ–¹æ³•ï¼Œä½†æ˜¯æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯<code>(instancetype)initWithPath:(NSString*)aPath flags:(int)openFlags vfs:(NSString *)vfsName</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithPath:(NSString*)aPath flags:(int)openFlags vfs:(NSString *)vfsName &#123;</div><div class="line">    </div><div class="line">    self = [super init];</div><div class="line">    </div><div class="line">    if (self != nil) &#123;</div><div class="line">        // æ ¹æ®æŒ‡å®šè·¯å¾„å¯»æ‰¾æ•°æ®åº“ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è¿”å›dbï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</div><div class="line">        _db = [[[self class] databaseClass] databaseWithPath:aPath];</div><div class="line">        FMDBRetain(_db);</div><div class="line">        </div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3005000</div><div class="line">        BOOL success = [_db openWithFlags:openFlags vfs:vfsName];</div><div class="line">#else</div><div class="line">        BOOL success = [_db open];</div><div class="line">#endif</div><div class="line">        if (!success) &#123;</div><div class="line">            NSLog(@&quot;Could not create database queue for path %@&quot;, aPath);</div><div class="line">            FMDBRelease(self);</div><div class="line">            return 0x00;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        _path = FMDBReturnRetained(aPath);</div><div class="line">        // åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—</div><div class="line">        _queue = dispatch_queue_create([[NSString stringWithFormat:@&quot;fmdb.%@&quot;, self] UTF8String], NULL);</div><div class="line">        // ç»™_queueé˜Ÿåˆ—æŒ‡å®šäº†kDispatchQueueSpecificKeyå­—ç¬¦ä¸²ï¼Œå¹¶å’Œselfç»‘å®šï¼Œåé¢å¯ä»¥é€šè¿‡kDispatchQueueSpecificKeyè·å–åˆ°selfï¼Œä½†è¦ä¿è¯æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—æ˜¯è¿™ä¸ª_queue</div><div class="line">        dispatch_queue_set_specific(_queue, kDispatchQueueSpecificKey, (__bridge void *)self, NULL);</div><div class="line">        _openFlags = openFlags;</div><div class="line">        _vfsName = [vfsName copy];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FMDatabaseQueue *queue = [FMDatabaseQueue databaseQueueWithPath:dbPath];</div></pre></td></tr></table></figure>
<h4 id="u64CD_u4F5C_u6570_u636E_u5E93"><a href="#u64CD_u4F5C_u6570_u636E_u5E93" class="headerlink" title="æ“ä½œæ•°æ®åº“"></a>æ“ä½œæ•°æ®åº“</h4><p>æƒ³è¦å¤šçº¿ç¨‹æ“ä½œæ•°æ®åº“æ—¶ï¼Œä¸æ˜¯ç›´æ¥ä½¿ç”¨<code>FMDatabase</code>å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡<code>FMDatabaseQueue</code>å¯¹è±¡ï¼Œè°ƒç”¨<code>- inDatabas:</code>ï¼Œé€šè¿‡<code>block</code>è¿”å›<code>FMDatabase</code>å¯¹è±¡æ¥æ“ä½œï¼Œè™½ç„¶<code>- inDatabas:</code>å†…æ˜¯åŒæ­¥æ“ä½œï¼Œä½†æ˜¯çº¿ç¨‹ä¹‹é—´æ˜¯å¹¶è¡Œçš„ï¼Œå°±ç›¸å½“äºé©¬è·¯ä¸Šæœ‰ä¸¤æ¡å•è¡Œçš„è·¯ï¼Œè™½ç„¶æ¯æ¡è·¯ä¸Šçš„è½¦éƒ½æ˜¯ä¸€è¾†æ¥ä¸€è¾†çš„ï¼Œä½†æ˜¯ä¸¤æ¡è·¯ä¹‹é—´æ˜¯äº’ä¸å½±å“çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (void)inDatabase:(void (^)(FMDatabase *db))block &#123;</div><div class="line">    // é€šè¿‡kDispatchQueueSpecificKeyæ¥è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ£€æŸ¥å’Œselfåšæ¯”è¾ƒï¼Œç¡®ä¿æ²¡æœ‰å‘ç”Ÿæ­»é”ï¼Œå› ä¸ºå¯ä»¥åˆ›å»ºå¤šä¸ªFMDatabaseQueueå¤šä¸ªæ¥æ‰§è¡Œä¸åŒçš„SQLè¯­å¥</div><div class="line">    FMDatabaseQueue *currentSyncQueue = (__bridge id)dispatch_get_specific(kDispatchQueueSpecificKey);</div><div class="line">    assert(currentSyncQueue != self &amp;&amp; &quot;inDatabase: was called reentrantly on the same queue, which would lead to a deadlock&quot;);</div><div class="line">    </div><div class="line">    FMDBRetain(self);</div><div class="line">    // åœ¨å½“å‰queueä¸­ï¼ŒåŒæ­¥æ‰§è¡Œblock</div><div class="line">    dispatch_sync(_queue, ^() &#123;</div><div class="line">        </div><div class="line">        FMDatabase *db = [self database];</div><div class="line">        block(db);</div><div class="line">        </div><div class="line">        if ([db hasOpenResultSets]) &#123;</div><div class="line">            NSLog(@&quot;Warning: there is at least one open result set around after performing [FMDatabaseQueue inDatabase:]&quot;);</div><div class="line">            </div><div class="line">#if defined(DEBUG) &amp;&amp; DEBUG</div><div class="line">            NSSet *openSetCopy = FMDBReturnAutoreleased([[db valueForKey:@&quot;_openResultSets&quot;] copy]);</div><div class="line">            for (NSValue *rsInWrappedInATastyValueMeal in openSetCopy) &#123;</div><div class="line">                FMResultSet *rs = (FMResultSet *)[rsInWrappedInATastyValueMeal pointerValue];</div><div class="line">                NSLog(@&quot;query: &apos;%@&apos;&quot;, [rs query]);</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    FMDBRelease(self);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[queue inDatabase:^(FMDatabase *adb) &#123;</div><div class="line">    [adb executeUpdate:@&quot;create table qfoo (foo text)&quot;];</div><div class="line">    [adb executeUpdate:@&quot;insert into qfoo values (&apos;hi&apos;)&quot;];</div><div class="line">    [adb executeUpdate:@&quot;insert into qfoo values (&apos;hello&apos;)&quot;];</div><div class="line">    [adb executeUpdate:@&quot;insert into qfoo values (&apos;not&apos;)&quot;];</div><div class="line"></div><div class="line">	int count = 0;</div><div class="line">    FMResultSet *rsl = [adb executeQuery:@&quot;select * from qfoo where foo like &apos;h%&apos;&quot;];</div><div class="line">    while ([rsl next]) &#123;</div><div class="line">        count++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    FMDBQuickCheck(count == 2);</div><div class="line"></div><div class="line">    count = 0;</div><div class="line">    rsl = [adb executeQuery:@&quot;select * from qfoo where foo like ?&quot;, @&quot;h%&quot;];</div><div class="line">    while ([rsl next]) &#123;</div><div class="line">        count++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    FMDBQuickCheck(count == 2);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h4 id="u4E8B_u52A1_u5904_u7406"><a href="#u4E8B_u52A1_u5904_u7406" class="headerlink" title="äº‹åŠ¡å¤„ç†"></a>äº‹åŠ¡å¤„ç†</h4><p>å’Œ<code>FMDatabase</code>ä¸€æ ·ï¼Œä¹Ÿæœ‰äº‹åŠ¡çš„å¤„ç†ï¼Œåˆ†ä¸ºexclusiveäº‹åŠ¡å’Œdeferredäº‹åŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (void)inDeferredTransaction:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;</div><div class="line">    [self beginTransaction:YES withBlock:block];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)inTransaction:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;</div><div class="line">    [self beginTransaction:NO withBlock:block];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)beginTransaction:(BOOL)useDeferred withBlock:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;</div><div class="line">    FMDBRetain(self);</div><div class="line">    dispatch_sync(_queue, ^() &#123; </div><div class="line">        </div><div class="line">        BOOL shouldRollback = NO;</div><div class="line">        // æ˜¯å¦ä½¿ç”¨å»¶è¿Ÿäº‹åŠ¡</div><div class="line">        if (useDeferred) &#123;</div><div class="line">            [[self database] beginDeferredTransaction];</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            [[self database] beginTransaction];</div><div class="line">        &#125;</div><div class="line">        // å¦‚æœæ•°æ®åº“æ“ä½œå‡ºé”™äº†ï¼Œä½ å¯ä»¥è®¾ç½®æ˜¯å¦éœ€è¦å›æ»šï¼Œå›æ»šåˆ°æ“ä½œä¹‹å‰çš„å†…å®¹</div><div class="line">        block([self database], &amp;shouldRollback);</div><div class="line">        </div><div class="line">        if (shouldRollback) &#123;</div><div class="line">            [[self database] rollback];</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // å¦‚æœä¸éœ€è¦å›æ»šï¼Œåˆ™commitæäº¤ç›¸åº”çš„sqlæ“ä½œ</div><div class="line">            [[self database] commit];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    FMDBRelease(self);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[queue inTransaction:^(FMDatabase *adb, BOOL *rollback) &#123;</div><div class="line">    NSLog(@&quot;Starting query  %ld&quot;, nby);</div><div class="line"></div><div class="line">    FMResultSet *rsl = [adb executeQuery:@&quot;select * from qfoo where foo like &apos;h%&apos;&quot;];</div><div class="line">    while ([rsl next]) &#123;</div><div class="line">        ;// whatever.</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    NSLog(@&quot;Ending query    %ld&quot;, nby);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h2 id="FMDatabasePool"><a href="#FMDatabasePool" class="headerlink" title="FMDatabasePool"></a>FMDatabasePool</h2><blockquote>
<p>If you really really really know what youâ€™re doing and <code>FMDatabasePool</code> is what  you really really need (ie, youâ€™re using a read only database), OK you can use it.  But just be careful not to deadlock!</p>
</blockquote>
<p>å¯¹ï¼Œè¿™å°±æ˜¯<code>FMDatabasePool</code>çš„æè¿°ï¼Œåªèƒ½ç”¨äºæ•°æ®åº“åªè¯»æ“ä½œï¼Œå¦‚æœè¿›è¡Œäº†å†™æ“ä½œï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°æ­»é”ï¼Œä¹±ç”¨æä¸å¥½å°±è·ªäº†â€¦</p>
<p>é‡Œé¢çš„æ–¹æ³•åŸºæœ¬å’Œ<code>FMDatabaseQueue</code>å·®ä¸å¤šï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªç‰¹åˆ«çš„å±æ€§ï¼š<code>_databaseInPool</code>å’Œ<code>_databaseOutPool</code>ï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œè¿™ä¸¤ä¸ªå±æ€§çš„ä½œç”¨å°±åƒæ˜¯ä¸€ä¸ªç”¨æ¥å­˜æ”¾é—²ç½®çš„dbï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥å­˜æ”¾æ­£åœ¨æ‰§è¡Œæ“ä½œçš„dbï¼Œåœ¨<code>- inDatabase:</code>ç­‰è¿™äº›æ–¹æ³•æœ€åéƒ½è°ƒç”¨äº†<code>- pushDatabaseBackInPool:</code>æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">// å°†dbæ”¾å›InPoolé‡Œé¢</div><div class="line">- (void)pushDatabaseBackInPool:(FMDatabase*)db &#123;</div><div class="line">    </div><div class="line">    if (!db) &#123; // db can be null if we set an upper bound on the # of databases to create.</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    // åŒæ­¥æ‰§è¡Œ</div><div class="line">    [self executeLocked:^() &#123;</div><div class="line">        // å¦‚æœInPoolæ•°ç»„é‡Œé¢åŒ…å«dbï¼Œè¯´æ˜dbå·²ç»åœ¨InPoolé‡Œé¢ï¼Œä¸éœ€è¦å†æ”¾å›InPoolé‡Œï¼Œå¹¶ä¸”æŠ›å‡ºå¼‚å¸¸ï¼Œä¸‹é¢çš„æ“ä½œå°±ä¸è¿›è¡Œäº†</div><div class="line">        if ([self-&gt;_databaseInPool containsObject:db]) &#123;</div><div class="line">            [[NSException exceptionWithName:@&quot;Database already in pool&quot; reason:@&quot;The FMDatabase being put back into the pool is already present in the pool&quot; userInfo:nil] raise];</div><div class="line">        &#125;</div><div class="line">        // å¦‚æœdbä¸åœ¨InPoolé‡Œé¢ï¼ŒæŠŠdbåŠ åˆ°InPoolæ•°ç»„ï¼Œå¹¶ä¸”ä»OutPoolä¸­ç§»é™¤</div><div class="line">        [self-&gt;_databaseInPool addObject:db];</div><div class="line">        [self-&gt;_databaseOutPool removeObject:db];</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (FMDatabase*)db &#123;</div><div class="line">    </div><div class="line">    __block FMDatabase *db;</div><div class="line">    </div><div class="line">    </div><div class="line">    [self executeLocked:^() &#123;</div><div class="line">        // ä»_databaseInPoolé‡Œé¢å–å‡ºæœ€åä¸€ä¸ªFMDatabaseå¯¹è±¡</div><div class="line">        db = [self-&gt;_databaseInPool lastObject];</div><div class="line">        </div><div class="line">        BOOL shouldNotifyDelegate = NO;</div><div class="line">        // å¦‚æœdbå­˜åœ¨ï¼Œåˆ™åŠ åˆ°_databaseOutPoolé‡Œï¼Œ_databaseInPoolç§»é™¤æ‰ï¼Œæˆ‘çš„ç†è§£æ˜¯_databaseOutPoolæ˜¯ç”¨äºå­˜æ”¾æ­£åœ¨æ‰§è¡Œæ“ä½œçš„dbæ± ï¼Œ_databaseInPoolåˆ™å­˜æ”¾é—²ç½®çš„dbæ± </div><div class="line">        // åœ¨éœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼Œä»é—²ç½®çš„æ± é‡Œé¢å–å‡ºæ¥æ”¾åˆ°æ­£åœ¨æ‰§è¡Œçš„æ± é‡Œé¢</div><div class="line">        if (db) &#123;</div><div class="line">            [self-&gt;_databaseOutPool addObject:db];</div><div class="line">            [self-&gt;_databaseInPool removeLastObject];</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // æ£€æŸ¥æœ€å¤§åˆ›å»ºçš„dbæ•°é‡ï¼Œè¶…è¿‡äº†åˆ™è¿”å›ï¼Œå¦åˆ™å°±æ ¹æ®è·¯å¾„ï¼Œæ‰¾åˆ°db</div><div class="line">            if (self-&gt;_maximumNumberOfDatabasesToCreate) &#123;</div><div class="line">                NSUInteger currentCount = [self-&gt;_databaseOutPool count] + [self-&gt;_databaseInPool count];</div><div class="line">                </div><div class="line">                if (currentCount &gt;= self-&gt;_maximumNumberOfDatabasesToCreate) &#123;</div><div class="line">                    NSLog(@&quot;Maximum number of databases (%ld) has already been reached!&quot;, (long)currentCount);</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            db = [[[self class] databaseClass] databaseWithPath:self-&gt;_path];</div><div class="line">            shouldNotifyDelegate = YES;</div><div class="line">        &#125;</div><div class="line">        // æ ¹æ®_openFlagså’Œ_vfsNameæ‰“å¼€db</div><div class="line">        //This ensures that the db is opened before returning</div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3005000</div><div class="line">        BOOL success = [db openWithFlags:self-&gt;_openFlags vfs:self-&gt;_vfsName];</div><div class="line">#else</div><div class="line">        BOOL success = [db open];</div><div class="line">#endif</div><div class="line">        if (success) &#123;</div><div class="line">            // å¦‚æœä»£ç†æ–¹æ³•å“åº”äº†ï¼Œä½†æ˜¯dbä¸å…è®¸è¢«åŠ åˆ°poolé‡Œé¢ï¼Œé‚£ä¹ˆdbå…³é—­é‡Šæ”¾</div><div class="line">            if ([self-&gt;_delegate respondsToSelector:@selector(databasePool:shouldAddDatabaseToPool:)] &amp;&amp; ![self-&gt;_delegate databasePool:self shouldAddDatabaseToPool:db]) &#123;</div><div class="line">                [db close];</div><div class="line">                db = 0x00;</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                //It should not get added in the pool twice if lastObject was found</div><div class="line">                // å¯¹äºæ–°åˆ›å»ºçš„dbï¼Œéœ€è¦åŠ åˆ°_databaseOutPoolé‡Œï¼Œè€Œä¸éœ€è¦åŠ åˆ°_databaseInPoolé‡Œ</div><div class="line">                if (![self-&gt;_databaseOutPool containsObject:db]) &#123;</div><div class="line">                    [self-&gt;_databaseOutPool addObject:db];</div><div class="line">                    // æ–°åˆ›å»ºçš„dbéœ€è¦å“åº”delegate</div><div class="line">                    if (shouldNotifyDelegate &amp;&amp; [self-&gt;_delegate respondsToSelector:@selector(databasePool:didAddDatabase:)]) &#123;</div><div class="line">                        [self-&gt;_delegate databasePool:self didAddDatabase:db];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            NSLog(@&quot;Could not open up the database at path %@&quot;, self-&gt;_path);</div><div class="line">            db = 0x00;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    return db;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;FMResultSet&lt;/code&gt;ç”¨æ¥æ‰§è¡ŒSQLè¯­å¥ç»“æœçš„æŸ¥è¯¢&lt;/p&gt;
&lt;p&gt;&lt;code&gt;FMDatabaseQueue&lt;/code&gt;ç”¨ä¸åŒçš„çº¿ç¨‹æ¥æ‰§è¡Œè‹¥å¹²ä¸ªæŸ¥è¯¢å’Œæ›´æ–°æ“ä½œ&lt;/p&gt;
&lt;p&gt;&lt;code&gt;FMDatabasePool&lt;/code&gt;å’Œ&lt;code&gt;FMDatabaseQueue&lt;/code&gt;ç±»ä¼¼ï¼Œä½†æ˜¯åªæ˜¯ç”¨åœ¨æ•°æ®åº“åªè¯»æ“ä½œä¸Š&lt;/p&gt;
    
    </summary>
    
    
      <category term="FMDB" scheme="http://yuzeyang.github.io/tags/FMDB/"/>
    
  </entry>
  
  <entry>
    <title>FMDBåˆæ¢ï¼ˆä¸€ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/07/23/FMDB-one/"/>
    <id>http://yuzeyang.github.io/2016/07/23/FMDB-one/</id>
    <published>2016-07-23T04:11:21.000Z</published>
    <updated>2016-07-24T10:49:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¹‹å‰çš„<a href="http://zeeyang.com/2016/06/22/GCDAsyncSocket-socket-optimize/" target="_blank" rel="external">iOS Socketé‡æ„è®¾è®¡</a>é‡Œé¢æˆ‘æœ‰æåˆ°æˆ‘ä»¬ä½¿ç”¨äº†FMDBåšæ¶ˆæ¯ç¼“å­˜ï¼Œåœ¨æ•°æ®åº“é€‰å‹æ–¹é¢ï¼Œæˆ‘ä»¬<a href="http://broccoliii.me/" target="_blank" rel="external">è¥¿å…°èŠ±</a>ä¹Ÿå¯¹ç›®å‰æ¯”è¾ƒæµè¡Œå’Œæˆç†Ÿçš„<code>Realm</code>ã€<code>FMDB</code>å’Œ<code>Core Data</code>åšäº†è°ƒæŸ¥ï¼Œé‡Œé¢åŒ…æ‹¬äº†å®‰è£…ã€ä½¿ç”¨å’Œæ€§èƒ½æ¯”è¾ƒï¼Œæ˜¯ä¸ªä¸é”™çš„å‚è€ƒä¾‹å­</p>
<p>åœ¨é€‰å‹æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å¤šé€‰å–å‡ ä¸ªä½œä¸ºå¯¹æ¯”ï¼Œä»ä½¿ç”¨æ–¹é¢è¯„ä¼°å­¦ä¹ æˆæœ¬ï¼Œé€šè¿‡æµ‹è¯•ä¸åŒæ•°æ®åº“æ“ä½œæ¥æ¯”è¾ƒæ€§èƒ½å·®å¼‚ï¼Œäº†è§£æœ‰å“ªäº›å¤§å‹çš„Appä½¿ç”¨äº†è¯¥æ•°æ®åº“ä»¥åŠè¯„ä»·æ¥ä¾§é¢è¯´æ˜è¯¥æ•°æ®åº“çš„æˆç†Ÿåº¦å’Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜ï¼Œæœ€åæ ¹æ®è‡ªå·±å®é™…çš„ä¸šåŠ¡éœ€æ±‚æ¥é€‰å‹</p>
<p>åœ¨é€‰å®šä½¿ç”¨<code>FMDB</code>ä¹‹åï¼Œæˆ‘ä¹Ÿåªæ˜¯ç®€å•çš„äº†è§£ä¸‹<code>FMDB</code>çš„ä½¿ç”¨ï¼Œå¹¶æœªå¯¹å†…éƒ¨çš„å®ç°å’Œè®¾è®¡æ€è·¯åšæ·±å…¥äº†è§£ï¼Œä½†æ˜¯åœ¨é˜…è¯»äº†ä»£ç ä¹‹åï¼Œ<code>FMDB</code>ç¡®å®åƒå…¶ä»–åšå®¢é‡Œé¢æåˆ°çš„é‚£æ ·ï¼Œæ˜¯å¯¹åŸç”Ÿçš„SQLite APIè¿›è¡Œäº†åŒ…è£…ï¼Œæš´éœ²å‡ºç›¸å¯¹å‹å¥½çš„å¯¹å¤–æ¥å£ï¼Œåªéœ€ä¼ å…¥SQLè¯­å¥å³å¯(ä½†æ˜¯å¯¹äºä¹ æƒ¯äºä½¿ç”¨Modelæ“ä½œçš„æˆ‘ä»¬æ¥è¯´ï¼Œç›´æ¥å†™SQLè¯­å¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œæ‰€ä»¥GitHubä¸Šä¹Ÿå°±åº“å¯¹<code>FMDB</code>è¿›è¡Œäº†å°è£…ï¼Œçœå»å†™SQLè¯­å¥ï¼Œç›´æ¥å¯¹Modelè¿›è¡Œæ“ä½œ)ï¼Œå¹¶ä¸”<code>FMDB</code>å†…éƒ¨å¯¹SQLè¯­å¥è¿›è¡Œäº†ç¼“å­˜ï¼Œå†é…åˆä¸Šå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œåœ¨æé«˜æ•ˆç‡æ–¹é¢åšäº†ä¸å°‘çš„ä¼˜åŒ–ï¼Œå¦å¤–è¿˜æ‰©å±•äº†å†…å­˜/æ–‡ä»¶çš„IOæ“ä½œå’Œè™šè¡¨çš„æ“ä½œ</p>
<p>ä¸‹é¢æˆ‘ä¼šå°†APIä½¿ç”¨å’Œæºç ç»“åˆèµ·æ¥è®²ï¼Œæ–¹ä¾¿äº†è§£<code>FMDB</code>ä»¥åŠå¯¹å¤ä¹ ä¸‹åŸç”Ÿçš„SQLite API</p>
<a id="more"></a>
<h2 id="FMDatabase"><a href="#FMDatabase" class="headerlink" title="FMDatabase"></a>FMDatabase</h2><h4 id="u521D_u59CB_u5316"><a href="#u521D_u59CB_u5316" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>æ•°æ®åº“çš„åˆå§‹åŒ–å¯¹å¤–æœ‰ä¸¤ç§æ–¹æ³•<code>+ databaseWithPath:</code>å’Œ<code>- initWithPath:</code>ï¼Œå†…éƒ¨å®é™…ä¸Š<code>+ databaseWithPath:</code>åªæ˜¯å¯¹<code>- initWithPath:</code>åŒ…è£…ï¼Œä»£ç é‡Œå¾ˆå¤šç±»ä¼¼<code>FMDBReturnAutoreleased</code>ç­‰ç­‰è¿™ä¸€ç±»å®å®šä¹‰æ˜¯ä¸ºäº†å…¼å®¹ARCå’ŒMRC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)databaseWithPath:(NSString*)aPath &#123;</div><div class="line">    return FMDBReturnAutoreleased([[self alloc] initWithPath:aPath]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)init &#123;</div><div class="line">    return [self initWithPath:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithPath:(NSString*)aPath &#123;</div><div class="line">    // SQLiteæ”¯æŒä¸‰ç§çº¿ç¨‹æ¨¡å¼ï¼Œåˆ†åˆ«ä¸ºå•çº¿ç¨‹æ¨¡å¼ã€å¤šçº¿ç¨‹æ¨¡å¼å’Œä¸²è¡Œæ¨¡å¼</div><div class="line">    // sqlite3_threadsafe()çš„è¿”å›å€¼å¯ä»¥ç¡®å®šç¼–è¯‘æ—¶æŒ‡å®šçš„çº¿ç¨‹æ¨¡å¼ï¼Œå…¶ä¸­å¯¹äºå•çº¿ç¨‹æ¨¡å¼ï¼Œsqlite3_threadsafe()è¿”å›falseï¼Œå¯¹äºå¦å¤–ä¸¤ä¸ªæ¨¡å¼ï¼Œåˆ™è¿”å›trueã€‚è¿™æ˜¯å› ä¸ºå•çº¿ç¨‹æ¨¡å¼ä¸‹æ²¡æœ‰è¿›è¡Œäº’æ–¥ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹ä¸‹æ˜¯ä¸å®‰å…¨çš„</div><div class="line">    assert(sqlite3_threadsafe()); // whoa there big boy- gotta make sure sqlite it happy with what we&apos;re going to do.</div><div class="line">    </div><div class="line">    self = [super init];</div><div class="line">    </div><div class="line">    if (self) &#123;</div><div class="line">        _databasePath               = [aPath copy];</div><div class="line">        _openResultSets             = [[NSMutableSet alloc] init];</div><div class="line">        // æ­¤æ—¶å¹¶ä¸åˆ›å»ºæ•°æ®åº“ï¼ŒçœŸæ­£åˆ›å»ºæ˜¯åœ¨opençš„æ—¶å€™</div><div class="line">      	_db                         = nil;</div><div class="line">        _logsErrors                 = YES;</div><div class="line">        _crashOnErrors              = NO;</div><div class="line">        _maxBusyRetryTimeInterval   = 2;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// ç»™å®šdatabaseè·¯å¾„</div><div class="line">NSString *dbPath = @&quot;/tmp/tmp.db&quot;;</div><div class="line">// è°ƒç”¨[+ databaseWithPath:]æ–¹æ³•</div><div class="line">FMDatabase *db = [FMDatabase databaseWithPath:dbPath];</div></pre></td></tr></table></figure>
<h4 id="u6253_u5F00_u6570_u636E_u8FDE_u63A5"><a href="#u6253_u5F00_u6570_u636E_u8FDE_u63A5" class="headerlink" title="æ‰“å¼€æ•°æ®è¿æ¥"></a>æ‰“å¼€æ•°æ®è¿æ¥</h4><p>æ‰“å¼€è¿æ¥æä¾›äº†ä¸‰ç§æ–¹æ³•ï¼Œè¿™æ—¶å€™æ‰å¼€å§‹åˆ›å»ºæ•°æ®åº“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (BOOL)open &#123;</div><div class="line">    if (_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    // æ ¹æ®æ•°æ®åº“è·¯å¾„æ‰“å¼€æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨å°±æ–°å»ºä¸€ä¸ª</div><div class="line">    int err = sqlite3_open([self sqlitePath], (sqlite3**)&amp;_db );</div><div class="line">    if(err != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error opening!: %d&quot;, err);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    // è®¾ç½®æœ€å¤§ç¹å¿™é‡è¯•æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º2ç§’</div><div class="line">    if (_maxBusyRetryTimeInterval &gt; 0.0) &#123;</div><div class="line">        // set the handler</div><div class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">  	return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// æ ¹æ®æ ‡è®°æ‰“å¼€ä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥</div><div class="line">// flagå¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§å€¼ä¹‹ä¸€ï¼š</div><div class="line">// SQLITE_OPEN_READONLYï¼Œåªè¯»æ¨¡å¼ï¼Œå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ä¼šæŠ¥é”™</div><div class="line">// SQLITE_OPEN_READWRITEï¼Œè¯»å†™æ¨¡å¼ï¼Œå¦‚æœè¯¥æ–‡ä»¶åœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¯å†™ä¿æŠ¤çš„ï¼Œé‚£å°±æ˜¯ä»¥åªè¯»æ–¹å¼æ‰“å¼€ï¼Œå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ä¼šæŠ¥é”™</div><div class="line">// SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATEï¼Œä»¥è¯»å†™æ–¹å¼æ‰“å¼€ï¼Œå¦‚æœæ•°æ®ä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ªï¼Œè¿™ä¸ªç”¨äºopenæ–¹æ³•é‡Œé¢</div><div class="line">// ä»¥ä¸Šè¿˜å¯ä»¥å¯é€‰ç»„åˆ`SQLITE_OPEN_NOMUTEX`, `SQLITE_OPEN_FULLMUTEX`, `SQLITE_OPEN_SHAREDCACHE`, `SQLITE_OPEN_PRIVATECACHE`, and/or `SQLITE_OPEN_URI`</div><div class="line">- (BOOL)openWithFlags:(int)flags &#123;</div><div class="line">    return [self openWithFlags:flags vfs:nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (BOOL)openWithFlags:(int)flags vfs:(NSString *)vfsName &#123;</div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3005000</div><div class="line">    if (_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    // æ¯”sqlite3_openå¤šä¼ å…¥äº†flagså’ŒvfsNameï¼ŒvfsNameä¸ºä½¿ç”¨çš„VFSæ¨¡å—çš„åç§°</div><div class="line">    // sqlite3_open_v2é‡ŒzVfså‚æ•°å…è®¸å®¢æˆ·åº”ç”¨ç¨‹åºå‘½åä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVirtual File Systemï¼‰æ¨¡å—ï¼Œç”¨æ¥ä¸æ•°æ®åº“è¿æ¥ã€‚VFSä½œä¸ºSQlite libraryå’Œåº•å±‚å­˜å‚¨ç³»ç»Ÿï¼ˆå¦‚æŸä¸ªæ–‡ä»¶ç³»ç»Ÿï¼‰ä¹‹é—´çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œé€šå¸¸å®¢æˆ·åº”ç”¨ç¨‹åºå¯ä»¥ç®€å•çš„ç»™è¯¥å‚æ•°ä¼ é€’ä¸€ä¸ªNULLæŒ‡é’ˆï¼Œä»¥ä½¿ç”¨é»˜è®¤çš„VFSæ¨¡å—ã€‚</div><div class="line">    // sqlite3_open_v2æ¯”sqlite3_openå’Œsqlite3_open16å¼ºå¤§åœ¨å®ƒå¯ä»¥æŒ‡å®šè¿æ¥æ–¹å¼</div><div class="line">    int err = sqlite3_open_v2([self sqlitePath], (sqlite3**)&amp;_db, flags, [vfsName UTF8String]);</div><div class="line">    if(err != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error opening!: %d&quot;, err);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_maxBusyRetryTimeInterval &gt; 0.0) &#123;</div><div class="line">        // set the handler</div><div class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return YES;</div><div class="line">#else</div><div class="line">    NSLog(@&quot;openWithFlags requires SQLite 3.5&quot;);</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>openæ—¶ä¼šæ ¹æ®<code>_maxBusyRetryTimeInterval</code>æ¥è®¾ç½®ç¹å¿™å¤„ç†<code>busy handler</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">- (void)setMaxBusyRetryTimeInterval:(NSTimeInterval)timeout &#123;</div><div class="line">    </div><div class="line">    _maxBusyRetryTimeInterval = timeout;</div><div class="line">    </div><div class="line">    if (!_db) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    /*</div><div class="line">     int sqlite3_busy_handler(sqlite3*, int(*)(void*,int), void*);</div><div class="line">     ç¬¬äºŒä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ï¼ˆbusy handlerï¼‰ï¼Œå¦‚æœè®¾ç½®äº†å›è°ƒå‡½æ•°ï¼Œé‚£å°±éœ€è¦è®¾ç½®sqlite3_busy_handlerçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¿™é‡Œä¼ é€’ç»™å®ƒçš„æ˜¯ä¸€ä¸ªvoid*çš„å‚æ•°çš„æ‹·è´ï¼›å¦‚æœå›è°ƒå‡½æ•°è¿”å›ï¼æ—¶ï¼Œå°†ä¸å†å°è¯•å†æ¬¡è®¿é—®æ•°æ®åº“è€Œè¿”å›SQLITE_BUSYæˆ–è€…SQLITE_IOERR_BLOCKEDã€‚å¦‚æœå›è°ƒå‡½æ•°è¿”å›éï¼,å°†ä¼šä¸æ–­å°è¯•æ“ä½œæ•°æ®åº“ã€‚</div><div class="line">     ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å…¶ä»–è¿›ç¨‹æˆ–è€…çº¿ç¨‹åœ¨è¯»å†™æ•°æ®åº“ï¼Œé‚£ä¹ˆsqlite3_busy_handlerä¼šä¸æ–­è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œç›´åˆ°å…¶ä»–è¿›ç¨‹æˆ–è€…çº¿ç¨‹é‡Šæ”¾é”ã€‚è·å¾—é”ä¹‹åï¼Œä¸ä¼šå†è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œä»è€Œå‘ä¸‹æ‰§è¡Œï¼Œè¿›è¡Œæ•°æ®åº“æ“ä½œã€‚è¯¥å‡½æ•°æ˜¯åœ¨è·å–ä¸åˆ°é”çš„æ—¶å€™ï¼Œä»¥æ‰§è¡Œå›è°ƒå‡½æ•°çš„æ¬¡æ•°æ¥è¿›è¡Œå»¶è¿Ÿï¼Œç­‰å¾…å…¶ä»–è¿›ç¨‹æˆ–è€…çº¿ç¨‹æ“ä½œæ•°æ®åº“ç»“æŸï¼Œä»è€Œè·å¾—é”æ“ä½œæ•°æ®åº“ã€‚</div><div class="line">     */</div><div class="line">    if (timeout &gt; 0) &#123;</div><div class="line">        // busy handlerè®¾ç½®ä¸ºFMDBDatabaseBusyHandlerå‡½æ•°</div><div class="line">        sqlite3_busy_handler(_db, &amp;FMDBDatabaseBusyHandler, (__bridge void *)(self));</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        // turn it off otherwise</div><div class="line">        // å…³é—­busy handler</div><div class="line">        sqlite3_busy_handler(_db, nil, nil);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// è¿™å°±æ˜¯å›è°ƒå‡½æ•°</div><div class="line">static int FMDBDatabaseBusyHandler(void *f, int count) &#123;</div><div class="line">    FMDatabase *self = (__bridge FMDatabase*)f;</div><div class="line">    </div><div class="line">    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè°ƒç”¨[+ timeIntervalSinceReferenceDate]æ–¹æ³•ï¼Œè·å–å½“å‰æ—¶é—´ä¸2001å¹´1æœˆ1æ—¥00:00:00 UTCçš„æ—¶é—´é—´éš”ï¼Œå¹¶èµ‹å€¼ç»™startBusyRetryTime</div><div class="line">    if (count == 0) &#123;</div><div class="line">        self-&gt;_startBusyRetryTime = [NSDate timeIntervalSinceReferenceDate];</div><div class="line">        // è¿”å›1ï¼Œåˆ™å°†ä¸æ–­å°è¯•æ“ä½œæ•°æ®åº“</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    // è®¡ç®—å½“å‰æ—¶é—´ä¸2001å¹´1æœˆ1æ—¥00:00:00 UTCçš„æ—¶é—´é—´éš”å’ŒstartBusyRetryTimeçš„é—´éš”</div><div class="line">    NSTimeInterval delta = [NSDate timeIntervalSinceReferenceDate] - (self-&gt;_startBusyRetryTime);</div><div class="line">    // å¦‚æœé—´éš”æ—¶é—´å°äºæœ€å¤§çš„é‡è¯•é—´éš”æ—¶é—´</div><div class="line">    if (delta &lt; [self maxBusyRetryTimeInterval]) &#123;</div><div class="line">        // äº§ç”Ÿä¸€ä¸ªä»50-99çš„éšæœºæ•´æ•°ä½œä¸ºéœ€è¦æŒ‚èµ·æ¯«ç§’æ—¶é—´</div><div class="line">        int requestedSleepInMillseconds = (int) arc4random_uniform(50) + 50;</div><div class="line">        // è°ƒç”¨sqlite3_sleepè¿”å›å®é™…æŒ‚èµ·æ¯«ç§’æ—¶é—´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œå¯èƒ½æ˜¯å› ä¸ºSQLiteæ„å»ºæ—¶æ²¡æœ‰å°†HAVE_USLEEPè®¾ç½®ä¸º1</div><div class="line">        int actualSleepInMilliseconds = sqlite3_sleep(requestedSleepInMillseconds);</div><div class="line">        if (actualSleepInMilliseconds != requestedSleepInMillseconds) &#123;</div><div class="line">            NSLog(@&quot;WARNING: Requested sleep of %i milliseconds, but SQLite returned %i. Maybe SQLite wasn&apos;t built with HAVE_USLEEP=1?&quot;, requestedSleepInMillseconds, actualSleepInMilliseconds);</div><div class="line">        &#125;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (![db open]) &#123;</div><div class="line">	// do somthing        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u5355_u4E2A_u67E5_u8BE2SQL_u8BED_u53E5"><a href="#u6267_u884C_u5355_u4E2A_u67E5_u8BE2SQL_u8BED_u53E5" class="headerlink" title="æ‰§è¡Œå•ä¸ªæŸ¥è¯¢SQLè¯­å¥"></a>æ‰§è¡Œå•ä¸ªæŸ¥è¯¢SQLè¯­å¥</h4><p>ä¸»è¦æ‰§è¡Œçš„æ˜¯<code>(FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args</code>æ–¹æ³•ï¼Œ<code>sql</code>æ˜¯æ‰§è¡ŒSELECTè¯­å¥ï¼Œ<code>dictionaryArgs</code>æ˜¯å¯¹åº”äº<code>sql</code>è¯­å¥é‡Œ<code>ï¼Ÿ</code>çš„<code>key</code>å’Œ<code>value</code>ï¼Œåœ¨å°†<code>sql</code>è¯­å¥è½¬æ¢æˆ<code>prepared</code>è¯­å¥æ—¶ï¼Œè¿™é‡Œå…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œæ²¡æœ‰çš„è¯å†å»è°ƒç”¨<code>sqlite3_prepare_v2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">- (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</div><div class="line">    // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨</div><div class="line">    if (![self databaseExists]) &#123;</div><div class="line">        return 0x00;</div><div class="line">    &#125;</div><div class="line">    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ‰§è¡Œæ“ä½œ</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return 0x00;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int rc                  = 0x00;</div><div class="line">    sqlite3_stmt *pStmt     = 0x00;</div><div class="line">    FMStatement *statement  = 0x00;</div><div class="line">    FMResultSet *rs         = 0x00;</div><div class="line">    </div><div class="line">    if (_traceExecution &amp;&amp; sql) &#123;</div><div class="line">        NSLog(@&quot;%@ executeQuery: %@&quot;, self, sql);</div><div class="line">    &#125;</div><div class="line">    // å°†sqlè¯­å¥è½¬æ¢æˆpreparedè¯­å¥</div><div class="line">    // ç”±äºä½¿ç”¨sqlite3_prepare_v2æ¥ç”Ÿæˆsqlå¯¹åº”çš„preparedè¯­å¥ä»£ä»·å¾ˆå¤§</div><div class="line">    // æ‰€ä»¥ä½¿ç”¨ç¼“å­˜æœºåˆ¶æ¥å‡å°‘sqlite3_prepare_v2çš„ä½¿ç”¨</div><div class="line">    if (_shouldCacheStatements) &#123;</div><div class="line">        // æ ¹æ®sqlè·å–åˆ°ç¼“å­˜ä¸­çš„preparedè¯­å¥</div><div class="line">        statement = [self cachedStatementForQuery:sql];</div><div class="line">        pStmt = statement ? [statement statement] : 0x00;</div><div class="line">        // é‡ç½®preparedè¯­å¥</div><div class="line">        [statement reset];</div><div class="line">    &#125;</div><div class="line">    // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰sqlå¯¹åº”çš„preparedè¯­å¥ï¼Œé‚£ä¹ˆéœ€è¦ç”¨sqlite3_prepare_v2ç”Ÿæˆå¯¹åº”çš„preparedè¯­å¥</div><div class="line">    if (!pStmt) &#123;</div><div class="line">        </div><div class="line">        rc = sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</div><div class="line">        </div><div class="line">        // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œåˆ™æ‰“å°é”™è¯¯æ—¥å¿—</div><div class="line">        if (SQLITE_OK != rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_crashOnErrors) &#123;</div><div class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                // åœæ­¢ç¨‹åº</div><div class="line">                abort();</div><div class="line">            &#125;</div><div class="line">            // é‡Šæ”¾æ‰€æœ‰å†…éƒ¨èµ„æºå’ŒFMStatement</div><div class="line">            sqlite3_finalize(pStmt);</div><div class="line">            _isExecutingStatement = NO;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    id obj;</div><div class="line">    int idx = 0;</div><div class="line">    // sqlite3_bind_parameter_count è¿”å›SQLè¯­å¥å‚æ•°çš„æ•°é‡</div><div class="line">    int queryCount = sqlite3_bind_parameter_count(pStmt); // pointed out by Dominic Yu (thanks!)</div><div class="line">    </div><div class="line">    // If dictionaryArgs is passed in, that means we are using sqlite&apos;s named parameter support</div><div class="line">    if (dictionaryArgs) &#123;</div><div class="line">        </div><div class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</div><div class="line">            </div><div class="line">            // Prefix the key with a colon.</div><div class="line">            NSString *parameterName = [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                NSLog(@&quot;%@ = %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Get the index for the parameter name.</div><div class="line">            // é€šè¿‡ä¼ å…¥å‚æ•°åæ¥è·å–è¯¥å‚æ•°çš„ç´¢å¼•</div><div class="line">            int namedIdx = sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</div><div class="line">            </div><div class="line">            FMDBRelease(parameterName);</div><div class="line">            // å¦‚æœç´¢å¼•å¤§äº0</div><div class="line">            if (namedIdx &gt; 0) &#123;</div><div class="line">                // Standard binding from here.</div><div class="line">                // åœ¨preparedè¯­å¥é‡Œå°†å€¼ç»‘å®šåˆ°ç´¢å¼•ä½ç½®</div><div class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</div><div class="line">                // increment the binding count, so our check below works out</div><div class="line">                // ç»‘å®šæ•°é‡åŠ ä¸€</div><div class="line">                idx++;</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                NSLog(@&quot;Could not find index for %@&quot;, dictionaryKey);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        </div><div class="line">        while (idx &lt; queryCount) &#123;</div><div class="line">            // å½“è°ƒç”¨ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•æ—¶</div><div class="line">            // - (FMResultSet *)executeQueryWithFormat:(NSString*)format, ...</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray *)arguments</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString *)sql values:(NSArray *)values error:(NSError * __autoreleasing *)error</div><div class="line">            // å€¼æ˜¯æ”¾åœ¨NSArrayé‡Œé¢ï¼Œå¾ªç¯å–å‡ºæ¥ç»‘å®š</div><div class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</div><div class="line">                obj = [arrayArgs objectAtIndex:(NSUInteger)idx];</div><div class="line">            &#125;</div><div class="line">            // å½“è°ƒç”¨ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•æ—¶</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString*)sql, ...</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString*)sql withVAList:(va_list)args</div><div class="line">            // å€¼æ˜¯æ”¾åœ¨va_listé‡Œé¢ï¼Œå¾ªç¯å–å‡ºæ¥ç»‘å®š</div><div class="line">            else if (args) &#123;</div><div class="line">                obj = va_arg(args, id);</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                //We ran out of arguments</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</div><div class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            idx++;</div><div class="line">            // ç»‘å®šå‚æ•°</div><div class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // å¦‚æœç»‘å®šæ•°é‡å’Œå‚æ•°æ•°é‡ä¸ä¸€è‡´ï¼Œæ‰“å°é”™è¯¯ï¼Œå¹¶é‡Šæ”¾èµ„æº</div><div class="line">    if (idx != queryCount) &#123;</div><div class="line">        NSLog(@&quot;Error: the bind count is not correct for the # of variables (executeQuery)&quot;);</div><div class="line">        sqlite3_finalize(pStmt);</div><div class="line">        _isExecutingStatement = NO;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    FMDBRetain(statement); // to balance the release below</div><div class="line">    </div><div class="line">    // å¦‚æœstatementä¸ä¸ºç©ºï¼Œåˆ™ç¼“å­˜</div><div class="line">    if (!statement) &#123;</div><div class="line">        statement = [[FMStatement alloc] init];</div><div class="line">        [statement setStatement:pStmt];</div><div class="line">        </div><div class="line">        if (_shouldCacheStatements &amp;&amp; sql) &#123;</div><div class="line">            // ä»¥sqlä½œä¸ºkeyæ¥ç¼“å­˜statement</div><div class="line">            [self setCachedStatement:statement forQuery:sql];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // the statement gets closed in rs&apos;s dealloc or [rs close];</div><div class="line">    // æ ¹æ®statementå’ŒFMDataBaseå¯¹è±¡æ¥åˆå§‹åŒ–FMResultSetå¯¹è±¡</div><div class="line">    rs = [FMResultSet resultSetWithStatement:statement usingParentDatabase:self];</div><div class="line">    [rs setQuery:sql];</div><div class="line">    </div><div class="line">    // å°†FMResultSetå¯¹è±¡åŠ åˆ°_openResultSetsé‡Œ</div><div class="line">    NSValue *openResultSet = [NSValue valueWithNonretainedObject:rs];</div><div class="line">    [_openResultSets addObject:openResultSet];</div><div class="line">    // useCount+1</div><div class="line">    [statement setUseCount:[statement useCount] + 1];</div><div class="line">    </div><div class="line">    FMDBRelease(statement);</div><div class="line">    // è®¾ç½®_isExecutingStatementæ“ä½œç»“æŸ</div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return rs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rs = [newDb executeQuery:@&quot;select rowid,* from test where a = ?&quot;, @&quot;hi&apos;&quot;];</div><div class="line"></div><div class="line">rs = [db executeQueryWithFormat:@&quot;select * from t5 where a = %s and a = %@ and b = %d&quot;, &quot;text&quot;, @&quot;text&quot;, 42];</div><div class="line"></div><div class="line">rs = [db executeQuery:@&quot;select * from testOneHundredTwelvePointTwo where b &gt; ?&quot; withArgumentsInArray:[NSArray arrayWithObject:[NSNumber numberWithInteger:1]]];</div><div class="line"></div><div class="line">rs = [db executeQuery:@&quot;select * from namedparamcounttest where a = :a&quot; withParameterDictionary:dictionaryArgs];</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u5355_u4E2A_u66F4_u65B0SQL_u8BED_u53E5"><a href="#u6267_u884C_u5355_u4E2A_u66F4_u65B0SQL_u8BED_u53E5" class="headerlink" title="æ‰§è¡Œå•ä¸ªæ›´æ–°SQLè¯­å¥"></a>æ‰§è¡Œå•ä¸ªæ›´æ–°SQLè¯­å¥</h4><p><code>- (BOOL)executeUpdate:(NSString*)sql error:(NSError**)outErr withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args</code>æ˜¯ä¸»è¦å‡½æ•°ï¼Œä½†æ˜¯é‡Œé¢å¤§éƒ¨åˆ†å¤„ç†å’Œ<code>- executeQuery: withArgumentsInArray: orDictionary: orVAList:</code>å¤„ç†ç±»ä¼¼ï¼Œä¸åŒå¤„æˆ‘å·²ç»æ³¨é‡Šè¯´æ˜ï¼Œå¯ä»¥ç›´æ¥çœ‹æ³¨é‡Šéƒ¨åˆ†ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div></pre></td><td class="code"><pre><div class="line">- (BOOL)executeUpdate:(NSString*)sql error:(NSError**)outErr withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</div><div class="line">    </div><div class="line">    if (![self databaseExists]) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int rc                   = 0x00;</div><div class="line">    sqlite3_stmt *pStmt      = 0x00;</div><div class="line">    FMStatement *cachedStmt  = 0x00;</div><div class="line">    </div><div class="line">    if (_traceExecution &amp;&amp; sql) &#123;</div><div class="line">        NSLog(@&quot;%@ executeUpdate: %@&quot;, self, sql);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_shouldCacheStatements) &#123;</div><div class="line">        cachedStmt = [self cachedStatementForQuery:sql];</div><div class="line">        pStmt = cachedStmt ? [cachedStmt statement] : 0x00;</div><div class="line">        [cachedStmt reset];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (!pStmt) &#123;</div><div class="line">        rc = sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</div><div class="line">        </div><div class="line">        if (SQLITE_OK != rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_crashOnErrors) &#123;</div><div class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                abort();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (outErr) &#123;</div><div class="line">                *outErr = [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            sqlite3_finalize(pStmt);</div><div class="line">            </div><div class="line">            _isExecutingStatement = NO;</div><div class="line">            return NO;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    id obj;</div><div class="line">    int idx = 0;</div><div class="line">    int queryCount = sqlite3_bind_parameter_count(pStmt);</div><div class="line">    </div><div class="line">    // If dictionaryArgs is passed in, that means we are using sqlite&apos;s named parameter support</div><div class="line">    if (dictionaryArgs) &#123;</div><div class="line">        </div><div class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</div><div class="line">            </div><div class="line">            // Prefix the key with a colon.</div><div class="line">            NSString *parameterName = [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                NSLog(@&quot;%@ = %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</div><div class="line">            &#125;</div><div class="line">            // Get the index for the parameter name.</div><div class="line">            int namedIdx = sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</div><div class="line">            </div><div class="line">            FMDBRelease(parameterName);</div><div class="line">            </div><div class="line">            if (namedIdx &gt; 0) &#123;</div><div class="line">                // Standard binding from here.</div><div class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</div><div class="line">                </div><div class="line">                // increment the binding count, so our check below works out</div><div class="line">                idx++;</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                // ç”±äºå¤šäº†outErrï¼Œæ‰€ä»¥ç»‘å®šæ—¶å‡ºé”™éœ€è¦å°†erroræŠ›å‡º</div><div class="line">                NSString *message = [NSString stringWithFormat:@&quot;Could not find index for %@&quot;, dictionaryKey];</div><div class="line">                </div><div class="line">                if (_logsErrors) &#123;</div><div class="line">                    NSLog(@&quot;%@&quot;, message);</div><div class="line">                &#125;</div><div class="line">                if (outErr) &#123;</div><div class="line">                    *outErr = [self errorWithMessage:message];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        </div><div class="line">        while (idx &lt; queryCount) &#123;</div><div class="line">            </div><div class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</div><div class="line">                obj = [arrayArgs objectAtIndex:(NSUInteger)idx];</div><div class="line">            &#125;</div><div class="line">            else if (args) &#123;</div><div class="line">                obj = va_arg(args, id);</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                //We ran out of arguments</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</div><div class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            idx++;</div><div class="line">            </div><div class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    if (idx != queryCount) &#123;</div><div class="line">        // åŒæ ·ä¹Ÿæ˜¯ç»„è£…erroræŠ›å‡º</div><div class="line">        NSString *message = [NSString stringWithFormat:@&quot;Error: the bind count (%d) is not correct for the # of variables in the query (%d) (%@) (executeUpdate)&quot;, idx, queryCount, sql];</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;%@&quot;, message);</div><div class="line">        &#125;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:message];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        sqlite3_finalize(pStmt);</div><div class="line">        _isExecutingStatement = NO;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    /* Call sqlite3_step() to run the virtual machine. Since the SQL being</div><div class="line">     ** executed is not a SELECT statement, we assume no data will be returned.</div><div class="line">     */</div><div class="line">    // sqlite3_prepareå‡½æ•°å°†SQLå‘½ä»¤å­—ç¬¦ä¸²è§£æå¹¶è½¬æ¢ä¸ºä¸€ç³»åˆ—çš„å‘½ä»¤å­—èŠ‚ç ï¼Œè¿™äº›å­—èŠ‚ç æœ€ç»ˆè¢«ä¼ é€åˆ°SQlite3çš„è™šæ‹Ÿæ•°æ®åº“å¼•æ“ï¼ˆVDBE: Virtual Database Engineï¼‰ä¸­æ‰§è¡Œï¼Œå®Œæˆè¿™é¡¹å·¥ä½œçš„æ˜¯sqlite3_stepå‡½æ•°ã€‚æ¯”å¦‚ä¸€ä¸ªSELECTæŸ¥è¯¢æ“ä½œï¼Œsqlite3_stepå‡½æ•°çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿”å›ç»“æœé›†ä¸­çš„å…¶ä¸­ä¸€è¡Œï¼Œç›´åˆ°å†æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¡Œäº†ã€‚æ¯æ¬¡è°ƒç”¨sqlite3_stepå‡½æ•°å¦‚æœè¿”å›SQLITE_ROWï¼Œä»£è¡¨è·å¾—äº†æœ‰æ•ˆæ•°æ®è¡Œï¼Œå¯ä»¥é€šè¿‡sqlite3_columnå‡½æ•°æå–æŸåˆ—çš„å€¼ã€‚å¦‚æœè°ƒç”¨sqlite3_stepå‡½æ•°è¿”å›SQLITE_DONEï¼Œåˆ™ä»£è¡¨preparedè¯­å¥å·²ç»æ‰§è¡Œåˆ°ç»ˆç‚¹äº†ï¼Œæ²¡æœ‰æœ‰æ•ˆæ•°æ®äº†ã€‚å¾ˆå¤šå‘½ä»¤ç¬¬ä¸€æ¬¡è°ƒç”¨sqlite3_stepå‡½æ•°å°±ä¼šè¿”å›SQLITE_DONEï¼Œå› ä¸ºè¿™äº›SQLå‘½ä»¤ä¸ä¼šè¿”å›æ•°æ®ã€‚å¯¹äºINSERTï¼ŒUPDATEï¼ŒDELETEå‘½ä»¤ï¼Œä¼šè¿”å›å®ƒä»¬æ‰€ä¿®æ”¹çš„è¡Œå·â€”â€”ä¸€ä¸ªå•è¡Œå•åˆ—çš„å€¼ã€‚</div><div class="line">    /**</div><div class="line">     SQLITE_BUSY æ•°æ®åº“æ–‡ä»¶æœ‰é”</div><div class="line">     SQLITE_LOCKED æ•°æ®åº“ä¸­çš„æŸå¼ è¡¨æœ‰é”</div><div class="line">     SQLITE_DONE sqlite3_step()æ‰§è¡Œå®Œæ¯•</div><div class="line">     SQLITE_ROW sqlite3_step()è·å–åˆ°ä¸‹ä¸€è¡Œæ•°æ®</div><div class="line">     SQLITE_ERROR ä¸€èˆ¬ç”¨äºæ²¡æœ‰ç‰¹åˆ«æŒ‡å®šé”™è¯¯ç çš„é”™è¯¯ï¼Œå°±æ˜¯è¯´å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†æ— æ³•çŸ¥é“é”™è¯¯å‘ç”Ÿçš„åŸå› ã€‚</div><div class="line">     SQLITE_MISUSE æ²¡æœ‰æ­£ç¡®ä½¿ç”¨SQLiteæ¥å£ï¼Œæ¯”å¦‚ä¸€æ¡è¯­å¥åœ¨sqlite3_stepå‡½æ•°æ‰§è¡Œä¹‹åï¼Œæ²¡æœ‰è¢«é‡ç½®ä¹‹å‰ï¼Œå†æ¬¡ç»™å…¶ç»‘å®šå‚æ•°ï¼Œè¿™æ—¶bindå‡½æ•°å°±ä¼šè¿”å›SQLITE_MISUSEã€‚</div><div class="line">     **/</div><div class="line">    rc      = sqlite3_step(pStmt);</div><div class="line">    </div><div class="line">    if (SQLITE_DONE == rc) &#123;</div><div class="line">        // all is well, let&apos;s return.</div><div class="line">    &#125;</div><div class="line">    // sqlæ“ä½œè¢«sqlite3_interrupt()å‡½æ•°ç»ˆæ­¢</div><div class="line">    else if (SQLITE_INTERRUPT == rc) &#123;</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;Error calling sqlite3_step. Query was interrupted (%d: %s) SQLITE_INTERRUPT&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else if (rc == SQLITE_ROW) &#123;</div><div class="line">        NSString *message = [NSString stringWithFormat:@&quot;A executeUpdate is being called with a query string &apos;%@&apos;&quot;, sql];</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;%@&quot;, message);</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:message];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (SQLITE_ERROR == rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_ERROR&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else if (SQLITE_MISUSE == rc) &#123;</div><div class="line">            // uh oh.</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_MISUSE&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // wtf?</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) eu&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_shouldCacheStatements &amp;&amp; !cachedStmt) &#123;</div><div class="line">        cachedStmt = [[FMStatement alloc] init];</div><div class="line">        </div><div class="line">        [cachedStmt setStatement:pStmt];</div><div class="line">        </div><div class="line">        [self setCachedStatement:cachedStmt forQuery:sql];</div><div class="line">        </div><div class="line">        FMDBRelease(cachedStmt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int closeErrorCode;</div><div class="line">    </div><div class="line">    if (cachedStmt) &#123;</div><div class="line">        [cachedStmt setUseCount:[cachedStmt useCount] + 1];</div><div class="line">        closeErrorCode = sqlite3_reset(pStmt);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        /* Finalize the virtual machine. This releases all memory and other</div><div class="line">         ** resources allocated by the sqlite3_prepare() call above.</div><div class="line">         */</div><div class="line">        closeErrorCode = sqlite3_finalize(pStmt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (closeErrorCode != SQLITE_OK) &#123;</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;Unknown error finalizing or resetting statement (%d: %s)&quot;, closeErrorCode, sqlite3_errmsg(_db));</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    return (rc == SQLITE_DONE || rc == SQLITE_OK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[db executeUpdate:@&quot;insert into t5 values (?, ?, ?, ?, ?)&quot; withErrorAndBindings:&amp;err, @&quot;text&quot;, [NSNumber numberWithInt:42], @&quot;BLOB&quot;, @&quot;d&quot;, [NSNumber numberWithInt:0]];</div><div class="line"></div><div class="line">[dbB executeUpdate:@&quot;create table attached (a text)&quot;];</div><div class="line"></div><div class="line">[dbB executeUpdate:@&quot;insert into attached values (?)&quot;, @&quot;test&quot;];</div><div class="line"></div><div class="line">[db executeUpdateWithFormat:@&quot;insert into t55 values (%c, %hi, %g)&quot;, &apos;a&apos;, testShort, testFloat];</div><div class="line"></div><div class="line">[db executeUpdate:@&quot;insert into testOneHundredTwelvePointTwo values (?, ?)&quot; withArgumentsInArray:[NSArray arrayWithObjects:@&quot;one&quot;, [NSNumber numberWithInteger:2], nil]];</div><div class="line"></div><div class="line">[db executeUpdate:@&quot;insert into namedparamtest values (:a, :b, :c, :d)&quot; withParameterDictionary:dictionaryArgs];</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u591A_u4E2ASQL_u8BED_u53E5"><a href="#u6267_u884C_u591A_u4E2ASQL_u8BED_u53E5" class="headerlink" title="æ‰§è¡Œå¤šä¸ªSQLè¯­å¥"></a>æ‰§è¡Œå¤šä¸ªSQLè¯­å¥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">// ä½¿ç”¨executeStatements:å‡½æ•°å¯ä»¥å°†å¤šä¸ªSQLæ‰§è¡Œè¯­å¥å†™åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œå¹¶æ‰§è¡Œ</div><div class="line">- (BOOL)executeStatements:(NSString *)sql &#123;</div><div class="line">    return [self executeStatements:sql withResultBlock:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)executeStatements:(NSString *)sql withResultBlock:(FMDBExecuteStatementsCallbackBlock)block &#123;</div><div class="line">    </div><div class="line">    int rc;</div><div class="line">    char *errmsg = nil;</div><div class="line">    /*</div><div class="line">     sqlite3_exec(sqlite3*, const char *sql, sqlite_callback, void *data, char **errmsg)</div><div class="line">     </div><div class="line">     è¯¥ä¾‹ç¨‹æä¾›äº†ä¸€ä¸ªæ‰§è¡Œ SQL å‘½ä»¤çš„å¿«æ·æ–¹å¼ï¼ŒSQL å‘½ä»¤ç”± sql å‚æ•°æä¾›ï¼Œå¯ä»¥ç”±å¤šä¸ª SQL å‘½ä»¤ç»„æˆã€‚</div><div class="line">     </div><div class="line">     åœ¨è¿™é‡Œï¼Œç¬¬ä¸€ä¸ªå‚æ•° sqlite3 æ˜¯æ‰“å¼€çš„æ•°æ®åº“å¯¹è±¡ï¼Œsqlite_callback æ˜¯ä¸€ä¸ªå›è°ƒï¼Œdata ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œerrmsg å°†è¢«è¿”å›ç”¨æ¥è·å–ç¨‹åºç”Ÿæˆçš„ä»»ä½•é”™è¯¯ã€‚</div><div class="line">     </div><div class="line">     sqlite3_exec() ç¨‹åºè§£æå¹¶æ‰§è¡Œç”± sql å‚æ•°æ‰€ç»™çš„æ¯ä¸ªå‘½ä»¤ï¼Œç›´åˆ°å­—ç¬¦ä¸²ç»“æŸæˆ–è€…é‡åˆ°é”™è¯¯ä¸ºæ­¢ã€‚</div><div class="line">     */</div><div class="line">    rc = sqlite3_exec([self sqliteHandle], [sql UTF8String], block ? FMDBExecuteBulkSQLCallback : nil, (__bridge void *)(block), &amp;errmsg);</div><div class="line">    </div><div class="line">    if (errmsg &amp;&amp; [self logsErrors]) &#123;</div><div class="line">        NSLog(@&quot;Error inserting batch: %s&quot;, errmsg);</div><div class="line">        sqlite3_free(errmsg);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">NSString *sql = @&quot;create table messages1 (id integer primary key messageId, x text);&quot;</div><div class="line">                 &quot;create table messages2 (id integer primary key messageId, y text);&quot;</div><div class="line">				 &quot;insert into messages1 (x) values (&apos;X&apos;);&quot;</div><div class="line">                 &quot;insert into messages2 (y) values (&apos;Y&apos;);&quot;;</div><div class="line"></div><div class="line">success = [db executeStatements:sql];</div><div class="line"></div><div class="line">sql = @&quot;select count(*) as count from messages1;&quot;</div><div class="line">       &quot;select count(*) as count from messages2;&quot;;</div><div class="line"></div><div class="line">success = [self.db executeStatements:sql withResultBlock:^int(NSDictionary *dictionary) &#123;</div><div class="line">    // do something</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h4 id="u83B7_u53D6_u6700_u540E_u4E00_u6761_u63D2_u5165_u6570_u636E_u7684RowId"><a href="#u83B7_u53D6_u6700_u540E_u4E00_u6761_u63D2_u5165_u6570_u636E_u7684RowId" class="headerlink" title="è·å–æœ€åä¸€æ¡æ’å…¥æ•°æ®çš„RowId"></a>è·å–æœ€åä¸€æ¡æ’å…¥æ•°æ®çš„RowId</h4><p>å¯ä»¥æ ¹æ®è¿™ä¸ª<code>id</code>æ‹¿åˆ°è¯¥æ•°æ®ï¼Œå¹¶ä¸”å‘ä¸Šå–æ•°æ®åº“æ•°æ®ç­‰æ“ä½œéƒ½å¯ä»¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (sqlite_int64)lastInsertRowId &#123;</div><div class="line">    // å¦‚æœæœ‰æ­£åœ¨æ‰§è¡Œè¯­å¥ï¼Œè¿”å›</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    // sqlite3_last_insert_rowid è·å–æŒ‡å®šæ•°æ®åº“æœ€åä¸€ä¸ªæ’å…¥çš„rowid</div><div class="line">    sqlite_int64 ret = sqlite3_last_insert_rowid(_db);</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u7EDF_u8BA1_u4E0A_u4E00_u6B21SQL_u8BED_u53E5_u53D7_u5F71_u54CD_u7684_u884C_u6570"><a href="#u7EDF_u8BA1_u4E0A_u4E00_u6B21SQL_u8BED_u53E5_u53D7_u5F71_u54CD_u7684_u884C_u6570" class="headerlink" title="ç»Ÿè®¡ä¸Šä¸€æ¬¡SQLè¯­å¥å—å½±å“çš„è¡Œæ•°"></a>ç»Ÿè®¡ä¸Šä¸€æ¬¡SQLè¯­å¥å—å½±å“çš„è¡Œæ•°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (int)changes &#123;</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int ret = sqlite3_changes(_db);</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="exclusive_u4E8B_u52A1_u548Cdeferred_u4E8B_u52A1"><a href="#exclusive_u4E8B_u52A1_u548Cdeferred_u4E8B_u52A1" class="headerlink" title="exclusiveäº‹åŠ¡å’Œdeferredäº‹åŠ¡"></a>exclusiveäº‹åŠ¡å’Œdeferredäº‹åŠ¡</h4><p>äº‹åŠ¡å¯ä»¥ä»<code>DEFERRED</code>ï¼Œ<code>IMMEDIATE</code>æˆ–è€…<code>EXCLUSIVE</code>ï¼Œä¸€ä¸ªäº‹åŠ¡çš„ç±»å‹åœ¨<code>BEGIN</code>å‘½ä»¤ä¸­æŒ‡å®šï¼š<code>BEGIN [ DEFERRED | IMMEDIATE | EXCLUSIVE ] TRANSACTION</code></p>
<p>ä¸€ä¸ª<code>deferred</code>äº‹åŠ¡ä¸è·å–ä»»ä½•é”ï¼Œç›´åˆ°å®ƒéœ€è¦é”çš„æ—¶å€™ï¼Œè€Œä¸”<code>BEGIN</code>è¯­å¥æœ¬èº«ä¹Ÿä¸ä¼šåšä»€ä¹ˆäº‹æƒ…â€”â€”å®ƒå¼€å§‹äº<code>UNLOCK</code>çŠ¶æ€ï¼›é»˜è®¤æƒ…å†µä¸‹æ˜¯è¿™æ ·çš„ã€‚å¦‚æœä»…ä»…ç”¨<code>BEGIN</code>å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆäº‹åŠ¡å°±æ˜¯<code>DEFERRED</code>çš„ï¼ŒåŒæ—¶å®ƒä¸ä¼šè·å–ä»»ä½•é”ï¼Œå½“å¯¹æ•°æ®åº“è¿›è¡Œç¬¬ä¸€æ¬¡è¯»æ“ä½œæ—¶ï¼Œå®ƒä¼šè·å–<code>SHARED LOCK</code>ï¼›åŒæ ·ï¼Œå½“è¿›è¡Œç¬¬ä¸€æ¬¡å†™æ“ä½œæ—¶ï¼Œå®ƒä¼šè·å–<code>RESERVED LOCK</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">// å¼€å§‹å»¶è¿Ÿäº‹åŠ¡</div><div class="line">- (BOOL)beginDeferredTransaction &#123;</div><div class="line">    </div><div class="line">    BOOL b = [self executeUpdate:@&quot;begin deferred transaction&quot;];</div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//Exclusiveäº‹åŠ¡ä¼šè¯•ç€è·å–å¯¹æ•°æ®åº“çš„EXCLUSIVEé”ã€‚è¿™ä¸IMMEDIATEç±»ä¼¼ï¼Œä½†æ˜¯ä¸€æ—¦æˆåŠŸï¼ŒEXCLUSIVEäº‹åŠ¡ä¿è¯æ²¡æœ‰å…¶å®ƒçš„è¿æ¥ï¼Œæ‰€ä»¥å°±å¯å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ“ä½œäº†ã€‚</div><div class="line"></div><div class="line">// å¼€å§‹äº‹åŠ¡</div><div class="line">- (BOOL)beginTransaction &#123;</div><div class="line">    </div><div class="line">    BOOL b = [self executeUpdate:@&quot;begin exclusive transaction&quot;];</div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// å›æ»šäº‹åŠ¡</div><div class="line">- (BOOL)rollback &#123;</div><div class="line">    BOOL b = [self executeUpdate:@&quot;rollback transaction&quot;];</div><div class="line">    </div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line">// æäº¤äº‹åŠ¡</div><div class="line">- (BOOL)commit &#123;</div><div class="line">    BOOL b =  [self executeUpdate:@&quot;commit transaction&quot;];</div><div class="line">    </div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6570_u636E_u5E93_u52A0_u5BC6_u53CA_u91CD_u7F6E"><a href="#u6570_u636E_u5E93_u52A0_u5BC6_u53CA_u91CD_u7F6E" class="headerlink" title="æ•°æ®åº“åŠ å¯†åŠé‡ç½®"></a>æ•°æ®åº“åŠ å¯†åŠé‡ç½®</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (BOOL)setKeyWithData:(NSData *)keyData &#123;</div><div class="line">// SQLITE_HAS_CODEC ç”¨æ¥ç¡®å®šæ˜¯å¦æ”¯æŒåŠ å¯†</div><div class="line">#ifdef SQLITE_HAS_CODEC</div><div class="line">    if (!keyData) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // int sqlite3_key( sqlite3 *db, const void *pKey, int nKey)</div><div class="line">    // dbæ˜¯æŒ‡å®šçš„æ•°æ®åº“ï¼ŒpKeyæ˜¯å¯†é’¥ï¼ŒnKeyæ˜¯å¯†é’¥çš„é•¿åº¦</div><div class="line">    // ä¾‹å¦‚ï¼šsqlite3_key(_db, &quot;gongcheng&quot;, 9);</div><div class="line">    int rc = sqlite3_key(_db, [keyData bytes], (int)[keyData length]);</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">#else</div><div class="line">#pragma unused(keyData)</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (BOOL)rekeyWithData:(NSData *)keyData &#123;</div><div class="line">#ifdef SQLITE_HAS_CODEC</div><div class="line">    if (!keyData) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // int sqlite3_rekey( sqlite3 *db, const void *pKey, int nKey)</div><div class="line">    // dbæ˜¯æŒ‡å®šçš„æ•°æ®åº“ï¼ŒpKeyæ˜¯å¯†é’¥ï¼ŒnKeyæ˜¯å¯†é’¥çš„é•¿åº¦</div><div class="line">    // ä¾‹å¦‚ï¼šsqlite3_rekey(_db, &quot;yzy&quot;, 3);</div><div class="line">    int rc = sqlite3_rekey(_db, [keyData bytes], (int)[keyData length]);</div><div class="line">    </div><div class="line">    if (rc != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error on rekey: %d&quot;, rc);</div><div class="line">        NSLog(@&quot;%@&quot;, [self lastErrorMessage]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">#else</div><div class="line">#pragma unused(keyData)</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6570_u636E_u5E93_u56DE_u6EDA_u65F6_u8BBE_u7F6E_u56DE_u6EDA_u8282_u70B9"><a href="#u6570_u636E_u5E93_u56DE_u6EDA_u65F6_u8BBE_u7F6E_u56DE_u6EDA_u8282_u70B9" class="headerlink" title="æ•°æ®åº“å›æ»šæ—¶è®¾ç½®å›æ»šèŠ‚ç‚¹"></a>æ•°æ®åº“å›æ»šæ—¶è®¾ç½®å›æ»šèŠ‚ç‚¹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">- (NSError*)inSavePoint:(void (^)(BOOL *rollback))block &#123;</div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3007000</div><div class="line">    static unsigned long savePointIdx = 0;</div><div class="line">    // è®¾ç½®èŠ‚ç‚¹åç§°</div><div class="line">    NSString *name = [NSString stringWithFormat:@&quot;dbSavePoint%ld&quot;, savePointIdx++];</div><div class="line">    // é»˜è®¤ä¸å›æ»š</div><div class="line">    BOOL shouldRollback = NO;</div><div class="line">    </div><div class="line">    NSError *err = 0x00;</div><div class="line">    // å…ˆå¯¹å½“å‰çŠ¶æ€è¿›è¡Œä¿å­˜</div><div class="line">    if (![self startSavePointWithName:name error:&amp;err]) &#123;</div><div class="line">        return err;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (block) &#123;</div><div class="line">        block(&amp;shouldRollback);</div><div class="line">    &#125;</div><div class="line">    // å¦‚æœéœ€è¦å›æ»šï¼Œåˆ™å›æ»šå½“ä¸Šä¸€ä¸ªèŠ‚ç‚¹</div><div class="line">    if (shouldRollback) &#123;</div><div class="line">        // We need to rollback and release this savepoint to remove it</div><div class="line">        [self rollbackToSavePointWithName:name error:&amp;err];</div><div class="line">    &#125;</div><div class="line">    // é‡Šæ”¾èŠ‚ç‚¹</div><div class="line">    [self releaseSavePointWithName:name error:&amp;err];</div><div class="line">    </div><div class="line">    return err;</div><div class="line">#else</div><div class="line">    NSString *errorMessage = NSLocalizedString(@&quot;Save point functions require SQLite 3.7&quot;, nil);</div><div class="line">    if (self.logsErrors) NSLog(@&quot;%@&quot;, errorMessage);</div><div class="line">    return [NSError errorWithDomain:@&quot;FMDatabase&quot; code:0 userInfo:@&#123;NSLocalizedDescriptionKey : errorMessage&#125;];</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u5173_u95ED_u6570_u636E_u5E93_u8FDE_u63A5"><a href="#u5173_u95ED_u6570_u636E_u5E93_u8FDE_u63A5" class="headerlink" title="å…³é—­æ•°æ®åº“è¿æ¥"></a>å…³é—­æ•°æ®åº“è¿æ¥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (BOOL)close &#123;</div><div class="line">    // æ¸…é™¤ç¼“å­˜çš„preparedè¯­å¥</div><div class="line">    [self clearCachedStatements];</div><div class="line">    // å…³é—­æ‰€æœ‰æ‰“å¼€çš„FMResultSetå¯¹è±¡</div><div class="line">    [self closeOpenResultSets];</div><div class="line">    </div><div class="line">    if (!_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int  rc;</div><div class="line">    BOOL retry;</div><div class="line">    BOOL triedFinalizingOpenStatements = NO;</div><div class="line">    </div><div class="line">    do &#123;</div><div class="line">        retry   = NO;</div><div class="line">        // è°ƒç”¨sqlite3_closeå°è¯•å…³é—­æ•°æ®åº“</div><div class="line">        rc      = sqlite3_close(_db);</div><div class="line">        // å½“è¿”å›ç»“æœæ˜¯æ•°æ®åº“ç¹å¿™æˆ–è€…è¢«é”ä½äº†</div><div class="line">        if (SQLITE_BUSY == rc || SQLITE_LOCKED == rc) &#123;</div><div class="line">            if (!triedFinalizingOpenStatements) &#123;</div><div class="line">                triedFinalizingOpenStatements = YES;</div><div class="line">                sqlite3_stmt *pStmt;</div><div class="line">                // ä»å…³è”çš„pDbæ•°æ®é‡Œé¢å¯¹åº”çš„preparedè¯­å¥å¼€å§‹å¾€ä¸‹æ‰¾ç›¸åº”çš„preparedè¯­å¥ï¼Œ</div><div class="line">                // å¦‚æœpStmtæ˜¯NULLï¼Œåˆ™ä»pDbçš„ç¬¬ä¸€ä¸ªpreparedè¯­å¥å¼€å§‹æ‰¾ï¼Œ</div><div class="line">                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å›NULL</div><div class="line">                while ((pStmt = sqlite3_next_stmt(_db, nil)) !=0) &#123;</div><div class="line">                    // æ‰¾åˆ°ä¹‹åï¼Œé‡Šæ”¾èµ„æº</div><div class="line">                    NSLog(@&quot;Closing leaked statement&quot;);</div><div class="line">                    sqlite3_finalize(pStmt);</div><div class="line">                    retry = YES;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else if (SQLITE_OK != rc) &#123;</div><div class="line">            NSLog(@&quot;error closing!: %d&quot;, rc);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    while (retry);</div><div class="line">    </div><div class="line">    _db = nil;</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[newDb close];</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¹‹å‰çš„&lt;a href=&quot;http://zeeyang.com/2016/06/22/GCDAsyncSocket-socket-optimize/&quot;&gt;iOS Socketé‡æ„è®¾è®¡&lt;/a&gt;é‡Œé¢æˆ‘æœ‰æåˆ°æˆ‘ä»¬ä½¿ç”¨äº†FMDBåšæ¶ˆæ¯ç¼“å­˜ï¼Œåœ¨æ•°æ®åº“é€‰å‹æ–¹é¢ï¼Œæˆ‘ä»¬&lt;a href=&quot;http://broccoliii.me/&quot;&gt;è¥¿å…°èŠ±&lt;/a&gt;ä¹Ÿå¯¹ç›®å‰æ¯”è¾ƒæµè¡Œå’Œæˆç†Ÿçš„&lt;code&gt;Realm&lt;/code&gt;ã€&lt;code&gt;FMDB&lt;/code&gt;å’Œ&lt;code&gt;Core Data&lt;/code&gt;åšäº†è°ƒæŸ¥ï¼Œé‡Œé¢åŒ…æ‹¬äº†å®‰è£…ã€ä½¿ç”¨å’Œæ€§èƒ½æ¯”è¾ƒï¼Œæ˜¯ä¸ªä¸é”™çš„å‚è€ƒä¾‹å­&lt;/p&gt;
&lt;p&gt;åœ¨é€‰å‹æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å¤šé€‰å–å‡ ä¸ªä½œä¸ºå¯¹æ¯”ï¼Œä»ä½¿ç”¨æ–¹é¢è¯„ä¼°å­¦ä¹ æˆæœ¬ï¼Œé€šè¿‡æµ‹è¯•ä¸åŒæ•°æ®åº“æ“ä½œæ¥æ¯”è¾ƒæ€§èƒ½å·®å¼‚ï¼Œäº†è§£æœ‰å“ªäº›å¤§å‹çš„Appä½¿ç”¨äº†è¯¥æ•°æ®åº“ä»¥åŠè¯„ä»·æ¥ä¾§é¢è¯´æ˜è¯¥æ•°æ®åº“çš„æˆç†Ÿåº¦å’Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜ï¼Œæœ€åæ ¹æ®è‡ªå·±å®é™…çš„ä¸šåŠ¡éœ€æ±‚æ¥é€‰å‹&lt;/p&gt;
&lt;p&gt;åœ¨é€‰å®šä½¿ç”¨&lt;code&gt;FMDB&lt;/code&gt;ä¹‹åï¼Œæˆ‘ä¹Ÿåªæ˜¯ç®€å•çš„äº†è§£ä¸‹&lt;code&gt;FMDB&lt;/code&gt;çš„ä½¿ç”¨ï¼Œå¹¶æœªå¯¹å†…éƒ¨çš„å®ç°å’Œè®¾è®¡æ€è·¯åšæ·±å…¥äº†è§£ï¼Œä½†æ˜¯åœ¨é˜…è¯»äº†ä»£ç ä¹‹åï¼Œ&lt;code&gt;FMDB&lt;/code&gt;ç¡®å®åƒå…¶ä»–åšå®¢é‡Œé¢æåˆ°çš„é‚£æ ·ï¼Œæ˜¯å¯¹åŸç”Ÿçš„SQLite APIè¿›è¡Œäº†åŒ…è£…ï¼Œæš´éœ²å‡ºç›¸å¯¹å‹å¥½çš„å¯¹å¤–æ¥å£ï¼Œåªéœ€ä¼ å…¥SQLè¯­å¥å³å¯(ä½†æ˜¯å¯¹äºä¹ æƒ¯äºä½¿ç”¨Modelæ“ä½œçš„æˆ‘ä»¬æ¥è¯´ï¼Œç›´æ¥å†™SQLè¯­å¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œæ‰€ä»¥GitHubä¸Šä¹Ÿå°±åº“å¯¹&lt;code&gt;FMDB&lt;/code&gt;è¿›è¡Œäº†å°è£…ï¼Œçœå»å†™SQLè¯­å¥ï¼Œç›´æ¥å¯¹Modelè¿›è¡Œæ“ä½œ)ï¼Œå¹¶ä¸”&lt;code&gt;FMDB&lt;/code&gt;å†…éƒ¨å¯¹SQLè¯­å¥è¿›è¡Œäº†ç¼“å­˜ï¼Œå†é…åˆä¸Šå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œåœ¨æé«˜æ•ˆç‡æ–¹é¢åšäº†ä¸å°‘çš„ä¼˜åŒ–ï¼Œå¦å¤–è¿˜æ‰©å±•äº†å†…å­˜/æ–‡ä»¶çš„IOæ“ä½œå’Œè™šè¡¨çš„æ“ä½œ&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä¼šå°†APIä½¿ç”¨å’Œæºç ç»“åˆèµ·æ¥è®²ï¼Œæ–¹ä¾¿äº†è§£&lt;code&gt;FMDB&lt;/code&gt;ä»¥åŠå¯¹å¤ä¹ ä¸‹åŸç”Ÿçš„SQLite API&lt;/p&gt;
    
    </summary>
    
    
      <category term="FMDB" scheme="http://yuzeyang.github.io/tags/FMDB/"/>
    
  </entry>
  
  <entry>
    <title>IM UIæ€§èƒ½ä¼˜åŒ–ä¹‹å¼‚æ­¥ç»˜åˆ¶</title>
    <link href="http://yuzeyang.github.io/2016/07/05/IM-UI-optimize/"/>
    <id>http://yuzeyang.github.io/2016/07/05/IM-UI-optimize/</id>
    <published>2016-07-05T14:35:44.000Z</published>
    <updated>2017-04-10T13:19:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>é‡æ„å®ŒSocketä¹‹åï¼Œæœ€è¿‘æˆ‘ä»¬ä¹Ÿå¼€å§‹é’ˆå¯¹IMçš„UIåšäº†ä¼˜åŒ–ï¼Œè¿™æ¬¡çš„ä¼˜åŒ–æˆ‘ä»¬ä¸»è¦æ˜¯å‚è€ƒäº†<a href="https://github.com/ibireme/YYKit" target="_blank" rel="external">YYKit</a>å¯¹äºæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–ï¼Œå‰æœŸæˆ‘çš„å¦ä¸€ä¸ªå°ä¼™ä¼´<a href="http://broccoliii.me/" target="_blank" rel="external">è¥¿å…°èŠ±</a>ä¹Ÿå¯¹<a href="https://github.com/facebook/AsyncDisplayKit" target="_blank" rel="external">AsyncDisplayKit</a>åšäº†è°ƒç ”ï¼Œä¸è¿‡è¿™ä¸ªåº“ç†è§£èµ·æ¥ç¡®å®è¦è´¹ä¸€ç•ªåŠŸå¤«ï¼Œç”±äºYYkitçš„æ ¸å¿ƒæ€è·¯åŸºæœ¬ä¸Šéƒ½æ˜¯å­¦ä¹ AsyncDisplayKitçš„ï¼Œç›¸ä¿¡YYkitè¿™ä¸ªåº“å¤§å®¶éƒ½å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸è¿‡å¯èƒ½è¿˜æ²¡æœ‰çœ‹è¿‡è¿™ä¸ªåº“ï¼Œé‚£ä¸‹é¢æˆ‘åšä¸€ä¸ªç®€å•çš„ä»‹ç»</p>
<a id="more"></a>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/yykit.png" alt=""></p>
<p>YYKitçš„ä½œè€…æ˜¯<a href="http://blog.ibireme.com/" target="_blank" rel="external">éƒ­æ›œæº</a>ï¼ŒYYKitå®é™…ä¸Šæ˜¯å°†å®ƒé‚£äº›å•ç‹¬çš„iOSç»„ä»¶æ•´åˆåœ¨äº†ä¸€èµ·ï¼Œç±»ä¼¼äºé›†åˆä¸€æ ·ç»„æˆåŠŸèƒ½æ¯”è¾ƒå…¨é¢çš„ç»„ä»¶ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±ä¸šåŠ¡çš„éœ€è¦å•ç‹¬ä½¿ç”¨å…¶ä¸­çš„æŸäº›éƒ¨åˆ†</p>
<h2 id="0x00__u524D_u671F_u51C6_u5907"><a href="#0x00__u524D_u671F_u51C6_u5907" class="headerlink" title="0x00 å‰æœŸå‡†å¤‡"></a>0x00 å‰æœŸå‡†å¤‡</h2><p>æˆ‘ä»¬é¦–å…ˆé˜…è¯»äº†éƒ­æ›œæºåœ¨<a href="http://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="external">å¯¹ç•Œé¢æµç•…æ€§æ–¹é¢çš„è§è§£</a>ï¼Œé‡Œé¢æåˆ°äº†<code>å¼‚æ­¥ç»˜åˆ¶</code>ï¼Œä½†æ˜¯æ–‡å­—è¡¨è¿°æ¯•ç«Ÿæ˜¯æŠ½è±¡çš„ï¼Œç„¶åæˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹ä»–çš„YYTextå’ŒYYAsyncLayerç»„ä»¶ï¼Œçœ‹å®Œä¹‹åå®é™…ä¸Šå¯¹å¦‚ä½•ä½¿ç”¨ä»–çš„YYAsyncLayerè¿™ä¸ªç»„ä»¶æ¥å®ç°å¼‚æ­¥ç»˜åˆ¶è¿˜æ˜¯æœ‰ç‚¹æ¨¡ç³Šçš„ï¼Œåæ¥æˆ‘ä»¬ç›´æ¥çœ‹ä»–çš„å¾®åšdemoï¼Œæˆ‘ä»¬é€æ¸ç†æ¸…äº†ä»–æ˜¯å¦‚ä½•å®ç°å¼‚æ­¥ç»˜åˆ¶ä»¥åŠå‡ ä¸ªæ€§èƒ½ä¼˜åŒ–æ–¹é¢çš„ç‚¹</p>
<p>å› ä¸ºYYLabel Async Displayé‡Œé¢åŠ äº†æ˜¯å¦å¼‚æ­¥ç»˜åˆ¶å¼€å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ç”¨è¿™ä¸ªä¾‹å­ä½œä¸ºå¯¹æ¯”ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹å¼‚æ­¥ç»˜åˆ¶çš„æ•ˆæœï¼Œå¼€å§‹çš„æ—¶å€™æˆ‘ä»¬å…³é—­å¼‚æ­¥ç»˜åˆ¶çš„å¼€å…³ï¼Œä½ ä¼šå‘ç°FPSç¬é—´æ‰åˆ°6äº†ï¼Œå±å¹•æ»šåŠ¨å¼€å§‹éå¸¸å¡ï¼Œä½†æ˜¯æ‰“å¼€å¼€å…³ä¹‹åï¼Œæ»šåŠ¨æ—¶è™½ç„¶FPSè¿˜æ˜¯ä¼šæ‰åˆ°30-40ï¼Œä½†æ˜¯æ»‘åŠ¨çš„æµç•…åº¦æ¯”ä¹‹å‰è¦å¥½å¾ˆå¤šï¼Œæ„Ÿè§‰è¿™å¼‚æ­¥ç»˜åˆ¶çš„æ•ˆæœæ æ çš„å¥½å•Šï¼Œé‚£æˆ‘ä»¬ä¸€å®šè¦çœ‹çœ‹ä»–æ˜¯æ€ä¹ˆåšçš„äº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/YYAsyncLayer.gif!500x500" alt=""></p>
<h2 id="0x01__u5206_u6790"><a href="#0x01__u5206_u6790" class="headerlink" title="0x01 åˆ†æ"></a>0x01 åˆ†æ</h2><p>å…¶å®æ•´ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–å…³é”®çš„ç‚¹åŠæµç¨‹æœ‰ä¸‰ä¸ªï¼š</p>
<h5 id="1-_u6570_u636E_u6E90_u7684_u5F02_u6B65_u5904_u7406"><a href="#1-_u6570_u636E_u6E90_u7684_u5F02_u6B65_u5904_u7406" class="headerlink" title="1.æ•°æ®æºçš„å¼‚æ­¥å¤„ç†"></a>1.æ•°æ®æºçš„å¼‚æ­¥å¤„ç†</h5><p>å½“æˆ‘ä»¬è·å–åˆ°æ•°æ®æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®æºè¿›è¡Œè®¡ç®—å¤„ç†ï¼Œè®¡ç®—å‡ºUIç»˜åˆ¶æ‰€éœ€è¦çš„å±æ€§æ¯”å¦‚å®½é«˜ã€é¢œè‰²ç­‰ç­‰ï¼Œè€Œä¸”è¿™äº›è®¡ç®—è¦å¼‚æ­¥å»åšï¼Œå¦åˆ™ä¼šå¡ä½ä¸»çº¿ç¨‹ï¼Œç­‰è¿™äº›æ•°æ®æºè®¡ç®—å®Œæˆä¹‹åï¼Œå†å»å¤„ç†ç»˜åˆ¶ï¼Œä½†æ˜¯å¦‚æœæ•°æ®æºè¿‡å¤§ï¼Œè®¡ç®—çš„è€—æ—¶è¿˜æ˜¯åœ¨çš„ï¼Œæ‰€ä»¥ä¼šæœ‰è¾ƒé•¿æ—¶é—´çš„ç­‰å¾…æ—¶é—´ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘åŠ ä¸Šç­‰å¾…çš„å‹å¥½å¤„ç†</p>
<h5 id="2-_u91C7_u7528_u66F4_u8F7B_u91CF_u7EA7_u7684_u7ED8_u5236"><a href="#2-_u91C7_u7528_u66F4_u8F7B_u91CF_u7EA7_u7684_u7ED8_u5236" class="headerlink" title="2.é‡‡ç”¨æ›´è½»é‡çº§çš„ç»˜åˆ¶"></a>2.é‡‡ç”¨æ›´è½»é‡çº§çš„ç»˜åˆ¶</h5><p>åœ¨ç»˜åˆ¶æ—¶ï¼Œå¯¹äºä¸éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶çš„æ§ä»¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…åˆ›å»ºUIViewå¯¹è±¡ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä½¿ç”¨æ›´ä¸ºè½»é‡çš„CALayerï¼Œå¹¶ä¸”å¯¹äºä¸€ä¸ªlayeråŒ…å«å¤šä¸ªsubLayerçš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾å±‚é¢„åˆæˆçš„æ–¹æ³•ï¼Œå°†å¤šä¸ªsubLayeråˆæˆæ¸²æŸ“æˆä¸€å¼ å›¾ç‰‡ï¼Œé€šè¿‡ä¸Šè¿°çš„å¤„ç†ï¼Œä¸ä»…èƒ½å‡å°‘CPUåœ¨åˆ›å»ºUIKitå¯¹è±¡çš„æ¶ˆè€—ï¼Œè¿˜èƒ½å‡å°‘GPUåœ¨åˆæˆå’Œæ¸²æŸ“ä¸Šçš„æ¶ˆè€—ï¼Œå†…å­˜çš„å ç”¨ä¹Ÿä¼šå°‘å¾ˆå¤š</p>
<h5 id="3-_u5F02_u6B65_u7ED8_u5236"><a href="#3-_u5F02_u6B65_u7ED8_u5236" class="headerlink" title="3.å¼‚æ­¥ç»˜åˆ¶"></a>3.å¼‚æ­¥ç»˜åˆ¶</h5><p>æˆ‘ä»¬å°†ä½¿ç”¨<code>YYAsyncLayer</code>ç»„ä»¶å®ç°å¼‚æ­¥ç»˜åˆ¶</p>
<h2 id="0x02_YYAsyncLayer_u4ECB_u7ECD"><a href="#0x02_YYAsyncLayer_u4ECB_u7ECD" class="headerlink" title="0x02 YYAsyncLayerä»‹ç»"></a>0x02 YYAsyncLayerä»‹ç»</h2><p>å‰é¢ä¸¤ä¸ªä¼˜åŒ–ç‚¹ï¼Œå¹³æ—¶åœ¨åšçš„æ—¶å€™å¯èƒ½ä¹Ÿéƒ½ä¼šå»åšï¼Œä½†æ˜¯å¼‚æ­¥ç»˜åˆ¶è¿™ä¸ªè¯¥æ€ä¹ˆå»å®ç°å‘¢ï¼Ÿæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸‹<code>YYAsyncLayer</code>çš„ä»£ç </p>
<p><code>YYAsyncLayer</code>ç»„ä»¶é‡Œé¢ä¸€å…±åŒ…å«äº†ä¸‰ä¸ªç±»ï¼š<code>YYAsyncLayer</code>ã€<code>YYSentinel</code>ã€<code>YYTransaction</code></p>
<p><code>YYAsyncLayer</code>ç±»æ˜¯æˆ‘ä»¬ä¸»è¦ç”¨çš„ç±»ï¼Œå®ƒæ˜¯CALayerçš„å­ç±»ï¼Œæ˜¯ç”¨æ¥å¼‚æ­¥æ¸²æŸ“layerå†…å®¹</p>
<p><code>YYSentinel</code>ç±»æ˜¯ç”¨æ¥ç»™çº¿ç¨‹å®‰å…¨è®¡æ•°çš„ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹å¤„ç†çš„åœºæ™¯</p>
<p><code>YYTransaction</code>ç±»æ˜¯åˆ©ç”¨runloopåœ¨ä¼‘çœ å‰çš„ç©ºé—²æ—¶é—´æ¥è§¦å‘ä½ é¢„è®¾çš„æ–¹æ³•</p>
<p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç”¨åˆ°<code>YYTransaction</code>ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†<code>YYAsyncLayer</code>ã€<code>YYSentinel</code>åˆæˆä¸€ä¸ªç±»ï¼Œå¹¶åšäº†æ··æ·†ï¼Œè¿™æ ·å¯ä»¥å°‘å¼•ç”¨ä¸€ä¸ªåº“</p>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹<code>YYAsyncLayer</code>çš„å¤´æ–‡ä»¶</p>
<p><code>YYAsyncLayer</code>ç±»åªæœ‰ä¸€ä¸ª<code>displaysAsynchronously</code>å±æ€§ï¼Œå°±æ˜¯è®¾ç½®æ¸²æŸ“æ˜¯å¦æ˜¯å¼‚æ­¥æ‰§è¡Œçš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property BOOL displaysAsynchronously;</div></pre></td></tr></table></figure>
<p>ç„¶åè¿˜æœ‰ä¸ªä»£ç†æ–¹æ³•ï¼Œè¿™ä¸ªä»£ç†æ–¹æ³•çš„è§¦å‘æ—¶æœºæ˜¯åœ¨layerçš„å†…å®¹éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œæ­¤æ—¶ä½ æœ‰ä¸ªæ–°çš„ç»˜åˆ¶ä»»åŠ¡ï¼Œç„¶åè¿”å›çš„æ˜¯ä¸ª<code>YYAsyncLayerDisplayTask</code>å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (YYAsyncLayerDisplayTask *)newAsyncDisplayTask;</div></pre></td></tr></table></figure>
<p><code>YYAsyncLayerDisplayTask</code>ç±»åªæœ‰ä¸‰ä¸ªblockï¼Œå³å°†ç»˜åˆ¶ã€ç»˜åˆ¶ä¸­ã€ç»˜åˆ¶å®Œæˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@property (nullable, nonatomic, copy) void (^willDisplay)(CALayer *layer);</div><div class="line">@property (nullable, nonatomic, copy) void (^display)(CGContextRef context, CGSize size, BOOL(^isCancelled)(void));</div><div class="line">@property (nullable, nonatomic, copy) void (^didDisplay)(CALayer *layer, BOOL finished);</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°å®ç°æ–‡ä»¶é‡Œé¢ï¼Œè§¦å‘è¿™ä¸ªä»£ç†çš„æ–¹æ³•æ˜¯<code>- setNeedsDisplay</code>æ–¹æ³•ï¼Œå°±æ˜¯å½“layeréœ€è¦æ›´æ–°å†…å®¹çš„æ—¶å€™ï¼Œå®ƒä¼šå‘ä»£ç†å‘èµ·ä¸€ä¸ªå¼‚æ­¥ç»˜åˆ¶çš„è¯·æ±‚ï¼Œå°†å†…å®¹çš„æ¸²æŸ“æ”¾åˆ°åå°é˜Ÿåˆ—å»åšï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨<code>YYAsyncLayer</code>ç±»æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™<code>+ layerClass</code>æ–¹æ³•ï¼Œè¿”å›<code>YYAsyncLayer</code>ç±»ï¼Œå¦åˆ™ä¼šç›´æ¥è°ƒç”¨<code>CALayer</code>çš„æ–¹æ³•ï¼Œä¸ä¼šè§¦å‘ä»£ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (void)setNeedsDisplay &#123;</div><div class="line">    [self _cancelAsyncDisplay];</div><div class="line">    [super setNeedsDisplay];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)display &#123;</div><div class="line">    super.contents = super.contents;</div><div class="line">    [self _displayAsync:_displaysAsynchronously];</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - Private</div><div class="line"></div><div class="line">- (void)_displayAsync:(BOOL)async &#123;</div><div class="line">    __strong id&lt;YYAsyncLayerDelegate&gt; delegate = self.delegate;</div><div class="line">    YYAsyncLayerDisplayTask *task = [delegate newAsyncDisplayTask];</div><div class="line">  // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>- _displayAsync</code>æ–¹æ³•é‡Œé¢ä¸»è¦åˆ†æˆä¸‰éƒ¨åˆ†ï¼š</p>
<p>å¦‚æœæ²¡æœ‰è®¾ç½®displayå›è°ƒï¼Œlayerçš„å†…å®¹ä¼šè¢«æ¸…ç©º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">if (!task.display) &#123;</div><div class="line">    if (task.willDisplay) task.willDisplay(self);</div><div class="line">    self.contents = nil;</div><div class="line">    if (task.didDisplay) task.didDisplay(self, YES);</div><div class="line">    return;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®ä¹‹å‰<code>displaysAsynchronously</code>å±æ€§è®¾ç½®åˆ¤æ–­ï¼Œå¦‚æœæ˜¯åŒæ­¥ç»˜åˆ¶çš„è¯ï¼Œå®é™…ä¸Šçš„æ“ä½œå°±æ˜¯åœ¨è°ƒç”¨å®Œ<code>display</code>blockä¹‹åï¼Œå°†sublayeråˆæˆä¸€å¼ å›¾ä½œä¸ºlayerçš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[self increase];</div><div class="line">if (task.willDisplay) task.willDisplay(self);</div><div class="line">UIGraphicsBeginImageContextWithOptions(self.bounds.size,self.opaque,self.contentsScale);</div><div class="line">CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line">task.display(context, self.bounds.size, ^&#123;return NO;&#125;);</div><div class="line">UIImage *image = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">UIGraphicsEndImageContext();</div><div class="line">self.contents = (__bridge id)(image.CGImage);</div><div class="line">if (task.didDisplay) task.didDisplay(self, YES);</div></pre></td></tr></table></figure>
<p>è€Œå¼‚æ­¥æ¸²æŸ“çš„å¤„ç†å’ŒåŒæ­¥æ¸²æŸ“å¤§åŒå°å¼‚ï¼Œç¬¬ä¸€ï¼Œå¤šäº†ä¸€ä¸ª<code>BOOL (^isCancelled)()</code>blockï¼Œè¿™ä¸ªblockçš„å¥½å¤„æ˜¯ï¼Œåœ¨<code>display</code>blockè°ƒç”¨ç»˜åˆ¶å‰ï¼Œå¯ä»¥é€šè¿‡åˆ¤æ–­<code>isCancelled</code>å¸ƒå°”å€¼çš„å€¼æ¥åœæ­¢ç»˜åˆ¶ï¼Œå‡å°‘æ€§èƒ½ä¸Šçš„æ¶ˆè€—ï¼Œä»¥åŠé¿å…å‡ºç°çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œæ¯”å¦‚TableViewå¿«é€Ÿæ»‘åŠ¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡è¿™æ ·çš„åˆ¤æ–­ï¼Œæ¥é¿å…ä¸å¿…è¦çš„ç»˜åˆ¶ï¼Œæå‡æ»‘åŠ¨çš„æµç•…æ€§ï¼Œç¬¬äºŒï¼Œå°†ä¸Šé¢åŒæ­¥çš„ç»˜åˆ¶å¤„ç†æ”¾åˆ°äº†å¼‚æ­¥å»åšï¼Œç»˜åˆ¶æ–¹å¼æ˜¯ä¸€æ ·çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">if (task.willDisplay) task.willDisplay(self);</div><div class="line">int32_t value = self.value;</div><div class="line">BOOL (^isCancelled)() = ^BOOL() &#123;</div><div class="line">    return value != self.value;</div><div class="line">&#125;;</div><div class="line">CGSize size = self.bounds.size;</div><div class="line">BOOL opaque = self.opaque;</div><div class="line">CGFloat scale = self.contentsScale;</div><div class="line">if (size.width &lt; 1 || size.height &lt; 1) &#123;</div><div class="line">    CGImageRef image = (__bridge_retained CGImageRef)(self.contents);</div><div class="line">    self.contents = nil;</div><div class="line">    if (image) &#123;</div><div class="line">        dispatch_async(FIMAsyncLayerGetReleaseQueue(), ^&#123;</div><div class="line">            CFRelease(image);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    if (task.didDisplay) task.didDisplay(self, YES);</div><div class="line">    return;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dispatch_async(FIMAsyncLayerGetDisplayQueue(), ^&#123;</div><div class="line">    if (isCancelled()) return;</div><div class="line">    UIGraphicsBeginImageContextWithOptions(size, opaque, scale);</div><div class="line">    CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line">    task.display(context, size, isCancelled);</div><div class="line">    if (isCancelled()) &#123;</div><div class="line">        UIGraphicsEndImageContext();</div><div class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            if (task.didDisplay) task.didDisplay(self, NO);</div><div class="line">        &#125;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">    UIGraphicsEndImageContext();</div><div class="line">    if (isCancelled()) &#123;</div><div class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            if (task.didDisplay) task.didDisplay(self, NO);</div><div class="line">        &#125;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        if (isCancelled()) &#123;</div><div class="line">            if (task.didDisplay) task.didDisplay(self, NO);</div><div class="line">        &#125; else &#123;</div><div class="line">            self.contents = (__bridge id)(image.CGImage);</div><div class="line">            if (task.didDisplay) task.didDisplay(self, YES);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¼‚æ­¥çš„é˜Ÿåˆ—ä¹Ÿæ˜¯è‡ªå·±åˆ›å»ºçš„ï¼Œåœ¨é¢„è®¾äº†ä¸€ä¸ªé˜Ÿåˆ—æœ€å¤§å€¼ä¹‹åï¼Œé€šè¿‡è·å–è¿è¡Œè¯¥è¿›ç¨‹çš„ç³»ç»Ÿå¤„äºæ¿€æ´»çŠ¶æ€çš„å¤„ç†å™¨æ•°é‡æ¥åˆ›å»ºé˜Ÿåˆ—ï¼Œä½¿å¾—ç»˜åˆ¶çš„æ•ˆç‡è¾¾åˆ°æœ€é«˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">static dispatch_queue_t FIMAsyncLayerGetDisplayQueue() &#123;</div><div class="line">#define MAX_QUEUE_COUNT 16</div><div class="line">    static int queueCount;</div><div class="line">    static dispatch_queue_t queues[MAX_QUEUE_COUNT];</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    static int32_t counter = 0;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        queueCount = (int)[NSProcessInfo processInfo].activeProcessorCount;</div><div class="line">        queueCount = queueCount &lt; 1 ? 1 : queueCount &gt; MAX_QUEUE_COUNT ? MAX_QUEUE_COUNT : queueCount;</div><div class="line">        if ([UIDevice currentDevice].systemVersion.floatValue &gt;= 8.0) &#123;</div><div class="line">            for (NSUInteger i = 0; i &lt; queueCount; i++) &#123;</div><div class="line">                dispatch_queue_attr_t attr = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, QOS_CLASS_USER_INITIATED, 0);</div><div class="line">                queues[i] = dispatch_queue_create(&quot;com.ibireme.FIMkit.render&quot;, attr);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            for (NSUInteger i = 0; i &lt; queueCount; i++) &#123;</div><div class="line">                queues[i] = dispatch_queue_create(&quot;com.ibireme.FIMkit.render&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">                dispatch_set_target_queue(queues[i], dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    int32_t cur = OSAtomicIncrement32(&amp;counter);</div><div class="line">    if (cur &lt; 0) cur = -cur;</div><div class="line">    return queues[(cur) % queueCount];</div><div class="line">#undef MAX_QUEUE_COUNT</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x03__u8865_u5145"><a href="#0x03__u8865_u5145" class="headerlink" title="0x03 è¡¥å……"></a>0x03 è¡¥å……</h2><p>åœ¨<code>æ–‡æœ¬</code>çš„å®ç°ä¸Šï¼Œæˆ‘ä»¬æ›´åŠ æ¨èä½¿ç”¨CoreTextï¼ŒCoreTextå¯¹è±¡å ç”¨çš„å†…å­˜å°‘ï¼Œè€Œä¸”é€‚ç”¨äºæ–‡æœ¬æ’ç‰ˆå¤æ‚çš„æƒ…å†µï¼Œè™½ç„¶åœ¨å®ç°ä¸Šè¾ƒä¸ºå¤æ‚ï¼Œä½†æ˜¯æ‰€å¸¦æ¥çš„å¥½å¤„è¿œè¿œè¦å¤š</p>
<p>åœ¨æ¸²æŸ“<code>å›¾ç‰‡</code>æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨åå°æŠŠå›¾ç‰‡ç»˜åˆ¶åˆ°<code>CGBitmapContext</code>ä¸­ï¼Œç„¶åä»<code>Bitmap</code>ç›´æ¥åˆ›å»ºå›¾ç‰‡ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨åŸæ¥ImageViewè¯»å–Imageçš„æ–¹å¼æ˜¯ï¼Œåœ¨åˆ›å»ºImageæˆ–è€…CGImageSourceå¯¹è±¡æ—¶ï¼Œå›¾ç‰‡æ•°æ®å¹¶ä¸ä¼šç«‹å³è§£ç ï¼Œè€Œæ˜¯ç­‰åˆ°è®¾ç½®åˆ°ImageViewæˆ–è€…layer.contentsï¼Œlayerè¢«æäº¤åˆ°GPUä¹‹å‰ï¼Œæ‰è§£ç ï¼Œå¹¶ä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼Œæ˜¯ç›¸å½“è€—æ€§èƒ½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ç”¨æ¨èçš„æ–¹å¼å»ç»˜åˆ¶ï¼Œè€Œä¸”AFNetworkingåœ¨å¯¹å›¾ç‰‡å¤„ç†çš„æ—¶å€™ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/AFURLResponseSerializationImage.png" alt=""></p>
<h2 id="0x04__u7B80_u5355_u5B9E_u73B0demo"><a href="#0x04__u7B80_u5355_u5B9E_u73B0demo" class="headerlink" title="0x04 ç®€å•å®ç°demo"></a>0x04 ç®€å•å®ç°demo</h2><p>å¯¹äºä¸Šè¿°ä¼˜åŒ–ç‚¹ï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªç®€å•çš„<a href="https://github.com/Yuzeyang/GCAsyncDisplayDemo" target="_blank" rel="external">CoreText demo</a>ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªdemoåšè¿›ä¸€æ­¥äº†è§£~</p>
<h2 id="0x05__u76F8_u5173_u63A8_u8350_u9605_u8BFB"><a href="#0x05__u76F8_u5173_u63A8_u8350_u9605_u8BFB" class="headerlink" title="0x05 ç›¸å…³æ¨èé˜…è¯»"></a>0x05 ç›¸å…³æ¨èé˜…è¯»</h2><p><a href="http://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/" target="_blank" rel="external">iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=400417748&amp;idx=1&amp;sn=0c5f6747dd192c5a0eea32bb4650c160&amp;scene=27&amp;uin=MjI5NjY4NTU%3D&amp;key=7b81aac53bd2393d5c4f70d3d589ce1750179035ed3e4fc89454779d85881a9acd97a28bef1484ddbcfcd3250861abc7&amp;devicetype=iMac+MacBookPro11%2C1+OSX+OSX+10.11.6+build(15G31" target="_blank" rel="external">iOS äº‹ä»¶å¤„ç†æœºåˆ¶ä¸å›¾åƒæ¸²æŸ“è¿‡ç¨‹</a>&amp;version=12000110&amp;lang=zh_CN&amp;nettype=WIFI&amp;fontScale=100&amp;pass_ticket=JE1V0DIEopWtscTKwaYEiHN6qmvNRu9O60t4vUkn3Ek%3D)</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é‡æ„å®ŒSocketä¹‹åï¼Œæœ€è¿‘æˆ‘ä»¬ä¹Ÿå¼€å§‹é’ˆå¯¹IMçš„UIåšäº†ä¼˜åŒ–ï¼Œè¿™æ¬¡çš„ä¼˜åŒ–æˆ‘ä»¬ä¸»è¦æ˜¯å‚è€ƒäº†&lt;a href=&quot;https://github.com/ibireme/YYKit&quot;&gt;YYKit&lt;/a&gt;å¯¹äºæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–ï¼Œå‰æœŸæˆ‘çš„å¦ä¸€ä¸ªå°ä¼™ä¼´&lt;a href=&quot;http://broccoliii.me/&quot;&gt;è¥¿å…°èŠ±&lt;/a&gt;ä¹Ÿå¯¹&lt;a href=&quot;https://github.com/facebook/AsyncDisplayKit&quot;&gt;AsyncDisplayKit&lt;/a&gt;åšäº†è°ƒç ”ï¼Œä¸è¿‡è¿™ä¸ªåº“ç†è§£èµ·æ¥ç¡®å®è¦è´¹ä¸€ç•ªåŠŸå¤«ï¼Œç”±äºYYkitçš„æ ¸å¿ƒæ€è·¯åŸºæœ¬ä¸Šéƒ½æ˜¯å­¦ä¹ AsyncDisplayKitçš„ï¼Œç›¸ä¿¡YYkitè¿™ä¸ªåº“å¤§å®¶éƒ½å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸è¿‡å¯èƒ½è¿˜æ²¡æœ‰çœ‹è¿‡è¿™ä¸ªåº“ï¼Œé‚£ä¸‹é¢æˆ‘åšä¸€ä¸ªç®€å•çš„ä»‹ç»&lt;/p&gt;
    
    </summary>
    
    
      <category term="IM å¼‚æ­¥ç»˜åˆ¶" scheme="http://yuzeyang.github.io/tags/IM-%E5%BC%82%E6%AD%A5%E7%BB%98%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>iOS Socketé‡æ„è®¾è®¡</title>
    <link href="http://yuzeyang.github.io/2016/06/22/GCDAsyncSocket-socket-optimize/"/>
    <id>http://yuzeyang.github.io/2016/06/22/GCDAsyncSocket-socket-optimize/</id>
    <published>2016-06-22T15:02:22.000Z</published>
    <updated>2016-06-23T08:48:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åŸºäºGCDAsyncSocketå°è£…äº†ä¸€ä¸ªSocket Managerç±»ï¼Œä½†æ˜¯ç”±äºä¸šåŠ¡å¤æ‚åº¦çš„ä¸Šå‡ï¼Œä¹‹å‰è®¾è®¡çš„ä¸šåŠ¡æ¥å£çš„æ•°é‡é€æ¸å¢åŠ ï¼Œä»£ç†å›è°ƒä¹Ÿéšä¹‹å¢åŠ ï¼Œä»£ç†çš„ä½¿ç”¨ä¹Ÿè¶Šæ¥è¶Šéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬é’ˆå¯¹socketé€šä¿¡è¿™å—ï¼Œè¿›è¡Œäº†ä¸€æ¬¡é‡æ„</p>
<p>è¿™é‡Œæœ‰æˆ‘ä»¬çš„æ–°ç«¥é‹<a href="http://broccoliii.me/" target="_blank" rel="external">è¥¿å…°èŠ±</a>å¾ˆå¤§çš„åŠŸåŠ³å“ˆ~</p>
<p>ä»£ç åœ°å€ï¼š<a href="https://github.com/Yuzeyang/GCDAsyncSocketManager" target="_blank" rel="external">GCDAsyncSocketManager</a></p>
<a id="more"></a>
<p>ä¹‹å‰çš„è®¾è®¡æ–¹æ¡ˆå¯ä»¥çœ‹è¿™é‡Œï¼š<a href="http://zeeyang.com/2016/01/17/GCDAsyncSocket-socket/" target="_blank" rel="external">socketé‡æ„å‰æ–¹æ¡ˆ</a></p>
<p>é’ˆå¯¹è€çš„è®¾è®¡ï¼Œæˆ‘ä»¬åšå‡ºäº†ä»¥ä¸‹å‡ ç‚¹ä¿®æ”¹æ–¹å‘ï¼š</p>
<h2 id="0x00__u62C6_u5206SocketManager"><a href="#0x00__u62C6_u5206SocketManager" class="headerlink" title="0x00 æ‹†åˆ†SocketManager"></a>0x00 æ‹†åˆ†SocketManager</h2><p>é¦–å…ˆæˆ‘ä»¬å¯¹SocketManagerè¿›è¡Œå¼€åˆ€ï¼Œæˆ‘ä»¬å°†socketç›¸å…³çš„æ“ä½œå’Œä¸šåŠ¡ç›¸å…³çš„æ“ä½œè¿›è¡Œæ‹†åˆ†ï¼Œå°†ä¸šåŠ¡ç›¸å…³çš„å•ç‹¬æ”¾åˆ°ä¸€ä¸ªç±»é‡Œé¢å®Œæˆï¼Œæˆ‘ä»¬å‘½åå®ƒä¸ºCommunicationManager</p>
<p>ç°åœ¨åœ¨SocketManageré‡Œé¢ï¼Œæˆ‘ä»¬åªä¿ç•™äº†<code>æœåŠ¡å™¨è¯»å†™æ•°æ®</code>ã€<code>æ–­å¼€è¿æ¥</code>ã€<code>å¿ƒè·³</code>ã€<code>é‡è¿</code>ã€<code>GCDAsyncSocketå›è°ƒè®¾ç½®</code></p>
<p>åœ¨CommunicationManageré‡Œé¢ï¼Œæˆ‘ä»¬åšæ‰€æœ‰ä¸šåŠ¡çš„æ“ä½œ</p>
<h2 id="0x01__u4E1A_u52A1_u63A5_u53E3_u6539_u4E3A_u901A_u7528_u63A5_u53E3"><a href="#0x01__u4E1A_u52A1_u63A5_u53E3_u6539_u4E3A_u901A_u7528_u63A5_u53E3" class="headerlink" title="0x01 ä¸šåŠ¡æ¥å£æ”¹ä¸ºé€šç”¨æ¥å£"></a>0x01 ä¸šåŠ¡æ¥å£æ”¹ä¸ºé€šç”¨æ¥å£</h2><p>ç”±äºä¸šåŠ¡è¯·æ±‚ç±»å‹çš„ä¸æ–­å¢åŠ ï¼Œä¸šåŠ¡æ¥å£çš„æ•°é‡ä¹Ÿåœ¨ä¸æ–­å¢åŠ ï¼Œè¿™æ ·ä½¿å¾—å¤´æ–‡ä»¶ä¸€çœ¼æœ›ä¸åˆ°åº•â€¦è‡ªå·±çœ‹èµ·æ¥éƒ½å¾ˆå¤´ç–¼ï¼Œæ›´åˆ«è¯´æ˜¯ä½¿ç”¨æ–¹äº†â€¦</p>
<p>é¦–å…ˆæˆ‘ä»¬å°†ä¸åŒçš„ä¸šåŠ¡è¯·æ±‚ä»¥æšä¸¾çš„æ–¹å¼åˆ—å‡ºæ¥ï¼Œæ–¹ä¾¿å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™æŸ¥çœ‹ï¼Œå¹¶ä¸”æœ€å¥½åœ¨æšä¸¾åé¢åŠ ä¸Šæ³¨é‡Šï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  ä¸šåŠ¡ç±»å‹</div><div class="line"> */</div><div class="line">typedef NS_ENUM(NSInteger, FIMRequestType) &#123;</div><div class="line">    FIMRequestType_Beat = 1,                       //å¿ƒè·³</div><div class="line">    FIMRequestType_ConnectionAuthAppraisal,        //è¿æ¥é‰´æƒ</div><div class="line">  	FIMRequestType_GetConversationsList,           //è·å–ä¼šè¯åˆ—è¡¨</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†ä¸šåŠ¡æ¥å£ç”¨ä¸‹é¢è¿™ä¸€ä¸ªé€šç”¨çš„æ¥å£æ›¿æ¢æ‰ï¼Œåªéœ€è¦ä¼ <code>type</code>ä¸šåŠ¡è¯·æ±‚ç±»å‹ï¼Œ<code>body</code>è¯·æ±‚ä½“å’Œ<code>callback</code>å›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  å‘æœåŠ¡å™¨å‘é€æ•°æ®</div><div class="line"> *</div><div class="line"> *  @param type    è¯·æ±‚ç±»å‹</div><div class="line"> *  @param body    è¯·æ±‚ä½“</div><div class="line"> */</div><div class="line">- (void)socketWriteDataWithRequestType:(FIMRequestType)type</div><div class="line">                           requestBody:(nonnull NSDictionary *)body</div><div class="line">                            completion:(nullable SocketDidReadBlock)callback;</div></pre></td></tr></table></figure>
<p>æ¯”å¦‚ä¸šåŠ¡æ–¹å¯ä»¥å¦‚ä¸‹ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NSDictionary *requestBody = @&#123; @&quot;limit&quot;: @(10), @&quot;offset&quot;: @(0) &#125;;</div><div class="line">[[FIMCommunicationManager sharedInstance]</div><div class="line">socketWriteDataWithRequestType:FIMRequestType_GetConversationsList</div><div class="line">                   requestBody:requestBody</div><div class="line">                    completion:^(NSError *error, id data) &#123;</div><div class="line">                        // do something</div><div class="line">                    &#125;];</div></pre></td></tr></table></figure>
<h2 id="0x02__u544A_u522BDelegate_uFF0C_u4F7F_u7528Blcok"><a href="#0x02__u544A_u522BDelegate_uFF0C_u4F7F_u7528Blcok" class="headerlink" title="0x02 å‘Šåˆ«Delegateï¼Œä½¿ç”¨Blcok"></a>0x02 å‘Šåˆ«Delegateï¼Œä½¿ç”¨Blcok</h2><p>å‰é¢ä¹Ÿæåˆ°ï¼Œä¹‹å‰ä¼šå¯¹ä¸åŒçš„ä¸šåŠ¡è¯·æ±‚ï¼Œè®¾å®šç›¸åº”çš„delegateå›è°ƒï¼Œä½†æ˜¯æ•°é‡ä¸€å¤šï¼Œä½¿ç”¨èµ·æ¥é‚£çœŸçš„æ˜¯æ§½ç³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å‚è€ƒ<code>AFNetworking</code>çš„åšæ³•ï¼Œå‘èµ·è¯·æ±‚æ—¶å°†blockä¸ä¸€ä¸ªå”¯ä¸€æ ‡è¯†è¿›è¡Œç»‘å®šï¼ŒåŒæ—¶å°†è¿™ä¸ªå”¯ä¸€æ ‡è¯†æ”¾åˆ°è¯·æ±‚é‡Œé¢å‘ç»™æœåŠ¡å™¨ï¼ˆæœåŠ¡å™¨å¯¹è¯¥æ ‡è¯†ä¸åšä»»ä½•å¤„ç†ï¼‰ï¼Œåœ¨ç­‰åˆ°GCDAsyncSocketå›è°ƒå›æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡æœåŠ¡å™¨è¿”å›çš„è¿™ä¸ªæ ‡è¯†ï¼Œæ‰¾åˆ°å¯¹åº”çš„blockå›è°ƒå‡ºå»ï¼Œè¿™æ ·å¯¹ä¸šåŠ¡æ–¹æ¥è¯´ï¼Œè¿™ä¸ªsocketæ¥å£ç”¨èµ·æ¥å…¶å®å’ŒHTTPè¯·æ±‚æ¥å£æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå°†è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¹Ÿå…³è”èµ·æ¥äº†</p>
<p>å¦‚å›¾ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/replaceDelegate.png" alt=""></p>
<p>å…·ä½“å®ç°ï¼š</p>
<p>å‘èµ·è¯·æ±‚æ—¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (void)socketWriteDataWithRequestType:(FIMRequestType)type</div><div class="line">                           requestBody:(nonnull NSDictionary *)body</div><div class="line">                            completion:(nullable SocketDidReadBlock)callback &#123;</div><div class="line">  // ...                            </div><div class="line">   </div><div class="line">  // ç”Ÿæˆå”¯ä¸€æ ‡è¯†</div><div class="line">  NSString *blockRequestID = [self createRequestID];</div><div class="line">  if (callback) &#123;</div><div class="line">      // å°†blockå’Œæ ‡è¯†è¿›è¡Œç»‘å®šï¼Œå­˜åˆ°ä¸€ä¸ªå…¨å±€å˜é‡é‡Œé¢</div><div class="line">      [self.requestsMap setObject:callback forKey:blockRequestID];</div><div class="line">  &#125;</div><div class="line">                              </div><div class="line">  // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¥æ”¶åˆ°GCDAsyncSocketå›è°ƒæ—¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">- (void)socket:(GCDAsyncSocket *)sock didReadData:(NSData *)data withTag:(long)tag &#123;</div><div class="line">  // ...</div><div class="line">  </div><div class="line">  // æ ¹æ®æœåŠ¡å™¨è¿”å›çš„æ ‡è¯†å¾—åˆ°ç›¸åº”çš„block</div><div class="line">  SocketDidReadBlock didReadBlock = self.requestsMap[requestID];</div><div class="line">  </div><div class="line">  switch (requestType) &#123;</div><div class="line">        case FIMRequestType_ConnectionAuthAppraisal: &#123;</div><div class="line">            if (didReadBlock) &#123;</div><div class="line">                didReadBlock(nil, nil);</div><div class="line">            &#125;</div><div class="line">        &#125; break;</div><div class="line">    	// ...</div><div class="line">    	default: &#123;</div><div class="line">            // do something</div><div class="line">        &#125; break;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="0x03__u4F7F_u7528_u6A21_u62DF_u670D_u52A1_u5668_u65F6_u95F4_uFF0C_u6765_u89E3_u51B3_u7F13_u5B58_u6D88_u606F_u4FDD_u5E8F_u95EE_u9898"><a href="#0x03__u4F7F_u7528_u6A21_u62DF_u670D_u52A1_u5668_u65F6_u95F4_uFF0C_u6765_u89E3_u51B3_u7F13_u5B58_u6D88_u606F_u4FDD_u5E8F_u95EE_u9898" class="headerlink" title="0x03 ä½¿ç”¨æ¨¡æ‹ŸæœåŠ¡å™¨æ—¶é—´ï¼Œæ¥è§£å†³ç¼“å­˜æ¶ˆæ¯ä¿åºé—®é¢˜"></a>0x03 ä½¿ç”¨æ¨¡æ‹ŸæœåŠ¡å™¨æ—¶é—´ï¼Œæ¥è§£å†³ç¼“å­˜æ¶ˆæ¯ä¿åºé—®é¢˜</h2><p>åœ¨socketæ¨¡å—é‡Œé¢ï¼Œæˆ‘ä»¬åŸºäºFMDBå®ç°äº†ä¸€å¥—ç¼“å­˜æœºåˆ¶ï¼Œä½†æ˜¯èŠå¤©é¡µé¢å¯¹æ•°æ®åº“è¯»å†™æ“ä½œçš„åœºæ™¯éå¸¸å¤æ‚ï¼Œè€Œä¸”æˆ‘ä»¬å¯¹å‘é€å¤±è´¥çš„æ¶ˆæ¯ä¹Ÿè¿›è¡Œäº†ç¼“å­˜ï¼Œå¦‚æœä½¿ç”¨msgIDå¯¹æ¶ˆæ¯è¿›è¡Œä¿åºï¼Œä½ è¦è€ƒè™‘å‘é€æˆåŠŸå’Œå¤±è´¥æ¶ˆæ¯çš„æ’åºï¼Œä»¥åŠé‡å‘æ¶ˆæ¯ä¹‹åçš„æ’åºï¼Œç­‰ç­‰åœºæ™¯ï¼Œè¿™æ ·å®ç°èµ·æ¥ä¹Ÿä¼šå¾ˆè®©äººå¤´å¤§</p>
<p>æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨<code>æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´</code>æ¥è¿›è¡Œä¿åºï¼Œè¿™æ ·ä¸ç®¡æ¶ˆæ¯æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Œä»æ•°æ®åº“é‡Œé¢è¯»å‡ºæ¥çš„æ•°æ®ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®åˆ›å»ºæ—¶é—´æ¥æ’ä¸‹åºè¿”å›ç»™ä¸šåŠ¡å±‚ï¼Œå¦‚æœä¸šåŠ¡å±‚å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›´æ–°æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´ï¼Œè¿™æ ·ä¸‹æ¬¡å–å‡ºæ¥çš„é¡ºåºå’ŒUIå±•ç¤ºçš„é¡ºåºä¹Ÿè¿˜æ˜¯ä¸€æ ·çš„</p>
<p>é‚£è¿™ä¸ªåˆ›å»ºæ—¶é—´æ˜¯ç”±æœåŠ¡å™¨ç”Ÿæˆçš„ï¼Œè€Œä¸”æ¶ˆæ¯å‘é€æˆåŠŸä¹‹åï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šè¿”å›ç»™æˆ‘ä»¬è¿™æ¡æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´ï¼Œè€Œä¸”å¤±è´¥çš„æ¶ˆæ¯æœåŠ¡å™¨é‚£è¾¹æ˜¯ä¸ä¼šå­˜çš„ï¼Œæ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬æœ¬åœ°æ¨¡æ‹ŸæœåŠ¡å™¨æ¥ç”Ÿæˆè¿™ä¸ªæ—¶é—´</p>
<p>å› ä¸ºè€ƒè™‘åˆ°æœ¬åœ°æ—¶é—´å’ŒæœåŠ¡å™¨æ—¶é—´å­˜åœ¨åå·®ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨socketå»ºç«‹è¿æ¥æˆåŠŸä¹‹åï¼Œè¿”å›ç»™æˆ‘ä»¬æœåŠ¡å™¨æ—¶é—´ï¼Œæˆ‘ä»¬æ‹¿åˆ°æœåŠ¡å™¨æ—¶é—´ä¹‹åå’Œæ‰‹æœºçš„æœ¬åœ°æ—¶é—´åšä¸ªæ¯”è¾ƒï¼Œè®°å½•ä¸‹è¿™ä¸ªåå·®å€¼ï¼Œç„¶åä¸šåŠ¡å±‚åœ¨è°ƒç”¨å‘é€æ¶ˆæ¯çš„æ¥å£æ—¶ï¼Œsocketå†…éƒ¨æ¨¡æ‹Ÿå‡ºæœåŠ¡å™¨åˆ›å»ºæ—¶é—´èµ‹å€¼ç»™è¯¥æ¶ˆæ¯ï¼Œç„¶åå­˜åˆ°æ•°æ®åº“é‡Œé¢ï¼Œè¿™æ ·å°±å¯ä»¥åŸºæœ¬ä¿è¯æ•°æ®åº“å­˜å‚¨æ¶ˆæ¯çš„é¡ºåºå’ŒæœåŠ¡å™¨çš„é¡ºåºæ˜¯ä¸€è‡´çš„</p>
<p>å¦‚å›¾ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/serverCreateTime.png" alt=""></p>
<h2 id="0x04__u76D1_u542C_u7F51_u7EDC_u72B6_u6001_u6765_u6539_u53D8socket_u8FDE_u63A5_u72B6_u6001"><a href="#0x04__u76D1_u542C_u7F51_u7EDC_u72B6_u6001_u6765_u6539_u53D8socket_u8FDE_u63A5_u72B6_u6001" class="headerlink" title="0x04 ç›‘å¬ç½‘ç»œçŠ¶æ€æ¥æ”¹å˜socketè¿æ¥çŠ¶æ€"></a>0x04 ç›‘å¬ç½‘ç»œçŠ¶æ€æ¥æ”¹å˜socketè¿æ¥çŠ¶æ€</h2><p>æˆ‘ä»¬å¯¹socketè¿æ¥çŠ¶æ€ä¹Ÿåšäº†å¾®è°ƒï¼Œæˆ‘ä»¬é€šè¿‡æµ‹è¯•å¾®ä¿¡çš„è¿æ¥ï¼Œå‘ç°ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<p>1ã€ç½‘ç»œæ–­å¼€åï¼Œsocketç›´æ¥æ–­å¼€ï¼Œæ˜¾ç¤ºâ€œæœªè¿æ¥â€</p>
<p>2ã€æœ‰ç½‘ä½†æ˜¯socketè¿æ¥ä¸ä¸Šæ—¶ï¼Œsocketä¼šä¸€ç›´é‡è¿ï¼Œé‡è¿næ¬¡åï¼Œä¼‘çœ å‡ ç§’åï¼Œå†é‡è¿ï¼Œå¦‚æ­¤å¾ªç¯</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯¹socketè¿æ¥åšäº†è°ƒæ•´ï¼Œç”¨<code>AFNetWorking</code>åº“é‡Œé¢ç›‘æµ‹ç½‘ç»œçŠ¶æ€ç±»<code>AFNetworkReachabilityManager</code>ï¼ˆ<a href="http://zeeyang.com/2016/05/23/AFNetWorking-four/" target="_blank" rel="external">AFNetworkReachabilityManageråŸç†</a>ï¼‰ï¼Œåœ¨æ— ç½‘æ—¶ï¼Œåˆ¤æ–­å¦‚æœsocketæ­£åœ¨è¿æ¥æˆ–è€…å·²è¿æ¥æ—¶ï¼Œæˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨<code>disconnect</code>æ–­å¼€è¿æ¥ï¼Œå¦‚æœæœ‰ç½‘ï¼Œåˆ¤æ–­å¦‚æœsocketæœªè¿æ¥ï¼Œæˆ‘ä»¬ä¸»åŠ¨å»ºç«‹è¿æ¥ï¼Œå»ºç«‹è¿æ¥ä¸æˆåŠŸçš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬èµ°é‡è¿çš„æµç¨‹ï¼Œåªæ˜¯æˆ‘ä»¬ä¾æ—§ä¿æŒäº†é‡è¿næ¬¡åï¼Œnæ¬¡å¤±è´¥åä¸å†é‡è¿äº†ï¼Œè¿™ä¸ªæ˜¯ä¸å¾®ä¿¡ä¸åŒçš„åœ°æ–¹</p>
<h2 id="0x05__u4F7F_u7528FIMSocketModel"><a href="#0x05__u4F7F_u7528FIMSocketModel" class="headerlink" title="0x05 ä½¿ç”¨FIMSocketModel"></a>0x05 ä½¿ç”¨FIMSocketModel</h2><p>å› ä¸ºè¯·æ±‚çš„æ•°æ®ç»“æ„åŸºæœ¬ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰äº†FIMSocketModelç±»æ¥æ–¹ä¾¿å¯¹æ•°æ®çš„è½¬åŒ–ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡ ä¸ªå¿…ä¼ çš„å­—æ®µï¼Œä»¥åŠå¯èƒ½è¯·æ±‚ä¸åŒæ‰€éœ€çš„ä¸€äº›éå¿…ä¼ å­—æ®µï¼Œç”±äºä¹‹å‰æˆ‘ä»¬bodyä½“é‡Œé¢çš„å†…å®¹æ˜¯åšäº†2æ¬¡JSONè½¬åŒ–å¤„ç†çš„ï¼Œæ‰€ä»¥ä¸šåŠ¡å±‚ä¼ å…¥bodyå†…å®¹æ—¶å«è‹¦è¿å¤©ï¼ŒFIMSocketModelä¹Ÿå¢åŠ äº†<code>- socketModelToJSONString</code>æ–¹æ³•ï¼Œæ–¹ä¾¿Socketå†…éƒ¨è½¬åŒ–æˆJSONå¤„ç†ï¼Œè¿™æ ·ä¸šåŠ¡å±‚åªéœ€è¦ä¼ ä¸€ä¸ªå­—å…¸è¿›æ¥ï¼ŒSocketå†…éƒ¨å°±ä¼šå¤„ç†å¥½ä¸€åˆ‡ï¼Œä½¿ç”¨èµ·æ¥ä¸€ä¸‹å°±æ–¹ä¾¿äº†~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰åŸºäºGCDAsyncSocketå°è£…äº†ä¸€ä¸ªSocket Managerç±»ï¼Œä½†æ˜¯ç”±äºä¸šåŠ¡å¤æ‚åº¦çš„ä¸Šå‡ï¼Œä¹‹å‰è®¾è®¡çš„ä¸šåŠ¡æ¥å£çš„æ•°é‡é€æ¸å¢åŠ ï¼Œä»£ç†å›è°ƒä¹Ÿéšä¹‹å¢åŠ ï¼Œä»£ç†çš„ä½¿ç”¨ä¹Ÿè¶Šæ¥è¶Šéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬é’ˆå¯¹socketé€šä¿¡è¿™å—ï¼Œè¿›è¡Œäº†ä¸€æ¬¡é‡æ„&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæœ‰æˆ‘ä»¬çš„æ–°ç«¥é‹&lt;a href=&quot;http://broccoliii.me/&quot;&gt;è¥¿å…°èŠ±&lt;/a&gt;å¾ˆå¤§çš„åŠŸåŠ³å“ˆ~&lt;/p&gt;
&lt;p&gt;ä»£ç åœ°å€ï¼š&lt;a href=&quot;https://github.com/Yuzeyang/GCDAsyncSocketManager&quot;&gt;GCDAsyncSocketManager&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Socket" scheme="http://yuzeyang.github.io/tags/Socket/"/>
    
  </entry>
  
  <entry>
    <title>å®¢æˆ·ç«¯ç”Ÿæˆä¸ƒç‰›ä¸Šä¼ token</title>
    <link href="http://yuzeyang.github.io/2016/06/13/Qiniu-token/"/>
    <id>http://yuzeyang.github.io/2016/06/13/Qiniu-token/</id>
    <published>2016-06-13T15:07:54.000Z</published>
    <updated>2016-06-13T16:24:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨ä¸ƒç‰›iOS SDKä¸Šä¼ å›¾ç‰‡æ—¶éœ€è¦ç”¨åˆ°ä¸Šä¼ çš„tokenï¼Œè™½ç„¶ä¸ƒç‰›å»ºè®®tokenä¸è¦åœ¨å®¢æˆ·ç«¯ç”Ÿæˆï¼Œè¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯éœ€è¦äº†è§£ä¸‹å®¢æˆ·ç«¯æ˜¯å¦‚ä½•ç”Ÿæˆtokençš„</p>
<a id="more"></a>
<p>æˆ‘ç®€å•åœ°å¯¹ç”Ÿæˆtokenå’Œä¸Šä¼ æ•°æ®åšäº†å°è£…ï¼Œè¿™æ˜¯ä»£ç åœ°å€ï¼š<a href="https://github.com/Yuzeyang/GCQiniuUploadManager" target="_blank" rel="external">provide simple interface to create token,upload file and upload files</a></p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸‰ä¸ªå‚æ•°<code>scope</code>ã€<code>AccessKey</code>å’Œ<code>SecretKey</code></p>
<p><code>scope</code>å…¶å®å°±æ˜¯èµ„æºå­˜æ”¾çš„æ–‡ä»¶å¤¹åå­—ï¼Œä¾‹å¦‚ä¸‹å›¾çš„<code>cmxj</code></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/Qiniu_scope.png" alt=""></p>
<p><code>AccessKey</code>å’Œ<code>SecretKey</code>åœ¨ä¸ªäººé¢æ¿ -&gt; ä¸ªäººä¸­å¿ƒ -&gt; å¯†é’¥ç®¡ç†é‡Œé¢å°±èƒ½çœ‹åˆ°</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/Qiniu_AK_SK.png" alt=""></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åˆ›å»ºtokenäº†ï¼Œé¦–å…ˆæˆ‘ä»¬å°†ä¸Šä¼ ç­–ç•¥ä¸­çš„<code>scope</code>å’Œ<code>deadline</code>åºåˆ—åŒ–æˆjsonæ ¼å¼ï¼Œé‡Œé¢çš„<code>liveTime</code>åˆ™æ˜¯tokençš„æœ‰æ•ˆæ—¶é—´ï¼Œå¯ä»¥ä»¥å¤©ä¸ºå•ä½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSMutableDictionary *authInfo = [NSMutableDictionary dictionary];</div><div class="line">[authInfo setObject:self.scope forKey:@&quot;scope&quot;];</div><div class="line">[authInfo</div><div class="line">setObject:[NSNumber numberWithLong:[[NSDate date] timeIntervalSince1970] + self.liveTime * 24 * 3600]</div><div class="line">   forKey:@&quot;deadline&quot;];</div><div class="line"></div><div class="line">NSData *jsonData =</div><div class="line">[NSJSONSerialization dataWithJSONObject:authInfo options:NSJSONWritingPrettyPrinted error:nil];</div></pre></td></tr></table></figure>
<p>å†å¯¹jsonåºåˆ—åŒ–åçš„ä¸Šä¼ ç­–ç•¥è¿›è¡ŒURLå®‰å…¨çš„base64ç¼–ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSString *encodedString = [self urlSafeBase64Encode:jsonData];</div></pre></td></tr></table></figure>
<p><code>QN_GTM_Base64</code>æ˜¯ä¸ƒç‰›SDKæä¾›ç»™ç”¨æˆ·ç”¨æ¥å¤„ç†base64å’ŒWebSafeBase64ç¼–ç çš„ç±»ï¼Œç„¶åå°†é‡Œé¢çš„<code>+</code>å’Œ<code>/</code>æ›¿æ¢æˆ<code>_</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (NSString *)urlSafeBase64Encode:(NSData *)text &#123;</div><div class="line">    NSString *base64 =</div><div class="line">    [[NSString alloc] initWithData:[QN_GTM_Base64 encodeData:text] encoding:NSUTF8StringEncoding];</div><div class="line">    base64 = [base64 stringByReplacingOccurrencesOfString:@&quot;+&quot; withString:@&quot;-&quot;];</div><div class="line">    base64 = [base64 stringByReplacingOccurrencesOfString:@&quot;/&quot; withString:@&quot;_&quot;];</div><div class="line">    return base64;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åç”¨secretKeyå¯¹ç¼–ç åçš„ä¸Šä¼ ç­–ç•¥è¿›è¡ŒHMAC-SHA1åŠ å¯†ï¼Œå¹¶ä¸”åšå®‰å…¨çš„base64ç¼–ç ï¼Œå¾—åˆ°encoded_signed</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSString *encodedSignedString = [self HMACSHA1:self.secretKey text:encodedString];</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (NSString *)HMACSHA1:(NSString *)key text:(NSString *)text &#123;</div><div class="line">    const char *cKey = [key cStringUsingEncoding:NSUTF8StringEncoding];</div><div class="line">    const char *cData = [text cStringUsingEncoding:NSUTF8StringEncoding];</div><div class="line"></div><div class="line">    char cHMAC[CC_SHA1_DIGEST_LENGTH];</div><div class="line"></div><div class="line">    CCHmac(kCCHmacAlgSHA1, cKey, strlen(cKey), cData, strlen(cData), cHMAC);</div><div class="line"></div><div class="line">    NSData *HMAC = [[NSData alloc] initWithBytes:cHMAC length:CC_SHA1_DIGEST_LENGTH];</div><div class="line">    NSString *hash = [self urlSafeBase64Encode:HMAC];</div><div class="line">    return hash;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åå°†accessKeyã€encodedSignedStringå’ŒencodedStringæ‹¼æ¥ï¼Œä¸­é—´ç”¨ï¼šåˆ†å¼€ï¼Œå¾—åˆ°çš„å°±æ˜¯ä¸Šä¼ çš„token</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSString *token =</div><div class="line">    [NSString stringWithFormat:@&quot;%@:%@:%@&quot;, self.accessKey, encodedSignedString, encodedString];</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä½¿ç”¨ä¸ƒç‰›iOS SDKä¸Šä¼ å›¾ç‰‡æ—¶éœ€è¦ç”¨åˆ°ä¸Šä¼ çš„tokenï¼Œè™½ç„¶ä¸ƒç‰›å»ºè®®tokenä¸è¦åœ¨å®¢æˆ·ç«¯ç”Ÿæˆï¼Œè¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯éœ€è¦äº†è§£ä¸‹å®¢æˆ·ç«¯æ˜¯å¦‚ä½•ç”Ÿæˆtokençš„&lt;/p&gt;
    
    </summary>
    
    
      <category term="ä¸ƒç‰› token" scheme="http://yuzeyang.github.io/tags/%E4%B8%83%E7%89%9B-token/"/>
    
  </entry>
  
  <entry>
    <title>æ¨¡ä»¿iOS7 task switcherçš„å¡ç‰‡åŠ¨ç”»</title>
    <link href="http://yuzeyang.github.io/2016/06/11/iOS-card-animation/"/>
    <id>http://yuzeyang.github.io/2016/06/11/iOS-card-animation/</id>
    <published>2016-06-11T02:20:29.000Z</published>
    <updated>2016-06-11T09:25:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªiOS9çš„task switcherå¼€æºå®ç°ï¼Œä½†æ˜¯æ²¡æœ‰åˆ é™¤åŠŸèƒ½ï¼Œå°±æƒ³ç€å¹²è„†åšä¸€ä¸ªæ¨¡ä»¿iOS7ç³»ç»Ÿçš„æ•ˆæœï¼ŒåŠ ä¸Šåˆ é™¤å’Œé‡ç”¨å¡ç‰‡åŠŸèƒ½ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/GCCardViewController.gif!500x500" alt=""></p>
<p>è¿™æ˜¯ä»£ç åœ°å€ï¼š<a href="https://github.com/Yuzeyang/GCCardViewController" target="_blank" rel="external">https://github.com/Yuzeyang/GCCardViewController</a></p>
<a id="more"></a>
<p>å®ç°ä¸Šå¯ä»¥ä½¿ç”¨scrollViewæˆ–è€…collectionViewå»åšï¼Œè¿™ä¸ªæˆ‘æ˜¯ç”¨scrollViewå»åš</p>
<p>åŠŸèƒ½ç‚¹ä¸Šåˆ†ä¸ºä¸‰ç‚¹ï¼š</p>
<p>1.å¡ç‰‡æ»‘åŠ¨çš„æ•ˆæœ</p>
<p>2.å¡ç‰‡é‡ç”¨</p>
<p>3.å¡ç‰‡åˆ é™¤</p>
<h2 id="u5361_u7247_u6ED1_u52A8_u6548_u679C"><a href="#u5361_u7247_u6ED1_u52A8_u6548_u679C" class="headerlink" title="å¡ç‰‡æ»‘åŠ¨æ•ˆæœ"></a>å¡ç‰‡æ»‘åŠ¨æ•ˆæœ</h2><p>é€šè¿‡- [scrollViewDidScroll:]ä»£ç†è·å–scrollViewæ»‘åŠ¨æ—¶çš„contentOffsetå€¼ï¼Œè®¡ç®—å½“å‰contentOffsetå’ŒåŸå…ˆcontentOffsetä¹‹é—´çš„å·®å€¼diffï¼Œå†ç®—å‡ºè¿›åº¦å€¼progressï¼Œä»¥åŠæ ¹æ®å·®å€¼diffæ˜¯å¦å¤§äº0æ¥è·å–å¡ç‰‡çš„æ»‘åŠ¨æ–¹å‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)scrollViewDidScroll:(UIScrollView *)scrollView &#123;</div><div class="line">    CGFloat orginContentOffset = self.currentCardIndex*kGCScrollViewWidth;</div><div class="line">    CGFloat diff = scrollView.contentOffset.x - orginContentOffset;</div><div class="line">    CGFloat progress = fabs(diff)/(kGCViewWidth*0.8);</div><div class="line">    CardMoveDirection direction = diff &gt; 0 ? CardMoveDirectionLeft : CardMoveDirectionRight;</div><div class="line">    for (UIView *card in self.cards) &#123;</div><div class="line">        [self.cardDelegate updateCard:card withProgress:progress direction:direction];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // å¡ç‰‡é‡ç”¨</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡è°ƒç”¨è‡ªå·±çš„cardDelegateæ–¹æ³•æ›´æ–°å¡ç‰‡çš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)updateCard:(UIView *)card withProgress:(CGFloat)progress direction:(CardMoveDirection)direction;</div></pre></td></tr></table></figure>
<p>å½“å‰å¡ç‰‡ä¸ç®¡æ˜¯å·¦ç§»è¿˜æ˜¯å³ç§»ï¼Œåªéœ€è¦æ ¹æ®progressæ¥æ›´æ–°çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">card.layer.transform = CATransform3DMakeScale(1 - 0.1 * progress, 1 - 0.1 * progress, 1.0);</div><div class="line">card.layer.opacity = 1 - 0.2*progress;</div></pre></td></tr></table></figure>
<p>æ ¹æ®å·¦ç§»è¿˜æ˜¯å³ç§»ï¼Œæ¥å†³å®šæ”¹å˜å½“å‰å¡ç‰‡ä¸‹ä¸€å¼ è¿˜æ˜¯ä¸Šä¸€å¼ å¡ç‰‡çš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSInteger transCardTag = direction == CardMoveDirectionLeft ? [self.cardScrollView currentCard] + 1 : [self.cardScrollView currentCard] - 1;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">card.layer.transform = CATransform3DMakeScale(0.9 + 0.1*progress, 0.9 + 0.1*progress, 1.0);</div><div class="line">card.layer.opacity = 0.8 + 0.2*progress;</div></pre></td></tr></table></figure>
<h2 id="u5361_u7247_u91CD_u7528"><a href="#u5361_u7247_u91CD_u7528" class="headerlink" title="å¡ç‰‡é‡ç”¨"></a>å¡ç‰‡é‡ç”¨</h2><p>ç”±äºé¡µé¢ä¸Šåªæ˜¾ç¤ºä¸‰å¼ å¡ç‰‡ï¼Œæ‰€ä»¥è¦é‡ç”¨å¡ç‰‡çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å››å¼ å¡ç‰‡ï¼Œç±»ä¼¼äºtableViewCellçš„é‡ç”¨å¤„ç†ä¸€æ ·ï¼Œå½“ç¬¬ä¸€å¼ å¡ç‰‡ç¦»å¼€å±å¹•æ˜¾ç¤ºä¹‹åï¼Œå°†ç¬¬ä¸€å¼ å¡ç‰‡ç§»åˆ°æœ€åä¸€å¼ å¡ç‰‡çš„åé¢ï¼Œåä¹‹ï¼ŒåŒç†</p>
<p>åœ¨- [scrollViewDidScroll:]é‡Œé¢ï¼Œæ ¹æ®contentOffsetå˜åŒ–çš„ç»å¯¹å€¼å¤§äºscrollViewå®½åº¦çš„80%æ—¶ï¼Œå¯¹å¡ç‰‡è¿›è¡Œé‡ç”¨ï¼Œä»¥åŠæ”¹å˜å½“å‰çš„index</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (fabs(diff) &gt;= kGCScrollViewWidth*0.8) &#123;</div><div class="line">        self.currentCardIndex = direction == CardMoveDirectionLeft ? self.currentCardIndex + 1 : self.currentCardIndex - 1;</div><div class="line">        [self reuseCardWithMoveDirection:direction];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨é‡ç”¨ä¹‹å‰ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰ä½ç½®éƒ½éœ€è¦é‡ç”¨ï¼Œåœ¨indexï¼ˆindexä»0å¼€å§‹è®¡ç®—ï¼‰å°äº2æˆ–è€…indexå¤§äºæ€»å¡ç‰‡æ•°é‡-3çš„æ—¶å€™ï¼Œæ‰éœ€è¦é‡ç”¨ï¼Œå·¦ç§»æ—¶ï¼Œå–å‡ºcardsæ•°ç»„é‡Œé¢ç¬¬ä¸€ä¸ªcardï¼Œå°†cardç§»åˆ°æœ€åä¸€ä¸ªcardåé¢ï¼Œæ”¹å˜å®ƒçš„centerå°±å¯ä»¥ï¼Œå³ç§»æ—¶ï¼Œå–å‡ºæœ€åä¸€ä¸ªcardï¼Œç§»åˆ°ç¬¬ä¸€ä¸ªcardå‰é¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (void)reuseCardWithMoveDirection:(CardMoveDirection)moveDirection &#123;</div><div class="line">    BOOL isLeft = moveDirection == CardMoveDirectionLeft;</div><div class="line">    UIView *card = nil;</div><div class="line">    if (isLeft) &#123;</div><div class="line">        if (self.currentCardIndex &gt; self.totalNumberOfCards - 3 || self.currentCardIndex &lt; 2) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        card = [self.cards objectAtIndex:0];</div><div class="line">        card.tag+=4;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (self.currentCardIndex &gt; self.totalNumberOfCards - 4 ||</div><div class="line">            self.currentCardIndex &lt; 1) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        card = [self.cards objectAtIndex:3];</div><div class="line">        card.tag-=4;</div><div class="line">    &#125;</div><div class="line">    card.center = [self centerForCardWithIndex:card.tag];</div><div class="line">    [self.cardDataSource cardReuseView:card atIndex:card.tag];</div><div class="line">    [self ascendingSortCards];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”è°ƒç”¨- [cardReuseView:atIndex:]å¯¹é‡ç”¨çš„å¡ç‰‡æ”¹å˜æ•°æ®æºï¼Œæœ€åæŒ‰tagå€¼å‡åºæ’åº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (UIView *)cardReuseView:(UIView *)reuseView atIndex:(NSInteger)index &#123;</div><div class="line">    if (reuseView) &#123;</div><div class="line">        // you can set new style</div><div class="line">        return reuseView;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    UIView *card = [[UIView alloc] initWithFrame:CGRectMake(0, 0, kGCCardWidth * 0.9, kGCCardHeight)];</div><div class="line">    card.layer.backgroundColor = [UIColor whiteColor].CGColor;</div><div class="line">    card.layer.cornerRadius = 4;</div><div class="line">    card.layer.masksToBounds = YES;</div><div class="line">    </div><div class="line">    return card;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u5361_u7247_u5220_u9664"><a href="#u5361_u7247_u5220_u9664" class="headerlink" title="å¡ç‰‡åˆ é™¤"></a>å¡ç‰‡åˆ é™¤</h2><p>å¡ç‰‡åˆ é™¤æ˜¯ä¸€ä¸ªå¯é€‰åŠŸèƒ½ï¼Œé€šè¿‡è®¾ç½®canDeleteCardæ¥æ·»åŠ æ‰‹åŠ¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, assign) BOOL canDeleteCard;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if (self.canDeleteCard) &#123;</div><div class="line">    UIPanGestureRecognizer *deleteGesture = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(deleteCard:)];</div><div class="line">    deleteGesture.minimumNumberOfTouches = 1;</div><div class="line">    deleteGesture.maximumNumberOfTouches = 1;</div><div class="line">    deleteGesture.delegate = self;</div><div class="line">    [card addGestureRecognizer:deleteGesture];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±äºå¡ç‰‡æœ‰æ‹–åŠ¨æ‰‹åŠ¿å’ŒscrollViewä¹Ÿæœ‰æ‹–åŠ¨æ‰‹åŠ¿ï¼Œè¿™ä¸¤ä¸ªæ‰‹åŠ¿ä¼šå‡ºç°å†²çªï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®æ‰‹åŠ¿çš„æ–¹å‘æ¥åˆ¤æ–­åˆ°åº•åº”è¯¥æ˜¯ä½œç”¨äºå¡ç‰‡ä¸Šè¿˜æ˜¯scrollViewä¸Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (BOOL)gestureRecognizerShouldBegin:(UIGestureRecognizer *)gestureRecognizer &#123;</div><div class="line">    if ([gestureRecognizer isKindOfClass:[UIPanGestureRecognizer class]]) &#123;</div><div class="line">        CGPoint translatedPoint = [(UIPanGestureRecognizer *)gestureRecognizer translationInView:gestureRecognizer.view];</div><div class="line">        if (fabs(translatedPoint.y) &gt; fabs(translatedPoint.x)) &#123;</div><div class="line">            return YES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è°ƒç”¨å¡ç‰‡åˆ é™¤æ‰‹åŠ¿æ—¶ï¼Œå‘ä¸‹æ‹–åŠ¨æ—¶ä¸åšåˆ é™¤ï¼Œå‘ä¸Šæ‹–åŠ¨å±å¹•é«˜åº¦çš„ä¸€åŠåï¼Œåˆ é™¤å¡ç‰‡ï¼Œå¹¶ä¸”é‡ç”¨åˆ é™¤åçš„å¡ç‰‡ï¼Œè¿™éƒ¨åˆ†é‡ç”¨ç›¸å¯¹æ¯”è¾ƒå¤æ‚</p>
<h5 id="u5F53_u5361_u7247_u5C0F_u4E8E_u7B49_u4E8E_u56DB_u5F20_u65F6_uFF0C_u6211_u4EEC_u76F4_u63A5_u79FB_u9664_u5F53_u524D_u7684_u5361_u7247"><a href="#u5F53_u5361_u7247_u5C0F_u4E8E_u7B49_u4E8E_u56DB_u5F20_u65F6_uFF0C_u6211_u4EEC_u76F4_u63A5_u79FB_u9664_u5F53_u524D_u7684_u5361_u7247" class="headerlink" title="å½“å¡ç‰‡å°äºç­‰äºå››å¼ æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç§»é™¤å½“å‰çš„å¡ç‰‡"></a>å½“å¡ç‰‡å°äºç­‰äºå››å¼ æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç§»é™¤å½“å‰çš„å¡ç‰‡</h5><p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸º0æ—¶ -&gt; å³è¾¹çš„å¡ç‰‡å·¦ç§» -&gt; å³è¾¹å¡ç‰‡çš„tagå‡å‡1</p>
<p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸ºæœ€åä¸€å¼ æ—¶ -&gt; å·¦è¾¹çš„å¡ç‰‡å³ç§» -&gt; å·¦è¾¹å¡ç‰‡çš„tagä¸å˜</p>
<p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸ºä¸­é—´æ—¶ -&gt; å³è¾¹çš„å¡ç‰‡å·¦ç§» -&gt; å³è¾¹å¡ç‰‡çš„tagå‡å‡1</p>
<p>æœ€åæŒ‰å‡åºæ’åº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if (self.totalNumberOfCards &lt;= 4) &#123;</div><div class="line">    [(UIView *)[self.cards objectAtIndex:index] removeFromSuperview];</div><div class="line">    [self resetTagFromIndex:index];</div><div class="line">    [self.cards removeObjectAtIndex:index];</div><div class="line">    [self ascendingSortCards];</div><div class="line">    return;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (void)resetTagFromIndex:(NSInteger)index &#123;</div><div class="line">    [self.cards enumerateObjectsUsingBlock:^(UIView *card, NSUInteger idx, BOOL * _Nonnull stop) &#123;</div><div class="line">        if ((NSInteger)idx &gt; index) &#123;</div><div class="line">            card.tag-=1;</div><div class="line">            [UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">                card.center = [self centerForCardWithIndex:card.tag];</div><div class="line">            &#125;];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“å¡ç‰‡è¶…è¿‡å››å¼ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡ç”¨åˆ é™¤çš„å¡ç‰‡</p>
<p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸º0æ—¶ -&gt; å¡ç‰‡çš„tagå€¼åŠ 4 -&gt; å³è¾¹çš„å¡ç‰‡å·¦ç§» -&gt; å³è¾¹å¡ç‰‡çš„tagå‡å‡1</p>
<p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸ºæœ€åä¸€å¼ æ—¶ -&gt; å¡ç‰‡çš„tagå€¼å‡4 -&gt; å·¦è¾¹çš„å¡ç‰‡å³ç§» -&gt; å·¦è¾¹å¡ç‰‡çš„tagä¸å˜</p>
<p>-&gt; å¦‚æœå½“å‰å¡ç‰‡indexä¸ºä¸­é—´æ—¶ -&gt; ä»¥å››ä¸ªå¡ç‰‡ä¸ºä¸€ç»„ï¼Œè·å–ç¬¬ä¸€ä¸ªå¡ç‰‡å’Œæœ€åä¸€ä¸ªå¡ç‰‡çš„tagå€¼ -&gt; åˆ¤è¯»æœ€åä¸€ä¸ªå¡ç‰‡æ˜¯å¦æ˜¯æœ€åä¸€å¼ å¡ç‰‡ -&gt; å¦‚æœæ˜¯ï¼Œåˆ™å°†å¡ç‰‡ç§»åˆ°ç¬¬ä¸€å¼ å¡ç‰‡çš„å·¦è¾¹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å°†å¡ç‰‡ç§»åˆ°æœ€åä¸€å¼ å¡ç‰‡çš„å³è¾¹ -&gt; å³è¾¹çš„å¡ç‰‡å·¦ç§» -&gt; å³è¾¹å¡ç‰‡çš„tagå‡å‡1</p>
<p>æœ€åæŒ‰å‡åºæ’åº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">UIView *card = [self.cards objectAtIndex:index];</div><div class="line">NSInteger fromIndex = index;</div><div class="line">if (index == 0) &#123;</div><div class="line">    card.tag+=4;</div><div class="line">    fromIndex = index - 1;</div><div class="line">&#125; else if (index == 3) &#123;</div><div class="line">    card.tag-=4;</div><div class="line">&#125; else &#123;</div><div class="line">    NSInteger lastTag = ((UIView *)[self.cards lastObject]).tag;</div><div class="line">    NSInteger firstTag = ((UIView *)[self.cards firstObject]).tag;</div><div class="line">    if (lastTag == self.totalNumberOfCards - 1) &#123;</div><div class="line">        card.tag = firstTag - 1;</div><div class="line">    &#125; else &#123;</div><div class="line">        card.tag = lastTag + 1;</div><div class="line">        fromIndex = index - 1;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">card.center = [self centerForCardWithIndex:card.tag];</div><div class="line">[self ascendingSortCards];</div><div class="line">[self resetTagFromIndex:fromIndex];</div><div class="line">[self.cardDataSource cardReuseView:card atIndex:card.tag];</div></pre></td></tr></table></figure>
<p>æœ€ååªè¦æ”¹å˜scrollViewçš„contentSizeå’Œå¡ç‰‡çŠ¶æ€å³å¯~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">    [self.scrollView setContentSize:CGSizeMake(kGCScrollViewWidth*self.totalNumberOfCards, kGCViewHeight)];</div><div class="line">    for (UIView *card in self.cards) &#123;</div><div class="line">        [self.cardDelegate updateCard:card withProgress:1 direction:CardMoveDirectionNone];</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªiOS9çš„task switcherå¼€æºå®ç°ï¼Œä½†æ˜¯æ²¡æœ‰åˆ é™¤åŠŸèƒ½ï¼Œå°±æƒ³ç€å¹²è„†åšä¸€ä¸ªæ¨¡ä»¿iOS7ç³»ç»Ÿçš„æ•ˆæœï¼ŒåŠ ä¸Šåˆ é™¤å’Œé‡ç”¨å¡ç‰‡åŠŸèƒ½ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/GCCardViewController.gif!500x500&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯ä»£ç åœ°å€ï¼š&lt;a href=&quot;https://github.com/Yuzeyang/GCCardViewController&quot;&gt;https://github.com/Yuzeyang/GCCardViewController&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="task switcher" scheme="http://yuzeyang.github.io/tags/task-switcher/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆå…­ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/05/27/AFNetWorking-six/"/>
    <id>http://yuzeyang.github.io/2016/05/27/AFNetWorking-six/</id>
    <published>2016-05-27T01:44:43.000Z</published>
    <updated>2016-06-12T15:25:24.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>AFURLResponseSerialization</code>æ˜¯ç”¨æ¥å°†è¿”å›çš„responseå¤„ç†æˆç›¸åº”çš„æ ¼å¼ï¼Œå®ƒé€šè¿‡åè®®å¯¹ç‰¹å®šresponseçš„dataè¿›è¡Œè§£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (nullable id)responseObjectForResponse:(nullable NSURLResponse *)response</div><div class="line">                           data:(nullable NSData *)data</div><div class="line">                          error:(NSError * _Nullable __autoreleasing *)error NS_SWIFT_NOTHROW;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p><code>AFHTTPResponseSerializer</code>å¯ä»¥é€šè¿‡<code>+ serializer</code>å’Œ<code>- init</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œå®é™…ä¸Š<code>+ serializer</code>å†…åªæ˜¯è°ƒç”¨äº†<code>- init</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)serializer &#123;</div><div class="line">    return [[self alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)init &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (!self) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">	// è®¾ç½®å­—ç¬¦ä¸²ç¼–ç ç±»å‹ï¼Œå¯æ¥å—çš„çŠ¶æ€ç ï¼Œå¯æ¥å—çš„MIMEç±»å‹</div><div class="line">    self.stringEncoding = NSUTF8StringEncoding;</div><div class="line">	self.acceptableStatusCodes = [NSIndexSet indexSetWithIndexesInRange:NSMakeRange(200, 100)];</div><div class="line">    self.acceptableContentTypes = nil;</div><div class="line"></div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>acceptableStatusCodeså’ŒacceptableContentTypeså¯ä»¥é€šè¿‡å¤–éƒ¨è¿›è¡Œè®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, copy, nullable) NSIndexSet *acceptableStatusCodes;</div><div class="line">@property (nonatomic, copy, nullable) NSSet &lt;NSString *&gt; *acceptableContentTypes;</div></pre></td></tr></table></figure>
<p>ç„¶åå¯ä»¥è°ƒç”¨<code>- [validateResponse:data:error:]</code>æ£€æŸ¥è¿™ä¸ªresponseæ˜¯å¦åŒ…å«å¯æ¥å—çš„çŠ¶æ€ç å’Œå¯æ¥å—MIMEç±»å‹æ¥éªŒè¯responseçš„æœ‰æ•ˆæ€§ï¼Œå­ç±»ä¹Ÿå¯ä»¥å¢åŠ ç‰¹å®šåŸŸåæ£€æŸ¥ï¼Œ<code>- [responseObjectForResponse:data:error]</code>ä¹Ÿæ˜¯è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›data</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // è°ƒç”¨- [validateResponse:data:error:]æ–¹æ³•ï¼Œè¿”å›data </div><div class="line">    [self validateResponse:(NSHTTPURLResponse *)response data:data error:error];</div><div class="line"></div><div class="line">    return data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (BOOL)validateResponse:(NSHTTPURLResponse *)response</div><div class="line">                    data:(NSData *)data</div><div class="line">                   error:(NSError * __autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // è®¾ç½®åˆå§‹å€¼</div><div class="line">    BOOL responseIsValid = YES;</div><div class="line">    NSError *validationError = nil;</div><div class="line"></div><div class="line">    // æ£€æŸ¥è¿™ä¸ªresponseæ˜¯å¦åŒ…å«å¯æ¥å—çš„çŠ¶æ€ç å’Œå¯æ¥å—MIMEç±»å‹</div><div class="line"></div><div class="line">    if (error &amp;&amp; !responseIsValid) &#123;</div><div class="line">        *error = validationError;</div><div class="line">    &#125;</div><div class="line">    // è¿”å›responseæ˜¯å¦æœ‰æ•ˆæ€§</div><div class="line">    return responseIsValid;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ£€æŸ¥è¿™ä¸ªresponseæ˜¯å¦åŒ…å«å¯æ¥å—çš„çŠ¶æ€ç å’Œå¯æ¥å—MIMEç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">// æ£€æŸ¥responseæ˜¯å¦ä¸ºç©ºï¼Œä»¥åŠresponseæ˜¯å¦æ˜¯NSHTTPURLResponseç±»</div><div class="line">    if (response &amp;&amp; [response isKindOfClass:[NSHTTPURLResponse class]]) &#123;</div><div class="line">        // acceptableContentTypesä¸ä¸ºç©ºå¹¶ä¸”responseçš„MIMEç±»å‹ä¸åœ¨å¯æ¥å—çš„èŒƒå›´é‡Œ</div><div class="line">        if (self.acceptableContentTypes &amp;&amp; ![self.acceptableContentTypes containsObject:[response MIMEType]]) &#123;</div><div class="line">            </div><div class="line">            // åŒ…è£…é”™è¯¯ä¿¡æ¯</div><div class="line">            if ([data length] &gt; 0 &amp;&amp; [response URL]) &#123;</div><div class="line">                NSMutableDictionary *mutableUserInfo = [@&#123;</div><div class="line">                                                          NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&quot;Request failed: unacceptable content-type: %@&quot;, @&quot;AFNetworking&quot;, nil), [response MIMEType]],</div><div class="line">                                                          NSURLErrorFailingURLErrorKey:[response URL],</div><div class="line">                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                                        &#125; mutableCopy];</div><div class="line">                if (data) &#123;</div><div class="line">                    mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:mutableUserInfo], validationError);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            responseIsValid = NO;</div><div class="line">        &#125;</div><div class="line">        // acceptableStatusCodesä¸ä¸ºç©ºå¹¶ä¸”acceptableStatusCodesåŒ…å«responseçš„çŠ¶æ€ç ï¼Œresponseçš„URLä¹Ÿå­˜åœ¨</div><div class="line">        if (self.acceptableStatusCodes &amp;&amp; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &amp;&amp; [response URL]) &#123;</div><div class="line">            // åŒ…è£…é”™è¯¯ä¿¡æ¯</div><div class="line">            NSMutableDictionary *mutableUserInfo = [@&#123;</div><div class="line">                                               NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&quot;Request failed: %@ (%ld)&quot;, @&quot;AFNetworking&quot;, nil), [NSHTTPURLResponse localizedStringForStatusCode:response.statusCode], (long)response.statusCode],</div><div class="line">                                               NSURLErrorFailingURLErrorKey:[response URL],</div><div class="line">                                               AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                       &#125; mutableCopy];</div><div class="line"></div><div class="line">            if (data) &#123;</div><div class="line">                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorBadServerResponse userInfo:mutableUserInfo], validationError);</div><div class="line"></div><div class="line">            responseIsValid = NO;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œå‡å¦‚responseä¸ºnilæˆ–è€…responseä¸æ˜¯<code>NSHTTPURLResponse</code>ç±»ï¼Œé‚£ä¸‹é¢çš„æ“ä½œå‡ä¸ä¼šå¯¹responseIsValidå¸ƒå°”å€¼è¿›è¡Œä¿®æ”¹ï¼Œæœ€åè¿”å›çš„æ˜¯ä¸ªYESï¼Œä½†æ˜¯è¿™æ ·çš„responseä¸åº”è¯¥æ˜¯NOä¹ˆï¼Ÿ</p>
<hr>
<p><code>AFJSONResponseSerializer</code>æ˜¯ç»§æ‰¿äº<code>AFHTTPResponseSerializer</code></p>
<p>å¤–éƒ¨å¯ä»¥è®¾ç½®<code>NSJSONReadingOptions</code>å’Œæ˜¯å¦ç§»é™¤ç©ºå€¼çš„key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, assign) NSJSONReadingOptions readingOptions;</div><div class="line">@property (nonatomic, assign) BOOL removesKeysWithNullValues;</div></pre></td></tr></table></figure>
<p>è½¬æ¢objectçš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥dataæ˜¯å¦æ˜¯ç©ºæ ¼ï¼Œè¿™ä¸ªæ˜¯Safariçš„ä¸€ä¸ªbugï¼Œå…·ä½“è¯·çœ‹<a href="https://github.com/rails/rails/issues/1742" target="_blank" rel="external">Workaround for behavior of Rails to return a single space for <code>head :ok</code> (a workaround for a bug in Safari), which is not interpreted as valid input by NSJSONSerialization.</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;</div><div class="line">        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    id responseObject = nil;</div><div class="line">    NSError *serializationError = nil;</div><div class="line">    // åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºæ ¼</div><div class="line">    BOOL isSpace = [data isEqualToData:[NSData dataWithBytes:&quot; &quot; length:1]];</div><div class="line">    if (data.length &gt; 0 &amp;&amp; !isSpace) &#123;</div><div class="line">        responseObject = [NSJSONSerialization JSONObjectWithData:data options:self.readingOptions error:&amp;serializationError];</div><div class="line">    &#125; else &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    // è°ƒç”¨AFJSONObjectByRemovingKeysWithNullValuesæŠŠç©ºå€¼çš„keyéƒ½ç§»é™¤æ‰ï¼Œè¿”å›object</div><div class="line">    if (self.removesKeysWithNullValues &amp;&amp; responseObject) &#123;</div><div class="line">        responseObject = AFJSONObjectByRemovingKeysWithNullValues(responseObject, self.readingOptions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error) &#123;</div><div class="line">        *error = AFErrorWithUnderlyingError(serializationError, *error);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return responseObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>AFXMLParserResponseSerializer</code>åˆ™æ˜¯ç›´æ¥æ ¡éªŒresponseåï¼Œç”¨dataåˆå§‹åŒ–NSXMLParserå¯¹è±¡å¹¶è¿”å›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSHTTPURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;</div><div class="line">        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [[NSXMLParser alloc] initWithData:data];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>AFPropertyListResponseSerializer</code>ä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;</div><div class="line">        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    id responseObject;</div><div class="line">    NSError *serializationError = nil;</div><div class="line"></div><div class="line">    if (data) &#123;</div><div class="line">        responseObject = [NSPropertyListSerialization propertyListWithData:data options:self.readOptions format:NULL error:&amp;serializationError];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error) &#123;</div><div class="line">        *error = AFErrorWithUnderlyingError(serializationError, *error);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return responseObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>AFImageResponseSerializer</code>åœ¨éªŒè¯responseä¹‹åï¼Œä¼šæ ¹æ®è®¾ç½®æ˜¯å¦è‡ªåŠ¨è§£å‹automaticallyInflatesResponseImageå¸ƒå°”å€¼ï¼Œæ¥å¯¹imageDataæŒ‰å›¾ç‰‡æ¯”ä¾‹è¿”å›UIImageå¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, assign) CGFloat imageScale;</div><div class="line">@property (nonatomic, assign) BOOL automaticallyInflatesResponseImage;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    if (![self validateResponse:(NSHTTPURLResponse *)response data:data error:error]) &#123;</div><div class="line">        if (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, NSURLErrorCannotDecodeContentData, AFURLResponseSerializationErrorDomain)) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_WATCH</div><div class="line">    // iOSéœ€è¦æ‰‹åŠ¨è§£å‹å›¾ç‰‡</div><div class="line">    if (self.automaticallyInflatesResponseImage) &#123;</div><div class="line">        return AFInflatedImageFromResponseWithDataAtScale((NSHTTPURLResponse *)response, data, self.imageScale);</div><div class="line">    &#125; else &#123;</div><div class="line">        return AFImageWithDataAtScale(data, self.imageScale);</div><div class="line">    &#125;</div><div class="line">#else</div><div class="line">    // MacOSå¯ä»¥ç›´æ¥ä½¿ç”¨NSBitmapImageRepæ¥è§£å‹</div><div class="line">    NSBitmapImageRep *bitimage = [[NSBitmapImageRep alloc] initWithData:data];</div><div class="line">    NSImage *image = [[NSImage alloc] initWithSize:NSMakeSize([bitimage pixelsWide], [bitimage pixelsHigh])];</div><div class="line">    [image addRepresentation:bitimage];</div><div class="line"></div><div class="line">    return image;</div><div class="line">#endif</div><div class="line"></div><div class="line">    return nil;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœä¸è§£å‹çš„è¯ï¼Œå°±ç›´æ¥æ ¹æ®imageDataå’Œscaleæ¥åˆ›å»ºImageï¼Œä½†æ˜¯è¿™æœ‰ä¸ªç–‘é—®æ˜¯ï¼ŒAFä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸¤æ¬¡imageï¼Œæˆ‘è§‰å¾—å¯ä»¥ç›´æ¥ä½¿ç”¨- [imageWithData:scale:]æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static UIImage * AFImageWithDataAtScale(NSData *data, CGFloat scale) &#123;</div><div class="line">    UIImage *image = [UIImage af_safeImageWithData:data];</div><div class="line">    if (image.images) &#123;</div><div class="line">        return image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return [[UIImage alloc] initWithCGImage:[image CGImage] scale:scale orientation:image.imageOrientation];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœç”¨imageWithDataè½¬æˆUIImageå¯¹è±¡åï¼Œç”±äºç½‘ç»œå›¾ç‰‡PNGå’ŒJPGéƒ½æ˜¯å‹ç¼©æ ¼å¼ï¼Œéœ€è¦è§£å‹æˆbitmapåæ‰èƒ½æ¸²æŸ“åˆ°å±å¹•ï¼Œè¿™æ—¶ä¼šåœ¨ä¸»çº¿ç¨‹å¯¹å›¾ç‰‡è¿›è¡Œè§£å‹æ“ä½œï¼Œè¿™æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œå¯èƒ½è¿˜ä¼šå¯¹ä¸»çº¿ç¨‹é€ æˆé˜»å¡ï¼Œæ‰€ä»¥AFè¿˜æä¾›äº†<code>AFInflatedImageFromResponseWithDataAtScale</code>æ–¹æ³•ï¼Œå¯¹PNGå’ŒJPGè§£å‹åï¼Œè¿”å›UIImageå¯¹è±¡ï¼Œè¿™æ ·é¿å…äº†åœ¨ä¸»çº¿ç¨‹çš„è§£å‹æ“ä½œï¼Œä¸ä¼šå¯¹ä¸»çº¿ç¨‹é€ æˆå¡é¡¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">static UIImage * AFInflatedImageFromResponseWithDataAtScale(NSHTTPURLResponse *response, NSData *data, CGFloat scale) &#123;</div><div class="line">    if (!data || [data length] == 0) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">	// åˆ›å»ºCGImageRef</div><div class="line">    CGImageRef imageRef = NULL;</div><div class="line">    // ç”¨dataåˆ›å»ºCGDataProviderRef</div><div class="line">    CGDataProviderRef dataProvider = CGDataProviderCreateWithCFData((__bridge CFDataRef)data);</div><div class="line"></div><div class="line">    if ([response.MIMEType isEqualToString:@&quot;image/png&quot;]) &#123;</div><div class="line">        imageRef = CGImageCreateWithPNGDataProvider(dataProvider,  NULL, true, kCGRenderingIntentDefault);</div><div class="line">    &#125; else if ([response.MIMEType isEqualToString:@&quot;image/jpeg&quot;]) &#123;</div><div class="line">        imageRef = CGImageCreateWithJPEGDataProvider(dataProvider, NULL, true, kCGRenderingIntentDefault);</div><div class="line"></div><div class="line">        if (imageRef) &#123;</div><div class="line">            CGColorSpaceRef imageColorSpace = CGImageGetColorSpace(imageRef);</div><div class="line">            CGColorSpaceModel imageColorSpaceModel = CGColorSpaceGetModel(imageColorSpace);</div><div class="line"></div><div class="line">            // å¦‚æœè‰²å½©ç©ºé—´æ˜¯CMKYï¼ŒCGImageCreateWithJPEGDataProvideræ˜¯ä¸ä¼šè¿›è¡Œå¤„ç†çš„ï¼Œä¹Ÿå°±æ˜¯ä¸è¿›è¡Œè§£å‹ï¼Œå°†è°ƒç”¨AFImageWithDataAtScaleè¿”å›image</div><div class="line">            if (imageColorSpaceModel == kCGColorSpaceModelCMYK) &#123;</div><div class="line">                CGImageRelease(imageRef);</div><div class="line">                imageRef = NULL;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CGDataProviderRelease(dataProvider);</div><div class="line">	// ä¸ç¬¦åˆè§£å‹æ¡ä»¶çš„ï¼Œå°†è°ƒç”¨AFImageWithDataAtScaleè¿”å›imageï¼Œä½†æ˜¯è¿™é‡Œå¦‚æœç¬¦åˆè§£å‹æ¡ä»¶çš„ä¹Ÿä¼šè°ƒç”¨ï¼Œä»¥åŠä¸‹é¢ä¼šå¯¹è¶…å‡ºå¤§å°çš„ï¼Œç›´æ¥è¿”å›imageï¼Œè¿™é‡Œæˆ‘è§‰å¾—åº”è¯¥ç»Ÿä¸€å¯¹ä¸ç¬¦åˆæ¡ä»¶çš„è¿”å›imageï¼Œç¬¦åˆæ¡ä»¶çš„å°±ä¸éœ€è¦è°ƒç”¨AFImageWithDataAtScale</div><div class="line">    UIImage *image = AFImageWithDataAtScale(data, scale);</div><div class="line">    if (!imageRef) &#123;</div><div class="line">        if (image.images || !image) &#123;</div><div class="line">            return image;</div><div class="line">        &#125;</div><div class="line">		// è¿™é‡Œè°ƒç”¨CGImageCreateCopyï¼Œåªä¼šå¯¹å›¾å½¢æœ¬èº«ç»“æ„è¿›è¡Œæ‹·è´ï¼Œåº•å±‚çš„æ•°æ®æ˜¯ä¸ä¼šæ‹·è´çš„</div><div class="line">        imageRef = CGImageCreateCopy([image CGImage]);</div><div class="line">        if (!imageRef) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	// è®¾ç½®å›¾ç‰‡çš„å®½å’Œé«˜å’Œå­˜å‚¨ä¸€ä¸ªåƒç´ æ‰€éœ€è¦ç”¨åˆ°çš„å­—èŠ‚</div><div class="line">    size_t width = CGImageGetWidth(imageRef);</div><div class="line">    size_t height = CGImageGetHeight(imageRef);</div><div class="line">    size_t bitsPerComponent = CGImageGetBitsPerComponent(imageRef);</div><div class="line">	// å¦‚æœå›¾ç‰‡å¤§å°å®½é«˜ä¹˜ç§¯è¶…è¿‡1024*1024æˆ–è€…bitsPerComponentå¤§äº8éƒ½ä¸è§£å‹äº†ï¼Œå› ä¸ºbitmapæ˜¯ä¸€ç›´å­˜åœ¨UIImageå¯¹è±¡é‡Œçš„ï¼Œå¯èƒ½ä¼šæŠŠå†…å­˜çˆ†äº†</div><div class="line">    if (width * height &gt; 1024 * 1024 || bitsPerComponent &gt; 8) &#123;</div><div class="line">        CGImageRelease(imageRef);</div><div class="line"></div><div class="line">        return image;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // ç”»å¸ƒå‚æ•°</div><div class="line">    size_t bytesPerRow = 0;</div><div class="line">    CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();</div><div class="line">    CGColorSpaceModel colorSpaceModel = CGColorSpaceGetModel(colorSpace);</div><div class="line">    CGBitmapInfo bitmapInfo = CGImageGetBitmapInfo(imageRef);</div><div class="line"></div><div class="line">    if (colorSpaceModel == kCGColorSpaceModelRGB) &#123;</div><div class="line">        uint32_t alpha = (bitmapInfo &amp; kCGBitmapAlphaInfoMask);</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wassign-enum&quot;</div><div class="line">        if (alpha == kCGImageAlphaNone) &#123;</div><div class="line">            bitmapInfo &amp;= ~kCGBitmapAlphaInfoMask;</div><div class="line">            bitmapInfo |= kCGImageAlphaNoneSkipFirst;</div><div class="line">        &#125; else if (!(alpha == kCGImageAlphaNoneSkipFirst || alpha == kCGImageAlphaNoneSkipLast)) &#123;</div><div class="line">            bitmapInfo &amp;= ~kCGBitmapAlphaInfoMask;</div><div class="line">            bitmapInfo |= kCGImageAlphaPremultipliedFirst;</div><div class="line">        &#125;</div><div class="line">#pragma clang diagnostic pop</div><div class="line">    &#125;</div><div class="line">	// åˆ›å»ºç”»å¸ƒ</div><div class="line">    CGContextRef context = CGBitmapContextCreate(NULL, width, height, bitsPerComponent, bytesPerRow, colorSpace, bitmapInfo);</div><div class="line"></div><div class="line">    CGColorSpaceRelease(colorSpace);</div><div class="line"></div><div class="line">    if (!context) &#123;</div><div class="line">        CGImageRelease(imageRef);</div><div class="line"></div><div class="line">        return image;</div><div class="line">    &#125;</div><div class="line">	// åœ¨ç”»å¸ƒä¸Šç”»å‡ºå›¾ç‰‡</div><div class="line">    CGContextDrawImage(context, CGRectMake(0.0f, 0.0f, width, height), imageRef);</div><div class="line">    // ä¿å­˜æˆCGImageRef</div><div class="line">  	CGImageRef inflatedImageRef = CGBitmapContextCreateImage(context);</div><div class="line"></div><div class="line">    CGContextRelease(context);</div><div class="line">	// å†è½¬æˆUIImageå¯¹è±¡</div><div class="line">    UIImage *inflatedImage = [[UIImage alloc] initWithCGImage:inflatedImageRef scale:scale orientation:image.imageOrientation];</div><div class="line"></div><div class="line">    CGImageRelease(inflatedImageRef);</div><div class="line">    CGImageRelease(imageRef);</div><div class="line"></div><div class="line">    return inflatedImage;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p><code>AFCompoundResponseSerializer</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (id)responseObjectForResponse:(NSURLResponse *)response</div><div class="line">                           data:(NSData *)data</div><div class="line">                          error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // éå†responseSerializers                    </div><div class="line">    for (id &lt;AFURLResponseSerialization&gt; serializer in self.responseSerializers) &#123;</div><div class="line">        // å¦‚æœserializerä¸æ˜¯AFHTTPResponseSerializerç±»ï¼Œåˆ™ç»§ç»­</div><div class="line">      	if (![serializer isKindOfClass:[AFHTTPResponseSerializer class]]) &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        NSError *serializerError = nil;</div><div class="line">        // ä¸€å±‚ä¸€å±‚çš„è°ƒç”¨è‡ªå·±çš„- [responseObjectForResponse:data:error:]ï¼Œç›´åˆ°è¿”å›responseObject</div><div class="line">        id responseObject = [serializer responseObjectForResponse:response data:data error:&amp;serializerError];</div><div class="line">        if (responseObject) &#123;</div><div class="line">            if (error) &#123;</div><div class="line">                *error = AFErrorWithUnderlyingError(serializerError, *error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return responseObject;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [super responseObjectForResponse:response data:data error:error];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;AFURLResponseSerialization&lt;/code&gt;æ˜¯ç”¨æ¥å°†è¿”å›çš„responseå¤„ç†æˆç›¸åº”çš„æ ¼å¼ï¼Œå®ƒé€šè¿‡åè®®å¯¹ç‰¹å®šresponseçš„dataè¿›è¡Œè§£ç &lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;- (nullable id)responseObjectForResponse:(nullable NSURLResponse *)response&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                           data:(nullable NSData *)data&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                          error:(NSError * _Nullable __autoreleasing *)error NS_SWIFT_NOTHROW;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/05/25/AFNetWorking-five/"/>
    <id>http://yuzeyang.github.io/2016/05/25/AFNetWorking-five/</id>
    <published>2016-05-25T12:49:32.000Z</published>
    <updated>2016-06-12T15:17:30.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>AFURLRequestSerialization</code>æ˜¯ç”¨æ¥å¯¹å‘å‡ºçš„è¯·æ±‚è¿›è¡Œä¸€äº›å¤„ç†</p>
<a id="more"></a>
<p><code>AFPercentEscapedStringFromString</code>æ–¹æ³•å°†stringé‡Œé¢çš„:#[]@!$&amp;â€™()*+,;=å­—ç¬¦æ›¿æ¢æˆ%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">NSString * AFPercentEscapedStringFromString(NSString *string) &#123;</div><div class="line">  	static NSString * const kAFCharactersGeneralDelimitersToEncode = @&quot;:#[]@&quot;; // does not include &quot;?&quot; or &quot;/&quot; due to RFC 3986 - Section 3.4</div><div class="line">    static NSString * const kAFCharactersSubDelimitersToEncode = @&quot;!$&amp;&apos;()*+,;=&quot;;</div><div class="line">	</div><div class="line">  	// ä»å¯ç”¨å­—ç¬¦æ›¿æ¢åˆ é™¤æ‰:#[]@!$&amp;&apos;()*+,;=è¿™äº›å­—ç¬¦</div><div class="line">    NSMutableCharacterSet * allowedCharacterSet = [[NSCharacterSet URLQueryAllowedCharacterSet] mutableCopy];</div><div class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</div><div class="line"></div><div class="line">	// FIXME: https://github.com/AFNetworking/AFNetworking/pull/3028</div><div class="line">    // return [string stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">	</div><div class="line">  	// å£°æ˜æ‰¹é‡å¤„ç†çš„å¤§å°ä¸º50</div><div class="line">    static NSUInteger const batchSize = 50;</div><div class="line"></div><div class="line">    NSUInteger index = 0;</div><div class="line">    NSMutableString *escaped = @&quot;&quot;.mutableCopy;</div><div class="line">	</div><div class="line">  	// å¾ªç¯å°†stringé‡Œé¢:#[]@!$&amp;&apos;()*+,;=çš„å­—ç¬¦æ›¿æ¢æˆ%</div><div class="line">    while (index &lt; string.length) &#123;</div><div class="line">#pragma GCC diagnostic push</div><div class="line">#pragma GCC diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">        NSUInteger length = MIN(string.length - index, batchSize);</div><div class="line">#pragma GCC diagnostic pop</div><div class="line">        NSRange range = NSMakeRange(index, length);</div><div class="line"></div><div class="line">        // To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</div><div class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</div><div class="line"></div><div class="line">        NSString *substring = [string substringWithRange:range];</div><div class="line">        NSString *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">        [escaped appendString:encoded];</div><div class="line"></div><div class="line">        index += range.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	return escaped;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>AFQueryStringPair</code>ç±»é‡Œé¢æœ‰ä¸ª<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œå°†è¯·æ±‚é‡Œé¢çš„URLå‚æ•°è½¬æˆfield=valueå½¢å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (NSString *)URLEncodedStringValue &#123;</div><div class="line">    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;</div><div class="line">        return AFPercentEscapedStringFromString([self.field description]);</div><div class="line">    &#125; else &#123;</div><div class="line">        return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å­—å…¸é‡Œé¢æ˜¯æˆ‘ä»¬æŸ¥è¯¢çš„keyå’Œvalueï¼Œæˆ‘ä»¬é€šè¿‡å°†å­—å…¸å†…å®¹è½¬æˆ<code>AFQueryStringPair</code>å¯¹è±¡ï¼Œè°ƒç”¨<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œè½¬æˆkey=valueï¼Œæ”¾åˆ°mutablePairsæ•°ç»„é‡Œï¼Œæœ€åç”¨&amp;ç¬¦æ‹¼æ¥èµ·æ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSString * AFQueryStringFromParameters(NSDictionary *parameters) &#123;</div><div class="line">    NSMutableArray *mutablePairs = [NSMutableArray array];</div><div class="line">    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</div><div class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [mutablePairs componentsJoinedByString:@&quot;&amp;&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) &#123;</div><div class="line">    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];</div><div class="line"></div><div class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@&quot;description&quot; ascending:YES selector:@selector(compare:)];</div><div class="line">	</div><div class="line">  	// å¦‚æœæ˜¯å­—å…¸ï¼Œéå†åè¿”å›key[nestedKey]=nestedValue</div><div class="line">    if ([value isKindOfClass:[NSDictionary class]]) &#123;</div><div class="line">        NSDictionary *dictionary = value;</div><div class="line">        // Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</div><div class="line">        for (id nestedKey in [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            id nestedValue = dictionary[nestedKey];</div><div class="line">            if (nestedValue) &#123;</div><div class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@&quot;%@[%@]&quot;, key, nestedKey] : nestedKey), nestedValue)];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†åè¿”å›key[]=nestedValue</div><div class="line">  	else if ([value isKindOfClass:[NSArray class]]) &#123;</div><div class="line">        NSArray *array = value;</div><div class="line">        for (id nestedValue in array) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([NSString stringWithFormat:@&quot;%@[]&quot;, key], nestedValue)];</div><div class="line">        &#125;</div><div class="line">    &#125; // å¦‚æœæ˜¯é›†åˆï¼Œéå†åè¿”å›key=obj</div><div class="line">  	else if ([value isKindOfClass:[NSSet class]]) &#123;</div><div class="line">        NSSet *set = value;</div><div class="line">        for (id obj in [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</div><div class="line">        &#125;</div><div class="line">    &#125; // å…¶ä»–è¿”å›key=value </div><div class="line">  	else &#123;</div><div class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableQueryStringComponents;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‡è®¾ä¼ å…¥çš„æ˜¯ï¼Œæˆ‘å°†key,valueæ”¾åˆ°æ•°ç»„é‡Œé¢ï¼Œå†æ”¾åˆ°mutableQueryStringComponentsé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSSet *afSet = [NSSet setWithObjects:@(1),@(2), nil];</div><div class="line">NSDictionary *afDic = @&#123;@&quot;dickey&quot;: @&#123;@&quot;nestKey&quot;: @&quot;nestValue&quot;&#125;,</div><div class="line">                        @&quot;arrayKey&quot;: @[@[@(1)]],</div><div class="line">                        @&quot;setKey&quot;: afSet,</div><div class="line">                        @&quot;generalKey&quot;: @&quot;generalValue&quot;&#125;;</div><div class="line">NSArray *resultArray = AFQueryStringPairsFromKeyAndValue(nil, afDic);</div></pre></td></tr></table></figure>
<p>æ‰“å°å¾—åˆ°çš„ç»“æœæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[arrayKey, 1],</div><div class="line"> [dickey[nestKey], nestValue],</div><div class="line"> [generalKey, generalValue],</div><div class="line"> [setKey, 1]ï¼Œ</div><div class="line"> [setKey,2]]</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨<code>AFHTTPRequestSerializer</code>å¯¹HTTPè¯·æ±‚çš„å¤´éƒ¨è¿›è¡Œå¤„ç†</p>
<p>é¦–å…ˆè°ƒç”¨<code>+ serializer</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œé‡Œé¢è°ƒç”¨äº†è‡ªå·±initæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)serializer &#123;</div><div class="line">    return [[self alloc] init];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>inité‡Œé¢å…ˆå°†Accept-Languageå­˜åˆ°mutableHTTPRequestHeadersé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// å°†mainBundleé‡Œé¢æ ¹æ®ä½¿ç”¨è¯­è¨€çš„ä¼˜å…ˆé¡ºåºæ”¾åˆ°acceptLanguagesComponentsé‡Œé¢ï¼Œå†ç”¨&quot;,&quot;åˆ†éš”ï¼Œå­˜åˆ°mutableHTTPRequestHeaderså­—å…¸é‡Œé¢</div><div class="line">  	NSMutableArray *acceptLanguagesComponents = [NSMutableArray array];</div><div class="line">    [[NSLocale preferredLanguages] enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) &#123;</div><div class="line">        float q = 1.0f - (idx * 0.1f);</div><div class="line">        [acceptLanguagesComponents addObject:[NSString stringWithFormat:@&quot;%@;q=%0.1g&quot;, obj, q]];</div><div class="line">        *stop = q &lt;= 0.5f;</div><div class="line">    &#125;];</div><div class="line">    [self setValue:[acceptLanguagesComponents componentsJoinedByString:@&quot;, &quot;] forHTTPHeaderField:@&quot;Accept-Language&quot;];</div></pre></td></tr></table></figure>
<p>ç„¶åæ‹¼æ¥User-Agentï¼Œæ ¼å¼ä¸ºâ€%@/%@ (%@; iOS %@; Scale/%0.2f)â€ï¼Œé‡Œé¢éœ€è¦5ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å…ˆè·å–é¡¹ç›®åï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨BundleIdentifierï¼Œç¬¬äºŒä¸ªå‚æ•°å…ˆè·å–çŸ­ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨ç‰ˆæœ¬å·ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç±»å‹ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç‰ˆæœ¬å·ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯å±å¹•çš„æ¯”ä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NSString *userAgent = nil;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">#if TARGET_OS_IOS</div><div class="line">    userAgent = [NSString stringWithFormat:@&quot;%@/%@ (%@; iOS %@; Scale/%0.2f)&quot;, [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleExecutableKey] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleIdentifierKey], [[NSBundle mainBundle] infoDictionary][@&quot;CFBundleShortVersionString&quot;] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleVersionKey], [[UIDevice currentDevice] model], [[UIDevice currentDevice] systemVersion], [[UIScreen mainScreen] scale]];</div><div class="line">#elif TARGET_OS_WATCH</div><div class="line">    // ... </div><div class="line">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</div><div class="line">    // ...</div><div class="line">#endif</div><div class="line">#pragma clang diagnostic pop</div><div class="line">if (userAgent) &#123;</div><div class="line">        if (![userAgent canBeConvertedToEncoding:NSASCIIStringEncoding]) &#123;</div><div class="line">            NSMutableString *mutableUserAgent = [userAgent mutableCopy];</div><div class="line">            if (CFStringTransform((__bridge CFMutableStringRef)(mutableUserAgent), NULL, (__bridge CFStringRef)@&quot;Any-Latin; Latin-ASCII; [:^ASCII:] Remove&quot;, false)) &#123;</div><div class="line">                userAgent = mutableUserAgent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        [self setValue:userAgent forHTTPHeaderField:@&quot;User-Agent&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åè®¾ç½®å±æ€§çš„ç›‘å¬ï¼Œè¿™äº›å±æ€§åœ¨å¤´æ–‡ä»¶é‡Œé¢éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œå®ç°æ–‡ä»¶é‡Œé¢ä¹Ÿå®ç°äº†setæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">self.mutableObservedChangedKeyPaths = [NSMutableSet set];</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self respondsToSelector:NSSelectorFromString(keyPath)]) &#123;</div><div class="line">            [self addObserver:self forKeyPath:keyPath options:NSKeyValueObservingOptionNew context:AFHTTPRequestSerializerObserverContext];</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">static NSArray * AFHTTPRequestSerializerObservedKeyPaths() &#123;</div><div class="line">    static NSArray *_AFHTTPRequestSerializerObservedKeyPaths = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[NSStringFromSelector(@selector(allowsCellularAccess)), NSStringFromSelector(@selector(cachePolicy)), NSStringFromSelector(@selector(HTTPShouldHandleCookies)), NSStringFromSelector(@selector(HTTPShouldUsePipelining)), NSStringFromSelector(@selector(networkServiceType)), NSStringFromSelector(@selector(timeoutInterval))];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _AFHTTPRequestSerializerObservedKeyPaths;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡KVOåˆ¤æ–­æ˜¯å¦æ˜¯æ–°å€¼ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±åŠ åˆ°mutableObservedChangedKeyPathsé‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath</div><div class="line">                      ofObject:(__unused id)object</div><div class="line">                        change:(NSDictionary *)change</div><div class="line">                       context:(void *)context</div><div class="line">&#123;</div><div class="line">    if (context == AFHTTPRequestSerializerObserverContext) &#123;</div><div class="line">        if ([change[NSKeyValueChangeNewKey] isEqual:[NSNull null]]) &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths removeObject:keyPath];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths addObject:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¾ç½®éªŒè¯å­—æ®µ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username</div><div class="line">                                       password:(NSString *)password</div><div class="line">&#123;</div><div class="line">    NSData *basicAuthCredentials = [[NSString stringWithFormat:@&quot;%@:%@&quot;, username, password] dataUsingEncoding:NSUTF8StringEncoding];</div><div class="line">    NSString *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(NSDataBase64EncodingOptions)0];</div><div class="line">    [self setValue:[NSString stringWithFormat:@&quot;Basic %@&quot;, base64AuthCredentials] forHTTPHeaderField:@&quot;Authorization&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¹‹åï¼Œéœ€è¦è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)method</div><div class="line">                                 URLString:(NSString *)URLString</div><div class="line">                                parameters:(id)parameters</div><div class="line">                                     error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // æ–­è¨€                                     </div><div class="line">    NSParameterAssert(method);</div><div class="line">    NSParameterAssert(URLString);</div><div class="line">	</div><div class="line">    NSURL *url = [NSURL URLWithString:URLString];</div><div class="line"></div><div class="line">    NSParameterAssert(url);</div><div class="line">	// æ ¹æ®urlåˆå§‹åŒ–request</div><div class="line">    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</div><div class="line">    // è®¾ç½®HTTPæ–¹æ³•                                   </div><div class="line">    mutableRequest.HTTPMethod = method;</div><div class="line">	// æ ¹æ®mutableObservedChangedKeyPathså­˜å‚¨çš„å±æ€§ï¼Œè®¾ç½®åˆ°mutableRequest</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</div><div class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	// è°ƒç”¨- [requestBySerializingRequest:withParameters:error]æ–¹æ³•</div><div class="line">    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</div><div class="line"></div><div class="line">	return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</div><div class="line">                               withParameters:(id)parameters</div><div class="line">                                        error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // æ–­è¨€                                      </div><div class="line">    NSParameterAssert(request);</div><div class="line"></div><div class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</div><div class="line">    // æ ¹æ®HTTPRequestHeadersæ¥è®¾ç½®mutableRequestçš„å¤´éƒ¨å­—æ®µ</div><div class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</div><div class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</div><div class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">	</div><div class="line">    NSString *query = nil;</div><div class="line">    if (parameters) &#123;</div><div class="line">        if (self.queryStringSerialization) &#123;</div><div class="line">          	// å¦‚æœè®¾ç½®äº†queryStringSerializationè¿™ä¸ªblockçš„è¯ï¼Œå°±éœ€è¦è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„æŸ¥è¯¢è¯­å¥åºåˆ—åŒ–æ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</div><div class="line">            NSError *serializationError;</div><div class="line">            query = self.queryStringSerialization(request, parameters, &amp;serializationError);</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                if (error) &#123;</div><div class="line">                    *error = serializationError;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return nil;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">          	// å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™è°ƒç”¨AFQueryStringFromParametersæ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</div><div class="line">            switch (self.queryStringSerializationStyle) &#123;</div><div class="line">                case AFHTTPRequestQueryStringDefaultStyle:</div><div class="line">                    query = AFQueryStringFromParameters(parameters);</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    // å°†æ‹¼æ¥å¥½çš„queryè¯­å¥æ”¾åˆ° mutableRequest.URLæˆ–è€…æ”¾åˆ°                                    mutableRequestçš„HTTPBodyé‡Œ</div><div class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</div><div class="line">        if (query) &#123;</div><div class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // #2864: an empty string is a valid x-www-form-urlencoded payload</div><div class="line">        if (!query) &#123;</div><div class="line">            query = @&quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</div><div class="line">            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</div><div class="line">        &#125;</div><div class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„è¯ï¼ŒåŸºæœ¬éƒ½æ˜¯å¯¹å¤šéƒ¨åˆ†æ•°æ®è¿›è¡Œç»„è£…</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;AFURLRequestSerialization&lt;/code&gt;æ˜¯ç”¨æ¥å¯¹å‘å‡ºçš„è¯·æ±‚è¿›è¡Œä¸€äº›å¤„ç†&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆå››ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/05/23/AFNetWorking-four/"/>
    <id>http://yuzeyang.github.io/2016/05/23/AFNetWorking-four/</id>
    <published>2016-05-23T15:24:24.000Z</published>
    <updated>2016-06-21T08:08:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>AFNetworkReachabilityManager</code>æ˜¯ç”¨æ¥ç›‘æµ‹ç½‘ç»œçŠ¶æ€çš„ç±»ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®çŠ¶æ€æ”¹å˜å›è°ƒæ¥è·å¾—å½“å‰ç½‘ç»œçŠ¶æ€</p>
<a id="more"></a>
<p>ç½‘ç»œçš„çŠ¶æ€å€¼æœ‰ä»¥ä¸‹å››ç§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSInteger, AFNetworkReachabilityStatus) &#123;</div><div class="line">    AFNetworkReachabilityStatusUnknown          = -1,// æœªçŸ¥</div><div class="line">    AFNetworkReachabilityStatusNotReachable     = 0, // ä¸å¯ç”¨</div><div class="line">    AFNetworkReachabilityStatusReachableViaWWAN = 1, // æ— çº¿å¹¿åŸŸç½‘è¿æ¥</div><div class="line">    AFNetworkReachabilityStatusReachableViaWiFi = 2, // WiFiè¿æ¥</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>AFNetworkReachabilityManager</code>æä¾›äº†äº”ç§åˆå§‹åŒ–çš„æ–¹æ³•</p>
<p>å¯ä»¥é€šè¿‡å•ä¾‹æ–¹æ³•åˆå§‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)sharedManager &#123;</div><div class="line">    static AFNetworkReachabilityManager *_sharedManager = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        // è°ƒç”¨+ manageråˆå§‹åŒ–æ–¹æ³•</div><div class="line">        _sharedManager = [self manager];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _sharedManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å•ä¾‹é‡Œé¢è°ƒç”¨äº†ç¬¬äºŒç§é€šè¿‡é»˜è®¤çš„socketåœ°å€åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªmanagerå¯¹è±¡ï¼Œsin_familyè¡¨ç¤ºåè®®æ—ï¼ŒAF_INETè¡¨ç¤ºTCP/IPåè®®æ—çš„åœ°å€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)manager</div><div class="line">&#123;</div><div class="line">#if (defined(__IPHONE_OS_VERSION_MIN_REQUIRED) &amp;&amp; __IPHONE_OS_VERSION_MIN_REQUIRED &gt;= 90000) || (defined(__MAC_OS_X_VERSION_MIN_REQUIRED) &amp;&amp; __MAC_OS_X_VERSION_MIN_REQUIRED &gt;= 101100)</div><div class="line">    struct sockaddr_in6 address;</div><div class="line">    bzero(&amp;address, sizeof(address));</div><div class="line">    address.sin6_len = sizeof(address);</div><div class="line">    address.sin6_family = AF_INET6;</div><div class="line">#else</div><div class="line">    // å£°æ˜sockaddr_inç»“æ„ä½“</div><div class="line">    struct sockaddr_in address;</div><div class="line">    // addressæ¸…é›¶</div><div class="line">    bzero(&amp;address, sizeof(address));</div><div class="line">    // addressèµ‹å€¼</div><div class="line">    address.sin_len = sizeof(address);</div><div class="line">    address.sin_family = AF_INET;</div><div class="line">#endif</div><div class="line">    // è°ƒç”¨+ [managerForAddress:]æ–¹æ³• </div><div class="line">    return [self managerForAddress:&amp;address];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œåˆè°ƒç”¨äº†ç¬¬ä¸‰ç§é€šè¿‡ä¼ å…¥ä¸€ä¸ªsocketåœ°å€æ¥åˆå§‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)managerForAddress:(const void *)address &#123;</div><div class="line">    // ç”ŸæˆSCNetworkReachabilityRef</div><div class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithAddress(kCFAllocatorDefault, (const struct sockaddr *)address);</div><div class="line">    // è°ƒç”¨- [initWithReachability:]æ–¹æ³•</div><div class="line">    AFNetworkReachabilityManager *manager = [[self alloc] initWithReachability:reachability];</div><div class="line"></div><div class="line">    CFRelease(reachability);</div><div class="line">    </div><div class="line">    return manager;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‡Œé¢åˆè°ƒç”¨äº†ç¬¬äº”ç§åˆå§‹åŒ–æ–¹æ³•ï¼Œå› ä¸ºè¯¥æ–¹æ³•çš„åç¼€é‡Œé¢æœ‰<code>NS_DESIGNATED_INITIALIZER</code>ï¼Œæ‰€ä»¥æœ€ç»ˆéƒ½ä¼šè°ƒåˆ°å®ƒï¼Œè¿™é‡Œå°±æ˜¯åšäº†åˆå§‹åŒ–çš„å·¥ä½œï¼Œå°†èµ·å§‹çš„ç½‘ç»œçŠ¶æ€å®šä¸ºUnknown</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithReachability:(SCNetworkReachabilityRef)reachability &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (!self) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    _networkReachability = CFRetain(reachability);</div><div class="line">    self.networkReachabilityStatus = AFNetworkReachabilityStatusUnknown;</div><div class="line"></div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åå‰©ä¸‹ä¸€ç§æ–¹æ³•å°±æ˜¯å¯ä»¥æ ¹æ®ç‰¹å®šçš„åŸŸæ¥åˆå§‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)managerForDomain:(NSString *)domain &#123;</div><div class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithName(kCFAllocatorDefault, [domain UTF8String]);</div><div class="line"></div><div class="line">    AFNetworkReachabilityManager *manager = [[self alloc] initWithReachability:reachability];</div><div class="line">    </div><div class="line">    CFRelease(reachability);</div><div class="line"></div><div class="line">    return manager;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨åˆå§‹åŒ–ç»“æŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç½‘ç»œçŠ¶æ€æ”¹å˜çš„å›è°ƒï¼Œåœ¨å¼€å¯ç›‘å¬ä¹‹åï¼Œä¼šå°†ç½‘ç»œçŠ¶æ€å›è°ƒç»™å¤–éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)setReachabilityStatusChangeBlock:(void (^)(AFNetworkReachabilityStatus status))block &#123;</div><div class="line">    self.networkReachabilityStatusBlock = block;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åå°±æ˜¯å¼€å¯ç›‘å¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (void)startMonitoring &#123;</div><div class="line">    // åœæ­¢ç›‘å¬</div><div class="line">    [self stopMonitoring];</div><div class="line"></div><div class="line">    if (!self.networkReachability) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // æ”¶åˆ°callbackè°ƒç”¨åï¼Œå°†statusé€šè¿‡networkReachabilityStatusBlockå›è°ƒå‡ºå»</div><div class="line">    __weak __typeof(self)weakSelf = self;</div><div class="line">    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</div><div class="line">        __strong __typeof(weakSelf)strongSelf = weakSelf;</div><div class="line"></div><div class="line">        strongSelf.networkReachabilityStatus = status;</div><div class="line">        if (strongSelf.networkReachabilityStatusBlock) &#123;</div><div class="line">            strongSelf.networkReachabilityStatusBlock(status);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">  	// å£°æ˜SCNetworkReachabilityContextç»“æ„ä½“</div><div class="line">    SCNetworkReachabilityContext context = &#123;0, (__bridge void *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, NULL&#125;;</div><div class="line">    // è®¾ç½®å›è°ƒ</div><div class="line">  	SCNetworkReachabilitySetCallback(self.networkReachability, AFNetworkReachabilityCallback, &amp;context);</div><div class="line">    // åŠ åˆ°Main runloopé‡Œé¢å¯¹å…¶è¿›è¡Œç›‘æµ‹</div><div class="line">  	SCNetworkReachabilityScheduleWithRunLoop(self.networkReachability, CFRunLoopGetMain(), kCFRunLoopCommonModes);</div><div class="line">	</div><div class="line">  	// è·å–å½“å‰çš„ç½‘ç»œçŠ¶æ€ï¼Œè°ƒç”¨callback</div><div class="line">    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0),^&#123;</div><div class="line">        SCNetworkReachabilityFlags flags;</div><div class="line">        if (SCNetworkReachabilityGetFlags(self.networkReachability, &amp;flags)) &#123;</div><div class="line">            AFPostReachabilityStatusChange(flags, callback);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰è®¾ç½®å›è°ƒçš„è¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨å†Œé€šçŸ¥çš„æ–¹å¼ï¼Œæ”¶åˆ°ç½‘ç»œçŠ¶æ€çš„å˜åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static void AFPostReachabilityStatusChange(SCNetworkReachabilityFlags flags, AFNetworkReachabilityStatusBlock block) &#123;</div><div class="line">    // è·å–å½“å‰çš„status</div><div class="line">  	AFNetworkReachabilityStatus status = AFNetworkReachabilityStatusForFlags(flags);</div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        // è¿”å›statuså€¼</div><div class="line">      	if (block) &#123;</div><div class="line">            block(status);</div><div class="line">        &#125;</div><div class="line">      	// åŒæ—¶ä¼šå‘é€ä¸€ä¸ªé€šçŸ¥</div><div class="line">        NSNotificationCenter *notificationCenter = [NSNotificationCenter defaultCenter];</div><div class="line">        NSDictionary *userInfo = @&#123; AFNetworkingReachabilityNotificationStatusItem: @(status) &#125;;</div><div class="line">        [notificationCenter postNotificationName:AFNetworkingReachabilityDidChangeNotification object:nil userInfo:userInfo];</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœæ­¢ç›‘å¬çš„è¯ï¼Œå°±æ˜¯å–æ¶ˆåœ¨Main Runloopé‡Œé¢çš„ç›‘å¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)stopMonitoring &#123;</div><div class="line">    if (!self.networkReachability) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SCNetworkReachabilityUnscheduleFromRunLoop(self.networkReachability, CFRunLoopGetMain(), kCFRunLoopCommonModes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>ä½¿ç”¨æ–¹å¼ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">AFNetworkReachabilityManager *networkManager = [AFNetworkReachabilityManager sharedManager];</div><div class="line">[networkManager startMonitoring];</div><div class="line">[networkManager setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) &#123;</div><div class="line">    switch (status) &#123;</div><div class="line">        case AFNetworkReachabilityStatusNotReachable:</div><div class="line">      		// do something</div><div class="line">            break;</div><div class="line">        case AFNetworkReachabilityStatusReachableViaWWAN:</div><div class="line">      		// do something</div><div class="line">      		break;</div><div class="line">        case AFNetworkReachabilityStatusReachableViaWiFi:</div><div class="line">      		// do something</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;AFNetworkReachabilityManager&lt;/code&gt;æ˜¯ç”¨æ¥ç›‘æµ‹ç½‘ç»œçŠ¶æ€çš„ç±»ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®çŠ¶æ€æ”¹å˜å›è°ƒæ¥è·å¾—å½“å‰ç½‘ç»œçŠ¶æ€&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆä¸‰ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/05/22/AFNetWorking-three/"/>
    <id>http://yuzeyang.github.io/2016/05/22/AFNetWorking-three/</id>
    <published>2016-05-22T13:35:11.000Z</published>
    <updated>2016-06-12T15:26:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨iOS9ä¹‹åï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸èƒ½å‘é€HTTPè¯·æ±‚ï¼Œæ¨èä½¿ç”¨HTTPSï¼Œå½“ç„¶ä½ å¯ä»¥åœ¨plisté‡Œé¢è®¾ç½®<code>NSAppTransportSecurity</code>çš„NSAllowsArbitraryLoadsä¸ºtrueï¼ŒAppå°±ä¾ç„¶æ”¯æŒHTTPè¯·æ±‚</p>
<p>è€ŒAFSecurityPolicyä¸»è¦çš„ä½œç”¨å°±æ˜¯éªŒè¯HTTPSè¯·æ±‚çš„è¯ä¹¦çš„æœ‰æ•ˆæ€§</p>
<a id="more"></a>
<p>AFSecurityPolicyæ˜¯å®‰å…¨ç­–ç•¥ç±»ï¼Œæœ‰ä¸‰ç§SSL Pinningæ¨¡å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSUInteger, AFSSLPinningMode) &#123;</div><div class="line">    AFSSLPinningModeNone,// åœ¨è¯ä¹¦åˆ—è¡¨ä¸­æ ¡éªŒæœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦</div><div class="line">    AFSSLPinningModePublicKey,// å®¢æˆ·ç«¯è¦æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œåªæ˜¯éªŒè¯æ—¶åªéªŒè¯è¯ä¹¦é‡Œçš„å…¬é’¥</div><div class="line">    AFSSLPinningModeCertificate,// å®¢æˆ·ç«¯è¦æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œç¬¬ä¸€æ­¥å…ˆéªŒè¯è¯ä¹¦åŸŸå/æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ï¼Œç¬¬äºŒæ­¥å¯¹æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦å’Œå®¢æˆ·ç«¯è¿”å›çš„æ˜¯å¦ä¸€è‡´</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ˜¯è¯ä¹¦é›†åˆï¼Œæ³›å‹é‡Œé¢è¡¨ç¤ºäº†é›†åˆé‡Œé¢æ˜¯NSDataç±»å‹ï¼Œè¡¨æ˜è¿™ä¸ªæ˜¯ç”¨æ¥å­˜è¯ä¹¦æ•°æ®çš„é›†åˆï¼Œè¿™äº›è¯ä¹¦æ ¹æ®SSL Pinningæ¨¡å¼æ¥å’ŒæœåŠ¡å™¨è¿›è¡Œæ ¡éªŒï¼Œé»˜è®¤æ˜¯æ²¡æœ‰è¯ä¹¦çš„ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨+ certificatesInBundle:æ–¹æ³•å°†bundleé‡Œé¢çš„è¯ä¹¦æ–‡ä»¶è½¬æˆé‡Œé¢æ˜¯dataç±»å‹çš„é›†åˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, strong, nullable) NSSet &lt;NSData *&gt; *pinnedCertificates;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">+ (NSSet *)certificatesInBundle:(NSBundle *)bundle &#123;</div><div class="line">    // è·å–è¯ä¹¦</div><div class="line">  	NSArray *paths = [bundle pathsForResourcesOfType:@&quot;cer&quot; inDirectory:@&quot;.&quot;];</div><div class="line"></div><div class="line">    NSMutableSet *certificates = [NSMutableSet setWithCapacity:[paths count]];</div><div class="line">    // å°†è¯ä¹¦æ–‡ä»¶è½¬æˆdata</div><div class="line">  	for (NSString *path in paths) &#123;</div><div class="line">        NSData *certificateData = [NSData dataWithContentsOfFile:path];</div><div class="line">        [certificates addObject:certificateData];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [NSSet setWithSet:certificates];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ‰ä¸‰ç§åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯é»˜è®¤ç­–ç•¥ï¼ŒAFSSLPinningModeNone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)defaultPolicy &#123;</div><div class="line">    AFSecurityPolicy *securityPolicy = [[self alloc] init];</div><div class="line">    securityPolicy.SSLPinningMode = AFSSLPinningModeNone;</div><div class="line"></div><div class="line">    return securityPolicy;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªå®‰å…¨ç­–ç•¥ï¼Œç„¶åè¯»å–ceræ–‡ä»¶æ”¾åˆ°é›†åˆé‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode &#123;</div><div class="line">    return [self policyWithPinningMode:pinningMode withPinnedCertificates:[self defaultPinnedCertificates]];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ (NSSet *)defaultPinnedCertificates &#123;</div><div class="line">    static NSSet *_defaultPinnedCertificates = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        NSBundle *bundle = [NSBundle bundleForClass:[self class]];</div><div class="line">        _defaultPinnedCertificates = [self certificatesInBundle:bundle];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _defaultPinnedCertificates;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰ç§åˆ™æ˜¯éœ€è¦æˆ‘ä»¬å¤šä¼ å…¥ä¸€ä¸ªè¯ä¹¦é›†åˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode withPinnedCertificates:(NSSet *)pinnedCertificates &#123;</div><div class="line">    AFSecurityPolicy *securityPolicy = [[self alloc] init];</div><div class="line">    securityPolicy.SSLPinningMode = pinningMode;</div><div class="line"></div><div class="line">    [securityPolicy setPinnedCertificates:pinnedCertificates];</div><div class="line"></div><div class="line">    return securityPolicy;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¾ç½®è¯ä¹¦çš„æ—¶å€™ï¼Œå°±æ˜¯æŠŠä¸Šé¢åˆå§‹åŒ–æ—¶ä¼ å…¥çš„è¯ä¹¦å–å‡ºå…¬é’¥ï¼Œå†æŠŠå…¬é’¥ä¿å­˜åˆ°mutablePinnedPublicKeysé›†åˆä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)setPinnedCertificates:(NSSet *)pinnedCertificates &#123;</div><div class="line">    _pinnedCertificates = pinnedCertificates;</div><div class="line"></div><div class="line">    if (self.pinnedCertificates) &#123;</div><div class="line">        NSMutableSet *mutablePinnedPublicKeys = [NSMutableSet setWithCapacity:[self.pinnedCertificates count]];</div><div class="line">        for (NSData *certificate in self.pinnedCertificates) &#123;</div><div class="line">            // å–å‡ºå…¬é’¥</div><div class="line">          	id publicKey = AFPublicKeyForCertificate(certificate);</div><div class="line">            if (!publicKey) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            // å°†å…¬é’¥å­˜åˆ°é›†åˆ</div><div class="line">            [mutablePinnedPublicKeys addObject:publicKey];</div><div class="line">        &#125;</div><div class="line">        self.pinnedPublicKeys = [NSSet setWithSet:mutablePinnedPublicKeys];</div><div class="line">    &#125; else &#123;</div><div class="line">        self.pinnedPublicKeys = nil;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>AFPublicKeyForCertificate</code>æ–¹æ³•é‡Œé¢ï¼Œåšäº†ä¸€ç³»åˆ—æ“ä½œåè¿”å›å…¬é’¥ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">static id AFPublicKeyForCertificate(NSData *certificate) &#123;</div><div class="line">    id allowedPublicKey = nil;</div><div class="line">    SecCertificateRef allowedCertificate;</div><div class="line">    SecCertificateRef allowedCertificates[1];</div><div class="line">    CFArrayRef tempCertificates = nil;</div><div class="line">    SecPolicyRef policy = nil;</div><div class="line">    SecTrustRef allowedTrust = nil;</div><div class="line">    SecTrustResultType result;</div><div class="line"></div><div class="line">  	// å–å‡ºè¯ä¹¦SecCertificateRef</div><div class="line">    allowedCertificate = SecCertificateCreateWithData(NULL, (__bridge CFDataRef)certificate);</div><div class="line">    __Require_Quiet(allowedCertificate != NULL, _out);</div><div class="line">	</div><div class="line">  	// ç”Ÿæˆè¯ä¹¦æ•°ç»„</div><div class="line">    allowedCertificates[0] = allowedCertificate;</div><div class="line">    tempCertificates = CFArrayCreate(NULL, (const void **)allowedCertificates, 1, NULL);</div><div class="line"></div><div class="line">  	// ç”ŸæˆSecPolicyRef</div><div class="line">    policy = SecPolicyCreateBasicX509();</div><div class="line">    __Require_noErr_Quiet(SecTrustCreateWithCertificates(tempCertificates, policy, &amp;allowedTrust), _out);</div><div class="line">    __Require_noErr_Quiet(SecTrustEvaluate(allowedTrust, &amp;result), _out);</div><div class="line">	</div><div class="line">  	// ä»SecPolicyRefä¸­å–å‡ºå…¬é’¥</div><div class="line">    allowedPublicKey = (__bridge_transfer id)SecTrustCopyPublicKey(allowedTrust);</div><div class="line"></div><div class="line">_out:</div><div class="line">    // ä¸€äº›èµ„æºçš„é‡Šæ”¾</div><div class="line"></div><div class="line">    return allowedPublicKey;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>-[evaluateServerTrust:forDomain:]</code>æ–¹æ³•æ˜¯<code>AFSecurityPolicy</code>ç±»æœ€é•¿ä¹Ÿæ˜¯æœ€é‡è¦çš„æ–¹æ³•ï¼Œå®ƒç”¨æ¥éªŒè¯æœåŠ¡ç«¯æ˜¯å¦æ˜¯å—ä¿¡çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">- (BOOL)evaluateServerTrust:(SecTrustRef)serverTrust</div><div class="line">                  forDomain:(NSString *)domain</div><div class="line">&#123;</div><div class="line">    // è‹¹æœæ–‡æ¡£ä¸­è¡¨ç¤ºä¸è¦éšå¼åœ°ä¿¡ä»»è‡ªå·±ç­¾åçš„è¯ä¹¦ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åº”è¯¥å¢åŠ è‡ªå·±çš„CAè¯ä¹¦åˆ°å—ä¿¡åˆ—è¡¨é‡Œ</div><div class="line">    if (domain &amp;&amp; self.allowInvalidCertificates &amp;&amp; self.validatesDomainName &amp;&amp; (self.SSLPinningMode == AFSSLPinningModeNone || [self.pinnedCertificates count] == 0)) &#123;</div><div class="line">        NSLog(@&quot;In order to validate a domain name for self signed certificates, you MUST use pinning.&quot;);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // policieså¢åŠ SecPolicyRef</div><div class="line">    NSMutableArray *policies = [NSMutableArray array];</div><div class="line">    if (self.validatesDomainName) &#123;</div><div class="line">        [policies addObject:(__bridge_transfer id)SecPolicyCreateSSL(true, (__bridge CFStringRef)domain)];</div><div class="line">    &#125; else &#123;</div><div class="line">        [policies addObject:(__bridge_transfer id)SecPolicyCreateBasicX509()];</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    // è®¾ç½®ä¿¡ä»»çš„policiesåº”å½“è¢«éªŒè¯</div><div class="line">    SecTrustSetPolicies(serverTrust, (__bridge CFArrayRef)policies);</div><div class="line">	</div><div class="line">    // å‘ç³»ç»Ÿå†…ç½®çš„æ ¹è¯ä¹¦éªŒè¯æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦æ˜¯å¦åˆæ³•</div><div class="line">    if (self.SSLPinningMode == AFSSLPinningModeNone) &#123;</div><div class="line">        return self.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</div><div class="line">    &#125; else if (!AFServerTrustIsValid(serverTrust) &amp;&amp; !self.allowInvalidCertificates) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    // æ ¹æ®SSLPinningModeå¯¹æœåŠ¡ç«¯æ˜¯å¦å—ä¿¡è¿›è¡Œæ ¡éªŒ</div><div class="line">    switch (self.SSLPinningMode) &#123;</div><div class="line">        case AFSSLPinningModeNone:</div><div class="line">        default:</div><div class="line">            return NO;</div><div class="line">        case AFSSLPinningModeCertificate: &#123;</div><div class="line">            NSMutableArray *pinnedCertificates = [NSMutableArray array];</div><div class="line">            for (NSData *certificateData in self.pinnedCertificates) &#123;</div><div class="line">                [pinnedCertificates addObject:(__bridge_transfer id)SecCertificateCreateWithData(NULL, (__bridge CFDataRef)certificateData)];</div><div class="line">            &#125;</div><div class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge CFArrayRef)pinnedCertificates);</div><div class="line"></div><div class="line">            if (!AFServerTrustIsValid(serverTrust)) &#123;</div><div class="line">                return NO;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it&apos;s the Root CA)</div><div class="line">            NSArray *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</div><div class="line">            </div><div class="line">            for (NSData *trustChainCertificate in [serverCertificates reverseObjectEnumerator]) &#123;</div><div class="line">                if ([self.pinnedCertificates containsObject:trustChainCertificate]) &#123;</div><div class="line">                    return YES;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            return NO;</div><div class="line">        &#125;</div><div class="line">        case AFSSLPinningModePublicKey: &#123;</div><div class="line">            NSUInteger trustedPublicKeyCount = 0;</div><div class="line">            NSArray *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</div><div class="line"></div><div class="line">            for (id trustChainPublicKey in publicKeys) &#123;</div><div class="line">                for (id pinnedPublicKey in self.pinnedPublicKeys) &#123;</div><div class="line">                    if (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</div><div class="line">                        trustedPublicKeyCount += 1;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return trustedPublicKeyCount &gt; 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨iOS9ä¹‹åï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸èƒ½å‘é€HTTPè¯·æ±‚ï¼Œæ¨èä½¿ç”¨HTTPSï¼Œå½“ç„¶ä½ å¯ä»¥åœ¨plisté‡Œé¢è®¾ç½®&lt;code&gt;NSAppTransportSecurity&lt;/code&gt;çš„NSAllowsArbitraryLoadsä¸ºtrueï¼ŒAppå°±ä¾ç„¶æ”¯æŒHTTPè¯·æ±‚&lt;/p&gt;
&lt;p&gt;è€ŒAFSecurityPolicyä¸»è¦çš„ä½œç”¨å°±æ˜¯éªŒè¯HTTPSè¯·æ±‚çš„è¯ä¹¦çš„æœ‰æ•ˆæ€§&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>Hexoæ­å»ºGitHub blog</title>
    <link href="http://yuzeyang.github.io/2016/04/29/hexo_build_github_blog/"/>
    <id>http://yuzeyang.github.io/2016/04/29/hexo_build_github_blog/</id>
    <published>2016-04-28T16:00:00.000Z</published>
    <updated>2016-07-06T08:05:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚æœä½ åŒå€¦äº†ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹çš„åšå®¢å¹³å°ï¼Œä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹ç”¨hexoå’Œgithubæ¥æ­å»ºè‡ªå·±çš„åšå®¢</p>
<hr>
<p>ç”¨hexoæ¥æ­å»ºgithub blogå¾ˆç®€å•ï¼Œåªéœ€è¦äº”æ­¥~</p>
<h2 id="1-_u5728github_u4E0A_u9762_u65B0_u5EFA_u4E00_u4E2A_u4ED3_u5E93"><a href="#1-_u5728github_u4E0A_u9762_u65B0_u5EFA_u4E00_u4E2A_u4ED3_u5E93" class="headerlink" title="1.åœ¨githubä¸Šé¢æ–°å»ºä¸€ä¸ªä»“åº“"></a>1.åœ¨githubä¸Šé¢æ–°å»ºä¸€ä¸ªä»“åº“</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨è‡ªå·±çš„githubä¸Šæ–°å»ºä¸€ä¸ªä»“åº“ï¼Œå°†ä»“åº“çš„å‘½åä¸ºxxx.github.ioï¼Œä¸€å®šè¦æŒ‰è¯¥æ ¼å¼å‘½åï¼Œå¦åˆ™ä¸èƒ½æ­å»ºæˆåŠŸ</p>
<a id="more"></a>
<h2 id="2-_u914D_u7F6E_u73AF_u5883"><a href="#2-_u914D_u7F6E_u73AF_u5883" class="headerlink" title="2.é…ç½®ç¯å¢ƒ"></a>2.é…ç½®ç¯å¢ƒ</h2><p>åœ¨ä½¿ç”¨æ­å»ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®å¥½ä¸‹é¢ç¯å¢ƒ</p>
<h4 id="u5B89_u88C5Homebrew"><a href="#u5B89_u88C5Homebrew" class="headerlink" title="å®‰è£…Homebrew"></a>å®‰è£…Homebrew</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</div></pre></td></tr></table></figure>
<h4 id="u5B89_u88C5node-js"><a href="#u5B89_u88C5node-js" class="headerlink" title="å®‰è£…node.js"></a>å®‰è£…node.js</h4><p>node.jsé›†æˆå¸¦æœ‰äº†npm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ brew install node</div></pre></td></tr></table></figure>
<h4 id="u5B89_u88C5hexo-cli"><a href="#u5B89_u88C5hexo-cli" class="headerlink" title="å®‰è£…hexo-cli"></a>å®‰è£…hexo-cli</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install -g hexo-cli</div></pre></td></tr></table></figure>
<h2 id="3-_u5728blog_u76EE_u5F55_u4E0B_uFF0C_u521D_u59CB_u5316hexo"><a href="#3-_u5728blog_u76EE_u5F55_u4E0B_uFF0C_u521D_u59CB_u5316hexo" class="headerlink" title="3.åœ¨blogç›®å½•ä¸‹ï¼Œåˆå§‹åŒ–hexo"></a>3.åœ¨blogç›®å½•ä¸‹ï¼Œåˆå§‹åŒ–hexo</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ¥å­˜æ”¾blogå†…å®¹ï¼Œå‡è®¾æˆ‘æ–°å»ºäº†ä¸€ä¸ªblogæ–‡ä»¶å¤¹ï¼Œç„¶åæˆ‘cdåˆ°è¯¥è·¯å¾„ä¸‹é¢ï¼Œç„¶åæˆ‘ä»¬éœ€è¦å¯¹è¯¥ç›®å½•è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo init $&#123;blogè·¯å¾„&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/hexoinit.png" alt=""></p>
<p>ï¼ˆå›¾ä¸­ä¸­é—´å‡ºç°çš„æŠ¥é”™ä¸è¦åœ¨æ„ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨äº†æ’ä»¶ï¼Œæç¤ºæœªæ‰¾åˆ°è¯¥æ’ä»¶ï¼‰</p>
<h2 id="4-_u751F_u6210_u9759_u6001_u9875_u9762"><a href="#4-_u751F_u6210_u9759_u6001_u9875_u9762" class="headerlink" title="4.ç”Ÿæˆé™æ€é¡µé¢"></a>4.ç”Ÿæˆé™æ€é¡µé¢</h2><p>åˆå§‹åŒ–å¥½ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é¡µé¢æ˜¯ä¸æ˜¯èƒ½æ­£å¸¸æ˜¾ç¤ºæ‰“å¼€äº†ï¼Œè¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo g</div></pre></td></tr></table></figure>
<p>ç­‰åŒäº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<h4 id="u6CE8_u610F_uFF1A"><a href="#u6CE8_u610F_uFF1A" class="headerlink" title="æ³¨æ„ï¼š"></a>æ³¨æ„ï¼š</h4><p>ç¬¬ä¸€æ¬¡éƒ¨ç½²çš„æ—¶å€™ä¼šå› ä¸ºæ‰¾ä¸åˆ°gitè€ŒæŠ¥é”™ï¼Œéœ€è¦å®‰è£…ä¸‹ï¼Œå†æäº¤ä¸€æ¬¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/hexog.png" alt=""></p>
<h2 id="5-_u521D_u59CB_u5316_u4F9D_u8D56"><a href="#5-_u521D_u59CB_u5316_u4F9D_u8D56" class="headerlink" title="5.åˆå§‹åŒ–ä¾èµ–"></a>5.åˆå§‹åŒ–ä¾èµ–</h2><p>åœ¨ç¬¬ä¸€æ¬¡å®‰è£…è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–ä¾èµ–ï¼Œå¦åˆ™åé¢å¯åŠ¨æœåŠ¡æˆ–è€…ç”Ÿæˆé™æ€ç•Œé¢ä¼šå‡ºé”™â€¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install</div></pre></td></tr></table></figure>
<h2 id="6-_u542F_u52A8_u670D_u52A1"><a href="#6-_u542F_u52A8_u670D_u52A1" class="headerlink" title="6.å¯åŠ¨æœåŠ¡"></a>6.å¯åŠ¨æœåŠ¡</h2><p>ç„¶åæˆ‘ä»¬å¯åŠ¨ä¸€ä¸‹æœåŠ¡çœ‹çœ‹ï¼Œæˆ‘ä»¬çš„åšå®¢æ˜¯ä¸æ˜¯èƒ½æ‰“å¼€äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/hexoserver.png" alt=""></p>
<p>æˆ‘ä»¬æ‰“å¼€<a href="http://0.0.0.0:4000/" target="_blank" rel="external">http://0.0.0.0:4000/</a>çœ‹çœ‹ï¼Œå¦‚æœå‰é¢ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä½ å°±èƒ½çœ‹åˆ°ä½ æ­å»ºæˆåŠŸçš„åšå®¢äº†~ï¼ˆæ³¨æ„æ­¤æ—¶æ‰“å¼€çš„è¿˜ä¸æ˜¯è‡ªå·±çš„githubåšå®¢åœ°å€å“¦ï¼Œåªæ˜¯hexoé»˜è®¤é…ç½®çš„åœ°å€ï¼‰</p>
<h2 id="7-_u4FEE_u6539blog_u76EE_u5F55_u4E0B_u7684_config-yml_u914D_u7F6E_u6587_u4EF6"><a href="#7-_u4FEE_u6539blog_u76EE_u5F55_u4E0B_u7684_config-yml_u914D_u7F6E_u6587_u4EF6" class="headerlink" title="7.ä¿®æ”¹blogç›®å½•ä¸‹çš„_config.ymlé…ç½®æ–‡ä»¶"></a>7.ä¿®æ”¹blogç›®å½•ä¸‹çš„_config.ymlé…ç½®æ–‡ä»¶</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°†hexoæ‰“å¼€çš„åšå®¢åœ°å€æ”¹æˆè‡ªå·±çš„åœ°å€ï¼Œæ‰“å¼€blogç›®å½•ä¸‹é¢çš„_config.ymlæ–‡ä»¶ï¼Œæ‰¾åˆ°deployï¼Œå°†éƒ¨ç½²ç±»å‹æ”¹æˆgitæˆ–è€…GItHubï¼Œä»“åº“æ”¹æˆè‡ªå·±çš„github blogåœ°å€æ ¼å¼ï¼Œåˆ†æ”¯æ”¹æˆmasterï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">deploy:</span></div><div class="line"><span class="attr">  type:</span> <span class="string">git</span>    <span class="comment">#éƒ¨ç½²ç±»å‹</span></div><div class="line"><span class="attr">  repository:</span> <span class="attr">https://github.com/Yuzeyang/yuzeyang.github.io.git</span>   <span class="comment">#éƒ¨ç½²çš„ä»“åº“çš„SSH</span></div><div class="line"><span class="attr">  branch:</span> <span class="string">master</span>   <span class="comment">#éƒ¨ç½²åˆ†æ”¯,ä¸€èˆ¬ä½¿ç”¨masterä¸»åˆ†æ”¯</span></div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼štype/repository/branch:å’Œå†…å®¹ä¹‹é—´æ˜¯æœ‰ç©ºæ ¼çš„ï¼Œè€Œä¸”æ˜¯ä¸€å®šè¦æœ‰çš„ï¼Œå¦åˆ™åœ¨é‡æ–°ç”Ÿæˆé™æ€é¡µé¢çš„æ—¶å€™ï¼Œä¼šæ‰¾ä¸åˆ°ä»“åº“è·¯å¾„</p>
<h2 id="8-_u9009_u53D6_u559C_u6B22_u7684_u4E3B_u9898"><a href="#8-_u9009_u53D6_u559C_u6B22_u7684_u4E3B_u9898" class="headerlink" title="8.é€‰å–å–œæ¬¢çš„ä¸»é¢˜"></a>8.é€‰å–å–œæ¬¢çš„ä¸»é¢˜</h2><p>ä½œä¸ºçˆ±è£…é€¼çš„ç¨‹åºå‘˜æ€ä¹ˆèƒ½ç”¨é»˜è®¤çš„ä¸»é¢˜å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨hexoä¸»é¢˜ç½‘èµšæŒ‘é€‰ä¸€ä¸ªè‡ªå·±å–œæ¬¢çš„ä¸»é¢˜ï¼š<a href="https://hexo.io/themes/" target="_blank" rel="external">hexoä¸»é¢˜</a>ï¼Œå½“ç„¶ä½ æœ‰ä¸€å®šçš„å‰ç«¯åŸºç¡€å¯ä»¥è‡ªå·±å†™ä¸€å¥—ä¸»é¢˜ç©ç©ï¼Œåˆ†äº«ç»™å¤§å®¶</p>
<h2 id="9-_u91CD_u65B0_u90E8_u7F72_u4F60_u7684_u9759_u6001_u7F51_u9875"><a href="#9-_u91CD_u65B0_u90E8_u7F72_u4F60_u7684_u9759_u6001_u7F51_u9875" class="headerlink" title="9.é‡æ–°éƒ¨ç½²ä½ çš„é™æ€ç½‘é¡µ"></a>9.é‡æ–°éƒ¨ç½²ä½ çš„é™æ€ç½‘é¡µ</h2><p>ä¿®æ”¹å®Œé…ç½®ä¹‹åï¼Œæˆ‘ä»¬é‡æ–°éƒ¨ç½²ä¸€ä¸‹ï¼Œçœ‹çœ‹æ•ˆæœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo d -g</div></pre></td></tr></table></figure>
<p>ç­‰åŒäº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy -generate</div></pre></td></tr></table></figure>
<h2 id="10-_u518D_u5237_u65B0_u4E00_u4E0B_u4F60_u7684_u7F51_u9875_uFF0CDuang_7E"><a href="#10-_u518D_u5237_u65B0_u4E00_u4E0B_u4F60_u7684_u7F51_u9875_uFF0CDuang_7E" class="headerlink" title="10.å†åˆ·æ–°ä¸€ä¸‹ä½ çš„ç½‘é¡µï¼ŒDuang~"></a>10.å†åˆ·æ–°ä¸€ä¸‹ä½ çš„ç½‘é¡µï¼ŒDuang~</h2><p>å› ä¸ºé¦–é¡µå›¾ç‰‡åŠ è½½å¤ªæ…¢äº†â€¦æˆ‘æ¢äº†ä¸ªä¸»é¢˜â€¦</p>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/blog.jpg" alt=""></p>
<h2 id="11-_u4E0A_u4F20_u6587_u7AE0"><a href="#11-_u4E0A_u4F20_u6587_u7AE0" class="headerlink" title="11.ä¸Šä¼ æ–‡ç« "></a>11.ä¸Šä¼ æ–‡ç« </h2><p>ä½ å¯ä»¥è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new &quot;æ–°çš„æ–‡ç« æ ‡é¢˜&quot;</div></pre></td></tr></table></figure>
<p>è¿™æ ·ä¼šè‡ªåŠ¨ç”Ÿæˆå¥½</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">title: Hexoæ­å»ºGitHub blog</div><div class="line">date: 2016-4-29 17:00:00</div><div class="line">tags: Hexo</div><div class="line">---</div></pre></td></tr></table></figure>
<p>æˆ–è€…ï¼Œ æŠŠæ–‡ç« æ”¾åˆ°blog/source/._postsç›®å½•ä¸‹é¢</p>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/upload.jpg" alt=""></p>
<p>åœ¨æ–‡ç« çš„å†…å®¹å‰é¢éœ€è¦åŠ ä¸Šæ ‡é¢˜ã€æ—¶é—´å’Œæ ‡ç­¾ï¼Œè¿™æ ·æ‰èƒ½åœ¨é¦–é¡µæ˜¾ç¤ºå‡ºä½ çš„æ ‡é¢˜ï¼Œä½ ä¹Ÿå¯ä»¥æ·»åŠ æ–‡ç« çš„æ—¶é—´å’Œæ–‡ç« çš„tagï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">title: Hexoæ­å»ºGitHub blog</div><div class="line">date: 2016-4-29</div><div class="line">tags: Hexo</div><div class="line">---</div></pre></td></tr></table></figure>
<p>å†èµ·ä¸€ä¸‹æœåŠ¡ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä¿®æ”¹æˆåŠŸ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹æˆåŠŸåï¼Œå†é‡æ–°éƒ¨ç½²ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo d -g</div></pre></td></tr></table></figure>
<p>æœ€åå†ç¡®è®¤ä¸€ä¸‹</p>
<p><img src="http://7xtit4.com2.z0.glb.clouddn.com/update.jpg" alt=""></p>
<p>ä¸Šä¼ æˆåŠŸ~ï¼</p>
<h2 id="12-_u7533_u8BF7_u4E2A_u4EBA_u57DF_u540D"><a href="#12-_u7533_u8BF7_u4E2A_u4EBA_u57DF_u540D" class="headerlink" title="12.ç”³è¯·ä¸ªäººåŸŸå"></a>12.ç”³è¯·ä¸ªäººåŸŸå</h2><p>ä½¿ç”¨xxx.github.ioï¼Œå…¶å®è¿˜ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¹Ÿæ²¡æœ‰xxx.comæˆ–è€…xxx.meè¿™æ ·çš„åŸŸåå¥½ï¼ˆzhuangï¼‰è®°ï¼ˆbiï¼‰ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¼šè‡ªå·±å»ç”³è¯·ä¸€ä¸ªä¸ªäººåŸŸå</p>
<p>æˆ‘ä»¬æ‰“å¼€googleï¼Œæœç´¢ä¸€ä¸‹<code>ä¸ªäººåŸŸå</code></p>
<p>æ©ï¼Œè·³å‡º<a href="https://wanwang.aliyun.com/?utm_content=se_97054&amp;gclid=CITQ0ce8vs0CFQqkvQodNFUPrA" target="_blank" rel="external">ä¸‡ç½‘</a>å’Œ<a href="https://sg.godaddy.com/zh/offers/default.aspx?tmskey=1dom_23&amp;isc=gennlcn10&amp;countrview=1&amp;currencytype=CNY&amp;cvosrc=ppc.google.+%C3%A4%C2%B8%C2%AA%C3%A4%C2%BA%C2%BA%C3%A5%C2%9F%C2%9F%C3%A5%C2%90%C2%8D&amp;cvo_crid=103919011486&amp;matchtype=b" target="_blank" rel="external">GoDaddy</a>ï¼Œä¸è¿‡å¥½åƒGoDaddyç»­è´¹æ¯”è¾ƒè´µï¼Œä¸‡ç½‘å¥½åƒèƒ½æŸ¥åˆ°ä½ çš„ä¸ªäººä¿¡æ¯èµ„æ–™â€¦</p>
<p>æ‰€ä»¥æˆ‘å’¨è¯¢äº†ä¸‹åŒäº‹ï¼Œä»–ä»¬æ¨èäº†æˆ‘<a href="https://www.namesilo.com/" target="_blank" rel="external">namesilo</a>ï¼Œç»­è´¹ä¾¿å®œï¼Œè¿˜èƒ½å¼€å¯éšç§ä¿æŠ¤~</p>
<p>è¿›åˆ°é¦–é¡µä¹‹åæˆ‘ä»¬åœ¨ç®­å¤´ä½ç½®æœç´¢ä¸‹æˆ‘ä»¬æƒ³è¦çš„åŸŸå</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/namesilo.png" alt=""></p>
<p>ç„¶åæˆ‘ä»¬å°±èƒ½çœ‹åˆ°å“ªäº›æ˜¯å·²ç»æ³¨å†Œï¼Œå“ªäº›æ˜¯å¯ä»¥ä½¿ç”¨çš„</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/namesiloRes.png" alt=""></p>
<p>åœ¨æ”¯ä»˜å‰çœ‹ä¸‹ä»·æ ¼ï¼Œè¿™ä¸Šé¢æ˜¾ç¤ºçš„ä»·æ ¼åªæ˜¯ä½ä»·ï¼Œç±»ä¼¼äºèµ·æ‹ä»·ï¼Œå®é™…ä»·æ ¼åœ¨æ”¯ä»˜é¡µå¯ä»¥çœ‹åˆ°ï¼Œè´­ä¹°å‰è¯·ä»”ç»†çœ‹ä¸‹æ•°å­—â€¦åˆ«ä»˜äº†å¥½å‡ ä¸‡â€¦ï¼ˆå¯ä»¥æ”¯æŒæ”¯ä»˜å®å“¦~ï¼‰</p>
<p>ç„¶åæˆ‘ä»¬åˆ°<a href="https://www.dnspod.cn/" target="_blank" rel="external">DNSPOD</a>é‡Œï¼Œå¯¹æˆ‘ä»¬çš„xxx.github.ioè¿›è¡ŒDNSè½¬ç§»åˆ°xxx.com</p>
<p>ç™»å½•åï¼Œåœ¨åŸŸåè§£æé‡Œé¢ï¼Œæ·»åŠ æˆ‘ä»¬çš„ä¸ªäººåŸŸåï¼Œç„¶åå°†é»˜è®¤çš„NSç±»å‹çš„è®°å½•å€¼æ‹·è´å‡ºæ¥ï¼Œå›åˆ°æˆ‘ä»¬çš„namesiloé‡Œé¢ï¼Œå°†nameserverä¿®æ”¹æˆNSç±»å‹çš„è®°å½•å€¼ï¼Œä¿å­˜ï¼Œç„¶åè¿‡ä¸€ä¼šå„¿æ‰ä¼šç”Ÿæ•ˆ</p>
<p>åœ¨Githubçš„xxx.github.ioä»“åº“çš„ç›®å½•ä¸‹é¢ï¼Œæ–°å»ºä¸€ä¸ªCNAMEæ–‡ä»¶ï¼Œå†™ä¸Šä½ çš„ä¸ªäººåŸŸå</p>
<p>åœ¨webå¯¼èˆªæ é‡Œé¢è¾“å‡ºä½ çš„ä¸ªäººåŸŸåï¼Œå°±å¯ä»¥æ­£å¸¸è®¿é—®äº†~</p>
<h2 id="13-_u589E_u52A0_u8BC4_u8BBA_u529F_u80FD"><a href="#13-_u589E_u52A0_u8BC4_u8BBA_u529F_u80FD" class="headerlink" title="13.å¢åŠ è¯„è®ºåŠŸèƒ½"></a>13.å¢åŠ è¯„è®ºåŠŸèƒ½</h2><p>ç›®å‰ç”¨çš„æ¯”è¾ƒå¤šçš„è¯„è®ºæ’ä»¶æœ‰<a href="https://disqus.com/" target="_blank" rel="external">disqus</a>ã€<a href="http://duoshuo.com/" target="_blank" rel="external">å¤šè¯´</a>ã€<a href="http://www.uyan.cc/" target="_blank" rel="external">å‹è¨€</a></p>
<p>ä½†æ˜¯å¤šè¯´å’Œå‹è¨€ç•Œé¢æœ‰ç‚¹ä¸‘â€¦ç›¸æ¯”ä¹‹ä¸‹disqusè¿˜æ˜¯æ¯”è¾ƒç¬¦åˆæˆ‘çš„å£å‘³çš„~</p>
<p>é‚£æˆ‘å°±æ¥ä»‹ç»æ€ä¹ˆåŠ disqus</p>
<p>é¦–å…ˆæ³¨å†Œç™»å½•ï¼Œç„¶åç‚¹å‡»å³ä¸Šè§’çš„è®¾ç½®æŒ‰é’®</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/SettingsDisqus.png!400x400" alt=""></p>
<p>é€‰æ‹©å·¦ä¾§çš„<code>Account</code>ï¼Œåœ¨Usernameé‡Œé¢å¡«ä¸Šä½ çš„åŸŸååç§°ï¼Œä¾‹å¦‚æˆ‘çš„åŸŸåæ˜¯<code>zeeyang.com</code>ï¼Œé‚£ä¹ˆæˆ‘å°±å¡«<code>zeeyang</code></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/SettingsDisqusUsername.png" alt=""></p>
<p>ç„¶åæ‰“å¼€ä½ çš„hexoé…ç½®æ–‡ä»¶ï¼Œåœ¨æœ€ååŠ ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">disqus_shortname: åŸŸååç§°(ä¾‹å¦‚ï¼šzeeyang)</div></pre></td></tr></table></figure>
<p>ç„¶åæ‰“å¼€ä¸»é¢˜é…ç½®æ–‡ä»¶ï¼Œä¹ŸåŒæ ·åŠ ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">disqus: åŸŸååç§°(ä¾‹å¦‚ï¼šzeeyang)</div></pre></td></tr></table></figure>
<p>ç„¶åæäº¤ä¿®æ”¹ï¼Œå†åˆ·æ–°ä¸‹ç½‘é¡µ</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/disqusComplete.png" alt=""></p>
<p>è¿™ä¸‹å­åˆ«äººå¯ä»¥åœ¨ä½ çš„æ–‡ç« ä¸‹é¢ç•™è¨€å•¦~ï¼ˆæˆ‘åæ¥æ›´æ¢äº†apolloä¸»é¢˜ï¼Œæ¯”è¾ƒæ¸…çˆ½ï¼‰</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¦‚æœä½ åŒå€¦äº†ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹çš„åšå®¢å¹³å°ï¼Œä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹ç”¨hexoå’Œgithubæ¥æ­å»ºè‡ªå·±çš„åšå®¢&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;ç”¨hexoæ¥æ­å»ºgithub blogå¾ˆç®€å•ï¼Œåªéœ€è¦äº”æ­¥~&lt;/p&gt;
&lt;h2 id=&quot;1-_u5728github_u4E0A_u9762_u65B0_u5EFA_u4E00_u4E2A_u4ED3_u5E93&quot;&gt;&lt;a href=&quot;#1-_u5728github_u4E0A_u9762_u65B0_u5EFA_u4E00_u4E2A_u4ED3_u5E93&quot; class=&quot;headerlink&quot; title=&quot;1.åœ¨githubä¸Šé¢æ–°å»ºä¸€ä¸ªä»“åº“&quot;&gt;&lt;/a&gt;1.åœ¨githubä¸Šé¢æ–°å»ºä¸€ä¸ªä»“åº“&lt;/h2&gt;&lt;p&gt;é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨è‡ªå·±çš„githubä¸Šæ–°å»ºä¸€ä¸ªä»“åº“ï¼Œå°†ä»“åº“çš„å‘½åä¸ºxxx.github.ioï¼Œä¸€å®šè¦æŒ‰è¯¥æ ¼å¼å‘½åï¼Œå¦åˆ™ä¸èƒ½æ­å»ºæˆåŠŸ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="http://yuzeyang.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>iOS åŒæ—¶ä¿®æ”¹buttonä½ç½®å’Œæ–‡å­—é—®é¢˜</title>
    <link href="http://yuzeyang.github.io/2016/04/09/button-location-title-bug/"/>
    <id>http://yuzeyang.github.io/2016/04/09/button-location-title-bug/</id>
    <published>2016-04-09T03:27:16.000Z</published>
    <updated>2016-05-21T03:39:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨å†™Appçš„ç™»å½•æ³¨å†Œç•Œé¢ï¼Œå…¶ä¸­ç™»å½•å’Œæ³¨å†Œä¹‹é—´çš„åˆ‡æ¢å’Œå°è±¡ç¬”è®°ä¸€æ ·<br><img src="http://7xtit4.com1.z0.glb.clouddn.com/Evernote.gif!500x500" alt="å°è±¡ç¬”è®°ç™»å½•ç•Œé¢"></p>
<hr>
<p>ä¸­é—´çš„ç™»å½•æŒ‰é’®ä¼šæœ‰ä¸€ä¸ªä¸‹ç§»ä»¥åŠæ›´æ”¹æ–‡å­—çš„æ“ä½œï¼Œä½†æ˜¯æˆ‘åœ¨åŠ äº†ä¸‹ç§»åŠ¨ç”»ä¹‹åï¼Œå†ä¿®æ”¹æŒ‰é’®çš„æ–‡å­—ï¼Œå°±å‡ºç°äº†å¾ˆå¥‡æ€ªçš„ç°è±¡ï¼ŒæŒ‰é’®ä¼šå…ˆä¸‹ç§»ç„¶åä¿®æ”¹æ–‡å­—ä¹‹åï¼Œåˆè·³å›åˆ°æœ€åˆçš„ä½ç½®</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/Evernote%20bug.gif!500x500" alt="é—®é¢˜æ“ä½œ"><br>è¿™å°±å¥‡æ€ªäº†ï¼Œçœ‹é€»è¾‘ä¸Šä¸€ç‚¹é”™è¯¯ä¹Ÿæ²¡æœ‰ï¼Œé‚£æ€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p>
<p>æ£€æŸ¥äº†ä¸‹æŒ‰é’®çš„ç±»å‹ä¹Ÿæ˜¯è‡ªå®šä¹‰çš„ï¼Œé‚£ä¼šä¸ä¼šæ˜¯åŠ¨ç”»å½±å“çš„å‘¢ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (void)animateWithDuration:(NSTimeInterval)duration animations:(void (^)(void))animations completion:(void (^ __nullable)(BOOL finished))completion NS_AVAILABLE_IOS(4_0);</div></pre></td></tr></table></figure></p>
<p>åœ¨blocké‡Œé¢ï¼Œæˆ‘åœ¨setTitle:forStateçš„æ–¹æ³•å¤–é¢ï¼Œå»æ‰åŠ¨ç”»çš„å½±å“<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[UIView setAnimationsEnabled:NO];</div><div class="line">[self.loginButton setTitle:@&quot;æ³¨ Â  å†Œ&quot; forState:UIControlStateNormal];</div><div class="line">[self.loginButton layoutIfNeeded];</div><div class="line">[UIView setAnimationsEnabled:YES];</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[UIView performWithoutAnimation:^&#123;</div><div class="line">Â  Â  Â  Â  [self.loginButton setTitle:@&quot;æ³¨ Â  å†Œ&quot; forState:UIControlStateNormal];</div><div class="line">        [self.loginButton layoutIfNeeded];</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>éƒ½è¿˜æ˜¯ä¸è¡Œã€‚ã€‚ã€‚</p>
<p>å¹²è„†æŠŠåŠ¨ç”»æ–¹æ³•å»æ‰ï¼Œç›´æ¥æ”¹å˜æŒ‰é’®çš„ä½ç½®å†è¯•è¯•ã€‚ã€‚ç»“æœè¿˜æ˜¯ä¸€æ ·ï¼Œé‚£å°±çº³é—·äº†ã€‚ã€‚</p>
<p>åæ¥æ‰¾äº†å¾ˆä¹…çš„èµ„æ–™å‘ç°ï¼ŒåŸæ¥æ˜¯å—åˆ°äº†autolayoutçš„å½±å“ï¼Œå› ä¸ºåœ¨å¹¿æ³›å¼€å§‹ä½¿ç”¨autolayoutä¹‹åï¼Œåœ¨storyboardï¼Œnibå’Œå®ç°æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å¯èƒ½ä¸åƒä»¥å‰é‚£æ ·å»ç¹ççš„è®¡ç®—åæ ‡äº†ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªé€‚åº”çš„æ–¹å¼ï¼Œå»ç¡®å®šæ§ä»¶çš„ä½ç½®</p>
<p>å› ä¸ºæˆ‘çš„ç™»å½•æŒ‰é’®æ˜¯è‡ªé€‚åº”çš„ï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹äº†æŒ‰é’®ä½ç½®åï¼Œå†ä¿®æ”¹æ–‡å­—ï¼Œå°±ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘æ‰“å°äº†å¾ˆå¤šæ–¹æ³•ï¼Œéƒ½æ²¡æœ‰å‘ç°è°ƒç”¨ï¼Œæ‰€ä»¥ä¸çŸ¥é“ç³»ç»Ÿåœ¨è®¾ç½®æ–‡å­—çš„æ—¶å€™ï¼Œåˆè°ƒç”¨äº†å“ªä¸ªæ–¹æ³•</p>
<p>æˆ‘è¯•ç€è°ƒç”¨äº†ä¿®æ”¹å…¶ä»–çš„å±æ€§çš„æ–¹æ³•ï¼Œæ¯”å¦‚èƒŒæ™¯è‰²ï¼ŒsetImageï¼šforStateï¼Œè¿™äº›éƒ½æ²¡äº‹ï¼Œå‡¡æ˜¯è°ƒç”¨äº†titleç›¸å…³çš„ä¸‰ä¸ªè®¾ç½®éƒ½ä¼šè¿™æ ·ã€‚ã€‚æˆ‘å°±æ»¡è„¸é»‘çº¿äº†ã€‚ã€‚</p>
<p>æ‰€ä»¥ç›®å‰èƒ½æ‰¾åˆ°çš„è§£å†³åŠæ³•å°±æ˜¯ï¼Œè¯¥æŒ‰é’®<strong>ç”¨åæ ‡è®¡ç®—çš„æ–¹å¼æ·»åŠ </strong></p>
<p>å¦‚æœå“ªä½å¤§ç¥æ‰¾åˆ°æ›´å¥½çš„è§£å†³åŠæ³•ï¼Œæ¬¢è¿ç•™è¨€~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¤©åœ¨å†™Appçš„ç™»å½•æ³¨å†Œç•Œé¢ï¼Œå…¶ä¸­ç™»å½•å’Œæ³¨å†Œä¹‹é—´çš„åˆ‡æ¢å’Œå°è±¡ç¬”è®°ä¸€æ ·&lt;br&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/Evernote.gif!500x500&quot; alt=&quot;å°è±¡ç¬”è®°ç™»å½•ç•Œé¢&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;ä¸­
    
    </summary>
    
    
      <category term="button" scheme="http://yuzeyang.github.io/tags/button/"/>
    
  </entry>
  
  <entry>
    <title>iOS ç®€å•ä¸‹è½½åŠ¨ç”»</title>
    <link href="http://yuzeyang.github.io/2016/03/27/simple-download-animation/"/>
    <id>http://yuzeyang.github.io/2016/03/27/simple-download-animation/</id>
    <published>2016-03-27T03:22:17.000Z</published>
    <updated>2016-05-21T03:40:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªåŠ¨ç”»æ¯”è¾ƒç®€å•åŸºç¡€ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåŠ¨ç”»æ¨¡æ‹Ÿçš„åŠ¨å›¾<br><img src="http://7xtit4.com1.z0.glb.clouddn.com/downloadAnimation.gif!500x500" alt="ä¸‹è½½åŠ¨ç”»"></p>
<hr>
<p>åŠ¨ç”»ä¸€å…±æœ‰å››ä¸ªçŠ¶æ€ï¼Œ<strong>å¼€å§‹ä¸‹è½½</strong>ã€<strong>ä¸‹è½½ç»“æŸ</strong>ã€<strong>ä¸‹è½½æˆåŠŸ</strong>å’Œ<strong>ä¸‹è½½å¤±è´¥</strong></p>
<p>ä¸ºä»€ä¹ˆä¼šåˆ†æœ‰<strong>ä¸‹è½½ç»“æŸ</strong>è¿™æ ·çš„çŠ¶æ€å‘¢ï¼Ÿå› ä¸ºè€ƒè™‘åˆ°å®é™…åœºæ™¯ï¼Œå¯èƒ½ä¼šæœ‰åœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿”å›ä¸Šçº§ç•Œé¢ï¼Œæˆ‘ä»¬éœ€è¦ç»“æŸä¸‹è½½åŠ¨ç”»</p>
<hr>
<p>æˆ‘ä»¬æŒ‰çŠ¶æ€æ¥å®ç°ï¼Œé¦–å…ˆå…ˆçœ‹å¼€å§‹åŠ è½½<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *rotationZAnimation = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.z&quot;];</div><div class="line">rotationZAnimation.fromValue = @(0);</div><div class="line">rotationZAnimation.toValue = @(M_PI*2);</div><div class="line">rotationZAnimation.repeatDuration = HUGE_VAL;</div><div class="line">rotationZAnimation.duration = 1.0;</div><div class="line">rotationZAnimation.cumulative = YES;</div><div class="line">rotationZAnimation.beginTime = CACurrentMediaTime();</div><div class="line">[self.loadingLayer addAnimation:rotationZAnimation forKey:@&quot;rotationZAnimation&quot;];</div><div class="line">Â Â  Â  Â  Â </div><div class="line">NSArray *values = [self valueArrayWithWidth:self.downloadingViewWidth];</div><div class="line">CAKeyframeAnimation *boundsAnimation = [self bounsAnimationWithValues:values];</div><div class="line">[self.loadingLayer addAnimation:boundsAnimation forKey:nil];</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œåˆ†ä¸ºä¸¤ä¸ªåŠ¨ç”»ï¼Œä¸€ä¸ªæ˜¯<strong>æ—‹è½¬åŠ¨ç”»</strong>ï¼Œä¸€ä¸ªæ˜¯<strong>æ”¾å¤§ç¼©å°çš„åŠ¨ç”»</strong><br><strong>æ—‹è½¬åŠ¨ç”»</strong>ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªåˆå§‹å€¼å’Œæœ«å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨CABasicAnimationå°±å¯ä»¥äº†ï¼Œä¸éœ€è¦ä½¿ç”¨CAKeyframeAnimationï¼ŒCAKeyframeAnimationæ˜¯ç”¨æ¥å¤„ç†å…³é”®å¸§åŠ¨ç”»çš„ï¼Œå®ƒçš„valueså±æ€§ç”¨æ¥å­˜å‚¨å…³é”®å¸§çš„å€¼ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç”¨æ¥åšå¤„ç†<strong>æ”¾å¤§ç¼©å°åŠ¨ç”»</strong>ï¼Œä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°æˆ‘å°†å®ƒæŠ½æˆäº†ä¸€ä¸ªæ–¹æ³•æ¥ç”¨ï¼Œå› ä¸ºåœ¨ä¸‹è½½æˆåŠŸå’Œå¤±è´¥çš„æ—¶å€™ï¼ŒæˆåŠŸå’Œå¤±è´¥ä¹Ÿæ˜¯æœ‰æ”¾å¤§ç¼©å°çš„åŠ¨ç”»ï¼Œè¿™ä¸‰ä¸ªå…¶å®æ˜¯ä¸€ä¸ªåŠ¨ç”»<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (NSArray *)valueArrayWithWidth:(CGFloat)width &#123;</div><div class="line">Â  Â  return @[[NSValue valueWithCGRect:CGRectMake(0, 0, width * 0.7, width * 0.7)],</div><div class="line">Â Â  Â  Â  Â  Â  Â  [NSValue valueWithCGRect:CGRectMake(0, 0, width, width)],</div><div class="line">Â Â  Â  Â  Â  Â  Â  [NSValue valueWithCGRect:CGRectMake(0, 0, width * 0.9, width * 0.9)]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (CAKeyframeAnimation *)bounsAnimationWithValues:(NSArray *)values &#123;</div><div class="line">Â  Â  CAKeyframeAnimation *boundsAnimation = [CAKeyframeAnimation animationWithKeyPath:@&quot;bounds&quot;];</div><div class="line">Â  Â  boundsAnimation.duration = 0.6;</div><div class="line">Â  Â  boundsAnimation.beginTime = CACurrentMediaTime();</div><div class="line">Â  Â  boundsAnimation.values = values;</div><div class="line">Â  Â  boundsAnimation.keyTimes = @[@(0),@(0.3),@(0.6)];</div><div class="line">Â  Â  boundsAnimation.timingFunctions = @[[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut],</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseOut],</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseOut]];</div><div class="line">Â  Â  boundsAnimation.removedOnCompletion = NO;</div><div class="line">Â  Â  boundsAnimation.fillMode = kCAFillModeForwards;</div><div class="line">Â  Â  return boundsAnimation;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬ç»Ÿä¸€è®¾ç½®åŠ¨ç”»çš„valueså€¼ï¼Œè¿™é‡Œä¼ å…¥çš„widthå€¼æ˜¯ä¸‹è½½çš„èƒŒæ™¯å¤§å°ï¼Œå› ä¸ºä¸‹è½½åœ†åœˆæœ‰ä¸ªæ”¾å¤§çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ†åœˆçš„åŸå§‹å¤§å°è¦æ¯”èƒŒæ™¯çš„å¤§å°å°ï¼Œæ‰€ä»¥æˆ‘é»˜è®¤è®¾ç½®åœ†åœˆçš„å¤§å°æ˜¯èƒŒæ™¯å¤§å°çš„0.9å€ï¼Œæ‰€ä»¥åŠ¨ç”»çš„æ•ˆæœæ˜¯åœ†åœˆä»èƒŒæ™¯å¤§å°çš„0.7å€-&gt;èƒŒæ™¯å¤§å°-&gt;èƒŒæ™¯å¤§å°çš„0.9å€ï¼ˆåœ†åœˆçš„åŸå§‹å¤§å°ï¼‰<br>åœ¨è®¾ç½®è¿™ä¸ªåŠ¨ç”»çš„æ—¶å€™ï¼Œå› ä¸ºåŠ¨ç”»çš„å€¼ä¸æ­¢æ˜¯åˆå§‹å€¼å’Œæœ«å€¼ï¼Œè¿˜æ˜¯ä¸­é—´å€¼ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨CAKeyframeAnimationæ¥åšï¼Œæ¯ä¸ªå…³é”®å¸§ä¹‹é—´çš„åŠ¨ç”»æ—¶é—´è®¾ç½®ä¸º0.3ç§’ï¼Œè¿™æ˜¯æœ€é€‚åˆçš„åŠ¨ç”»æ—¶é—´ï¼Œå½“ç„¶è¿™æ˜¯æ—¶é—´è¿˜æ˜¯ç”±è‡ªå·±åå¤è°ƒè¯•åŠ¨ç”»å†³å®šçš„</p>
<hr>
<p>ä¸‹è½½ç»“æŸæˆ‘ä»¬åªè¦å°†è½¬åœˆçš„åŠ¨ç”»ç§»é™¤æ‰å³å¯ï¼Œè¿™æ ·è½¬åœˆå°±æ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€äº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.loadingLayer removeAllAnimations];</div></pre></td></tr></table></figure></p>
<hr>
<p>ä¸‹è½½æˆåŠŸæˆ‘ä»¬ä¹Ÿéœ€è¦å°†è½¬åœˆåŠ¨ç”»ç§»é™¤ï¼Œç„¶åå‡ºç°æˆåŠŸçš„åŠ¨ç”»ï¼Œå¹¶ä¸”å°†æˆåŠŸå›¾å±‚çš„é€æ˜åº¦ä»0å˜åˆ°1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[self.loadingLayer removeAllAnimations];</div><div class="line">self.failLayer.opacity = 0.0;</div><div class="line">NSArray *values = [self valueArrayWithWidth:self.downloadingViewWidth * 0.5];</div><div class="line">CAKeyframeAnimation *boundsAnimation = [self bounsAnimationWithValues:values];</div><div class="line">[self.doneLayer addAnimation:boundsAnimation forKey:nil];</div><div class="line">Â Â  Â  Â  Â </div><div class="line">[UIView animateWithDuration:1.0 animations:^&#123;</div><div class="line">Â  Â  self.doneLayer.opacity = 1.0;</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<hr>
<p>ä¸‹è½½å¤±è´¥ä¹Ÿæ˜¯åŒç†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[self.loadingLayer removeAllAnimations];</div><div class="line">self.doneLayer.opacity = 0.0;</div><div class="line">NSArray *values = [self valueArrayWithWidth:self.downloadingViewWidth * 0.5];</div><div class="line">CAKeyframeAnimation *boundsAnimation = [self bounsAnimationWithValues:values];</div><div class="line">[self.failLayer addAnimation:boundsAnimation forKey:nil];</div><div class="line">Â Â  Â  Â  Â </div><div class="line">[UIView animateWithDuration:1.0 animations:^&#123;</div><div class="line">Â  Â  Â self.failLayer.opacity = 1.0;</div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>å¥½äº†ï¼ŒåŠ¨ç”»ä¸»è¦çš„åŸç†å°±æ˜¯è¿™æ ·ï¼Œå…·ä½“çš„ä»£ç å®ç°å¯ä»¥çœ‹è¿™é‡Œï¼š<a href="https://github.com/Yuzeyang/DownloadingAnimation" target="_blank" rel="external">https://github.com/Yuzeyang/DownloadingAnimation</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ä¸ªåŠ¨ç”»æ¯”è¾ƒç®€å•åŸºç¡€ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåŠ¨ç”»æ¨¡æ‹Ÿçš„åŠ¨å›¾&lt;br&gt;&lt;img src=&quot;http://7xtit4.com1.z0.glb.clouddn.com/downloadAnimation.gif!500x500&quot; alt=&quot;ä¸‹è½½åŠ¨ç”»&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;åŠ¨ç”»
    
    </summary>
    
    
      <category term="ä¸‹è½½åŠ¨ç”»" scheme="http://yuzeyang.github.io/tags/%E4%B8%8B%E8%BD%BD%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäºŒï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/03/15/AFNetWorking-two/"/>
    <id>http://yuzeyang.github.io/2016/03/15/AFNetWorking-two/</id>
    <published>2016-03-15T07:34:30.000Z</published>
    <updated>2016-06-12T15:28:26.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>AFHTTPSessionManager</code>ç»§æ‰¿äº<code>AFURLSessionManager</code>ï¼Œæä¾›äº†æ›´æ–¹ä¾¿çš„HTTPè¯·æ±‚æ–¹æ³•ï¼ŒåŒ…æ‹¬äº†GETã€POSTã€PUTã€PATCHã€DELETEè¿™äº”ç§æ–¹å¼ï¼Œå¹¶ä¸”AFé¼“åŠ±æˆ‘ä»¬åœ¨<code>AFHTTPSessionManager</code>å†è¿›è¡Œä¸€æ¬¡å°è£…æ¥æ»¡è¶³æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚</p>
<a id="more"></a>
<hr>
<p>åœ¨å¼€å§‹çš„åœ°æ–¹ï¼ŒAFä¸€ç›´æé†’åˆ°ä¸€ä¸ªå±æ€§<code>baseURL</code>ï¼Œè¿™ä¸ªå˜é‡ä½ å¯ä»¥åœ¨è¿›ä¸€æ­¥å°è£…çš„æ—¶å€™ï¼Œå°†<code>baseURL</code>å†™æˆä½ è‡ªå·±çš„HTTPè¯·æ±‚åŸå§‹åœ°å€ï¼Œæ¯”å¦‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (NSURL *)baseURL &#123;</div><div class="line">    return [NSURL URLWithString:kBaseURLString];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å¯¹<code>baseURL</code>è¿›è¡Œæ‹¼æ¥çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼Œé˜²æ­¢å‡ºç°è¯·æ±‚çš„URLå‡ºç°é—®é¢˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NSURL *baseURL = [NSURL URLWithString:@&quot;http://example.com/v1/&quot;];</div><div class="line">    [NSURL URLWithString:@&quot;foo&quot; relativeToURL:baseURL];                  // http://example.com/v1/foo</div><div class="line">    [NSURL URLWithString:@&quot;foo?bar=baz&quot; relativeToURL:baseURL];          // http://example.com/v1/foo?bar=baz</div><div class="line">    [NSURL URLWithString:@&quot;/foo&quot; relativeToURL:baseURL];                 // http://example.com/foo</div><div class="line">    [NSURL URLWithString:@&quot;foo/&quot; relativeToURL:baseURL];                 // http://example.com/v1/foo</div><div class="line">    [NSURL URLWithString:@&quot;/foo/&quot; relativeToURL:baseURL];                // http://example.com/foo/</div><div class="line">    [NSURL URLWithString:@&quot;http://example2.com/&quot; relativeToURL:baseURL]; // http://example2.com/</div></pre></td></tr></table></figure>
<p>åœ¨åˆå§‹åŒ–çš„æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithBaseURL:(nullable NSURL *)url;</div><div class="line">- (instancetype)initWithBaseURL:(nullable NSURL *)url</div><div class="line">           sessionConfiguration:(nullable NSURLSessionConfiguration *)configuration NS_DESIGNATED_INITIALIZER;</div></pre></td></tr></table></figure>
<p><code>NS_DESIGNATED_INITIALIZER</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>æŒ‡å®šçš„æ„é€ å™¨é€šè¿‡å‘é€åˆå§‹åŒ–æ¶ˆæ¯åˆ°çˆ¶ç±»æ¥ä¿è¯objectè¢«å®Œå…¨åˆå§‹åŒ–ï¼ŒæŒ‡å®šæ„é€ å™¨æœ‰ä»¥ä¸‹å‡ ä¸ªè§„åˆ™ï¼š</p>
<p>1.æŒ‡å®šæ„é€ å™¨å¿…é¡»è°ƒç”¨çˆ¶ç±»çš„æŒ‡å®šæ„é€ å™¨</p>
<p>2.ä»»ä½•ä¸€ä¸ªä¾¿åˆ©æ„é€ å™¨å¿…é¡»è°ƒç”¨æœ€ç»ˆæŒ‡å‘æŒ‡å®šæ„é€ å™¨çš„å…¶ä»–æ„é€ å™¨</p>
<p>3.å…·æœ‰æŒ‡å®šæ„é€ å™¨çš„ç±»å¿…é¡»å®ç°çˆ¶ç±»çš„æ‰€æœ‰æŒ‡å®šæ„é€ å™¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (instancetype)init &#123;</div><div class="line">    // æŒ‡å‘- [initWithBaseURL:]</div><div class="line">  	return [self initWithBaseURL:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithBaseURL:(NSURL *)url &#123;</div><div class="line">    // æŒ‡å‘- [initWithBaseURL:sessionConfiguration:]</div><div class="line">    return [self initWithBaseURL:url sessionConfiguration:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithSessionConfiguration:(NSURLSessionConfiguration *)configuration &#123;</div><div class="line">    // æŒ‡å‘- [initWithBaseURL:sessionConfiguration:]</div><div class="line">    return [self initWithBaseURL:nil sessionConfiguration:configuration];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithBaseURL:(NSURL *)url</div><div class="line">           sessionConfiguration:(NSURLSessionConfiguration *)configuration</div><div class="line">&#123;</div><div class="line">    // è°ƒç”¨çˆ¶ç±»çš„- [initWithSessionConfiguration:]</div><div class="line">    self = [super initWithSessionConfiguration:configuration];</div><div class="line">    if (!self) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // baseURLèµ‹å€¼ï¼ŒAFHTTPRequestSerializerå’ŒAFJSONResponseSerializeråºåˆ—åŒ–</div><div class="line">    </div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DEPRECATED_ATTRIBUTE</code>è¿™ä¸ªç›¸ä¿¡å¤§å®¶è§å¾—æ¯”è¾ƒå¤šäº†ï¼Œå­—é¢æ„æ€å°±æ˜¯è¿™ä¸ªAPIä¸å»ºè®®å¼€å‘è€…å†ä½¿ç”¨äº†ï¼Œå†ä½¿ç”¨æ—¶ï¼Œä¼šå‡ºç°ç¼–è¯‘è­¦å‘Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (nullable NSURLSessionDataTask *)GET:(NSString *)URLString</div><div class="line">                   parameters:(nullable id)parameters</div><div class="line">                      success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</div><div class="line">                      failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure DEPRECATED_ATTRIBUTE;</div></pre></td></tr></table></figure>
<hr>
<p>ä¸‹é¢POSTã€GETã€PUTã€PATCHã€DELETEæ–¹æ³•ä¼ å‚åŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚</p>
<p><code>URLString</code>è¡¨ç¤ºè¯·æ±‚çš„URLï¼Œ<code>parameters</code>è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚å†…å®¹çš„å­˜å‚¨å™¨ï¼Œ<code>progress</code>è¡¨ç¤ºè¯·æ±‚çš„è¿›åº¦ï¼Œ<code>constructingBodyWithBlock</code>é‡Œé¢åªæœ‰ä¸€ä¸ªformDataç”¨æ¥æ‹¼æ¥åˆ°HTTPçš„è¯·æ±‚ä½“ï¼Œ<code>success</code>è¡¨ç¤ºè¯·æ±‚æˆåŠŸåçš„blockå›è°ƒï¼Œ<code>failure</code>è¡¨ç¤ºè¯·æ±‚å¤±è´¥çš„blockå›è°ƒ</p>
<p>é‚£ä¹ˆè¿™å‡ ä¸ªè¯·æ±‚æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p>1ã€POSTè¯·æ±‚æ˜¯å‘æœåŠ¡ç«¯å‘é€æ•°æ®çš„ï¼Œç”¨æ¥æ›´æ–°èµ„æºä¿¡æ¯ï¼Œå®ƒå¯ä»¥æ”¹å˜æ•°æ®çš„ç§ç±»ç­‰èµ„æº</p>
<p>2ã€GETè¯·æ±‚æ˜¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ•°æ®ï¼Œç”¨æ¥è·å–æˆ–æŸ¥è¯¢èµ„æºä¿¡æ¯</p>
<p>3ã€PUTè¯·æ±‚å’ŒPOSTè¯·æ±‚å¾ˆåƒï¼Œéƒ½æ˜¯å‘é€æ•°æ®çš„ï¼Œä½†æ˜¯PUTè¯·æ±‚ä¸èƒ½æ”¹å˜æ•°æ®çš„ç§ç±»ç­‰èµ„æºï¼Œå®ƒåªèƒ½ä¿®æ”¹å†…å®¹</p>
<p>4ã€DELETEè¯·æ±‚å°±æ˜¯ç”¨æ¥åˆ é™¤æŸä¸ªèµ„æºçš„</p>
<p>5ã€PATCHè¯·æ±‚å’ŒPUTè¯·æ±‚ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç”¨æ¥è¿›è¡Œæ•°æ®æ›´æ–°çš„ï¼Œå®ƒæ˜¯HTTP verbæ¨èç”¨äºæ›´æ–°çš„</p>
<p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨POSTå’ŒGETè¯·æ±‚æ˜¯æœ€å¤šçš„</p>
<hr>
<p>åœ¨è¯·æ±‚å®ç°çš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯è°ƒç”¨äº†<code>-[dataTaskWithHTTPMethod:URLString:parameters:uploadProgress:downloadProgress:success:failure]</code>æ–¹æ³•åˆ›å»º<code>NSURLSessionDataTask</code>å¯¹è±¡</p>
<p>ä¼ å‚çš„å†…å®¹åŸºæœ¬éƒ½æ˜¯å’Œä¸Šä¸€å±‚æ–¹æ³•ä¸€æ ·ï¼Œ<code>method</code>æŒ‡çš„å°±æ˜¯è¯·æ±‚çš„ç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (NSURLSessionDataTask *)dataTaskWithHTTPMethod:(NSString *)method</div><div class="line">                                       URLString:(NSString *)URLString</div><div class="line">                                      parameters:(id)parameters</div><div class="line">                                  uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgress</div><div class="line">                                downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgress</div><div class="line">                                         success:(void (^)(NSURLSessionDataTask *, id))success</div><div class="line">                                         failure:(void (^)(NSURLSessionDataTask *, NSError *))failure</div><div class="line">&#123;</div><div class="line"></div><div class="line">    NSError *serializationError = nil;</div><div class="line">    NSMutableURLRequest *request = [self.requestSerializer requestWithMethod:method URLString:[[NSURL URLWithString:URLString relativeToURL:self.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</div><div class="line">    if (serializationError) &#123;</div><div class="line">        if (failure) &#123;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">            dispatch_async(self.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                failure(nil, serializationError);</div><div class="line">            &#125;);</div><div class="line">#pragma clang diagnostic pop</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    __block NSURLSessionDataTask *dataTask = nil;</div><div class="line">    dataTask = [self dataTaskWithRequest:request</div><div class="line">                          uploadProgress:uploadProgress</div><div class="line">                        downloadProgress:downloadProgress</div><div class="line">                       completionHandler:^(NSURLResponse * __unused response, id responseObject, NSError *error) &#123;</div><div class="line">        // å¤±è´¥æˆåŠŸå¤„ç†</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    return dataTask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;AFHTTPSessionManager&lt;/code&gt;ç»§æ‰¿äº&lt;code&gt;AFURLSessionManager&lt;/code&gt;ï¼Œæä¾›äº†æ›´æ–¹ä¾¿çš„HTTPè¯·æ±‚æ–¹æ³•ï¼ŒåŒ…æ‹¬äº†GETã€POSTã€PUTã€PATCHã€DELETEè¿™äº”ç§æ–¹å¼ï¼Œå¹¶ä¸”AFé¼“åŠ±æˆ‘ä»¬åœ¨&lt;code&gt;AFHTTPSessionManager&lt;/code&gt;å†è¿›è¡Œä¸€æ¬¡å°è£…æ¥æ»¡è¶³æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>iOS AFNetWorkingæºç è¯¦è§£ï¼ˆä¸€ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/02/21/AFNetWorking-one/"/>
    <id>http://yuzeyang.github.io/2016/02/21/AFNetWorking-one/</id>
    <published>2016-02-21T03:47:48.000Z</published>
    <updated>2017-03-21T14:29:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆæ¥ä»‹ç»ä¸‹AFNetWorkingï¼Œå®˜æ–¹ä»‹ç»å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AFNetworking is a delightful networking library for iOS and Mac OS X. Itâ€™s built on top of the<a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html" target="_blank" rel="external">Foundation URL Loading System</a>, extending the powerful high-level networking abstractions built into Cocoa. It has a modular architecture with well-designed, feature-rich APIs that are a joy to use.</p>
<p>Perhaps the most important feature of all, however, is the amazing community of developers who use and contribute to AFNetworking every day. AFNetworking powers some of the most popular and critically-acclaimed apps on the iPhone, iPad, and Mac.</p>
<p>Choose AFNetworking for your next project, or migrate over your existing projectsâ€”youâ€™ll be happy you did!</p>
</blockquote>
<p>ç¿»è¯‘è¿‡æ¥ç®€å•æ¥è¯´å°±æ˜¯</p>
<p>AFNetworkingæ˜¯ä¸€ä¸ªé€‚ç”¨äºiOSå’ŒMac OS Xä¸¤ä¸ªå¹³å°çš„ç½‘ç»œåº“ï¼Œå®ƒæ˜¯åŸºäº<a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html" target="_blank" rel="external">Foundation URL Loading System</a>ä¸Šè¿›è¡Œäº†ä¸€å¥—å°è£…ï¼Œå¹¶ä¸”æä¾›äº†ä¸°å¯Œä¸”ä¼˜ç¾çš„APIæ¥å£ç»™ä½¿ç”¨è€…ä½¿ç”¨</p>
<a id="more"></a>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/AFNetWorking.png" alt=""></p>
<p>ç›¸ä¿¡ä»staræ•°å’Œforkæ•°æ¥çœ‹ï¼Œå¤§å®¶éƒ½èƒ½æ˜ç™½è¿™ä¸ªåº“æ˜¯å¤šä¹ˆçš„å—æ¬¢è¿äº†ï¼Œæ‰€ä»¥äº†è§£è¿™ä¸ªåº“å¯¹äºä¸€ä¸ªiOSå¼€å‘æ¥è¯´æ˜¯æä¸ºé‡è¦çš„ï¼</p>
<p>è¿™ä¸ªæ˜¯AFNetworkingçš„githubåœ°å€ï¼š<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">GitHub - AFNetworking/AFNetworking: A delightful networking framework for iOS</a></p>
<p>åœ¨ä½¿ç”¨å‰é˜…è¯»READMEæ˜¯éå¸¸é‡è¦çš„ï¼Œé‡Œé¢å¾€å¾€åŒ…æ‹¬äº†è¿™ä¸ªåº“çš„ä»‹ç»ã€å®‰è£…å’Œä½¿ç”¨ç­‰ç­‰ï¼Œå¯¹äºå¿«é€Ÿäº†è§£ä¸€ä¸ªåº“æ¥è¯´ï¼Œè¿™æ˜¯éå¸¸æœ‰å¸®åŠ©çš„</p>
<hr>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">AFNetWorkingæºç åœ°å€</a>é‡Œdownloadä¸‹æ¥ï¼Œæ‰“å¼€å·¥ç¨‹æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢å†…å®¹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯AFNetworkingï¼Œå¦ä¸€ä¸ªæ˜¯UIKit+AFNetworking</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/AFNetWorking_file.png" alt=""></p>
<p>å¾ˆæ˜æ˜¾ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”¨æ¥åšç½‘ç»œè¯·æ±‚ç›¸å…³çš„ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯å’ŒUIä½¿ç”¨ç›¸å…³çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ª</p>
<p>åœ¨çœ‹å®Œå¤´æ–‡ä»¶å’ŒREADMEä¹‹åï¼Œä½ ä¼šå‘ç°<code>AFURLSessionManager</code>å’Œ<code>AFHTTPSessionManager</code>æ˜¯é‡Œé¢æ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªç±»</p>
<p>è¿™é‡Œæˆ‘å…ˆè®²<code>AFURLSessionManager</code>è¿™ä¸ªç±»</p>
<p>é¦–å…ˆæµè§ˆå®Œè¿™ä¸ªç±»ä»APIï¼Œå‘ç°å…¶ä¸»è¦æä¾›äº†æ•°æ®çš„è¯·æ±‚ã€ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½</p>
<p>åœ¨å±æ€§æ–¹é¢ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@property(readonly,nonatomic,strong)NSArray *tasks;</div><div class="line"></div><div class="line">@property(readonly,nonatomic,strong)NSArray *dataTasks;</div><div class="line"></div><div class="line">@property(readonly,nonatomic,strong)NSArray *uploadTasks;</div><div class="line"></div><div class="line">@property(readonly,nonatomic,strong)NSArray *downloadTasks;</div></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™å››ä¸ªå±æ€§ï¼Œæˆ‘ä»¬åˆ†åˆ«å¯ä»¥æ‹¿åˆ°æ€»çš„ä»»åŠ¡é›†åˆã€æ•°æ®ä»»åŠ¡é›†åˆã€ä¸Šä¼ ä»»åŠ¡é›†åˆå’Œä¸‹è½½ä»»åŠ¡é›†åˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property(nonatomic,assign)BOOL attemptsToRecreateUploadTasksForBackgroundSessions;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå±æ€§éå¸¸é‡è¦ï¼Œæ³¨é‡Šé‡Œé¢å†™åˆ°ï¼Œåœ¨iOS7ä¸­å­˜åœ¨ä¸€ä¸ªbugï¼Œåœ¨åˆ›å»ºåå°ä¸Šä¼ ä»»åŠ¡æ—¶ï¼Œæœ‰æ—¶å€™ä¼šè¿”å›nilï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒAFNetworkingéµç…§äº†è‹¹æœçš„å»ºè®®ï¼Œåœ¨åˆ›å»ºå¤±è´¥çš„æ—¶å€™ï¼Œä¼šé‡æ–°å°è¯•åˆ›å»ºï¼Œæ¬¡æ•°é»˜è®¤ä¸º3æ¬¡ï¼Œæ‰€ä»¥ä½ çš„åº”ç”¨å¦‚æœæœ‰åœºæ™¯ä¼šæœ‰åœ¨åå°ä¸Šä¼ çš„æƒ…å†µçš„è¯ï¼Œè®°å¾—å°†è¯¥å€¼è®¾ä¸ºYESï¼Œé¿å…å‡ºç°ä¸Šä¼ å¤±è´¥çš„é—®é¢˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FOUNDATION_EXPORT NSString * const AFNetworkingTaskDidResumeNotification;</div></pre></td></tr></table></figure>
<p>åœ¨å¯¹å¤–æä¾›çš„notification keyé‡Œé¢ï¼Œä½¿ç”¨äº†<code>FOUNDATION_EXPORT</code>æ¥å®šä¹‰å¸¸é‡ï¼Œä½¿ç”¨<code>FOUNDATION_EXPORT</code>å’Œ<code>extern</code>æˆ–è€…<code>define</code>æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p><code>FOUNDATION_EXPORT</code>åœ¨cæ–‡ä»¶ç¼–è¯‘ä¸‹æ˜¯å’Œexternç­‰åŒï¼Œåœ¨c++æ–‡ä»¶ç¼–è¯‘ä¸‹æ˜¯å’Œextern â€œCâ€ç­‰åŒï¼Œåœ¨32ä½æœºçš„ç¯å¢ƒä¸‹åˆæ˜¯å¦å¤–ç¼–è¯‘æƒ…å†µï¼Œåœ¨å…¼å®¹æ€§æ–¹é¢ï¼Œ<code>FOUNDATION_EXPORT</code>åšçš„ä¼šæ›´å¥½ã€‚</p>
<p>è¿™é‡Œè¿˜æåˆ°äº†æ•ˆç‡æ–¹é¢çš„é—®é¢˜ï¼š<a href="http://www.jianshu.com/p/f547eb0368c4" target="_blank" rel="external">iOSå¼€å‘çš„ä¸€äº›å¥‡å·§æ·«æŠ€3</a></p>
<hr>
<p>è¿›å…¥åˆ°å®ç°æ–‡ä»¶é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å¤–éƒ¨APIè°ƒç”¨dataTaskã€uploadTaskã€downloadTaskæ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯completionHanlder blockè¿”å›å‡ºæ¥çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ç½‘ç»œè¯·æ±‚æ˜¯delegateè¿”å›ç»“æœçš„ï¼ŒAFå†…éƒ¨åšäº†å·§å¦™çš„æ“ä½œï¼Œä»–å¯¹æ¯ä¸ªtaskéƒ½å¢åŠ ä»£ç†è®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request</div><div class="line">                               uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgressBlock</div><div class="line">                             downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgressBlock</div><div class="line">                            completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject,  NSError * _Nullable error))completionHandler &#123;</div><div class="line">	__block NSURLSessionDataTask *dataTask = nil;</div><div class="line">    url_session_manager_create_task_safely(^&#123;</div><div class="line">        dataTask = [self.session dataTaskWithRequest:request];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">	// æ¯ä¸ªtaské‡Œé¢éƒ½ä¼šè°ƒç”¨addDelegateæ–¹æ³•</div><div class="line">    [self addDelegateForDataTask:dataTask uploadProgress:uploadProgressBlock downloadProgress:downloadProgressBlock completionHandler:completionHandler];</div><div class="line"></div><div class="line">    return dataTask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è®¾ç½®é‡Œé¢ï¼Œæ¯ä¸ªtaskä¼šåœ¨å†…éƒ¨åˆ›å»º<code>AFURLSessionManagerTaskDelegate</code>å¯¹è±¡ï¼Œå¹¶è®¾ç½®completionHandlerã€uploadProgressBlockã€downloadProgressBlockå›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (void)addDelegateForDataTask:(NSURLSessionDataTask *)dataTask</div><div class="line">                uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgressBlock</div><div class="line">              downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgressBlock</div><div class="line">             completionHandler:(void (^)(NSURLResponse *response, id responseObject, NSError *error))completionHandler</div><div class="line">&#123;</div><div class="line">    // åˆå§‹åŒ–delegateå¯¹è±¡</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] init];</div><div class="line">    delegate.manager = self;</div><div class="line">    // å°†taskçš„completionHandlerèµ‹ç»™delegateï¼Œç³»ç»Ÿç½‘ç»œè¯·æ±‚delegate è°ƒç”¨è¯¥blockï¼Œè¿”å›ç»“æœ</div><div class="line">    delegate.completionHandler = completionHandler;</div><div class="line"></div><div class="line">    dataTask.taskDescription = self.taskDescriptionForSessionTasks;</div><div class="line">    // å¯¹taskè¿›è¡Œdelegate</div><div class="line">    [self setDelegate:delegate forTask:dataTask];</div><div class="line">	// è®¾ç½®ä¸Šä¼ å’Œä¸‹è½½è¿›åº¦å›è°ƒ</div><div class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</div><div class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ådelegateå¯¹è±¡åˆ©ç”¨kvoå°†taskå¯¹ä¸€äº›æ–¹æ³•è¿›è¡Œç›‘å¬ï¼Œå¹¶ä¸”ç›‘å¬åˆ°å˜åŒ–æ—¶ï¼Œé€šè¿‡blockè¿”å›ï¼Œå°†delegateè½¬æˆblockå‡ºå»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (void)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</div><div class="line">            forTask:(NSURLSessionTask *)task</div><div class="line">&#123;</div><div class="line">    // æ–­è¨€</div><div class="line">    NSParameterAssert(task);</div><div class="line">    NSParameterAssert(delegate);</div><div class="line"></div><div class="line">    [self.lock lock];</div><div class="line">    self.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</div><div class="line">    // taskä½¿ç”¨kvoå¯¹ä¸€äº›æ–¹æ³•ç›‘å¬ï¼Œè¿”å›ä¸Šä¼ æˆ–è€…ä¸‹è½½çš„è¿›åº¦</div><div class="line">    [delegate setupProgressForTask:task];</div><div class="line">    // sessionManagerå¯¹æš‚åœtaskå’Œæ¢å¤taskè¿›è¡Œæ³¨å†Œé€šçŸ¥</div><div class="line">    [self addNotificationObserverForTask:task];</div><div class="line">    [self.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨åŸå…ˆIMçš„è®¾è®¡æ—¶ï¼Œå› ä¸ºæ¥å£çš„æ•°é‡å¹¶ä¸å¤šï¼Œæ‰€ä»¥åœ¨AsyncSocketçš„delegateå›è°ƒåï¼Œæˆ‘ä»¬ä¾æ—§æ˜¯é‡‡ç”¨delegateå›è°ƒç»™ä¸šåŠ¡å±‚ï¼Œä½†æ˜¯éšç€æ¥å£æ•°é‡çš„å¢åŠ ï¼Œä¸šåŠ¡å±‚å¯¹äºå›è°ƒçš„å¤„ç†æ›´åŠ å›°éš¾å’Œä¸å¯æ§ï¼Œåœ¨é‡æ„IMçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå‚è€ƒå­¦ä¹ äº†AFçš„åšæ³•ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹å”¯ä¸€æ ‡è¯†å’Œæ¯ä¸ªè¯·æ±‚åšä¸€ä¸€ç»‘å®šï¼Œå°†è¯·æ±‚çš„ä¸Šä¸‹æ–‡å…³è”èµ·æ¥ï¼Œè¿™æ ·è®©socketé•¿è¿æ¥çš„è¯·æ±‚çš„ä¹Ÿæƒ³httpè¯·æ±‚ä¸€æ ·ï¼Œéƒ½ç”±blockå›å»ï¼Œå¯¹äºä¸šåŠ¡å±‚çš„å¤„ç†ä¹Ÿæ–¹ä¾¿æ›´å¤š</p>
<p><code>setupProgressForTask</code>æ–¹æ³•ä¸»è¦æ˜¯å¯¹taskå’Œprogressè®¾ç½®ç›‘å¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (void)setupProgressForTask:(NSURLSessionTask *)task &#123;</div><div class="line">    __weak __typeof__(task) weakTask = task;</div><div class="line"></div><div class="line">    // è®¾ç½®ä¸Šä¼ å’Œä¸‹è½½çš„å¤§å°</div><div class="line">    </div><div class="line">    // è®¾ç½®ä¸Šä¼ å’Œä¸‹è½½ä¸­å…è®¸å–æ¶ˆå’Œæš‚åœ</div><div class="line">  </div><div class="line">  	// è®¾ç½®ä¸Šä¼ å’Œä¸‹è½½å“åº”æ¢å¤å¤„ç†æ–¹æ³•åæ¢å¤ä¸Šä¼ æˆ–ä¸‹è½½</div><div class="line">    </div><div class="line">    // taskå¯¹æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°ã€æœŸæœ›æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°ã€å‘é€çš„å­—èŠ‚æ•°ã€æœŸæœ›å‘é€çš„å­—èŠ‚æ•°è®¾ç½®ç›‘å¬</div><div class="line">    [task addObserver:self</div><div class="line">           forKeyPath:NSStringFromSelector(@selector(countOfBytesReceived))</div><div class="line">              options:NSKeyValueObservingOptionNew</div><div class="line">              context:NULL];</div><div class="line">    [task addObserver:self</div><div class="line">          forKeyPath:NSStringFromSelector(@selector(countOfBytesExpectedToReceive))</div><div class="line">              options:NSKeyValueObservingOptionNew</div><div class="line">              context:NULL];</div><div class="line"></div><div class="line">    [task addObserver:self</div><div class="line">           forKeyPath:NSStringFromSelector(@selector(countOfBytesSent))</div><div class="line">              options:NSKeyValueObservingOptionNew</div><div class="line">              context:NULL];</div><div class="line">    [task addObserver:self</div><div class="line">           forKeyPath:NSStringFromSelector(@selector(countOfBytesExpectedToSend))</div><div class="line">              options:NSKeyValueObservingOptionNew</div><div class="line">              context:NULL];</div><div class="line">	// ä¸Šä¼ å’Œä¸‹è½½è®¾ç½®å®Œæˆçš„åˆ†æ•°ç›‘å¬</div><div class="line">    [self.downloadProgress addObserver:self</div><div class="line">                            forKeyPath:NSStringFromSelector(@selector(fractionCompleted))</div><div class="line">                               options:NSKeyValueObservingOptionNew</div><div class="line">                               context:NULL];</div><div class="line">    [self.uploadProgress addObserver:self</div><div class="line">                          forKeyPath:NSStringFromSelector(@selector(fractionCompleted))</div><div class="line">                             options:NSKeyValueObservingOptionNew</div><div class="line">                             context:NULL];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSString *,id&gt; *)change context:(void *)context &#123;</div><div class="line">    if ([object isKindOfClass:[NSURLSessionTask class]] || [object isKindOfClass:[NSURLSessionDownloadTask class]]) &#123;</div><div class="line">        // è®¾ç½®ä¸Šä¼ å’Œä¸‹è½½çš„æ–°å€¼</div><div class="line">    &#125;</div><div class="line">    else if ([object isEqual:self.downloadProgress]) &#123;</div><div class="line">        if (self.downloadProgressBlock) &#123;</div><div class="line">            self.downloadProgressBlock(object);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else if ([object isEqual:self.uploadProgress]) &#123;</div><div class="line">        if (self.uploadProgressBlock) &#123;</div><div class="line">            self.uploadProgressBlock(object);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ç¬¬ä¸€ä¸ªifåˆ¤æ–­é‡Œé¢ï¼Œobjectåˆ¤æ–­æ˜¯å¦æ˜¯<code>NSURLSessionTask</code>ç±»æˆ–è€…æ˜¯å¦æ˜¯<code>NSURLSessionDownloadTask</code>ç±»ï¼Œä½†æ˜¯è¿›åˆ°<code>NSURLSessionDownloadTask</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>NSURLSessionDownloadTask</code>æ˜¯<code>NSURLSessionTask</code>çš„å­ç±»ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦åˆ¤æ–­è¿™ä¸ªå‘¢ï¼Ÿ</p>
<p><code>NSURLSessionTask</code>å®é™…ä¸Šæ˜¯<a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/DevPedia-CocoaCore/ClassCluster.html" target="_blank" rel="external">Class cluster</a>ï¼Œé€šè¿‡<code>NSURLSession</code>ç”Ÿæˆçš„taskè¿”å›çš„å¹¶ä¸ä¸€å®šæ˜¯æŒ‡å®šçš„taskç±»å‹ã€‚å› æ­¤kindOfClasså¹¶ä¸æ€»ä¼šç”Ÿæ•ˆï¼Œå…·ä½“å¯ä»¥å‚è§<a href="https://github.com/AFNetworking/AFNetworking/blob/master/AFNetworking/AFURLSessionManager.m#L382~L414" target="_blank" rel="external">AFURLSessionManager.måœ¨loadæ–¹æ³•ä¸­çš„è¯´æ˜</a>ã€‚<br>ç‰¹å®šäºå½“å‰é—®é¢˜ï¼Œæ˜¯ç”±äºiOS 7ä¸Š<strong>NSCFURLSessionDownloadTaskçš„åŸºç±»å¹¶ä¸æ˜¯</strong><code>NSCFURLSessionTask</code>ï¼Œå› æ­¤isKindOfClassä¼šå‡ºé”™ã€‚æŸ¥çœ‹å¯¹åº”çš„<a href="https://github.com/AFNetworking/AFNetworking/commit/a745be4fcd75de75b560dce1d689b6bcc11f42ba#diff-dd81ac1f455a60ac8065ade41f06881f" target="_blank" rel="external">commit</a>å°±å¯ä»¥çŸ¥é“äº†ã€‚</p>
<p>åœ¨<code>NSURLSessionTaskDelegate</code>çš„ä»£ç†é‡Œé¢ï¼Œåªæ˜¯åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œç¬¬ä¸€ä¸ªæ˜¯è·å–æ•°æ®ï¼Œå°†responseSerializerå’ŒdownloadFileURLæˆ–dataå­˜åˆ°userInfoé‡Œé¢ï¼Œç¬¬äºŒä¸ªæ˜¯æ ¹æ®erroræ˜¯å¦ä¸ºç©ºå€¼ï¼Œåšä¸‹ä¸€æ­¥å¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">#pragma mark - NSURLSessionTaskDelegate</div><div class="line"></div><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">    // è·å–æ•°æ®ï¼Œå°†responseSerializerå’ŒdownloadFileURLæˆ–dataå­˜åˆ°userInfoé‡Œé¢</div><div class="line">    __strong AFURLSessionManager *manager = self.manager;</div><div class="line"></div><div class="line">    __block id responseObject = nil;</div><div class="line"></div><div class="line">    __block NSMutableDictionary *userInfo = [NSMutableDictionary dictionary];</div><div class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</div><div class="line"></div><div class="line">    //Performance Improvement from #2672</div><div class="line">    NSData *data = nil;</div><div class="line">    if (self.mutableData) &#123;</div><div class="line">        data = [self.mutableData copy];</div><div class="line">        //We no longer need the reference, so nil it out to gain back some memory.</div><div class="line">        self.mutableData = nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (self.downloadFileURL) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = self.downloadFileURL;</div><div class="line">    &#125; else if (data) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error) &#123;</div><div class="line">      // æœ‰erroræ—¶å¤„ç†</div><div class="line">    &#125; else &#123;</div><div class="line">      // æ— erroræ—¶æ­£å¸¸å¤„ç†</div><div class="line">    &#125;</div><div class="line">#pragma clang diagnostic pop</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æœ‰erroræ—¶ï¼ŒuserInfoå…ˆå­˜å‚¨errorï¼Œç„¶åæ£€æŸ¥manageræ˜¯å¦æœ‰completionGroupå’ŒcompletionQueueï¼Œæ²¡æœ‰çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ªdispatch_group_tå’Œåœ¨ä¸»çº¿ç¨‹ä¸ŠåšcompletionHandlerçš„æ“ä½œï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹ä¸­å‘é€ä¸€ä¸ªAFNetworkingTaskDidCompleteNotificationé€šçŸ¥ï¼Œè¿™ä¸ªé€šçŸ¥åœ¨UIKit+AFNetworkingé‡ŒUIRefreshControl +AFNetworkingé‡Œä¹Ÿä¼šæ¥æ”¶åˆ°ï¼Œç”¨æ¥åœæ­¢åˆ·æ–°ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨AFçš„UIéƒ¨åˆ†ï¼Œä½ å¯ä»¥é€šè¿‡æ¥æ”¶è¿™ä¸ªé€šçŸ¥æ¥åšæ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</div><div class="line"></div><div class="line">dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">            if (self.completionHandler) &#123;</div><div class="line">                self.completionHandler(task.response, responseObject, error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>åœ¨æ²¡æœ‰erroræ—¶ï¼Œä¼šå…ˆå¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡åºåˆ—åŒ–æ“ä½œï¼Œç„¶åä¸‹é¢çš„å¤„ç†å°±å’Œæœ‰errorçš„é‚£éƒ¨åˆ†ä¸€æ ·äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">dispatch_async(url_session_manager_processing_queue(), ^&#123;</div><div class="line">            NSError *serializationError = nil;</div><div class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</div><div class="line"></div><div class="line">            if (self.downloadFileURL) &#123;</div><div class="line">                responseObject = self.downloadFileURL;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (responseObject) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                if (self.completionHandler) &#123;</div><div class="line">                    self.completionHandler(task.response, responseObject, serializationError);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹æˆ‘ä»¬å°±çœ‹åˆ°äº†clangå‘½ä»¤ï¼Œè¿™ä¸ªçš„ä½œç”¨æ˜¯ç”¨æ¥æ¶ˆé™¤ç‰¹å®šåŒºåŸŸçš„clangçš„ç¼–è¯‘è­¦å‘Šï¼Œ-Wgnuåˆ™æ˜¯æ¶ˆé™¤?:è­¦å‘Šï¼Œè¿™ä¸ªæ˜¯clangçš„è­¦å‘Šmessageåˆ—è¡¨<a href="http://fuckingclangwarnings.com/" target="_blank" rel="external">Which Clang Warning Is Generating This Message?</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">#pragma clang diagnostic push</div><div class="line"></div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line"></div><div class="line">// some codes</div><div class="line"></div><div class="line">#pragma clang diagnostic pop</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†ä¸‹é¢ä¸¤ä¸ªåˆ™æ˜¯æ”¶åˆ°æ•°æ®å’Œä¸‹è½½æ–‡ä»¶çš„å›è°ƒå¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">#pragma mark - NSURLSessionDataTaskDelegate</div><div class="line"></div><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">          dataTask:(__unused NSURLSessionDataTask *)dataTask</div><div class="line">    didReceiveData:(NSData *)data</div><div class="line">&#123;</div><div class="line">    [self.mutableData appendData:data];</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - NSURLSessionDownloadTaskDelegate</div><div class="line"></div><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">      downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line">didFinishDownloadingToURL:(NSURL *)location</div><div class="line">&#123;</div><div class="line">    NSError *fileManagerError = nil;</div><div class="line">    self.downloadFileURL = nil;</div><div class="line"></div><div class="line">    if (self.downloadTaskDidFinishDownloading) &#123;</div><div class="line">        self.downloadFileURL = self.downloadTaskDidFinishDownloading(session, downloadTask, location);</div><div class="line">        if (self.downloadFileURL) &#123;</div><div class="line">            [[NSFileManager defaultManager] moveItemAtURL:location toURL:self.downloadFileURL error:&amp;fileManagerError];</div><div class="line"></div><div class="line">            if (fileManagerError) &#123;</div><div class="line">                [[NSNotificationCenter defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:fileManagerError.userInfo];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨åˆšæ‰è¯´åˆ°çš„loadæ–¹æ³•é‡Œé¢ï¼Œå¯¹ç³»ç»Ÿçš„resumeå’Œsuspendæ–¹æ³•è¿›è¡Œäº†æ›¿æ¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">+ (void)swizzleResumeAndSuspendMethodForClass:(Class)theClass &#123;</div><div class="line">    Method afResumeMethod = class_getInstanceMethod(self, @selector(af_resume));</div><div class="line">    Method afSuspendMethod = class_getInstanceMethod(self, @selector(af_suspend));</div><div class="line"></div><div class="line">    if (af_addMethod(theClass, @selector(af_resume), afResumeMethod)) &#123;</div><div class="line">        af_swizzleSelector(theClass, @selector(resume), @selector(af_resume));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (af_addMethod(theClass, @selector(af_suspend), afSuspendMethod)) &#123;</div><div class="line">        af_swizzleSelector(theClass, @selector(suspend), @selector(af_suspend));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ›¿æ¢ä¹‹åï¼Œåªæ˜¯å¢åŠ äº†é€šçŸ¥å¤„ç†è€Œå·²</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)af_resume &#123;</div><div class="line">    NSAssert([self respondsToSelector:@selector(state)], @&quot;Does not respond to state&quot;);</div><div class="line">    NSURLSessionTaskState state = [self state];</div><div class="line">    [self af_resume];</div><div class="line">    </div><div class="line">    if (state != NSURLSessionTaskStateRunning) &#123;</div><div class="line">        [[NSNotificationCenter defaultCenter] postNotificationName:AFNSURLSessionTaskDidResumeNotification object:self];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)af_suspend &#123;</div><div class="line">    NSAssert([self respondsToSelector:@selector(state)], @&quot;Does not respond to state&quot;);</div><div class="line">    NSURLSessionTaskState state = [self state];</div><div class="line">    [self af_suspend];</div><div class="line">    </div><div class="line">    if (state != NSURLSessionTaskStateSuspended) &#123;</div><div class="line">        [[NSNotificationCenter defaultCenter] postNotificationName:AFNSURLSessionTaskDidSuspendNotification object:self];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è°ƒç”¨æ›¿æ¢å’Œå¢åŠ æ–¹æ³•æ—¶å€™ï¼Œç”¨åˆ°äº†å…³é”®å­—inlineï¼Œinlineæ˜¯ä¸ºäº†é˜²æ­¢åæ±‡ç¼–ä¹‹åï¼Œåœ¨ç¬¦å·è¡¨é‡Œé¢çœ‹ä¸åˆ°ä½ æ‰€è°ƒç”¨çš„è¯¥æ–¹æ³•ï¼Œå¦åˆ™åˆ«äººå¯ä»¥é€šè¿‡ç¯¡æ”¹ä½ çš„è¿”å›å€¼æ¥é€ æˆæ”»å‡»ï¼Œ<a href="http://www.blogfshare.com/ioss-static-inline.html" target="_blank" rel="external">iOSå®‰å…¨â€“ä½¿ç”¨static inlineæ–¹å¼ç¼–è¯‘å‡½æ•°ï¼Œé˜²æ­¢é™æ€åˆ†æ</a>ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨swizzlingçš„æ—¶å€™ï¼Œé‚£é™¤äº†ä½¿ç”¨swizzlingåŠ¨æ€æ›¿æ¢å‡½æ•°æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æœ‰åˆ«çš„æ–¹æ³•ä¹ˆï¼Ÿæœ‰ï¼Œä¿®æ”¹IMPæŒ‡é’ˆæŒ‡å‘çš„æ–¹æ³•ï¼Œ<a href="http://www.cocoachina.com/ios/20150717/12623.html" target="_blank" rel="external">è½»æ¾å­¦ä¹ ä¹‹ IMPæŒ‡é’ˆçš„ä½œç”¨ - CocoaChina_è®©ç§»åŠ¨å¼€å‘æ›´ç®€å•</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">static inline void af_swizzleSelector(Class theClass, SEL originalSelector, SEL swizzledSelector) &#123;</div><div class="line">    Method originalMethod = class_getInstanceMethod(theClass, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(theClass, swizzledSelector);</div><div class="line">    method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static inline BOOL af_addMethod(Class theClass, SEL selector, Method method) &#123;</div><div class="line">    return class_addMethod(theClass, selector,  method_getImplementation(method),  method_getTypeEncoding(method));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨+ loadæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆçœ‹åˆ°äº†GCCå‘½ä»¤ï¼Œé‚£clangå’ŒGCCåœ¨ä½¿ç”¨çš„æ—¶æœºæœ‰æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ<a href="http://stackoverflow.com/questions/11838379/should-i-use-pragma-gcc-or-pragma-clang-in-xcode" target="_blank" rel="external">é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨GCCç‰¹æœ‰çš„å¤„ç†æˆ–è€…æ˜¯åœ¨GCCï¼Œclangå’Œå…¶ä»–å…¼å®¹GCCçš„ç¼–è¯‘å™¨æ—¶ï¼Œå°½é‡ä½¿ç”¨<strong>#pragma GCC</strong>ï¼Œclangç‰¹æœ‰çš„å¤„ç†æ—¶ï¼Œä½¿ç”¨<strong>#pragma clang</strong></a>ï¼Œè¿™ä¸ªæ˜¯<a href="https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html" target="_blank" rel="external">GCCçš„messageè¡¨</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">+ (void)load &#123;</div><div class="line">    // ...</div><div class="line">#pragma GCC diagnostic push</div><div class="line">#pragma GCC diagnostic ignored &quot;-Wnonnull&quot;</div><div class="line">        NSURLSessionDataTask *localDataTask = [session dataTaskWithURL:nil];</div><div class="line">#pragma clang diagnostic pop</div><div class="line">    // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>çœ‹å®Œä¹‹åï¼Œæœ‰ä¸ªç–‘é—®ï¼ŒæŸ¥äº†èµ„æ–™ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ï¼š</p>
<p>åœ¨NSURLSessionDelegateçš„<a href="https://github.com/AFNetworking/AFNetworking/blob/master/AFNetworking/AFURLSessionManager.m#L974~L979" target="_blank" rel="external">URLSession:didReceiveChallenge:completionHandler:æ–¹æ³•é‡Œé¢dispositionä¼šå¯¹credentialå¯¹è±¡åšéç©ºåˆ¤æ–­ç„¶åå†èµ‹å€¼æ ¡éªŒç±»å‹</a>ï¼Œä½†æ˜¯NSURLSessionTaskDelegateçš„<a href="https://github.com/AFNetworking/AFNetworking/blob/master/AFNetworking/AFURLSessionManager.m#L1025~L1026" target="_blank" rel="external">-  [URLSession:task:didReceiveChallenge:completionHandler:]æ–¹æ³•é‡Œé¢dispositionå¹¶ä¸å¯¹credentialå¯¹è±¡åšåˆ¤æ–­ï¼Œè€Œæ˜¯ç›´æ¥å°±èµ‹å€¼æ ¡éªŒç±»å‹</a>ï¼Œæœ‰çŸ¥é“çš„ï¼Œæ¬¢è¿ç•™è¨€äº¤æµ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¦–å…ˆæ¥ä»‹ç»ä¸‹AFNetWorkingï¼Œå®˜æ–¹ä»‹ç»å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AFNetworking is a delightful networking library for iOS and Mac OS X. Itâ€™s built on top of the&lt;a href=&quot;http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html&quot;&gt;Foundation URL Loading System&lt;/a&gt;, extending the powerful high-level networking abstractions built into Cocoa. It has a modular architecture with well-designed, feature-rich APIs that are a joy to use.&lt;/p&gt;
&lt;p&gt;Perhaps the most important feature of all, however, is the amazing community of developers who use and contribute to AFNetworking every day. AFNetworking powers some of the most popular and critically-acclaimed apps on the iPhone, iPad, and Mac.&lt;/p&gt;
&lt;p&gt;Choose AFNetworking for your next project, or migrate over your existing projectsâ€”youâ€™ll be happy you did!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç¿»è¯‘è¿‡æ¥ç®€å•æ¥è¯´å°±æ˜¯&lt;/p&gt;
&lt;p&gt;AFNetworkingæ˜¯ä¸€ä¸ªé€‚ç”¨äºiOSå’ŒMac OS Xä¸¤ä¸ªå¹³å°çš„ç½‘ç»œåº“ï¼Œå®ƒæ˜¯åŸºäº&lt;a href=&quot;http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html&quot;&gt;Foundation URL Loading System&lt;/a&gt;ä¸Šè¿›è¡Œäº†ä¸€å¥—å°è£…ï¼Œå¹¶ä¸”æä¾›äº†ä¸°å¯Œä¸”ä¼˜ç¾çš„APIæ¥å£ç»™ä½¿ç”¨è€…ä½¿ç”¨&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetWorking" scheme="http://yuzeyang.github.io/tags/AFNetWorking/"/>
    
  </entry>
  
  <entry>
    <title>iOS ä¸ä»˜è´¹çœ‹å¾®ä¿¡çº¢åŒ…ç…§ç‰‡</title>
    <link href="http://yuzeyang.github.io/2016/01/26/red-packet/"/>
    <id>http://yuzeyang.github.io/2016/01/26/red-packet/</id>
    <published>2016-01-26T15:11:50.000Z</published>
    <updated>2016-05-18T15:26:36.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›¸ä¿¡ä»Šå¤©å¾®ä¿¡çº¢åŒ…ç…§ç‰‡å·²ç»å¸­å·äº†æœ‹å‹åœˆï¼Œå¾®ä¿¡è¿™æ¬¡åˆ›æ„æ˜¯éå¸¸å¥½çš„ï¼Œå¯¹å‘å¸ƒçš„ç…§ç‰‡è¿›è¡Œäº†æ¨¡ç³Šå¤„ç†ï¼Œæ‰“å¼€ä¸€çœ‹ï¼Œæ˜¯è¦å‘çº¢åŒ…æ‰èƒ½çœ‹åˆ°ç…§ç‰‡çš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>è¿™æ€ä¹ˆèƒ½éš¾å€’æˆ‘ä»¬è¿™äº›æŠ€æœ¯ç”·ï¼Œä¸€æ‹›ç ´è§£ï¼</p>
<a id="more"></a>
<p>ç¬¬ä¸€ç§æ–¹æ³•Charles</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/hongbaozhaopian.png!600x600" alt=""></p>
<p>æ¥æˆ‘ä»¬ä¸€èµ·æ¥æŠ“åŒ…çœ‹çœ‹~</p>
<p>é¦–å…ˆè®¾ç½®å¥½è‡ªå·±çš„WiFiçš„httpä»£ç†ï¼Œç»‘å®šå¥½è‡ªå·±çš„Mac ipåœ°å€ï¼Œæ‰“å¼€Charlesï¼Œé€‰æ‹©allow</p>
<p>ç„¶åæ‰“å¼€ä½ çš„å¾®ä¿¡æœ‹å‹åœˆï¼Œä½ åœ¨Charlesé‡Œé¢å¯ä»¥çœ‹åˆ°</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/zhuabaojieguo.jpg!500x500" alt=""></p>
<p>ç„¶ååœ¨overviewçš„URLé‡Œé¢ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°å›¾ç‰‡çš„URLåœ°å€äº†ï¼Œå°†å…¶æ‹·è´å‡ºæ¥ï¼Œæ”¾åˆ°æµè§ˆå™¨é‡Œé¢æ‰“å¼€</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/yuanshitu.png!600x600" alt=""></p>
<p>ok~å°±è¿™ä¹ˆç®€å•~</p>
<hr>
<p><strong>ä¸‹é¢è®²ä¸‹ç¬¬äºŒç§æ–¹æ³•</strong></p>
<p>ç”¨å¦ä¸€ä¸ªiOSå·¥å…·ï¼Œå«åšReplica</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/replica.png!600x600" alt=""></p>
<p>æ‰“å¼€Replicaä¹‹åï¼Œå¯åŠ¨Startï¼Œç„¶åä¼šæ‰“å¼€VPNï¼ŒæŒ‰æ“ä½œä¸€æ­¥ä¸€æ­¥å³å¯</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/replica_start.png!600x600" alt=""></p>
<p>ç„¶åæ‰“å¼€å¾®ä¿¡æœ‹å‹åœˆï¼Œå†è¿”å›åˆ°Replicaï¼Œè¿›åˆ°Analyticsï¼Œç‚¹å‡»æœ€æ–°çš„sessionï¼Œé‡Œé¢ä¼šæœ‰æœ€æ–°çš„POST/GETçš„æ•°æ®</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/post_get_data.png!600x600" alt=""></p>
<p>ç„¶åæ‰¾åˆ°180.163å¼€å¤´çš„GETè¯·æ±‚ï¼Œç‚¹è¿›å»ï¼Œåˆ‡åˆ°Responseï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªGETè¯·æ±‚åˆ°çš„æ•°æ®ç±»å‹æ˜¯imageï¼Œç„¶åæ‰“å¼€Image Viewer</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/180.163.png!600x600" alt=""></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/yuanshitu2.png!600x600" alt=""></p>
<p>ä¹Ÿæ˜¯å¯ä»¥å°†å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥çš„</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ç…§ç‰‡çš„æ¨¡ç³Šå¤„ç†æ˜¯åœ¨æœ¬åœ°åšçš„</p>
<p>å½“ç„¶è¿™ä¸ªæˆ‘ä»¬åªæ˜¯å¨±ä¹ä¸ºä¸»ï¼Œè¿™æ¬¡çš„äº§å“è®¾è®¡è¿˜æ˜¯éå¸¸ä¸é”™çš„ï¼Œç‚¹ä¸ªèµå–”~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›¸ä¿¡ä»Šå¤©å¾®ä¿¡çº¢åŒ…ç…§ç‰‡å·²ç»å¸­å·äº†æœ‹å‹åœˆï¼Œå¾®ä¿¡è¿™æ¬¡åˆ›æ„æ˜¯éå¸¸å¥½çš„ï¼Œå¯¹å‘å¸ƒçš„ç…§ç‰‡è¿›è¡Œäº†æ¨¡ç³Šå¤„ç†ï¼Œæ‰“å¼€ä¸€çœ‹ï¼Œæ˜¯è¦å‘çº¢åŒ…æ‰èƒ½çœ‹åˆ°ç…§ç‰‡çš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;è¿™æ€ä¹ˆèƒ½éš¾å€’æˆ‘ä»¬è¿™äº›æŠ€æœ¯ç”·ï¼Œä¸€æ‹›ç ´è§£ï¼&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ“åŒ…" scheme="http://yuzeyang.github.io/tags/%E6%8A%93%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>iOS ç»™Appæ·»åŠ TouchIDéªŒè¯</title>
    <link href="http://yuzeyang.github.io/2016/01/19/TouchID/"/>
    <id>http://yuzeyang.github.io/2016/01/19/TouchID/</id>
    <published>2016-01-19T14:47:27.000Z</published>
    <updated>2016-05-18T15:04:09.000Z</updated>
    
    <content type="html"><![CDATA[<p>TouchIDéªŒè¯è¿™ä¸ªåœ¨iOS8ä¸­å·²ç»å¯¹å¼€å‘è€…å¼€æ”¾ä½¿ç”¨äº†ï¼Œè€Œä¸”éœ€åœ¨5sä»¥ä¸ŠçœŸæœºæ‰èƒ½ä½¿ç”¨ï¼Œè¿™ä¸ªå‡ºæ¥å·²ç»æ¯”è¾ƒæ—©äº†ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½åº”è¯¥å·²ç»çŸ¥é“æ€ä¹ˆä½¿ç”¨TouchIDäº†ï¼Œä½†æ˜¯å°±ç›®å‰æˆ‘ä½¿ç”¨çš„Appæ¥è¯´ï¼Œçœ‹åˆ°ä½¿ç”¨TouchIDéªŒè¯çš„å å¾—æ•°é‡å¹¶ä¸å¤šï¼Œå¯¹äºä¸€äº›æ¶‰åŠåˆ°å®‰å…¨æ€§çš„Appæ¥è¯´ï¼Œå¾ˆæœ‰å¯èƒ½ä½ çš„è§£é”éªŒè¯ã€Appç™»å½•ä»¥åŠæ”¯ä»˜éªŒè¯éƒ½æ˜¯ç”¨çš„TouchIDä½¿ç”¨TouchIDéªŒè¯è¿˜æ˜¯æœ‰é£é™©çš„ï¼Œä½†æ˜¯æœ‰äº›Appå¢åŠ ä½¿ç”¨TouchIDä½œä¸ºä¸€ç§éªŒè¯è¿˜æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œæ—¢å¿«æ·åˆæ–¹ä¾¿ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´å¢åŠ çš„æˆæœ¬ä¹Ÿå¾ˆä½</p>
<a id="more"></a>
<p>è¿™ä¸ªæ˜¯æˆ‘æ‰€è®²çš„demoçš„æºç <a href="https://github.com/Yuzeyang/TouchIDDemo" target="_blank" rel="external">TouchID demo</a>ï¼Œä»£ç é‡éå¸¸å°‘</p>
<hr>
<p>ä¸‹é¢æˆ‘å°±æ¥ä»‹ç»ä¸‹æ€ä¹ˆç»™Appå¢åŠ TouchIDéªŒè¯å§</p>
<p>é¦–å…ˆï¼Œè¦ä½¿ç”¨TouchIDï¼Œå¾—å…ˆå¼•å…¥LocalAuthentication.frameworkè¿™ä¸ªåº“ï¼Œè¿™é‡Œé¢åªæœ‰å››ä¸ªå¤´æ–‡ä»¶ï¼Œä½†å®é™…ä½¿ç”¨åˆ°çš„åªæœ‰LAContext.hå’ŒLAError.hè¿™ä¸¤ä¸ªå¤´æ–‡ä»¶</p>
<p>åœ¨åšéªŒè¯æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨åˆ°LAContextä¸­çš„ä¸¤ä¸ªæ–¹æ³•</p>
<p>æˆ‘ä»¬å…ˆåˆå§‹åŒ–ä¸€ä¸ªLAContextå¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LAContext *ctx = [[LAContext alloc] init];</div></pre></td></tr></table></figure>
<p>ç„¶åè°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (BOOL)canEvaluatePolicy:(LAPolicy)policy error:(NSError*__autoreleasing*)error;</div></pre></td></tr></table></figure>
<p>æ–¹æ³•æ¥ç¡®å®šå½“å‰æŒ‡å®šçš„éªŒè¯æ–¹æ³•èƒ½å¦ä½¿ç”¨ï¼ŒLAPolicyæ˜¯ä¸ªæšä¸¾ï¼Œé‡Œé¢åªæœ‰ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯LAPolicyDeviceOwnerAuthenticationWithBiometricsï¼ˆä½¿ç”¨è¯¥è®¾å¤‡çš„TouchIDéªŒè¯ï¼‰ï¼ŒLAPolicyDeviceOwnerAuthenticationï¼ˆä½¿ç”¨è¯¥è®¾å¤‡çš„TouchIDå’Œè®¾å¤‡å¯†ç éªŒè¯ï¼‰</p>
<p>è¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œé”™è¯¯å¤„ç†æˆ‘ç­‰ä¸‹ä¸€èµ·è¯´æ˜ï¼Œå½“è¿”å›å¯ä»¥ä½¿ç”¨å½“å‰æŒ‡å®šçš„éªŒè¯æ³•æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)evaluatePolicy:(LAPolicy)policy localizedReason:(NSString*)localizedReason reply:(void(^)(BOOLsuccess,NSError*__nullableerror))reply;</div></pre></td></tr></table></figure>
<p>æ–¹æ³•å¼€å§‹ä½¿ç”¨TouchIDéªŒè¯ï¼ŒlocalizedReasonæŒ‡çš„æ˜¯åœ¨å¼¹å‡ºTouchIDéªŒè¯æ¡†æ—¶æç¤ºçš„æ–‡å­—ï¼ŒreplyæŒ‡çš„æ˜¯åœ¨åšæŒ‡çº¹éªŒè¯æˆ–è€…å¯†ç éªŒè¯åçš„ç»“æœè¿”å›ï¼Œæˆ‘å°†localizedReasonç”¨@â€é€šè¿‡Homeé”®éªŒè¯å·²æœ‰æ‰‹æœºæŒ‡çº¹â€ä½œä¸ºæç¤ºï¼Œä¸‹å›¾æ¯”è¾ƒç›´è§‚</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/TouchID1.png!600x600" alt=""></p>
<p>åˆšæ‰å¸ƒå°”å€¼çš„é”™è¯¯å¯¹åº”çš„æ˜¯å“ªäº›å‘¢ï¼Ÿ</p>
<p>è¿™å°±ç”¨åˆ°äº†LAError.hè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»å®šä¹‰äº†ç›®å‰æ‰€æœ‰çš„éªŒè¯å¤±è´¥çš„é”™è¯¯codeï¼Œæˆ‘ç›´æ¥å°†å®ƒcopyè¿‡æ¥äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">typedefNS_ENUM(NSInteger, LAError)</div><div class="line">&#123;</div><div class="line">	/// æ ¡éªŒå¤±è´¥</div><div class="line">	LAErrorAuthenticationFailed =kLAErrorAuthenticationFailed,</div><div class="line"></div><div class="line">    /// ç”¨æˆ·å–æ¶ˆéªŒè¯</div><div class="line">	LAErrorUserCancel=kLAErrorUserCancel,</div><div class="line"></div><div class="line">	/// ç”¨æˆ·å›é€€ï¼ˆè¿”å›å¯†ç æ ¡éªŒï¼‰</div><div class="line">	LAErrorUserFallback=kLAErrorUserFallback,</div><div class="line"></div><div class="line">	/// ç³»ç»Ÿå–æ¶ˆæ ¡éªŒ</div><div class="line">	LAErrorSystemCancel=kLAErrorSystemCancel,</div><div class="line"></div><div class="line">	/// å¯†ç æœªè®¾ç½®</div><div class="line">	LAErrorPasscodeNotSet=kLAErrorPasscodeNotSet,</div><div class="line"></div><div class="line">	/// æŒ‡çº¹ä¸æ­£ç¡®</div><div class="line">	LAErrorTouchIDNotAvailable=kLAErrorTouchIDNotAvailable,</div><div class="line"></div><div class="line">	/// æ²¡æœ‰å½•å…¥æŒ‡çº¹</div><div class="line">	LAErrorTouchIDNotEnrolled=kLAErrorTouchIDNotEnrolled,</div><div class="line"></div><div class="line">	/// TouchIDè¢«é”å®š</div><div class="line">	LAErrorTouchIDLockoutNS_ENUM_AVAILABLE(10_11,9_0) =kLAErrorTouchIDLockout,</div><div class="line"></div><div class="line">	/// Appå–æ¶ˆéªŒè¯</div><div class="line">	LAErrorAppCancelNS_ENUM_AVAILABLE(10_11,9_0) =kLAErrorAppCancel,</div><div class="line"></div><div class="line">	/// æ— æ•ˆçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</div><div class="line">	LAErrorInvalidContextNS_ENUM_AVAILABLE(10_11,9_0) =kLAErrorInvalidContext</div><div class="line">&#125;NS_ENUM_AVAILABLE(10_10,8_0);</div></pre></td></tr></table></figure>
<p>è€Œå‰å››ç§erroræ˜¯é’ˆå¯¹äºèƒ½ç¡®å®šä½¿ç”¨éªŒè¯åï¼Œåœ¨éªŒè¯åè¿”å›çš„é”™è¯¯</p>
<p>åå…­ç§erroræ˜¯é’ˆå¯¹äºä¸èƒ½ä½¿ç”¨éªŒè¯çš„åŸå› </p>
<p>ä½ å¯ä»¥é’ˆå¯¹è¿™äº›åŸå› åšä¸€äº›ç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚å¼¹çª—ç­‰ç­‰</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;TouchIDéªŒè¯è¿™ä¸ªåœ¨iOS8ä¸­å·²ç»å¯¹å¼€å‘è€…å¼€æ”¾ä½¿ç”¨äº†ï¼Œè€Œä¸”éœ€åœ¨5sä»¥ä¸ŠçœŸæœºæ‰èƒ½ä½¿ç”¨ï¼Œè¿™ä¸ªå‡ºæ¥å·²ç»æ¯”è¾ƒæ—©äº†ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½åº”è¯¥å·²ç»çŸ¥é“æ€ä¹ˆä½¿ç”¨TouchIDäº†ï¼Œä½†æ˜¯å°±ç›®å‰æˆ‘ä½¿ç”¨çš„Appæ¥è¯´ï¼Œçœ‹åˆ°ä½¿ç”¨TouchIDéªŒè¯çš„å å¾—æ•°é‡å¹¶ä¸å¤šï¼Œå¯¹äºä¸€äº›æ¶‰åŠåˆ°å®‰å…¨æ€§çš„Appæ¥è¯´ï¼Œå¾ˆæœ‰å¯èƒ½ä½ çš„è§£é”éªŒè¯ã€Appç™»å½•ä»¥åŠæ”¯ä»˜éªŒè¯éƒ½æ˜¯ç”¨çš„TouchIDä½¿ç”¨TouchIDéªŒè¯è¿˜æ˜¯æœ‰é£é™©çš„ï¼Œä½†æ˜¯æœ‰äº›Appå¢åŠ ä½¿ç”¨TouchIDä½œä¸ºä¸€ç§éªŒè¯è¿˜æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œæ—¢å¿«æ·åˆæ–¹ä¾¿ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´å¢åŠ çš„æˆæœ¬ä¹Ÿå¾ˆä½&lt;/p&gt;
    
    </summary>
    
    
      <category term="TouchID" scheme="http://yuzeyang.github.io/tags/TouchID/"/>
    
  </entry>
  
  <entry>
    <title>iOS åŸºäºGCDAsyncSocketå¿«é€Ÿå¼€å‘Socketé€šä¿¡</title>
    <link href="http://yuzeyang.github.io/2016/01/17/GCDAsyncSocket-socket/"/>
    <id>http://yuzeyang.github.io/2016/01/17/GCDAsyncSocket-socket/</id>
    <published>2016-01-17T14:10:53.000Z</published>
    <updated>2016-08-05T03:31:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>GCDAsyncSocketæ˜¯CocoaAsyncSocketç¬¬ä¸‰æ–¹åº“ä¸­çš„å…¶ä¸­ä¸€ä¸ªç±»ï¼Œæœ¬æ–‡ä»‹ç»çš„å°±æ˜¯åŸºäºè¿™ä¸€ä¸ªç±»æ¥åšå¿«é€Ÿçš„socketé€šä¿¡å¼€å‘ï¼Œè€Œä¸”è¯¥åº“å·²ç»æ”¯æŒIPv4å’ŒIPv6</p>
<p>æˆ‘ä»¬å¯¹GCDAsyncSocketåšäº†ä¸€å±‚å°è£…è°ƒç”¨ï¼Œå®ƒåŒ…å«äº†å»ºè¿ã€æ–­å¼€ã€é‡è¿ã€å¿ƒè·³ã€è‡ªå®šä¹‰è¯·æ±‚</p>
<a id="more"></a>
<hr>
<p>é¦–å…ˆï¼Œä»‹ç»ä¸€ä¸‹CocoaAsyncSocketç¬¬ä¸‰æ–¹åº“çš„ç”¨é€”</p>
<blockquote>
<p>CocoaAsyncSocket provides easy-to-use and powerful asynchronous socket libraries for Mac and iOS. </p>
</blockquote>
<p>ç¿»è¯‘æˆï¼š</p>
<blockquote>
<p>CocoaAsyncSocketä¸ºMacå’ŒiOSæä¾›äº†æ˜“äºä½¿ç”¨ä¸”å¼ºå¤§çš„å¼‚æ­¥é€šä¿¡åº“</p>
</blockquote>
<p>åœ¨Podfileæ–‡ä»¶ä¸­ï¼Œåªè¦åŠ ä¸Šè¿™å¥è¯å°±å¯ä»¥ä½¿ç”¨äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod &apos;CocoaAsyncSocket&apos;, &apos;7.4.1&apos;</div></pre></td></tr></table></figure>
<hr>
<p>ç®€å•çš„Socketé€šä¿¡åŒ…æ‹¬äº†å»ºè¿ã€æ–­å¼€è¿æ¥ã€å‘é€socketä¸šåŠ¡è¯·æ±‚ã€é‡è¿è¿™å››ä¸ªåŸºæœ¬åŠŸèƒ½</p>
<p>ä¸‹é¢ï¼Œæˆ‘å°±æŒ‰ç…§è¿™ä¸ªå››ä¸ªåŸºæœ¬åŠŸèƒ½æ¥è®²ä¸€ä¸‹ï¼Œæ€ä¹ˆæ¥ä½¿ç”¨CocoaAsyncSocketä¸­GCDAsyncSocketè¿™ä¸ªç±»æ¥å¼€å‘Socketé€šä¿¡</p>
<p>é¦–å…ˆï¼ŒSocketåœ¨ç¬¬ä¸€æ­¥æ—¶ï¼Œéœ€è¦å»ºè¿æ‰èƒ½å¼€å§‹é€šä¿¡</p>
<p>åœ¨GCDAsyncSocketä¸­æä¾›äº†å››ç§åˆå§‹åŒ–çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (id)init;</div><div class="line">- (id)initWithSocketQueue:(dispatch_queue_t)sq;</div><div class="line">- (id)initWithDelegate:(id)aDelegate delegateQueue:(dispatch_queue_t)dq;</div><div class="line">- (id)initWithDelegate:(id)aDelegate delegateQueue:(dispatch_queue_t)dq socketQueue:(dispatch_queue_t)sq;</div><div class="line"></div><div class="line">@property (atomic, weak, readwrite) id delegate;</div><div class="line">#if OS_OBJECT_USE_OBJC</div><div class="line">@property (atomic, strong, readwrite) dispatch_queue_t delegateQueue;</div><div class="line">#else</div><div class="line">@property (atomic, assign, readwrite) dispatch_queue_t delegateQueue;</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>sqæ˜¯socketçš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ˜¯å¯é€‰çš„è®¾ç½®ï¼Œå¦‚æœä½ å†™nullï¼ŒGCDAsyncSocketå†…éƒ¨ä¼šå¸®ä½ åˆ›å»ºä¸€ä¸ªå®ƒè‡ªå·±çš„socketçº¿ç¨‹ï¼Œå¦‚æœä½ è¦è‡ªå·±æä¾›ä¸€ä¸ªsocketçº¿ç¨‹çš„è¯ï¼Œåƒä¸‡ä¸è¦æä¾›ä¸€ä¸ªå¹¶å‘çº¿ç¨‹ï¼Œåœ¨é¢‘ç¹socketé€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé˜»å¡æ‰ï¼Œä¸ªäººå»ºè®®æ˜¯ä¸ç”¨åˆ›å»º</p>
<p>aDelegateå°±æ˜¯socketçš„ä»£ç†</p>
<p>dqæ˜¯delegateçš„çº¿ç¨‹</p>
<p>å¿…é¡»è¦éœ€è¦è®¾ç½®socketçš„ä»£ç†ä»¥åŠä»£ç†çš„çº¿ç¨‹ï¼Œå¦åˆ™socketçš„å›è°ƒä½ å‹æ ¹å„¿å°±ä¸çŸ¥é“äº†ï¼Œ</p>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.socket =[[GCDAsyncSocket alloc] initWithDelegate:delegate delegateQueue:dispatch_get_main_queue()];</div></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œåœ¨è®¾ç½®ä»£ç†ä¹‹åï¼Œä½ éœ€è¦å°è¯•è¿æ¥åˆ°ç›¸åº”çš„åœ°å€æ¥ç¡®å®šä½ çš„socketæ˜¯å¦èƒ½è¿é€šäº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (BOOL)connectToHost:(NSString *)host</div><div class="line">               onPort:(uint16_t)port</div><div class="line">          withTimeout:(NSTimeInterval)timeout</div><div class="line">                error:(NSError **)errPtr;</div></pre></td></tr></table></figure>
<p>hostæ˜¯ä¸»æœºåœ°å€ï¼Œportæ˜¯ç«¯å£å·</p>
<p>å¦‚æœå»ºè¿æˆåŠŸä¹‹åï¼Œä¼šæ”¶åˆ°socketæˆåŠŸçš„å›è°ƒï¼Œåœ¨æˆåŠŸé‡Œé¢ä½ å¯ä»¥åšä½ éœ€è¦åšçš„ä¸€äº›äº‹æƒ…ï¼Œæˆ‘è¿™è¾¹çš„è¯ï¼Œæ˜¯åšäº†å¿ƒè·³çš„å¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)socket:(GCDAsyncSocket *)sock didConnectToHost:(NSString *)host port:(uint16_t)port;</div></pre></td></tr></table></figure>
<p>å¦‚æœå»ºè¿å¤±è´¥äº†ï¼Œä¼šæ”¶åˆ°å¤±è´¥çš„å›è°ƒï¼Œæˆ‘è¿™è¾¹åœ¨å¤±è´¥é‡Œé¢åšäº†é‡è¿çš„æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)socketDidDisconnect:(GCDAsyncSocket *)sock withError:(NSError *)err;</div></pre></td></tr></table></figure>
<p>é‡è¿æ“ä½œå…¶å®æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å†è°ƒç”¨ä¸€æ¬¡å»ºè¿è¯·æ±‚ï¼Œæˆ‘è¿™è¾¹è®¾ç½®çš„é‡è¿è§„åˆ™æ˜¯é‡è¿æ¬¡æ•°ä¸º5æ¬¡ï¼Œæ¯æ¬¡çš„æ—¶é—´é—´éš”ä¸º2çš„næ¬¡æ–¹ï¼Œè¶…è¿‡æ¬¡æ•°ä¹‹åï¼Œå°±ä¸å†å»é‡è¿äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (void)socketDidDisconnect:(GCDAsyncSocket*)sock withError:(NSError*)err &#123;</div><div class="line"></div><div class="line">	self.status= -1;</div><div class="line"></div><div class="line">	if(self.reconnection_time&gt;=0 &amp;&amp; self.reconnection_time &lt;= kMaxReconnection_time) &#123;</div><div class="line"></div><div class="line">		[self.timer invalidate];</div><div class="line"></div><div class="line">		self.timer=nil;</div><div class="line"></div><div class="line">		int time =pow(2,self.reconnection_time);</div><div class="line"></div><div class="line">		self.timer= [NSTimer scheduledTimerWithTimeInterval:time target:selfselector:@selector(reconnection) userInfo:nil repeats:NO];</div><div class="line"></div><div class="line">		self.reconnection_time++;</div><div class="line"></div><div class="line">		NSLog(@&quot;socket did reconnection,after %ds try again&quot;,time);</div><div class="line"></div><div class="line">	&#125; else &#123;</div><div class="line"></div><div class="line">		self.reconnection_time=0;</div><div class="line"></div><div class="line">		NSLog(@&quot;socketDidDisconnect:%p withError: %@&quot;, sock, err);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ç”¨statusæ¥æ ‡è®°socketçš„è¿æ¥çŠ¶æ€</p>
<p>é‚£ä¹ˆsocketå·²ç»å»ºè¿äº†ï¼Œè¯¥æ€ä¹ˆå‘èµ·socketé€šä¿¡å‘¢ï¼Ÿ</p>
<p>ä½ éœ€è¦å’Œåç«¯å¼€å‘äººå‘˜å•†å®šå¥½socketåè®®æ ¼å¼ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[NSString stringWithFormat:@&quot;&#123;\&quot;version\&quot;:%d,\&quot;reqType\&quot;:%d,\&quot;body\&quot;:\&quot;%@\&quot;&#125;\r\n&quot;,PROTOCOL_VERSION,reqType,reqBody];</div></pre></td></tr></table></figure>
<p>ä¸­é—´åº”è¯¥å¤§å®¶éƒ½èƒ½çœ‹å¾—æ‡‚ï¼Œé‚£ä¸ºä»€ä¹ˆåé¢éœ€è¦åŠ ä¸Š\r\nå‘¢ï¼Ÿ</p>
<p>è¿™ä¸ª\r\næ˜¯socketæ¶ˆæ¯çš„è¾¹ç•Œç¬¦ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å‘ç”Ÿæ¶ˆæ¯é»è¿ï¼Œæ²¡æœ‰\r\nçš„è¯ï¼Œå¯èƒ½ç”±äºæŸç§åŸå› ï¼Œåç«¯ä¼šæ”¶åˆ°ä¸¤æ¡socketè¯·æ±‚ï¼Œä½†æ˜¯åç«¯ä¸çŸ¥é“æ€ä¹ˆæ‹†åˆ†è¿™ä¸¤ä¸ªè¯·æ±‚</p>
<p>åŒç†ï¼Œåœ¨æ”¶åˆ°socketè¯·æ±‚å›è°ƒæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®è¿™ä¸ªè¾¹ç•Œç¬¦å»æ‹†åˆ†</p>
<p>é‚£ä¸ºä»€ä¹ˆè¦ç”¨\r\nå‘¢ï¼Ÿ</p>
<p>è€Œä¸”GCDAsyncSocketä¸æ”¯æŒè‡ªå®šä¹‰è¾¹ç•Œç¬¦ï¼Œå®ƒæä¾›äº†å››ç§è¾¹ç•Œç¬¦ä¾›ä½ ä½¿ç”¨\r\nã€\rã€\nã€ç©ºå­—ç¬¦ä¸²</p>
<p>åœ¨æ‹¼è£…å¥½socketè¯·æ±‚ä¹‹åï¼Œä½ éœ€è¦è°ƒç”¨GCDAsyncSocketçš„å†™æ–¹æ³•ï¼Œæ¥å‘é€è¯·æ±‚ï¼Œç„¶ååœ¨å†™å®Œæˆä¹‹åä½ ä¼šæ”¶åˆ°å†™çš„å›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.socket writeData:requestData withTimeout:-1 tag:0];</div></pre></td></tr></table></figure>
<p>timeoutæ˜¯è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªæ ¹æ®å®é™…çš„éœ€è¦å»è®¾ç½®</p>
<p>è¿™ä¸ªæ˜¯å†™çš„å›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)socket:(GCDAsyncSocket*)sock didWriteDataWithTag:(long)tagï¼›</div></pre></td></tr></table></figure>
<p>åœ¨å†™ä¹‹åï¼Œéœ€è¦å†è°ƒç”¨è¯»æ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½æ”¶åˆ°ä½ å‘å‡ºè¯·æ±‚åä»æœåŠ¡å™¨é‚£è¾¹æ”¶åˆ°çš„æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.socketreadDataToData:[GCDAsyncSocket CRLFData] withTimeout:10 maxLength:50000 tag:0];</div></pre></td></tr></table></figure>
<p>[GCDAsyncSocket CRLFData]è¿™é‡Œæ˜¯è®¾ç½®è¾¹ç•Œç¬¦ï¼ŒmaxLengthæ˜¯è®¾ç½®ä½ æ”¶åˆ°çš„è¯·æ±‚æ•°æ®å†…å®¹çš„æœ€å¤§å€¼</p>
<p>åœ¨è¯»å›è°ƒé‡Œé¢ï¼Œä½ å¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)socket:(GCDAsyncSocket*)sock didReadData:(NSData*)data withTag:(long)tag;</div></pre></td></tr></table></figure>
<p>æœ€åä¸€ä¸ªåˆ™æ˜¯æ–­å¼€è¿æ¥ï¼Œè¿™ä¸ªåªéœ€è¦è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.socket disconnect];</div></pre></td></tr></table></figure>
<p>okï¼Œè¿™æ ·çš„è¯ï¼Œæœ€ç®€å•åŸºç¡€çš„socketé€šä¿¡ï¼Œä½ å·²ç»å¤§è‡´èƒ½å®Œæˆäº†~</p>
<hr>
<p>2016.4.26æ›´æ–°</p>
<p>åœ¨ç½‘ç»œç¯å¢ƒä»¥åŠå…¶ä»–å› ç´ ä¸‹ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šé€ æˆå®¢æˆ·ç«¯æˆ–è€…åç«¯æ²¡æœ‰æ¥æ”¶åˆ°å›è°ƒæˆ–è€…è¯·æ±‚ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>æˆ‘ä»¬éœ€è¦åŠ ä¸Šæ¶ˆæ¯å›æ‰§çš„å¤„ç†</p>
<p>å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥å°†è¯¥è¯·æ±‚æ”¾åˆ°å­˜åˆ°æ•°ç»„é‡Œé¢ï¼Œç­‰åˆ°åç«¯çš„ç›¸åº”å›è°ƒåœ¨ç§»é™¤æ‰ï¼Œå¦‚æœè¯¥è¯·æ±‚è¶…æ—¶æˆ–è€…åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤è¿”å›ï¼Œè¯´æ˜åç«¯æ²¡æœ‰æ¥æ”¶åˆ°æˆ‘ä»¬çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥è¯·æ±‚é‡æ–°å‘é€</p>
<p>å®¢æˆ·ç«¯æ¥æ”¶è¯·æ±‚çš„æ—¶å€™ï¼Œåç«¯å°†æ•°æ®å‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯éœ€è¦å¢åŠ å›æ‰§å¤„ç†ï¼Œå‘Šè¯‰åç«¯ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°æ•°æ®äº†ï¼Œå¦‚æœåç«¯æ²¡æ¥æ”¶åˆ°ï¼Œä¹Ÿé‡æ–°æ¨ä¸€éæ•°æ®ï¼Œå®¢æˆ·ç«¯å’Œåç«¯åŒå‘ä¿æŠ¤æ¥è§£å†³ä¸¢å¤±é—®é¢˜</p>
<p>2016.8.5æ›´æ–°</p>
<p>æœ‰äº›æ—¶å€™ï¼Œä¸èƒ½å®šä½æ˜¯å¦æ˜¯åç«¯é—®é¢˜è¿˜æ˜¯å®¢æˆ·ç«¯/SDKé—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨å‘½ä»¤è¡ŒæŠ“ä¸€ä¸‹socketåŒ…çœ‹çœ‹ï¼ˆç”¨Charlesåªèƒ½æŠ“httpå’ŒhttpsåŒ…ï¼‰</p>
<p>å‘½ä»¤è¡Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump -i any -n -X port 7070</div></pre></td></tr></table></figure>
<p>Tipï¼š7070ç«¯å£å·è¯·æ ¹æ®å®é™…çš„è°ƒè¯•ç«¯å£å·ä¿®æ”¹</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/socketPacket.png" alt=""></p>
<p>çº¢è‰²éƒ¨åˆ†å°±æ˜¯socketåŒ…çš„å†…å®¹äº†</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;GCDAsyncSocketæ˜¯CocoaAsyncSocketç¬¬ä¸‰æ–¹åº“ä¸­çš„å…¶ä¸­ä¸€ä¸ªç±»ï¼Œæœ¬æ–‡ä»‹ç»çš„å°±æ˜¯åŸºäºè¿™ä¸€ä¸ªç±»æ¥åšå¿«é€Ÿçš„socketé€šä¿¡å¼€å‘ï¼Œè€Œä¸”è¯¥åº“å·²ç»æ”¯æŒIPv4å’ŒIPv6&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬å¯¹GCDAsyncSocketåšäº†ä¸€å±‚å°è£…è°ƒç”¨ï¼Œå®ƒåŒ…å«äº†å»ºè¿ã€æ–­å¼€ã€é‡è¿ã€å¿ƒè·³ã€è‡ªå®šä¹‰è¯·æ±‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="GCDAsyncSocket,Socket" scheme="http://yuzeyang.github.io/tags/GCDAsyncSocket-Socket/"/>
    
  </entry>
  
  <entry>
    <title>é›¶ä¸‹ä¸‰ååº¦çš„å“ˆå°”æ»¨ä¹‹è¡Œ</title>
    <link href="http://yuzeyang.github.io/2016/01/12/Harbin-travel/"/>
    <id>http://yuzeyang.github.io/2016/01/12/Harbin-travel/</id>
    <published>2016-01-12T11:37:10.000Z</published>
    <updated>2016-05-18T15:01:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å¹´å‡è¿‡æœŸä¹‹å‰ï¼Œæˆ‘å’ŒåŒäº‹ä»¬æƒ³ç€ç”¨è¿™ä¸ªå¹´å‡å»å“ªå„¿æµªï¼Œåæ¥å•†é‡ä¹‹åï¼Œå†³å®šå»ä¸€è¶Ÿå“ˆå°”æ»¨çœ‹çœ‹ï¼Œå½“ç„¶å¯¹äºä¸€ç›´ä»æœªæ„Ÿå—è¿‡é›¶ä¸‹ååº¦ä»¥ä¸‹çš„å—æ–¹æ±‰å­ä»¬ï¼Œç‰¹åˆ«æ˜¯ITå®…ç”·ä»¬æ¥è¯´ï¼Œé‚£é‡Œçš„å†·æ˜¯æ ¹æœ¬æƒ³è±¡ä¸åˆ°çš„ã€‚ï¼ˆå¤šå›¾é¢„è­¦ï¼ï¼ï¼ï¼‰</p>
<a id="more"></a>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/afraid.jpg" alt=""></p>
<p>æˆ‘ä»¬å®šåœ¨1æœˆ7æ—¥å‡ºå‘ï¼Œåˆšå¥½å’Œå…ƒæ—¦é”™å¼€äº†ï¼Œä½†æ˜¯æ²¡åŠæ³•ï¼Œå†°é›ªèŠ‚åœ¨å…ƒæ—¦ä¹‹åæ‰å¼€å§‹..å“ï¼Œä¸ç„¶ç©çš„æ—¶é—´å°±æ›´é•¿äº†ã€‚</p>
<p>å‰æœŸçš„å‡†å¤‡è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼</p>
<p><strong>1.å¸½å­-é˜²é£é˜²å¯’</strong></p>
<p><strong>2.å£ç½©-æ£‰/åšï¼ˆæˆ´çœ¼é•œçš„äººæå…¶ç—›è‹¦â€¦æ ¹æœ¬ä¸èƒ½å¸¦å£ç½©ï¼‰</strong></p>
<p><strong>3.å›´å·¾-åš</strong></p>
<p><strong>4.è€³å¥—</strong></p>
<p><strong>5.ä¿æš–å†…è¡£.ç¾Šæ¯›è¡«.æŠ“ç»’å¤–å¥—.ç¾½ç»’æœ è‡³å°‘å››å±‚</strong></p>
<p><strong>6.æ£‰æ¯›è£¤.æ£‰è£¤.å†²é”‹è£¤ è‡³å°‘ç©¿ä¸‰å±‚</strong></p>
<p><strong>7.åšè¢œå­ è‡³å°‘ä¸¤åŒ</strong></p>
<p><strong>8.æ‰‹å¥—</strong></p>
<p><strong>9.æ£‰é‹.é›ªåœ°é´</strong></p>
<p><strong>10.é›ªå¥—ï¼ˆè¿™ä¸ªå¥½åƒæˆ‘å¸¦å»éƒ½æ²¡æœ‰ç”¨åˆ°ï¼‰</strong></p>
<p><strong>11.ä¿æ¸©æ¯</strong></p>
<p><strong>12ã€æš–å®å®ï¼ˆè¿™ä¸ªç”¨åˆ°çš„æ—¶é—´ä¸æ˜¯å¾ˆå¤šï¼Œä¸è¿‡ç«™åœ¨é›ªåœ°çš„æ—¶å€™ï¼Œå¯ä»¥è´´ä¸€ä¸ªåœ¨è„šåº•æŠµæŒ¡ä¸€äº›å¯’å†·ï¼‰</strong></p>
<p>åƒç­‰ä¸‡ç­‰ï¼Œç»ˆäºç­‰åˆ°å‡ºå‘çš„æ—¥å­äº†ï¼Œæˆ‘ä»¬ä¸€è¡Œäººä¹Ÿæ˜¯é«˜é«˜å…´å…´çš„ç²—å‘å•¦ï¼Œåçš„æ˜¯å››å·èˆªç©ºï¼Œç©ºå§å’Œç©ºå°‘éƒ½æœ‰ç‚¹èƒ–èƒ–çš„â€¦å¥½æ¡‘å¿ƒâ€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/INeedAV.jpg" alt=""></p>
<p>ä»æ­å·åˆ°å“ˆå°”æ»¨çš„é£æœºéœ€è¦ä¸‰ä¸ªå°æ—¶å·¦å³çš„è¡Œç¨‹ï¼Œå¿«åˆ°å“ˆå°”æ»¨çš„æ—¶å€™ï¼Œä»é£æœºä¸Šå¾€ä¸‹çœ‹ï¼Œåœ°éƒ½æ˜¯é›ªç™½é›ªç™½çš„ï¼Œè¿™å«å°”ç­‰å—æ–¹æ¥çš„æ±‰å­ä»¬å¾ˆæ˜¯æ¿€åŠ¨å•Šï¼Œç™½èŒ«èŒ«çš„ä¸€ç‰‡~</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/snow.jpeg!600x600" alt="é£æœºä¸Šä¿¯ç°çš„é›ªæ™¯"></p>
<p>é£æœºé™è½ä¹‹åï¼Œæˆ‘ä»¬æ‰“è½¦åˆ°ä¸­å¤®å¤§è¡—ï¼Œåœ¨æ‰“è½¦çš„æ—¶å€™è¦æ³¨æ„ä¸€ç‚¹ï¼Œæœ‰äº›å¸æœºä¼šå‘ä½ æ”¶å–<strong>é«˜é€Ÿè·¯çš„è¿‡è·¯è´¹</strong>ï¼Œå¹¶ä¸”è®©ä½ å–æ¶ˆè®¢å•ï¼Œç”¨ç°é‡‘æ”¯ä»˜ã€‚ç°é‡‘æ”¯ä»˜æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå¬è¯´æœ€è¿‘æŸæ»´å·²ç»å¼€å§‹å‘å¸æœºæ”¶å–å¥½åƒ20%çš„æœåŠ¡è´¹äº†ï¼Œä½†<strong>ä½ åƒä¸‡ä¸è¦ç»™å¸æœºé«˜é€Ÿè·¯çš„è¿‡è·¯è´¹</strong>ï¼Œå› ä¸ºé«˜é€Ÿè·¯çš„è¿‡è·¯è´¹ï¼Œåœ¨ä»å“ˆå°”æ»¨åˆ°æœºåœºçš„è·¯ä¸Šï¼Œæœ‰å…¶ä»–ä¹˜å®¢å·²ç»å¸®ä½ ä»˜äº†ï¼Œè¿™ä¸ªæ˜¯æ²¡æœ‰åŠæ³•çš„ï¼Œä½†æ˜¯è¿”ç¨‹ä»æœºåœºåˆ°å“ˆå°”æ»¨æ˜¯ä¸ç”¨ä»˜çš„ï¼Œè¿™ä¸ªæ˜¯å¸æœºæƒ³å¤šèµšä½ çš„é’±ï¼</p>
<p>åœ¨è¿›è¿‡çš„è·¯ä¸Šï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆè·¯â€¦æœ‰ç”¨å†°ç –æ­çš„ä¸€åº§åŸï¼Œå¾ˆæ˜¯æ¼‚äº®ï¼Œä»æ²¡æœ‰è¿‘è·ç¦»çš„çœ‹è¿‡â€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/snow2.jpeg!600x600" alt="å†°åŸ"></p>
<p>ç»è¿‡å¿«ä¸€ä¸ªå°æ—¶çš„è½¦ç¨‹ï¼ˆè¿˜æ˜¯æœ‰ç‚¹å µçš„ï¼‰ï¼Œåˆ°äº†ä¸­å¤®å¤§è¡—ï¼Œæ®è¯´è¿™ä¸ªä¸€æ¡éå¸¸çƒ­é—¹è€Œä¸”æœ‰åçš„è¡—ï¼ˆå› ä¸ºä¹‹å‰åƒä½å…¨æ˜¯å¦å¤–ä¸€ä¸ªåŒäº‹è®¢å¥½çš„..æ‰€ä»¥æˆ‘éƒ½æ²¡æœ‰æå‰å»äº†è§£..ï¼‰ï¼Œä¸‹äº†é£æœºä¹‹åæ„Ÿè§‰ç¬é—´å˜å†·ï¼Œå¾—èµ¶ç´§å»æ—…é¦†åŠ ä¸Šè¡£æœï¼ŒåŸºæœ¬æŒ‰ç…§ä¸Šé¢å¿…å¤‡çš„é‚£ä¹ˆç©¿å°±ä¸å†·äº†ï¼Œå“ˆå°”æ»¨çš„å¤©æ°”è¡£æœç©¿å¤Ÿäº†ï¼Œèº«ä¸Šä¸å†·ï¼Œä½†æ˜¯é£æ‰“åœ¨è„¸ä¸Šè¿˜æ˜¯å¾ˆå†·çš„ï¼Œæ—¶é—´ä¸€é•¿ï¼Œé¼»å­å°±å—ä¸äº†äº†ã€‚</p>
<p>é€›ä¸­å¤®å¤§è¡—çš„æ—¶å€™ï¼Œé—¨å£å°±æœ‰ä¸ªçƒ¤è‚ ï¼Œéå¸¸å¥½åƒï¼ä½†æ˜¯ä¸è¦ä¹°å¤šâ€¦åƒäº†ä¸€ä¸¤æ ¹ä¹‹åæˆ‘æ„Ÿè§‰å°±æœ‰ç‚¹åƒä¸ä¸‹äº†â€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/xiangchang.jpeg!600x600" alt="çƒ¤è‚ "></p>
<p>åœ¨æ—…é¦†é—¨å£è¿˜æœ‰ä¸€ä¸ªç”¨å†°ç –æ­èµ·æ¥çš„æ»‘æ¢¯ï¼Œè¦æ”¶è´¹ï¼Œ10å…ƒæ»‘ä¸€æ¬¡ï¼Œå› ä¸ºæƒ³åˆ°æ™šä¸Šè¦å»å†°é›ªå¤§ä¸–ç•Œäº†ï¼Œä¹Ÿå°±æ²¡ä¸Šå»ç©äº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/binghuati.jpeg!600x600" alt="å†°æ»‘æ¢¯"></p>
<p>ä¸­å¤®å¤§è¡—ä¸Šé¢æœ‰å¾ˆå¤šéå¸¸æœ‰ç‰¹è‰²åº—ï¼šé©¬è¿­å°”å†°æ£ï¼ˆè¿™ä¸ªå†°æ£ä¹°çš„äººç‰¹åˆ«å¤šï¼‰ï¼Œåæ¢…è¥¿é¤å…ï¼ˆæ®è¯´è¿å“ˆå°”æ»¨äººä¹Ÿéƒ½æ’é˜Ÿè¿˜åƒä¸ä¸Šï¼Œæœ€åä¸€å¤©æˆ‘ä»¬æƒ³å»åƒï¼Œä½†æ˜¯æ’é˜Ÿçš„äººå®åœ¨å¤ªå¤šäº†ï¼Œå°±æ²¡åƒäº†ï¼Œå¥½å¯æƒœï¼‰ï¼Œè€å¨å®¶ï¼ˆè¿™ä¸ªå¾ˆæœ‰å†å²ä¹Ÿå¾ˆå¥½åƒï¼‰ç­‰ç­‰ï¼Œé‚£é‡Œçš„åº—å¤§å¤šéƒ½å¾ˆæœ‰ç‰¹è‰²</p>
<p>æ²¿ç€ä¸­å¤®å¤§è¡—èµ°å°±å¯ä»¥èµ°åˆ°é˜²æ´ªçºªå¿µå¡”ï¼Œåœ¨çºªå¿µå¡”åé¢å°±æ˜¯æ¾èŠ±æ±Ÿï¼Œæ±Ÿé¢å…¨éƒ¨éƒ½ç»“å†°äº†ï¼Œçœ‹å¾—æˆ‘éƒ½å‚»äº†..ä¸Šé¢éƒ½æ˜¯æ¸¸äººåœ¨æ»‘å†°ï¼Œç©è€ï¼Œå†°é¢è¿˜æ˜¯æ¯”è¾ƒæ»‘çš„ï¼Œè¦å°å¿ƒï¼Œé‡Œé¢çš„å¨±ä¹é¡¹ç›®çœ‹æƒ…å†µé€‰æ‹©ç©å§ï¼Œå‡ºæ¥ç©ï¼Œå¼€å¿ƒè¿˜æ˜¯æœ€é‡è¦çš„ï¼ˆæˆ‘ä¸€èˆ¬éƒ½æ˜¯è¿™ä¹ˆæƒ³çš„ï¼Œé£æœºç¥¨ã€åƒä½éƒ½èŠ±äº†è¿™ä¹ˆå¤šäº†ï¼Œä¸å·®è¿™ç‚¹å¨±ä¹çš„é’±äº†â€¦ï¼‰</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/songhuajiang.jpeg!600x600" alt="æ¾èŠ±æ±Ÿ"></p>
<p>æ™šä¸Šå°±å‡ºå‘å»äº†å†°é›ªå¤§ä¸–ç•Œç©ï¼Œåœ¨é‚£é‡Œé‹ä¸€å®šè¦ç©¿æš–ï¼Œå› ä¸ºæœ‰äº›é¡¹ç›®æ˜¯éœ€è¦æ’é˜Ÿçš„ï¼Œç«™é‚£è„šç‰¹åˆ«å†·..è€Œä¸”å¯ä»¥è€ƒè™‘å…ˆå»æ’é˜Ÿç©å¤§æ»‘æ¢¯ï¼Œæ®è¯´å¾ˆåˆºæ¿€ï¼Œä½†æ˜¯å› ä¸ºæ’é˜Ÿçš„äººå¤ªå¤šäº†ï¼Œæˆ‘ä»¬å°±å¾ˆé—æ†¾çš„æ²¡æœ‰å»ç©äº†ï¼Œé‡Œé¢ç©çš„éƒ½æ˜¯æ»‘æ¢¯ï¼Œçœ‹å†°é›•ï¼Œæ„Ÿå—ä¸‹å†°çš„é­…åŠ›ï¼Œå¯¹äºå—æ–¹æ¥çš„æˆ‘ä»¬ç©çš„è¿˜æ˜¯éå¸¸å¼€å¿ƒçš„~ä½†æ˜¯å¾ˆé—æ†¾æˆ‘æ²¡æœ‰æ‰¾åˆ°å†°é›ªå¤§ä¸–ç•Œçš„ç…§ç‰‡ï¼Œä¸è¿‡åŒäº‹é‚£é‡Œæœ‰ï¼Œä¹‹åæˆ‘ä¼šæ›´æ–°ä¸Šæ¥</p>
<p>åœ¨å†°é›ªå¤§ä¸–ç•Œè¿™ä¹ˆç–¯ç‹‚çš„æ¶ˆè€—ä½“åŠ›ä¹‹åï¼Œè‚¯å®šä¼šé¥¿äº†ï¼Œæˆ‘ä»¬ç”¨ç¾å›¢æœåˆ°äº†ä¸€å®¶éå¸¸å¥½åƒçš„çƒ§çƒ¤åº—å«1981çƒ§çƒ¤ï¼ˆå¥½åƒæ˜¯è¿™ä¸ªåå­—ï¼‰ï¼Œä»·æ ¼ä¹Ÿä¸è´µï¼Œçƒ¤çš„éå¸¸å¥½åƒï¼Œä»¥è‡´äºæœ‰ä¸ªåŒäº‹ä¸€è¿ä¸‰å¤©æ‹‰ç€æˆ‘åƒçƒ§çƒ¤ï¼Œåˆ«è¯´ï¼ŒåŒ—æ–¹çš„çƒ§çƒ¤è¿˜çœŸçš„æ¯”å—æ–¹è¦å¥½åƒä¸€ç‚¹ï¼Œå“ˆå“ˆ</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/1981shaokao.jpeg!600x600" alt="1981çƒ§çƒ¤"></p>
<p>ç¬¬äºŒå¤©ï¼Œæˆ‘ä»¬é€‰æ‹©å»äº†é›ªä¹¡ï¼Œå¬è¯´é‚£é‡Œæ˜¯å› ä¸ºæ‹äº†çˆ¸çˆ¸å»å“ªäº†ä¹‹åï¼Œæ‰ç«èµ·æ¥çš„ï¼Œä½†æ˜¯å› ä¸ºå®¢æœçš„åŸå› ï¼ŒæŠŠæˆ‘ä»¬çš„åå•å¼„é”™äº†ï¼Œå¯¼è‡´æ²¡åä¸Šå¤§å·´è½¦ï¼Œç»“æœæäº†è¾†å°é¢åŒ…ï¼Œåé¢çš„äº‹æƒ…å°±æ›´å‡„æƒ¨äº†â€¦é›ªä¹¡çš„è·¯ä¸Šæœ‰ä¸ªå¡ï¼Œè·¯é¢æ»‘ï¼Œæ€ä¹ˆéƒ½ä¸Šä¸å»ï¼Œè£…é˜²æ»‘æ¡ï¼Œæ–­äº†ï¼Œè£…é˜²æ»‘é“¾ï¼Œè£…ä¸ä¸Šâ€¦å•Šâ€¦çœŸçš„æ˜¯æ—¥äº†å¤Ÿäº†ï¼Œæäº†ä¸€ä¸¤ä¸ªå°æ—¶ï¼Œæœ¬æ¥å‡ºå‘æ—¶é—´å°±è€½æäº†ï¼Œè¿™ä¹ˆä¸€æå°±æ›´æ™šäº†ï¼Œç»“æœä¸€è¾†è·¯è¿‡çš„å¤§å·´è½¦æ•‘äº†æˆ‘ä»¬ï¼Œè¾¾åˆ°é›ªä¹¡èŠ±äº†æˆ‘ä»¬12ä¸ªå°æ—¶â€¦é†‰äº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/zhuangfanghualian.jpeg!600x600" alt="è£…é˜²æ»‘é“¾"></p>
<p>ä½†æ˜¯é›ªä¹¡æ²¿é€”çš„é£æ™¯è¿˜æ˜¯å¾ˆæ¼‚äº®çš„ï¼Œåšåšçš„é›ªï¼Œè¿˜æœ‰é›¾å‡‡</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/xuejing.jpeg!600x600" alt="é›ªæ™¯"></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/wusong.jpeg!600x600" alt="é›¾å‡‡"></p>
<p>åˆ°é›ªä¹¡ä¹‹åï¼Œå°±æ˜¯å¤œæ™šäº†ï¼Œè™½ç„¶è¿˜æ˜¯5ç‚¹å¤šé’Ÿï¼Œä½†å¤©é»‘çš„ç‰¹åˆ«æ—©ï¼Œé›ªä¹¡ä¸€è¿›æ¥å°±ç»™äººçš„æ„Ÿè§‰æ˜¯å•†ä¸šåŒ–æ¯”è¾ƒä¸¥é‡ï¼Œå·²ç»å¾ˆéš¾çœ‹å‡ºåŸæ¥çš„é£åœŸäººæƒ…äº†ã€‚é›ªä¹¡é‡Œé¢èƒ½çœ‹åˆ°é›ªæ©‡çŠ¬ï¼Œè¿˜æ˜¯é©¬æ‹‰è½¦ï¼Œè½¦è¿˜æ˜¯æœ‰ç‰Œç…§çš„â€¦</p>
<p>æˆ‘ä»¬å› ä¸ºè·¯é€”çš„åŠ³ç´¯ä¹Ÿæ²¡å‡ºå»é€›ï¼Œé›ªä¹¡ä¹‹è¡Œè¿˜æ˜¯æ„å¤–çš„å¯æƒœï¼Œè‰è‰çš„å°±ç»“æŸäº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/xuexiangyejing.jpeg!600x600" alt="é›ªä¹¡å¤œæ™¯"></p>
<p>æˆ‘ä»¬ä¸€è¡Œäººç¡çš„æ˜¯äº”äººç‚•ï¼Œä½†æ˜¯åæ¥å¬åŒ—æ–¹çš„åŒäº‹è¯´ï¼Œé‚£ä¸ªå¥½åƒæ˜¯ç”µå­ç‚•ï¼Œä¸æ˜¯ç«çƒ§é‚£ç§äº†</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/wurenkang.jpeg!600x600" alt="äº”äººç‚•"></p>
<p>åœ¨é‚£é‡Œæˆ‘ä»¬ä¹°äº†å†°æŸ¿å­ï¼Œå†°è‰è“ï¼Œå†°æ¢¨ï¼Œå‘ç°å¤ªç¡¬äº†å¤ªå†·äº†â€¦åæ¥æ”¾é‚£è½¯äº†å°±æ‰”äº†â€¦åæ¥å¬è¯´é‚£ä¸ªæ˜¯è¦æ”¾å†·æ°´é‡ŒåŒ–å¼€äº†å†åƒçš„â€¦åƒçš„..çš„ï¼Œæˆ‘ä»¬å°±å¿§ä¼¤äº†â€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/bingcaomei.jpeg!600x600" alt="å†°è‰è“"></p>
<p>ç¬¬ä¸‰å¤©æˆ‘ä»¬å°±ä»é›ªä¹¡å‡ºå‘ï¼Œå»å¾€äºšå¸ƒåŠ›æ»‘é›ªï¼Œç¬¬ä¸€æ¬¡æ»‘é›ªçš„æˆ‘æ¥è¯´å¯å…´å¥‹äº†ãƒ¾(oâ—•âˆ€â—•)ï¾‰ãƒ¾ï¼ŒåŒäº‹è¯´å»30Â°å¡çš„æ»‘é›ªåœºï¼Œæˆ‘è¯´å¤ªå¹³äº†æ˜¯ä¸æ˜¯ä¸å¥½ç©ï¼Œæˆ‘è¯´è¦45Â°çš„ï¼Œåæ¥å°‘æ•°æœä»å¤šæ•°ï¼Œæˆ‘ä»¬è¿˜æ˜¯å»äº†30Â°çš„æ»‘é›ªåœºï¼Œåˆ°é‚£é‡Œå­˜å¥½ä¸œè¥¿ä¹‹åï¼Œæœ‰æ¡ä»¶çš„å¯ä»¥è¯·ä¸ªæ•™ç»ƒå¸¦ä¸€å¸¦ä½ ï¼Œæ²¡æœ‰çš„ï¼Œå¯ä»¥è®©ä¼šçš„åŒäº‹å¸¦ä½ ï¼Œä¸ç„¶å°±åƒæˆ‘ä¸€æ ·ï¼Œä»å¡ä¸Šé¢ä¸€ç›´æ‘”åˆ°äº†å¡ä¸‹é¢â€¦.å› ä¸ºä¸æ‡‚æ€ä¹ˆåˆ¹è½¦â€¦å°±ä¸€ç›´æ‘”â€¦å¥½ç–¼â€¦è€Œä¸”ç©¿ç€æ»‘é›ªé‹ï¼Œå®¹æ˜“å´´è„šï¼Œæœ€åæˆ‘å»äº†å„¿ç«¥åŒºï¼Œè¿˜æ˜¯æ‘”/(ã„’oã„’)/~~</p>
<p>å›æ¥çš„æ™šä¸Šæˆ‘ä»¬å¥½å¥½çš„é€›äº†ä¸‹ä¸­å¤®å¤§è¡—ï¼Œåœ¨è€å¨å®¶åƒäº†é¡¿æ”¾ï¼Œå’ŒåŒ—æ–¹çš„åŒäº‹èšäº†ä¸€ä¸‹ï¼Œæ€»ç»“äº†ä¸€ä¸‹åŒ—æ–¹çš„èœæœ‰ç‚¹å’¸ï¼Œä½†æ˜¯é‡ç‰¹è¶³ï¼Œ5ä¸ªäººåŸºæœ¬ç‚¹3ä¸ªèœå°±å·®ä¸å¤šäº†</p>
<p>ä¸­å¤®å¤§è¡—çš„å¤œæ™¯ä¹Ÿéå¸¸æ¼‚äº®ï¼Œè¡—é“ä¸¤æ—éƒ½æœ‰å¤§å‹çš„å†°é›•ï¼Œå“ç‰ŒèµåŠ©â€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/shengdanshu.jpeg!600x600" alt="åœ£è¯æ ‘"></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/beijixiong.jpeg!600x600" alt="åŒ—æç†Šå°å±‹"></p>
<p>æœ€åä¸€å¤©æˆ‘ä»¬å°±å»äº†åœ£ç´¢è²äºšå¤§æ•™å ‚ï¼Œæ®è¯´æ•™å ‚é‡Œé¢æ˜¯æ²¡æœ‰ä»€ä¹ˆå¥½çœ‹çš„ï¼Œéƒ½æ˜¯ä¹°çºªå¿µå“ï¼Œåªè¦å¤–é¢å‚è§‚ä¸‹å°±å¯ä»¥äº†ï¼Œè€Œä¸”æœ‰é¸½å­çš„åŒºåŸŸæ²¡æœ‰æˆ‘æƒ³è±¡ä¸­çš„é‚£ä¹ˆå¤§ï¼Œå°±é‚£ä¸€å°å—åœ°æ–¹â€¦</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/jiaotang.jpeg!600x600" alt="æ•™å ‚æ­£é¢"></p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/gezi.jpeg!600x600" alt="æ•™å ‚æ—çš„é¸½å­"></p>
<p>åŒ†åŒ†çš„å“ˆå°”æ»¨ä¹‹è¡Œå°±æ„‰å¿«çš„ç»“æŸäº†ï¼Œå¥½æœŸå¾…ä¸‹ä¸€æ¬¡çš„æ—…è¡Œ~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å¹´å‡è¿‡æœŸä¹‹å‰ï¼Œæˆ‘å’ŒåŒäº‹ä»¬æƒ³ç€ç”¨è¿™ä¸ªå¹´å‡å»å“ªå„¿æµªï¼Œåæ¥å•†é‡ä¹‹åï¼Œå†³å®šå»ä¸€è¶Ÿå“ˆå°”æ»¨çœ‹çœ‹ï¼Œå½“ç„¶å¯¹äºä¸€ç›´ä»æœªæ„Ÿå—è¿‡é›¶ä¸‹ååº¦ä»¥ä¸‹çš„å—æ–¹æ±‰å­ä»¬ï¼Œç‰¹åˆ«æ˜¯ITå®…ç”·ä»¬æ¥è¯´ï¼Œé‚£é‡Œçš„å†·æ˜¯æ ¹æœ¬æƒ³è±¡ä¸åˆ°çš„ã€‚ï¼ˆå¤šå›¾é¢„è­¦ï¼ï¼ï¼ï¼‰&lt;/p&gt;
    
    </summary>
    
    
      <category term="å“ˆå°”æ»¨" scheme="http://yuzeyang.github.io/tags/%E5%93%88%E5%B0%94%E6%BB%A8/"/>
    
  </entry>
  
  <entry>
    <title>iOS TableViewä¸Šæ‹‰ä¸‹æ‹‰åˆ·æ–°æ§ä»¶ï¼ˆäºŒï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/01/06/iOS_TableView_refresh_controller-two/"/>
    <id>http://yuzeyang.github.io/2016/01/06/iOS_TableView_refresh_controller-two/</id>
    <published>2016-01-06T14:59:44.000Z</published>
    <updated>2016-05-17T15:22:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æˆ‘ä»¬æ¥è®²å¦‚ä½•å°†loadingåœ†åœˆåŠ¨ç”»å’ŒTableViewç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ã€‚</p>
<a id="more"></a>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†loadingåœ†åœˆå’Œæç¤ºlabelåŠ åˆ°ä¸€ä¸ªviewä¸Šå»æ˜¾ç¤ºï¼Œå®ç°çš„ä¸»è¦ç‚¹æœ‰ä¸¤ç‚¹ï¼šç¬¬ä¸€ï¼Œåœ¨ä¸Šæ‹‰æˆ–è€…ä¸‹æ‹‰çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡progresså€¼å»æ§åˆ¶loadingåœ†åœˆçš„åŠ¨ç”»å’Œlabelçš„alphaå€¼ï¼Œç¬¬äºŒï¼Œé€šè¿‡è®¾ç½®æ‹‰åŠ¨çš„æ–¹å‘æ¥è®¾ç½®labelæç¤ºçš„å†…å®¹</p>
<p>ç„¶åï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆå»è·å¾—è¿™ä¸ªprogresså€¼å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦ç›‘å¬æ‰€å…³è”çš„scrollViewçš„contentOffsetå€¼ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.scrollView addObserver:self forKeyPath:@&quot;contentOffset&quot; options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld context:nil];</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨observeValueForKeyPathé‡Œé¢ï¼Œæˆ‘ä»¬è·å–contentOffsetçš„æœ€æ–°å€¼ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CGPoint contentOffset = [[change valueForKey:NSKeyValueChangeNewKey] CGPointValue];</div></pre></td></tr></table></figure>
<p>ç„¶åå†é€šè¿‡è®¡ç®—æ¥æ”¹å˜progresså€¼ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.progress = MAX(0.0, MIN(fabs((self.originOffset + contentOffset.y)/kMaxPullDownDistance), 1.0));</div></pre></td></tr></table></figure>
<p>ï¼ˆæ³¨ï¼šåœ¨è¿™é‡Œæœ‰ä¸ªoriginOffsetå€¼ï¼Œè¿™ä¸ªæ˜¯æˆ‘ç”¨æ¥å¤„ç†æ˜¯å¦æœ‰å¯¼èˆªæ çš„æƒ…å†µï¼Œæœ‰åˆ™è¯¥å€¼ä¸º64.0ï¼Œæ²¡æœ‰åˆ™ä¸º0.0ï¼‰</p>
<p>è®¡ç®—çš„æ€è·¯æ˜¯æˆ‘ä»¬é€šè¿‡æ‰€å…³è”çš„scrollViewçš„contentOffsetä¸æˆ‘ä»¬æ‰€è®¾ç½®çš„æœ€å¤§çš„æ‹‰åŠ¨è·ç¦»å€¼ç›¸é™¤ä½œæ¯”è¾ƒï¼Œå¾—åˆ°çš„å°±æ˜¯æ‹‰åŠ¨çš„ä¸€ä¸ªèŒƒå›´æ¯”ä¾‹ï¼Œå› ä¸ºcontentOffsetä¼šè¶…å‡ºæˆ‘ä»¬è®¾ç½®çš„æœ€å¤§æ‹‰åŠ¨è·ç¦»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†å–æœ€å°æœ€å¤§å€¼ï¼Œæ¥è·å–åˆ°æœ€åçš„progresså€¼ã€‚</p>
<hr>
<p>åœ¨è¿™é‡Œæ’ä¸€ä¸ªå°çš„çŸ¥è¯†ç‚¹ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯åœ¨å†™ä¸Šæ‹‰æ—¶ï¼Œæ‰€å¿…é¡»çŸ¥é“çš„ä¸€ä¸ªç‚¹ï¼ŒcontentOffsetæ˜¯æ€ä¹ˆç®—çš„ï¼Ÿ</p>
<p>contentOffsetæ˜¯scrollviewå½“å‰æ˜¾ç¤ºåŒºåŸŸé¡¶ç‚¹ç›¸å¯¹äºframeé¡¶ç‚¹çš„åç§»é‡</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/contentOffset.png" alt=""></p>
<p>ä½†å½“ä¸Šæ‹‰åˆ·æ–°ä¹‹åï¼Œæ­¤æ—¶scrollviewçš„contentSizeå˜åŒ–äº†ï¼Œï¼ˆcontentSizeæŒ‡çš„æ˜¯å¯æ˜¾ç¤ºåŒºåŸŸï¼‰ï¼Œåœ¨è®¡ç®—contentOffsetæ—¶ï¼Œéœ€è¦å°†contentSizeå‡å»scrollViewçš„é«˜åº¦ï¼Œæ¥å’ŒcontentOffsetä½œæ¯”è¾ƒã€‚</p>
<p>æ‹¿åˆ°progressä¹‹åï¼Œæ­¤æ—¶æˆ‘ä»¬ç¦»å®Œæˆè¿™ä¸ªæ§ä»¶çš„ä»»åŠ¡å°±å·®ä¸å¤šäº†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†progressèµ‹å€¼ç»™loadingåœ†åœˆå’Œæç¤ºlabelï¼Œ</p>
<p>ç„¶åå¦‚æœæˆ‘ä»¬æ‹‰åŠ¨çš„è·ç¦»è¶…è¿‡äº†è®¾ç½®æœ€å¤§å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬åšloadingï¼Œå¹¶ä¸”é€šè¿‡blockè®©å¤–éƒ¨åšä¸€äº›ç½‘ç»œè¯·æ±‚æˆ–è€…å…¶ä»–çš„æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[self startLoading:self.refreshView];</div><div class="line">                </div><div class="line">// 0.3s animation time is the best experience</div><div class="line">[UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">    self.scrollView.contentInset = UIEdgeInsetsMake(kMaxPullDownDistance + self.originOffset, 0, 0, 0);</div><div class="line">&#125; completion:^(BOOL finished) &#123;</div><div class="line">    if (self.refreshingBlock) &#123;</div><div class="line">        self.refreshingBlock();</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šæ‹‰æ—¶ï¼Œæœ‰ä¸€ç‚¹ä¸åŒï¼ŒscrollViewçš„contentSizeå¯èƒ½æ˜¯ä¼šå˜åŒ–çš„ï¼Œè€Œæˆ‘ä»¬çš„æ§ä»¶æ˜¯è¦å§‹ç»ˆæ˜¾ç¤ºåœ¨å®ƒçš„æœ€ä¸‹æ–¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸Šæ‹‰æ—¶ï¼Œéœ€è¦å¯¹contentSizeä¹ŸåŠ ç›‘å¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.scrollView addObserver:self forKeyPath:@&quot;contentSize&quot; options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld context:nil];</div></pre></td></tr></table></figure>
<p>å¹¶ä¸”åœ¨observeValueForKeyPathé‡Œé¢ï¼Œéœ€è¦è®¾ç½®æ§ä»¶çš„centeræ¥æ”¹å˜æˆ‘ä»¬çš„æ˜¾ç¤ºä½ç½®ï¼Œä»¥åŠprogresså€¼ï¼Œå…¶ä»–æ“ä½œéƒ½å’Œä¸‹æ‹‰åˆ·æ–°ä¸€æ ·ã€‚</p>
<p>okï¼Œæˆ‘ä»¬çš„ä¸Šæ‹‰ä¸‹æ‹‰åˆ·æ–°æ§ä»¶å®Œæˆå–½~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æˆ‘ä»¬æ¥è®²å¦‚ä½•å°†loadingåœ†åœˆåŠ¨ç”»å’ŒTableViewç»“åˆèµ·æ¥ä¸€èµ·ä½¿ç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="TableView" scheme="http://yuzeyang.github.io/tags/TableView/"/>
    
  </entry>
  
  <entry>
    <title>iOS TableViewä¸Šæ‹‰ä¸‹æ‹‰åˆ·æ–°æ§ä»¶ï¼ˆä¸€ï¼‰</title>
    <link href="http://yuzeyang.github.io/2016/01/05/iOS_TableView_refresh_controller_one/"/>
    <id>http://yuzeyang.github.io/2016/01/05/iOS_TableView_refresh_controller_one/</id>
    <published>2016-01-05T14:29:07.000Z</published>
    <updated>2016-05-17T15:21:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ³¨ï¼šæ­¤åˆ·æ–°æ§ä»¶çš„æ•ˆæœæ˜¯æ¥è‡ªKittenYangçš„ä¸€ä¸ªGIFå›¾ï¼Œä»–æœ‰å¾ˆå¤šåŠ¨ç”»åˆ†æå’Œå†™å¾—éƒ½ä¸é”™ï¼Œå¤§å®¶å¯ä»¥å…³æ³¨ä¸€ä¸‹~</p>
<p>æ¨èä¸€ä¸ªéå¸¸å¥½çš„åŠ¨ç”»æ•ˆæœç½‘ç«™ï¼š<a href="http://uimovement.com/" target="_blank" rel="external">UI Movement</a>ï¼Œé‡Œé¢å¾ˆå¤šè®¾è®¡å‡ºçš„åŠ¨ç”»æ•ˆæœéƒ½éå¸¸å¥½ï¼Œéƒ½å¯ä»¥ä¸€ä¸€å®ç°çœ‹çœ‹å“¦</p>
<a id="more"></a>
<hr>
<p>è¯ä¸å¤šè¯´ï¼Œå…ˆçœ‹ä¸‹æˆ‘è¦è®²çš„åˆ·æ–°æ§ä»¶æ•ˆæœï¼š</p>
<p>1.æ— å¯¼èˆªæ çš„åˆ·æ–°æ§ä»¶æ•ˆæœå›¾ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/TableRefreshAnimation1.gif" alt=""></p>
<p>2.æœ‰å¯¼èˆªæ çš„åˆ·æ–°æ§ä»¶æ•ˆæœå›¾ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/TableRefreshAnimation2.gif" alt="">            </p>
<hr>
<p>å¥½äº†ï¼Œè¿›å…¥æ­£é¢˜ã€‚</p>
<p>é¦–å…ˆçœ‹åˆ°è¿™ä¸ªæ§ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦å»åˆ†æï¼Œè¿™ä¸ªæ§ä»¶æ˜¯ç”±å“ªå‡ éƒ¨åˆ†ç»„æˆçš„ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ§ä»¶æ˜¯åªæ˜¯ç”±ä¸€ä¸ªloadingåœ†åœˆå’Œlabelæç¤ºæ–‡å­—ç»„æˆçš„ï¼Œè€Œlabelæ¯”è¾ƒç®€å•ï¼Œåœ¨è¿™é‡Œæˆ‘å°±ä¸å…·ä½“è¯´æ€ä¹ˆå®ç°äº†ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥çœ‹æºç ï¼Œè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä¸»è¦è®²æ€ä¹ˆå®ç°è¿™ä¸ªloadingåœ†åœˆçš„è½¬åœˆæ•ˆæœã€‚</p>
<p>é¦–å…ˆè¿™ä¸ªè½¬åœˆåˆ†æˆä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®ƒåˆ†æˆ0.0-0.5å’Œ0.5-1.0è¿™ä¸¤ä¸ªé˜¶æ®µã€‚</p>
<p>åœ¨0.0-0.5è¿™ä¸ªè¿‡ç¨‹çš„åŠ¨ç”»æ˜¯è¿™æ ·çš„ï¼š</p>
<p>â€‹    <img src="http://7xtit4.com1.z0.glb.clouddn.com/refresh0-0.5.gif" alt=""></p>
<p>ä»¥å·¦è¾¹çš„çº¿ä¸ºä¾‹ï¼Œä¸Šé¡¶ç‚¹ä¸ºBç‚¹ï¼Œä¸‹é¡¶ç‚¹ä¸ºAç‚¹ï¼Œå®é™…ä¸Šè¿™ä¸ªè¿‡ç¨‹åªæ˜¯ï¼ŒAï¼ŒBä¸¤ç‚¹çš„yå€¼åœ¨éšç€progressçš„å˜åŒ–è€Œå˜åŒ–ï¼Œxæ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°Aï¼ŒBä¸¤ç‚¹çš„åæ ‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CGPoint leftA = CGPointMake(kCenterX - kLineLength, kCenterY + 2*kLineLength - self.progress/0.5*kLineLength);</div><div class="line">CGPoint leftB = CGPointMake(leftA.x, leftA.y - kLineLength);</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ç”¨è´å¡å°”æ›²çº¿ï¼Œå°†ä¸¤ç‚¹è¿èµ·æ¥ï¼Œä»Aç‚¹åˆ°Bç‚¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[leftPath moveToPoint:leftA];</div><div class="line">[leftPath addLineToPoint:leftB];</div></pre></td></tr></table></figure>
<p>é‚£è¿™ä¸ªå°–è§’æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬åˆ©ç”¨ä»¥å‰å­¦è¿‡çš„æ•°å­¦çŸ¥è¯†ï¼Œå‡è®¾å°–è§’çš„è§’åº¦æ˜¯30Â°ï¼Œé‚£xå€¼å°±æ˜¯leftB.x-kArrowLength<em>sin(kArrowAngle)ï¼Œyå€¼å°±æ˜¯leftB.y+kArrowLength</em>cos(kArrowAngle)ï¼Œå‡è®¾è¿™ä¸ªç‚¹æ˜¯Cç‚¹ï¼Œæœ€åå°±æ˜¯å°†Cç‚¹å’ŒBç‚¹ç›¸è¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[arrowPath moveToPoint:leftB];</div><div class="line">[arrowPath addLineToPoint:CGPointMake(leftB.x - kArrowLength*sin(kArrowAngle), leftB.y + kArrowLength*cos(kArrowAngle))];</div><div class="line">[leftPath appendPath:arrowPath];</div></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†0.0-0.5çš„åŠ¨ç”»ï¼Œè¿™ä¸ªä¸€éƒ¨åˆ†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯0.5-1.0çš„åŠ¨ç”»è¿‡ç¨‹ï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/refresh0.5-1.gif" alt=""></p>
<p>å½“åˆ°è¾¾0.5çš„æ—¶å€™ï¼ŒåŸå…ˆçš„Bç‚¹å¼€å§‹ä¿æŒä¸åŠ¨ï¼Œå®ƒçš„ä½ç½®å§‹ç»ˆæ˜¯CGPointMake(kCenterX-kLineLength,kCenterY)ï¼Œè€ŒAç‚¹ä¹Ÿæ¸æ¸å‘Bç‚¹é è¿‘ï¼ŒCGPointMake(kCenterX-kLineLength,kCenterY+kLineLength- (self.progress-0.5)/0.5*kLineLength)ï¼Œé‚£è¿™ä¸ªåœ†å¼§æ˜¯æ€ä¹ˆå‡ºæ¥çš„ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (void)addArcWithCenter:(CGPoint)center radius:(CGFloat)radius startAngle:(CGFloat)startAngle endAngle:(CGFloat)endAngle clockwise:(BOOL)clockwise NS_AVAILABLE_IOS(4_0);</div></pre></td></tr></table></figure>
<p>åœ¨ç»˜åˆ¶è´å¡å°”æ›²çº¿é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªç»˜åˆ¶åœ†å¼§çš„æ–¹æ³•ï¼Œcenteræ˜¯ä»¥æŸä¸€ä¸ªç‚¹ä¸ºåœ†å¿ƒç»˜åˆ¶åœ†å¼§ï¼Œ</p>
<p>radiusæ˜¯åŠå¾„ï¼ŒstartAngleæ˜¯å¼€å§‹è§’åº¦ï¼ŒendAngleæ˜¯ç»“æŸè§’åº¦ï¼Œclockwiseæ˜¯æ˜¯å¦ä»¥é¡ºæ—¶é’ˆç»˜åˆ¶ï¼Œokï¼Œæˆ‘ä»¬å°±ç”¨è¿™ä¸ªæ¥ç»˜åˆ¶æˆ‘ä»¬çš„åœ†å¼§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[leftPath moveToPoint:leftA];</div><div class="line">[leftPath addLineToPoint:leftB];</div><div class="line">[leftPath addArcWithCenter:CGPointMake(kCenterX, kCenterY) radius:kLineLength startAngle:M_PI endAngle:M_PI+M_PI*(self.progress - 0.5)/0.5*9/10 clockwise:YES];</div></pre></td></tr></table></figure>
<p>æ©ï¼Œåœ†å¼§ä¹Ÿç”»å¥½äº†ï¼Œé‚£æˆ‘ä»¬çš„å°–è§’æ˜¯ä¸æ˜¯ä¹ŸæŒ‰ç…§åˆšæ‰çš„é‚£æ ·å†™å°±å¯ä»¥äº†ï¼Ÿæ©ï¼Œå·®ä¸å¤šå“¦ï¼Œåªæ˜¯æˆ‘ä»¬åœ¨åŸæœ‰å°–è§’30Â°çš„åŸºç¡€ä¸Šï¼Œéœ€è¦åŠ ä¸Šæˆ‘ä»¬åœ†å¼§æ—‹è½¬çš„è§’åº¦ï¼Œæ‰æ˜¯çœŸæ­£å°–è§’ä¸åœ†å¼§é¡¶ç‚¹çš„åˆ‡çº¿è§’åº¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CGPointMake(leftPath.currentPoint.x - kArrowLength*sin(kArrowAngle+M_PI*(self.progress - 0.5)/0.5*9/10),leftPath.currentPoint.y + kArrowLength*cos(kArrowAngle+M_PI*(self.progress - 0.5)/0.5*9/10))</div></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œå°–è§’é¡¶ç‚¹ä¹ŸçŸ¥é“äº†ï¼Œé‚£è¿æ¥åªè¦å’ŒåŸæ¥ä¸€æ ·å°±å¯ä»¥äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[arrowPath moveToPoint:leftPath.currentPoint];</div><div class="line">[arrowPath addLineToPoint:CGPointMake(leftPath.currentPoint.x - kArrowLength*sin(kArrowAngle+M_PI*(self.progress - 0.5)/0.5*9/10),</div><div class="line">                                              leftPath.currentPoint.y + kArrowLength*cos(kArrowAngle+M_PI*(self.progress - 0.5)/0.5*9/10))];</div><div class="line">[leftPath appendPath:arrowPath];</div></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œå·¦è¾¹çš„åŠ¨ç”»æ˜¯è¿™æ ·ï¼Œå³è¾¹çš„åªè¦å¯¹ç§°å³å¯~</p>
<p>æ˜¯ä¸æ˜¯çœ‹ä¸Šå»æ¯”è¾ƒå¤æ‚çš„åŠ¨ç”»ï¼Œå°†å®ƒåˆ†è§£å¼€æ¥ï¼Œå°±å˜å¾—ç®€å•äº†å‘¢ï¼Ÿ</p>
<p>ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä¼šè®²æ€ä¹ˆå°†è¿™ä¸ªåŠ¨ç”»å’Œtableviewç»“åˆèµ·æ¥ä½¿ç”¨~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ³¨ï¼šæ­¤åˆ·æ–°æ§ä»¶çš„æ•ˆæœæ˜¯æ¥è‡ªKittenYangçš„ä¸€ä¸ªGIFå›¾ï¼Œä»–æœ‰å¾ˆå¤šåŠ¨ç”»åˆ†æå’Œå†™å¾—éƒ½ä¸é”™ï¼Œå¤§å®¶å¯ä»¥å…³æ³¨ä¸€ä¸‹~&lt;/p&gt;
&lt;p&gt;æ¨èä¸€ä¸ªéå¸¸å¥½çš„åŠ¨ç”»æ•ˆæœç½‘ç«™ï¼š&lt;a href=&quot;http://uimovement.com/&quot;&gt;UI Movement&lt;/a&gt;ï¼Œé‡Œé¢å¾ˆå¤šè®¾è®¡å‡ºçš„åŠ¨ç”»æ•ˆæœéƒ½éå¸¸å¥½ï¼Œéƒ½å¯ä»¥ä¸€ä¸€å®ç°çœ‹çœ‹å“¦&lt;/p&gt;
    
    </summary>
    
    
      <category term="TableView" scheme="http://yuzeyang.github.io/tags/TableView/"/>
    
  </entry>
  
  <entry>
    <title>TextFieldå­—æ•°é™åˆ¶å¤„ç†</title>
    <link href="http://yuzeyang.github.io/2015/09/17/TextField_count_limit_handle/"/>
    <id>http://yuzeyang.github.io/2015/09/17/TextField_count_limit_handle/</id>
    <published>2015-09-17T14:40:44.000Z</published>
    <updated>2016-05-16T15:23:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç¬¬ä¸‰æ–¹é”®ç›˜åŠ å…¥ä¹‹åï¼Œå¯¹äºå­—æ•°é™åˆ¶çš„å¤„ç†ä¸å†åƒä¹‹å‰é‚£ä¹ˆç®€å•äº†</p>
<a id="more"></a>
<p>çº¯æ•°å­—ã€å­—ç¬¦è¾“å…¥ï¼ˆä¸åŒ…æ‹¬ç²˜è´´ï¼‰è¿™æ ·çš„å­—æ•°é™åˆ¶è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒç®€å•çš„ï¼Œä½ å¯ä»¥ç”¨ä¸¤ç§æ–¹æ³•è¿›è¡Œå¤„ç†</p>
<p>ç¬¬ä¸€ç§æ˜¯<strong>textfieldçš„delegate</strong>å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string &#123;</div><div class="line">    if (range.length + range.location &gt; textField.text.length) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    NSUInteger newLength = textField.text.length + string.length - range.length;</div><div class="line">    return newLength&lt;=kMaxCharacterCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§<strong>æ˜¯æ³¨å†Œä¸€ä¸ªé€šçŸ¥</strong>ï¼Œåœ¨textfieldç¼–è¾‘æ—¶åšå¤„ç†ï¼š</p>
<p>é¦–å…ˆä½ åœ¨viewDidLoadä¸­æ³¨å†Œé€šçŸ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(textFiledEditChanged:) name:UITextFieldTextDidChangeNotification object:self.shopName];</div></pre></td></tr></table></figure>
<p>å†å®ç°é€šçŸ¥é‡Œé¢çš„æ–¹æ³•ï¼Œåœ¨è¶…è¿‡æœ€å¤§å€¼æ—¶ï¼Œå–æœ€å¤§çš„å­—æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (self.shopName.text.length &gt; kMaxCharacterCount) &#123;</div><div class="line">        self.shopName.text = [self.shopName.text substringToIndex:kMaxCharacterCount];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œåœ¨ä¸­æ–‡çš„é™åˆ¶ä¸Šé¢æƒ…å†µå°±å¤æ‚äº†ï¼Œå½“æ—¶åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹é”®ç›˜ï¼Œæ‰€ä»¥å½“æ—¶æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ç³»ç»Ÿé”®ç›˜çš„æ—¶å€™ï¼Œä¸€ä¸‹å­å°±è›‹ç–¼äº†â€¦.</p>
<p>ä¸‹é¢æˆ‘å¼€å§‹åˆ†æä¸€ä¸‹ï¼Œä¸¤è€…çš„åŒºåˆ«ï¼š</p>
<p>1ã€ç¬¬ä¸‰æ–¹é”®ç›˜åœ¨è¾“å…¥å­—ç¬¦æ—¶ï¼Œä¸€èˆ¬æ˜¯ä¸ä¼šå°†å­—ç¬¦ç›´æ¥è¾“å…¥åˆ°textfieldä¸­ï¼Œè€Œæ˜¯å°†å­—ç¬¦æ˜¾ç¤ºåœ¨å®ƒè‡ªå·±çš„viewä¸Šæ–¹ï¼Œä½†æ˜¯ç³»ç»Ÿé”®ç›˜ä¼šç›´æ¥è¾“å…¥åˆ°textfieldä¸­ï¼Œè€Œä¸”å®ƒä¼šå 2ä¸ªå­—ç¬¦é•¿åº¦ï¼Œæ¯”å¦‚ä½ è¾“å…¥â€abcdâ€ï¼Œåœ¨textfieldä¸­æ˜¾ç¤ºçš„æ˜¯â€a b c dâ€ï¼Œå¹¶ä¸”â€a b c dâ€æ˜¯å¤„åœ¨é«˜äº®ä¸­çš„ï¼Œå¹¶ä¸ç®—æ˜¯çœŸæ­£è¾“å…¥åˆ°textfieldä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åº”æŠŠé«˜äº®çš„å­—ç¬¦è®¡ç®—åœ¨å†…ï¼Œæˆ‘ä»¬åº”è¯¥è®¡ç®—çœŸæ­£è¾“å…¥çš„å­—ç¬¦</p>
<p>2ã€å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯delegateåšå¤„ç†çš„æ—¶å€™ï¼Œç³»ç»Ÿä¸­æ–‡è¾“å…¥çš„æ—¶å€™ä¼šæœ‰è”æƒ³ï¼Œä½†æ˜¯è”æƒ³çš„é‚£ä¸ªå­—å¹¶ä¸ä¼šè°ƒç”¨delegateï¼Œæ¯”å¦‚ä½ è¾“å…¥ä¸€ä¸ªâ€ä½ â€ï¼Œåœ¨ç³»ç»Ÿçš„è”æƒ³é‡Œé¢å¯èƒ½ä¼šå‡ºç°â€çš„â€,â€ä»¬â€è¿™æ ·çš„è”æƒ³ï¼Œä½†æ˜¯ä½ é€‰æ‹©â€çš„â€çš„æ—¶å€™ï¼Œdelegateå¹¶ä¸ä¼šè°ƒç”¨ï¼Œï¼ˆå°¼ç›â€¦.ï¼‰ï¼Œæˆ‘çŒœæƒ³è”æƒ³è¾“å…¥åº”è¯¥ä¸ç®—åškeyboardæ‰€è§¦å‘çš„äº‹ä»¶ï¼Œæ‰€ä»¥ä»–å¹¶ä¸ä¼šè§¦å‘delegateï¼Œä½†æ˜¯å¦‚æœä½ æ³¨å†Œçš„æ˜¯é€šçŸ¥ï¼Œä»–å€’æ˜¯ä¼šè°ƒç”¨ï¼Œï¼ˆè¿˜å¥½æœ‰æ•‘ï¼‰</p>
<p>å¦å¤–æé†’ä¸€ä¸‹ï¼Œæœ‰æ—¶å€™åœ¨è‡ªæµ‹è¾“å…¥çš„æ—¶å€™ï¼Œè¦è€ƒè™‘å…¨é¢ï¼Œæ¯”å¦‚ç²˜è´´è¿™ä¹Ÿæ˜¯ä¸€ç§è¾“å…¥ï¼Œå½“æ—¶æ²¡è€ƒè™‘ï¼Œæˆ‘ä¹Ÿæ˜¯è·ªäº†</p>
<p>å¥½äº†ï¼Œåˆ†æäº†ä¸»è¦çš„åŒºåˆ«ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å…·ä½“æ€ä¹ˆå®ç°å§~</p>
<p>åœ¨å®ç°æ³¨å†Œé€šçŸ¥æ–¹æ³•é‡Œé¢ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#pragma mark - UITextViewDelegate</div><div class="line">- (void)textViewDidChange:(UITextView *)textView &#123;</div><div class="line">    if (textView.text.length == 0) &#123;</div><div class="line">        self.recommendTips.hidden = NO;</div><div class="line">    &#125;else&#123;</div><div class="line">        self.recommendTips.hidden = YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSString *toBeString = textView.text;</div><div class="line">    NSString *lang = self.textInputMode.primaryLanguage; // é”®ç›˜è¾“å…¥æ¨¡å¼</div><div class="line">    if ([lang isEqualToString:@&quot;zh-Hans&quot;]) &#123; // ç®€ä½“ä¸­æ–‡è¾“å…¥ï¼ŒåŒ…æ‹¬ç®€ä½“æ‹¼éŸ³ï¼Œå¥ä½“äº”ç¬”ï¼Œç®€ä½“æ‰‹å†™</div><div class="line">        UITextRange *selectedRange = [textView markedTextRange];</div><div class="line">        //è·å–é«˜äº®éƒ¨åˆ†</div><div class="line">        UITextPosition *position = [textView positionFromPosition:selectedRange.start offset:0];</div><div class="line">        // æ²¡æœ‰é«˜äº®é€‰æ‹©çš„å­—ï¼Œåˆ™å¯¹å·²è¾“å…¥çš„æ–‡å­—è¿›è¡Œå­—æ•°ç»Ÿè®¡å’Œé™åˆ¶</div><div class="line">        if (!position || !selectedRange) &#123;</div><div class="line">            if (toBeString.length &gt; 200) &#123;</div><div class="line">                textView.text = [toBeString substringToIndex:200];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        // æœ‰é«˜äº®é€‰æ‹©çš„å­—ç¬¦ä¸²ï¼Œåˆ™æš‚ä¸å¯¹æ–‡å­—è¿›è¡Œç»Ÿè®¡å’Œé™åˆ¶</div><div class="line">        else&#123;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // ä¸­æ–‡è¾“å…¥æ³•ä»¥å¤–çš„ç›´æ¥å¯¹å…¶ç»Ÿè®¡é™åˆ¶å³å¯ï¼Œä¸è€ƒè™‘å…¶ä»–è¯­ç§æƒ…å†µ</div><div class="line">    else&#123;</div><div class="line">        if (toBeString.length &gt; 200) &#123;</div><div class="line">            textView.text = [toBeString substringToIndex:200];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ ¹æ®é”®ç›˜çš„è¾“å…¥æ¨¡å¼è¿›è¡ŒåŒºåˆ†ï¼Œè‹±æ–‡çš„æ¯”è¾ƒç®€å•å°±å’Œä¸Šé¢ä¸€æ ·ï¼Œç›´æ¥å–æœ€å¤§çš„å­—ç¬¦æ•°å°±å¥½äº†ï¼Œåœ¨ä¸­æ–‡è¾“å…¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç”¨markedTextRangeæ–¹æ³•è·å–åˆ°å½“å‰çš„å…‰æ ‡ä½ç½®ï¼Œå†ç”¨textField positionFromPosition:selectedRange.start offset:0è·å–åˆ°é«˜äº®éƒ¨åˆ†ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æœ‰é«˜äº®ï¼Œè¿™ä¸ªæ—¶å€™ç³»ç»Ÿä¼šè°ƒç”¨ä¸¤æ¬¡é€šçŸ¥æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡æ˜¯å°†é«˜äº®çš„å­—ç¬¦è¾“å…¥ï¼Œç¬¬äºŒæ¬¡æ˜¯å°†é«˜äº®çš„å­—ç¬¦è½¬æ¢æˆä¸­æ–‡è¾“å…¥ï¼ˆè¿™ä¸ªæ—¶å€™å°±æ²¡æœ‰é«˜äº®äº†ï¼Œç„¶åå†å–æœ€å¤§çš„å­—ç¬¦æ•°ï¼‰ï¼Œä½†æ˜¯åœ¨iOS7çš„è®¾å¤‡ä¸Šæµ‹è¯•æ—¶å‘ç°ï¼Œpositionéƒ½ä¸ä¼šä¸ºnilï¼Œåœ¨iOS8ä»¥ä¸Šéƒ½æ­£å¸¸ï¼Œä½†æ˜¯è·å–åˆ°å…‰æ ‡çš„rangeï¼Œå´æ˜¯æ­£å¸¸çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NS_CLASS_AVAILABLE_IOS(3_2) @interface UITextRange : NSObject</div><div class="line"></div><div class="line">@property (nonatomic, readonly, getter=isEmpty) BOOL empty;     //  Whether the range is zero-length.</div><div class="line">@property (nonatomic, readonly) UITextPosition *start;</div><div class="line">@property (nonatomic, readonly) UITextPosition *end;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç³»ç»Ÿçš„UITextRangeï¼Œæœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯startï¼Œä¸€ä¸ªæ˜¯endï¼Œè¿™æ­£æ˜¯å¯¹äºçš„é«˜äº®åŒºåŸŸï¼</p>
<p>æ‰€ä»¥æ—¢ç„¶positionä¸èƒ½ä½¿ç”¨ï¼Œé‚£æˆ‘ä»¬å¹²è„†å°±ä½¿ç”¨rangeï¼Œé€šè¿‡åˆ¤æ–­rangeçš„å­˜åœ¨ï¼Œæ¥å¯¹æ–‡å­—è¿›è¡Œé™åˆ¶å¤„ç†ã€‚ï¼ˆç²˜è´´ä¹Ÿé€‚ç”¨ï¼‰</p>
<p>ç»“æœä¹Ÿæ˜¯æ£’æ£’çš„ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ç¬¬ä¸‰æ–¹é”®ç›˜åŠ å…¥ä¹‹åï¼Œå¯¹äºå­—æ•°é™åˆ¶çš„å¤„ç†ä¸å†åƒä¹‹å‰é‚£ä¹ˆç®€å•äº†&lt;/p&gt;
    
    </summary>
    
    
      <category term="TextField" scheme="http://yuzeyang.github.io/tags/TextField/"/>
    
  </entry>
  
</feed>
