<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰ Â· å®«åŸ</title><meta name="description" content="iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰ - å®«åŸ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yuzeyang.github.io/atom.xml" title="å®«åŸ"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰</h1><div class="post-info">2016å¹´5æœˆ25æ—¥</div><div class="post-content"><p><code>AFURLRequestSerialization</code>æ˜¯ç”¨æ¥å¯¹å‘å‡ºçš„è¯·æ±‚è¿›è¡Œä¸€äº›å¤„ç†</p>
<a id="more"></a>
<p><code>AFPercentEscapedStringFromString</code>æ–¹æ³•å°†stringé‡Œé¢çš„:#[]@!$&amp;â€™()*+,;=å­—ç¬¦æ›¿æ¢æˆ%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">NSString * AFPercentEscapedStringFromString(NSString *string) &#123;</span><br><span class="line">  	static NSString * const kAFCharactersGeneralDelimitersToEncode = @&quot;:#[]@&quot;; // does not include &quot;?&quot; or &quot;/&quot; due to RFC 3986 - Section 3.4</span><br><span class="line">    static NSString * const kAFCharactersSubDelimitersToEncode = @&quot;!$&amp;&apos;()*+,;=&quot;;</span><br><span class="line">	</span><br><span class="line">  	// ä»å¯ç”¨å­—ç¬¦æ›¿æ¢åˆ é™¤æ‰:#[]@!$&amp;&apos;()*+,;=è¿™äº›å­—ç¬¦</span><br><span class="line">    NSMutableCharacterSet * allowedCharacterSet = [[NSCharacterSet URLQueryAllowedCharacterSet] mutableCopy];</span><br><span class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</span><br><span class="line"></span><br><span class="line">	// FIXME: https://github.com/AFNetworking/AFNetworking/pull/3028</span><br><span class="line">    // return [string stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</span><br><span class="line">	</span><br><span class="line">  	// å£°æ˜æ‰¹é‡å¤„ç†çš„å¤§å°ä¸º50</span><br><span class="line">    static NSUInteger const batchSize = 50;</span><br><span class="line"></span><br><span class="line">    NSUInteger index = 0;</span><br><span class="line">    NSMutableString *escaped = @&quot;&quot;.mutableCopy;</span><br><span class="line">	</span><br><span class="line">  	// å¾ªç¯å°†stringé‡Œé¢:#[]@!$&amp;&apos;()*+,;=çš„å­—ç¬¦æ›¿æ¢æˆ%</span><br><span class="line">    while (index &lt; string.length) &#123;</span><br><span class="line">#pragma GCC diagnostic push</span><br><span class="line">#pragma GCC diagnostic ignored &quot;-Wgnu&quot;</span><br><span class="line">        NSUInteger length = MIN(string.length - index, batchSize);</span><br><span class="line">#pragma GCC diagnostic pop</span><br><span class="line">        NSRange range = NSMakeRange(index, length);</span><br><span class="line"></span><br><span class="line">        // To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</span><br><span class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</span><br><span class="line"></span><br><span class="line">        NSString *substring = [string substringWithRange:range];</span><br><span class="line">        NSString *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</span><br><span class="line">        [escaped appendString:encoded];</span><br><span class="line"></span><br><span class="line">        index += range.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	return escaped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>AFQueryStringPair</code>ç±»é‡Œé¢æœ‰ä¸ª<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œå°†è¯·æ±‚é‡Œé¢çš„URLå‚æ•°è½¬æˆfield=valueå½¢å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)URLEncodedStringValue &#123;</span><br><span class="line">    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;</span><br><span class="line">        return AFPercentEscapedStringFromString([self.field description]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­—å…¸é‡Œé¢æ˜¯æˆ‘ä»¬æŸ¥è¯¢çš„keyå’Œvalueï¼Œæˆ‘ä»¬é€šè¿‡å°†å­—å…¸å†…å®¹è½¬æˆ<code>AFQueryStringPair</code>å¯¹è±¡ï¼Œè°ƒç”¨<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œè½¬æˆkey=valueï¼Œæ”¾åˆ°mutablePairsæ•°ç»„é‡Œï¼Œæœ€åç”¨&amp;ç¬¦æ‹¼æ¥èµ·æ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSString * AFQueryStringFromParameters(NSDictionary *parameters) &#123;</span><br><span class="line">    NSMutableArray *mutablePairs = [NSMutableArray array];</span><br><span class="line">    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return [mutablePairs componentsJoinedByString:@&quot;&amp;&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) &#123;</span><br><span class="line">    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];</span><br><span class="line"></span><br><span class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@&quot;description&quot; ascending:YES selector:@selector(compare:)];</span><br><span class="line">	</span><br><span class="line">  	// å¦‚æœæ˜¯å­—å…¸ï¼Œéå†åè¿”å›key[nestedKey]=nestedValue</span><br><span class="line">    if ([value isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">        NSDictionary *dictionary = value;</span><br><span class="line">        // Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span><br><span class="line">        for (id nestedKey in [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            id nestedValue = dictionary[nestedKey];</span><br><span class="line">            if (nestedValue) &#123;</span><br><span class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@&quot;%@[%@]&quot;, key, nestedKey] : nestedKey), nestedValue)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†åè¿”å›key[]=nestedValue</span><br><span class="line">  	else if ([value isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">        NSArray *array = value;</span><br><span class="line">        for (id nestedValue in array) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([NSString stringWithFormat:@&quot;%@[]&quot;, key], nestedValue)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; // å¦‚æœæ˜¯é›†åˆï¼Œéå†åè¿”å›key=obj</span><br><span class="line">  	else if ([value isKindOfClass:[NSSet class]]) &#123;</span><br><span class="line">        NSSet *set = value;</span><br><span class="line">        for (id obj in [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; // å…¶ä»–è¿”å›key=value </span><br><span class="line">  	else &#123;</span><br><span class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return mutableQueryStringComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾ä¼ å…¥çš„æ˜¯ï¼Œæˆ‘å°†key,valueæ”¾åˆ°æ•°ç»„é‡Œé¢ï¼Œå†æ”¾åˆ°mutableQueryStringComponentsé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSSet *afSet = [NSSet setWithObjects:@(1),@(2), nil];</span><br><span class="line">NSDictionary *afDic = @&#123;@&quot;dickey&quot;: @&#123;@&quot;nestKey&quot;: @&quot;nestValue&quot;&#125;,</span><br><span class="line">                        @&quot;arrayKey&quot;: @[@[@(1)]],</span><br><span class="line">                        @&quot;setKey&quot;: afSet,</span><br><span class="line">                        @&quot;generalKey&quot;: @&quot;generalValue&quot;&#125;;</span><br><span class="line">NSArray *resultArray = AFQueryStringPairsFromKeyAndValue(nil, afDic);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¾—åˆ°çš„ç»“æœæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[[arrayKey, 1],</span><br><span class="line"> [dickey[nestKey], nestValue],</span><br><span class="line"> [generalKey, generalValue],</span><br><span class="line"> [setKey, 1]ï¼Œ</span><br><span class="line"> [setKey,2]]</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨<code>AFHTTPRequestSerializer</code>å¯¹HTTPè¯·æ±‚çš„å¤´éƒ¨è¿›è¡Œå¤„ç†</p>
<p>é¦–å…ˆè°ƒç”¨<code>+ serializer</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œé‡Œé¢è°ƒç”¨äº†è‡ªå·±initæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)serializer &#123;</span><br><span class="line">    return [[self alloc] init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>inité‡Œé¢å…ˆå°†Accept-Languageå­˜åˆ°mutableHTTPRequestHeadersé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// å°†mainBundleé‡Œé¢æ ¹æ®ä½¿ç”¨è¯­è¨€çš„ä¼˜å…ˆé¡ºåºæ”¾åˆ°acceptLanguagesComponentsé‡Œé¢ï¼Œå†ç”¨&quot;,&quot;åˆ†éš”ï¼Œå­˜åˆ°mutableHTTPRequestHeaderså­—å…¸é‡Œé¢</span><br><span class="line">  	NSMutableArray *acceptLanguagesComponents = [NSMutableArray array];</span><br><span class="line">    [[NSLocale preferredLanguages] enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) &#123;</span><br><span class="line">        float q = 1.0f - (idx * 0.1f);</span><br><span class="line">        [acceptLanguagesComponents addObject:[NSString stringWithFormat:@&quot;%@;q=%0.1g&quot;, obj, q]];</span><br><span class="line">        *stop = q &lt;= 0.5f;</span><br><span class="line">    &#125;];</span><br><span class="line">    [self setValue:[acceptLanguagesComponents componentsJoinedByString:@&quot;, &quot;] forHTTPHeaderField:@&quot;Accept-Language&quot;];</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‹¼æ¥User-Agentï¼Œæ ¼å¼ä¸ºâ€%@/%@ (%@; iOS %@; Scale/%0.2f)â€ï¼Œé‡Œé¢éœ€è¦5ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å…ˆè·å–é¡¹ç›®åï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨BundleIdentifierï¼Œç¬¬äºŒä¸ªå‚æ•°å…ˆè·å–çŸ­ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨ç‰ˆæœ¬å·ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç±»å‹ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç‰ˆæœ¬å·ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯å±å¹•çš„æ¯”ä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NSString *userAgent = nil;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</span><br><span class="line">#if TARGET_OS_IOS</span><br><span class="line">    userAgent = [NSString stringWithFormat:@&quot;%@/%@ (%@; iOS %@; Scale/%0.2f)&quot;, [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleExecutableKey] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleIdentifierKey], [[NSBundle mainBundle] infoDictionary][@&quot;CFBundleShortVersionString&quot;] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleVersionKey], [[UIDevice currentDevice] model], [[UIDevice currentDevice] systemVersion], [[UIScreen mainScreen] scale]];</span><br><span class="line">#elif TARGET_OS_WATCH</span><br><span class="line">    // ... </span><br><span class="line">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</span><br><span class="line">    // ...</span><br><span class="line">#endif</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">if (userAgent) &#123;</span><br><span class="line">        if (![userAgent canBeConvertedToEncoding:NSASCIIStringEncoding]) &#123;</span><br><span class="line">            NSMutableString *mutableUserAgent = [userAgent mutableCopy];</span><br><span class="line">            if (CFStringTransform((__bridge CFMutableStringRef)(mutableUserAgent), NULL, (__bridge CFStringRef)@&quot;Any-Latin; Latin-ASCII; [:^ASCII:] Remove&quot;, false)) &#123;</span><br><span class="line">                userAgent = mutableUserAgent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [self setValue:userAgent forHTTPHeaderField:@&quot;User-Agent&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè®¾ç½®å±æ€§çš„ç›‘å¬ï¼Œè¿™äº›å±æ€§åœ¨å¤´æ–‡ä»¶é‡Œé¢éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œå®ç°æ–‡ä»¶é‡Œé¢ä¹Ÿå®ç°äº†setæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.mutableObservedChangedKeyPaths = [NSMutableSet set];</span><br><span class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        if ([self respondsToSelector:NSSelectorFromString(keyPath)]) &#123;</span><br><span class="line">            [self addObserver:self forKeyPath:keyPath options:NSKeyValueObservingOptionNew context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static NSArray * AFHTTPRequestSerializerObservedKeyPaths() &#123;</span><br><span class="line">    static NSArray *_AFHTTPRequestSerializerObservedKeyPaths = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[NSStringFromSelector(@selector(allowsCellularAccess)), NSStringFromSelector(@selector(cachePolicy)), NSStringFromSelector(@selector(HTTPShouldHandleCookies)), NSStringFromSelector(@selector(HTTPShouldUsePipelining)), NSStringFromSelector(@selector(networkServiceType)), NSStringFromSelector(@selector(timeoutInterval))];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return _AFHTTPRequestSerializerObservedKeyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡KVOåˆ¤æ–­æ˜¯å¦æ˜¯æ–°å€¼ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±åŠ åˆ°mutableObservedChangedKeyPathsé‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath</span><br><span class="line">                      ofObject:(__unused id)object</span><br><span class="line">                        change:(NSDictionary *)change</span><br><span class="line">                       context:(void *)context</span><br><span class="line">&#123;</span><br><span class="line">    if (context == AFHTTPRequestSerializerObserverContext) &#123;</span><br><span class="line">        if ([change[NSKeyValueChangeNewKey] isEqual:[NSNull null]]) &#123;</span><br><span class="line">            [self.mutableObservedChangedKeyPaths removeObject:keyPath];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            [self.mutableObservedChangedKeyPaths addObject:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®éªŒè¯å­—æ®µ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username</span><br><span class="line">                                       password:(NSString *)password</span><br><span class="line">&#123;</span><br><span class="line">    NSData *basicAuthCredentials = [[NSString stringWithFormat:@&quot;%@:%@&quot;, username, password] dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    NSString *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(NSDataBase64EncodingOptions)0];</span><br><span class="line">    [self setValue:[NSString stringWithFormat:@&quot;Basic %@&quot;, base64AuthCredentials] forHTTPHeaderField:@&quot;Authorization&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¹‹åï¼Œéœ€è¦è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)method</span><br><span class="line">                                 URLString:(NSString *)URLString</span><br><span class="line">                                parameters:(id)parameters</span><br><span class="line">                                     error:(NSError *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    // æ–­è¨€                                     </span><br><span class="line">    NSParameterAssert(method);</span><br><span class="line">    NSParameterAssert(URLString);</span><br><span class="line">	</span><br><span class="line">    NSURL *url = [NSURL URLWithString:URLString];</span><br><span class="line"></span><br><span class="line">    NSParameterAssert(url);</span><br><span class="line">	// æ ¹æ®urlåˆå§‹åŒ–request</span><br><span class="line">    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</span><br><span class="line">    // è®¾ç½®HTTPæ–¹æ³•                                   </span><br><span class="line">    mutableRequest.HTTPMethod = method;</span><br><span class="line">	// æ ¹æ®mutableObservedChangedKeyPathså­˜å‚¨çš„å±æ€§ï¼Œè®¾ç½®åˆ°mutableRequest</span><br><span class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	// è°ƒç”¨- [requestBySerializingRequest:withParameters:error]æ–¹æ³•</span><br><span class="line">    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</span><br><span class="line"></span><br><span class="line">	return mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</span><br><span class="line">                               withParameters:(id)parameters</span><br><span class="line">                                        error:(NSError *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    // æ–­è¨€                                      </span><br><span class="line">    NSParameterAssert(request);</span><br><span class="line"></span><br><span class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</span><br><span class="line">    // æ ¹æ®HTTPRequestHeadersæ¥è®¾ç½®mutableRequestçš„å¤´éƒ¨å­—æ®µ</span><br><span class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</span><br><span class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">	</span><br><span class="line">    NSString *query = nil;</span><br><span class="line">    if (parameters) &#123;</span><br><span class="line">        if (self.queryStringSerialization) &#123;</span><br><span class="line">          	// å¦‚æœè®¾ç½®äº†queryStringSerializationè¿™ä¸ªblockçš„è¯ï¼Œå°±éœ€è¦è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„æŸ¥è¯¢è¯­å¥åºåˆ—åŒ–æ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</span><br><span class="line">            NSError *serializationError;</span><br><span class="line">            query = self.queryStringSerialization(request, parameters, &amp;serializationError);</span><br><span class="line"></span><br><span class="line">            if (serializationError) &#123;</span><br><span class="line">                if (error) &#123;</span><br><span class="line">                    *error = serializationError;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return nil;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          	// å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™è°ƒç”¨AFQueryStringFromParametersæ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</span><br><span class="line">            switch (self.queryStringSerializationStyle) &#123;</span><br><span class="line">                case AFHTTPRequestQueryStringDefaultStyle:</span><br><span class="line">                    query = AFQueryStringFromParameters(parameters);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    // å°†æ‹¼æ¥å¥½çš„queryè¯­å¥æ”¾åˆ° mutableRequest.URLæˆ–è€…æ”¾åˆ°                                    mutableRequestçš„HTTPBodyé‡Œ</span><br><span class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        if (query) &#123;</span><br><span class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // #2864: an empty string is a valid x-www-form-urlencoded payload</span><br><span class="line">        if (!query) &#123;</span><br><span class="line">            query = @&quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</span><br><span class="line">            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line">        &#125;</span><br><span class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„è¯ï¼ŒåŸºæœ¬éƒ½æ˜¯å¯¹å¤šéƒ¨åˆ†æ•°æ®è¿›è¡Œç»„è£…</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/05/27/AFNetWorking-six/" class="prev">ä¸Šä¸€ç¯‡</a><a href="/2016/05/23/AFNetWorking-four/" class="next">ä¸‹ä¸€ç¯‡</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2016/05/25/AFNetWorking-five/';
var disqus_title = 'iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰';
var disqus_url = 'http://yuzeyang.github.io/2016/05/25/AFNetWorking-five/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2015 - 2018 <a href="http://yuzeyang.github.io">å®«åŸ</a>, Talk is cheap, show me the code. <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>