<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰ Â· å®«åŸ</title><meta name="description" content="iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰ - å®«åŸ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰</h1><div class="post-info">May 25, 2016</div><div class="post-content"><p><code>AFURLRequestSerialization</code>æ˜¯ç”¨æ¥å¯¹å‘å‡ºçš„è¯·æ±‚è¿›è¡Œä¸€äº›å¤„ç†</p>
<a id="more"></a>
<p><code>AFPercentEscapedStringFromString</code>æ–¹æ³•å°†stringé‡Œé¢çš„:#[]@!$&amp;â€™()*+,;=å­—ç¬¦æ›¿æ¢æˆ%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">NSString * AFPercentEscapedStringFromString(NSString *string) &#123;</div><div class="line">  	static NSString * const kAFCharactersGeneralDelimitersToEncode = @&quot;:#[]@&quot;; // does not include &quot;?&quot; or &quot;/&quot; due to RFC 3986 - Section 3.4</div><div class="line">    static NSString * const kAFCharactersSubDelimitersToEncode = @&quot;!$&amp;&apos;()*+,;=&quot;;</div><div class="line">	</div><div class="line">  	// ä»å¯ç”¨å­—ç¬¦æ›¿æ¢åˆ é™¤æ‰:#[]@!$&amp;&apos;()*+,;=è¿™äº›å­—ç¬¦</div><div class="line">    NSMutableCharacterSet * allowedCharacterSet = [[NSCharacterSet URLQueryAllowedCharacterSet] mutableCopy];</div><div class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</div><div class="line"></div><div class="line">	// FIXME: https://github.com/AFNetworking/AFNetworking/pull/3028</div><div class="line">    // return [string stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">	</div><div class="line">  	// å£°æ˜æ‰¹é‡å¤„ç†çš„å¤§å°ä¸º50</div><div class="line">    static NSUInteger const batchSize = 50;</div><div class="line"></div><div class="line">    NSUInteger index = 0;</div><div class="line">    NSMutableString *escaped = @&quot;&quot;.mutableCopy;</div><div class="line">	</div><div class="line">  	// å¾ªç¯å°†stringé‡Œé¢:#[]@!$&amp;&apos;()*+,;=çš„å­—ç¬¦æ›¿æ¢æˆ%</div><div class="line">    while (index &lt; string.length) &#123;</div><div class="line">#pragma GCC diagnostic push</div><div class="line">#pragma GCC diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">        NSUInteger length = MIN(string.length - index, batchSize);</div><div class="line">#pragma GCC diagnostic pop</div><div class="line">        NSRange range = NSMakeRange(index, length);</div><div class="line"></div><div class="line">        // To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</div><div class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</div><div class="line"></div><div class="line">        NSString *substring = [string substringWithRange:range];</div><div class="line">        NSString *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">        [escaped appendString:encoded];</div><div class="line"></div><div class="line">        index += range.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	return escaped;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>AFQueryStringPair</code>ç±»é‡Œé¢æœ‰ä¸ª<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œå°†è¯·æ±‚é‡Œé¢çš„URLå‚æ•°è½¬æˆfield=valueå½¢å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (NSString *)URLEncodedStringValue &#123;</div><div class="line">    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;</div><div class="line">        return AFPercentEscapedStringFromString([self.field description]);</div><div class="line">    &#125; else &#123;</div><div class="line">        return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å­—å…¸é‡Œé¢æ˜¯æˆ‘ä»¬æŸ¥è¯¢çš„keyå’Œvalueï¼Œæˆ‘ä»¬é€šè¿‡å°†å­—å…¸å†…å®¹è½¬æˆ<code>AFQueryStringPair</code>å¯¹è±¡ï¼Œè°ƒç”¨<code>- URLEncodedStringValue</code>æ–¹æ³•ï¼Œè½¬æˆkey=valueï¼Œæ”¾åˆ°mutablePairsæ•°ç»„é‡Œï¼Œæœ€åç”¨&amp;ç¬¦æ‹¼æ¥èµ·æ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSString * AFQueryStringFromParameters(NSDictionary *parameters) &#123;</div><div class="line">    NSMutableArray *mutablePairs = [NSMutableArray array];</div><div class="line">    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</div><div class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [mutablePairs componentsJoinedByString:@&quot;&amp;&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) &#123;</div><div class="line">    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];</div><div class="line"></div><div class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@&quot;description&quot; ascending:YES selector:@selector(compare:)];</div><div class="line">	</div><div class="line">  	// å¦‚æœæ˜¯å­—å…¸ï¼Œéå†åè¿”å›key[nestedKey]=nestedValue</div><div class="line">    if ([value isKindOfClass:[NSDictionary class]]) &#123;</div><div class="line">        NSDictionary *dictionary = value;</div><div class="line">        // Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</div><div class="line">        for (id nestedKey in [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            id nestedValue = dictionary[nestedKey];</div><div class="line">            if (nestedValue) &#123;</div><div class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@&quot;%@[%@]&quot;, key, nestedKey] : nestedKey), nestedValue)];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†åè¿”å›key[]=nestedValue</div><div class="line">  	else if ([value isKindOfClass:[NSArray class]]) &#123;</div><div class="line">        NSArray *array = value;</div><div class="line">        for (id nestedValue in array) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([NSString stringWithFormat:@&quot;%@[]&quot;, key], nestedValue)];</div><div class="line">        &#125;</div><div class="line">    &#125; // å¦‚æœæ˜¯é›†åˆï¼Œéå†åè¿”å›key=obj</div><div class="line">  	else if ([value isKindOfClass:[NSSet class]]) &#123;</div><div class="line">        NSSet *set = value;</div><div class="line">        for (id obj in [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</div><div class="line">        &#125;</div><div class="line">    &#125; // å…¶ä»–è¿”å›key=value </div><div class="line">  	else &#123;</div><div class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableQueryStringComponents;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‡è®¾ä¼ å…¥çš„æ˜¯ï¼Œæˆ‘å°†key,valueæ”¾åˆ°æ•°ç»„é‡Œé¢ï¼Œå†æ”¾åˆ°mutableQueryStringComponentsé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSSet *afSet = [NSSet setWithObjects:@(1),@(2), nil];</div><div class="line">NSDictionary *afDic = @&#123;@&quot;dickey&quot;: @&#123;@&quot;nestKey&quot;: @&quot;nestValue&quot;&#125;,</div><div class="line">                        @&quot;arrayKey&quot;: @[@[@(1)]],</div><div class="line">                        @&quot;setKey&quot;: afSet,</div><div class="line">                        @&quot;generalKey&quot;: @&quot;generalValue&quot;&#125;;</div><div class="line">NSArray *resultArray = AFQueryStringPairsFromKeyAndValue(nil, afDic);</div></pre></td></tr></table></figure>
<p>æ‰“å°å¾—åˆ°çš„ç»“æœæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[arrayKey, 1],</div><div class="line"> [dickey[nestKey], nestValue],</div><div class="line"> [generalKey, generalValue],</div><div class="line"> [setKey, 1]ï¼Œ</div><div class="line"> [setKey,2]]</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨<code>AFHTTPRequestSerializer</code>å¯¹HTTPè¯·æ±‚çš„å¤´éƒ¨è¿›è¡Œå¤„ç†</p>
<p>é¦–å…ˆè°ƒç”¨<code>+ serializer</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œé‡Œé¢è°ƒç”¨äº†è‡ªå·±initæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)serializer &#123;</div><div class="line">    return [[self alloc] init];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>inité‡Œé¢å…ˆå°†Accept-Languageå­˜åˆ°mutableHTTPRequestHeadersé‡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// å°†mainBundleé‡Œé¢æ ¹æ®ä½¿ç”¨è¯­è¨€çš„ä¼˜å…ˆé¡ºåºæ”¾åˆ°acceptLanguagesComponentsé‡Œé¢ï¼Œå†ç”¨&quot;,&quot;åˆ†éš”ï¼Œå­˜åˆ°mutableHTTPRequestHeaderså­—å…¸é‡Œé¢</div><div class="line">  	NSMutableArray *acceptLanguagesComponents = [NSMutableArray array];</div><div class="line">    [[NSLocale preferredLanguages] enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) &#123;</div><div class="line">        float q = 1.0f - (idx * 0.1f);</div><div class="line">        [acceptLanguagesComponents addObject:[NSString stringWithFormat:@&quot;%@;q=%0.1g&quot;, obj, q]];</div><div class="line">        *stop = q &lt;= 0.5f;</div><div class="line">    &#125;];</div><div class="line">    [self setValue:[acceptLanguagesComponents componentsJoinedByString:@&quot;, &quot;] forHTTPHeaderField:@&quot;Accept-Language&quot;];</div></pre></td></tr></table></figure>
<p>ç„¶åæ‹¼æ¥User-Agentï¼Œæ ¼å¼ä¸ºâ€%@/%@ (%@; iOS %@; Scale/%0.2f)â€ï¼Œé‡Œé¢éœ€è¦5ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å…ˆè·å–é¡¹ç›®åï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨BundleIdentifierï¼Œç¬¬äºŒä¸ªå‚æ•°å…ˆè·å–çŸ­ç‰ˆæœ¬å·ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨ç‰ˆæœ¬å·ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç±»å‹ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å½“å‰è®¾å¤‡çš„ç‰ˆæœ¬å·ï¼Œç¬¬äº”ä¸ªå‚æ•°æ˜¯å±å¹•çš„æ¯”ä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NSString *userAgent = nil;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">#if TARGET_OS_IOS</div><div class="line">    userAgent = [NSString stringWithFormat:@&quot;%@/%@ (%@; iOS %@; Scale/%0.2f)&quot;, [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleExecutableKey] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleIdentifierKey], [[NSBundle mainBundle] infoDictionary][@&quot;CFBundleShortVersionString&quot;] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleVersionKey], [[UIDevice currentDevice] model], [[UIDevice currentDevice] systemVersion], [[UIScreen mainScreen] scale]];</div><div class="line">#elif TARGET_OS_WATCH</div><div class="line">    // ... </div><div class="line">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</div><div class="line">    // ...</div><div class="line">#endif</div><div class="line">#pragma clang diagnostic pop</div><div class="line">if (userAgent) &#123;</div><div class="line">        if (![userAgent canBeConvertedToEncoding:NSASCIIStringEncoding]) &#123;</div><div class="line">            NSMutableString *mutableUserAgent = [userAgent mutableCopy];</div><div class="line">            if (CFStringTransform((__bridge CFMutableStringRef)(mutableUserAgent), NULL, (__bridge CFStringRef)@&quot;Any-Latin; Latin-ASCII; [:^ASCII:] Remove&quot;, false)) &#123;</div><div class="line">                userAgent = mutableUserAgent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        [self setValue:userAgent forHTTPHeaderField:@&quot;User-Agent&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åè®¾ç½®å±æ€§çš„ç›‘å¬ï¼Œè¿™äº›å±æ€§åœ¨å¤´æ–‡ä»¶é‡Œé¢éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œå®ç°æ–‡ä»¶é‡Œé¢ä¹Ÿå®ç°äº†setæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">self.mutableObservedChangedKeyPaths = [NSMutableSet set];</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self respondsToSelector:NSSelectorFromString(keyPath)]) &#123;</div><div class="line">            [self addObserver:self forKeyPath:keyPath options:NSKeyValueObservingOptionNew context:AFHTTPRequestSerializerObserverContext];</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">static NSArray * AFHTTPRequestSerializerObservedKeyPaths() &#123;</div><div class="line">    static NSArray *_AFHTTPRequestSerializerObservedKeyPaths = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[NSStringFromSelector(@selector(allowsCellularAccess)), NSStringFromSelector(@selector(cachePolicy)), NSStringFromSelector(@selector(HTTPShouldHandleCookies)), NSStringFromSelector(@selector(HTTPShouldUsePipelining)), NSStringFromSelector(@selector(networkServiceType)), NSStringFromSelector(@selector(timeoutInterval))];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _AFHTTPRequestSerializerObservedKeyPaths;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡KVOåˆ¤æ–­æ˜¯å¦æ˜¯æ–°å€¼ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±åŠ åˆ°mutableObservedChangedKeyPathsé‡Œé¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath</div><div class="line">                      ofObject:(__unused id)object</div><div class="line">                        change:(NSDictionary *)change</div><div class="line">                       context:(void *)context</div><div class="line">&#123;</div><div class="line">    if (context == AFHTTPRequestSerializerObserverContext) &#123;</div><div class="line">        if ([change[NSKeyValueChangeNewKey] isEqual:[NSNull null]]) &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths removeObject:keyPath];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths addObject:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¾ç½®éªŒè¯å­—æ®µ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username</div><div class="line">                                       password:(NSString *)password</div><div class="line">&#123;</div><div class="line">    NSData *basicAuthCredentials = [[NSString stringWithFormat:@&quot;%@:%@&quot;, username, password] dataUsingEncoding:NSUTF8StringEncoding];</div><div class="line">    NSString *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(NSDataBase64EncodingOptions)0];</div><div class="line">    [self setValue:[NSString stringWithFormat:@&quot;Basic %@&quot;, base64AuthCredentials] forHTTPHeaderField:@&quot;Authorization&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¹‹åï¼Œéœ€è¦è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)method</div><div class="line">                                 URLString:(NSString *)URLString</div><div class="line">                                parameters:(id)parameters</div><div class="line">                                     error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // æ–­è¨€                                     </div><div class="line">    NSParameterAssert(method);</div><div class="line">    NSParameterAssert(URLString);</div><div class="line">	</div><div class="line">    NSURL *url = [NSURL URLWithString:URLString];</div><div class="line"></div><div class="line">    NSParameterAssert(url);</div><div class="line">	// æ ¹æ®urlåˆå§‹åŒ–request</div><div class="line">    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</div><div class="line">    // è®¾ç½®HTTPæ–¹æ³•                                   </div><div class="line">    mutableRequest.HTTPMethod = method;</div><div class="line">	// æ ¹æ®mutableObservedChangedKeyPathså­˜å‚¨çš„å±æ€§ï¼Œè®¾ç½®åˆ°mutableRequest</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</div><div class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	// è°ƒç”¨- [requestBySerializingRequest:withParameters:error]æ–¹æ³•</div><div class="line">    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</div><div class="line"></div><div class="line">	return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</div><div class="line">                               withParameters:(id)parameters</div><div class="line">                                        error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // æ–­è¨€                                      </div><div class="line">    NSParameterAssert(request);</div><div class="line"></div><div class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</div><div class="line">    // æ ¹æ®HTTPRequestHeadersæ¥è®¾ç½®mutableRequestçš„å¤´éƒ¨å­—æ®µ</div><div class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</div><div class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</div><div class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">	</div><div class="line">    NSString *query = nil;</div><div class="line">    if (parameters) &#123;</div><div class="line">        if (self.queryStringSerialization) &#123;</div><div class="line">          	// å¦‚æœè®¾ç½®äº†queryStringSerializationè¿™ä¸ªblockçš„è¯ï¼Œå°±éœ€è¦è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„æŸ¥è¯¢è¯­å¥åºåˆ—åŒ–æ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</div><div class="line">            NSError *serializationError;</div><div class="line">            query = self.queryStringSerialization(request, parameters, &amp;serializationError);</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                if (error) &#123;</div><div class="line">                    *error = serializationError;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return nil;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">          	// å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™è°ƒç”¨AFQueryStringFromParametersæ–¹æ³•ï¼Œè½¬æˆqueryæŸ¥è¯¢å‚æ•°</div><div class="line">            switch (self.queryStringSerializationStyle) &#123;</div><div class="line">                case AFHTTPRequestQueryStringDefaultStyle:</div><div class="line">                    query = AFQueryStringFromParameters(parameters);</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    // å°†æ‹¼æ¥å¥½çš„queryè¯­å¥æ”¾åˆ° mutableRequest.URLæˆ–è€…æ”¾åˆ°                                    mutableRequestçš„HTTPBodyé‡Œ</div><div class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</div><div class="line">        if (query) &#123;</div><div class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // #2864: an empty string is a valid x-www-form-urlencoded payload</div><div class="line">        if (!query) &#123;</div><div class="line">            query = @&quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</div><div class="line">            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</div><div class="line">        &#125;</div><div class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„è¯ï¼ŒåŸºæœ¬éƒ½æ˜¯å¯¹å¤šéƒ¨åˆ†æ•°æ®è¿›è¡Œç»„è£…</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/05/23/AFNetWorking-four/" class="prev">PREV</a><a href="/2016/05/27/AFNetWorking-six/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2016/05/25/AFNetWorking-five/';
var disqus_title = 'iOS AFNetWorkingæºç è¯¦è§£ï¼ˆäº”ï¼‰';
var disqus_url = 'http://yuzeyang.github.io/2016/05/25/AFNetWorking-five/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2015 - 2017 <a href="http://yuzeyang.github.io">å®«åŸ</a>, Talk is cheap, show me the code.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>