<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS AFNetWorking源码详解（五） · 宫城</title><meta name="description" content="iOS AFNetWorking源码详解（五） - 宫城"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS AFNetWorking源码详解（五）</h1><div class="post-info">May 25, 2016</div><div class="post-content"><p><code>AFURLRequestSerialization</code>是用来对发出的请求进行一些处理</p>
<a id="more"></a>
<p><code>AFPercentEscapedStringFromString</code>方法将string里面的:#[]@!$&amp;’()*+,;=字符替换成%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">NSString * AFPercentEscapedStringFromString(NSString *string) &#123;</div><div class="line">  	static NSString * const kAFCharactersGeneralDelimitersToEncode = @&quot;:#[]@&quot;; // does not include &quot;?&quot; or &quot;/&quot; due to RFC 3986 - Section 3.4</div><div class="line">    static NSString * const kAFCharactersSubDelimitersToEncode = @&quot;!$&amp;&apos;()*+,;=&quot;;</div><div class="line">	</div><div class="line">  	// 从可用字符替换删除掉:#[]@!$&amp;&apos;()*+,;=这些字符</div><div class="line">    NSMutableCharacterSet * allowedCharacterSet = [[NSCharacterSet URLQueryAllowedCharacterSet] mutableCopy];</div><div class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</div><div class="line"></div><div class="line">	// FIXME: https://github.com/AFNetworking/AFNetworking/pull/3028</div><div class="line">    // return [string stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">	</div><div class="line">  	// 声明批量处理的大小为50</div><div class="line">    static NSUInteger const batchSize = 50;</div><div class="line"></div><div class="line">    NSUInteger index = 0;</div><div class="line">    NSMutableString *escaped = @&quot;&quot;.mutableCopy;</div><div class="line">	</div><div class="line">  	// 循环将string里面:#[]@!$&amp;&apos;()*+,;=的字符替换成%</div><div class="line">    while (index &lt; string.length) &#123;</div><div class="line">#pragma GCC diagnostic push</div><div class="line">#pragma GCC diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">        NSUInteger length = MIN(string.length - index, batchSize);</div><div class="line">#pragma GCC diagnostic pop</div><div class="line">        NSRange range = NSMakeRange(index, length);</div><div class="line"></div><div class="line">        // To avoid breaking up character sequences such as 👴🏻👮🏽</div><div class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</div><div class="line"></div><div class="line">        NSString *substring = [string substringWithRange:range];</div><div class="line">        NSString *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</div><div class="line">        [escaped appendString:encoded];</div><div class="line"></div><div class="line">        index += range.length;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	return escaped;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>AFQueryStringPair</code>类里面有个<code>- URLEncodedStringValue</code>方法，将请求里面的URL参数转成field=value形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (NSString *)URLEncodedStringValue &#123;</div><div class="line">    if (!self.value || [self.value isEqual:[NSNull null]]) &#123;</div><div class="line">        return AFPercentEscapedStringFromString([self.field description]);</div><div class="line">    &#125; else &#123;</div><div class="line">        return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>字典里面是我们查询的key和value，我们通过将字典内容转成<code>AFQueryStringPair</code>对象，调用<code>- URLEncodedStringValue</code>方法，转成key=value，放到mutablePairs数组里，最后用&amp;符拼接起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSString * AFQueryStringFromParameters(NSDictionary *parameters) &#123;</div><div class="line">    NSMutableArray *mutablePairs = [NSMutableArray array];</div><div class="line">    for (AFQueryStringPair *pair in AFQueryStringPairsFromDictionary(parameters)) &#123;</div><div class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [mutablePairs componentsJoinedByString:@&quot;&amp;&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) &#123;</div><div class="line">    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];</div><div class="line"></div><div class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:@&quot;description&quot; ascending:YES selector:@selector(compare:)];</div><div class="line">	</div><div class="line">  	// 如果是字典，遍历后返回key[nestedKey]=nestedValue</div><div class="line">    if ([value isKindOfClass:[NSDictionary class]]) &#123;</div><div class="line">        NSDictionary *dictionary = value;</div><div class="line">        // Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</div><div class="line">        for (id nestedKey in [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            id nestedValue = dictionary[nestedKey];</div><div class="line">            if (nestedValue) &#123;</div><div class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@&quot;%@[%@]&quot;, key, nestedKey] : nestedKey), nestedValue)];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; // 如果是数组，遍历后返回key[]=nestedValue</div><div class="line">  	else if ([value isKindOfClass:[NSArray class]]) &#123;</div><div class="line">        NSArray *array = value;</div><div class="line">        for (id nestedValue in array) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([NSString stringWithFormat:@&quot;%@[]&quot;, key], nestedValue)];</div><div class="line">        &#125;</div><div class="line">    &#125; // 如果是集合，遍历后返回key=obj</div><div class="line">  	else if ([value isKindOfClass:[NSSet class]]) &#123;</div><div class="line">        NSSet *set = value;</div><div class="line">        for (id obj in [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</div><div class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</div><div class="line">        &#125;</div><div class="line">    &#125; // 其他返回key=value </div><div class="line">  	else &#123;</div><div class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableQueryStringComponents;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设传入的是，我将key,value放到数组里面，再放到mutableQueryStringComponents里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSSet *afSet = [NSSet setWithObjects:@(1),@(2), nil];</div><div class="line">NSDictionary *afDic = @&#123;@&quot;dickey&quot;: @&#123;@&quot;nestKey&quot;: @&quot;nestValue&quot;&#125;,</div><div class="line">                        @&quot;arrayKey&quot;: @[@[@(1)]],</div><div class="line">                        @&quot;setKey&quot;: afSet,</div><div class="line">                        @&quot;generalKey&quot;: @&quot;generalValue&quot;&#125;;</div><div class="line">NSArray *resultArray = AFQueryStringPairsFromKeyAndValue(nil, afDic);</div></pre></td></tr></table></figure>
<p>打印得到的结果是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[arrayKey, 1],</div><div class="line"> [dickey[nestKey], nestValue],</div><div class="line"> [generalKey, generalValue],</div><div class="line"> [setKey, 1]，</div><div class="line"> [setKey,2]]</div></pre></td></tr></table></figure>
<p>我们使用<code>AFHTTPRequestSerializer</code>对HTTP请求的头部进行处理</p>
<p>首先调用<code>+ serializer</code>进行初始化，里面调用了自己init方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)serializer &#123;</div><div class="line">    return [[self alloc] init];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>init里面先将Accept-Language存到mutableHTTPRequestHeaders里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 将mainBundle里面根据使用语言的优先顺序放到acceptLanguagesComponents里面，再用&quot;,&quot;分隔，存到mutableHTTPRequestHeaders字典里面</div><div class="line">  	NSMutableArray *acceptLanguagesComponents = [NSMutableArray array];</div><div class="line">    [[NSLocale preferredLanguages] enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) &#123;</div><div class="line">        float q = 1.0f - (idx * 0.1f);</div><div class="line">        [acceptLanguagesComponents addObject:[NSString stringWithFormat:@&quot;%@;q=%0.1g&quot;, obj, q]];</div><div class="line">        *stop = q &lt;= 0.5f;</div><div class="line">    &#125;];</div><div class="line">    [self setValue:[acceptLanguagesComponents componentsJoinedByString:@&quot;, &quot;] forHTTPHeaderField:@&quot;Accept-Language&quot;];</div></pre></td></tr></table></figure>
<p>然后拼接User-Agent，格式为”%@/%@ (%@; iOS %@; Scale/%0.2f)”，里面需要5个参数，第一个参数先获取项目名，如果没有，就用BundleIdentifier，第二个参数先获取短版本号，如果没有就用版本号，第三个参数是当前设备的类型，第四个参数是当前设备的版本号，第五个参数是屏幕的比例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NSString *userAgent = nil;</div><div class="line">#pragma clang diagnostic push</div><div class="line">#pragma clang diagnostic ignored &quot;-Wgnu&quot;</div><div class="line">#if TARGET_OS_IOS</div><div class="line">    userAgent = [NSString stringWithFormat:@&quot;%@/%@ (%@; iOS %@; Scale/%0.2f)&quot;, [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleExecutableKey] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleIdentifierKey], [[NSBundle mainBundle] infoDictionary][@&quot;CFBundleShortVersionString&quot;] ?: [[NSBundle mainBundle] infoDictionary][(__bridge NSString *)kCFBundleVersionKey], [[UIDevice currentDevice] model], [[UIDevice currentDevice] systemVersion], [[UIScreen mainScreen] scale]];</div><div class="line">#elif TARGET_OS_WATCH</div><div class="line">    // ... </div><div class="line">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</div><div class="line">    // ...</div><div class="line">#endif</div><div class="line">#pragma clang diagnostic pop</div><div class="line">if (userAgent) &#123;</div><div class="line">        if (![userAgent canBeConvertedToEncoding:NSASCIIStringEncoding]) &#123;</div><div class="line">            NSMutableString *mutableUserAgent = [userAgent mutableCopy];</div><div class="line">            if (CFStringTransform((__bridge CFMutableStringRef)(mutableUserAgent), NULL, (__bridge CFStringRef)@&quot;Any-Latin; Latin-ASCII; [:^ASCII:] Remove&quot;, false)) &#123;</div><div class="line">                userAgent = mutableUserAgent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        [self setValue:userAgent forHTTPHeaderField:@&quot;User-Agent&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后设置属性的监听，这些属性在头文件里面都可以找到，实现文件里面也实现了set方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">self.mutableObservedChangedKeyPaths = [NSMutableSet set];</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self respondsToSelector:NSSelectorFromString(keyPath)]) &#123;</div><div class="line">            [self addObserver:self forKeyPath:keyPath options:NSKeyValueObservingOptionNew context:AFHTTPRequestSerializerObserverContext];</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">static NSArray * AFHTTPRequestSerializerObservedKeyPaths() &#123;</div><div class="line">    static NSArray *_AFHTTPRequestSerializerObservedKeyPaths = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[NSStringFromSelector(@selector(allowsCellularAccess)), NSStringFromSelector(@selector(cachePolicy)), NSStringFromSelector(@selector(HTTPShouldHandleCookies)), NSStringFromSelector(@selector(HTTPShouldUsePipelining)), NSStringFromSelector(@selector(networkServiceType)), NSStringFromSelector(@selector(timeoutInterval))];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _AFHTTPRequestSerializerObservedKeyPaths;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过KVO判断是否是新值，如果是的话，就加到mutableObservedChangedKeyPaths里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath</div><div class="line">                      ofObject:(__unused id)object</div><div class="line">                        change:(NSDictionary *)change</div><div class="line">                       context:(void *)context</div><div class="line">&#123;</div><div class="line">    if (context == AFHTTPRequestSerializerObserverContext) &#123;</div><div class="line">        if ([change[NSKeyValueChangeNewKey] isEqual:[NSNull null]]) &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths removeObject:keyPath];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self.mutableObservedChangedKeyPaths addObject:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>设置验证字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)setAuthorizationHeaderFieldWithUsername:(NSString *)username</div><div class="line">                                       password:(NSString *)password</div><div class="line">&#123;</div><div class="line">    NSData *basicAuthCredentials = [[NSString stringWithFormat:@&quot;%@:%@&quot;, username, password] dataUsingEncoding:NSUTF8StringEncoding];</div><div class="line">    NSString *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(NSDataBase64EncodingOptions)0];</div><div class="line">    [self setValue:[NSString stringWithFormat:@&quot;Basic %@&quot;, base64AuthCredentials] forHTTPHeaderField:@&quot;Authorization&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化之后，需要调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)method</div><div class="line">                                 URLString:(NSString *)URLString</div><div class="line">                                parameters:(id)parameters</div><div class="line">                                     error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // 断言                                     </div><div class="line">    NSParameterAssert(method);</div><div class="line">    NSParameterAssert(URLString);</div><div class="line">	</div><div class="line">    NSURL *url = [NSURL URLWithString:URLString];</div><div class="line"></div><div class="line">    NSParameterAssert(url);</div><div class="line">	// 根据url初始化request</div><div class="line">    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</div><div class="line">    // 设置HTTP方法                                   </div><div class="line">    mutableRequest.HTTPMethod = method;</div><div class="line">	// 根据mutableObservedChangedKeyPaths存储的属性，设置到mutableRequest</div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</div><div class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	// 调用- [requestBySerializingRequest:withParameters:error]方法</div><div class="line">    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</div><div class="line"></div><div class="line">	return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</div><div class="line">                               withParameters:(id)parameters</div><div class="line">                                        error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    // 断言                                      </div><div class="line">    NSParameterAssert(request);</div><div class="line"></div><div class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</div><div class="line">    // 根据HTTPRequestHeaders来设置mutableRequest的头部字段</div><div class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</div><div class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</div><div class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">	</div><div class="line">    NSString *query = nil;</div><div class="line">    if (parameters) &#123;</div><div class="line">        if (self.queryStringSerialization) &#123;</div><div class="line">          	// 如果设置了queryStringSerialization这个block的话，就需要设置一个自定义的查询语句序列化方法，转成query查询参数</div><div class="line">            NSError *serializationError;</div><div class="line">            query = self.queryStringSerialization(request, parameters, &amp;serializationError);</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                if (error) &#123;</div><div class="line">                    *error = serializationError;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return nil;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">          	// 如果没有设置，则调用AFQueryStringFromParameters方法，转成query查询参数</div><div class="line">            switch (self.queryStringSerializationStyle) &#123;</div><div class="line">                case AFHTTPRequestQueryStringDefaultStyle:</div><div class="line">                    query = AFQueryStringFromParameters(parameters);</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    // 将拼接好的query语句放到 mutableRequest.URL或者放到                                    mutableRequest的HTTPBody里</div><div class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</div><div class="line">        if (query) &#123;</div><div class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // #2864: an empty string is a valid x-www-form-urlencoded payload</div><div class="line">        if (!query) &#123;</div><div class="line">            query = @&quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</div><div class="line">            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</div><div class="line">        &#125;</div><div class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面的话，基本都是对多部分数据进行组装</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/05/23/AFNetWorking-four/" class="prev">PREV</a><a href="/2016/05/27/AFNetWorking-six/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2016/05/25/AFNetWorking-five/';
var disqus_title = 'iOS AFNetWorking源码详解（五）';
var disqus_url = 'http://yuzeyang.github.io/2016/05/25/AFNetWorking-five/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://yuzeyang.github.io">宫城</a>, Talk is cheap, show me the code.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>