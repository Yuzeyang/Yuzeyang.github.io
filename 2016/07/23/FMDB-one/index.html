<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> FMDB初探（一） · 宫城</title><meta name="description" content="FMDB初探（一） - 宫城"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yuzeyang.github.io/atom.xml" title="宫城"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">FMDB初探（一）</h1><div class="post-info">2016年7月23日</div><div class="post-content"><p>在之前的<a href="http://zeeyang.com/2016/06/22/GCDAsyncSocket-socket-optimize/" target="_blank" rel="external">iOS Socket重构设计</a>里面我有提到我们使用了FMDB做消息缓存，在数据库选型方面，我们<a href="http://broccoliii.me/" target="_blank" rel="external">西兰花</a>也对目前比较流行和成熟的<code>Realm</code>、<code>FMDB</code>和<code>Core Data</code>做了调查，里面包括了安装、使用和性能比较，是个不错的参考例子</p>
<p>在选型时，我们应该多选取几个作为对比，从使用方面评估学习成本，通过测试不同数据库操作来比较性能差异，了解有哪些大型的App使用了该数据库以及评价来侧面说明该数据库的成熟度和在使用过程中出现的问题，最后根据自己实际的业务需求来选型</p>
<p>在选定使用<code>FMDB</code>之后，我也只是简单的了解下<code>FMDB</code>的使用，并未对内部的实现和设计思路做深入了解，但是在阅读了代码之后，<code>FMDB</code>确实像其他博客里面提到的那样，是对原生的SQLite API进行了包装，暴露出相对友好的对外接口，只需传入SQL语句即可(但是对于习惯于使用Model操作的我们来说，直接写SQL语句还是比较麻烦的，所以GitHub上也就库对<code>FMDB</code>进行了封装，省去写SQL语句，直接对Model进行操作)，并且<code>FMDB</code>内部对SQL语句进行了缓存，再配合上多线程并发执行，在提高效率方面做了不少的优化，另外还扩展了内存/文件的IO操作和虚表的操作</p>
<p>下面我会将API使用和源码结合起来讲，方便了解<code>FMDB</code>以及对复习下原生的SQLite API</p>
<a id="more"></a>
<h2 id="FMDatabase"><a href="#FMDatabase" class="headerlink" title="FMDatabase"></a>FMDatabase</h2><h4 id="u521D_u59CB_u5316"><a href="#u521D_u59CB_u5316" class="headerlink" title="初始化"></a>初始化</h4><p>数据库的初始化对外有两种方法<code>+ databaseWithPath:</code>和<code>- initWithPath:</code>，内部实际上<code>+ databaseWithPath:</code>只是对<code>- initWithPath:</code>包装，代码里很多类似<code>FMDBReturnAutoreleased</code>等等这一类宏定义是为了兼容ARC和MRC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)databaseWithPath:(NSString*)aPath &#123;</div><div class="line">    return FMDBReturnAutoreleased([[self alloc] initWithPath:aPath]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)init &#123;</div><div class="line">    return [self initWithPath:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithPath:(NSString*)aPath &#123;</div><div class="line">    // SQLite支持三种线程模式，分别为单线程模式、多线程模式和串行模式</div><div class="line">    // sqlite3_threadsafe()的返回值可以确定编译时指定的线程模式，其中对于单线程模式，sqlite3_threadsafe()返回false，对于另外两个模式，则返回true。这是因为单线程模式下没有进行互斥，所以多线程下是不安全的</div><div class="line">    assert(sqlite3_threadsafe()); // whoa there big boy- gotta make sure sqlite it happy with what we&apos;re going to do.</div><div class="line">    </div><div class="line">    self = [super init];</div><div class="line">    </div><div class="line">    if (self) &#123;</div><div class="line">        _databasePath               = [aPath copy];</div><div class="line">        _openResultSets             = [[NSMutableSet alloc] init];</div><div class="line">        // 此时并不创建数据库，真正创建是在open的时候</div><div class="line">      	_db                         = nil;</div><div class="line">        _logsErrors                 = YES;</div><div class="line">        _crashOnErrors              = NO;</div><div class="line">        _maxBusyRetryTimeInterval   = 2;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 给定database路径</div><div class="line">NSString *dbPath = @&quot;/tmp/tmp.db&quot;;</div><div class="line">// 调用[+ databaseWithPath:]方法</div><div class="line">FMDatabase *db = [FMDatabase databaseWithPath:dbPath];</div></pre></td></tr></table></figure>
<h4 id="u6253_u5F00_u6570_u636E_u8FDE_u63A5"><a href="#u6253_u5F00_u6570_u636E_u8FDE_u63A5" class="headerlink" title="打开数据连接"></a>打开数据连接</h4><p>打开连接提供了三种方法，这时候才开始创建数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (BOOL)open &#123;</div><div class="line">    if (_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    // 根据数据库路径打开数据库，如果数据库不存在就新建一个</div><div class="line">    int err = sqlite3_open([self sqlitePath], (sqlite3**)&amp;_db );</div><div class="line">    if(err != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error opening!: %d&quot;, err);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    // 设置最大繁忙重试时间间隔，默认为2秒</div><div class="line">    if (_maxBusyRetryTimeInterval &gt; 0.0) &#123;</div><div class="line">        // set the handler</div><div class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">  	return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// 根据标记打开一个新的数据库连接</div><div class="line">// flag可以是以下三种值之一：</div><div class="line">// SQLITE_OPEN_READONLY，只读模式，如果数据库不存在会报错</div><div class="line">// SQLITE_OPEN_READWRITE，读写模式，如果该文件在操作系统中是写保护的，那就是以只读方式打开，如果数据库不存在会报错</div><div class="line">// SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE，以读写方式打开，如果数据不存在则新建一个，这个用于open方法里面</div><div class="line">// 以上还可以可选组合`SQLITE_OPEN_NOMUTEX`, `SQLITE_OPEN_FULLMUTEX`, `SQLITE_OPEN_SHAREDCACHE`, `SQLITE_OPEN_PRIVATECACHE`, and/or `SQLITE_OPEN_URI`</div><div class="line">- (BOOL)openWithFlags:(int)flags &#123;</div><div class="line">    return [self openWithFlags:flags vfs:nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (BOOL)openWithFlags:(int)flags vfs:(NSString *)vfsName &#123;</div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3005000</div><div class="line">    if (_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    // 比sqlite3_open多传入了flags和vfsName，vfsName为使用的VFS模块的名称</div><div class="line">    // sqlite3_open_v2里zVfs参数允许客户应用程序命名一个虚拟文件系统（Virtual File System）模块，用来与数据库连接。VFS作为SQlite library和底层存储系统（如某个文件系统）之间的一个抽象层，通常客户应用程序可以简单的给该参数传递一个NULL指针，以使用默认的VFS模块。</div><div class="line">    // sqlite3_open_v2比sqlite3_open和sqlite3_open16强大在它可以指定连接方式</div><div class="line">    int err = sqlite3_open_v2([self sqlitePath], (sqlite3**)&amp;_db, flags, [vfsName UTF8String]);</div><div class="line">    if(err != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error opening!: %d&quot;, err);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_maxBusyRetryTimeInterval &gt; 0.0) &#123;</div><div class="line">        // set the handler</div><div class="line">        [self setMaxBusyRetryTimeInterval:_maxBusyRetryTimeInterval];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return YES;</div><div class="line">#else</div><div class="line">    NSLog(@&quot;openWithFlags requires SQLite 3.5&quot;);</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>open时会根据<code>_maxBusyRetryTimeInterval</code>来设置繁忙处理<code>busy handler</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">- (void)setMaxBusyRetryTimeInterval:(NSTimeInterval)timeout &#123;</div><div class="line">    </div><div class="line">    _maxBusyRetryTimeInterval = timeout;</div><div class="line">    </div><div class="line">    if (!_db) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    /*</div><div class="line">     int sqlite3_busy_handler(sqlite3*, int(*)(void*,int), void*);</div><div class="line">     第二个参数是回调函数（busy handler），如果设置了回调函数，那就需要设置sqlite3_busy_handler的第三个参数，这里传递给它的是一个void*的参数的拷贝；如果回调函数返回０时，将不再尝试再次访问数据库而返回SQLITE_BUSY或者SQLITE_IOERR_BLOCKED。如果回调函数返回非０,将会不断尝试操作数据库。</div><div class="line">     也就是说，程序运行过程中，如果有其他进程或者线程在读写数据库，那么sqlite3_busy_handler会不断调用回调函数，直到其他进程或者线程释放锁。获得锁之后，不会再调用回调函数，从而向下执行，进行数据库操作。该函数是在获取不到锁的时候，以执行回调函数的次数来进行延迟，等待其他进程或者线程操作数据库结束，从而获得锁操作数据库。</div><div class="line">     */</div><div class="line">    if (timeout &gt; 0) &#123;</div><div class="line">        // busy handler设置为FMDBDatabaseBusyHandler函数</div><div class="line">        sqlite3_busy_handler(_db, &amp;FMDBDatabaseBusyHandler, (__bridge void *)(self));</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        // turn it off otherwise</div><div class="line">        // 关闭busy handler</div><div class="line">        sqlite3_busy_handler(_db, nil, nil);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 这就是回调函数</div><div class="line">static int FMDBDatabaseBusyHandler(void *f, int count) &#123;</div><div class="line">    FMDatabase *self = (__bridge FMDatabase*)f;</div><div class="line">    </div><div class="line">    // 如果是第一次调用，调用[+ timeIntervalSinceReferenceDate]方法，获取当前时间与2001年1月1日00:00:00 UTC的时间间隔，并赋值给startBusyRetryTime</div><div class="line">    if (count == 0) &#123;</div><div class="line">        self-&gt;_startBusyRetryTime = [NSDate timeIntervalSinceReferenceDate];</div><div class="line">        // 返回1，则将不断尝试操作数据库</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    // 计算当前时间与2001年1月1日00:00:00 UTC的时间间隔和startBusyRetryTime的间隔</div><div class="line">    NSTimeInterval delta = [NSDate timeIntervalSinceReferenceDate] - (self-&gt;_startBusyRetryTime);</div><div class="line">    // 如果间隔时间小于最大的重试间隔时间</div><div class="line">    if (delta &lt; [self maxBusyRetryTimeInterval]) &#123;</div><div class="line">        // 产生一个从50-99的随机整数作为需要挂起毫秒时间</div><div class="line">        int requestedSleepInMillseconds = (int) arc4random_uniform(50) + 50;</div><div class="line">        // 调用sqlite3_sleep返回实际挂起毫秒时间，如果不一致，可能是因为SQLite构建时没有将HAVE_USLEEP设置为1</div><div class="line">        int actualSleepInMilliseconds = sqlite3_sleep(requestedSleepInMillseconds);</div><div class="line">        if (actualSleepInMilliseconds != requestedSleepInMillseconds) &#123;</div><div class="line">            NSLog(@&quot;WARNING: Requested sleep of %i milliseconds, but SQLite returned %i. Maybe SQLite wasn&apos;t built with HAVE_USLEEP=1?&quot;, requestedSleepInMillseconds, actualSleepInMilliseconds);</div><div class="line">        &#125;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (![db open]) &#123;</div><div class="line">	// do somthing        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u5355_u4E2A_u67E5_u8BE2SQL_u8BED_u53E5"><a href="#u6267_u884C_u5355_u4E2A_u67E5_u8BE2SQL_u8BED_u53E5" class="headerlink" title="执行单个查询SQL语句"></a>执行单个查询SQL语句</h4><p>主要执行的是<code>(FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args</code>方法，<code>sql</code>是执行SELECT语句，<code>dictionaryArgs</code>是对应于<code>sql</code>语句里<code>？</code>的<code>key</code>和<code>value</code>，在将<code>sql</code>语句转换成<code>prepared</code>语句时，这里先从缓存中获取，没有的话再去调用<code>sqlite3_prepare_v2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">- (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</div><div class="line">    // 检查数据库是否存在</div><div class="line">    if (![self databaseExists]) &#123;</div><div class="line">        return 0x00;</div><div class="line">    &#125;</div><div class="line">    // 检查是否正在执行操作</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return 0x00;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int rc                  = 0x00;</div><div class="line">    sqlite3_stmt *pStmt     = 0x00;</div><div class="line">    FMStatement *statement  = 0x00;</div><div class="line">    FMResultSet *rs         = 0x00;</div><div class="line">    </div><div class="line">    if (_traceExecution &amp;&amp; sql) &#123;</div><div class="line">        NSLog(@&quot;%@ executeQuery: %@&quot;, self, sql);</div><div class="line">    &#125;</div><div class="line">    // 将sql语句转换成prepared语句</div><div class="line">    // 由于使用sqlite3_prepare_v2来生成sql对应的prepared语句代价很大</div><div class="line">    // 所以使用缓存机制来减少sqlite3_prepare_v2的使用</div><div class="line">    if (_shouldCacheStatements) &#123;</div><div class="line">        // 根据sql获取到缓存中的prepared语句</div><div class="line">        statement = [self cachedStatementForQuery:sql];</div><div class="line">        pStmt = statement ? [statement statement] : 0x00;</div><div class="line">        // 重置prepared语句</div><div class="line">        [statement reset];</div><div class="line">    &#125;</div><div class="line">    // 如果缓存中没有sql对应的prepared语句，那么需要用sqlite3_prepare_v2生成对应的prepared语句</div><div class="line">    if (!pStmt) &#123;</div><div class="line">        </div><div class="line">        rc = sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</div><div class="line">        </div><div class="line">        // 如果生成失败，则打印错误日志</div><div class="line">        if (SQLITE_OK != rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_crashOnErrors) &#123;</div><div class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                // 停止程序</div><div class="line">                abort();</div><div class="line">            &#125;</div><div class="line">            // 释放所有内部资源和FMStatement</div><div class="line">            sqlite3_finalize(pStmt);</div><div class="line">            _isExecutingStatement = NO;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    id obj;</div><div class="line">    int idx = 0;</div><div class="line">    // sqlite3_bind_parameter_count 返回SQL语句参数的数量</div><div class="line">    int queryCount = sqlite3_bind_parameter_count(pStmt); // pointed out by Dominic Yu (thanks!)</div><div class="line">    </div><div class="line">    // If dictionaryArgs is passed in, that means we are using sqlite&apos;s named parameter support</div><div class="line">    if (dictionaryArgs) &#123;</div><div class="line">        </div><div class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</div><div class="line">            </div><div class="line">            // Prefix the key with a colon.</div><div class="line">            NSString *parameterName = [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                NSLog(@&quot;%@ = %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Get the index for the parameter name.</div><div class="line">            // 通过传入参数名来获取该参数的索引</div><div class="line">            int namedIdx = sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</div><div class="line">            </div><div class="line">            FMDBRelease(parameterName);</div><div class="line">            // 如果索引大于0</div><div class="line">            if (namedIdx &gt; 0) &#123;</div><div class="line">                // Standard binding from here.</div><div class="line">                // 在prepared语句里将值绑定到索引位置</div><div class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</div><div class="line">                // increment the binding count, so our check below works out</div><div class="line">                // 绑定数量加一</div><div class="line">                idx++;</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                NSLog(@&quot;Could not find index for %@&quot;, dictionaryKey);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        </div><div class="line">        while (idx &lt; queryCount) &#123;</div><div class="line">            // 当调用下面三个方法时</div><div class="line">            // - (FMResultSet *)executeQueryWithFormat:(NSString*)format, ...</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString *)sql withArgumentsInArray:(NSArray *)arguments</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString *)sql values:(NSArray *)values error:(NSError * __autoreleasing *)error</div><div class="line">            // 值是放在NSArray里面，循环取出来绑定</div><div class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</div><div class="line">                obj = [arrayArgs objectAtIndex:(NSUInteger)idx];</div><div class="line">            &#125;</div><div class="line">            // 当调用下面两个方法时</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString*)sql, ...</div><div class="line">            // - (FMResultSet *)executeQuery:(NSString*)sql withVAList:(va_list)args</div><div class="line">            // 值是放在va_list里面，循环取出来绑定</div><div class="line">            else if (args) &#123;</div><div class="line">                obj = va_arg(args, id);</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                //We ran out of arguments</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</div><div class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            idx++;</div><div class="line">            // 绑定参数</div><div class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // 如果绑定数量和参数数量不一致，打印错误，并释放资源</div><div class="line">    if (idx != queryCount) &#123;</div><div class="line">        NSLog(@&quot;Error: the bind count is not correct for the # of variables (executeQuery)&quot;);</div><div class="line">        sqlite3_finalize(pStmt);</div><div class="line">        _isExecutingStatement = NO;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    FMDBRetain(statement); // to balance the release below</div><div class="line">    </div><div class="line">    // 如果statement不为空，则缓存</div><div class="line">    if (!statement) &#123;</div><div class="line">        statement = [[FMStatement alloc] init];</div><div class="line">        [statement setStatement:pStmt];</div><div class="line">        </div><div class="line">        if (_shouldCacheStatements &amp;&amp; sql) &#123;</div><div class="line">            // 以sql作为key来缓存statement</div><div class="line">            [self setCachedStatement:statement forQuery:sql];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // the statement gets closed in rs&apos;s dealloc or [rs close];</div><div class="line">    // 根据statement和FMDataBase对象来初始化FMResultSet对象</div><div class="line">    rs = [FMResultSet resultSetWithStatement:statement usingParentDatabase:self];</div><div class="line">    [rs setQuery:sql];</div><div class="line">    </div><div class="line">    // 将FMResultSet对象加到_openResultSets里</div><div class="line">    NSValue *openResultSet = [NSValue valueWithNonretainedObject:rs];</div><div class="line">    [_openResultSets addObject:openResultSet];</div><div class="line">    // useCount+1</div><div class="line">    [statement setUseCount:[statement useCount] + 1];</div><div class="line">    </div><div class="line">    FMDBRelease(statement);</div><div class="line">    // 设置_isExecutingStatement操作结束</div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return rs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rs = [newDb executeQuery:@&quot;select rowid,* from test where a = ?&quot;, @&quot;hi&apos;&quot;];</div><div class="line"></div><div class="line">rs = [db executeQueryWithFormat:@&quot;select * from t5 where a = %s and a = %@ and b = %d&quot;, &quot;text&quot;, @&quot;text&quot;, 42];</div><div class="line"></div><div class="line">rs = [db executeQuery:@&quot;select * from testOneHundredTwelvePointTwo where b &gt; ?&quot; withArgumentsInArray:[NSArray arrayWithObject:[NSNumber numberWithInteger:1]]];</div><div class="line"></div><div class="line">rs = [db executeQuery:@&quot;select * from namedparamcounttest where a = :a&quot; withParameterDictionary:dictionaryArgs];</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u5355_u4E2A_u66F4_u65B0SQL_u8BED_u53E5"><a href="#u6267_u884C_u5355_u4E2A_u66F4_u65B0SQL_u8BED_u53E5" class="headerlink" title="执行单个更新SQL语句"></a>执行单个更新SQL语句</h4><p><code>- (BOOL)executeUpdate:(NSString*)sql error:(NSError**)outErr withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args</code>是主要函数，但是里面大部分处理和<code>- executeQuery: withArgumentsInArray: orDictionary: orVAList:</code>处理类似，不同处我已经注释说明，可以直接看注释部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div></pre></td><td class="code"><pre><div class="line">- (BOOL)executeUpdate:(NSString*)sql error:(NSError**)outErr withArgumentsInArray:(NSArray*)arrayArgs orDictionary:(NSDictionary *)dictionaryArgs orVAList:(va_list)args &#123;</div><div class="line">    </div><div class="line">    if (![self databaseExists]) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int rc                   = 0x00;</div><div class="line">    sqlite3_stmt *pStmt      = 0x00;</div><div class="line">    FMStatement *cachedStmt  = 0x00;</div><div class="line">    </div><div class="line">    if (_traceExecution &amp;&amp; sql) &#123;</div><div class="line">        NSLog(@&quot;%@ executeUpdate: %@&quot;, self, sql);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_shouldCacheStatements) &#123;</div><div class="line">        cachedStmt = [self cachedStatementForQuery:sql];</div><div class="line">        pStmt = cachedStmt ? [cachedStmt statement] : 0x00;</div><div class="line">        [cachedStmt reset];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (!pStmt) &#123;</div><div class="line">        rc = sqlite3_prepare_v2(_db, [sql UTF8String], -1, &amp;pStmt, 0);</div><div class="line">        </div><div class="line">        if (SQLITE_OK != rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">                NSLog(@&quot;DB Path: %@&quot;, _databasePath);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_crashOnErrors) &#123;</div><div class="line">                NSAssert(false, @&quot;DB Error: %d \&quot;%@\&quot;&quot;, [self lastErrorCode], [self lastErrorMessage]);</div><div class="line">                abort();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (outErr) &#123;</div><div class="line">                *outErr = [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            sqlite3_finalize(pStmt);</div><div class="line">            </div><div class="line">            _isExecutingStatement = NO;</div><div class="line">            return NO;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    id obj;</div><div class="line">    int idx = 0;</div><div class="line">    int queryCount = sqlite3_bind_parameter_count(pStmt);</div><div class="line">    </div><div class="line">    // If dictionaryArgs is passed in, that means we are using sqlite&apos;s named parameter support</div><div class="line">    if (dictionaryArgs) &#123;</div><div class="line">        </div><div class="line">        for (NSString *dictionaryKey in [dictionaryArgs allKeys]) &#123;</div><div class="line">            </div><div class="line">            // Prefix the key with a colon.</div><div class="line">            NSString *parameterName = [[NSString alloc] initWithFormat:@&quot;:%@&quot;, dictionaryKey];</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                NSLog(@&quot;%@ = %@&quot;, parameterName, [dictionaryArgs objectForKey:dictionaryKey]);</div><div class="line">            &#125;</div><div class="line">            // Get the index for the parameter name.</div><div class="line">            int namedIdx = sqlite3_bind_parameter_index(pStmt, [parameterName UTF8String]);</div><div class="line">            </div><div class="line">            FMDBRelease(parameterName);</div><div class="line">            </div><div class="line">            if (namedIdx &gt; 0) &#123;</div><div class="line">                // Standard binding from here.</div><div class="line">                [self bindObject:[dictionaryArgs objectForKey:dictionaryKey] toColumn:namedIdx inStatement:pStmt];</div><div class="line">                </div><div class="line">                // increment the binding count, so our check below works out</div><div class="line">                idx++;</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                // 由于多了outErr，所以绑定时出错需要将error抛出</div><div class="line">                NSString *message = [NSString stringWithFormat:@&quot;Could not find index for %@&quot;, dictionaryKey];</div><div class="line">                </div><div class="line">                if (_logsErrors) &#123;</div><div class="line">                    NSLog(@&quot;%@&quot;, message);</div><div class="line">                &#125;</div><div class="line">                if (outErr) &#123;</div><div class="line">                    *outErr = [self errorWithMessage:message];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        </div><div class="line">        while (idx &lt; queryCount) &#123;</div><div class="line">            </div><div class="line">            if (arrayArgs &amp;&amp; idx &lt; (int)[arrayArgs count]) &#123;</div><div class="line">                obj = [arrayArgs objectAtIndex:(NSUInteger)idx];</div><div class="line">            &#125;</div><div class="line">            else if (args) &#123;</div><div class="line">                obj = va_arg(args, id);</div><div class="line">            &#125;</div><div class="line">            else &#123;</div><div class="line">                //We ran out of arguments</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            if (_traceExecution) &#123;</div><div class="line">                if ([obj isKindOfClass:[NSData class]]) &#123;</div><div class="line">                    NSLog(@&quot;data: %ld bytes&quot;, (unsigned long)[(NSData*)obj length]);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    NSLog(@&quot;obj: %@&quot;, obj);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            idx++;</div><div class="line">            </div><div class="line">            [self bindObject:obj toColumn:idx inStatement:pStmt];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    if (idx != queryCount) &#123;</div><div class="line">        // 同样也是组装error抛出</div><div class="line">        NSString *message = [NSString stringWithFormat:@&quot;Error: the bind count (%d) is not correct for the # of variables in the query (%d) (%@) (executeUpdate)&quot;, idx, queryCount, sql];</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;%@&quot;, message);</div><div class="line">        &#125;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:message];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        sqlite3_finalize(pStmt);</div><div class="line">        _isExecutingStatement = NO;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    /* Call sqlite3_step() to run the virtual machine. Since the SQL being</div><div class="line">     ** executed is not a SELECT statement, we assume no data will be returned.</div><div class="line">     */</div><div class="line">    // sqlite3_prepare函数将SQL命令字符串解析并转换为一系列的命令字节码，这些字节码最终被传送到SQlite3的虚拟数据库引擎（VDBE: Virtual Database Engine）中执行，完成这项工作的是sqlite3_step函数。比如一个SELECT查询操作，sqlite3_step函数的每次调用都会返回结果集中的其中一行，直到再没有有效数据行了。每次调用sqlite3_step函数如果返回SQLITE_ROW，代表获得了有效数据行，可以通过sqlite3_column函数提取某列的值。如果调用sqlite3_step函数返回SQLITE_DONE，则代表prepared语句已经执行到终点了，没有有效数据了。很多命令第一次调用sqlite3_step函数就会返回SQLITE_DONE，因为这些SQL命令不会返回数据。对于INSERT，UPDATE，DELETE命令，会返回它们所修改的行号——一个单行单列的值。</div><div class="line">    /**</div><div class="line">     SQLITE_BUSY 数据库文件有锁</div><div class="line">     SQLITE_LOCKED 数据库中的某张表有锁</div><div class="line">     SQLITE_DONE sqlite3_step()执行完毕</div><div class="line">     SQLITE_ROW sqlite3_step()获取到下一行数据</div><div class="line">     SQLITE_ERROR 一般用于没有特别指定错误码的错误，就是说函数在执行过程中发生了错误，但无法知道错误发生的原因。</div><div class="line">     SQLITE_MISUSE 没有正确使用SQLite接口，比如一条语句在sqlite3_step函数执行之后，没有被重置之前，再次给其绑定参数，这时bind函数就会返回SQLITE_MISUSE。</div><div class="line">     **/</div><div class="line">    rc      = sqlite3_step(pStmt);</div><div class="line">    </div><div class="line">    if (SQLITE_DONE == rc) &#123;</div><div class="line">        // all is well, let&apos;s return.</div><div class="line">    &#125;</div><div class="line">    // sql操作被sqlite3_interrupt()函数终止</div><div class="line">    else if (SQLITE_INTERRUPT == rc) &#123;</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;Error calling sqlite3_step. Query was interrupted (%d: %s) SQLITE_INTERRUPT&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else if (rc == SQLITE_ROW) &#123;</div><div class="line">        NSString *message = [NSString stringWithFormat:@&quot;A executeUpdate is being called with a query string &apos;%@&apos;&quot;, sql];</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;%@&quot;, message);</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:message];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        if (outErr) &#123;</div><div class="line">            *outErr = [self errorWithMessage:[NSString stringWithUTF8String:sqlite3_errmsg(_db)]];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (SQLITE_ERROR == rc) &#123;</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_ERROR&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else if (SQLITE_MISUSE == rc) &#123;</div><div class="line">            // uh oh.</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Error calling sqlite3_step (%d: %s) SQLITE_MISUSE&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            // wtf?</div><div class="line">            if (_logsErrors) &#123;</div><div class="line">                NSLog(@&quot;Unknown error calling sqlite3_step (%d: %s) eu&quot;, rc, sqlite3_errmsg(_db));</div><div class="line">                NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_shouldCacheStatements &amp;&amp; !cachedStmt) &#123;</div><div class="line">        cachedStmt = [[FMStatement alloc] init];</div><div class="line">        </div><div class="line">        [cachedStmt setStatement:pStmt];</div><div class="line">        </div><div class="line">        [self setCachedStatement:cachedStmt forQuery:sql];</div><div class="line">        </div><div class="line">        FMDBRelease(cachedStmt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int closeErrorCode;</div><div class="line">    </div><div class="line">    if (cachedStmt) &#123;</div><div class="line">        [cachedStmt setUseCount:[cachedStmt useCount] + 1];</div><div class="line">        closeErrorCode = sqlite3_reset(pStmt);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        /* Finalize the virtual machine. This releases all memory and other</div><div class="line">         ** resources allocated by the sqlite3_prepare() call above.</div><div class="line">         */</div><div class="line">        closeErrorCode = sqlite3_finalize(pStmt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (closeErrorCode != SQLITE_OK) &#123;</div><div class="line">        if (_logsErrors) &#123;</div><div class="line">            NSLog(@&quot;Unknown error finalizing or resetting statement (%d: %s)&quot;, closeErrorCode, sqlite3_errmsg(_db));</div><div class="line">            NSLog(@&quot;DB Query: %@&quot;, sql);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    return (rc == SQLITE_DONE || rc == SQLITE_OK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[db executeUpdate:@&quot;insert into t5 values (?, ?, ?, ?, ?)&quot; withErrorAndBindings:&amp;err, @&quot;text&quot;, [NSNumber numberWithInt:42], @&quot;BLOB&quot;, @&quot;d&quot;, [NSNumber numberWithInt:0]];</div><div class="line"></div><div class="line">[dbB executeUpdate:@&quot;create table attached (a text)&quot;];</div><div class="line"></div><div class="line">[dbB executeUpdate:@&quot;insert into attached values (?)&quot;, @&quot;test&quot;];</div><div class="line"></div><div class="line">[db executeUpdateWithFormat:@&quot;insert into t55 values (%c, %hi, %g)&quot;, &apos;a&apos;, testShort, testFloat];</div><div class="line"></div><div class="line">[db executeUpdate:@&quot;insert into testOneHundredTwelvePointTwo values (?, ?)&quot; withArgumentsInArray:[NSArray arrayWithObjects:@&quot;one&quot;, [NSNumber numberWithInteger:2], nil]];</div><div class="line"></div><div class="line">[db executeUpdate:@&quot;insert into namedparamtest values (:a, :b, :c, :d)&quot; withParameterDictionary:dictionaryArgs];</div></pre></td></tr></table></figure>
<h4 id="u6267_u884C_u591A_u4E2ASQL_u8BED_u53E5"><a href="#u6267_u884C_u591A_u4E2ASQL_u8BED_u53E5" class="headerlink" title="执行多个SQL语句"></a>执行多个SQL语句</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">// 使用executeStatements:函数可以将多个SQL执行语句写在一个字符串中，并执行</div><div class="line">- (BOOL)executeStatements:(NSString *)sql &#123;</div><div class="line">    return [self executeStatements:sql withResultBlock:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)executeStatements:(NSString *)sql withResultBlock:(FMDBExecuteStatementsCallbackBlock)block &#123;</div><div class="line">    </div><div class="line">    int rc;</div><div class="line">    char *errmsg = nil;</div><div class="line">    /*</div><div class="line">     sqlite3_exec(sqlite3*, const char *sql, sqlite_callback, void *data, char **errmsg)</div><div class="line">     </div><div class="line">     该例程提供了一个执行 SQL 命令的快捷方式，SQL 命令由 sql 参数提供，可以由多个 SQL 命令组成。</div><div class="line">     </div><div class="line">     在这里，第一个参数 sqlite3 是打开的数据库对象，sqlite_callback 是一个回调，data 作为其第一个参数，errmsg 将被返回用来获取程序生成的任何错误。</div><div class="line">     </div><div class="line">     sqlite3_exec() 程序解析并执行由 sql 参数所给的每个命令，直到字符串结束或者遇到错误为止。</div><div class="line">     */</div><div class="line">    rc = sqlite3_exec([self sqliteHandle], [sql UTF8String], block ? FMDBExecuteBulkSQLCallback : nil, (__bridge void *)(block), &amp;errmsg);</div><div class="line">    </div><div class="line">    if (errmsg &amp;&amp; [self logsErrors]) &#123;</div><div class="line">        NSLog(@&quot;Error inserting batch: %s&quot;, errmsg);</div><div class="line">        sqlite3_free(errmsg);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">NSString *sql = @&quot;create table messages1 (id integer primary key messageId, x text);&quot;</div><div class="line">                 &quot;create table messages2 (id integer primary key messageId, y text);&quot;</div><div class="line">				 &quot;insert into messages1 (x) values (&apos;X&apos;);&quot;</div><div class="line">                 &quot;insert into messages2 (y) values (&apos;Y&apos;);&quot;;</div><div class="line"></div><div class="line">success = [db executeStatements:sql];</div><div class="line"></div><div class="line">sql = @&quot;select count(*) as count from messages1;&quot;</div><div class="line">       &quot;select count(*) as count from messages2;&quot;;</div><div class="line"></div><div class="line">success = [self.db executeStatements:sql withResultBlock:^int(NSDictionary *dictionary) &#123;</div><div class="line">    // do something</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<h4 id="u83B7_u53D6_u6700_u540E_u4E00_u6761_u63D2_u5165_u6570_u636E_u7684RowId"><a href="#u83B7_u53D6_u6700_u540E_u4E00_u6761_u63D2_u5165_u6570_u636E_u7684RowId" class="headerlink" title="获取最后一条插入数据的RowId"></a>获取最后一条插入数据的RowId</h4><p>可以根据这个<code>id</code>拿到该数据，并且向上取数据库数据等操作都可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (sqlite_int64)lastInsertRowId &#123;</div><div class="line">    // 如果有正在执行语句，返回</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    // sqlite3_last_insert_rowid 获取指定数据库最后一个插入的rowid</div><div class="line">    sqlite_int64 ret = sqlite3_last_insert_rowid(_db);</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u7EDF_u8BA1_u4E0A_u4E00_u6B21SQL_u8BED_u53E5_u53D7_u5F71_u54CD_u7684_u884C_u6570"><a href="#u7EDF_u8BA1_u4E0A_u4E00_u6B21SQL_u8BED_u53E5_u53D7_u5F71_u54CD_u7684_u884C_u6570" class="headerlink" title="统计上一次SQL语句受影响的行数"></a>统计上一次SQL语句受影响的行数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (int)changes &#123;</div><div class="line">    if (_isExecutingStatement) &#123;</div><div class="line">        [self warnInUse];</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    _isExecutingStatement = YES;</div><div class="line">    </div><div class="line">    int ret = sqlite3_changes(_db);</div><div class="line">    </div><div class="line">    _isExecutingStatement = NO;</div><div class="line">    </div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="exclusive_u4E8B_u52A1_u548Cdeferred_u4E8B_u52A1"><a href="#exclusive_u4E8B_u52A1_u548Cdeferred_u4E8B_u52A1" class="headerlink" title="exclusive事务和deferred事务"></a>exclusive事务和deferred事务</h4><p>事务可以从<code>DEFERRED</code>，<code>IMMEDIATE</code>或者<code>EXCLUSIVE</code>，一个事务的类型在<code>BEGIN</code>命令中指定：<code>BEGIN [ DEFERRED | IMMEDIATE | EXCLUSIVE ] TRANSACTION</code></p>
<p>一个<code>deferred</code>事务不获取任何锁，直到它需要锁的时候，而且<code>BEGIN</code>语句本身也不会做什么事情——它开始于<code>UNLOCK</code>状态；默认情况下是这样的。如果仅仅用<code>BEGIN</code>开始一个事务，那么事务就是<code>DEFERRED</code>的，同时它不会获取任何锁，当对数据库进行第一次读操作时，它会获取<code>SHARED LOCK</code>；同样，当进行第一次写操作时，它会获取<code>RESERVED LOCK</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">// 开始延迟事务</div><div class="line">- (BOOL)beginDeferredTransaction &#123;</div><div class="line">    </div><div class="line">    BOOL b = [self executeUpdate:@&quot;begin deferred transaction&quot;];</div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//Exclusive事务会试着获取对数据库的EXCLUSIVE锁。这与IMMEDIATE类似，但是一旦成功，EXCLUSIVE事务保证没有其它的连接，所以就可对数据库进行读写操作了。</div><div class="line"></div><div class="line">// 开始事务</div><div class="line">- (BOOL)beginTransaction &#123;</div><div class="line">    </div><div class="line">    BOOL b = [self executeUpdate:@&quot;begin exclusive transaction&quot;];</div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 回滚事务</div><div class="line">- (BOOL)rollback &#123;</div><div class="line">    BOOL b = [self executeUpdate:@&quot;rollback transaction&quot;];</div><div class="line">    </div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div><div class="line">// 提交事务</div><div class="line">- (BOOL)commit &#123;</div><div class="line">    BOOL b =  [self executeUpdate:@&quot;commit transaction&quot;];</div><div class="line">    </div><div class="line">    if (b) &#123;</div><div class="line">        _inTransaction = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6570_u636E_u5E93_u52A0_u5BC6_u53CA_u91CD_u7F6E"><a href="#u6570_u636E_u5E93_u52A0_u5BC6_u53CA_u91CD_u7F6E" class="headerlink" title="数据库加密及重置"></a>数据库加密及重置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (BOOL)setKeyWithData:(NSData *)keyData &#123;</div><div class="line">// SQLITE_HAS_CODEC 用来确定是否支持加密</div><div class="line">#ifdef SQLITE_HAS_CODEC</div><div class="line">    if (!keyData) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // int sqlite3_key( sqlite3 *db, const void *pKey, int nKey)</div><div class="line">    // db是指定的数据库，pKey是密钥，nKey是密钥的长度</div><div class="line">    // 例如：sqlite3_key(_db, &quot;gongcheng&quot;, 9);</div><div class="line">    int rc = sqlite3_key(_db, [keyData bytes], (int)[keyData length]);</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">#else</div><div class="line">#pragma unused(keyData)</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (BOOL)rekeyWithData:(NSData *)keyData &#123;</div><div class="line">#ifdef SQLITE_HAS_CODEC</div><div class="line">    if (!keyData) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // int sqlite3_rekey( sqlite3 *db, const void *pKey, int nKey)</div><div class="line">    // db是指定的数据库，pKey是密钥，nKey是密钥的长度</div><div class="line">    // 例如：sqlite3_rekey(_db, &quot;yzy&quot;, 3);</div><div class="line">    int rc = sqlite3_rekey(_db, [keyData bytes], (int)[keyData length]);</div><div class="line">    </div><div class="line">    if (rc != SQLITE_OK) &#123;</div><div class="line">        NSLog(@&quot;error on rekey: %d&quot;, rc);</div><div class="line">        NSLog(@&quot;%@&quot;, [self lastErrorMessage]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return (rc == SQLITE_OK);</div><div class="line">#else</div><div class="line">#pragma unused(keyData)</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u6570_u636E_u5E93_u56DE_u6EDA_u65F6_u8BBE_u7F6E_u56DE_u6EDA_u8282_u70B9"><a href="#u6570_u636E_u5E93_u56DE_u6EDA_u65F6_u8BBE_u7F6E_u56DE_u6EDA_u8282_u70B9" class="headerlink" title="数据库回滚时设置回滚节点"></a>数据库回滚时设置回滚节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">- (NSError*)inSavePoint:(void (^)(BOOL *rollback))block &#123;</div><div class="line">#if SQLITE_VERSION_NUMBER &gt;= 3007000</div><div class="line">    static unsigned long savePointIdx = 0;</div><div class="line">    // 设置节点名称</div><div class="line">    NSString *name = [NSString stringWithFormat:@&quot;dbSavePoint%ld&quot;, savePointIdx++];</div><div class="line">    // 默认不回滚</div><div class="line">    BOOL shouldRollback = NO;</div><div class="line">    </div><div class="line">    NSError *err = 0x00;</div><div class="line">    // 先对当前状态进行保存</div><div class="line">    if (![self startSavePointWithName:name error:&amp;err]) &#123;</div><div class="line">        return err;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (block) &#123;</div><div class="line">        block(&amp;shouldRollback);</div><div class="line">    &#125;</div><div class="line">    // 如果需要回滚，则回滚当上一个节点</div><div class="line">    if (shouldRollback) &#123;</div><div class="line">        // We need to rollback and release this savepoint to remove it</div><div class="line">        [self rollbackToSavePointWithName:name error:&amp;err];</div><div class="line">    &#125;</div><div class="line">    // 释放节点</div><div class="line">    [self releaseSavePointWithName:name error:&amp;err];</div><div class="line">    </div><div class="line">    return err;</div><div class="line">#else</div><div class="line">    NSString *errorMessage = NSLocalizedString(@&quot;Save point functions require SQLite 3.7&quot;, nil);</div><div class="line">    if (self.logsErrors) NSLog(@&quot;%@&quot;, errorMessage);</div><div class="line">    return [NSError errorWithDomain:@&quot;FMDatabase&quot; code:0 userInfo:@&#123;NSLocalizedDescriptionKey : errorMessage&#125;];</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="u5173_u95ED_u6570_u636E_u5E93_u8FDE_u63A5"><a href="#u5173_u95ED_u6570_u636E_u5E93_u8FDE_u63A5" class="headerlink" title="关闭数据库连接"></a>关闭数据库连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (BOOL)close &#123;</div><div class="line">    // 清除缓存的prepared语句</div><div class="line">    [self clearCachedStatements];</div><div class="line">    // 关闭所有打开的FMResultSet对象</div><div class="line">    [self closeOpenResultSets];</div><div class="line">    </div><div class="line">    if (!_db) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int  rc;</div><div class="line">    BOOL retry;</div><div class="line">    BOOL triedFinalizingOpenStatements = NO;</div><div class="line">    </div><div class="line">    do &#123;</div><div class="line">        retry   = NO;</div><div class="line">        // 调用sqlite3_close尝试关闭数据库</div><div class="line">        rc      = sqlite3_close(_db);</div><div class="line">        // 当返回结果是数据库繁忙或者被锁住了</div><div class="line">        if (SQLITE_BUSY == rc || SQLITE_LOCKED == rc) &#123;</div><div class="line">            if (!triedFinalizingOpenStatements) &#123;</div><div class="line">                triedFinalizingOpenStatements = YES;</div><div class="line">                sqlite3_stmt *pStmt;</div><div class="line">                // 从关联的pDb数据里面对应的prepared语句开始往下找相应的prepared语句，</div><div class="line">                // 如果pStmt是NULL，则从pDb的第一个prepared语句开始找，</div><div class="line">                // 如果没有找到，则返回NULL</div><div class="line">                while ((pStmt = sqlite3_next_stmt(_db, nil)) !=0) &#123;</div><div class="line">                    // 找到之后，释放资源</div><div class="line">                    NSLog(@&quot;Closing leaked statement&quot;);</div><div class="line">                    sqlite3_finalize(pStmt);</div><div class="line">                    retry = YES;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else if (SQLITE_OK != rc) &#123;</div><div class="line">            NSLog(@&quot;error closing!: %d&quot;, rc);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    while (retry);</div><div class="line">    </div><div class="line">    _db = nil;</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[newDb close];</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/07/05/IM-UI-optimize/" class="prev">上一篇</a><a href="/2016/07/23/FMDB-two/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2016/07/23/FMDB-one/';
var disqus_title = 'FMDB初探（一）';
var disqus_url = 'http://yuzeyang.github.io/2016/07/23/FMDB-one/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"></div><p>© 2015 - 2017 <a href="http://yuzeyang.github.io">宫城</a>, Talk is cheap, show me the code.</p></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>