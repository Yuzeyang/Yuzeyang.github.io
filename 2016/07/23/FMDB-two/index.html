<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> FMDB初探（二） · 宫城</title><meta name="description" content="FMDB初探（二） - 宫城"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">FMDB初探（二）</h1><div class="post-info">2016年7月23日</div><div class="post-content"><p><code>FMResultSet</code>用来执行SQL语句结果的查询</p>
<p><code>FMDatabaseQueue</code>用不同的线程来执行若干个查询和更新操作</p>
<p><code>FMDatabasePool</code>和<code>FMDatabaseQueue</code>类似，但是只是用在数据库只读操作上</p>
<a id="more"></a>
<h2 id="FMResultSet"><a href="#FMResultSet" class="headerlink" title="FMResultSet"></a>FMResultSet</h2><p>主要是根据<code>columnName</code>列名/<code>columnIdx</code>列索引获取到相应数据格式的数据，以及使用<code>- next</code>方法，将查询结果逐行输入</p>
<h4 id="u521D_u59CB_u5316"><a href="#u521D_u59CB_u5316" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)resultSetWithStatement:(FMStatement *)statement usingParentDatabase:(FMDatabase*)aDB &#123;&#10;    // &#21021;&#22987;&#21270;FMResultSet&#23545;&#35937;&#10;    FMResultSet *rs = [[FMResultSet alloc] init];&#10;    // &#35774;&#32622;prepared&#35821;&#21477;&#21644;db&#10;    [rs setStatement:statement];&#10;    [rs setParentDB:aDB];&#10;    // &#35774;&#32622;prepared&#35821;&#21477;&#27491;&#22312;&#20351;&#29992;&#10;    NSParameterAssert(![statement inUse]);&#10;    [statement setInUse:YES]; // weak reference&#10;    &#10;    return FMDBReturnAutoreleased(rs);&#10;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u83B7_u53D6_u7ED3_u679C"><a href="#u83B7_u53D6_u7ED3_u679C" class="headerlink" title="获取结果"></a>获取结果</h4><p>返回结果的数据类型有很多种：除了基本数据类型之外，还有<code>NSString</code>、<code>NSDate</code>、<code>NSData</code></p>
<p>比如以下两个接口<code>- intForColumn:</code>实际上调用的还是<code>- intForColumnIndex:</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (int)intForColumn:(NSString*)columnName &#123;&#10;    return [self intForColumnIndex:[self columnIndexForName:columnName]];&#10;&#125;&#10;&#10;- (int)intForColumnIndex:(int)columnIdx &#123;&#10;    return sqlite3_column_int([_statement statement], columnIdx);&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用<code>- columnIndexForName:</code>方法，用列名来获得列索引，这层映射关系都是存在<code>_columnNameToIndexMap</code>字典里</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (int)columnIndexForName:(NSString*)columnName &#123;&#10;    columnName = [columnName lowercaseString];&#10;    &#10;    NSNumber *n = [[self columnNameToIndexMap] objectForKey:columnName];&#10;    &#10;    if (n) &#123;&#10;        return [n intValue];&#10;    &#125;&#10;    &#10;    NSLog(@&#34;Warning: I could not find the column named &#39;%@&#39;.&#34;, columnName);&#10;    &#10;    return -1;&#10;&#125;&#10;&#10;- (NSMutableDictionary *)columnNameToIndexMap &#123;&#10;    if (!_columnNameToIndexMap) &#123;&#10;        int columnCount = sqlite3_column_count([_statement statement]);&#10;        _columnNameToIndexMap = [[NSMutableDictionary alloc] initWithCapacity:(NSUInteger)columnCount];&#10;        int columnIdx = 0;&#10;        for (columnIdx = 0; columnIdx &#60; columnCount; columnIdx++) &#123;&#10;            // &#21015;&#21517;&#20316;&#20026;key&#65292;&#23545;&#24212;&#30340;&#21015;&#21495;&#20316;&#20026;value&#10;            [_columnNameToIndexMap setObject:[NSNumber numberWithInt:columnIdx]&#10;                                      forKey:[[NSString stringWithUTF8String:sqlite3_column_name([_statement statement], columnIdx)] lowercaseString]];&#10;        &#125;&#10;    &#125;&#10;    return _columnNameToIndexMap;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u9010_u884C_u8FD4_u56DE_u7ED3_u679C"><a href="#u9010_u884C_u8FD4_u56DE_u7ED3_u679C" class="headerlink" title="逐行返回结果"></a>逐行返回结果</h4><p><code>- next</code>方法本质是调用<code>- nextWithError</code>，<code>FMDB</code>里面有的注释写的还是挺逗的，连<code>wtf</code>都有…哈哈</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)nextWithError:(NSError **)outErr &#123;&#10;    /* Call sqlite3_step() to run the virtual machine. Since the SQL being&#10;     ** executed is not a SELECT statement, we assume no data will be returned.&#10;     */&#10;    // sqlite3_prepare&#20989;&#25968;&#23558;SQL&#21629;&#20196;&#23383;&#31526;&#20018;&#35299;&#26512;&#24182;&#36716;&#25442;&#20026;&#19968;&#31995;&#21015;&#30340;&#21629;&#20196;&#23383;&#33410;&#30721;&#65292;&#36825;&#20123;&#23383;&#33410;&#30721;&#26368;&#32456;&#34987;&#20256;&#36865;&#21040;SQlite3&#30340;&#34394;&#25311;&#25968;&#25454;&#24211;&#24341;&#25806;&#65288;VDBE: Virtual Database Engine&#65289;&#20013;&#25191;&#34892;&#65292;&#23436;&#25104;&#36825;&#39033;&#24037;&#20316;&#30340;&#26159;sqlite3_step&#20989;&#25968;&#12290;&#27604;&#22914;&#19968;&#20010;SELECT&#26597;&#35810;&#25805;&#20316;&#65292;sqlite3_step&#20989;&#25968;&#30340;&#27599;&#27425;&#35843;&#29992;&#37117;&#20250;&#36820;&#22238;&#32467;&#26524;&#38598;&#20013;&#30340;&#20854;&#20013;&#19968;&#34892;&#65292;&#30452;&#21040;&#20877;&#27809;&#26377;&#26377;&#25928;&#25968;&#25454;&#34892;&#20102;&#12290;&#27599;&#27425;&#35843;&#29992;sqlite3_step&#20989;&#25968;&#22914;&#26524;&#36820;&#22238;SQLITE_ROW&#65292;&#20195;&#34920;&#33719;&#24471;&#20102;&#26377;&#25928;&#25968;&#25454;&#34892;&#65292;&#21487;&#20197;&#36890;&#36807;sqlite3_column&#20989;&#25968;&#25552;&#21462;&#26576;&#21015;&#30340;&#20540;&#12290;&#22914;&#26524;&#35843;&#29992;sqlite3_step&#20989;&#25968;&#36820;&#22238;SQLITE_DONE&#65292;&#21017;&#20195;&#34920;prepared&#35821;&#21477;&#24050;&#32463;&#25191;&#34892;&#21040;&#32456;&#28857;&#20102;&#65292;&#27809;&#26377;&#26377;&#25928;&#25968;&#25454;&#20102;&#12290;&#24456;&#22810;&#21629;&#20196;&#31532;&#19968;&#27425;&#35843;&#29992;sqlite3_step&#20989;&#25968;&#23601;&#20250;&#36820;&#22238;SQLITE_DONE&#65292;&#22240;&#20026;&#36825;&#20123;SQL&#21629;&#20196;&#19981;&#20250;&#36820;&#22238;&#25968;&#25454;&#12290;&#23545;&#20110;INSERT&#65292;UPDATE&#65292;DELETE&#21629;&#20196;&#65292;&#20250;&#36820;&#22238;&#23427;&#20204;&#25152;&#20462;&#25913;&#30340;&#34892;&#21495;&#8212;&#8212;&#19968;&#20010;&#21333;&#34892;&#21333;&#21015;&#30340;&#20540;&#12290;&#10;    /**&#10;     SQLITE_BUSY &#25968;&#25454;&#24211;&#25991;&#20214;&#26377;&#38145;&#10;     SQLITE_LOCKED &#25968;&#25454;&#24211;&#20013;&#30340;&#26576;&#24352;&#34920;&#26377;&#38145;&#10;     SQLITE_DONE sqlite3_step()&#25191;&#34892;&#23436;&#27605;&#10;     SQLITE_ROW sqlite3_step()&#33719;&#21462;&#21040;&#19979;&#19968;&#34892;&#25968;&#25454;&#10;     SQLITE_ERROR &#19968;&#33324;&#29992;&#20110;&#27809;&#26377;&#29305;&#21035;&#25351;&#23450;&#38169;&#35823;&#30721;&#30340;&#38169;&#35823;&#65292;&#23601;&#26159;&#35828;&#20989;&#25968;&#22312;&#25191;&#34892;&#36807;&#31243;&#20013;&#21457;&#29983;&#20102;&#38169;&#35823;&#65292;&#20294;&#26080;&#27861;&#30693;&#36947;&#38169;&#35823;&#21457;&#29983;&#30340;&#21407;&#22240;&#12290;&#10;     SQLITE_MISUSE &#27809;&#26377;&#27491;&#30830;&#20351;&#29992;SQLite&#25509;&#21475;&#65292;&#27604;&#22914;&#19968;&#26465;&#35821;&#21477;&#22312;sqlite3_step&#20989;&#25968;&#25191;&#34892;&#20043;&#21518;&#65292;&#27809;&#26377;&#34987;&#37325;&#32622;&#20043;&#21069;&#65292;&#20877;&#27425;&#32473;&#20854;&#32465;&#23450;&#21442;&#25968;&#65292;&#36825;&#26102;bind&#20989;&#25968;&#23601;&#20250;&#36820;&#22238;SQLITE_MISUSE&#12290;&#10;     **/&#10;    int rc = sqlite3_step([_statement statement]);&#10;    &#10;    if (SQLITE_BUSY == rc || SQLITE_LOCKED == rc) &#123;&#10;        NSLog(@&#34;%s:%d Database busy (%@)&#34;, __FUNCTION__, __LINE__, [_parentDB databasePath]);&#10;        NSLog(@&#34;Database busy&#34;);&#10;        if (outErr) &#123;&#10;            *outErr = [_parentDB lastError];&#10;        &#125;&#10;    &#125;&#10;    else if (SQLITE_DONE == rc || SQLITE_ROW == rc) &#123;&#10;        // all is well, let&#39;s return.&#10;    &#125;&#10;    else if (SQLITE_ERROR == rc) &#123;&#10;        NSLog(@&#34;Error calling sqlite3_step (%d: %s) rs&#34;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));&#10;        if (outErr) &#123;&#10;            *outErr = [_parentDB lastError];&#10;        &#125;&#10;    &#125;&#10;    else if (SQLITE_MISUSE == rc) &#123;&#10;        // uh oh.&#10;        NSLog(@&#34;Error calling sqlite3_step (%d: %s) rs&#34;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));&#10;        if (outErr) &#123;&#10;            if (_parentDB) &#123;&#10;                *outErr = [_parentDB lastError];&#10;            &#125;&#10;            else &#123;&#10;                // If &#39;next&#39; or &#39;nextWithError&#39; is called after the result set is closed,&#10;                // we need to return the appropriate error.&#10;                NSDictionary* errorMessage = [NSDictionary dictionaryWithObject:@&#34;parentDB does not exist&#34; forKey:NSLocalizedDescriptionKey];&#10;                *outErr = [NSError errorWithDomain:@&#34;FMDatabase&#34; code:SQLITE_MISUSE userInfo:errorMessage];&#10;            &#125;&#10;            &#10;        &#125;&#10;    &#125;&#10;    else &#123;&#10;        // wtf?&#10;        NSLog(@&#34;Unknown error calling sqlite3_step (%d: %s) rs&#34;, rc, sqlite3_errmsg([_parentDB sqliteHandle]));&#10;        if (outErr) &#123;&#10;            *outErr = [_parentDB lastError];&#10;        &#125;&#10;    &#125;&#10;    &#10;    &#10;    if (rc != SQLITE_ROW) &#123;&#10;        [self close];&#10;    &#125;&#10;    &#10;    return (rc == SQLITE_ROW);&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while ([rs next]) &#123;&#10;    NSString *file = [rs stringForColumn:@&#34;file&#34;];&#10;    NSLog(@&#34;database_list: %@&#34;, file);&#10;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="FMDatabaseQueue"><a href="#FMDatabaseQueue" class="headerlink" title="FMDatabaseQueue"></a>FMDatabaseQueue</h2><p>是用来多线程并行执行SQL语句</p>
<h4 id="u521D_u59CB_u5316-1"><a href="#u521D_u59CB_u5316-1" class="headerlink" title="初始化"></a>初始化</h4><p>头文件里提供了很多种初始化方法，但是最终调用的还是<code>(instancetype)initWithPath:(NSString*)aPath flags:(int)openFlags vfs:(NSString *)vfsName</code>方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithPath:(NSString*)aPath flags:(int)openFlags vfs:(NSString *)vfsName &#123;&#10;    &#10;    self = [super init];&#10;    &#10;    if (self != nil) &#123;&#10;        // &#26681;&#25454;&#25351;&#23450;&#36335;&#24452;&#23547;&#25214;&#25968;&#25454;&#24211;&#65292;&#22914;&#26524;&#24050;&#23384;&#22312;&#21017;&#36820;&#22238;db&#65292;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;&#10;        _db = [[[self class] databaseClass] databaseWithPath:aPath];&#10;        FMDBRetain(_db);&#10;        &#10;#if SQLITE_VERSION_NUMBER &#62;= 3005000&#10;        BOOL success = [_db openWithFlags:openFlags vfs:vfsName];&#10;#else&#10;        BOOL success = [_db open];&#10;#endif&#10;        if (!success) &#123;&#10;            NSLog(@&#34;Could not create database queue for path %@&#34;, aPath);&#10;            FMDBRelease(self);&#10;            return 0x00;&#10;        &#125;&#10;        &#10;        _path = FMDBReturnRetained(aPath);&#10;        // &#21019;&#24314;&#20018;&#34892;&#38431;&#21015;&#10;        _queue = dispatch_queue_create([[NSString stringWithFormat:@&#34;fmdb.%@&#34;, self] UTF8String], NULL);&#10;        // &#32473;_queue&#38431;&#21015;&#25351;&#23450;&#20102;kDispatchQueueSpecificKey&#23383;&#31526;&#20018;&#65292;&#24182;&#21644;self&#32465;&#23450;&#65292;&#21518;&#38754;&#21487;&#20197;&#36890;&#36807;kDispatchQueueSpecificKey&#33719;&#21462;&#21040;self&#65292;&#20294;&#35201;&#20445;&#35777;&#27491;&#22312;&#25191;&#34892;&#30340;&#38431;&#21015;&#26159;&#36825;&#20010;_queue&#10;        dispatch_queue_set_specific(_queue, kDispatchQueueSpecificKey, (__bridge void *)self, NULL);&#10;        _openFlags = openFlags;&#10;        _vfsName = [vfsName copy];&#10;    &#125;&#10;    &#10;    return self;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FMDatabaseQueue *queue = [FMDatabaseQueue databaseQueueWithPath:dbPath];</span><br></pre></td></tr></table></figure>
<h4 id="u64CD_u4F5C_u6570_u636E_u5E93"><a href="#u64CD_u4F5C_u6570_u636E_u5E93" class="headerlink" title="操作数据库"></a>操作数据库</h4><p>想要多线程操作数据库时，不是直接使用<code>FMDatabase</code>对象，而是通过<code>FMDatabaseQueue</code>对象，调用<code>- inDatabas:</code>，通过<code>block</code>返回<code>FMDatabase</code>对象来操作，虽然<code>- inDatabas:</code>内是同步操作，但是线程之间是并行的，就相当于马路上有两条单行的路，虽然每条路上的车都是一辆接一辆的，但是两条路之间是互不影响的</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)inDatabase:(void (^)(FMDatabase *db))block &#123;&#10;    // &#36890;&#36807;kDispatchQueueSpecificKey&#26469;&#33719;&#21462;&#24403;&#21069;&#27491;&#22312;&#25191;&#34892;&#30340;&#38431;&#21015;&#65292;&#24182;&#19988;&#26816;&#26597;&#21644;self&#20570;&#27604;&#36739;&#65292;&#30830;&#20445;&#27809;&#26377;&#21457;&#29983;&#27515;&#38145;&#65292;&#22240;&#20026;&#21487;&#20197;&#21019;&#24314;&#22810;&#20010;FMDatabaseQueue&#22810;&#20010;&#26469;&#25191;&#34892;&#19981;&#21516;&#30340;SQL&#35821;&#21477;&#10;    FMDatabaseQueue *currentSyncQueue = (__bridge id)dispatch_get_specific(kDispatchQueueSpecificKey);&#10;    assert(currentSyncQueue != self &#38;&#38; &#34;inDatabase: was called reentrantly on the same queue, which would lead to a deadlock&#34;);&#10;    &#10;    FMDBRetain(self);&#10;    // &#22312;&#24403;&#21069;queue&#20013;&#65292;&#21516;&#27493;&#25191;&#34892;block&#10;    dispatch_sync(_queue, ^() &#123;&#10;        &#10;        FMDatabase *db = [self database];&#10;        block(db);&#10;        &#10;        if ([db hasOpenResultSets]) &#123;&#10;            NSLog(@&#34;Warning: there is at least one open result set around after performing [FMDatabaseQueue inDatabase:]&#34;);&#10;            &#10;#if defined(DEBUG) &#38;&#38; DEBUG&#10;            NSSet *openSetCopy = FMDBReturnAutoreleased([[db valueForKey:@&#34;_openResultSets&#34;] copy]);&#10;            for (NSValue *rsInWrappedInATastyValueMeal in openSetCopy) &#123;&#10;                FMResultSet *rs = (FMResultSet *)[rsInWrappedInATastyValueMeal pointerValue];&#10;                NSLog(@&#34;query: &#39;%@&#39;&#34;, [rs query]);&#10;            &#125;&#10;#endif&#10;        &#125;&#10;    &#125;);&#10;    &#10;    FMDBRelease(self);&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[queue inDatabase:^(FMDatabase *adb) &#123;&#10;    [adb executeUpdate:@&#34;create table qfoo (foo text)&#34;];&#10;    [adb executeUpdate:@&#34;insert into qfoo values (&#39;hi&#39;)&#34;];&#10;    [adb executeUpdate:@&#34;insert into qfoo values (&#39;hello&#39;)&#34;];&#10;    [adb executeUpdate:@&#34;insert into qfoo values (&#39;not&#39;)&#34;];&#10;&#10;&#9;int count = 0;&#10;    FMResultSet *rsl = [adb executeQuery:@&#34;select * from qfoo where foo like &#39;h%&#39;&#34;];&#10;    while ([rsl next]) &#123;&#10;        count++;&#10;    &#125;&#10;&#10;    FMDBQuickCheck(count == 2);&#10;&#10;    count = 0;&#10;    rsl = [adb executeQuery:@&#34;select * from qfoo where foo like ?&#34;, @&#34;h%&#34;];&#10;    while ([rsl next]) &#123;&#10;        count++;&#10;    &#125;&#10;&#10;    FMDBQuickCheck(count == 2);&#10;&#125;];</span><br></pre></td></tr></table></figure>
<h4 id="u4E8B_u52A1_u5904_u7406"><a href="#u4E8B_u52A1_u5904_u7406" class="headerlink" title="事务处理"></a>事务处理</h4><p>和<code>FMDatabase</code>一样，也有事务的处理，分为exclusive事务和deferred事务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)inDeferredTransaction:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;&#10;    [self beginTransaction:YES withBlock:block];&#10;&#125;&#10;&#10;- (void)inTransaction:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;&#10;    [self beginTransaction:NO withBlock:block];&#10;&#125;&#10;&#10;- (void)beginTransaction:(BOOL)useDeferred withBlock:(void (^)(FMDatabase *db, BOOL *rollback))block &#123;&#10;    FMDBRetain(self);&#10;    dispatch_sync(_queue, ^() &#123; &#10;        &#10;        BOOL shouldRollback = NO;&#10;        // &#26159;&#21542;&#20351;&#29992;&#24310;&#36831;&#20107;&#21153;&#10;        if (useDeferred) &#123;&#10;            [[self database] beginDeferredTransaction];&#10;        &#125;&#10;        else &#123;&#10;            [[self database] beginTransaction];&#10;        &#125;&#10;        // &#22914;&#26524;&#25968;&#25454;&#24211;&#25805;&#20316;&#20986;&#38169;&#20102;&#65292;&#20320;&#21487;&#20197;&#35774;&#32622;&#26159;&#21542;&#38656;&#35201;&#22238;&#28378;&#65292;&#22238;&#28378;&#21040;&#25805;&#20316;&#20043;&#21069;&#30340;&#20869;&#23481;&#10;        block([self database], &#38;shouldRollback);&#10;        &#10;        if (shouldRollback) &#123;&#10;            [[self database] rollback];&#10;        &#125;&#10;        else &#123;&#10;            // &#22914;&#26524;&#19981;&#38656;&#35201;&#22238;&#28378;&#65292;&#21017;commit&#25552;&#20132;&#30456;&#24212;&#30340;sql&#25805;&#20316;&#10;            [[self database] commit];&#10;        &#125;&#10;    &#125;);&#10;    &#10;    FMDBRelease(self);&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[queue inTransaction:^(FMDatabase *adb, BOOL *rollback) &#123;&#10;    NSLog(@&#34;Starting query  %ld&#34;, nby);&#10;&#10;    FMResultSet *rsl = [adb executeQuery:@&#34;select * from qfoo where foo like &#39;h%&#39;&#34;];&#10;    while ([rsl next]) &#123;&#10;        ;// whatever.&#10;    &#125;&#10;&#10;    NSLog(@&#34;Ending query    %ld&#34;, nby);&#10;&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="FMDatabasePool"><a href="#FMDatabasePool" class="headerlink" title="FMDatabasePool"></a>FMDatabasePool</h2><blockquote>
<p>If you really really really know what you’re doing and <code>FMDatabasePool</code> is what  you really really need (ie, you’re using a read only database), OK you can use it.  But just be careful not to deadlock!</p>
</blockquote>
<p>对，这就是<code>FMDatabasePool</code>的描述，只能用于数据库只读操作，如果进行了写操作，很有可能会出现死锁，乱用搞不好就跪了…</p>
<p>里面的方法基本和<code>FMDatabaseQueue</code>差不多，里面有两个特别的属性：<code>_databaseInPool</code>和<code>_databaseOutPool</code>，按我的理解，这两个属性的作用就像是一个用来存放闲置的db，一个是用来存放正在执行操作的db，在<code>- inDatabase:</code>等这些方法最后都调用了<code>- pushDatabaseBackInPool:</code>方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#23558;db&#25918;&#22238;InPool&#37324;&#38754;&#10;- (void)pushDatabaseBackInPool:(FMDatabase*)db &#123;&#10;    &#10;    if (!db) &#123; // db can be null if we set an upper bound on the # of databases to create.&#10;        return;&#10;    &#125;&#10;    // &#21516;&#27493;&#25191;&#34892;&#10;    [self executeLocked:^() &#123;&#10;        // &#22914;&#26524;InPool&#25968;&#32452;&#37324;&#38754;&#21253;&#21547;db&#65292;&#35828;&#26126;db&#24050;&#32463;&#22312;InPool&#37324;&#38754;&#65292;&#19981;&#38656;&#35201;&#20877;&#25918;&#22238;InPool&#37324;&#65292;&#24182;&#19988;&#25243;&#20986;&#24322;&#24120;&#65292;&#19979;&#38754;&#30340;&#25805;&#20316;&#23601;&#19981;&#36827;&#34892;&#20102;&#10;        if ([self-&#62;_databaseInPool containsObject:db]) &#123;&#10;            [[NSException exceptionWithName:@&#34;Database already in pool&#34; reason:@&#34;The FMDatabase being put back into the pool is already present in the pool&#34; userInfo:nil] raise];&#10;        &#125;&#10;        // &#22914;&#26524;db&#19981;&#22312;InPool&#37324;&#38754;&#65292;&#25226;db&#21152;&#21040;InPool&#25968;&#32452;&#65292;&#24182;&#19988;&#20174;OutPool&#20013;&#31227;&#38500;&#10;        [self-&#62;_databaseInPool addObject:db];&#10;        [self-&#62;_databaseOutPool removeObject:db];&#10;        &#10;    &#125;];&#10;&#125;&#10;&#10;- (FMDatabase*)db &#123;&#10;    &#10;    __block FMDatabase *db;&#10;    &#10;    &#10;    [self executeLocked:^() &#123;&#10;        // &#20174;_databaseInPool&#37324;&#38754;&#21462;&#20986;&#26368;&#21518;&#19968;&#20010;FMDatabase&#23545;&#35937;&#10;        db = [self-&#62;_databaseInPool lastObject];&#10;        &#10;        BOOL shouldNotifyDelegate = NO;&#10;        // &#22914;&#26524;db&#23384;&#22312;&#65292;&#21017;&#21152;&#21040;_databaseOutPool&#37324;&#65292;_databaseInPool&#31227;&#38500;&#25481;&#65292;&#25105;&#30340;&#29702;&#35299;&#26159;_databaseOutPool&#26159;&#29992;&#20110;&#23384;&#25918;&#27491;&#22312;&#25191;&#34892;&#25805;&#20316;&#30340;db&#27744;&#65292;_databaseInPool&#21017;&#23384;&#25918;&#38386;&#32622;&#30340;db&#27744;&#10;        // &#22312;&#38656;&#35201;&#20351;&#29992;&#30340;&#26102;&#20505;&#65292;&#20174;&#38386;&#32622;&#30340;&#27744;&#37324;&#38754;&#21462;&#20986;&#26469;&#25918;&#21040;&#27491;&#22312;&#25191;&#34892;&#30340;&#27744;&#37324;&#38754;&#10;        if (db) &#123;&#10;            [self-&#62;_databaseOutPool addObject:db];&#10;            [self-&#62;_databaseInPool removeLastObject];&#10;        &#125;&#10;        else &#123;&#10;            // &#26816;&#26597;&#26368;&#22823;&#21019;&#24314;&#30340;db&#25968;&#37327;&#65292;&#36229;&#36807;&#20102;&#21017;&#36820;&#22238;&#65292;&#21542;&#21017;&#23601;&#26681;&#25454;&#36335;&#24452;&#65292;&#25214;&#21040;db&#10;            if (self-&#62;_maximumNumberOfDatabasesToCreate) &#123;&#10;                NSUInteger currentCount = [self-&#62;_databaseOutPool count] + [self-&#62;_databaseInPool count];&#10;                &#10;                if (currentCount &#62;= self-&#62;_maximumNumberOfDatabasesToCreate) &#123;&#10;                    NSLog(@&#34;Maximum number of databases (%ld) has already been reached!&#34;, (long)currentCount);&#10;                    return;&#10;                &#125;&#10;            &#125;&#10;            &#10;            db = [[[self class] databaseClass] databaseWithPath:self-&#62;_path];&#10;            shouldNotifyDelegate = YES;&#10;        &#125;&#10;        // &#26681;&#25454;_openFlags&#21644;_vfsName&#25171;&#24320;db&#10;        //This ensures that the db is opened before returning&#10;#if SQLITE_VERSION_NUMBER &#62;= 3005000&#10;        BOOL success = [db openWithFlags:self-&#62;_openFlags vfs:self-&#62;_vfsName];&#10;#else&#10;        BOOL success = [db open];&#10;#endif&#10;        if (success) &#123;&#10;            // &#22914;&#26524;&#20195;&#29702;&#26041;&#27861;&#21709;&#24212;&#20102;&#65292;&#20294;&#26159;db&#19981;&#20801;&#35768;&#34987;&#21152;&#21040;pool&#37324;&#38754;&#65292;&#37027;&#20040;db&#20851;&#38381;&#37322;&#25918;&#10;            if ([self-&#62;_delegate respondsToSelector:@selector(databasePool:shouldAddDatabaseToPool:)] &#38;&#38; ![self-&#62;_delegate databasePool:self shouldAddDatabaseToPool:db]) &#123;&#10;                [db close];&#10;                db = 0x00;&#10;            &#125;&#10;            else &#123;&#10;                //It should not get added in the pool twice if lastObject was found&#10;                // &#23545;&#20110;&#26032;&#21019;&#24314;&#30340;db&#65292;&#38656;&#35201;&#21152;&#21040;_databaseOutPool&#37324;&#65292;&#32780;&#19981;&#38656;&#35201;&#21152;&#21040;_databaseInPool&#37324;&#10;                if (![self-&#62;_databaseOutPool containsObject:db]) &#123;&#10;                    [self-&#62;_databaseOutPool addObject:db];&#10;                    // &#26032;&#21019;&#24314;&#30340;db&#38656;&#35201;&#21709;&#24212;delegate&#10;                    if (shouldNotifyDelegate &#38;&#38; [self-&#62;_delegate respondsToSelector:@selector(databasePool:didAddDatabase:)]) &#123;&#10;                        [self-&#62;_delegate databasePool:self didAddDatabase:db];&#10;                    &#125;&#10;                &#125;&#10;            &#125;&#10;        &#125;&#10;        else &#123;&#10;            NSLog(@&#34;Could not open up the database at path %@&#34;, self-&#62;_path);&#10;            db = 0x00;&#10;        &#125;&#10;    &#125;];&#10;    &#10;    return db;&#10;&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/23/FMDB-one/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2016/07/23/FMDB-two/';
var disqus_title = 'FMDB初探（二）';
var disqus_url = 'http://yuzeyang.github.io/2016/07/23/FMDB-two/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://yuzeyang.github.io">宫城</a>, Talk is cheap, show me the code.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>