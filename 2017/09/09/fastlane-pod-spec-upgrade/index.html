<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Fastlane 升级私有 Pod 库 · 宫城</title><meta name="description" content="用 Fastlane 升级私有 Pod 库 - 宫城"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yuzeyang.github.io/atom.xml" title="宫城"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">用 Fastlane 升级私有 Pod 库</h1><div class="post-info">2017年9月9日</div><div class="post-content"><p>最近我们完成了用 <code>Fastlane</code> 自动化打包上传 iTunes Counnet ，为了将 Fastlane 的功能进一步的使用，后面希望能将 Pod 集成和升级也自动化，我也抽空研究了一下私有 Pod 库的升级、 Fastlane Action的制作和 Fastlane Plugin 的制作。</p>
<a id="more"></a>
<p>ok，开始我们的正文。</p>
<p>首先，简单介绍一下 <a href="https://github.com/fastlane/fastlane" target="_blank" rel="noopener">Fastlane </a>，它是用 <code>Ruby</code> 来实现自动化构建和打包的工具，并且能和 <code>Jenkins</code> 等 CI 平台结合使用。 Fastlane 对于 iOS 开发来说，实在是太友好，从它提供的 <a href="https://docs.fastlane.tools/actions/" target="_blank" rel="noopener">actions</a> 和 <a href="https://docs.fastlane.tools/plugins/available-plugins/" target="_blank" rel="noopener">plugins</a> 来看，足以满足大部分的自动化任务，如果不够的话，可以自定义 Action，并且可以制作成 Plugin 提交到 <code>RubyGems</code> 上供其他开发者使用。</p>
<h3 id="升级私有-Pod-库"><a href="#升级私有-Pod-库" class="headerlink" title="升级私有 Pod 库"></a>升级私有 Pod 库</h3><p>对 Fastlane 的配置这里就不说了，配置好后最简单的文件结构就是只有一个 <code>Appfile</code> 和 <code>Fastfile</code> ，Appfile 包含刚才初始化时配置，而 Fastfile 负责执行任务。</p>
<p>首先我们来分析一下我们平时在升级私有 Pod 库时的步骤（看注释部分）</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git_pull <span class="comment"># 拉取最新代码</span></span><br><span class="line">ensure_git_branch <span class="comment"># 确保当前是 master 分支</span></span><br><span class="line">pod_spec_lint(<span class="symbol">allow_warnings:</span> <span class="literal">true</span>) <span class="comment"># 检查 Podspec 有效性</span></span><br><span class="line">version_bump_podspec(<span class="symbol">path:</span> path, <span class="symbol">version_number:</span> version) <span class="comment"># 修改 podspec 中版本</span></span><br><span class="line">git_commit(<span class="symbol">path:</span> <span class="string">"."</span>, <span class="symbol">message:</span> <span class="string">"update version to <span class="subst">#&#123;version&#125;</span>"</span>) <span class="comment"># commit</span></span><br><span class="line">push_to_git_remote <span class="comment"># 提交本地改动到远程分支</span></span><br><span class="line">add_git_tag(<span class="symbol">tag:</span> version) <span class="comment"># 添加 tag</span></span><br><span class="line">push_git_tags <span class="comment"># push 本地 tags</span></span><br><span class="line">pod_push(<span class="symbol">path:</span> path, <span class="symbol">allow_warnings:</span> <span class="literal">true</span>) <span class="comment"># push podspec 到仓库</span></span><br></pre></td></tr></table></figure>
<p>再回到注释对应的 fastlane 命令，实际上 fastlane 的 actions 里都能找到 Pod 对应的命令，我们对照文档填充好参数之后，整个升级的核心功能已经实现了。最后我们考虑命令需要的哪些入参，我们需要知道 Project 的名字和升级到哪一个版本</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">version = options[<span class="symbol">:version</span>]</span><br><span class="line">project = options[<span class="symbol">:project</span>]</span><br></pre></td></tr></table></figure>
<p>完成之后我们后面升级只需要一行命令</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane pod_repo_push <span class="symbol">project:</span>[projectname] <span class="symbol">version:</span>[version]</span><br></pre></td></tr></table></figure>
<p>详见：<a href="https://github.com/Yuzeyang/Fastfile/blob/master/fastlane/Fastfile" target="_blank" rel="noopener">Fastfile</a></p>
<h3 id="自定义-Action"><a href="#自定义-Action" class="headerlink" title="自定义 Action"></a>自定义 Action</h3><p>上面升级库中用到了一个命令 <code>pod_spec_lint</code> ，这个并没有在官方提供的 Actions 里，是我自定义的，为什么要用 pod_spec_lint 不用 <code>pod_lib_lint</code> 呢？当时我在在测试升级的时候，把私有库更新传到 Github 上时，pod_lib_lint 验证通过，但是 push 到 remote 的时候就报错源文件找不到，这就让我很纳闷了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[22:46:42]: --------------------------</span><br><span class="line">[22:46:42]: --- Step: pod_lib_lint ---</span><br><span class="line">[22:46:42]: --------------------------</span><br><span class="line">[22:46:42]: $ pod lib lint --allow-warnings</span><br><span class="line">[22:46:52]: ▸ -&gt; FastlanePodspecDemo (0.1.1)</span><br><span class="line">[22:46:52]: ▸ - WARN | summary: The summary is not meaningful.</span><br><span class="line">[22:46:52]: ▸ - WARN | description: The description is equal to the summary.</span><br><span class="line">[22:46:52]: ▸ - WARN | [iOS] license: Unable to find a license file</span><br><span class="line">[22:46:52]: ▸ FastlanePodspecDemo passed validation.</span><br><span class="line">[22:46:52]: Pod lib lint Successfully ⬆️</span><br><span class="line">[22:46:52]: ----------------------------------</span><br><span class="line">...</span><br><span class="line">[22:47:34]: --- Step: pod_push ---</span><br><span class="line">[22:47:34]: ----------------------</span><br><span class="line">[22:47:34]: $ pod trunk push &apos;FastlanePodspecDemo.podspec&apos; --allow-warnings</span><br><span class="line">[22:47:34]: ▸ Updating spec repo master</span><br><span class="line">[22:49:36]: ▸ CocoaPods 1.3.1 is available.</span><br><span class="line">[22:49:36]: ▸ To update use: sudo gem install cocoapods</span><br><span class="line">[22:49:36]: ▸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</span><br><span class="line">[22:49:36]: ▸ Validating podspec</span><br><span class="line">[22:49:51]: ▸ -&gt; FastlanePodspecDemo (0.1.2)</span><br><span class="line">[22:49:51]: ▸ - WARN | summary: The summary is not meaningful.</span><br><span class="line">[22:49:51]: ▸ - WARN | description: The description is equal to the summary.</span><br><span class="line">[22:49:51]: ▸ - ERROR | [iOS] file patterns: The source_files pattern did not match any file.</span><br><span class="line">[22:49:51]: ▸ - ERROR | [iOS] file patterns: The resources pattern did not match any file.</span><br><span class="line">[22:49:51]: ▸ - WARN | [iOS] license: Unable to find a license file</span><br><span class="line">[22:49:51]: ▸ [!] The spec did not pass validation, due to 2 errors.</span><br><span class="line">[22:49:51]: ▸ [!] The validator for Swift projects uses Swift 3.0 by default, if you are using a different version of swift you can use a .swift-version file to set the version for your Pod. For example to use Swift 2.3, run:</span><br><span class="line">[22:49:51]: ▸ echo &quot;2.3 &quot; &gt; .swift-version.</span><br></pre></td></tr></table></figure>
<p>然后我看到了这篇解释 <a href="https://stackoverflow.com/questions/32304421/whats-the-difference-between-pod-spec-lint-and-pod-lib-lint" target="_blank" rel="noopener"><a href="https://stackoverflow.com/questions/32304421/whats-the-difference-between-pod-spec-lint-and-pod-lib-lint" target="_blank" rel="noopener">What’s the difference between ‘pod spec lint’ and ‘pod lib lint’?</a></a> ，pod lib lint 只会 lint 你本地的 pod ，以及确保你提供的东西是否正确，但是代码推到远程后如果 lint 不过也还是没用，而 pod spec lint 除了 pod lib lint 的验证步骤之外，还有会 lint 远程的pod ，真正确保 podspec 的有效性。</p>
<p>所以我基于原来的 pod_lib_lint 命令做了简单的修改，通过运行 <code>fatslant new_action</code> 生成<code>action/pod_sepc_lint.rb</code> 文件，详见：<a href="https://github.com/Yuzeyang/Fastfile/blob/master/fastlane/actions/pod_spec_lint.rb" target="_blank" rel="noopener">pod_spec_lint.rb</a> ，写好之后可以运行 <code>bundle exec rspec</code> 跑一下测试是否能通过，也可以运行 <code>bundle exec rubocop -a</code> 检查一下代码是否符合 fastlane action的规范。最后我试着提交一个 PR 看看能否给官方加上，后来官方回应已经不能在加 actions 了，只能添加到 plugin 里。</p>
<p>后来使用自定义的 pod_spec_lint 命令之后就解决了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[22:58:00]: Get started using a Gemfile for fastlane https://docs.fastlane.tools/getting-started/ios/setup/#use-a-gemfile</span><br><span class="line">...</span><br><span class="line">[22:58:06]: --- Step: pod_spec_lint ---</span><br><span class="line">[22:58:06]: ---------------------------</span><br><span class="line">[22:58:06]: $ pod spec lint --allow-warnings</span><br><span class="line">[22:58:19]: ▸ -&gt; FastlanePodspecDemo (0.1.2)</span><br><span class="line">[22:58:19]: ▸ - WARN | summary: The summary is not meaningful.</span><br><span class="line">[22:58:19]: ▸ - WARN | description: The description is equal to the summary.</span><br><span class="line">[22:58:19]: ▸ - WARN | [iOS] license: Unable to find a license file</span><br><span class="line">[22:58:19]: ▸ Analyzed 1 podspec.</span><br><span class="line">[22:58:19]: ▸ FastlanePodspecDemo.podspec passed validation.</span><br><span class="line">[22:58:19]: Pod spec lint Successfully ⬆️</span><br><span class="line">[22:58:19]: ----------------------------------</span><br><span class="line">...</span><br><span class="line">[22:58:40]: --- Step: pod_push ---</span><br><span class="line">[22:58:40]: ----------------------</span><br><span class="line">[22:58:40]: $ pod trunk push &apos;FastlanePodspecDemo.podspec&apos; --allow-warnings</span><br><span class="line">[22:58:41]: ▸ Updating spec repo master</span><br><span class="line">[23:04:01]: ▸ CocoaPods 1.3.1 is available.</span><br><span class="line">[23:04:01]: ▸ To update use: sudo gem install cocoapods</span><br><span class="line">[23:04:01]: ▸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</span><br><span class="line">[23:04:01]: ▸ Validating podspec</span><br><span class="line">[23:04:29]: ▸ -&gt; FastlanePodspecDemo (0.1.3)</span><br><span class="line">[23:04:29]: ▸ - WARN | summary: The summary is not meaningful.</span><br><span class="line">[23:04:29]: ▸ - WARN | description: The description is equal to the summary.</span><br><span class="line">[23:04:29]: ▸ - WARN | [iOS] license: Unable to find a license file</span><br><span class="line">[23:04:29]: ▸ Updating spec repo master</span><br><span class="line">[23:05:45]: ▸ CocoaPods 1.3.1 is available.</span><br><span class="line">[23:05:45]: ▸ To update use: sudo gem install cocoapods</span><br><span class="line">[23:05:45]: ▸ For more information, see https://blog.cocoapods.org and the CHANGELOG for this version at https://github.com/CocoaPods/CocoaPods/releases/tag/1.3.1</span><br><span class="line">[23:05:46]: ▸ --------------------------------------------------------------------------------</span><br><span class="line">[23:05:46]: ▸ 🎉 Congrats</span><br><span class="line">[23:05:46]: ▸ 🚀 FastlanePodspecDemo (0.1.3) successfully published</span><br><span class="line">[23:05:46]: ▸ 📅 September 3rd, 09:04</span><br><span class="line">[23:05:46]: ▸ 🌎 https://cocoapods.org/pods/FastlanePodspecDemo</span><br><span class="line">[23:05:46]: ▸ 👍 Tell your friends!</span><br><span class="line">[23:05:46]: ▸ --------------------------------------------------------------------------------</span><br><span class="line">[23:05:46]: Successfully pushed Podspec ⬆️</span><br><span class="line">[23:05:46]: push success, current version is 0.1.3</span><br><span class="line"></span><br><span class="line">+------+-------------------------------------+-------------+</span><br><span class="line">| fastlane summary |</span><br><span class="line">+------+-------------------------------------+-------------+</span><br><span class="line">| Step | Action | Time (in s) |</span><br><span class="line">+------+-------------------------------------+-------------+</span><br><span class="line">| 1 | Verifying required fastlane version | 0 |</span><br><span class="line">| 2 | default_platform | 0 |</span><br><span class="line">| 3 | git_pull | 3 |</span><br><span class="line">| 4 | ensure_git_branch | 0 |</span><br><span class="line">| 5 | pod_spec_lint | 13 |</span><br><span class="line">| 6 | version_bump_podspec | 0 |</span><br><span class="line">| 7 | git_add | 0 |</span><br><span class="line">| 8 | git_commit | 5 |</span><br><span class="line">| 9 | push_to_git_remote | 7 |</span><br><span class="line">| 10 | add_git_tag | 0 |</span><br><span class="line">| 11 | push_git_tags | 7 |</span><br><span class="line">| 12 | pod_push | 425 |</span><br><span class="line">+------+-------------------------------------+-------------+</span><br><span class="line"></span><br><span class="line">[23:05:46]: fastlane.tools just saved you 8 minutes! 🎉</span><br></pre></td></tr></table></figure>
<h3 id="制作-Plugin"><a href="#制作-Plugin" class="headerlink" title="制作 Plugin"></a>制作 Plugin</h3><p>这一部分我并没有实现通，我在注册 <code>RubyGems</code> 的账号时邮箱验证过之后还是不能登录，提示未验证….不知道什么原因，有遇到解决了的，麻烦留言告诉我一下。下面是对官方的 Plugin 制作的解释：</p>
<p>创建好目录之后，运行</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane new_plugin [plugin_name]</span><br></pre></td></tr></table></figure>
<p>fastlane 会创建一个有效的 Ruby gem 的文件结构，然后你编辑 <code>lib/fastlane/plugin/[plugin_name]/actions/[plugin_name].rb</code> 去实现你的 action ，把上面自定义的 action 的内容拷贝到里面，然后把创建出来的文件推到你的 Github 仓库，更新 <code>fastlane-plugin-[plugin_name].gemspec</code> 文件来指向你的仓库，最后运行</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bundle install</span><br><span class="line">rake install</span><br><span class="line">rake release</span><br></pre></td></tr></table></figure>
<p>ok~大功告成，现在你可以运行 <code>fastlane add_plugin [plugin_name]</code> 安装使用你的 Plugin 了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/24/https/" class="prev">PREV</a><a href="/2017/09/09/debug-tool-base-on-NSURLProtocol/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2017/09/09/fastlane-pod-spec-upgrade/';
var disqus_title = '用 Fastlane 升级私有 Pod 库';
var disqus_url = 'http://yuzeyang.github.io/2017/09/09/fastlane-pod-spec-upgrade/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://yuzeyang.github.io">宫城</a>, Talk is cheap, show me the code. <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>