<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WebSocket 实现原理 · 宫城</title><meta name="description" content="WebSocket 实现原理 - 宫城"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">WebSocket 实现原理</h1><div class="post-info">2017年7月2日</div><div class="post-content"><h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="背景"></a>背景</h2><p>之前我们将 <a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="external">CocoaAsyncSocket</a> 作为底层实现，在其上面封装了一套 Socket 通信机制以及业务接口，最近我们开始研究 WebSocket ，并用来替换掉原先的 CocoaAsyncSocket ，简单来说一下两者的关系，WebSocket 和 Socket 虽然名称上很像，但两者是完全不同的东西， WebSocket 是建立在 TCP/IP 协议之上，属于应用层的协议，而 Socket 是在应用层和传输层中的一个抽象层，它是将 TCP/IP 层的复杂操作抽象成几个简单的接口来提供给应用层调用。为什么要做这次替换呢？原因是我们服务端在做改造，同时网页版 IM 已经使用了 WebSocket ，客户端也采用的话对于服务端来说维护一套代码会更好更方便，而且 WebSocket 在体积、实时性和扩展上都具有一定的优势。</p>
<p>WebSocket 最新的协议是 <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="external">13 RFC 6455</a> ，要理解 WebSocket 的实现，一定要去理解它的协议！~</p>
<a id="more"></a>
<h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="前言"></a>前言</h2><p>WebSocket 的实现分为握手，数据发送/读取，关闭连接。</p>
<p>这里首先放上一张我们组 <a href="https://geminiwen.com/" target="_blank" rel="external">@省长</a> （推荐大家去读一读省长的博客，干货很多👍）整理出来的流程图，方便大家去理解，其中mbedTLS做的是数据的加解密，可以暂时不用关心：</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/libchat%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h2 id="u63E1_u624B"><a href="#u63E1_u624B" class="headerlink" title="握手"></a>握手</h2><p>握手要从请求头去理解。</p>
<p>WebSocket 首先发起一个 HTTP 请求，在请求头加上  <code>Upgrade</code> 字段，该字段用于改变 HTTP 协议版本或者是换用其他协议，这里我们把 <code>Upgrade</code> 的值设为 <code>websocket</code> ，将它升级为 WebSocket 协议。</p>
<p>同时要注意 <code>Sec-WebSocket-Key</code> 字段，它由客户端生成并发给服务端，用于证明服务端接收到的是一个可受信的连接握手，可以帮助服务端排除自身接收到的由非 WebSocket 客户端发起的连接，该值是一串随机经过 <code>base64</code> 编码的字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /chat HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</div><div class="line">Origin: http://example.com</div><div class="line">Sec-WebSocket-Protocol: chat, superchat</div><div class="line">Sec-WebSocket-Version: 13</div></pre></td></tr></table></figure>
<p>我们可以简化请求头，将请求以字符串方式发送出去，当然别忘了最后的两个空行作为包结束：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * fmt = <span class="string">"GET %s HTTP/1.1\r\n"</span></div><div class="line">                   <span class="string">"Upgrade: websocket\r\n"</span></div><div class="line">                   <span class="string">"Connection: Upgrade\r\n"</span></div><div class="line">                   <span class="string">"Host: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Key: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Version: 13\r\n"</span></div><div class="line">                   <span class="string">"\r\n"</span>;</div><div class="line">size = <span class="built_in">strlen</span>(fmt) + <span class="built_in">strlen</span>(path) + <span class="built_in">strlen</span>(host) + <span class="built_in">strlen</span>(ws-&gt;key);</div><div class="line">buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</div><div class="line"><span class="built_in">sprintf</span>(buf, fmt, path, host, ws-&gt;key);</div><div class="line">size = <span class="built_in">strlen</span>(buf);</div><div class="line">nbytes = ws-&gt;io_send(ws, ws-&gt;context, buf, size);</div></pre></td></tr></table></figure>
<p>收到请求后，服务端也会做一次响应：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</div></pre></td></tr></table></figure>
<p>里面重要的是 <code>Sec-WebSocket-Accept</code> ，服务端通过从客户端请求头中读取 <code>Sec-WebSocket-Key</code> 与一串全局唯一的标识字符串（俗称魔串）“258EAFA5-E914-47DA-   95CA-C5AB0DC85B11”做拼接，生成长度为160位的 <code>SHA-1</code> 字符串，然后进行 <code>base64</code> 编码，作为 <code>Sec-WebSocket-Accept</code> 的值回传给客户端。</p>
<p>处理握手 HTTP 响应解析的时候，可以用 nodejs 的 <a href="https://github.com/nodejs/http-parser" target="_blank" rel="external">http-paser</a> ，解析方式也比较简单，就是对头信息的逐字读取再处理，具体处理你可以看一下它的状态机实现。解析完成后你需要对其内容进行解析，看返回是否正确，同时去管理你的握手状态。</p>
<h2 id="u6570_u636E_u53D1_u9001/_u8BFB_u53D6"><a href="#u6570_u636E_u53D1_u9001/_u8BFB_u53D6" class="headerlink" title="数据发送/读取"></a>数据发送/读取</h2><p>数据的处理就要拿这个帧协议图来说明了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0                   1                   2                   3</div><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</div><div class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</div><div class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</div><div class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</div><div class="line">| |1|2|3|       |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |          Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>首先我们来看看数字的含义，数字表示位，0-7表示有8位，等于1个字节。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div></pre></td></tr></table></figure>
<p>所以如果要组装一个帧数据可以这样子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *rev = (rev *)<span class="built_in">malloc</span>(<span class="number">4</span>);</div><div class="line">rev[<span class="number">0</span>] = (<span class="keyword">char</span>)(<span class="number">0x81</span> &amp; <span class="number">0xff</span>);</div><div class="line">rev[<span class="number">1</span>] = <span class="number">126</span> &amp; <span class="number">0x7f</span>;</div><div class="line">rev[<span class="number">2</span>] = <span class="number">1</span>;</div><div class="line">rev[<span class="number">3</span>] = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>ok，了解了帧数据的样子，我们反过来去理解值对应的帧字段。</p>
<p>首先<code>0x81</code>是什么，这个是十六进制数据，转换成二进制就是<code>1000 0001</code>， 是一个字节的长度，也就是这一段里面每一位的值：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 </div><div class="line">+-+-+-+-+-------+</div><div class="line">|F|R|R|R| opcode|</div><div class="line">|I|S|S|S|  (4)  |</div><div class="line">|N|V|V|V|       |</div><div class="line">| |1|2|3|		|</div><div class="line">+-+-+-+-+-------+</div></pre></td></tr></table></figure>
<ul>
<li><code>FIN</code> 表示该帧是不是消息的最后一帧，1表示结束，0表示还有下一帧。</li>
<li><code>RSV1, RSV2, RSV3</code> 必须为0，除非扩展协商定义了一个非0的值，如果没有定义非0值，且收到了非0的  <code>RSV</code> ，那么 WebSocket 的连接会失效。</li>
<li><code>opcode</code> 用来描述 <code>Payload data</code> 的定义，如果收到了一个未知的 <code>opcode</code> ，同样会使 WebSocket 连接失效，协议定义了以下值：<ul>
<li>%x0 表示连续的帧</li>
<li>%x1 表示 text 帧</li>
<li>%x2 表示二进制帧</li>
<li>%x3-7 预留给非控制帧</li>
<li>%x8 表示关闭连接帧</li>
<li>%x9 表示 ping</li>
<li>%xA 表示 pong</li>
<li>%xB-F 预留给控制帧</li>
</ul>
</li>
</ul>
<p><code>0xff</code> 作用就是取出需要的二进制值。</p>
<p>下面再来看<code>126</code>，126则表示的是 <code>Payload len</code> ，也就是 Payload 的长度：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">                8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">                +-+-------------+-------------------------------+</div><div class="line">                |M| Payload len |    Extended payload length    |</div><div class="line">                |A|     (7)     |             (16/64)           |</div><div class="line">                |S|             |   (if payload len==126/127)   |</div><div class="line">                |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |           Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<ul>
<li><code>MASK</code>  表示<code>Playload data</code> 是否要加掩码，如果设成1，则需要赋值 <code>Masking-key</code> 。所有从客户端发到服务端的帧都要加掩码</li>
<li><code>Playload len</code> 表示 Payload 的长度，这里分为三种情况<ul>
<li>长度小于126，则只需要7位</li>
<li>长度是126，则需要额外2个字节的大小，也就是 <code>Extended payload length</code> </li>
<li>长度是127，则需要额外8个字节的大小，也就是 <code>Extended payload length</code> + <code>Extended payload length continued</code> ，<code>Extended payload length</code> 是2个字节，<code>Extended payload length continued</code> 是6个字节</li>
</ul>
</li>
<li><code>Playload len</code> 则表示 <code>Extension data</code> 与 <code>Application data</code> 的和</li>
</ul>
<p>而数据的发送和读取就是对帧的封装和解析。</p>
<p>数据发送:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ws__wrap_packet</span><span class="params">(_WS_IN <span class="keyword">websocket_t</span> *ws,</span></span></div><div class="line">                     _WS_IN <span class="keyword">const</span> <span class="keyword">char</span> *payload,</div><div class="line">                     _WS_IN <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size,</div><div class="line">                     _WS_IN <span class="keyword">int</span> flags,</div><div class="line">                     _WS_OUT <span class="keyword">char</span>** out,</div><div class="line">                     _WS_OUT <span class="keyword">uint64_t</span> *out_size) &#123;</div><div class="line">	<span class="keyword">struct</span> timeval tv;</div><div class="line">    <span class="keyword">char</span> mask[<span class="number">4</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask_int;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> payload_len_bits;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> payload_bit_offset = <span class="number">6</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extend_payload_len_bits, i;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> frame_size;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MASK_BIT_LEN = <span class="number">4</span>;</div><div class="line"></div><div class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">	srand(tv.tv_usec * tv.tv_sec);</div><div class="line">	mask_int = rand();</div><div class="line">	<span class="built_in">memcpy</span>(mask, &amp;mask_int, <span class="number">4</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * payload_len bits</div><div class="line">     * ref to https://tools.ietf.org/html/rfc6455#section-5.2</div><div class="line">     * If 0-125, that is the payload length</div><div class="line">     *</div><div class="line">     * If payload length is equals 126, the following 2 bytes interpreted as a</div><div class="line">     * 16-bit unsigned integer are the payload length</div><div class="line">     * </div><div class="line">     * If 127, the following 8 bytes interpreted as a 64-bit unsigned integer (the</div><div class="line">     * most significant bit MUST be 0) are the payload length.</div><div class="line">     */</div><div class="line">	<span class="keyword">if</span> (payload_size &lt;= <span class="number">125</span>) &#123;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + mask bit len + payload len)</span></div><div class="line">        extend_payload_len_bits = <span class="number">0</span>;</div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + MASK_BIT_LEN + payload_size;</div><div class="line"></div><div class="line">        payload_len_bits = payload_size;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">125</span> &amp;&amp; payload_size &lt;= <span class="number">0xffff</span>) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">2</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">		payload_len_bits = <span class="number">126</span>;</div><div class="line"></div><div class="line">		payload_bit_offset += extend_payload_len_bits;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">0xffff</span> &amp;&amp; payload_size &lt;= <span class="number">0xffffffffffffffff</span>LL) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">8</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">		payload_len_bits = <span class="number">127</span>;</div><div class="line">		payload_bit_offset += extend_payload_len_bits;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</div><div class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_DATA_TOO_LARGE_ERR);</div><div class="line">            ws-&gt;error_cb(ws, err);</div><div class="line">            <span class="built_in">free</span>(err);</div><div class="line">        &#125;</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    *out_size = frame_size;</div><div class="line">	<span class="keyword">char</span> *data = (*out) = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(frame_size);</div><div class="line">    <span class="keyword">char</span> *buf_offset = data;</div><div class="line"></div><div class="line">    bzero(data, frame_size);</div><div class="line">	*data = flags &amp; <span class="number">0xff</span>;</div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// set mask bit = 1</span></div><div class="line">	*(buf_offset) = payload_len_bits | <span class="number">0x80</span>; <span class="comment">//payload length with mask bit on</span></div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">2</span>;</div><div class="line">	<span class="keyword">if</span> (payload_len_bits == <span class="number">126</span>) &#123;</div><div class="line">		payload_size &amp;= <span class="number">0xffff</span>;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_len_bits == <span class="number">127</span>) &#123;</div><div class="line">		payload_size &amp;= <span class="number">0xffffffffffffffff</span>LL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; extend_payload_len_bits; i++) &#123;</div><div class="line">        *(buf_offset + i) = *((<span class="keyword">char</span> *)&amp;payload_size + (extend_payload_len_bits - i - <span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * according to https://tools.ietf.org/html/rfc6455#section-5.3</div><div class="line">     * </div><div class="line">     * buf_offset is set to mask bit</div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset - <span class="number">4</span>;</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">		*(buf_offset + i) = mask[i] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * mask the payload data </div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset;</div><div class="line">	<span class="built_in">memcpy</span>(buf_offset, payload, payload_size);</div><div class="line">	mask_payload(mask, buf_offset, payload_size);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mask_payload</span><span class="params">(<span class="keyword">char</span> mask[<span class="number">4</span>], <span class="keyword">char</span> *payload, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; payload_size; i++) &#123;</div><div class="line">		*(payload + i) ^= mask[i % <span class="number">4</span>] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>数据解析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws_recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">        ret = ws__recv(ws);</div><div class="line">        <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = OK, i;</div><div class="line">    <span class="keyword">int</span> state = ws-&gt;rd_state;</div><div class="line">    <span class="keyword">char</span> *rd_buf;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span>(state) &#123;</div><div class="line">        <span class="keyword">case</span> WS_READ_IDLE: &#123;</div><div class="line">            ret = ws__make_up(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">ws_frame_t</span> * frame;</div><div class="line">            <span class="keyword">if</span> (ws-&gt;c_frame == <span class="literal">NULL</span>) &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line">            frame = ws-&gt;c_frame;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;fin = (*(rd_buf) &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">            frame-&gt;op_code = *(rd_buf) &amp; <span class="number">0x0f</span>u;</div><div class="line">            frame-&gt;payload_len = *(rd_buf + <span class="number">1</span>) &amp; <span class="number">0x7f</span>u;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;payload_len &lt; <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">2</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame -&gt; payload_len == <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">4</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_2_WORDS;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">8</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_8_WORDS;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_2_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 2</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line"></div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_8_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 8</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_PAYLOAD: &#123;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">uint64_t</span> payload_len = frame-&gt;payload_len;</div><div class="line">            ret = ws__make_up(ws, payload_len);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;payload = <span class="built_in">malloc</span>(payload_len);</div><div class="line">            <span class="built_in">memcpy</span>(frame-&gt;payload, rd_buf, payload_len);</div><div class="line"></div><div class="line">            ws__reset_buf(ws, payload_len);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;fin == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// is control frame</span></div><div class="line">                ws__dispatch_msg(ws, frame);</div><div class="line">                ws__clean_frame(ws);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws-&gt;rd_state = WS_READ_IDLE;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u5173_u95ED_u8FDE_u63A5"><a href="#u5173_u95ED_u8FDE_u63A5" class="headerlink" title="关闭连接"></a>关闭连接</h2><p>关闭连接分为两种：服务端发起关闭和客户端主动关闭。</p>
<p>服务端跟客户端的处理基本一致，以服务端为例：</p>
<p>服务端发起关闭的时候，会客户端发送一个关闭帧，客户端在接收到帧的时候通过解析出帧的opcode来判断是否是关闭帧，然后同样向服务端再发送一个关闭帧作为回应。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (op_code == OP_CLOSE) &#123;</div><div class="line">    <span class="keyword">int</span> status_code;</div><div class="line">    <span class="keyword">char</span> *reason;</div><div class="line">    <span class="keyword">char</span> *status_code_buf = (<span class="keyword">char</span> *)&amp;status_code;</div><div class="line">    status_code_buf[<span class="number">0</span>] = payload[<span class="number">1</span>];</div><div class="line">    status_code_buf[<span class="number">1</span>] = payload[<span class="number">0</span>];</div><div class="line">    reason = payload + <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ws-&gt;state != WS_STATE_CLOSED) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * should send response to remote server</div><div class="line">         */</div><div class="line"></div><div class="line">        ws_send(ws, <span class="literal">NULL</span>, <span class="number">0</span>, OP_CLOSE | FLAG_FIN);</div><div class="line">        ws-&gt;state = WS_STATE_CLOSED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// close connection</span></div><div class="line">    <span class="keyword">if</span> (ws-&gt;close_cb) &#123;</div><div class="line">        ws-&gt;close_cb(ws, status_code, reason);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>对WebSocket的学习主要是对协议的理解，理解了协议，上面复杂的代码自然而然就会明白~</p>
<h2 id="u540E_u8BB0"><a href="#u540E_u8BB0" class="headerlink" title="后记"></a>后记</h2><p>对于I/O操作的原理，推荐大家可以看看这个：<a href="https://www.zhihu.com/question/20122137/answer/14049112#" target="_blank" rel="external">epoll 或者 kqueue 的原理是什么？</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/06/18/Mantle/" class="prev">上一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2017/07/02/websocket/';
var disqus_title = 'WebSocket 实现原理';
var disqus_url = 'http://yuzeyang.github.io/2017/07/02/websocket/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://yuzeyang.github.io">宫城</a>, Talk is cheap, show me the code.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>