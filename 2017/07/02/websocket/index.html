<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WebSocket å®ç°åŸç† Â· å®«åŸ</title><meta name="description" content="WebSocket å®ç°åŸç† - å®«åŸ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">WebSocket å®ç°åŸç†</h1><div class="post-info">2017å¹´7æœˆ2æ—¥</div><div class="post-content"><h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¹‹å‰æˆ‘ä»¬å°† <a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="external">CocoaAsyncSocket</a> ä½œä¸ºåº•å±‚å®ç°ï¼Œåœ¨å…¶ä¸Šé¢å°è£…äº†ä¸€å¥— Socket é€šä¿¡æœºåˆ¶ä»¥åŠä¸šåŠ¡æ¥å£ï¼Œæœ€è¿‘æˆ‘ä»¬å¼€å§‹ç ”ç©¶ WebSocket ï¼Œå¹¶ç”¨æ¥æ›¿æ¢æ‰åŸå…ˆçš„ CocoaAsyncSocket ï¼Œç®€å•æ¥è¯´ä¸€ä¸‹ä¸¤è€…çš„å…³ç³»ï¼ŒWebSocket å’Œ Socket è™½ç„¶åç§°ä¸Šå¾ˆåƒï¼Œä½†ä¸¤è€…æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼Œ WebSocket æ˜¯å»ºç«‹åœ¨ TCP/IP åè®®ä¹‹ä¸Šï¼Œå±äºåº”ç”¨å±‚çš„åè®®ï¼Œè€Œ Socket æ˜¯åœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒæ˜¯å°† TCP/IP å±‚çš„å¤æ‚æ“ä½œæŠ½è±¡æˆå‡ ä¸ªç®€å•çš„æ¥å£æ¥æä¾›ç»™åº”ç”¨å±‚è°ƒç”¨ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™æ¬¡æ›¿æ¢å‘¢ï¼ŸåŸå› æ˜¯æˆ‘ä»¬æœåŠ¡ç«¯åœ¨åšæ”¹é€ ï¼ŒåŒæ—¶ç½‘é¡µç‰ˆ IM å·²ç»ä½¿ç”¨äº† WebSocket ï¼Œå®¢æˆ·ç«¯ä¹Ÿé‡‡ç”¨çš„è¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´ç»´æŠ¤ä¸€å¥—ä»£ç ä¼šæ›´å¥½æ›´æ–¹ä¾¿ï¼Œè€Œä¸” WebSocket åœ¨ä½“ç§¯ã€å®æ—¶æ€§å’Œæ‰©å±•ä¸Šéƒ½å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚</p>
<p>WebSocket æœ€æ–°çš„åè®®æ˜¯ <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="external">13 RFC 6455</a> ï¼Œè¦ç†è§£ WebSocket çš„å®ç°ï¼Œä¸€å®šè¦å»ç†è§£å®ƒçš„åè®®ï¼~</p>
<a id="more"></a>
<h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>WebSocket çš„å®ç°åˆ†ä¸ºæ¡æ‰‹ï¼Œæ•°æ®å‘é€/è¯»å–ï¼Œå…³é—­è¿æ¥ã€‚</p>
<p>è¿™é‡Œé¦–å…ˆæ”¾ä¸Šä¸€å¼ æˆ‘ä»¬ç»„ <a href="https://geminiwen.com/" target="_blank" rel="external">@çœé•¿</a> ï¼ˆæ¨èå¤§å®¶å»è¯»ä¸€è¯»çœé•¿çš„åšå®¢ï¼Œå¹²è´§å¾ˆå¤šğŸ‘ï¼‰æ•´ç†å‡ºæ¥çš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿å¤§å®¶å»ç†è§£ï¼Œå…¶ä¸­mbedTLSåšçš„æ˜¯æ•°æ®çš„åŠ è§£å¯†ï¼Œå¯ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒï¼š</p>
<p><img src="http://7xtit4.com1.z0.glb.clouddn.com/libchat%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h2 id="u63E1_u624B"><a href="#u63E1_u624B" class="headerlink" title="æ¡æ‰‹"></a>æ¡æ‰‹</h2><p>æ¡æ‰‹è¦ä»è¯·æ±‚å¤´å»ç†è§£ã€‚</p>
<p>WebSocket é¦–å…ˆå‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œåœ¨è¯·æ±‚å¤´åŠ ä¸Š  <code>Upgrade</code> å­—æ®µï¼Œè¯¥å­—æ®µç”¨äºæ”¹å˜ HTTP åè®®ç‰ˆæœ¬æˆ–è€…æ˜¯æ¢ç”¨å…¶ä»–åè®®ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠ <code>Upgrade</code> çš„å€¼è®¾ä¸º <code>websocket</code> ï¼Œå°†å®ƒå‡çº§ä¸º WebSocket åè®®ã€‚</p>
<p>åŒæ—¶è¦æ³¨æ„ <code>Sec-WebSocket-Key</code> å­—æ®µï¼Œå®ƒç”±å®¢æˆ·ç«¯ç”Ÿæˆå¹¶å‘ç»™æœåŠ¡ç«¯ï¼Œç”¨äºè¯æ˜æœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå¯å—ä¿¡çš„è¿æ¥æ¡æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æœåŠ¡ç«¯æ’é™¤è‡ªèº«æ¥æ”¶åˆ°çš„ç”±é WebSocket å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸²éšæœºç»è¿‡ <code>base64</code> ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /chat HTTP/1.1</div><div class="line">Host: server.example.com</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</div><div class="line">Origin: http://example.com</div><div class="line">Sec-WebSocket-Protocol: chat, superchat</div><div class="line">Sec-WebSocket-Version: 13</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ç®€åŒ–è¯·æ±‚å¤´ï¼Œå°†è¯·æ±‚ä»¥å­—ç¬¦ä¸²æ–¹å¼å‘é€å‡ºå»ï¼Œå½“ç„¶åˆ«å¿˜äº†æœ€åçš„ä¸¤ä¸ªç©ºè¡Œä½œä¸ºåŒ…ç»“æŸï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> * fmt = <span class="string">"GET %s HTTP/1.1\r\n"</span></div><div class="line">                   <span class="string">"Upgrade: websocket\r\n"</span></div><div class="line">                   <span class="string">"Connection: Upgrade\r\n"</span></div><div class="line">                   <span class="string">"Host: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Key: %s\r\n"</span></div><div class="line">                   <span class="string">"Sec-WebSocket-Version: 13\r\n"</span></div><div class="line">                   <span class="string">"\r\n"</span>;</div><div class="line">size = <span class="built_in">strlen</span>(fmt) + <span class="built_in">strlen</span>(path) + <span class="built_in">strlen</span>(host) + <span class="built_in">strlen</span>(ws-&gt;key);</div><div class="line">buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</div><div class="line"><span class="built_in">sprintf</span>(buf, fmt, path, host, ws-&gt;key);</div><div class="line">size = <span class="built_in">strlen</span>(buf);</div><div class="line">nbytes = ws-&gt;io_send(ws, ws-&gt;context, buf, size);</div></pre></td></tr></table></figure>
<p>æ”¶åˆ°è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šåšä¸€æ¬¡å“åº”ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 101 Switching Protocols</div><div class="line">Upgrade: websocket</div><div class="line">Connection: Upgrade</div><div class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</div></pre></td></tr></table></figure>
<p>é‡Œé¢é‡è¦çš„æ˜¯ <code>Sec-WebSocket-Accept</code> ï¼ŒæœåŠ¡ç«¯é€šè¿‡ä»å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­è¯»å– <code>Sec-WebSocket-Key</code> ä¸ä¸€ä¸²å…¨å±€å”¯ä¸€çš„æ ‡è¯†å­—ç¬¦ä¸²ï¼ˆä¿—ç§°é­”ä¸²ï¼‰â€œ258EAFA5-E914-47DA-   95CA-C5AB0DC85B11â€åšæ‹¼æ¥ï¼Œç”Ÿæˆé•¿åº¦ä¸º160ä½çš„ <code>SHA-1</code> å­—ç¬¦ä¸²ï¼Œç„¶åè¿›è¡Œ <code>base64</code> ç¼–ç ï¼Œä½œä¸º <code>Sec-WebSocket-Accept</code> çš„å€¼å›ä¼ ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>å¤„ç†æ¡æ‰‹ HTTP å“åº”è§£æçš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ nodejs çš„ <a href="https://github.com/nodejs/http-parser" target="_blank" rel="external">http-paser</a> ï¼Œè§£ææ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯¹å¤´ä¿¡æ¯çš„é€å­—è¯»å–å†å¤„ç†ï¼Œå…·ä½“å¤„ç†ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„çŠ¶æ€æœºå®ç°ã€‚è§£æå®Œæˆåä½ éœ€è¦å¯¹å…¶å†…å®¹è¿›è¡Œè§£æï¼Œçœ‹è¿”å›æ˜¯å¦æ­£ç¡®ï¼ŒåŒæ—¶å»ç®¡ç†ä½ çš„æ¡æ‰‹çŠ¶æ€ã€‚</p>
<h2 id="u6570_u636E_u53D1_u9001/_u8BFB_u53D6"><a href="#u6570_u636E_u53D1_u9001/_u8BFB_u53D6" class="headerlink" title="æ•°æ®å‘é€/è¯»å–"></a>æ•°æ®å‘é€/è¯»å–</h2><p>æ•°æ®çš„å¤„ç†å°±è¦æ‹¿è¿™ä¸ªå¸§åè®®å›¾æ¥è¯´æ˜äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0                   1                   2                   3</div><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</div><div class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</div><div class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</div><div class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</div><div class="line">| |1|2|3|       |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |          Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æ•°å­—çš„å«ä¹‰ï¼Œæ•°å­—è¡¨ç¤ºä½ï¼Œ0-7è¡¨ç¤ºæœ‰8ä½ï¼Œç­‰äº1ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥å¦‚æœè¦ç»„è£…ä¸€ä¸ªå¸§æ•°æ®å¯ä»¥è¿™æ ·å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *rev = (rev *)<span class="built_in">malloc</span>(<span class="number">4</span>);</div><div class="line">rev[<span class="number">0</span>] = (<span class="keyword">char</span>)(<span class="number">0x81</span> &amp; <span class="number">0xff</span>);</div><div class="line">rev[<span class="number">1</span>] = <span class="number">126</span> &amp; <span class="number">0x7f</span>;</div><div class="line">rev[<span class="number">2</span>] = <span class="number">1</span>;</div><div class="line">rev[<span class="number">3</span>] = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>okï¼Œäº†è§£äº†å¸§æ•°æ®çš„æ ·å­ï¼Œæˆ‘ä»¬åè¿‡æ¥å»ç†è§£å€¼å¯¹åº”çš„å¸§å­—æ®µã€‚</p>
<p>é¦–å…ˆ<code>0x81</code>æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªæ˜¯åå…­è¿›åˆ¶æ•°æ®ï¼Œè½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯<code>1000 0001</code>ï¼Œ æ˜¯ä¸€ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ®µé‡Œé¢æ¯ä¸€ä½çš„å€¼ï¼š</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">0 1 2 3 4 5 6 7 8 </div><div class="line">+-+-+-+-+-------+</div><div class="line">|F|R|R|R| opcode|</div><div class="line">|I|S|S|S|  (4)  |</div><div class="line">|N|V|V|V|       |</div><div class="line">| |1|2|3|		|</div><div class="line">+-+-+-+-+-------+</div></pre></td></tr></table></figure>
<ul>
<li><code>FIN</code> è¡¨ç¤ºè¯¥å¸§æ˜¯ä¸æ˜¯æ¶ˆæ¯çš„æœ€åä¸€å¸§ï¼Œ1è¡¨ç¤ºç»“æŸï¼Œ0è¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€å¸§ã€‚</li>
<li><code>RSV1, RSV2, RSV3</code> å¿…é¡»ä¸º0ï¼Œé™¤éæ‰©å±•åå•†å®šä¹‰äº†ä¸€ä¸ªé0çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰é0å€¼ï¼Œä¸”æ”¶åˆ°äº†é0çš„  <code>RSV</code> ï¼Œé‚£ä¹ˆ WebSocket çš„è¿æ¥ä¼šå¤±æ•ˆã€‚</li>
<li><code>opcode</code> ç”¨æ¥æè¿° <code>Payload data</code> çš„å®šä¹‰ï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„ <code>opcode</code> ï¼ŒåŒæ ·ä¼šä½¿ WebSocket è¿æ¥å¤±æ•ˆï¼Œåè®®å®šä¹‰äº†ä»¥ä¸‹å€¼ï¼š<ul>
<li>%x0 è¡¨ç¤ºè¿ç»­çš„å¸§</li>
<li>%x1 è¡¨ç¤º text å¸§</li>
<li>%x2 è¡¨ç¤ºäºŒè¿›åˆ¶å¸§</li>
<li>%x3-7 é¢„ç•™ç»™éæ§åˆ¶å¸§</li>
<li>%x8 è¡¨ç¤ºå…³é—­è¿æ¥å¸§</li>
<li>%x9 è¡¨ç¤º ping</li>
<li>%xA è¡¨ç¤º pong</li>
<li>%xB-F é¢„ç•™ç»™æ§åˆ¶å¸§</li>
</ul>
</li>
</ul>
<p><code>0xff</code> ä½œç”¨å°±æ˜¯å–å‡ºéœ€è¦çš„äºŒè¿›åˆ¶å€¼ã€‚</p>
<p>ä¸‹é¢å†æ¥çœ‹<code>126</code>ï¼Œ126åˆ™è¡¨ç¤ºçš„æ˜¯ <code>Payload len</code> ï¼Œä¹Ÿå°±æ˜¯ Payload çš„é•¿åº¦ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">                8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</div><div class="line">                +-+-------------+-------------------------------+</div><div class="line">                |M| Payload len |    Extended payload length    |</div><div class="line">                |A|     (7)     |             (16/64)           |</div><div class="line">                |S|             |   (if payload len==126/127)   |</div><div class="line">                |K|             |                               |</div><div class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</div><div class="line">|     Extended payload length continued, if payload len == 127  |</div><div class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</div><div class="line">|                               |Masking-key, if MASK set to 1  |</div><div class="line">+-------------------------------+-------------------------------+</div><div class="line">| Masking-key (continued)       |           Payload Data         |</div><div class="line">+-------------------------------- - - - - - - - - - - - - - - - +</div><div class="line">:                     Payload Data continued ...                :</div><div class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</div><div class="line">|                     Payload Data continued ...                |</div><div class="line">+---------------------------------------------------------------+</div></pre></td></tr></table></figure>
<ul>
<li><code>MASK</code>  è¡¨ç¤º<code>Playload data</code> æ˜¯å¦è¦åŠ æ©ç ï¼Œå¦‚æœè®¾æˆ1ï¼Œåˆ™éœ€è¦èµ‹å€¼ <code>Masking-key</code> ã€‚æ‰€æœ‰ä»å®¢æˆ·ç«¯å‘åˆ°æœåŠ¡ç«¯çš„å¸§éƒ½è¦åŠ æ©ç </li>
<li><code>Playload len</code> è¡¨ç¤º Payload çš„é•¿åº¦ï¼Œè¿™é‡Œåˆ†ä¸ºä¸‰ç§æƒ…å†µ<ul>
<li>é•¿åº¦å°äº126ï¼Œåˆ™åªéœ€è¦7ä½</li>
<li>é•¿åº¦æ˜¯126ï¼Œåˆ™éœ€è¦é¢å¤–2ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> </li>
<li>é•¿åº¦æ˜¯127ï¼Œåˆ™éœ€è¦é¢å¤–8ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> + <code>Extended payload length continued</code> ï¼Œ<code>Extended payload length</code> æ˜¯2ä¸ªå­—èŠ‚ï¼Œ<code>Extended payload length continued</code> æ˜¯6ä¸ªå­—èŠ‚</li>
</ul>
</li>
<li><code>Playload len</code> åˆ™è¡¨ç¤º <code>Extension data</code> ä¸ <code>Application data</code> çš„å’Œ</li>
</ul>
<p>è€Œæ•°æ®çš„å‘é€å’Œè¯»å–å°±æ˜¯å¯¹å¸§çš„å°è£…å’Œè§£æã€‚</p>
<p>æ•°æ®å‘é€:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ws__wrap_packet</span><span class="params">(_WS_IN <span class="keyword">websocket_t</span> *ws,</span></span></div><div class="line">                     _WS_IN <span class="keyword">const</span> <span class="keyword">char</span> *payload,</div><div class="line">                     _WS_IN <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size,</div><div class="line">                     _WS_IN <span class="keyword">int</span> flags,</div><div class="line">                     _WS_OUT <span class="keyword">char</span>** out,</div><div class="line">                     _WS_OUT <span class="keyword">uint64_t</span> *out_size) &#123;</div><div class="line">	<span class="keyword">struct</span> timeval tv;</div><div class="line">    <span class="keyword">char</span> mask[<span class="number">4</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask_int;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> payload_len_bits;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> payload_bit_offset = <span class="number">6</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extend_payload_len_bits, i;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> frame_size;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MASK_BIT_LEN = <span class="number">4</span>;</div><div class="line"></div><div class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</div><div class="line">	srand(tv.tv_usec * tv.tv_sec);</div><div class="line">	mask_int = rand();</div><div class="line">	<span class="built_in">memcpy</span>(mask, &amp;mask_int, <span class="number">4</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * payload_len bits</div><div class="line">     * ref to https://tools.ietf.org/html/rfc6455#section-5.2</div><div class="line">     * If 0-125, that is the payload length</div><div class="line">     *</div><div class="line">     * If payload length is equals 126, the following 2 bytes interpreted as a</div><div class="line">     * 16-bit unsigned integer are the payload length</div><div class="line">     * </div><div class="line">     * If 127, the following 8 bytes interpreted as a 64-bit unsigned integer (the</div><div class="line">     * most significant bit MUST be 0) are the payload length.</div><div class="line">     */</div><div class="line">	<span class="keyword">if</span> (payload_size &lt;= <span class="number">125</span>) &#123;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + mask bit len + payload len)</span></div><div class="line">        extend_payload_len_bits = <span class="number">0</span>;</div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + MASK_BIT_LEN + payload_size;</div><div class="line"></div><div class="line">        payload_len_bits = payload_size;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">125</span> &amp;&amp; payload_size &lt;= <span class="number">0xffff</span>) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">2</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">		payload_len_bits = <span class="number">126</span>;</div><div class="line"></div><div class="line">		payload_bit_offset += extend_payload_len_bits;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">0xffff</span> &amp;&amp; payload_size &lt;= <span class="number">0xffffffffffffffff</span>LL) &#123;</div><div class="line">        extend_payload_len_bits = <span class="number">8</span>;</div><div class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></div><div class="line">		frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</div><div class="line">		payload_len_bits = <span class="number">127</span>;</div><div class="line">		payload_bit_offset += extend_payload_len_bits;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</div><div class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_DATA_TOO_LARGE_ERR);</div><div class="line">            ws-&gt;error_cb(ws, err);</div><div class="line">            <span class="built_in">free</span>(err);</div><div class="line">        &#125;</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    *out_size = frame_size;</div><div class="line">	<span class="keyword">char</span> *data = (*out) = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(frame_size);</div><div class="line">    <span class="keyword">char</span> *buf_offset = data;</div><div class="line"></div><div class="line">    bzero(data, frame_size);</div><div class="line">	*data = flags &amp; <span class="number">0xff</span>;</div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// set mask bit = 1</span></div><div class="line">	*(buf_offset) = payload_len_bits | <span class="number">0x80</span>; <span class="comment">//payload length with mask bit on</span></div><div class="line"></div><div class="line">    buf_offset = data + <span class="number">2</span>;</div><div class="line">	<span class="keyword">if</span> (payload_len_bits == <span class="number">126</span>) &#123;</div><div class="line">		payload_size &amp;= <span class="number">0xffff</span>;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_len_bits == <span class="number">127</span>) &#123;</div><div class="line">		payload_size &amp;= <span class="number">0xffffffffffffffff</span>LL;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; extend_payload_len_bits; i++) &#123;</div><div class="line">        *(buf_offset + i) = *((<span class="keyword">char</span> *)&amp;payload_size + (extend_payload_len_bits - i - <span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * according to https://tools.ietf.org/html/rfc6455#section-5.3</div><div class="line">     * </div><div class="line">     * buf_offset is set to mask bit</div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset - <span class="number">4</span>;</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">		*(buf_offset + i) = mask[i] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * mask the payload data </div><div class="line">     */</div><div class="line">    buf_offset = data + payload_bit_offset;</div><div class="line">	<span class="built_in">memcpy</span>(buf_offset, payload, payload_size);</div><div class="line">	mask_payload(mask, buf_offset, payload_size);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mask_payload</span><span class="params">(<span class="keyword">char</span> mask[<span class="number">4</span>], <span class="keyword">char</span> *payload, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size)</span> </span>&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; payload_size; i++) &#123;</div><div class="line">		*(payload + i) ^= mask[i % <span class="number">4</span>] &amp; <span class="number">0xff</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•°æ®è§£æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws_recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">        ret = ws__recv(ws);</div><div class="line">        <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</div><div class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = OK, i;</div><div class="line">    <span class="keyword">int</span> state = ws-&gt;rd_state;</div><div class="line">    <span class="keyword">char</span> *rd_buf;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span>(state) &#123;</div><div class="line">        <span class="keyword">case</span> WS_READ_IDLE: &#123;</div><div class="line">            ret = ws__make_up(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">ws_frame_t</span> * frame;</div><div class="line">            <span class="keyword">if</span> (ws-&gt;c_frame == <span class="literal">NULL</span>) &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line">            frame = ws-&gt;c_frame;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;fin = (*(rd_buf) &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">            frame-&gt;op_code = *(rd_buf) &amp; <span class="number">0x0f</span>u;</div><div class="line">            frame-&gt;payload_len = *(rd_buf + <span class="number">1</span>) &amp; <span class="number">0x7f</span>u;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;payload_len &lt; <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">2</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame -&gt; payload_len == <span class="number">126</span>) &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">4</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_2_WORDS;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                frame-&gt;payload_bit_offset = <span class="number">8</span>;</div><div class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_8_WORDS;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, <span class="number">2</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_2_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 2</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line"></div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_8_WORDS: &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 8</span></div><div class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</div><div class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</div><div class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</div><div class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> WS_READ_PAYLOAD: &#123;</div><div class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</div><div class="line">            <span class="keyword">uint64_t</span> payload_len = frame-&gt;payload_len;</div><div class="line">            ret = ws__make_up(ws, payload_len);</div><div class="line">            <span class="keyword">if</span> (ret != OK) &#123;</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            rd_buf = ws-&gt;buf;</div><div class="line">            frame-&gt;payload = <span class="built_in">malloc</span>(payload_len);</div><div class="line">            <span class="built_in">memcpy</span>(frame-&gt;payload, rd_buf, payload_len);</div><div class="line"></div><div class="line">            ws__reset_buf(ws, payload_len);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (frame-&gt;fin == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// is control frame</span></div><div class="line">                ws__dispatch_msg(ws, frame);</div><div class="line">                ws__clean_frame(ws);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ws__append_frame(ws);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ws-&gt;rd_state = WS_READ_IDLE;</div><div class="line"></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u5173_u95ED_u8FDE_u63A5"><a href="#u5173_u95ED_u8FDE_u63A5" class="headerlink" title="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥</h2><p>å…³é—­è¿æ¥åˆ†ä¸ºä¸¤ç§ï¼šæœåŠ¡ç«¯å‘èµ·å…³é—­å’Œå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ã€‚</p>
<p>æœåŠ¡ç«¯è·Ÿå®¢æˆ·ç«¯çš„å¤„ç†åŸºæœ¬ä¸€è‡´ï¼Œä»¥æœåŠ¡ç«¯ä¸ºä¾‹ï¼š</p>
<p>æœåŠ¡ç«¯å‘èµ·å…³é—­çš„æ—¶å€™ï¼Œä¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå…³é—­å¸§ï¼Œå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°å¸§çš„æ—¶å€™é€šè¿‡è§£æå‡ºå¸§çš„opcodeæ¥åˆ¤æ–­æ˜¯å¦æ˜¯å…³é—­å¸§ï¼Œç„¶ååŒæ ·å‘æœåŠ¡ç«¯å†å‘é€ä¸€ä¸ªå…³é—­å¸§ä½œä¸ºå›åº”ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (op_code == OP_CLOSE) &#123;</div><div class="line">    <span class="keyword">int</span> status_code;</div><div class="line">    <span class="keyword">char</span> *reason;</div><div class="line">    <span class="keyword">char</span> *status_code_buf = (<span class="keyword">char</span> *)&amp;status_code;</div><div class="line">    status_code_buf[<span class="number">0</span>] = payload[<span class="number">1</span>];</div><div class="line">    status_code_buf[<span class="number">1</span>] = payload[<span class="number">0</span>];</div><div class="line">    reason = payload + <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ws-&gt;state != WS_STATE_CLOSED) &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * should send response to remote server</div><div class="line">         */</div><div class="line"></div><div class="line">        ws_send(ws, <span class="literal">NULL</span>, <span class="number">0</span>, OP_CLOSE | FLAG_FIN);</div><div class="line">        ws-&gt;state = WS_STATE_CLOSED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// close connection</span></div><div class="line">    <span class="keyword">if</span> (ws-&gt;close_cb) &#123;</div><div class="line">        ws-&gt;close_cb(ws, status_code, reason);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹WebSocketçš„å­¦ä¹ ä¸»è¦æ˜¯å¯¹åè®®çš„ç†è§£ï¼Œç†è§£äº†åè®®ï¼Œä¸Šé¢å¤æ‚çš„ä»£ç è‡ªç„¶è€Œç„¶å°±ä¼šæ˜ç™½~</p>
<h2 id="u540E_u8BB0"><a href="#u540E_u8BB0" class="headerlink" title="åè®°"></a>åè®°</h2><p>å¯¹äºI/Oæ“ä½œçš„åŸç†ï¼Œæ¨èå¤§å®¶å¯ä»¥çœ‹çœ‹è¿™ä¸ªï¼š<a href="https://www.zhihu.com/question/20122137/answer/14049112#" target="_blank" rel="external">epoll æˆ–è€… kqueue çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/06/18/Mantle/" class="prev">ä¸Šä¸€ç¯‡</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2017/07/02/websocket/';
var disqus_title = 'WebSocket å®ç°åŸç†';
var disqus_url = 'http://yuzeyang.github.io/2017/07/02/websocket/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2015 - 2017 <a href="http://yuzeyang.github.io">å®«åŸ</a>, Talk is cheap, show me the code.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>