<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> WebSocket å®ç°åŸç† Â· å®«åŸ</title><meta name="description" content="WebSocket å®ç°åŸç† - å®«åŸ"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/CaptainAmerica.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yuzeyang.github.io/atom.xml" title="å®«åŸ"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/CaptainAmerica.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yuzeyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">WebSocket å®ç°åŸç†</h1><div class="post-info">2017å¹´7æœˆ2æ—¥</div><div class="post-content"><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¹‹å‰æˆ‘ä»¬å°† <a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="noopener">CocoaAsyncSocket</a> ä½œä¸ºåº•å±‚å®ç°ï¼Œåœ¨å…¶ä¸Šé¢å°è£…äº†ä¸€å¥— Socket é€šä¿¡æœºåˆ¶ä»¥åŠä¸šåŠ¡æ¥å£ï¼Œæœ€è¿‘æˆ‘ä»¬å¼€å§‹ç ”ç©¶ WebSocket ï¼Œå¹¶ç”¨æ¥æ›¿æ¢æ‰åŸå…ˆçš„ CocoaAsyncSocket ï¼Œç®€å•æ¥è¯´ä¸€ä¸‹ä¸¤è€…çš„å…³ç³»ï¼ŒWebSocket å’Œ Socket è™½ç„¶åç§°ä¸Šå¾ˆåƒï¼Œä½†ä¸¤è€…æ˜¯å®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼Œ WebSocket æ˜¯å»ºç«‹åœ¨ TCP/IP åè®®ä¹‹ä¸Šï¼Œå±äºåº”ç”¨å±‚çš„åè®®ï¼Œè€Œ Socket æ˜¯åœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒæ˜¯å°† TCP/IP å±‚çš„å¤æ‚æ“ä½œæŠ½è±¡æˆå‡ ä¸ªç®€å•çš„æ¥å£æ¥æä¾›ç»™åº”ç”¨å±‚è°ƒç”¨ã€‚ä¸ºä»€ä¹ˆè¦åšè¿™æ¬¡æ›¿æ¢å‘¢ï¼ŸåŸå› æ˜¯æˆ‘ä»¬æœåŠ¡ç«¯åœ¨åšæ”¹é€ ï¼ŒåŒæ—¶ç½‘é¡µç‰ˆ IM å·²ç»ä½¿ç”¨äº† WebSocket ï¼Œå®¢æˆ·ç«¯ä¹Ÿé‡‡ç”¨çš„è¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´ç»´æŠ¤ä¸€å¥—ä»£ç ä¼šæ›´å¥½æ›´æ–¹ä¾¿ï¼Œè€Œä¸” WebSocket åœ¨ä½“ç§¯ã€å®æ—¶æ€§å’Œæ‰©å±•ä¸Šéƒ½å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚</p>
<p>WebSocket æœ€æ–°çš„åè®®æ˜¯ <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">13 RFC 6455</a> ï¼Œè¦ç†è§£ WebSocket çš„å®ç°ï¼Œä¸€å®šè¦å»ç†è§£å®ƒçš„åè®®ï¼~</p>
<a id="more"></a>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>WebSocket çš„å®ç°åˆ†ä¸ºæ¡æ‰‹ï¼Œæ•°æ®å‘é€/è¯»å–ï¼Œå…³é—­è¿æ¥ã€‚</p>
<p>è¿™é‡Œé¦–å…ˆæ”¾ä¸Šä¸€å¼ æˆ‘ä»¬ç»„ <a href="https://geminiwen.com/" target="_blank" rel="noopener">@çœé•¿</a> ï¼ˆæ¨èå¤§å®¶å»è¯»ä¸€è¯»çœé•¿çš„åšå®¢ï¼Œå¹²è´§å¾ˆå¤šğŸ‘ï¼‰æ•´ç†å‡ºæ¥çš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿å¤§å®¶å»ç†è§£ï¼Œå…¶ä¸­mbedTLSåšçš„æ˜¯æ•°æ®çš„åŠ è§£å¯†ï¼Œå¯ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒï¼š</p>
<p><img src="http://media.shengyushan.com/libchat%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h2 id="æ¡æ‰‹"><a href="#æ¡æ‰‹" class="headerlink" title="æ¡æ‰‹"></a>æ¡æ‰‹</h2><p>æ¡æ‰‹è¦ä»è¯·æ±‚å¤´å»ç†è§£ã€‚</p>
<p>WebSocket é¦–å…ˆå‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œåœ¨è¯·æ±‚å¤´åŠ ä¸Š  <code>Upgrade</code> å­—æ®µï¼Œè¯¥å­—æ®µç”¨äºæ”¹å˜ HTTP åè®®ç‰ˆæœ¬æˆ–è€…æ˜¯æ¢ç”¨å…¶ä»–åè®®ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠ <code>Upgrade</code> çš„å€¼è®¾ä¸º <code>websocket</code> ï¼Œå°†å®ƒå‡çº§ä¸º WebSocket åè®®ã€‚</p>
<p>åŒæ—¶è¦æ³¨æ„ <code>Sec-WebSocket-Key</code> å­—æ®µï¼Œå®ƒç”±å®¢æˆ·ç«¯ç”Ÿæˆå¹¶å‘ç»™æœåŠ¡ç«¯ï¼Œç”¨äºè¯æ˜æœåŠ¡ç«¯æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå¯å—ä¿¡çš„è¿æ¥æ¡æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æœåŠ¡ç«¯æ’é™¤è‡ªèº«æ¥æ”¶åˆ°çš„ç”±é WebSocket å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸²éšæœºç»è¿‡ <code>base64</code> ç¼–ç çš„å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br><span class="line">Origin: http://example.com</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ç®€åŒ–è¯·æ±‚å¤´ï¼Œå°†è¯·æ±‚ä»¥å­—ç¬¦ä¸²æ–¹å¼å‘é€å‡ºå»ï¼Œå½“ç„¶åˆ«å¿˜äº†æœ€åçš„ä¸¤ä¸ªç©ºè¡Œä½œä¸ºåŒ…ç»“æŸï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * fmt = <span class="string">"GET %s HTTP/1.1\r\n"</span></span><br><span class="line">                   <span class="string">"Upgrade: websocket\r\n"</span></span><br><span class="line">                   <span class="string">"Connection: Upgrade\r\n"</span></span><br><span class="line">                   <span class="string">"Host: %s\r\n"</span></span><br><span class="line">                   <span class="string">"Sec-WebSocket-Key: %s\r\n"</span></span><br><span class="line">                   <span class="string">"Sec-WebSocket-Version: 13\r\n"</span></span><br><span class="line">                   <span class="string">"\r\n"</span>;</span><br><span class="line">size = <span class="built_in">strlen</span>(fmt) + <span class="built_in">strlen</span>(path) + <span class="built_in">strlen</span>(host) + <span class="built_in">strlen</span>(ws-&gt;key);</span><br><span class="line">buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="built_in">sprintf</span>(buf, fmt, path, host, ws-&gt;key);</span><br><span class="line">size = <span class="built_in">strlen</span>(buf);</span><br><span class="line">nbytes = ws-&gt;io_send(ws, ws-&gt;context, buf, size);</span><br></pre></td></tr></table></figure>
<p>æ”¶åˆ°è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šåšä¸€æ¬¡å“åº”ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢é‡è¦çš„æ˜¯ <code>Sec-WebSocket-Accept</code> ï¼ŒæœåŠ¡ç«¯é€šè¿‡ä»å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­è¯»å– <code>Sec-WebSocket-Key</code> ä¸ä¸€ä¸²å…¨å±€å”¯ä¸€çš„æ ‡è¯†å­—ç¬¦ä¸²ï¼ˆä¿—ç§°é­”ä¸²ï¼‰â€œ258EAFA5-E914-47DA-   95CA-C5AB0DC85B11â€åšæ‹¼æ¥ï¼Œç”Ÿæˆé•¿åº¦ä¸º160ä½çš„ <code>SHA-1</code> å­—ç¬¦ä¸²ï¼Œç„¶åè¿›è¡Œ <code>base64</code> ç¼–ç ï¼Œä½œä¸º <code>Sec-WebSocket-Accept</code> çš„å€¼å›ä¼ ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å†å»è§£æè¿™ä¸ªå€¼ï¼Œä¸è‡ªå·±åŠ å¯†ç¼–ç åçš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>å¤„ç†æ¡æ‰‹ HTTP å“åº”è§£æçš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ nodejs çš„ <a href="https://github.com/nodejs/http-parser" target="_blank" rel="noopener">http-paser</a> ï¼Œè§£ææ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯¹å¤´ä¿¡æ¯çš„é€å­—è¯»å–å†å¤„ç†ï¼Œå…·ä½“å¤„ç†ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„çŠ¶æ€æœºå®ç°ã€‚è§£æå®Œæˆåä½ éœ€è¦å¯¹å…¶å†…å®¹è¿›è¡Œè§£æï¼Œçœ‹è¿”å›æ˜¯å¦æ­£ç¡®ï¼ŒåŒæ—¶å»ç®¡ç†ä½ çš„æ¡æ‰‹çŠ¶æ€ã€‚</p>
<h2 id="æ•°æ®å‘é€-è¯»å–"><a href="#æ•°æ®å‘é€-è¯»å–" class="headerlink" title="æ•°æ®å‘é€/è¯»å–"></a>æ•°æ®å‘é€/è¯»å–</h2><p>æ•°æ®çš„å¤„ç†å°±è¦æ‹¿è¿™ä¸ªå¸§åè®®å›¾æ¥è¯´æ˜äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æ•°å­—çš„å«ä¹‰ï¼Œæ•°å­—è¡¨ç¤ºä½ï¼Œ0-7è¡¨ç¤ºæœ‰8ä½ï¼Œç­‰äº1ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å¦‚æœè¦ç»„è£…ä¸€ä¸ªå¸§æ•°æ®å¯ä»¥è¿™æ ·å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *rev = (rev *)<span class="built_in">malloc</span>(<span class="number">4</span>);</span><br><span class="line">rev[<span class="number">0</span>] = (<span class="keyword">char</span>)(<span class="number">0x81</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">rev[<span class="number">1</span>] = <span class="number">126</span> &amp; <span class="number">0x7f</span>;</span><br><span class="line">rev[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">rev[<span class="number">3</span>] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>okï¼Œäº†è§£äº†å¸§æ•°æ®çš„æ ·å­ï¼Œæˆ‘ä»¬åè¿‡æ¥å»ç†è§£å€¼å¯¹åº”çš„å¸§å­—æ®µã€‚</p>
<p>é¦–å…ˆ<code>0x81</code>æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªæ˜¯åå…­è¿›åˆ¶æ•°æ®ï¼Œè½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯<code>1000 0001</code>ï¼Œ æ˜¯ä¸€ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ®µé‡Œé¢æ¯ä¸€ä½çš„å€¼ï¼š</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 </span><br><span class="line">+-+-+-+-+-------+</span><br><span class="line">|F|R|R|R| opcode|</span><br><span class="line">|I|S|S|S|  (4)  |</span><br><span class="line">|N|V|V|V|       |</span><br><span class="line">| |1|2|3|       |</span><br><span class="line">+-+-+-+-+-------+</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>FIN</code> è¡¨ç¤ºè¯¥å¸§æ˜¯ä¸æ˜¯æ¶ˆæ¯çš„æœ€åä¸€å¸§ï¼Œ1è¡¨ç¤ºç»“æŸï¼Œ0è¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€å¸§ã€‚</p>
</li>
<li><p><code>RSV1, RSV2, RSV3</code> å¿…é¡»ä¸º0ï¼Œé™¤éæ‰©å±•åå•†å®šä¹‰äº†ä¸€ä¸ªé0çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰é0å€¼ï¼Œä¸”æ”¶åˆ°äº†é0çš„  <code>RSV</code> ï¼Œé‚£ä¹ˆ WebSocket çš„è¿æ¥ä¼šå¤±æ•ˆï¼Œå»ºè®®æ˜¯æ–­å¼€è¿æ¥ã€‚</p>
</li>
<li><p><code>opcode</code> ç”¨æ¥æè¿° <code>Payload data</code> çš„å®šä¹‰ï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªæœªçŸ¥çš„ <code>opcode</code> ï¼ŒåŒæ ·ä¼šä½¿ WebSocket è¿æ¥å¤±æ•ˆï¼Œåè®®å®šä¹‰äº†ä»¥ä¸‹å€¼ï¼š</p>
<ul>
<li>%x0 è¡¨ç¤ºè¿ç»­çš„å¸§</li>
<li>%x1 è¡¨ç¤º text å¸§</li>
<li>%x2 è¡¨ç¤ºäºŒè¿›åˆ¶å¸§</li>
<li>%x3-7 é¢„ç•™ç»™éæ§åˆ¶å¸§</li>
<li>%x8 è¡¨ç¤ºå…³é—­è¿æ¥å¸§</li>
<li>%x9 è¡¨ç¤º ping</li>
<li>%xA è¡¨ç¤º pong</li>
<li>%xB-F é¢„ç•™ç»™æ§åˆ¶å¸§</li>
</ul>
<p>è¿ç»­å¸§æ˜¯å’Œ FIN å€¼ç›¸å…³è”çš„ï¼Œå®ƒè¡¨æ˜å¯èƒ½ç”±äºæ¶ˆæ¯åˆ†ç‰‡çš„åŸå› ï¼Œå°†åŸæœ¬ä¸€ä¸ªå¸§çš„æ•°æ®åˆ†ä¸ºå¤šä¸ªå¸§ï¼Œè¿™æ—¶å€™å‰ä¸€å¸§çš„ opcode å°±æ˜¯0ï¼ŒFIN ä¹Ÿæ˜¯0ï¼Œæœ€åä¸€å¸§çš„ opcode å°±ä¸å†æ˜¯0ï¼ŒFIN å°±æ˜¯1äº†ã€‚</p>
<p>å†å¯ä»¥çœ‹åˆ° opcode é¢„ç•™äº†éæ§åˆ¶å¸§å’Œæ§åˆ¶å¸§ï¼Œè¿™ä¸¤ä¸ªåˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æ§åˆ¶å¸§è¡¨ç¤º WebSocket çš„çŠ¶æ€ä¿¡æ¯ï¼Œåƒæ˜¯å®šä¹‰çš„åˆ†ç‰‡ï¼Œå…³é—­è¿æ¥ï¼Œpingå’Œpongã€‚</p>
<p>éæ§åˆ¶å¸§å°±æ˜¯æ•°æ®å¸§ï¼Œåƒæ˜¯ text å¸§ï¼ŒäºŒè¿›åˆ¶å¸§ã€‚</p>
</li>
</ul>
<p><code>0xff</code> ä½œç”¨å°±æ˜¯å–å‡ºéœ€è¦çš„äºŒè¿›åˆ¶å€¼ã€‚</p>
<p>ä¸‹é¢å†æ¥çœ‹<code>126</code>ï¼Œ126åˆ™è¡¨ç¤ºçš„æ˜¯ <code>Payload len</code> ï¼Œä¹Ÿå°±æ˜¯ Payload çš„é•¿åº¦ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">                8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">                +-+-------------+-------------------------------+</span><br><span class="line">                |M| Payload len |    Extended payload length    |</span><br><span class="line">                |A|     (7)     |             (16/64)           |</span><br><span class="line">                |S|             |   (if payload len==126/127)   |</span><br><span class="line">                |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |           Payload Data        |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<ul>
<li><code>MASK</code>  è¡¨ç¤º<code>Playload data</code> æ˜¯å¦è¦åŠ æ©ç ï¼Œå¦‚æœè®¾æˆ1ï¼Œåˆ™éœ€è¦èµ‹å€¼ <code>Masking-key</code> ã€‚æ‰€æœ‰ä»å®¢æˆ·ç«¯å‘åˆ°æœåŠ¡ç«¯çš„å¸§éƒ½è¦åŠ æ©ç </li>
<li><code>Playload len</code> è¡¨ç¤º Payload çš„é•¿åº¦ï¼Œè¿™é‡Œåˆ†ä¸ºä¸‰ç§æƒ…å†µ<ul>
<li>é•¿åº¦å°äº126ï¼Œåˆ™åªéœ€è¦7ä½</li>
<li>é•¿åº¦æ˜¯126ï¼Œåˆ™éœ€è¦é¢å¤–2ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> </li>
<li>é•¿åº¦æ˜¯127ï¼Œåˆ™éœ€è¦é¢å¤–8ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ <code>Extended payload length</code> + <code>Extended payload length continued</code> ï¼Œ<code>Extended payload length</code> æ˜¯2ä¸ªå­—èŠ‚ï¼Œ<code>Extended payload length continued</code> æ˜¯6ä¸ªå­—èŠ‚</li>
</ul>
</li>
<li><code>Playload len</code> åˆ™è¡¨ç¤º <code>Extension data</code> ä¸ <code>Application data</code> çš„å’Œ</li>
<li><code>Masking-key</code> æ˜¯åœ¨ <code>MASK</code> è®¾ç½®æˆ1ä¹‹åï¼Œéšæœºç”Ÿæˆçš„4å­—èŠ‚é•¿åº¦çš„æ•°æ®ï¼Œç„¶åå’Œ <code>Payload Data</code> åšå¼‚æˆ–è¿ç®—</li>
<li><code>Payload Data</code> å°±æ˜¯æˆ‘ä»¬å‘é€çš„æ•°æ®</li>
</ul>
<p>è€Œæ•°æ®çš„å‘é€å’Œè¯»å–å°±æ˜¯å¯¹å¸§çš„å°è£…å’Œè§£æã€‚</p>
<p>æ•°æ®å‘é€:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__wrap_packet</span><span class="params">(_WS_IN <span class="keyword">websocket_t</span> *ws,</span></span></span><br><span class="line"><span class="function"><span class="params">                     _WS_IN <span class="keyword">const</span> <span class="keyword">char</span> *payload,</span></span></span><br><span class="line"><span class="function"><span class="params">                     _WS_IN <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                     _WS_IN <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                     _WS_OUT <span class="keyword">char</span>** out,</span></span></span><br><span class="line"><span class="function"><span class="params">                     _WS_OUT <span class="keyword">uint64_t</span> *out_size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    <span class="keyword">char</span> mask[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask_int;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload_len_bits;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> payload_bit_offset = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extend_payload_len_bits, i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> frame_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> MASK_BIT_LEN = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    srand(tv.tv_usec * tv.tv_sec);</span><br><span class="line">    mask_int = rand();</span><br><span class="line">    <span class="built_in">memcpy</span>(mask, &amp;mask_int, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * payload_len bits</span></span><br><span class="line"><span class="comment">     * ref to https://tools.ietf.org/html/rfc6455#section-5.2</span></span><br><span class="line"><span class="comment">     * If 0-125, that is the payload length</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If payload length is equals 126, the following 2 bytes interpreted as a</span></span><br><span class="line"><span class="comment">     * 16-bit unsigned integer are the payload length</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * If 127, the following 8 bytes interpreted as a 64-bit unsigned integer (the</span></span><br><span class="line"><span class="comment">     * most significant bit MUST be 0) are the payload length.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (payload_size &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + mask bit len + payload len)</span></span><br><span class="line">        extend_payload_len_bits = <span class="number">0</span>;</span><br><span class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + MASK_BIT_LEN + payload_size;</span><br><span class="line"></span><br><span class="line">        payload_len_bits = payload_size;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">125</span> &amp;&amp; payload_size &lt;= <span class="number">0xffff</span>) &#123;</span><br><span class="line">        extend_payload_len_bits = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></span><br><span class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</span><br><span class="line">        payload_len_bits = <span class="number">126</span>;</span><br><span class="line"></span><br><span class="line">        payload_bit_offset += extend_payload_len_bits;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_size &gt; <span class="number">0xffff</span> &amp;&amp; payload_size &lt;= <span class="number">0xffffffffffffffff</span>LL) &#123;</span><br><span class="line">        extend_payload_len_bits = <span class="number">8</span>;</span><br><span class="line">        <span class="comment">// consts of ((fin + rsv1/2/3 + opcode) + payload-len bits + extend-payload-len bites + mask bit len + payload len)</span></span><br><span class="line">        frame_size = <span class="number">1</span> + <span class="number">1</span> + extend_payload_len_bits + MASK_BIT_LEN + payload_size;</span><br><span class="line">        payload_len_bits = <span class="number">127</span>;</span><br><span class="line">        payload_bit_offset += extend_payload_len_bits;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</span><br><span class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_DATA_TOO_LARGE_ERR);</span><br><span class="line">            ws-&gt;error_cb(ws, err);</span><br><span class="line">            <span class="built_in">free</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> WS_SEND_SEND_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *out_size = frame_size;</span><br><span class="line">    <span class="keyword">char</span> *data = (*out) = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(frame_size);</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ws-&gt;error_cb) &#123;</span><br><span class="line">            <span class="keyword">ws_error_t</span> *err = ws_new_error(WS_SEND_SEND_ERR);</span><br><span class="line">            ws-&gt;error_cb(ws, err);</span><br><span class="line">            <span class="built_in">free</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *buf_offset = data;</span><br><span class="line"></span><br><span class="line">    bzero(data, frame_size);</span><br><span class="line">    *data = flags &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">    buf_offset = data + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set mask bit = 1</span></span><br><span class="line">    *(buf_offset) = payload_len_bits | <span class="number">0x80</span>; <span class="comment">//payload length with mask bit on</span></span><br><span class="line"></span><br><span class="line">    buf_offset = data + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (payload_len_bits == <span class="number">126</span>) &#123;</span><br><span class="line">        payload_size &amp;= <span class="number">0xffff</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payload_len_bits == <span class="number">127</span>) &#123;</span><br><span class="line">        payload_size &amp;= <span class="number">0xffffffffffffffff</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; extend_payload_len_bits; i++) &#123;</span><br><span class="line">        *(buf_offset + i) = *((<span class="keyword">char</span> *)&amp;payload_size + (extend_payload_len_bits - i - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * according to https://tools.ietf.org/html/rfc6455#section-5.3</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * buf_offset is set to mask bit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    buf_offset = data + payload_bit_offset - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">         *(buf_offset + i) = mask[i] &amp; <span class="number">0xff</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mask the payload data </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    buf_offset = data + payload_bit_offset;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf_offset, payload, payload_size);</span><br><span class="line">    mask_payload(mask, buf_offset, payload_size);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mask_payload</span><span class="params">(<span class="keyword">char</span> mask[<span class="number">4</span>], <span class="keyword">char</span> *payload, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> payload_size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; payload_size; i++) &#123;</span><br><span class="line">        *(payload + i) ^= mask[i % <span class="number">4</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•°æ®è§£æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws_recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</span><br><span class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        ret = ws__recv(ws);</span><br><span class="line">        <span class="keyword">if</span> (ret != OK) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ws__recv</span><span class="params">(<span class="keyword">websocket_t</span> *ws)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ws-&gt;state &lt; WS_STATE_HANDSHAKE_COMPLETED) &#123;</span><br><span class="line">        <span class="keyword">return</span> ws_do_handshake(ws);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = OK, i;</span><br><span class="line">    <span class="keyword">int</span> state = ws-&gt;rd_state;</span><br><span class="line">    <span class="keyword">char</span> *rd_buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(state) &#123;</span><br><span class="line">        <span class="keyword">case</span> WS_READ_IDLE: &#123;</span><br><span class="line">            ret = ws__make_up(ws, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">ws_frame_t</span> * frame;</span><br><span class="line">            <span class="keyword">if</span> (ws-&gt;c_frame == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ws__append_frame(ws);</span><br><span class="line">            &#125;</span><br><span class="line">            frame = ws-&gt;c_frame;</span><br><span class="line">            rd_buf = ws-&gt;buf;</span><br><span class="line">            frame-&gt;fin = (*(rd_buf) &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            frame-&gt;op_code = *(rd_buf) &amp; <span class="number">0x0f</span>u;</span><br><span class="line">            frame-&gt;payload_len = *(rd_buf + <span class="number">1</span>) &amp; <span class="number">0x7f</span>u;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (frame-&gt;payload_len &lt; <span class="number">126</span>) &#123;</span><br><span class="line">                frame-&gt;payload_bit_offset = <span class="number">2</span>;</span><br><span class="line">                ws-&gt;rd_state = WS_READ_PAYLOAD;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame -&gt; payload_len == <span class="number">126</span>) &#123;</span><br><span class="line">                frame-&gt;payload_bit_offset = <span class="number">4</span>;</span><br><span class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_2_WORDS;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                frame-&gt;payload_bit_offset = <span class="number">8</span>;</span><br><span class="line">                ws-&gt;rd_state = WS_READ_EXTEND_PAYLOAD_8_WORDS;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ws__reset_buf(ws, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_2_WORDS: &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 2</span></span><br><span class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</span><br><span class="line">            <span class="keyword">if</span> (ret != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">            rd_buf = ws-&gt;buf;</span><br><span class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</span><br><span class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</span><br><span class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> WS_READ_EXTEND_PAYLOAD_8_WORDS: &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_LEN_BITS 8</span></span><br><span class="line">            ret = ws__make_up(ws, PAYLOAD_LEN_BITS);</span><br><span class="line">            <span class="keyword">if</span> (ret != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rd_buf = ws-&gt;buf;</span><br><span class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</span><br><span class="line">            <span class="keyword">char</span> *payload_len_bytes = (<span class="keyword">char</span> *)&amp;frame-&gt;payload_len;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PAYLOAD_LEN_BITS; i++) &#123;</span><br><span class="line">                *(payload_len_bytes + i) = rd_buf[PAYLOAD_LEN_BITS - <span class="number">1</span> - i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ws__reset_buf(ws, PAYLOAD_LEN_BITS);</span><br><span class="line">            ws-&gt;rd_state = WS_READ_PAYLOAD;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> PAYLOAD_LEN_BITS</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> WS_READ_PAYLOAD: &#123;</span><br><span class="line">            <span class="keyword">ws_frame_t</span> * frame = ws-&gt;c_frame;</span><br><span class="line">            <span class="keyword">uint64_t</span> payload_len = frame-&gt;payload_len;</span><br><span class="line">            ret = ws__make_up(ws, payload_len);</span><br><span class="line">            <span class="keyword">if</span> (ret != OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            rd_buf = ws-&gt;buf;</span><br><span class="line">            frame-&gt;payload = <span class="built_in">malloc</span>(payload_len);</span><br><span class="line">            <span class="built_in">memcpy</span>(frame-&gt;payload, rd_buf, payload_len);</span><br><span class="line"></span><br><span class="line">            ws__reset_buf(ws, payload_len);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (frame-&gt;fin == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// is control frame</span></span><br><span class="line">                ws__dispatch_msg(ws, frame);</span><br><span class="line">                ws__clean_frame(ws);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ws__append_frame(ws);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ws-&gt;rd_state = WS_READ_IDLE;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…³é—­è¿æ¥"><a href="#å…³é—­è¿æ¥" class="headerlink" title="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥</h2><p>å…³é—­è¿æ¥åˆ†ä¸ºä¸¤ç§ï¼šæœåŠ¡ç«¯å‘èµ·å…³é—­å’Œå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ã€‚</p>
<p>æœåŠ¡ç«¯è·Ÿå®¢æˆ·ç«¯çš„å¤„ç†åŸºæœ¬ä¸€è‡´ï¼Œä»¥æœåŠ¡ç«¯ä¸ºä¾‹ï¼š</p>
<p>æœåŠ¡ç«¯å‘èµ·å…³é—­çš„æ—¶å€™ï¼Œä¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå…³é—­å¸§ï¼Œå®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°å¸§çš„æ—¶å€™é€šè¿‡è§£æå‡ºå¸§çš„opcodeæ¥åˆ¤æ–­æ˜¯å¦æ˜¯å…³é—­å¸§ï¼Œç„¶ååŒæ ·å‘æœåŠ¡ç«¯å†å‘é€ä¸€ä¸ªå…³é—­å¸§ä½œä¸ºå›åº”ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (op_code == OP_CLOSE) &#123;</span><br><span class="line">    <span class="keyword">int</span> status_code;</span><br><span class="line">    <span class="keyword">char</span> *reason;</span><br><span class="line">    <span class="keyword">char</span> *status_code_buf = (<span class="keyword">char</span> *)&amp;status_code;</span><br><span class="line">    status_code_buf[<span class="number">0</span>] = payload[<span class="number">1</span>];</span><br><span class="line">    status_code_buf[<span class="number">1</span>] = payload[<span class="number">0</span>];</span><br><span class="line">    reason = payload + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ws-&gt;state != WS_STATE_CLOSED) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * should send response to remote server</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        ws_send(ws, <span class="literal">NULL</span>, <span class="number">0</span>, OP_CLOSE | FLAG_FIN);</span><br><span class="line">        ws-&gt;state = WS_STATE_CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// close connection</span></span><br><span class="line">    <span class="keyword">if</span> (ws-&gt;close_cb) &#123;</span><br><span class="line">        ws-&gt;close_cb(ws, status_code, reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹WebSocketçš„å­¦ä¹ ä¸»è¦æ˜¯å¯¹åè®®çš„ç†è§£ï¼Œç†è§£äº†åè®®ï¼Œä¸Šé¢å¤æ‚çš„ä»£ç è‡ªç„¶è€Œç„¶å°±ä¼šæ˜ç™½~</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å¯¹äºI/Oæ“ä½œçš„åŸç†ï¼Œæ¨èå¤§å®¶å¯ä»¥çœ‹çœ‹è¿™ä¸ªï¼š<a href="https://www.zhihu.com/question/20122137/answer/14049112#" target="_blank" rel="noopener">epoll æˆ–è€… kqueue çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/09/debug-tool-base-on-NSURLProtocol/" class="prev">PREV</a><a href="/2017/06/18/Mantle/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'zeeyang';
var disqus_identifier = '2017/07/02/websocket/';
var disqus_title = 'WebSocket å®ç°åŸç†';
var disqus_url = 'http://yuzeyang.github.io/2017/07/02/websocket/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//zeeyang.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2015 - 2019 <a href="http://yuzeyang.github.io">å®«åŸ</a>, Talk is cheap, show me the code. <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>